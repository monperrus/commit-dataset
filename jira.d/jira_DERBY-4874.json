{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12478632","self":"https://issues.apache.org/jira/rest/api/latest/issue/12478632","key":"DERBY-4874","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313143","id":"12313143","description":"Head of 10.3 branch","name":"10.3.3.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313401","id":"12313401","description":"Head of 10.4 branch","name":"10.4.2.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315436","id":"12315436","description":"Head of 10.5 branch - version bump for DERBY-4835","name":"10.5.3.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315434","id":"12315434","description":"Head of 10.6 branch as of 2014-01-13","name":"10.6.2.4","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315902","id":"12315902","description":"Head of 10.7 branch as of 2010-11-29","name":"10.7.1.4","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12317968","id":"12317968","description":"second release on the 10.8 branch","name":"10.8.2.2","archived":false,"released":true,"releaseDate":"2011-10-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2010-10-29 17:38:39.885","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24504","customfield_12310222":"1_*:*_1_*:*_40953995537_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-02-15T00:01:49.317+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4874/watchers","watchCount":2,"isWatching":false},"created":"2010-10-28T23:55:14.112+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"12.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312251","id":"12312251","description":"Head of 10.2 branch","name":"10.2.2.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313143","id":"12313143","description":"Head of 10.3 branch","name":"10.3.3.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313401","id":"12313401","description":"Head of 10.4 branch","name":"10.4.2.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314117","id":"12314117","description":"Next release after 10.5.2.0 release candidate #1","name":"10.5.3.0","archived":false,"released":true,"releaseDate":"2009-08-21"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315343","id":"12315343","description":"Derby 10.6.2.1 Release","name":"10.6.2.1","archived":false,"released":true,"releaseDate":"2010-10-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315564","id":"12315564","description":"First release on the 10.7 branch.","name":"10.7.1.1","archived":false,"released":true,"releaseDate":"2010-12-14"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12377288","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12377288","type":{"id":"12310050","name":"Regression","inward":"is broken by","outward":"breaks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310050"},"outwardIssue":{"id":"12674782","key":"DERBY-6383","self":"https://issues.apache.org/jira/rest/api/2/issue/12674782","fields":{"summary":"Update trigger defined on one column fires on update of other columns","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-10-31T19:29:19.705+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"Trigger created before VARCHAR column is expanded with ALTER TABLE does not recognize new size and fails with:\r\nERROR 22001: A truncation error was encountered trying to shrink VARCHAR '012345\r\n678901234567890123456789001234567890' to length 30.\r\n\r\n\r\nCREATE TABLE tab (\r\n       element_id         INTEGER NOT NULL,\r\n       altered_id         VARCHAR(30) NOT NULL,\r\n       counter            SMALLINT NOT NULL DEFAULT 0,\r\n       timets            TIMESTAMP NOT NULL\r\n);\r\n0 rows inserted/updated/deleted\r\nij> -- Create a trigger against the table\r\nCREATE TRIGGER mytrig\r\n AFTER UPDATE ON tab\r\n REFERENCING NEW AS newt OLD AS oldt\r\n FOR EACH ROW MODE DB2SQL\r\n  UPDATE tab set tab.counter = CASE WHEN (oldt.counter < 32767) THEN (oldt.count\r\ner + 1) ELSE 1 END\r\n  WHERE ((newt.counter is null) or (oldt.counter = newt.counter))\r\n  AND newt.element_id = tab.element_id\r\n  AND newt.altered_id = tab.altered_id;\r\n0 rows inserted/updated/deleted\r\nij> -- Alter the table to increase column\r\nALTER TABLE tab ALTER altered_id SET DATA TYPE VARCHAR(64);\r\n0 rows inserted/updated/deleted\r\nij> -- insert the data\r\ninsert into tab values (99, '012345678901234567890123456789001234567890',1,CURRE\r\nNT_TIMESTAMP);\r\n1 row inserted/updated/deleted\r\nij> -- update and reproduce the issue\r\nupdate tab set timets = CURRENT_TIMESTAMP where ELEMENT_ID = 99;\r\nERROR 22001: A truncation error was encountered trying to shrink VARCHAR '012345\r\n678901234567890123456789001234567890' to length 30.\r\njava.sql.SQLDataException: A truncation error was encountered trying to shrink V\r\nARCHAR '012345678901234567890123456789001234567890' to length 30.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLE\r\nxceptionFactory40.java:79)\r\n        at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Util.java:256)\r\n\r\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException\r\n(TransactionResourceImpl.java:391)\r\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Tr\r\nansactionResourceImpl.java:346)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConne\r\nction.java:2269)\r\n        at org.apache.derby.impl.jdbc.ConnectionChild.handleException(Connection\r\nChild.java:81)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedState\r\nment.java:1321)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java\r\n:625)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java\r\n:555)\r\n        at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:367)\r\n        at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:521)\r\n        at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:3\r\n63)\r\n        at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:261)\r\n        at org.apache.derby.impl.tools.ij.Main.go(Main.java:229)\r\n        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:184)\r\n        at org.apache.derby.impl.tools.ij.Main.main(Main.java:75)\r\n        at org.apache.derby.tools.ij.main(ij.java:59)\r\nCaused by: java.sql.SQLException: A truncation error was encountered trying to s\r\nhrink VARCHAR '012345678901234567890123456789001234567890' to length 30.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExc\r\neptionFactory.java:45)\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransport\r\nAcrossDRDA(SQLExceptionFactory40.java:119)\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLE\r\nxceptionFactory40.java:70)\r\n        ... 16 more\r\nCaused by: ERROR 22001: A truncation error was encountered trying to shrink VARC\r\nHAR '012345678901234567890123456789001234567890' to length 30.\r\n        at org.apache.derby.iapi.error.StandardException.newException(StandardEx\r\nception.java:343)\r\n        at org.apache.derby.iapi.types.SQLChar.hasNonBlankChars(SQLChar.java:176\r\n6)\r\n        at org.apache.derby.iapi.types.SQLChar.setWidth(SQLChar.java:1840)\r\n        at org.apache.derby.exe.ac0b5b0099x012bxf542xab11x0000001bd2983.e2(Unkno\r\nwn Source)\r\n        at org.apache.derby.impl.services.reflect.DirectCall.invoke(ReflectGener\r\natedClass.java:143)\r\n        at org.apache.derby.impl.sql.execute.GenericQualifier.getOrderable(Gener\r\nicQualifier.java:96)\r\n        at org.apache.derby.impl.sql.execute.NoPutResultSetImpl.clearOrderableCa\r\nche(NoPutResultSetImpl.java:313)\r\n        at org.apache.derby.impl.sql.execute.TableScanResultSet.openScanControll\r\ner(TableScanResultSet.java:350)\r\n        at org.apache.derby.impl.sql.execute.TableScanResultSet.openCore(TableSc\r\nanResultSet.java:262)\r\n        at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.openCore(P\r\nrojectRestrictResultSet.java:174)\r\n        at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.openCore(P\r\nrojectRestrictResultSet.java:174)\r\n        at org.apache.derby.impl.sql.execute.NormalizeResultSet.openCore(Normali\r\nzeResultSet.java:146)\r\n        at org.apache.derby.impl.sql.execute.UpdateResultSet.setup(UpdateResultS\r\net.java:344)\r\n        at org.apache.derby.impl.sql.execute.UpdateResultSet.open(UpdateResultSe\r\nt.java:263)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(Generi\r\ncPreparedStatement.java:436)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.executeSubStatemen\r\nt(GenericPreparedStatement.java:306)\r\n        at org.apache.derby.impl.sql.execute.GenericTriggerExecutor.executeSPS(G\r\nenericTriggerExecutor.java:173)\r\n        at org.apache.derby.impl.sql.execute.RowTriggerExecutor.fireTrigger(RowT\r\nriggerExecutor.java:111)\r\n        at org.apache.derby.impl.sql.execute.TriggerEventActivator.notifyEvent(T\r\nriggerEventActivator.java:278)\r\n        at org.apache.derby.impl.sql.execute.UpdateResultSet.fireAfterTriggers(U\r\npdateResultSet.java:817)\r\n        at org.apache.derby.impl.sql.execute.UpdateResultSet.open(UpdateResultSe\r\nt.java:280)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(Generi\r\ncPreparedStatement.java:436)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPre\r\nparedStatement.java:317)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedState\r\nment.java:1232)\r\n        ... 10 more\r\nij>","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"36105","summary":"Trigger does not recognize new size of VARCHAR column  expanded with ALTER TABLE. It fails with ERROR 22001: A truncation error was encountered trying to shrink VARCHAR ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10422","value":"High Value Fix","id":"10422"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10101","value":"Release Note Needed","id":"10101"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10424","value":"Repro attached","id":"10424"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":53,"total":53,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12926012","id":"12926012","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Attaching repro","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2010-10-28T23:55:59.852+0000","updated":"2010-10-28T23:55:59.852+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12926369","id":"12926369","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"The repro fails on all the codelines starting 10.2. I do not have 10.1 to try it right away but seems like we have had this bug for a long time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-10-29T17:38:39.885+0000","updated":"2010-10-29T17:38:39.885+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12926393","id":"12926393","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"i would look at if the trigger code is getting recompiled at alter time.  \r\nIt might be useful to see if adding an index after the alter on dmtrigsnd.optcounter causes a recompile, it would be bad\r\nif it did not as i believe it would lead to corrupted indexes.   If it works maybe comparing the 2 code paths would lend some\r\nlight.\r\n\r\nI assume dropping and recreating the trigger is a workaround.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2010-10-29T18:30:52.491+0000","updated":"2010-10-29T18:30:52.491+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12926479","id":"12926479","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I noticed dropping and recreating the column seems to be work ok. e.g.\r\n\r\nALTER TABLE TAB DROP COLUMN altered_id;\r\nALTER TABLE TAB ADD  COLUMN altered_id VARCHAR(64);\r\n\r\n-- insert the data\r\ninsert into tab (element_id, altered_id, counter, timets) VALUES (99, '012345678901234567890123456789001234567890',1,CURRENT_TIMESTAMP);\r\n\r\nupdate tab set timets = CURRENT_TIMESTAMP where ELEMENT_ID = 99;\r\n\r\nIt might be also an interesting one for comparison\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2010-10-29T22:12:10.597+0000","updated":"2010-10-29T22:12:10.597+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12927042","id":"12927042","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I did some debugging of the original repro and see that trigger is getting invalidated and recompiled but for some reason, we still use the old length of 30 rather than the new length of 64 as indicated by alter table statement. I will continue debugging to see why we pick up length 30 rather than 64.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-11-01T16:57:40.992+0000","updated":"2010-11-01T16:57:40.992+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12927495","id":"12927495","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I have found what the problem is. The user's definition of trigger is as follows\r\nCREATE TRIGGER mytrig\r\n AFTER UPDATE ON tab\r\n REFERENCING NEW AS newt OLD AS oldt\r\n FOR EACH ROW MODE DB2SQL\r\n  UPDATE tab set tab.counter = CASE WHEN (oldt.counter < 32767) THEN (oldt.counter + 1) ELSE 1 END\r\n  WHERE ((newt.counter is null) or (oldt.counter = newt.counter))\r\n  AND newt.element_id = tab.element_id\r\n  AND newt.altered_id = tab.altered_id;\r\n\r\nFor the trigger action plan, Derby creates a SPSDescriptor which is saved in SYS.SYSSTATEMENTS. The above action plan gets converted to following and that is the query that is saved in SYS.SYSSTATEMENTS\r\nUPDATE tab set tab.counter = CASE WHEN (CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getOldRow().getObject(3) AS SMALLINT)  < 32767) THEN (CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getOldRow().getObject(3) AS SMALLINT)  + 1) ELSE 1 END\r\n  WHERE ((CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getNewRow().getObject(3) AS SMALLINT)  is null) or (CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getOldRow().getObject(3) AS SMALLINT)  = CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getNewRow().getObject(3) AS SMALLINT) ))\r\n  AND CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getNewRow().getObject(1) AS INTEGER)  = tab.element_id\r\n  AND CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getNewRow().getObject(2) AS VARCHAR(30))  = tab.altered_id\r\n\r\nNotice the casting to VARCHAR(30) which is what the column altered_id is defined at during trigger creation. Later, when we alter the length to VARCHAR(64), we do recognize that trigger has become invalid but we simply pickup the above query from SYS.SYSSTATEMENTS and recompile it which really doesn't help because VARCHAR(30) is not really correct anymore.\r\n\r\nKathey had a test case that she tried where she dropped the column and recreated it with longer length and the trigger seemed to work correctly for that case. I will debug that case to see what is different about it which makes it work. Hopefully, the same technique can be used for our broken case. I will get Kathey's test case a try and debug it to understand what is going on. Her test case is as follows\r\n\r\nALTER TABLE TAB DROP COLUMN altered_id; \r\nALTER TABLE TAB ADD COLUMN altered_id VARCHAR(64); \r\n\r\n-- insert the data \r\ninsert into tab (element_id, altered_id, counter, timets) VALUES (99, '012345678901234567890123456789001234567890',1,CURRENT_TIMESTAMP); \r\n\r\nupdate tab set timets = CURRENT_TIMESTAMP where ELEMENT_ID = 99; \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-11-02T17:07:40.419+0000","updated":"2010-11-02T17:07:40.419+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12927995","id":"12927995","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Here is what I found out about the test case of alter table to drop the column and another alter table to add the column back again. Although it appears that it is working(no exception thrown during the UPDATE sql but UPDATE trigger is not updating the table it is supposed to update). The test case is as follows\r\nFollowing is the schema to create the table and the trigger\r\nconnect 'jdbc:derby:wombat;create=true';\r\n-- Create the table\r\nCREATE TABLE tab (\r\n       element_id         INTEGER NOT NULL,\r\n       altered_id    \t  VARCHAR(30) NOT NULL,\r\n       counter            SMALLINT NOT NULL DEFAULT 0,\t\r\n       timets            TIMESTAMP NOT NULL\r\n);\r\n-- Create a trigger against the table\r\nCREATE TRIGGER mytrig\r\n AFTER UPDATE ON tab\r\n REFERENCING NEW AS newt OLD AS oldt\r\n FOR EACH ROW MODE DB2SQL\r\n  UPDATE tab set tab.counter = CASE WHEN (oldt.counter < 32767) THEN (oldt.counter + 1) ELSE 1 END\r\n  WHERE ((newt.counter is null) or (oldt.counter = newt.counter))\r\n  AND newt.element_id = tab.element_id\r\n  AND newt.altered_id = tab.altered_id;\r\n\r\n-- Next, we dop and recreate the column (with a different length) and a row into the table\r\nalter table tab drop column altered_id;\r\nALTER TABLE TAB ADD COLUMN altered_id VARCHAR(64); \r\ninsert into tab(element_id, altered_id, counter, timets) values (99, '1234567890',1,CURRENT_TIMESTAMP);\r\nselect * from tab;\r\nELEMENT_ID |COUNT&|TIMETS                    |ALTERED_ID\r\n----------------------------------------------------------------------------\r\n99         |1     |2010-11-03 10:05:29.39    |1234567890\r\n-- the following update will cause the trigger to fire which should increment the counter column's value from 1 to 2 but it doesn't. The explanation is below\r\nupdate tab set timets = CURRENT_TIMESTAMP where ELEMENT_ID = 99; \r\nselect * from tab;\r\nELEMENT_ID |COUNT&|TIMETS                    |ALTERED_ID\r\n99         |1     |2010-11-03 10:05:38.343   |1234567890\r\n\r\nThe trigger action gets changed internally before a SPSDescriptor is created for it\r\nUPDATE tab set tab.counter = CASE WHEN (CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getOldRow().getObject(3) AS SMALLINT) < 32767) THEN (CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getOldRow().getObject(3) AS SMALLINT) + 1) ELSE 1 END \r\n  WHERE ((CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getNewRow().getObject(3) AS SMALLINT) is null) or (CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getOldRow().getObject(3) AS SMALLINT) = CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getNewRow().getObject(3) AS SMALLINT) )) \r\n  AND CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getNewRow().getObject(1) AS INTEGER) = tab.element_id \r\n  AND CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getNewRow().getObject(2) AS VARCHAR(30)) = tab.altered_id \r\n\r\nAs we can see above, the columns are being accessed through column positions rather than names(this was done as part of DERBY-1258. But the column positions have changed in the underlying table because of the drop column and new column additions. The above sql, when it gets the column org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getNewRow().getObject(2), it is getting the column COUNTER rather than the column ALTERED_ID and because of that, the WHERE clause above returns FALSE and hence no row is updated by the trigger action.\r\n\r\nThis case is slightly different than the original test case where the ALTER TABLE changed the length of the existing column. I will explain the difference through the system tables. SYSTRIGGERS keeps track of the columns that are referenced in the trigger action. Those columns are later used at trigger execution time to decide which columns from the trigger table need to be actually fetched into memory. The column tracking is done through the column positions in the table. An ALTER TABLE which drops the column and adds it back again, then the column is going to get added into a new position in the table and hence the original column positions saved in SYSTRIGGERS are not going to be correct anymore. In a case like this, we want to recalculate the column positions of the trigger action columns and then regenerate the SQL for SPSDescriptor and compile the regenerated SQL. For our original case, where simply the length of the colunm was changed but not it's position, we just want to regenerate the SQL for SPSDescriptor and then compile that new query. For our original case, there is no need to recalculate the column positions of the trigger action columns. It may turn out to be easier to just do both the steps for all trigger invalidation (provided that the trigger has REFERENCES clause because the problem is only when trigger action is referenecing to old and new column values of the row. For all other trigger cases, we should be fine)\r\n\r\nI will file a jira for this problem and go back to looking at SPSDescriptor sql regerenation and updating SYSSTATEMENTS with that new sql.for a fix for the original problem.\r\n\r\nPlease let me know if anyone has any comments.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-11-03T20:47:00.465+0000","updated":"2010-11-03T21:48:45.324+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12928085","id":"12928085","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"If a trigger references a column, it seems like ALTER TABLE DROP COLUMN should either\r\n(a) refuse to run, because the trigger is referencing that column, or\r\n(b) drop the column, and also drop the trigger .\r\n\r\nLeaving the trigger in the system, referencing a non-existent column,\r\ndoes not seem like desirable behavior.\r\n\r\nIt seems like the \"CASCADE\" and \"RESTRICT\" forms of DROP COLUMN should\r\ncontrol whether case (a) or (b) is taken by the ALTER TABLE.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2010-11-04T01:43:03.324+0000","updated":"2010-11-04T01:43:03.324+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12928666","id":"12928666","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Bryan, thanks for going through this jira and commenting. I had similar thoughts about ALTER TABLE DROP COLUMNS's behavior. If the drop is CASCADE, I would have expected the trigger to be dropped and if RESTRICT, then drop column should have failed. I will put this info to in the new jira DERBY-4887.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-11-05T16:35:06.965+0000","updated":"2010-11-05T16:46:59.908+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12930642","id":"12930642","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I am currently running Junit suite with my changes which are not ready for commit. Once test that I see fails all the time is DatabaseMetaDataTest.testGetURL with following failure. I do not know why my changes would cause this failure. It seems like the terriotry and collation properties are switched by the getURL method. Has anyone seen this failure before?\r\n\r\njunit.framework.ComparisonFailure: getURL match expected:<...territory=en;collation=TERRITORY_BASED> but was:<...collation=TERRITORY_BASED;territory=en>\r\n\r\nAs for my changes, I have copied the relevant code from CreateTriggerNode into TriggerDescriptor to regenerate the trigger action statement. Currently, every reference to a column from new table in trigger action gets switched to \r\nCAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getNewRow().getObject(ColumnNumber) AS COLUMNDatatype)\r\nAnd every reference to \r\nCAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getOldRow().getObject(ColumnNumber) AS COLUMNDatatype)\r\n\r\nIn our specific case, the Alter table has changed the data type from varchar(30) to varchar(64) but the trigger action plan continued to use varchar(30). To fix varchar(30) casting to varchar(64), we need to regenerate the trigger action sql if \r\n1)the trigger is found to be invalid, \r\n2)the trigger is defined at row level (that is the only kind of trigger which allows reference to individual columns from old/new row)\r\n3)the trigger action plan has columns that reference old/new row columns\r\n\r\nI check for above 3 conditions when a trigger is going to be fired and if true, then regenerate the sql and update the SYSSTATEMENTS row for the trigger action plan stored prepared statement.\r\n\r\nAt this point, I have lot of code duplication but once I get all the tests running succesfully, I will post the patch as it is and then will work on avoiding the code duplication between CreateTriggerNode and TriggerDescriptor.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-11-10T16:26:06.929+0000","updated":"2010-11-10T16:26:06.929+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12931192","id":"12931192","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I have a patch which is not ready for commit yet because of a failure I still need to investigate. The failure is in lang/predicatesIntoViews.sql and it seems like that the trigger action plan is getting regenerated with wrong column numbers. I need to narrow down the test to a form where it is easier to debug. The part of the failure looks as follows\r\n$ java org.apache.derbyTesting.functionTests.harness.RunTest lang/predicatesIntoViews.sql\r\nderby.optimizer.noTimeout=true\r\n*** Start: predicatesIntoViews jdk1.6.0 2010-11-11 11:52:34 ***\r\n4739a4740,4756\r\n> ERROR 38000: The exception 'java.sql.SQLException: Column '3' not found.' was thrown while evaluating an expression.\r\n> ERROR S0022: Column '3' not found.\r\n\r\nI wanted to put out the patch in case anybody had comments on the general approach of the fix. Once I have the test failure fixed, I will try to put as much of the code as possible may be in DataDictionary and have both CreateTriigerNode and TriggerDescriptor call that code rather than have the duplication of the code in two places as it being done in my patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-11-11T20:52:27.387+0000","updated":"2010-11-11T20:52:27.387+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12931386","id":"12931386","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I took a look at the patch. Note that I'm not familiar with this part\r\nof the code, so my comments are only about how the code can be\r\nimproved, not about the correctness of the approach.\r\n\r\n1) I saw your comment about sharing code with CreateTriggerNode\r\ninstead of duplicating it... Yes, please! :)\r\n\r\n2) The changes in BaseMonitor don't seem to be related to this issue.\r\n\r\n3) The new method sortRefs() looks unnecessarily complex. In\r\nparticular:\r\n\r\n  a) The code that copies the Vector to an array, could be replaced\r\n  with a one-liner that just called toArray().\r\n\r\n  b) Using java.util.Collections.sort() sounds cleaner and less\r\n  error-prone than reimplementing bubble sort.\r\n\r\n4) I find the added code in getActionSPS() a bit hard to follow. It\r\nmay help if some short comments were added explaining the purpose of\r\nthe various if statements and for loops. (For example, the part of the\r\nJIRA comment from Nov 10 that says \"we need to regenerate the trigger\r\naction sql if 1) ... 2) ... 3) ...\" would be a helpful comment for the\r\nouter if statement.)\r\n\r\n5) In getActionSPS(), the code that sets all elements of\r\ntriggerColsAndTriggerActionCols to -1 could be simplified by using\r\njava.util.Arrays.fill().\r\n\r\n6) In getActionSPS(), (referencedColsInTriggerAction != null) is\r\nchecked both in the outer and the inner if statement, so one of the\r\nchecks is redundant and could be removed.\r\n\r\n7) The new variables in getActionSPS() are only used if the trigger\r\nneeds to be recompiled. It would be good to move the declarations\r\ninside the if statement so that we don't need to create a\r\nStringBuilder and check the version of the data dictionary in the\r\ncommon case.\r\n\r\n8) This code in getActionSPS() looks a bit suspicious:\r\n\r\n+\t\t\tDataDictionary dd = getDataDictionary();\r\n+\r\n+\t\t\tif (((org.apache.derby.impl.sql.catalog.DataDictionaryImpl) dd).readOnlyUpgrade)\r\n+\t\t\t\treturn actionSPS;\r\n\r\nEven if readOnlyUpgrade is false, it will still return actionSPS on\r\nthe next line, so this code appears to have no purpose.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2010-11-12T13:06:32.376+0000","updated":"2010-11-12T13:06:32.376+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12932345","id":"12932345","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Knut, thanks a bunch for taking the time to review the patch. In the attached patch, I have taken care of some of your comments. I am continuing to narrow down lang/predicatesIntoViews.sql to find out why wrong trigger action sql is getting regenerated as I mentioned in my comment on Nov 11th. The repro is pretty short compared to original lang/predicatesIntoViews.sql. I hope to narrow it down completely soon to be able to debug it. \r\n\r\nThe attached patch still has duplication of code. After I debug the lang/predicatesIntoViews.sql problem, I will next work on putting as much common code as possible in DataDictionary rather than having it in two places which is CreateTriggerNode and TriggerDescriptor. I will also add more comments to the code where applicable and add test cases for this jira.\r\n\r\nI took care of following feeback from you.\r\n1) I saw your comment about sharing code with CreateTriggerNode instead of duplicating it... Yes, please! :) \r\n*** I will work on this after taking care of lang/predicatesIntoViews.sql problem.\r\n\r\n2) The changes in BaseMonitor don't seem to be related to this issue. \r\n*** Thanks for catching it. I have removed that change from my codeline.\r\n\r\n3) The new method sortRefs() looks unnecessarily complex. In particular: \r\n  a) The code that copies the Vector to an array, could be replaced with a one-liner that just called toArray(). \r\n*** I tried using toArray() but got class cast exception. Didn't spend enough time on this yet but I have the code I tried commented out. Do you see something wrong with it?\r\n\r\n  b) Using java.util.Collections.sort() sounds cleaner and less error-prone than reimplementing bubble sort. \r\n*** This code has been in CreateTriggerNode but sometime and I am not sure why it was implemented this way. I will try to take a look at this after tackling the items mentioned above.\r\n\r\n4) I find the added code in getActionSPS() a bit hard to follow. It may help if some short comments were added explaining the purpose of the various if statements and for loops. (For example, the part of the JIRA comment from Nov 10 that says \"we need to regenerate the trigger action sql if 1) ... 2) ... 3) ...\" would be a helpful comment for the outer if statement.) \r\n*** I have adding comments in my todo list to make the code more readable but I did copy the reasons for regeneration into the code.\r\n\r\n5) In getActionSPS(), the code that sets all elements of triggerColsAndTriggerActionCols to -1 could be simplified by using \r\njava.util.Arrays.fill(). \r\n*** Thanks for this tip. I use now java.util.Arrays.fill() to do the array filling.\r\n\r\n6) In getActionSPS(), (referencedColsInTriggerAction != null) is checked both in the outer and the inner if statement, so one of the checks is redundant and could be removed. \r\n*** Thanks for noticing this, I have taken care of this.\r\n\r\n7) The new variables in getActionSPS() are only used if the trigger needs to be recompiled. It would be good to move the declarations inside the if statement so that we don't need to create a StringBuilder and check the version of the data dictionary in the common case. \r\n*** I took care of this.\r\n\r\n8) This code in getActionSPS() looks a bit suspicious: \r\n+ DataDictionary dd = getDataDictionary(); \r\n+ \r\n+ if (((org.apache.derby.impl.sql.catalog.DataDictionaryImpl) dd).readOnlyUpgrade) \r\n+ return actionSPS; \r\nEven if readOnlyUpgrade is false, it will still return actionSPS on the next line, so this code appears to have no purpose. \r\n*** You are right about this. I was experimenting updating SYSSTATEMENTS here but found that it is already being done as part of trigger invalidation. I have removed the code that you pointed out.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-11-16T05:37:32.210+0000","updated":"2010-11-16T05:37:32.210+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12932464","id":"12932464","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for making the changes, Mamta.\r\n\r\nAs to the ClassCastException, I think you need to invoke toArray() like this to make it return an array with the correct type:\r\n\r\n    sorted = (QueryTreeNode[]) refs.toArray(new QueryTreeNode[refs.size()]);","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2010-11-16T14:01:59.783+0000","updated":"2010-11-16T14:01:59.783+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12933934","id":"12933934","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Thanks, Knut. I will gave that a try.\r\n\r\nI was able to narrow done lang/predicatesIntoViews.sql problem to following sql\r\nconnect 'jdbc:derby:wombat;create=true';\r\ncreate table xr.repositoryobjectversion (\r\n\tid             varchar(48)\t\tnot null primary key,\r\n\tresourceid\t\tvarchar(48)\t\tnot null,\r\n\tname\t\t\tvarchar(128)\tnot null,\r\n\tuname\t\t\tvarchar(128),\r\n\tversionName\t\tvarchar(128)\tnot null\r\n\t);\r\n\t\r\ncreate trigger xr.rov_uname_i after insert on xr.repositoryobjectversion\r\nreferencing new as n\r\nfor each row\r\nupdate xr.repositoryobjectversion set uname = upper( n.name ) where name = n.name;\r\n\r\ncreate trigger xr.rov_unane_u after update of name, uname on xr.repositoryobjectversion\r\nreferencing new as n\r\nfor each row\r\nupdate xr.repositoryobjectversion set uname = upper( n.name )\r\n  where name = n.name and uname <> upper( n.name );\r\n\r\ncreate unique index xr.versionname on xr.repositoryobjectversion (resourceid, versionName);\r\n\r\nThe last sql which is creating the index invalidates the trigger and when we regenerate the action plan, we are regenerating the sql with the actual column number in the table rather than the relative column number of that column in the resultset that will be generated for the trigger. As a next step, I will debug this to see why the regenerated sql does not have the correct column number. Once I am done with this, I will work on reworking the code to put the common code in DataDictionary rather than the current duplication in CreateTriggerNode and TriggerDescriptor as done in my patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-11-19T19:49:50.824+0000","updated":"2010-11-19T19:49:50.824+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12968450","id":"12968450","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I am attaching a patch which now avoids the code duplication in CreateTriggerNode and TriggerDescriptor and has the two classes share majority of the code related to transformation of trigger action sql through DataDictionary class. It also resolves the problem where I was using the actual column position in the trigger table rather than the relative column position in the resultset for the trigger table which will be created at runtime. I would highly appreciate the feedback on the patch. It might be little hard to read because I have not put the comments in the code yet. I will work on that next and add a test case too but wanted to put the patch out if somebody had immediate comments. Thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-12-06T22:20:06.336+0000","updated":"2010-12-06T22:20:06.336+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12969883","id":"12969883","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I have committed the changes into trunk(10.8.0.0) with revision 1044096. The changes has comments and test for the code changes. Please let me know if anyone has any comments on the changes.\r\n\r\nThe commit comments are as follows\r\n\r\nDERBY-4874 Trigger does not recognize new size of VARCHAR column expanded with ALTER TABLE. It fails with ERROR 22001: A truncation error was encountered trying to shrink VARCHAR\r\n\r\nThe trigger action associated with a trigger gets converted as shown in the example below. This transformation happens if the trigger action has REFERENCEs clause.\r\n\tupdate xr.repositoryobjectversion set uname = upper( n.name )\r\n\t  where name = n.name and uname <> upper( n.name );\r\n\tturns into\r\n\tupdate xr.repositoryobjectversion set uname = \r\n\t  upper( CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getNewRow().getObject(3) AS VARCHAR(128)) ) \r\n\t  where name = CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getNewRow().getObject(3) AS VARCHAR(128))\r\nAs can be seen above, there is a CASTing involved which uses the length of the column in trigger table. \r\n\r\nIf say that length is changed by ALTER TABLE after the trigger has been created, that change in the length does not get reflected in the sql associated with the trigger action in the form on SPSDescriptor. In order to fix this, I have made changes which willcause us to regenerate the sql from the trigger action for the SPSDescriptor if we are working with an invalidated row level trigger which uses the REFERENCEs clause.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-12-09T19:21:23.833+0000","updated":"2010-12-09T19:21:23.833+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12970105","id":"12970105","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Hi Mamta,\r\n\r\nI noticed that you made the variable 'text' non-final, but didn't make the setter/getter synchronized. Do you know that's safe?\r\nSPSDescriptor can be used by several threads, and there's a comment about synchronization in the class JavaDoc. I made some changes in this area not long ago, and I discovered that this class can be ticklish when it comes to concurrent invalidation and compilation...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2010-12-10T08:39:31.210+0000","updated":"2010-12-10T08:39:31.210+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12970178","id":"12970178","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Hi Kristian, thanks for noticing that. I will go ahead and synchronize the getter and setter for the variable since it is not final anymore.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-12-10T14:21:56.197+0000","updated":"2010-12-10T14:21:56.197+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12971443","id":"12971443","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Attaching a backport for 10.6 release. I had to hand do these changes in 10.6 codeline because the changes in trunk depended on DERBY-1482. DERBY-1482 can't be backported to 10.6 and earlier because it had required system level changes which can't be backported to pre-released Derby products. I will be on vacation so won't be committing the changes yet. I will commit the changes in early January.\r\n\r\nDERBY-1482 was added into 10.7 codeline so a backport to 10.7 of this jira was straight forward. I have alreay committed this jira changes into 10.7","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-12-14T22:28:11.613+0000","updated":"2010-12-14T22:28:11.613+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12971444","id":"12971444","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Todo items for this jira\r\n\r\n1)It will be good to create a release note for this jira stating that the existing triggers will need to be dropped and recreated if the trigger table has had ALTER TABLE against it to change the length of the columns. This jira will take care of future ALTER TABLE statements changing the length of the column and any trigger using such columns in trigger action plan. \r\nI will create the release note once I am back from vacation.\r\n2)Implement Krisitian's suggestion to synchronize the setter and getter for variable text in SPSDescriptor in trunk and 10.7. This will later also have to be done as part of backport to 10.6 and under.\r\n3)Backport to 10.6 and below\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-12-14T22:28:57.292+0000","updated":"2010-12-14T23:52:12.200+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12975948","id":"12975948","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I thought I might look at the sychronization issue while Mamta is out, but am a little confused about what activity needs to be synchronized and wonder if just synchronizing getText and setText is enough or helpful as that would not prevent concurrent callers to the new TriggerDescriptor.getActionSPS() or prevent the text being changed  during compilation, etc.  Any helpful pointers and usage cases we are trying to protect  are welcome.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2010-12-30T00:35:21.291+0000","updated":"2010-12-30T00:35:21.291+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12977927","id":"12977927","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Backported the changes to 10.6 codeline with following commit comments\r\n\r\nBackporting the changes for DERBY-4874 to 10.6 codeline.\r\nDERBY-4874 Trigger does not recognize new size of VARCHAR column expanded with ALTER TABLE. It fails with ERROR 22001: A truncation error was encountered trying to shrink VARCHAR\r\n\r\nHad to hand do these changes rather than a simple migration from trunk because the changes in trunk depended on DERBY-1482. DERBY-1482 can't be backported to 10.6 and earlier because it had required system level changes which can't be backported to pre-released Derby products.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-05T19:40:52.690+0000","updated":"2011-01-05T19:40:52.690+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12978324","id":"12978324","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Bacported the changes to 10.3.3.1 codeline with following commit comments\r\n\r\nBackporting the changes for DERBY-4874 to 10.3 codeline. This backport to 10.3 has been the migration of changes committed to 10.6,\r\nDERBY-4874 Trigger does not recognize new size of VARCHAR column expanded with ALTER TABLE. It fails with ERROR 22001: A truncation error was encountered trying to shrink VARCHAR\r\n\r\nThe backport of DERBY-4874 from trunk to 10.6 codeline was done by hand (rather than a simple migration from trunk) because the changes in trunk depended on DERBY-1482. DERBY-1482 can't be backported to 10.6 and earlier because it had required system level changes which can't be backported to pre-released Derby products. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-06T14:00:46.807+0000","updated":"2011-01-06T14:00:46.807+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12978331","id":"12978331","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Kristian, I was wondering if you or anyone else had any feedback on Kathey's comment about synchronization (her comment copied below)\r\n\r\n\r\nI thought I might look at the sychronization issue while Mamta is out, but am a little confused about what activity needs to be synchronized and wonder if just synchronizing getText and setText is enough or helpful as that would not prevent concurrent callers to the new TriggerDescriptor.getActionSPS() or prevent the text being changed during compilation, etc. Any helpful pointers and usage cases we are trying to protect are welcome. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-06T14:18:43.255+0000","updated":"2011-01-06T14:18:43.255+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12978619","id":"12978619","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Bacported the changes to 10.4.2.1 codeline with following commit comments \r\n\r\nBackporting the changes for DERBY-4874 to 10.4 codeline. This backport to 10.4 has been the migration of changes committed to 10.6, \r\nDERBY-4874 Trigger does not recognize new size of VARCHAR column expanded with ALTER TABLE. It fails with ERROR 22001: A truncation error was encountered trying to shrink VARCHAR \r\n\r\nThe backport of DERBY-4874 from trunk to 10.6 codeline was done by hand (rather than a simple migration from trunk) because the changes in trunk depended on DERBY-1482. DERBY-1482 can't be backported to 10.6 and earlier because it had required system level changes which can't be backported to pre-released Derby products. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-07T02:39:07.186+0000","updated":"2011-01-07T02:39:07.186+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12978669","id":"12978669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"TriggerTest failed in the Tinderbox tests for 10.4 and 10.3 after the backport. Could it be related?\r\nhttp://dbtg.foundry.sun.com/derby/test/tinderbox_10.4_16/jvm1.6/testing/testlog/SunOS-5.10_i86pc-i386/1056174-org.apache.derbyTesting.functionTests.suites.All_diff.txt\r\nhttp://dbtg.foundry.sun.com/derby/test/tinderbox_10.3_16/jvm1.6/testing/testlog/SunOS-5.10_i86pc-i386/1055890-org.apache.derbyTesting.functionTests.suites.All_diff.txt","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-01-07T08:02:46.559+0000","updated":"2011-01-07T08:02:46.559+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12978794","id":"12978794","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I will take a look at those failures.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-07T14:30:06.938+0000","updated":"2011-01-07T14:30:06.938+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12978847","id":"12978847","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I didn't see these failures when I ran the junit suite on my laptop for both 10.4 and 10.3 before doing the checkin. I had used IBM's JVM1.6 rather than Sun's JVM1.6 which is what Tinderbox is using. The Tinderbox shows the errors in the basicSetup() method, part of which looks as follows. The method first drops the objects and then recreates them. If during the drop there is an exception, we just ignore it. The error encountered on Tinderbox is on the attempt to recreate table table1. This means that there may have been a failure during the drop but since we don't record the exception, I am not sure what the error may have been for the drop table1. The exception probably is logged into the derby,log. Can someone please tell me how to look at derby.log for a failed test on Tinderbox? Also, another thing to note in that the TriggerTest is run twice in junit suite. The first run of the test is fine, it is the second run of the test that runs into failure on Tinderbox.\r\n\r\n\tpublic void basicSetup() throws SQLException{\r\n        \t\tStatement s = createStatement();\r\n\t\ttry {\r\n\t\t\ts.execute(\"drop table table1\");\r\n\t\t} catch (SQLException sqle) {}\r\n\r\n\t\ttry {\r\n\t\t\ts.execute(\"drop table table2\");\r\n\t\t} catch (SQLException sqle) {}\r\n\r\n\t\ttry {\r\n\t\t\ts.execute(\"drop table table3\");\r\n\t\t} catch (SQLException sqle) {}\r\n\r\n\t\ttry {\r\n\t\t\ts.execute(\"drop trigger trigger1\");\r\n\t\t} catch (SQLException sqle) {}\r\n\r\n\t\ttry {\r\n\t\t\ts.execute(\"drop trigger trigger2\");\r\n\t\t} catch (SQLException sqle) {}\r\n\r\n\t\t//table1 is the main table on which all the testing is done and it \r\n\t\t//uses table2 at times to do DMLs as part of it's trigger action.\r\n\t\ts.execute(\"create table table1 (id int, status smallint, bl blob(2G))\");\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-07T16:31:36.692+0000","updated":"2011-01-07T17:39:03.711+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12978885","id":"12978885","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Backporting the changes for DERBY-4874 to 10.5 codeline. This backport to 10.5 has been the migration of changes committed to 10.6,\r\nDERBY-4874 Trigger does not recognize new size of VARCHAR column expanded with ALTER TABLE. It fails with ERROR 22001: A truncation error was encountered trying to shrink VARCHAR\r\n\r\nThe backport of DERBY-4874 from trunk to 10.6 codeline was done by hand (rather than a simple migration from trunk) because the changes in trunk depended on DERBY-1482. DERBY-1482 can't be backported to 10.6 and earlier because it had required system level changes which can't be backported to pre-released Derby products. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-07T17:51:54.644+0000","updated":"2011-01-07T17:51:54.644+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12979560","id":"12979560","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attaching derby.log from the fail directory in the failed tinderbox run on 10.4. Unfortunately, there are no exceptions that look related to the failure.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-01-10T12:07:52.858+0000","updated":"2011-01-10T12:07:52.858+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12979678","id":"12979678","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Knut, thanks for posting derby.log. I don't see anything in there which might indicate that earlier drop of the table1 failed which happens before an attempt is made to recreate table1. \r\n\r\nI did a dummy checkin to 10.3 on Friday to cause the tinerbox to run the tests again and the test did not fail on tinderbox again. I have to admit I am not sure at this point, why the test failed both on 10.3 and 10.4 \r\n\r\nBTW, the backporting of this jira to 10.5 didn't show any test failure. \r\n\r\nThe test runs on IBM's internal machines which can be found at http://people.apache.org/~myrnavl/derby_test_results/ also didn't show any failures for 10.3, 10.4, 10.5 and 10.6 codelines.\r\n\r\nI am running the junit suite on my laptop with Sun's jdk 1.6 to see if I can see the failure.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-10T18:47:05.496+0000","updated":"2011-01-10T18:47:05.496+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12979724","id":"12979724","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I am doing a dummy checkin to 10.4 codeline to see if tinderbox run will show the test failure again for the 10.4 codeline. A similar dummy checkin for 10.3 on Friday didn't show the test failure on 10.3 codeline on tinderbox.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-10T20:03:01.459+0000","updated":"2011-01-10T20:03:01.459+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12979746","id":"12979746","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I ran junit on my laptop on the 10.3 codeline with Sun's jdk 1.6 and that did not show the test failure either\r\n$ java -version\r\njava version \"1.6.0_21\"\r\nJava(TM) SE Runtime Environment (build 1.6.0_21-b07)\r\nJava HotSpot(TM) Client VM (build 17.0-b17, mixed mode)\r\n\r\nIf someone comes across this failure, please let me know. For now, I will assume maybe this was an intermittent test failure not related to my checkin","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-10T20:44:57.781+0000","updated":"2011-01-10T20:44:57.781+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12980020","id":"12980020","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attaching a patch (droptable.diff) that makes basicSetup() use a helper method in BaseJDBCTestCase to drop the tables. The helper method reports the exception if the table cannot be dropped for some other reason than that the table doesn't exist.\r\n\r\nCommitted to trunk with revision 1057542.\r\nMerged to 10.4 and committed revision 1057548.\r\n\r\nLet's see if we get more info now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-01-11T09:49:16.242+0000","updated":"2011-01-11T09:49:16.242+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12980823","id":"12980823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"http://dbtg.foundry.sun.com/derby/test/tinderbox_10.4_16/jvm1.6/testing/testlog/SunOS-5.10_i86pc-i386/1058108-org.apache.derbyTesting.functionTests.suites.All_diff.txt\r\n\r\nLooks like the table cannot be dropped because of a lock timeout.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-01-12T17:39:54.137+0000","updated":"2011-01-12T17:39:54.137+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12980900","id":"12980900","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I looked at the failing test fixtures(memory/triggerTests get run twice in junit, the first round has never shown the intermittent failure. It is the 2nd time around, when different test fixtures from memory/triggerTests run into intermittent failure. The test that I added for this jira(in lang/TriggerTest.java), testAlerColumnLength, gets run in the middle of the 2 runs of memory/triggerTests.) The test fixtures in memory/triggerTests are committing before they exit so I am not certain what kind of locks might be still held.\r\n\r\nI am looking to see if my code changes for this jira would kick in for failing tests to possibly cause any locking issues. I do update SYSSTATEMENTS table and am not sure how that plays into effect.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-12T20:12:35.420+0000","updated":"2011-01-12T20:12:35.420+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12980950","id":"12980950","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Spent some time looking at how my changes might impact the test and I couldn't find anything right away. The only time regeneration of sql for sps for trigger action plan will happen is if following is satisfied.\r\n\r\n\t\tif((!actionSPS.isValid() ||\r\n\t\t\t\t (actionSPS.getPreparedStatement() == null)) && \r\n\t\t\t\t isRow &&\r\n\t\t\t\t (oldReferencingName != null || newReferencingName != null)) \r\n\r\nWe check if trigger is invalid or has no prepared stmt associated with it, is a row trigger and it has either REFERECING CLAUSE referring to old or new. So this won't apply to the tests that are failing intermittently: Other than this, another related change in my checkin was in DataDictionaryImpl.updateSPS to include SYSSTATEMENTS_TEXT during sps update as shown below. But that shouldn't be a problem either because it will happen only during recompile to make sure that we copy the regenerated sql for trigger action plan in SYSSTATEMENTS.\r\n\r\n\t\tif (recompile)\r\n\t\t{\r\n\t\t\tif(firstCompilation)\r\n\t\t\t{\r\n\t\t\t\tupdCols = new int[] {SYSSTATEMENTSRowFactory.SYSSTATEMENTS_VALID,\r\n\t\t\t\t\t\t SYSSTATEMENTSRowFactory.SYSSTATEMENTS_TEXT,\r\n\t\t\t\t\t\t\t\t\t SYSSTATEMENTSRowFactory.SYSSTATEMENTS_LASTCOMPILED,\r\n\t\t\t\t\t\t\t\t\t SYSSTATEMENTSRowFactory.SYSSTATEMENTS_USINGTEXT,\r\n\t\t\t\t\t\t\t\t\t SYSSTATEMENTSRowFactory.SYSSTATEMENTS_CONSTANTSTATE,\r\n\t\t\t\t\t\t\t\t\t SYSSTATEMENTSRowFactory.SYSSTATEMENTS_INITIALLY_COMPILABLE};\r\n\t\t\t}else\r\n\t\t\t{\r\n\r\n\t\t\t\tupdCols = new int[] {SYSSTATEMENTSRowFactory.SYSSTATEMENTS_VALID,\r\n\t\t\t\t\t\t SYSSTATEMENTSRowFactory.SYSSTATEMENTS_TEXT,\r\n\t\t\t\t\t\t\t\t\t\t SYSSTATEMENTSRowFactory.SYSSTATEMENTS_LASTCOMPILED,\r\n\t\t\t\t\t\t\t\t\t\t SYSSTATEMENTSRowFactory.SYSSTATEMENTS_USINGTEXT,\r\n\t\t\t\t\t\t\t\t\t\t SYSSTATEMENTSRowFactory.SYSSTATEMENTS_CONSTANTSTATE };\r\n\t\t\t}\r\n\t\t}\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-12T21:42:08.013+0000","updated":"2011-01-12T21:42:08.013+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12980954","id":"12980954","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I looked at the test and the ouput.  It has the feel of a test/timing issue independant of mamta's change to me, but can't be sure until we can reproduce it.  My first guess is that there is some interaction going on with the background clean up thread and the test thread leading to the timeout.  The set of fixtures right before this error have some large blobs and multiple rows.  The delete tests then delete the rows and this is going to generate a lot of background cleanup work.  Then the first thing the next test does is drop the table with all that work, but each unit of work is going to run and then fail once the drop succeeds.  \r\n\r\nIt definitely seems like a timing thing as in the following tinderbox failure, one fixture fails, but the next one which \r\ndoes pretty much the same thing succeeds.:\r\nhttp://dbtg.foundry.sun.com/derby/test/tinderbox_10.4_16/jvm1.6/testing/testlog/SunOS-5.10_i86pc-i386/1057487-org.apache.derbyTesting.functionTests.suites.All_diff.txt\r\n\r\nThe most recent failure the last 2 fixures fail, and then no other fixtures are set to run.  \r\n\r\nSome info that might support this theory:\r\no  what kind of machine are the 10.4 and 10.3 tinderbox runs running on?  Are they single cpu - maybe slower than where the other tests are running.\r\no This test does not seem to set lock timeout, but is there a chance it is running with a less than default lock timeout.\r\n    Thinking about it, it might be a simple project to add the current locktimeout setting to the error message - might help\r\n    support with lock timeout issues.\r\no It might help to add the full lock table dump on the lock timeout for this test.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-01-12T21:44:59.929+0000","updated":"2011-01-12T21:44:59.929+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12980968","id":"12980968","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":">Some info that might support this theory:\r\n>o what kind of machine are the 10.4 and 10.3 tinderbox runs running on? Are they single cpu - maybe slower than where the other tests are running. \r\n\r\nAll tinderbox runs except trunk use this machine. It's a fairly old dual-cpu AMD Opteron. It's a lot slower than the machine that tests trunk (an 8-core machine), but it's the same as the 10.5 and 10.6 branches, which don't fail.\r\n\r\n> o This test does not seem to set lock timeout, but is there a chance it is running with a less than default lock timeout.\r\n>     Thinking about it, it might be a simple project to add the current locktimeout setting to the error message - might help\r\n>     support with lock timeout issues.\r\n\r\nFrom the log:\r\n\r\ntest5UpdateAfterTriggerNoReferencingClause used 3103 ms F.\r\ntest5UpdateBeforeTriggerNoReferencingClause used 3009 ms F.\r\n\r\n3 seconds shouldn't be enough to cause a lock timeout unless the timeout has been altered.\r\n\r\n> o It might help to add the full lock table dump on the lock timeout for this test.\r\n\r\nI've checked in a change to make it run with derby.locks.deadlockTrace=true (revision 1058340 on 10.4 branch).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-01-12T22:22:15.924+0000","updated":"2011-01-12T22:22:15.924+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12981174","id":"12981174","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Stack traces with lock table dumps can be found here: http://dbtg.foundry.sun.com/derby/test/tinderbox_10.4_16/jvm1.6/testing/testlog/SunOS-5.10_i86pc-i386/1058341-org.apache.derbyTesting.functionTests.suites.All_diff.txt","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-01-13T08:27:30.582+0000","updated":"2011-01-13T08:27:30.582+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12981902","id":"12981902","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I need to point out a difference between the synchronization code between 10.3 through 10.6 codelines and 10,7 through main codelines. In 10.7 and trunk, I didn't synchronize the getter and setter for field \"text\" in SPSDescriptor. While hand migrating these changes to 10.6 codeline, I experiemented with synchronization in SPSDescriptor and checked in the changes into 10.6 through 10.3 with synchronization in it. I will go ahead and make the same changes to trunk and 10.7 codelines so all the codelines are at the same level for this jira. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-14T19:52:37.443+0000","updated":"2011-01-14T19:55:25.358+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12982700","id":"12982700","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Attaching the release note","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-17T16:44:29.957+0000","updated":"2011-01-17T16:44:29.957+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12983272","id":"12983272","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Put in the synchronization code in trunk (revision 1060480) with following commit comment\r\n\r\nPutting the synchronization code in SPSDescriptor for getter and setter methods for the field \"text\" (this code is already in 10.6, 10.5, 10.4 and 10.3). Will put this code in 10.7 codeline next. This way, all the codelines from 10.3 through trunk will have the same synchronization code\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-01-18T17:20:14.178+0000","updated":"2011-01-18T17:20:14.178+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12990144","id":"12990144","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Has anyone looked more into the failures on 10.3 and 10.4 after the back-porting of this issue? Is the current hypothesis that the lock timeouts happen because the post-commit work in the background thread takes a long time while holding locks on the table that is about to be dropped?\r\n\r\nThe three second lock timeout in this test may come from ResultSetMiscTest and SetTransactionIsolationTest, which reduce the lock timeout to three seconds. Before DERBY-4273 they didn't restore the original lock timeout on completion, but now they do. DERBY-4273 is fixed on the 10.5 branch, which may explain why we only see this issue on 10.4 and 10.3. It doesn't explain why we haven't seen this issue before, though.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-02-03T15:57:36.064+0000","updated":"2011-02-03T15:57:36.064+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12990460","id":"12990460","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Knut, I will work on backporting to 10.4 and 10.3 the subset of DERBY-4273 which restores the original lock timeout on completion of ResultSetMiscTest and SetTransactionIsolationTest and see if that helps with the intermittent failure on those 2 codelines\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-02-04T06:00:59.215+0000","updated":"2011-02-04T06:00:59.215+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12990766","id":"12990766","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Backported to 10.4 the subset of DERBY-4273 which restores the original lock timeout on completion of ResultSetMiscTest and SetTransactionIsolationTest and see if that helps with the intermittent failure on 10.4 codeline. Will next backport it to 10.3\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-02-04T22:02:03.661+0000","updated":"2011-02-04T22:02:03.661+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12991226","id":"12991226","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Finished backporting to 10.3 the subset of DERBY-4273 which restores the original lock timeout on completion of ResultSetMiscTest and SetTransactionIsolationTest and see if that helps with the intermittent failure on 10.3 codeline.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-02-06T22:02:15.519+0000","updated":"2011-02-06T22:02:15.519+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/12991304","id":"12991304","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks, Mamta. TriggerTests succeeded in the latest Tinderbox runs on 10.3 and 10.4. The failure was intermittent, so we cannot say for sure that it was fixed based on one run of the Tinderbox, but it looks promising.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-02-07T08:29:53.427+0000","updated":"2011-02-07T08:29:53.427+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/13208144","id":"13208144","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Will go ahead and close this issue since there is nothing outstanding at this point. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-02-15T00:01:49.483+0000","updated":"2012-02-15T00:01:49.483+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/13685145","id":"13685145","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"[bulk update] Close all resolved issues that haven't been updated for more than one year.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-06-17T09:19:09.837+0000","updated":"2013-06-17T09:19:09.837+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/13792459","id":"13792459","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1531226 from [~knutanders] in branch 'code/trunk'\r\n[ https://svn.apache.org/r1531226 ]\r\n\r\nDERBY-534: Support use of the WHEN clause in CREATE TRIGGER statements\r\n\r\nMake the code in TriggerDescriptor.getActionSPS() reusable for\r\nTriggerDescriptor.getWhenClauseSPS() so that the fixes for DERBY-4874\r\nand Cloudscape bug 4821 also get applied to the WHEN clause.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2013-10-11T08:29:16.969+0000","updated":"2013-10-11T08:29:16.969+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478632/comment/13810589","id":"13810589","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1537593 from [~mamtas] in branch 'code/trunk'\r\n[ https://svn.apache.org/r1537593 ]\r\n\r\nDERBY-6383(Update trigger defined on one column fires on update of other columns). \r\n\r\nThis regression is caused by DERBY-4874(Trigger does not recognize new size of VARCHAR column expanded with ALTER TABLE. It fails with ERROR 22001: A truncation error was\r\nencountered trying to shrink VARCHAR)\r\n\r\nThe regression is for Statement level triggers. The statement trigger gets fired incorrectly for any column update rather than just the column specified in the UPDATE of column clause. The fix is going to ensure that SYSTRIGGERS has the correct list of columns on which trigger should be fired. Row level triggers work fine. The only workaround at this point is to drop and recreate the statement triggers.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2013-10-31T19:29:19.705+0000","updated":"2013-10-31T19:29:19.705+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4874/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06jkn:"}}
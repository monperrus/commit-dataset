{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12386268","self":"https://issues.apache.org/jira/rest/api/latest/issue/12386268","key":"DERBY-3319","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2008-03-31 15:34:28.001","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23570","customfield_12310222":"3_*:*_1_*:*_9701189045_*|*_1_*:*_1_*:*_15011560669_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_343603984","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-10-27T15:23:30.207+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3319/watchers","watchCount":0,"isWatching":false},"created":"2008-01-15T14:44:20.493+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312876","id":"12312876","description":"","name":"10.3.2.1","archived":false,"released":true,"releaseDate":"2007-12-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12325645","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12325645","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12414620","key":"DERBY-4053","self":"https://issues.apache.org/jira/rest/api/2/issue/12414620","fields":{"summary":"Network Server's failure to rollback local transactions on shutdown can cause  hang on startup with message java.net.BindException: Address already in use: NET_Bind in derby.log ","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12325672","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12325672","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12331782","key":"DERBY-1191","self":"https://issues.apache.org/jira/rest/api/2/issue/12331782","fields":{"summary":"Some SQLExceptions, for example those generated from BrokeredStatements,  do not print to derby.log even  when  derby.stream.error.logSeverityLevel=0","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"New"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12325669","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12325669","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12425194","key":"DERBY-4225","self":"https://issues.apache.org/jira/rest/api/2/issue/12425194","fields":{"summary":"EmbeddedConnectionPoolDataSource40 never calls the ConnectionEventListener calbacks","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.png","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-07-14T17:52:04.680+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11407","id":"11407","name":"JDBC"},{"self":"https://issues.apache.org/jira/rest/api/2/component/11690","id":"11690","name":"Network Client"}],"timeoriginalestimate":null,"description":"If you call close on a logical connection, for instance as obtained through a PooledConnection, it does not check if there is an active transaction.\nThe close of the logical connection is allowed, and even the close of the parent PooledConnection is allowed in the client driver. This can/will cause resources to be left on the server, and later operations might fail (typically with lock timeouts because the \"closed\" transaction is still holding locks).\nI do not know if gc will solve this eventually, but I would say the current behavior of the client driver is wrong in any case.\nThere is difference in the behavior between the embedded and the client driver, and there also seems to be a bug in the embedded driver.\n\nThe analysis above is a bit sketchy, so it might be required to look into the issue a bit more...\nI will attach a repro (JDBC usage should be verified as well, is it legal / as intended?)","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"38380","summary":"Logical connections do not check if a transaction is active on close","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10101","value":"Release Note Needed","id":"10101"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Embedded driver and client driver.","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":15,"total":15,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12559073","id":"12559073","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"'LogicalConnectionCloseActiveTransactionBug.java' is a repro for this issue.\r\nNote the system property for running with the embedded or the client driver. Read class comment for how to compile/run.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-01-15T14:46:02.697+0000","updated":"2008-01-15T14:46:02.697+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12573733","id":"12573733","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"A test in jdbcapi.StatementPoolingTest has been disabled due to this bug:\r\n        // This test fails, DERBY-3319 is probably the cause.\r\n        //reqDataSuite.addTest(new StatementPoolingTest(\r\n        //        \"resTestNoDataCommittedOnInvalidTransactionState\"));\r\n\r\nIt should be enabled and verified when this bug has been fixed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-02-29T13:26:59.418+0000","updated":"2008-02-29T13:26:59.418+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12583724","id":"12583724","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Let's see if I understand this issue correctly. Based on experiments with the attached test case, I think this is how the drivers behave:\r\n\r\n1. close() on logical connections with active transactions does not fail and resources are not freed (both embedded and client)\r\n\r\n2. EmbedPooledConnection.getConnection() issues a rollback on the physical connection\r\n\r\n3. ClientPooledConnection.getConnection() does not issue a rollback on the physical connection if the previous logical connection has been closed\r\n\r\n4. ClientPooledConnection.getConnection() issues a rollback on the physical connection if the previous logical connection has not been closed\r\n\r\nDoes that sound about right?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-03-31T15:34:28.001+0000","updated":"2008-03-31T15:34:28.001+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12584874","id":"12584874","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"I would think points 1 is incorrect behavior. If that one is fixed, I think point 3 might be okay.\r\n\r\nPoints 2 and 4 are good. I believe it is required to be able to support \"connection stealing\", i.e. when a connection pool implementation executes a sequence like this:\r\nPooledConnection pc = ...\r\nConnection lc1 = pc.getConnection()\r\n// Give lc1 to a user/client.\r\n// Then wait, and determine that the user having lc1 has crashed / timed out / misbehaved.\r\n// Take back control of the physical connection and give a new logical connection to another user.\r\nConnection lc2 = pc.getConnection()\r\n// lc1 will now be closed / invalidated and should not contain any reference to the pooled / physical connection.\r\n\r\nWe should not throw an exception in this case. Also note that the reference to the PooledConnection will normally not be available to end-users.\r\nI logged this issue to get point 1 fixed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-04-02T22:48:31.717+0000","updated":"2008-04-02T22:48:31.717+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12609618","id":"12609618","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Regarding the \"connection stealing\", it seems like that's what ClientPooledConnection, ClientXAConnection and EmbedPooledConnection do. However, EmbedXAConnection only steals the connection if it is not part of a global connection. If it is part of a global XA connection, an exception is thrown. Here's the relevant code and comment in EmbedXAConnection.getConnection():\r\n\r\n\t\t\tif (currentConnectionHandle != null) {\r\n\t\t\t\t// this can only happen if someone called start(Xid),\r\n\t\t\t\t// getConnection, getConnection (and we are now the 2nd\r\n\t\t\t\t// getConnection call).\r\n\t\t\t\t// Cannot yank a global connection away like, I don't think... \r\n\t\t\t\tthrow Util.generateCsSQLException(\r\n\t\t\t\t\t\t\t   SQLState.CANNOT_CLOSE_ACTIVE_XA_CONNECTION);\r\n\t\t\t}\r\n\r\nI'm not sure what the correct approach is in this case. For pooled connections, I see that it makes sense to allow stealing the connection and aborting the active transaction because of the reasons Kristian mentioned above, but it's not clear to me if the same would apply to global XA connections.\r\n\r\nOne difference between pooled connections and XA connections in this respect is that PooledConnection.getConnection() is expected to return a fresh logical connection that executes in a different transaction than the previous logical connection, whereas the connection returned by XAConnection.getConnection() is expected to execute in the same global transaction as the previous logical connection did. At least, J2EEDataSourceTest is testing that they behave this way, so I assume that it is expected.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-07-01T15:18:35.430+0000","updated":"2008-07-01T15:18:35.430+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12610917","id":"12610917","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Currently, plain connections (from DriverManager) throw an exception on close if they have uncommitted operations and they have auto-commit off. I think connections that come from data sources should behave the same way, but if the connection is associated with an XA transaction, I think it should not throw an exception because\r\n\r\n  a) the connection object doesn't control commit/rollback. Even if the connection is closed, the global transaction can still be committed or rolled back with the XAResource. I think the rationale for disallowing close on plain connections when the transaction is active, is that there's no way to end the transaction after the connection is closed. Since this is not the case for XA transactions, there's no need to throw the exception.\r\n\r\n  b) there are regression tests that depend on the ability to close a connection before ending the associated XA transaction (sequences like XAResource.start() ... XAConnection.getConnection() ... Connection.close() ... XAConnection.getConnection() ... Connection.close() ... XAResource.end()) so keeping the current behaviour for these connections sounds safer\r\n\r\nUnless there are objections to this approach, I'll post a patch which implements this new behaviour.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-07-07T08:57:17.470+0000","updated":"2008-07-07T08:57:17.470+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12611570","id":"12611570","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Here's a patch that changes the behaviour as described in the previous\r\ncomment. The patch touches the following files:\r\n\r\nEmbedded:\r\n\r\nM      java/engine/org/apache/derby/impl/jdbc/EmbedConnection.java\r\n\r\n  - factored out code to check for active transaction in close() so\r\n    that it can be used in EmbedPooledConnection too\r\n\r\nM      java/engine/org/apache/derby/iapi/jdbc/BrokeredConnectionControl.java\r\n\r\n  - new interface method to check if it is allowed to close a brokered\r\n    connection (checkClose())\r\n\r\nM      java/engine/org/apache/derby/jdbc/EmbedPooledConnection.java\r\n\r\n  - implementation of BrokeredConnectionControl.checkClose()\r\n\r\n  - in getConnection(), reset the physical connection before closing\r\n    the existing logical connection, so that an exception isn't thrown\r\n    if the logical connection is still active\r\n\r\nM      java/engine/org/apache/derby/jdbc/EmbedXAConnection.java\r\n\r\n  - factored out common code to check if the transaction is global\r\n    into a helper method (isGlobal())\r\n\r\n  - implementation of BrokeredConnectionControl.checkClose()\r\n\r\nM      java/engine/org/apache/derby/iapi/jdbc/BrokeredConnection.java\r\n\r\n  - use BrokeredConnectionControl.checkClose() in close() to get the\r\n    expected exception when the transaction is active\r\n\r\nClient:\r\n\r\nM      java/client/org/apache/derby/client/net/NetConnection.java\r\n\r\n  - fixed existing method (allowCloseInUOW_()) for checking if the\r\n    connection can be closed in unit of work (previously is always\r\n    returned false)\r\n\r\nM      java/client/org/apache/derby/client/am/Connection.java\r\n\r\n  - transactionInProgress(): check NetConnection.allowCloseInUOW_()\r\n    instead of the autoCommit_ flag to find out if a transaction in\r\n    progress prevents us from closing the connection. Without this\r\n    change, XAConnection.getConnection() thinks that it needs to roll\r\n    back active global XA transactions, which it is not allowed to do.\r\n\r\n  - checkForTransactionInProgress(): don't check allowCloseInUOW_()\r\n    since it is now checked in transactionInProgress()\r\n\r\nM      java/client/org/apache/derby/client/am/LogicalConnection.java\r\n\r\n  - call checkForTransactionInProgress() from close() to get the\r\n    expected exception when the transaction is active\r\n\r\nTests:\r\n\r\nM      java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/StatementPoolingTest.java\r\n\r\n  - enabled the test case that had been disabled because of this issue\r\n\r\n  - fixed two occurrences of connections being closed with active\r\n    transactions\r\n\r\nM      java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/J2EEDataSourceTest.java\r\n\r\n  - test cases for close of active connections with all combinations of\r\n    { auto-commit, no auto-commit } ×\r\n    { DataSource, ConnectionPoolDS, local XADataSource, global XADataSource} ×\r\n    { client, embedded }\r\n\r\n\r\nAll the regression tests passed, except for the wisconsin test, which\r\npassed on rerun.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-07-08T13:11:05.172+0000","updated":"2008-07-08T13:11:05.172+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12612809","id":"12612809","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Committed revision 675870.\r\n\r\nI think a release note is needed, since now we'll throw an exception where we previously didn't, so I'm leaving the issue open for now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-07-11T08:57:51.966+0000","updated":"2008-07-11T08:57:51.966+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12642940","id":"12642940","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attaching a release note for this issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-10-27T15:21:24.659+0000","updated":"2008-10-27T15:21:24.659+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12644156","id":"12644156","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Release note looks good to me.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2008-10-30T23:18:34.398+0000","updated":"2008-10-30T23:18:34.398+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12644310","id":"12644310","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Closing issue.\r\n\r\nI verified that the repro no longer failed with trunk, and that it did indeed fail with 10.4 (that is, it threw an exception in a different place - when closing the last physical PooledConnection).\r\nThe release notes also look good.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-10-31T14:50:14.118+0000","updated":"2008-10-31T14:50:14.118+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12730470","id":"12730470","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"In addition to DERBY-4053,  I think we had a user report of a hard to diagnose issue after this change. To facilitate diagnosis, should the error that the connection cannot be closed be logged to derby.log especially if derby.stream.error.logSeverityLevel=0?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-13T19:17:04.436+0000","updated":"2009-07-13T19:17:04.436+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12730485","id":"12730485","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Linking DERBY-4053.\r\nThe new requirement that local transactions be rolled back before closing pooled connections was causing network server to fail to shutdown properly.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-13T20:02:56.328+0000","updated":"2009-07-13T20:02:56.328+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12730801","id":"12730801","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Kathey, since the error has statement severity (20000) it is worth filing a bug if it's not automatically logged with logSeverityLevel=0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-07-14T12:03:10.275+0000","updated":"2009-07-14T12:03:10.275+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386268/comment/12730999","id":"12730999","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I raised the priority of DERBY-1191 for the general case and linked it to this issue.  I think this particular case is pretty urgent as it seems really hard to track these issues down as we found in DERBY-4053 and DERBY-4225 but I don't know if it is easier just to fix the general case.  If not a subtask of DERBY-1191 can be filed to fix this one.\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-14T17:52:04.678+0000","updated":"2009-07-14T17:52:04.678+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3319/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06xm7:"}}
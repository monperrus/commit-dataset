{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12690110","self":"https://issues.apache.org/jira/rest/api/latest/issue/12690110","key":"LUCENE-5409","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310110","id":"12310110","key":"LUCENE","name":"Lucene - Core","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310110&avatarId=10061","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310110&avatarId=10061","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310110&avatarId=10061","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310110&avatarId=10061"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12325572","id":"12325572","description":"Major release after 4.6","name":"4.7","archived":false,"released":true,"releaseDate":"2014-02-26"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321663","id":"12321663","description":"Current trunk","name":"Trunk","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-01-22 15:14:53.051","customfield_12312323":null,"customfield_12310420":"369067","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_590094201_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2014-01-28T17:00:34.916+0000","workratio":0,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-5409/watchers","watchCount":3,"isWatching":false},"created":"2014-01-21T21:05:40.773+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":604800,"aggregatetimeoriginalestimate":604800,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324999","id":"12324999","description":"Major release after 4.5","name":"4.6","archived":false,"released":true,"releaseDate":"2013-11-24"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-03-16T13:02:16.435+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12310235","id":"12310235","name":"core/search","description":"issues with search code"}],"timeoriginalestimate":604800,"description":"A bug is observed to cause unstable results returned by the getTopGroups function of class ToParentBlockJoinCollector.\r\n\r\nIn the scorer generation stage, the ToParentBlockJoinCollector will automatically rewrite all the associated ToParentBlockJoinQuery (and their subqueries), and save them into its in-memory Look-up table, namely joinQueryID (see enroll() method for detail). Unfortunately, in the getTopGroups method, the new ToParentBlockJoinQuery parameter is not rewritten (at least users are not expected to do so). When the new one is searched in the old lookup table (considering the impact of rewrite() on hashCode()), the lookup will largely fail and eventually end up with a topGroup collection consisting of only empty groups (their hitCounts are guaranteed to be zero).\r\n\r\nAn easy fix would be to rewrite the original BlockJoinQuery before invoking getTopGroups method. However, the computational cost of this is not optimal. A better but slightly more complex solution would be to save unrewrited Queries into the lookup table.","customfield_10010":null,"timetracking":{"originalEstimate":"168h","remainingEstimate":"168h","originalEstimateSeconds":604800,"remainingEstimateSeconds":604800},"customfield_12310120":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10121","value":"New","id":"10121"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":604800,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"369372","summary":"ToParentBlockJoinCollector.getTopGroups returns empty Groups","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":604800,"percent":0},"customfield_12311024":null,"environment":"Ubuntu 12.04","customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":604800,"percent":0},"comment":{"startAt":0,"maxResults":18,"total":18,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13878749","id":"13878749","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Hi Peng, this is a good catch!  Probably we could key on the .origChildQuery since we already carry that one along.\r\n\r\nDo you have a test case showing the issue?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2014-01-22T15:14:53.051+0000","updated":"2014-01-22T15:14:53.051+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13878809","id":"13878809","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"body":"Hi Michael, I'll be working on the test case this evening.\r\nThanks a lot for the confirmation. I've read your book.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"created":"2014-01-22T16:21:22.453+0000","updated":"2014-01-22T16:21:22.453+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13879447","id":"13879447","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"body":"I was trying to work on a test case but have encountered the following problem:\r\n\r\nThe bug will only be triggered if a ToParentBlockJoinQuery can be rewritten into another query with a different hashcode (Uwe said this is a common situation). But I've experimented with several simple Query and they all have identical hashcode after the rewriting. The query that failed in my project was a very long CustomScoreQuery (used for feature engineering in text analysis), I wouldn't imagine to put that into the unit test. So can you show me an example of a compound query that doesn't preserve hashcode? I can finish other works.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"created":"2014-01-23T05:18:14.893+0000","updated":"2014-01-23T05:18:14.893+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13879858","id":"13879858","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Hmm, maybe a BooleanQuery containing just a single TermQuery?\r\n\r\nOr, maybe create a custom Query for this test that wraps another query but has its own \"unusual\" hashCode() impl...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2014-01-23T11:10:39.382+0000","updated":"2014-01-23T11:10:39.382+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13880597","id":"13880597","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"body":"Still doesn't work, this is my test case, perhaps I still need to implement a Query with custom rewrite and hashcode\r\n\r\n  public void testRewriteHash() throws IOException\r\n  {\r\n    final Directory dir = newDirectory();\r\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir);\r\n\r\n    final List<Document> docs = new ArrayList<Document>();\r\n\r\n    docs.add(makeJob(\"java\", 2007));\r\n    docs.add(makeJob(\"python\", 2010));\r\n    docs.add(makeResume(\"Lisa\", \"United Kingdom\"));\r\n    w.addDocuments(docs);\r\n\r\n    docs.clear();\r\n    docs.add(makeJob(\"ruby\", 2005));\r\n    docs.add(makeJob(\"java\", 2006));\r\n    docs.add(makeResume(\"Frank\", \"United States\"));\r\n    w.addDocuments(docs);\r\n\r\n    IndexReader r = w.getReader();\r\n    w.close();\r\n    IndexSearcher s = newSearcher(r);\r\n\r\n    Query q = new TermQuery(new Term(\"skill\",\"rudy\"));\r\n    BooleanQuery qc = new BooleanQuery();\r\n    qc.add(q,Occur.SHOULD);\r\n    Filter parentsFilter = new FixedBitSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"docType\", \"resume\"))));\r\n\r\n    Query qp = new ToParentBlockJoinQuery(qc,parentsFilter,ScoreMode.Max);\r\n    int hash1 = qp.hashCode();\r\n    Query qw = s.rewrite(qp);\r\n    int hash2 = qp.hashCode();\r\n\r\n    assertTrue(hash1 != hash2);\r\n  }","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"created":"2014-01-24T01:23:26.667+0000","updated":"2014-01-24T01:24:38.293+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13880890","id":"13880890","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Interesting ... because the hashCode for the TermQuery and the BooleanQuery do in fact differ.\r\n\r\nOK I see what's happening: ToParentBJQ.hashCode uses *origChildQuery* to compute its hashcode (and in .equals); so ... rewrite won't change it, by design.\r\n\r\nHmm, which then seems like you should not be hitting an issue here?  Maybe try to boil down your problem to a small test case?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2014-01-24T10:53:47.778+0000","updated":"2014-01-24T10:53:47.778+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13881342","id":"13881342","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"body":"That's a good point. but I also speculate that ToParentBJQ.rewrite() will change origChildQuery:\r\n      Query rewritten = new ToParentBlockJoinQuery(childQuery,\r\n                                childRewrite,\r\n                                parentsFilter,\r\n                                scoreMode);\r\nif rewrite is executed >twice, the origChildQuery won't be the same.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"created":"2014-01-24T19:29:02.996+0000","updated":"2014-01-24T19:29:02.996+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13881359","id":"13881359","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"body":"Wow I just changed rewritten code to use origChildQuery:\r\n      Query rewritten = new ToParentBlockJoinQuery(origChildQuery,\r\n                                childRewrite,\r\n                                parentsFilter,\r\n                                scoreMode);\r\nand it passed all unit test, I never thought the fix being that easy. Thank you so much for pointing it out!\r\nAlso, is it possible to close the trivial LUCENE-5398?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"created":"2014-01-24T19:44:41.529+0000","updated":"2014-01-24T19:44:41.529+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13881464","id":"13881464","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Ahh ... two rewrites will store the wrong origChildQuery.  Nice catch :)\r\n\r\nBut: do we first have a failing test case here?\r\n\r\nAlso, were you rewriting yourself externally in your application?  Or is there some path through Lucene that results in more than one rewrite?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2014-01-24T21:58:10.882+0000","updated":"2014-01-24T21:58:10.882+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13881505","id":"13881505","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"body":"Not yet, I'm trying to find a special case.\r\nI never rewrite myself (so does most of lucene users) but IndexSearcher.rewrite method used in search(...) will rewrite any query recursively until it reaches the final stage.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"created":"2014-01-24T22:45:55.370+0000","updated":"2014-01-24T22:45:55.370+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13882104","id":"13882104","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"bq. I never rewrite myself (so does most of lucene users) but IndexSearcher.rewrite method used in search(...) will rewrite any query recursively until it reaches the final stage.\r\n\r\nAhh, right.\r\n\r\nBut still I'm confused how this would tickle the bug.  Clearly the bug is there, and we should be passing origChildQuery as the first arg when we rewrite, but I'd still like a small test case here showing the issue, somehow ...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2014-01-25T23:10:33.960+0000","updated":"2014-01-25T23:10:33.960+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13883693","id":"13883693","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"body":"Finally got your test case: it only appears in larger scale, this is really excruciating as I'm not a software architect.\r\n\r\nTo run the failed test case, please apply the attached patch or manually copy the unit test function into testBlockJoin.java","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"created":"2014-01-28T02:55:53.422+0000","updated":"2014-01-28T02:55:53.422+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13883694","id":"13883694","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"body":"patch file","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"created":"2014-01-28T02:56:29.971+0000","updated":"2014-01-28T02:56:29.971+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13884265","id":"13884265","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Wow, thanks Peng!  I'll have a look.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2014-01-28T15:49:23.001+0000","updated":"2014-01-28T15:49:23.001+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13884325","id":"13884325","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1562124 from [~mikemccand] in branch 'dev/trunk'\r\n[ https://svn.apache.org/r1562124 ]\r\n\r\nLUCENE-5409: fix ToParentBlockJoinQuery.rewrite to correctly preserve the origChildQuery after more than one iteration of rewrite","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-01-28T16:59:08.210+0000","updated":"2014-01-28T16:59:08.210+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13884326","id":"13884326","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1562125 from [~mikemccand] in branch 'dev/branches/branch_4x'\r\n[ https://svn.apache.org/r1562125 ]\r\n\r\nLUCENE-5409: fix ToParentBlockJoinQuery.rewrite to correctly preserve the origChildQuery after more than one iteration of rewrite","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-01-28T17:00:14.110+0000","updated":"2014-01-28T17:00:14.110+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13884327","id":"13884327","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Thanks Peng, I just committed this.  I tweaked the test a bit to reduce the number of indexed docs ...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2014-01-28T17:00:34.944+0000","updated":"2014-01-28T17:00:34.944+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12690110/comment/13884424","id":"13884424","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"body":"Pleasure to be of service, also thanks Aaron Colak and Long Yao at sciencescape.net for support.\r\nDo I need a test case to resolve LUCENE-5398?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=peng","name":"peng","emailAddress":"pc175 at uow dot edu dot au","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peng Cheng","active":true},"created":"2014-01-28T18:54:08.255+0000","updated":"2014-01-28T18:54:08.255+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-5409/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1rm1j:"}}
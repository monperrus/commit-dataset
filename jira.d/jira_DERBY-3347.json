{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12386981","self":"https://issues.apache.org/jira/rest/api/latest/issue/12386981","key":"DERBY-3347","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313142","id":"12313142","description":"","name":"10.3.3.0","archived":false,"released":true,"releaseDate":"2008-05-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2008-01-24 15:36:33.878","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23586","customfield_12310222":"3_*:*_1_*:*_506245341_*|*_1_*:*_1_*:*_6534200556_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-04-14T10:17:04.275+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3347/watchers","watchCount":1,"isWatching":false},"created":"2008-01-23T22:36:18.378+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"9.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312876","id":"12312876","description":"","name":"10.3.2.1","archived":false,"released":true,"releaseDate":"2007-12-10"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12320560","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320560","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12377586","key":"DERBY-3052","self":"https://issues.apache.org/jira/rest/api/2/issue/12377586","fields":{"summary":"testStalePlanCheckIntervalOutOfRange(org.apache.derbyTesting.functionTests.tests.lang.StalePlansTest) fails with java.sql.SQLException: Log Record has been sent to the stream, but it cannot be applied to the store (Object null)","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12327965","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12327965","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12361805","key":"DERBY-2284","self":"https://issues.apache.org/jira/rest/api/2/issue/12361805","fields":{"summary":"OnlineBackupTest1 fails with ERROR XSDB3: Container information cannot change once written: was 0, now 80","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12320561","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320561","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12368029","key":"DERBY-2589","self":"https://issues.apache.org/jira/rest/api/2/issue/12368029","fields":{"summary":"'Exception while trying to insert row number: XXXXX' in store/OnlineCompressTest.java","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12320633","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320633","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12369901","key":"DERBY-2677","self":"https://issues.apache.org/jira/rest/api/2/issue/12369901","fields":{"summary":"OnlineCompressTest failed reporting NullPointerException, actual problem in derby.log is a page checksum error.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12320562","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320562","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12380962","key":"DERBY-3143","self":"https://issues.apache.org/jira/rest/api/2/issue/12380962","fields":{"summary":"testPositionClobWithUnicode in tests.jdbcapi.BlobClob4BlobTest is failing on IBM142 with \"Log Record has been sent to the stream, but it cannot be applied to the store (Object null).  This may cause recovery problems also.\"","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12320566","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320566","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12386968","key":"DERBY-3344","self":"https://issues.apache.org/jira/rest/api/2/issue/12386968","fields":{"summary":"Error in testNegValueSupportedLogRecord in ugrade test - caused by EOF Exception in store in 10.3","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12320564","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320564","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12388496","key":"DERBY-3411","self":"https://issues.apache.org/jira/rest/api/2/issue/12388496","fields":{"summary":"OnlineBackup1 test failed with underlying error: \"ERROR XSDG3: Meta-data for Container org.apache.derby.impl.store.raw.data.RAFContainer4@52325232 could not be accessed\"","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12320033","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320033","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12379122","key":"DERBY-3087","self":"https://issues.apache.org/jira/rest/api/2/issue/12379122","fields":{"summary":"NPE while running the SVT MailJdbc","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12320036","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320036","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12393398","key":"DERBY-3607","self":"https://issues.apache.org/jira/rest/api/2/issue/12393398","fields":{"summary":"Invalid checksum error in Derby 10.3.2.1","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12320035","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320035","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12393605","key":"DERBY-3611","self":"https://issues.apache.org/jira/rest/api/2/issue/12393605","fields":{"summary":"ERROR XSDG2: Invalid checksum on Page occurs during mass inserts into two-column bigint PK table","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12320034","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320034","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12369901","key":"DERBY-2677","self":"https://issues.apache.org/jira/rest/api/2/issue/12369901","fields":{"summary":"OnlineCompressTest failed reporting NullPointerException, actual problem in derby.log is a page checksum error.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12320037","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320037","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12393395","key":"DERBY-3606","self":"https://issues.apache.org/jira/rest/api/2/issue/12393395","fields":{"summary":"invalid checksum happened in Derby 10.2.2.0","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-01-21T17:51:20.174+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11412","id":"11412","name":"Store"}],"timeoriginalestimate":null,"description":"We are using derby as an embedded DB for our data collection server. During an endurance test when we do around 270 inserts and 9 updates per second, for about a week, I ocasionally see the error below in the deby log (and nothing else beside this).\n\nThis is a vanilla installation, we run derby embedded with no extra configuration.  I can confirm that there is no memory problem, the heap usage seems constant over time.\n\nCan somebody provide some more information regarding the effects of this error? By looking at the stacktrace, it looks like a checkpoint operation is aborted due to some inconsistency in the internal data structure. If the error does not repeat immediately, does it mean that the next checkpoint is successful and there is no data loss? \n\nI can't provide a test case for that, the error happens after about 1-2 day of running our software. I will rerun the test with the debug jars to capture the line numbers in the stacktrace.  Also, I'm starting another test with 10.2.2.0, to see if this problem was introduced in the latest version.\n\nThere are another two bugs referring to this error, (https://issues.apache.org/jira/browse/DERBY-2284 and https://issues.apache.org/jira/browse/DERBY-3087) but they seem to happen in response to some client action. This use case is a bit different, the client keeps inserting and updating records for several days in a steady manner and at some point the error pops up.\n\n\nAnd lastly, here is the exception:\n\n\nCheckpoint Daemon caught standard exception\n\n------------  BEGIN ERROR STACK -------------\n\nERROR XSDB3: Container information cannot change once written: was 0, now 80\n\tat org.apache.derby.iapi.error.StandardException.newException(Unknown Source)\n\tat org.apache.derby.impl.store.raw.data.AllocPage.WriteContainerInfo(Unknown Source)\n\tat org.apache.derby.impl.store.raw.data.FileContainer.writeHeader(Unknown Source)\n\tat org.apache.derby.impl.store.raw.data.RAFContainer.writeRAFHeader(Unknown Source)\n\tat org.apache.derby.impl.store.raw.data.RAFContainer.clean(Unknown Source)\n\tat org.apache.derby.impl.services.cache.CachedItem.clean(Unknown Source)\n\tat org.apache.derby.impl.services.cache.Clock.cleanCache(Unknown Source)\n\tat org.apache.derby.impl.services.cache.Clock.cleanAll(Unknown Source)\n\tat org.apache.derby.impl.store.raw.data.BaseDataFileFactory.checkpoint(Unknown Source)\n\tat org.apache.derby.impl.store.raw.log.LogToFile.checkpointWithTran(Unknown Source)\n\tat org.apache.derby.impl.store.raw.log.LogToFile.checkpoint(Unknown Source)\n\tat org.apache.derby.impl.store.raw.RawStore.checkpoint(Unknown Source)\n\tat org.apache.derby.impl.store.raw.log.LogToFile.performWork(Unknown Source)\n\tat org.apache.derby.impl.services.daemon.BasicDaemon.serviceClient(Unknown Source)\n\tat org.apache.derby.impl.services.daemon.BasicDaemon.work(Unknown Source)\n\tat org.apache.derby.impl.services.daemon.BasicDaemon.run(Unknown Source)\n\tat java.lang.Thread.run(Thread.java:619)\n\n\n------------  END ERROR STACK -------------\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10420","value":"Regression","id":"10420"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37345","summary":"ERROR XSDB3: Container information cannot change once written","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10101","value":"Release Note Needed","id":"10101"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Windows 2003 Server\nSun Java 1.6.0_03","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":52,"total":52,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12562082","id":"12562082","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"body":"All right, I was able to reproduce the problem using the debug jars for 10.3.2.1, the error happened 4 times over last night. The 10.2.2.0 test went fine so far, so this might be a problem introduced in 10.3. Another thing I want to mention is that the test runs on a quad core CPU, so this could be a concurrency issue. And now here is the stacktrace with line numbers:\r\n\r\nCheckpoint Daemon caught standard exception\r\n\r\n------------  BEGIN ERROR STACK -------------\r\n\r\nERROR XSDB3: Container information cannot change once written: was 0, now 80\r\n\tat org.apache.derby.iapi.error.StandardException.newException(StandardException.java:301)\r\n\tat org.apache.derby.impl.store.raw.data.AllocPage.WriteContainerInfo(AllocPage.java:575)\r\n\tat org.apache.derby.impl.store.raw.data.FileContainer.writeHeader(FileContainer.java:900)\r\n\tat org.apache.derby.impl.store.raw.data.RAFContainer.writeRAFHeader(RAFContainer.java:690)\r\n\tat org.apache.derby.impl.store.raw.data.RAFContainer.clean(RAFContainer.java:534)\r\n\tat org.apache.derby.impl.services.cache.CachedItem.clean(CachedItem.java:173)\r\n\tat org.apache.derby.impl.services.cache.Clock.cleanCache(Clock.java:1381)\r\n\tat org.apache.derby.impl.services.cache.Clock.cleanAll(Clock.java:619)\r\n\tat org.apache.derby.impl.store.raw.data.BaseDataFileFactory.checkpoint(BaseDataFileFactory.java:1202)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.checkpointWithTran(LogToFile.java:1521)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.checkpoint(LogToFile.java:1360)\r\n\tat org.apache.derby.impl.store.raw.RawStore.checkpoint(RawStore.java:440)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.performWork(LogToFile.java:3411)\r\n\tat org.apache.derby.impl.services.daemon.BasicDaemon.serviceClient(BasicDaemon.java:331)\r\n\tat org.apache.derby.impl.services.daemon.BasicDaemon.work(BasicDaemon.java:668)\r\n\tat org.apache.derby.impl.services.daemon.BasicDaemon.run(BasicDaemon.java:394)\r\n\tat java.lang.Thread.run(Thread.java:619)\r\n\r\n\r\n------------  END ERROR STACK -------------\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"created":"2008-01-24T14:39:29.966+0000","updated":"2008-01-24T14:39:29.966+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12562101","id":"12562101","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Just guessing here... The numbers 0 and 80 make me suspect that this is an issue with borrowedSpace. I think those are the only valid values for borrowedSpace. DERBY-3099 made some changes to the space calculation in AllocPage and may be the culprit. It was introduced in 10.3.2.1. Though, DERBY-2284 is reported against 10.3.1.4, so it might be something else that's causing it. Bogdan, is it possible for you to run with Derby 10.3.1.4 and see if the same happens there?\r\n\r\nThere is also another bug, DERBY-3116, which mentions incorrect space calculation involving borrowedSpace. It has a patch attached. If it's not too much trouble for you, it would be very interesting if you could download the 10.3.2.1 sources, apply the DERBY-3116 patch and see if that fixes your problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-01-24T15:36:33.878+0000","updated":"2008-01-24T15:36:33.878+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12562136","id":"12562136","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"body":"Sure, I'll go ahead with your suggestions and let you know how it goes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"created":"2008-01-24T17:20:04.966+0000","updated":"2008-01-24T17:20:04.966+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12563169","id":"12563169","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"body":"All right, I've run the endurance test for 10.3.1.4 and 10.3.2.1 + 3116 and the error is still there, numerous times. \r\n\r\nThis is a pretty serious issue in terms of reliability. Another thing is that after a bunch of these errors the server blows up with JDBC exceptions (probably because the failed checkpoints).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"created":"2008-01-28T15:31:22.190+0000","updated":"2008-01-28T15:31:22.190+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12563467","id":"12563467","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for taking the time to run these experiments, Bogdan!\r\n\r\nAt least, now we know the problem is not caused by DERBY-3099 or DERBY-3116, and we know that it must have been introduced some time after 10.2.2.0 and before 10.3.1.4.\r\n\r\nOne thing I know was changed in that area of the code in that period, is that RAFContainer started using java.nio.* to allow parallel reads and writes on JVMs that support nio. It is possible to force the use of the old mechanism by deleting or commenting out the following lines in java/engine/org/apache/derby/modules.properties and rebuilding derby.jar:\r\n\r\n# store data using a StorageFactory\r\n# Enhanced version using NIO API; requires Java 1.4\r\nderby.module.rawStore.data.genericJ4=org.apache.derby.impl.store.raw.data.BaseDataFileFactoryJ4\r\nderby.env.jdk.rawStore.data.genericJ4=4\r\nderby.env.classes.rawStore.data.genericJ4=java.nio.Buffer\r\ncloudscape.config.rawStore.data.genericJ4=derby\r\n\r\nIt would be great if you could make that change and rerun your test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-01-29T10:57:46.529+0000","updated":"2008-01-29T10:57:46.529+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12564546","id":"12564546","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Marking the issue as a regression since it is reported to work on Derby 10.2.2.0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-01-31T23:24:46.982+0000","updated":"2008-01-31T23:24:46.982+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12564970","id":"12564970","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"body":"I've started the test for 10.3.2.1 without NIO and in the first 8 hours I got the exception below. I will have to stop the test tonight and restart it on Monday. I'll keep you posted how it goes.\r\n\r\n2008-02-01 20:31:59.903 GMT Thread[derby.rawStoreDaemon,5,derby.daemons] Cleanup action starting\r\njava.lang.NullPointerException\r\n\tat org.apache.derby.impl.store.access.btree.ControlRow.getControlRowForPage(ControlRow.java:878)\r\n\tat org.apache.derby.impl.store.access.btree.ControlRow.get(ControlRow.java:844)\r\n\tat org.apache.derby.impl.store.access.btree.ControlRow.get(ControlRow.java:820)\r\n\tat org.apache.derby.impl.store.access.btree.BTreePostCommit.purgeRowLevelCommittedDeletes(BTreePostCommit.java:462)\r\n\tat org.apache.derby.impl.store.access.btree.BTreePostCommit.performWork(BTreePostCommit.java:278)\r\n\tat org.apache.derby.impl.services.daemon.BasicDaemon.serviceClient(BasicDaemon.java:331)\r\n\tat org.apache.derby.impl.services.daemon.BasicDaemon.work(BasicDaemon.java:668)\r\n\tat org.apache.derby.impl.services.daemon.BasicDaemon.run(BasicDaemon.java:394)\r\n\tat java.lang.Thread.run(Thread.java:619)\r\nCleanup action completed\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"created":"2008-02-01T23:03:14.525+0000","updated":"2008-02-01T23:03:14.525+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12571439","id":"12571439","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"body":"Since 10.3.2.1 without NIO is not a tested combination as illustrated by the exception above (so I wouldn't use it in productions), I continued testing 10.3.2.1 and 10.2.2.0 side by side. \r\n\r\nOne interesting thing that I noticed is that the test is successful if the maximum heap memory is small. With only 128M, 10.3.2.1 did not fail for a week. But with 800M (or 512M in the original tests) the error comes up consistently. Could it be related to weak/soft references?\r\n\r\nIs there somebody familiar enough with the code to try to look into this at code level? This seems like a pretty important reliability bug to me, so I will try to debug the code, but it will be a while before I become comfortable with the code base.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"created":"2008-02-22T15:21:37.909+0000","updated":"2008-02-22T15:21:37.909+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12575880","id":"12575880","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dyret","name":"dyret","emailAddress":"Dyre dot Tjeldvoll at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dyre Tjeldvoll","active":true},"body":"The call stack in your comment from 2008-02-01 looks like DERBY-3362","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dyret","name":"dyret","emailAddress":"Dyre dot Tjeldvoll at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dyre Tjeldvoll","active":true},"created":"2008-03-06T20:44:27.769+0000","updated":"2008-03-06T20:44:27.769+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12578061","id":"12578061","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Bogden, can you try the latest on the 10.3 branch, now that DERBY-3362 has been fixed\r\nand see if you still see the problem?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-03-12T23:00:37.043+0000","updated":"2008-03-12T23:00:37.043+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12578066","id":"12578066","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"body":"Sure, I can try it, but DERBY-3362 has probably nothing to do with the original problem. My comment from Feb 1st refers to another issue that prevented me from running the test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"created":"2008-03-12T23:13:23.097+0000","updated":"2008-03-12T23:13:23.097+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12578068","id":"12578068","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"body":"Would it be valuable to still disable NIO at code level or should I use the unmodified 10.3 branch?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"created":"2008-03-12T23:16:42.962+0000","updated":"2008-03-12T23:16:42.962+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12578070","id":"12578070","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I think it would be valuable to try with NIO disabled.  As I understand it you were blocked from doing that experiment because of DERBY-3362","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-03-12T23:19:20.164+0000","updated":"2008-03-12T23:19:20.164+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12578075","id":"12578075","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"body":"Yes, that is correct. OK.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"created":"2008-03-12T23:36:06.580+0000","updated":"2008-03-12T23:36:06.580+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12581535","id":"12581535","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"body":"I have run my test for a week with the 10.3.2.1 SVN and NIO disabled and the error did not occur. So then we can throw a guess that the issue is related to concurrency in the new code based on NIO.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"created":"2008-03-24T13:55:56.387+0000","updated":"2008-03-24T13:55:56.387+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12584749","id":"12584749","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"There is another user that may be hitting this same issue.  The trace is \r\nERROR XSDB3: Container information cannot change once written: was 0, now 80\r\n\tat org.apache.derby.iapi.error.StandardException.newException(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.data.AllocPage.WriteContainerInfo(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.data.FileContainer.writeHeader(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.data.RAFContainer.writeRAFHeader(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.data.RAFContainer.clean(Unknown Source)\r\n\tat org.apache.derby.impl.services.cache.CachedItem.clean(Unknown Source)\r\n\tat org.apache.derby.impl.services.cache.Clock.cleanCache(Unknown Source)\r\n\tat org.apache.derby.impl.services.cache.Clock.cleanAll(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.data.BaseDataFileFactory.checkpoint(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.checkpointWithTran(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.checkpoint(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.RawStore.checkpoint(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.performWork(Unknown Source)\r\n\tat org.apache.derby.impl.services.daemon.BasicDaemon.serviceClient(Unknown Source)\r\n\tat org.apache.derby.impl.services.daemon.BasicDaemon.work(Unknown Source)\r\n\tat org.apache.derby.impl.services.daemon.BasicDaemon.run(Unknown Source)\r\n\tat java.lang.Thread.run(Thread.java:801)\r\n\r\nWould it be worthwhile to have a runtime option (something you can put in the derby.properties) to disable NIO or does anyone have ideas on how to proceed with this issue?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-04-02T20:06:07.926+0000","updated":"2008-04-02T20:06:07.926+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12584834","id":"12584834","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"I'd think an option to disable the NIO as a workaround until something better can be found may be helpful to the users hitting this. (Although possibly not so helpful to whomever will pick this up to fix).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2008-04-02T22:14:31.826+0000","updated":"2008-04-02T22:14:31.826+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12586767","id":"12586767","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I think I see how this can happen.\r\n\r\nWhen we read or write through the page cache, we use FileChannels to\r\nallow multiple threads to access the same data file in parallel (after\r\nDERBY-801). The first alloc page in a file can also be accessed\r\ndirectly by the container object (via the container cache), in which\r\ncase RandomAccessFile.seek() + read/write is used instead of\r\nFileChannel.\r\n\r\nTheoretically, this should work because the FileChannel operations use\r\nabsolute positions and should therefore not influence the positioning\r\nof the read/write performed by the container object, and\r\nsynchronization ensures that RAF.seek+read/write only happens in one\r\nthread at a time. However, it seems like on some platforms[1] the\r\nposition of the RandomAccessFile object can be changed when operations\r\nusing absolute positioning are performed on the FileChannel object\r\nreturned by getChannel() on the RAF. I guess this is to be expected,\r\nsince FileChannel's javadoc only guarantees that the operations on a\r\nFileChannel object are thread safe, not that a mix of operations on\r\nFileChannel objects and RandomAccessFile objects is thread safe.\r\n\r\nSo what I think is happening, is that the check point code is cleaning\r\nthe container cache. At the same time, the page cache initiates the\r\ncleaning of a page in the same container as the container cache is\r\ncleaning, resulting in a FileChannel operation which changes the\r\nposition of the RandomAccessFile used by the container cache. The\r\nsubsequent call to RandomAccessFile.readFully() therefore reads data\r\nfrom the wrong position in the file. When the container cache later\r\nattempts to write the data back to the file, the inconsistency is\r\ndetected and the XSDB3 error is raised.\r\n\r\nI believe that we can fix this issue by rewriting the parts that don't\r\nyet use FileChannel, so that FileChannel is used consistently and the\r\nthread-safety guarantees in FileChannel's javadoc apply.\r\n\r\n[1] Some platforms == Windows. I've also tested it on Linux and\r\nSolaris, and there the position on the RandomAccessFile doesn't seem\r\nto be affected by operations using absolute positions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-08T11:54:43.335+0000","updated":"2008-04-08T11:54:43.335+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12586787","id":"12586787","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomanie","name":"thomanie","emailAddress":"thomas dot nielsen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thomas Nielsen","active":true},"body":"Knut,\r\n\r\nDo you think that this, or a rather similar scenario, could also be the reason for some of the checksum inconsistencies that have been reported lately? \r\nI'm envisioning a scenario where instead of a parallel cache clean, there's a parallel flush and/or checksum calculation performed by the checkpoint and file cache, and ultimately causing the wrong checksum to be flushed to disk?\r\n\r\nMost inconsistencies seem to be related to windows, and different RandomAccessFile behaviour may possibly be the culprit?\r\n\r\nJust an idea...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomanie","name":"thomanie","emailAddress":"thomas dot nielsen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thomas Nielsen","active":true},"created":"2008-04-08T13:02:02.886+0000","updated":"2008-04-08T13:03:44.988+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12586790","id":"12586790","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dyret","name":"dyret","emailAddress":"Dyre dot Tjeldvoll at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dyre Tjeldvoll","active":true},"body":"Knut, I see that you have assigned yourself to this issue. Does that mean you have a fix in the pipe line? If it could be merged to 10.4 fairly soon, I think we should consider spinning another RC with this fix...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dyret","name":"dyret","emailAddress":"Dyre dot Tjeldvoll at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dyre Tjeldvoll","active":true},"created":"2008-04-08T13:23:13.500+0000","updated":"2008-04-08T13:23:13.500+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12586801","id":"12586801","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thomas:\r\n> Do you think that this, or a rather similar scenario, could also be the reason for some of the checksum inconsistencies that have been reported lately?\r\n\r\nYes, that could be the reason, at least if the checksum inconsistencies happen on page 0 (which is the first alloc page). There also are a lot of reports about EOFException thrown by RandomAccessFile.readFully() in FileContainer.getEmbryonicPage() (all seen on Windows only) which I think are likely caused by the same problem.\r\n\r\nDyre: Yes, I have a patch in the pipeline. I haven't tested it yet, but I'll do so and post it tomorrow. I'll leave it up to you to decide whether it is worth a new RC. If it fixes these problems, I think it is worth it, but it is probably difficult to verify the fix that quickly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-08T13:53:26.694+0000","updated":"2008-04-08T13:53:26.694+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12586856","id":"12586856","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Here's a preview patch for those who are interested. It is not ready for commit (the regression tests haven't completed yet, the code needs more comments, and some old comments need to be updated), but it should give an impression of how I'm planning to solve it. Basically, it factors out the occurrences of RandomAccessFile.seek()+read/write in FileChannel into separate methods that can be overridden by the RAFContainer4 class and replaced with FileChannel calls. I also needed to change the way RAFContainer4 initialized the field ourChannel, since with these changes it is too late to initialize it at the end of createContainer() and openContainer().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-08T15:51:44.507+0000","updated":"2008-04-08T15:51:44.507+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12587104","id":"12587104","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Another related problem:\r\n\r\nBefore DERBY-801, there would be only one thread reading/writing the same data file at a time. After DERBY-801, there could be many threads accessing the same data file concurrently, but this should be OK since they would access different pages (read/write to the same page will be serialized by BasePage.setExclusive()). There is however no mechanism, as far as I can see, that prevents concurrent updates of the container information in page 0 and normal page updates that touch page 0. So I think it is possible that updates to the container information section of page 0 are lost because concurrent updates of AllocPage 0 overwrite the new information with the old value. We probably need to find a way to prevent AllocPage 0 from being cleaned while the container is being cleaned (that is, RAFContainer4.writePage(pageId=0) and RAFContainer.writeRAFHeader() must be serialized somehow).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-09T09:24:34.217+0000","updated":"2008-04-09T09:24:34.217+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12587111","id":"12587111","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The preview patch caused two failures in derbyall on Solaris 10 with JDK 6. unit/recoveryTest.unit and store/dropcrash2.java failed with an assert failure in AllocPage.ReadContainerInfo(): ASSERT FAILED N not what is expected : 0","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-09T09:30:33.155+0000","updated":"2008-04-09T09:30:33.155+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12587189","id":"12587189","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attaching an updated preview patch, still not ready for commit. The updated patch fixes the assert failures seen in the recovery tests. The problem was that the new methods in RAFContainer4 used the FileChannel associated with RAFContainer.fileData instead of the FileChannel associated with the file argument. The fileData field and the file argument are normally the same object, but not when a container is stubbified, so redo of DROP TABLE operations would fail. Now the recovery tests pass.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-09T13:38:24.377+0000","updated":"2008-04-09T13:38:24.377+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12587602","id":"12587602","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I've added more comments and attached a new patch (d3347-1a) which is ready for review. It only addresses the problem with the mix of old-style I/O and NIO on some platforms. The problem with multiple threads accessing page 0 concurrently will have to be fixed in a follow-up patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-10T11:39:36.618+0000","updated":"2008-04-10T11:39:36.618+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12587625","id":"12587625","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I'm also attaching a patch (d3347-2a) for the problem with concurrent I/O operations on page 0.\r\n\r\nThis patch adds a wrapper around the methods readPage() and writePage() in RAFContainer4. If the page that is accessed is FileContainer.FIRST_ALLOC_PAGE_NUMBER, the method calls are synchronized on the container object, and therefore behave just like their non-NIO counterparts in RAFContainer. Since the code that accesses the container information on the first alloc page also is synchronized on the container object, this means that we never have two threads accessing the first alloc page concurrently. For the rest of the pages, the synchronization is not necessary, since they can only be accessed through the page cache and therefore no two threads access the same page concurrently.\r\n\r\nI haven't run the regression tests on this patch yet.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-10T12:53:47.914+0000","updated":"2008-04-10T12:53:47.914+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12587823","id":"12587823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"I don't know this code area very well, so caveats apply ;)\r\n\r\n- Patch 1: Analysis that some read/writes use FileChannel to access\r\n  first page while others use the RandomAccessFile methods directly\r\n  (and hence no guarantee for serializability) seems correct to\r\n  me. Refactoring to remedy that looks good.\r\n\r\n  The cleanup on use/initialization of FileChannel is good, too.\r\n\r\n  RAFContainer4#write has lost a check for getCommittedDropState(). Is\r\n  this intentional?\r\n\r\n  Naming: FileContainer#readHeader doesn't do any reading any longer,\r\n  since it no longer calls getEmbryonicPage. This is slightly\r\n  confusing.\r\n\r\n  BTW: (not introduced by this patch, but I noticed so I thought I'd\r\n  mention it) RAFContainer4 (in contrast to RAFContainer) allocates an\r\n  encryption buffer for every page write. Guess it needs to since the\r\n  write method is not synchronized (and can thus not use the dedicated\r\n  buffer safely). Since such objects can be large, maybe a pool would be good?\r\n\r\n\r\n- Patch 2:\r\n  Although after patch 1, writeRAFHeader always uses FileChannel I/O\r\n  now, I agree there is a chance for the race you suggest. The patch\r\n  is simple and looks good to me. \r\n  +1\r\n\r\nGood detective work, Knut!\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2008-04-11T00:59:16.873+0000","updated":"2008-04-11T00:59:16.873+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12587887","id":"12587887","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for reviewing the patch, Dag!\r\n\r\n> RAFContainer4#write has lost a check for getCommittedDropState(). Is\r\n> this intentional?\r\n\r\nGood catch! No, it wasn't intentional. The new patch (1b) reintroduces the check, and also reintroduces the assert for !getCommittedDropState() in readPage().\r\n\r\n> Naming: FileContainer#readHeader doesn't do any reading any longer,\r\n> since it no longer calls getEmbryonicPage. This is slightly\r\n> confusing.\r\n\r\nAgreed, I think. Although the two methods it still invokes are called ReadContainerInfo() and readHeaderFromArray(), so I think there is some justification for keeping \"read\" in its name. If we come up with a better name, we can always rename it later.\r\n\r\n> BTW: (not introduced by this patch, but I noticed so I thought I'd\r\n> mention it) RAFContainer4 (in contrast to RAFContainer) allocates an\r\n> encryption buffer for every page write. Guess it needs to since the\r\n> write method is not synchronized (and can thus not use the dedicated\r\n> buffer safely). Since such objects can be large, maybe a pool would be good?\r\n\r\n(I guess you meant \"every encrypted page write\", not \"every page write\"...)\r\n\r\nYes, that was also commented in the review of DERBY-801, and DERBY-2086 was logged for it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-11T08:50:31.117+0000","updated":"2008-04-11T08:50:31.117+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12587889","id":"12587889","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The 1b patch replaces the 1a patch. It only contains one change: The checks/asserts for getCommittedDropState() are reintroduced in readPage()/writePage().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-11T08:54:37.078+0000","updated":"2008-04-11T08:54:37.078+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12587898","id":"12587898","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I committed the 2a patch to trunk with revision 647091.\r\n\r\nI have started the regression tests on the 1b patch as well. The changes from 1a are minimal, so I plan to commit it if the tests pass.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-11T09:47:33.553+0000","updated":"2008-04-11T09:47:33.553+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12587928","id":"12587928","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"> Agreed, I think. Although the two methods it still invokes are called\r\n> ReadContainerInfo() and readHeaderFromArray(), so I think there is\r\n> some justification for keeping \"read\" in its name. If we come up with\r\n> a better name, we can always rename it later.\r\n\r\nYes, I notices there are several existing methods in there that are\r\ncalled read<Something> and write<Something> that do no I/O, but just\r\nanalyze or format bytes arrays. It would be good to cleanup this code\r\nsome, but I am OK with deferring for now.\r\n\r\nThis comment in the StorageRandomAccessFile abstraction is also less\r\nprecise/correct after the advent of RAFContainer4 as a user of\r\nStorageRandomAccessFile:\r\n\r\n \"An implementation of StorageRandomAccessFile need not be thread\r\n safe. The database engine single-threads access to each\r\n StorageRandomAccessFile instance. Two threads will not access the\r\n same StorageRandomAccessFile instance at the same time.\"\r\n\r\nAfter you reintroduced the getCommittedDropState checks,\r\n+1 to the first patch as well!\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2008-04-11T11:21:35.305+0000","updated":"2008-04-11T11:21:35.305+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12587948","id":"12587948","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks again, Dag. Patch 1b has been committed with revision 647139.\r\n\r\nI agree that the code and comments in this area would benefit from an overhaul. The abstractions in the original code were obviously chosen to match the RandomAccessFile way of accessing the data files, and the NIO code doesn't fit very well into that model. Some of the comments added as part of DERBY-801 also mention that a restructuring of the interfaces would be beneficial.\r\n\r\nRegarding the comment in StorageRandomAccessFile, I think it's correct, actually. The only parts of a StorageRandomAccessFile that need to be thread safe, are the methods on the FileChannel object returned by the getChannel() method. However, the SRAF interface doesn't know anything about FileChannel or getChannel(), it's just RAFContainer4 that knows that some SRAF implementations are subclasses of java.io.RAF, and therefore manages to retrieve FileChannels from them. None of the SRAF methods are ever called concurrently on the same object.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-11T12:52:31.069+0000","updated":"2008-04-11T12:52:31.069+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12587955","id":"12587955","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I guess we should try to back-port the fix at least to 10.4. It would be great if we could get the fix verified first, but lacking a reliable repro that may be difficult.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-11T13:04:52.886+0000","updated":"2008-04-11T13:04:52.886+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12587989","id":"12587989","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dyret","name":"dyret","emailAddress":"Dyre dot Tjeldvoll at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dyre Tjeldvoll","active":true},"body":"+1 to merging to 10.4 (I added 10.4.1.2 as a fix-version, and have canceled the ongoing vote on 10.4.1.1 on derby-dev). ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dyret","name":"dyret","emailAddress":"Dyre dot Tjeldvoll at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dyre Tjeldvoll","active":true},"created":"2008-04-11T14:45:17.502+0000","updated":"2008-04-11T14:45:17.502+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12588128","id":"12588128","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I have merged the fixes to the 10.4 branch (revisions 647310 and 647312).\r\nI'm leaving the issue open for now, since the fix hasn't been verified.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-11T21:18:04.828+0000","updated":"2008-04-11T21:18:04.828+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12588145","id":"12588145","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"body":"I can rerun my endurance test next week using 10.4.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"created":"2008-04-11T21:56:11.048+0000","updated":"2008-04-11T21:56:11.048+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12588163","id":"12588163","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks Bogdan, that would be great!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-11T23:04:52.972+0000","updated":"2008-04-11T23:04:52.972+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12588198","id":"12588198","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"In working on another issue I hit this bug and thought I would post my program in case it can be expanded to become a more reliable reproduction.   You run it with the number of threads as an argument and might want to bump up memory e.g.\r\n\r\njava -Xmx512M MiniStress 50\r\n\r\nI ran the program once to the end without error and then reran on the same db and got the error.  I  haven't yet updated up to get the fix.  \r\nI ran it on my dual core Windows XP box with Sun jdk 1.6.  Maybe on a box with more CPU's it will pop the bug more reliably.\r\n\r\nHere is the trace from the derby.log\r\n\r\n------------  BEGIN SHUTDOWN ERROR STACK -------------\r\n\r\n\r\nERROR XSDG1: Page Page(1039,Container(0, 5856)) could not be written to disk, please check if disk is full.\r\n\r\n\tat org.apache.derby.iapi.error.StandardException.newException(StandardException.java:296)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.CachedPage.writePage(CachedPage.java:824)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.CachedPage.clean(CachedPage.java:605)\r\n\r\n\tat org.apache.derby.impl.services.cache.ConcurrentCache.cleanAndUnkeepEntry(ConcurrentCache.java:551)\r\n\r\n\tat org.apache.derby.impl.services.cache.ClockPolicy.rotateClock(ClockPolicy.java:476)\r\n\r\n\tat org.apache.derby.impl.services.cache.ClockPolicy.insertEntry(ClockPolicy.java:176)\r\n\r\n\tat org.apache.derby.impl.services.cache.ConcurrentCache.insertIntoFreeSlot(ConcurrentCache.java:208)\r\n\r\n\tat org.apache.derby.impl.services.cache.ConcurrentCache.find(ConcurrentCache.java:284)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.FileContainer.getUserPage(FileContainer.java:2412)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.FileContainer.getPage(FileContainer.java:2462)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.BaseContainerHandle.getPage(BaseContainerHandle.java:319)\r\n\r\n\tat org.apache.derby.impl.store.access.btree.ControlRow.get(ControlRow.java:833)\r\n\r\n\tat org.apache.derby.impl.store.access.btree.ControlRow.get(ControlRow.java:820)\r\n\r\n\tat org.apache.derby.impl.store.access.btree.BTreePostCommit.doShrink(BTreePostCommit.java:123)\r\n\r\n\tat org.apache.derby.impl.store.access.btree.BTreePostCommit.performWork(BTreePostCommit.java:249)\r\n\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.postTermination(Xact.java:2045)\r\n\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.completeCommit(Xact.java:818)\r\n\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.commit(Xact.java:854)\r\n\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.commit(Xact.java:649)\r\n\r\n\tat org.apache.derby.impl.store.access.RAMTransaction.commit(RAMTransaction.java:1964)\r\n\r\n\tat org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.doCommit(GenericLanguageConnectionContext.java:1211)\r\n\r\n\tat org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.userCommit(GenericLanguageConnectionContext.java:1031)\r\n\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.commit(TransactionResourceImpl.java:237)\r\n\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.commit(EmbedConnection.java:1661)\r\n\r\n\tat WorkerThread.run(WorkerThread.java:24)\r\n\r\nCaused by: java.nio.channels.ClosedChannelException\r\n\r\n\tat sun.nio.ch.FileChannelImpl.ensureOpen(FileChannelImpl.java:91)\r\n\r\n\tat sun.nio.ch.FileChannelImpl.write(FileChannelImpl.java:642)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.RAFContainer4.writeFull(RAFContainer4.java:397)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.RAFContainer4.writePage(RAFContainer4.java:291)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.CachedPage.writePage(CachedPage.java:782)\r\n\r\n\t... 23 more\r\n\r\n============= begin nested exception, level (1) ===========\r\n\r\njava.nio.channels.ClosedChannelException\r\n\r\n\tat sun.nio.ch.FileChannelImpl.ensureOpen(FileChannelImpl.java:91)\r\n\r\n\tat sun.nio.ch.FileChannelImpl.write(FileChannelImpl.java:642)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.RAFContainer4.writeFull(RAFContainer4.java:397)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.RAFContainer4.writePage(RAFContainer4.java:291)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.CachedPage.writePage(CachedPage.java:782)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.CachedPage.clean(CachedPage.java:605)\r\n\r\n\tat org.apache.derby.impl.services.cache.ConcurrentCache.cleanAndUnkeepEntry(ConcurrentCache.java:551)\r\n\r\n\tat org.apache.derby.impl.services.cache.ClockPolicy.rotateClock(ClockPolicy.java:476)\r\n\r\n\tat org.apache.derby.impl.services.cache.ClockPolicy.insertEntry(ClockPolicy.java:176)\r\n\r\n\tat org.apache.derby.impl.services.cache.ConcurrentCache.insertIntoFreeSlot(ConcurrentCache.java:208)\r\n\r\n\tat org.apache.derby.impl.services.cache.ConcurrentCache.find(ConcurrentCache.java:284)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.FileContainer.getUserPage(FileContainer.java:2412)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.FileContainer.getPage(FileContainer.java:2462)\r\n\r\n\tat org.apache.derby.impl.store.raw.data.BaseContainerHandle.getPage(BaseContainerHandle.java:319)\r\n\r\n\tat org.apache.derby.impl.store.access.btree.ControlRow.get(ControlRow.java:833)\r\n\r\n\tat org.apache.derby.impl.store.access.btree.ControlRow.get(ControlRow.java:820)\r\n\r\n\tat org.apache.derby.impl.store.access.btree.BTreePostCommit.doShrink(BTreePostCommit.java:123)\r\n\r\n\tat org.apache.derby.impl.store.access.btree.BTreePostCommit.performWork(BTreePostCommit.java:249)\r\n\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.postTermination(Xact.java:2045)\r\n\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.completeCommit(Xact.java:818)\r\n\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.commit(Xact.java:854)\r\n\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.commit(Xact.java:649)\r\n\r\n\tat org.apache.derby.impl.store.access.RAMTransaction.commit(RAMTransaction.java:1964)\r\n\r\n\tat org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.doCommit(GenericLanguageConnectionContext.java:1211)\r\n\r\n\tat org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.userCommit(GenericLanguageConnectionContext.java:1031)\r\n\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.commit(TransactionResourceImpl.java:237)\r\n\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.commit(EmbedConnection.java:1661)\r\n\r\n\tat WorkerThread.run(WorkerThread.java:24)\r\n\r\n============= end nested exception, level (1) ===========\r\n\r\n\r\n\r\n\r\n------------  END SHUTDOWN ERROR STACK -------------\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-04-12T04:29:57.414+0000","updated":"2008-04-12T04:29:57.414+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12588203","id":"12588203","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"The most likely way this bug will show up is concurrent writes to page 0.  But the bug may not be recognized for a long time as it only corrupts the on disk page, while the page is cache is likely\r\nfine (i am not sure of this but seems possible).   This bug in particular affects  page 0, which happens to be accessed a lot and thus is in cache a lot.   So best way to catch it, is as Kathey observed - \r\nrun your concurrent test and then shutdown completely and then start up again and check.  Easiest\r\nway to check is just to run the consistency checker against any tables you might be testing against.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2008-04-12T05:59:20.735+0000","updated":"2008-04-12T05:59:20.735+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12588302","id":"12588302","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Mike for the info.  I updated the program to shutdown the db when done and check the tables.  I can reproduce corruption in page 0 pretty reliably with 100 threads.  I am going to update my client now and see if the problem goes away with the fix.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-04-12T19:01:44.559+0000","updated":"2008-04-12T19:01:44.559+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12588392","id":"12588392","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I ran the program more than a dozen times without error with the fix after getting corruption 3/3 times without the fix.  So the fix looks good from this case's perspective.  Attached is the updated program that does the shutdown and table check MiniStress.zip.  Maybe someone that runs stress tests could incorporate something similar.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-04-13T13:39:04.950+0000","updated":"2008-04-13T13:39:04.950+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12588534","id":"12588534","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for taking the time to test the fix, Kathey!\r\nI haven't been able to reproduce the problem myself, but I'm marking the issue as resolved based on your testing. If Bogdan's testing shows that it's not fixed, we can reopen it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-14T10:17:04.226+0000","updated":"2008-04-14T10:17:04.226+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12588623","id":"12588623","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Knut, do you plan to backport this fix to 10.3?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-04-14T16:29:05.010+0000","updated":"2008-04-14T16:29:05.010+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12589022","id":"12589022","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Merged the fixes to the 10.3 branch and committed revision 648210.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-15T10:57:39.728+0000","updated":"2008-04-15T10:57:39.728+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12589276","id":"12589276","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"Trying to figure out what to tell 10.3 users that may have hit this.  Does anyone have a db that they can boot that has a table that gets this error on access.  Can you drop the index or table if it gets this error?  If you get this error during recovery you are going to have to go to backup, but i am hoping that if the error is on an index we can figure out some way to just be able to drop and recreate the index.  \r\n\r\nHow likely is this error to have caused more than page 0 to be corrupted?  Does the unintended i/o interaction have a chance to push a write that was supposed to start at offset 0 to somewhere later thus causing it to overwrite page 1?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2008-04-15T23:16:59.844+0000","updated":"2008-04-15T23:16:59.844+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12589445","id":"12589445","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I'm not sure (since I haven't been able to reproduce the problem myself) but I don't think you'll be able to drop the table/index. I think DROP TABLE will open the container it's about to drop, and then it'll also read the container information stored in page 0.\r\n\r\nI also think it is possible that the problem with mixing FileChannel operations and RandomAccessFile.seek() can cause corruption on any page in the container, although based on the reports, it seems like page 0 is the most likely one to be hit.\r\n\r\nI'm attaching the program I used to track down the problem (no Derby code, only pure file operations), FileOffset.java. It runs 10 threads that write at random positions in a file using a FileChannel, while the main thread runs a loop with RAF.seek(0L) + sleep() + RAF.getFilePointer(). On Solaris and Linux, getFilePointer() always returns 0, but on Windows it frequently returns other values pointing at random positions in the file (only tested with Sun's JVMs). So it is quite possible that a write occurs at the wrong position and corrupts another page than page 0.\r\n\r\nThe other problem (concurrent access to page 0 by container cache and page cache) can only hit page 0, I believe.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-16T07:23:35.731+0000","updated":"2008-04-16T07:23:35.731+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12593010","id":"12593010","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attaching a release note.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-29T13:26:54.187+0000","updated":"2008-04-29T13:26:54.187+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12593012","id":"12593012","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Is it true that this problem only affected Windows platforms? If so, would this be worth including in the note?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2008-04-29T13:38:43.074+0000","updated":"2008-04-29T13:38:43.074+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12593019","id":"12593019","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"It is true that parts of the problem didn't seem to happen on Solaris and Linux, whereas it did on Windows (see the attached FileOffset.java). But I only tried it on a limited set of JVM's, so I can't say definitely that it's not a problem on any JVM on any other OS than Windows.\r\n\r\nAlso, the possibility of overwriting parts of page 0 with old data due to lack of synchronization between page writes and container meta-data writes, is not limited to a single platform.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-29T14:14:15.232+0000","updated":"2008-04-29T14:14:15.232+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12593571","id":"12593571","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"body":"I've run our endurance test for about a week using 10.4 svn 648059 and it was solid as a rock.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bcalmac","name":"bcalmac","emailAddress":"bcalmac at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bcalmac&avatarId=19736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bcalmac&avatarId=19736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bcalmac&avatarId=19736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bcalmac&avatarId=19736"},"displayName":"Bogdan Calmac","active":true},"created":"2008-05-01T16:31:00.575+0000","updated":"2008-05-01T16:31:00.575+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12386981/comment/12593588","id":"12593588","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for testing it, Bogdan! I'm glad it solved your problems.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-05-01T17:23:17.402+0000","updated":"2008-05-01T17:23:17.402+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3347/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06r87:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12688558","self":"https://issues.apache.org/jira/rest/api/latest/issue/12688558","key":"DERBY-6455","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326659","id":"12326659","description":"candidate for Second release for 10.10 branch","name":"10.10.2.0","archived":false,"released":true,"releaseDate":"2014-04-15"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324243","id":"12324243","description":"First release on the 10.11 branch","name":"10.11.1.1","archived":false,"released":true,"releaseDate":"2014-08-26"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2014-01-20 14:28:21.207","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"367577","customfield_12310222":"1_*:*_1_*:*_767624374_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2014-01-22T13:10:17.567+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-6455/watchers","watchCount":4,"isWatching":false},"created":"2014-01-13T15:56:33.234+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321550","id":"12321550","description":"First release on the 10.10 branch","name":"10.10.1.1","archived":false,"released":true,"releaseDate":"2013-04-15"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12381252","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12381252","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12688576","key":"DERBY-6456","self":"https://issues.apache.org/jira/rest/api/2/issue/12688576","fields":{"summary":"Infinite loop in NetworkServerControlImpl when reply >= 32k","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-01-21T00:23:10.034+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11410","id":"11410","name":"Network Server"}],"timeoriginalestimate":null,"description":"NetworkServerControlImpl.ensureDataInBuffer missing check for return -1 (EOF) from 'clientIs.read'. When read returns -1 thread consumes 100% CPU. Method NetworkServerControlImpl.fillReplyBuffer correctly throw exception.\r\n\r\nFix: add two lines:\r\n    private void ensureDataInBuffer(int minimumBytesNeeded) throws Exception\r\n    {\r\n        // make sure the buffer is large enough\r\n        while ((replyBufferCount - replyBufferPos) < minimumBytesNeeded)\r\n        {\r\n            try {\r\n                int bytesRead = clientIs.read(replyBuffer, replyBufferCount, replyBuffer.length - replyBufferCount);\r\n+                if (bytesRead == -1)\r\n+                    consolePropertyMessage(\"DRDA_InvalidReplyTooShort.S\", true);\r\n                replyBufferCount += bytesRead;\r\n        \r\n            } catch (IOException e)\r\n            {\r\n                clientSocketError(e);\r\n            }\r\n        }\r\n    }\r\n\r\nStackTrace:\r\n  java.lang.Thread.State: RUNNABLE\r\n          at java.net.SocketInputStream.read(Unknown Source:-1)\r\n          at org.apache.derby.impl.drda.NetworkServerControlImpl.ensureDataInBuffer(Unknown Source:-1)\r\n          at org.apache.derby.impl.drda.NetworkServerControlImpl.readLDString(Unknown Source:-1)\r\n          at org.apache.derby.impl.drda.NetworkServerControlImpl.readStringReply(Unknown Source:-1)\r\n          at org.apache.derby.impl.drda.NetworkServerControlImpl.runtimeInfo(Unknown Source:-1)\r\n          at org.apache.derby.drda.NetworkServerControl.getRuntimeInfo(Unknown Source:-1)\r\n          at com.crcdata.dbadmin.server.DerbyEngine.getRuntimeInfo(DerbyEngine.java:134)\r\n          at com.crcdata.dbadmin.server.DerbyEngine$DerbyServerMonitorTask.run(DerbyEngine.java:305)\r\n          at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source:-1)\r\n          at java.util.concurrent.FutureTask$Sync.innerRun(Unknown Source:-1)\r\n          at java.util.concurrent.FutureTask.run(Unknown Source:-1)\r\n          at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source:-1)\r\n          at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source:-1)\r\n          at java.lang.Thread.run(Unknown Source:-1)\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10362","value":"Performance","id":"10362"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10421","value":"Seen in production","id":"10421"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"367885","summary":"Infinite loop in NetworkServerControlImpl.ensureDataInBuffer","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jandam%40crcdata.cz","name":"jandam@crcdata.cz","emailAddress":"jandam at crcdata dot cz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin JANDA","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10422","value":"High Value Fix","id":"10422"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10426","value":"Known fix","id":"10426"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jandam%40crcdata.cz","name":"jandam@crcdata.cz","emailAddress":"jandam at crcdata dot cz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin JANDA","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":5,"total":5,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12688558/comment/13869664","id":"13869664","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jandam%40crcdata.cz","name":"jandam@crcdata.cz","emailAddress":"jandam at crcdata dot cz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin JANDA","active":true},"body":"setSoTimeout should be called in NetworkServerControlImpl.setUpSocket","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jandam%40crcdata.cz","name":"jandam@crcdata.cz","emailAddress":"jandam at crcdata dot cz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin JANDA","active":true},"created":"2014-01-13T16:26:13.707+0000","updated":"2014-01-13T16:26:13.707+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12688558/comment/13876468","id":"13876468","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for the bug report and the patch, Martin.\r\n\r\nI'm able to reproduce the problem in my environment by forcing the server to stop sending data too early. I'm not seeing an infinite loop, but a delay of 15 seconds (at 100% CPU usage) before the expected error is raised. 15 seconds seems to be the time ensureDataInBuffer() needs to make replyBufferCount wrap around from Integer.MIN_VALUE to Integer.MAX_VALUE (after about 2 billion iterations), which makes the loop terminate.\r\n\r\nI've reworked the patch a little (see the attached d6455-1a.diff):\r\n\r\n1) I made the error checking in ensureDataInBuffer() optional, so that callers that want to give a more specific error message (such as readCommandReplyHeader()) can still do that.\r\n\r\n2) I removed the now redundant checks for insufficient data done by the callers of ensureDataInBuffer().\r\n\r\nI didn't add a regression test case for the bug, since it would require changes to the network server to make it possible to force it to send false data, and also because I wasn't able to reproduce an infinite loop, only slow completion of the command, so it's difficult to make the regression test distinguish between the bug and a slow test server.\r\n\r\nI've hand-tested the patch against a server that sends truncated data and verified that the command now fails immediately instead of looping at 100% CPU for a while before failing.\r\n\r\nAll the regression tests passed with the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-01-20T14:28:21.207+0000","updated":"2014-01-20T14:28:21.207+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12688558/comment/13877341","id":"13877341","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1559946 from [~knutanders] in branch 'code/trunk'\r\n[ https://svn.apache.org/r1559946 ]\r\n\r\nDERBY-6455: Infinite loop in NetworkServerControlImpl.ensureDataInBuffer\r\n\r\nMake NetworkServerControlImpl.ensureDataInBuffer() stop immediately if\r\nit reaches end-of-stream.\r\n\r\nBased on patch contributed by Martin Janda.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-01-21T08:59:10.169+0000","updated":"2014-01-21T08:59:10.169+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12688558/comment/13878622","id":"13878622","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1560341 from [~knutanders] in branch 'code/branches/10.10'\r\n[ https://svn.apache.org/r1560341 ]\r\n\r\nDERBY-6455: Infinite loop in NetworkServerControlImpl.ensureDataInBuffer\r\n\r\nMerged revision 1559946 from trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-01-22T13:09:51.403+0000","updated":"2014-01-22T13:09:51.403+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12688558/comment/14284756","id":"14284756","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"bulk change to close all issues resolved but not closed and not changed since June 1, 2014.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2015-01-21T00:23:10.019+0000","updated":"2015-01-21T00:23:10.019+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-6455/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1rcxb:"}}
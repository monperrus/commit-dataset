{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"32734","self":"https://issues.apache.org/jira/rest/api/latest/issue/32734","key":"DERBY-302","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2005-05-21 03:54:12.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"21883","customfield_12310222":"1_*:*_1_*:*_3451229000_*|*_6_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2005-06-29T01:55:09.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-302/watchers","watchCount":0,"isWatching":false},"created":"2005-05-20T03:14:40.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2005-06-29T01:55:09.000+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"I downloaded a Cloudescape Version 10 from here http://www-106.ibm.com/developerworks/db2/library/techarticle/dm-0408cline/index.html.  Not sure exactly which version of 10 this is.\n\nWould like to store up to a 10MB XML string in a CLOB.  However, I noticed it took over 3 minutes to insert a 500kb string.  I am using the PreparedStatement to get around the 37kb limitation encountered in a previous issue.  It takes less than 2 seconds to insert a 500kb string into a CLOB in mySQl.\n\nHere the snippet:\n\n      FileReader fr = new FileReader (\"sample.txt\");  \n      BufferedReader br = new BufferedReader(fr);\n      String record = null;\n      try {\n\n        while ( (record=br.readLine()) != null ) {\n\n          bufferStr.append( record );\n\n      }\n\n      } catch (IOException e) {\n      //\n      // put your error-handling code here\n      //\n         System.out.println(\"Error reading file\");\n      }\n\n\n      System.out.println(\"Size of inputStr: \"+bufferStr.length() );\n      \n      PreparedStatement ps = mm.connection.prepareStatement(\"INSERT into  documents           VALUES (?,?)\" );\n      ps.setInt(1, 13 );\n      StringReader reader1 = new StringReader(bufferStr.toString());\n      ps.setCharacterStream(2, reader1, bufferStr.length());\n      System.out.println(\"Uploading string....\");\n      ps.execute();\n      System.out.println(\"Done uploading string...\");\n      mm.connection.commit();\n\n\nThanks for your the help,\n\nGlenn O.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40928","summary":"Takes over 3 minutes to insert a 500kb String into CLOB","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=glenno","name":"glenno","emailAddress":"orbong at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Glenn Orbon","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=glenno","name":"glenno","emailAddress":"orbong at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Glenn Orbon","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Windows XP Professional, Dell Pentium IV","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":7,"total":7,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/32734/comment/65858","id":"65858","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=glenno","name":"glenno","emailAddress":"orbong at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Glenn Orbon","active":true},"body":" I am running Cloudscape as an embedded database.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=glenno","name":"glenno","emailAddress":"orbong at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Glenn Orbon","active":true},"created":"2005-05-20T23:56:23.000+0000","updated":"2005-05-20T23:56:23.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/32734/comment/65878","id":"65878","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"using setString instead of setCharacterStream in this case ( insert of 500kb clob) performs way much better.   But ofcourse, setString cannot be used for large data (or data that wont fit into memory) and one would need to use streams.\r\n\r\nInserting a 500kb blob using setBinaryStream is also much faster than the setCharacterStream. \r\n\r\n\r\n\r\n\r\n \r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2005-05-21T03:54:12.000+0000","updated":"2005-05-21T03:54:12.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/32734/comment/12312888","id":"12312888","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"For Sun JVM ( 1.4.2 _07) the first insert takes 3 minutes but with IBM jvm 1.4.2 it takes about 20seconds on my laptop. Further with Sun JVM you can improve performance if you use the BufferedReader and give a large buffer size to it. \r\n\r\nAdding this as a comment  here so the info is not lost.  I  have just started looking into this issue, but if someone else has other suggestions etc, please post here/to the list.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2005-06-07T23:16:14.000+0000","updated":"2005-06-07T23:16:14.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/32734/comment/12313310","id":"12313310","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"Currently in derby,  for an insert on a clob using setCharacterStream what will happen is , the entire stream will be materialized into a char array and sent to store for the insert.  ( we should not have to stream here. I will file another jira issue for this and put in all information I learnt)\r\n\r\nGiven this is how inserts for large clobs are happening, the performance issue analysis is as follows:\r\n--  profiler run shows that most time is spent in SQLChar.readExternal which is where the materialization into a char array for the user's input stream happens.  The growth of this array happens gradually till the entire stream is materialized into the array.  Below code snippet shows by how much the array is grown each time when it realizes it has to read more bytes from the stream.\r\n \r\nThe dvd hierarchy for clob is  -  SQLClob ( dvd) extends SQLVarChar extends SQLChar.\r\n\r\nSo in SQLChar.readExternal\r\n........\r\n    int growby = in.available();\r\n   if(growby < 64)\r\n       growby = 64\r\n and then an allocation and an arraycopy to the new allocated array.\r\n\r\n--  In the code snippet,  'in' is the wrapper around the user's stream which is ReaderToUTF8Stream .   ReaderToUTF8Stream extends InputStream and  does not override available() method . As per the spec, InputStream.available() returns 0.\r\n\r\n-- Thus each time, the array growth is by 64 bytes which is obviously not performant.  so for a 500k clob insert, this would mean allocation & arraycopy steps happen  ~8000 times.\r\n\r\n-- The ReaderToUTF8Stream that has the user's stream reads from the stream and does the utf8 conversion and puts it in a 4k array.  I think it is reasonable to have a 32k buffer to store this information for clobs.\r\n\r\nAlthough I think there seems to be more possible optimizations in this area,  I prefer the incremental approach too :)  so this patch  is a first step towards fixing the insert clob performance in the current system.\r\n\r\nFix includes:\r\n-- enhanced the way the array was grown to keep the original  64 bytes for char ( seems reasonable given the upper limit for char) but override it to have  4k for varchar and clobs.\r\n-- override available() in ReaderToUTF8Stream to return a better estimate of how many bytes can be read.\r\n\r\nsvn stat\r\nM      java\\engine\\org\\apache\\derby\\impl\\jdbc\\ReaderToUTF8Stream.java\r\nM      java\\engine\\org\\apache\\derby\\iapi\\services\\io\\LimitReader.java\r\nM      java\\engine\\org\\apache\\derby\\iapi\\types\\SQLChar.java\r\nM      java\\engine\\org\\apache\\derby\\iapi\\types\\SQLVarchar.java\r\n\r\n-- ran derbyall ok with sun jvm.\r\n\r\n--  I can add a test and compare times but I realize that is probably not the best solution here.  It should ideally be part of a performance regression suite.\r\n\r\nNumbers for clob inserts in seconds for one insert  on my laptop  - as per the jira issue.\r\nWith fix , times are in seconds for 1 insert on a clob on my laptop (windows, 1G ram, 1.6Ghz Intel Pentium(M) )\r\n\r\nFileSize            ibm jvm 1.4.2      sun jvm 1.4.2         sun jvm 1.5\r\n500k               0.9s                     1.6s                        1.7s\r\n1M                  2.1s                     4s                           5s\r\n2M                  3s                        9s                           11s\r\n4M                  7s                        18s                         22s\r\n\r\n\r\nWithout the fix, 500k with sun jvm takes 3 mins and ibm jvm takes 20 seconds.\r\nI will add the test program along with the input files to jira issue.\r\n_________________________\r\nWithout this fix :  As I already mentioned in the jira comment for derby302,  I changed the program in the attached jira entry to use BufferedReader with the buffersize set to a bigger value than the default ( to 64k) brought down the times for sun jvm closer to ibm jvm.  I noticed that in my test, if I ran the test multiple times and did multiple inserts the performance of sun jvm and ibm jvm for 500k clob was around 20 seconds - guess the jit kicks in , plus the OS cache may also be a factor..\r\n________________________\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2005-06-11T02:15:19.000+0000","updated":"2005-06-11T02:15:19.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/32734/comment/12313345","id":"12313345","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"This patch addresses Mike's comments  (#1 and #2)in http://mail-archives.apache.org/mod_mbox/db-derby-dev/200506.mbox/%3c42A9CE92.7070808@sbcglobal.net%3e\r\n \r\n1) Added final to the methods except for SQLChar for performance reasons. \r\n2) Added constants to improve readability for all the humbers. \r\n\r\n- Ran derbyall on jdk142 OK.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2005-06-11T09:55:32.000+0000","updated":"2005-06-11T09:55:32.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/32734/comment/12313346","id":"12313346","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"I just realized since the link I provided in my earlier comment to mike's email goes to 2 lines .. the link doesnt open up, so attaching the shorter gmane link to his mail and thread on derby dev. \r\n\r\nhttp://article.gmane.org/gmane.comp.apache.db.derby.devel/5405","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2005-06-11T10:16:51.000+0000","updated":"2005-06-11T10:16:51.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/32734/comment/12314622","id":"12314622","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"has been committed with  svn 190415.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2005-06-29T01:55:09.000+0000","updated":"2005-06-29T01:55:09.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-302/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i07dcf:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12365617","self":"https://issues.apache.org/jira/rest/api/latest/issue/12365617","key":"DERBY-2480","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2007-03-22 21:57:51.126","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23070","customfield_12310222":"1_*:*_1_*:*_2333432215_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2007-04-18T21:16:58.333+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2480/watchers","watchCount":2,"isWatching":false},"created":"2007-03-22T21:06:26.118+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"7.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10920","id":"10920","description":"initial source drop","name":"10.0.2.0","archived":false,"released":true,"releaseDate":"2004-08-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/10991","id":"10991","description":"snapshot","name":"10.0.2.1","archived":false,"released":true,"releaseDate":"2004-12-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12310615","id":"12310615","description":"","name":"10.1.2.1","archived":false,"released":true,"releaseDate":"2005-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12315570","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12315570","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12352818","key":"DERBY-1947","self":"https://issues.apache.org/jira/rest/api/2/issue/12352818","fields":{"summary":"OutOfMemoryError after repeated calls to boot and shutdown a database","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-01-21T17:49:59.662+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11407","id":"11407","name":"JDBC"}],"timeoriginalestimate":null,"description":"Repeated calls to java.sql.DriverManager.getConnection(\"jdbc:derby:C:\\\\DOES_NOT_EXIST\") leak memory and eventually lead to an OutOfMemoryError.\n\nThis bug is similar to DERBY-1947 in that ContextManager objects are not getting removed from the HashSet.  The attached test program demonstrates the issue.  When run with VM options -Xms8m -Xmx8m, it throws an OutOfMemoryError after 19022 calls to DriverManager.getConnection.\n\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37467","summary":"DriverManager.getConnection leaks memory when connecting to a non-existent database","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clary2137","name":"clary2137","emailAddress":"jclary at actuate dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Clary","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clary2137","name":"clary2137","emailAddress":"jclary at actuate dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Clary","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Windows Vista, JDK 1.4.2_13\nSolaris 10, Sun JDK 1.4.2, 1.5.0 & 1.6.0\nRed Hat Enterprise Linux 4 (2.6.9-34.ELsmp_64), Sun JDK 1.5.0 & 1.6.0","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":17,"total":17,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12483323","id":"12483323","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clary2137","name":"clary2137","emailAddress":"jclary at actuate dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Clary","active":true},"body":"Small test program demonstrating bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clary2137","name":"clary2137","emailAddress":"jclary at actuate dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Clary","active":true},"created":"2007-03-22T21:08:06.182+0000","updated":"2007-03-22T21:08:06.182+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12483333","id":"12483333","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"I tried the repro on Solaris 10 with both Java 1.4.2 and Java 1.5. Both failed with Derby 10.2.2.0 and with trunk.\r\nHowever, I was not able to reproduce the bug with Derby 10.1.3.1, so this seems like a regression. I stopped the test after a little over 500'000 iterations.\r\n\r\nWe could maybe add the repro to the test suite, as doing the connect a reasonable number of times (say 20-50000 repetitions) doesn't take long when the memory leak is not around. 50000 iterations with 10.1.3.1 took around 25 seconds on my machine. The problem is that we have to run this in a separate VM, and I don't know how good support we have for that currently?\r\n\r\nI also lowered the priority, as I consider this use-case a bit \"on the edge\" compared to common practice.\r\n\r\nThank you for the report :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2007-03-22T21:57:51.126+0000","updated":"2007-03-22T21:57:51.126+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12483470","id":"12483470","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"I downloaded and modified the repro java file so that I could run it with the ClientDriver against a Derby Network Server. It seems that the issue is not limited to the EmbeddedDriver, as the server JVM (trunk/10.3) with a max heap of 32 MB hit an OutOfMemoryError after 46918 connection attempts (using JDK 6).\r\n\r\nAttaching JConsole screenshot showing the heap usage for the server JVM: heap-server-Xmx32m.png.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2007-03-23T08:57:38.960+0000","updated":"2007-03-23T08:57:38.960+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12483513","id":"12483513","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"Removing the regression flag and changing affects versions, as further testing and an offline discussion with Kristian has resulted in the following findings:\r\n\r\n   * the issue can be reproduced against older Derby version as well, unless an \"invalid\" database path (e.g. \"C:\\\\whatever\" on a unix system) AND a sane build is used...\r\n   * If a sane build AND an invalid path is used, the booting attempts are stopped by an assertion failure, and no OutOfMemoryError (OOME) is seen:\r\n\r\norg.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED serviceName (/tmp/C:\\DOES_NOT_EXIST) expected to equal getCanonicalServiceName(serviceName) (null)\r\n\r\n     I am not yet sure if this is true for all versions of derby, or just some. Further testing is needed.\r\n\r\n   * If a sane build and a valid path (e.g. \"whateverDB\") is used, we see the memory leak on all versions/platforms tested so far.\r\n   * Also, if an insane build is used (regardless of path), we see the memory leak on all versions/platforms tested so far. I have tested insane versions of all official releases of Derby (and the current trunk) on Sun's 1.5.0_07 JVM.\r\n   \r\nWith a max heap size of 32 MB the OOME occurs after about 49000 connection attempts.\r\n\r\nI have not tested all variants and combinations of Derby versions, JVMs, database paths and operating systems, so I do not guarantee that these findings are 100% precise...\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2007-03-23T10:53:03.907+0000","updated":"2007-03-23T10:53:03.907+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12483620","id":"12483620","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clary2137","name":"clary2137","emailAddress":"jclary at actuate dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Clary","active":true},"body":"This might be a bit premature, but I am attaching a patch we are trying locally to fix this problem and DERBY-1947.  From our analysis, it looks like we are missing some calls to TransactionResourceImpl.cleanupOnError().\r\n\r\nI have just now gotten set up to check out, build, and test Derby.  I am running derbyall against svn revision 521727 now, and will re-run it this afternoon with this patch in place.  I'll post my results here.\r\n\r\n\r\n(By the way, sorry for not granting ASF license for the original test program...that was just a newbie error.  But I don't see any way to grant it now.)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clary2137","name":"clary2137","emailAddress":"jclary at actuate dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Clary","active":true},"created":"2007-03-23T14:46:12.805+0000","updated":"2007-03-23T14:46:12.805+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12483860","id":"12483860","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Hi Jeff, I looked at the patch, since I am working on the related\r\nDERBY-1947. I think the change in your patch which adds the call on\r\ncleanupOnError to EmbedConnection's constructor is orthogonal to the\r\nchanges I made in DERBY-1947-1, and it looks good.\r\n\r\nI think that maybe the change you made to EmbedConnection's public\r\nclose method really addresses DERBY-1947? (I ran your repro\r\nwithout OOM with just the change to the constructor's catch clause). \r\n\r\n\r\nI think it is better to make the changes for DERBY-1947 as a patch to\r\nthat issue, so you may want to simplify this patch to just keep the\r\nconstructor change. \r\n\r\nYou may want to have a look at the patch I made for DERBY-1947. Feel\r\nfree to comment on that :) \r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2007-03-24T17:30:48.569+0000","updated":"2007-03-24T17:30:48.569+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12484127","id":"12484127","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clary2137","name":"clary2137","emailAddress":"jclary at actuate dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Clary","active":true},"body":"At Dag's suggestion I have attached a patch that addresses only DERBY-2480.  It is a strict subset of the previous patch, so I am pretty confident that it should be good.  I am running derbyall against it right now.  Please consider it ready fo review.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clary2137","name":"clary2137","emailAddress":"jclary at actuate dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Clary","active":true},"created":"2007-03-26T13:42:04.812+0000","updated":"2007-03-26T13:42:04.812+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12484757","id":"12484757","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"I tried the patch, DERBY-2480-1.diff, and it seems to fix this issue. Ran the repro (with modified database path on Solaris) against sane jars, 1M iterations with the embedded driver (8 MB max heap; fails after less than 20k iterations without the patch) and 160k iterations with the client driver (16 MB max heap in the server VM). I saw no signs of a memory leak. I used JDK 6 for testing and its JConsole tool for monitoring.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2007-03-28T08:25:02.797+0000","updated":"2007-03-28T08:25:02.797+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12485439","id":"12485439","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"Changed the Summary to reflect the fact that this is issue is not limited to the EmbeddedDriver.\r\nAdded my test platforms to Environment.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2007-03-30T07:36:59.830+0000","updated":"2007-03-30T07:36:59.830+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12486467","id":"12486467","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clary2137","name":"clary2137","emailAddress":"jclary at actuate dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Clary","active":true},"body":"I've  been working on my ongoing Derby setup issues, and have an *almost* clean run of the derbyall suite against this patch.  One single test failed due to an OutOfMemoryError.  I've attached my derbyall_report.txt for reference.\r\n\r\nI see this bug is still unassigned.  Any committer out there want to take ownership of this one-liner and get it into the build?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clary2137","name":"clary2137","emailAddress":"jclary at actuate dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Clary","active":true},"created":"2007-04-03T19:02:32.162+0000","updated":"2007-04-03T19:02:32.162+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12486479","id":"12486479","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Jeff, I believe you should assign the bug to *yourself*, since you are the one who developed the fix.\r\n\r\nI see that your patch includes a code change only. Is there a way to construct a test case which\r\ndemonstrates the bug and the fix? John, I see that you worked with the repro code; do you think we\r\ncan extract a test case from the repro code?\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-04-03T20:07:00.199+0000","updated":"2007-04-03T20:07:00.199+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12487756","id":"12487756","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"Bryan: I see no reason why it should not be possible to create a test case based on Jeff's repro. Unless he or someone else beats me to it, I'll try to experiment a little with this, after familiarizing myself with Derby's JUnit test configurations etc.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2007-04-10T12:05:23.811+0000","updated":"2007-04-10T12:05:23.811+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12488090","id":"12488090","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"Assigning this issue to myself while I'm trying to figure out the best way to integrate a test for this into Derby's JUnit test framework. It seems that there is currently no support for trying to connect to a database without also creating it if it does not already exist. I won't be working full time on this, so feel free to reassign if desired.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2007-04-11T14:28:54.510+0000","updated":"2007-04-11T14:28:54.510+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12489390","id":"12489390","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"Attaching a patch (d2480-junitTest_v1.diff) which adds a JUnit test class to the ...functionTests.tests.memory package and a build file for that package. \r\n\r\nThe test class is named ConnectionHandlingJunit.java, and its functionality is similar to that of the existing non-JUnit test class ConnectionHandling.java in the same package, added for DERBY-444. I imagine that the older test may be converted to JUnit at some point so that the two can be combined into one class - I was not creative enough to come up with a better name for the new test class.\r\n\r\nThe test uses java.sql.DriverManager to attempt to get a connection to a database that does not exist. The test is set up to run 130 thousand attempts, which should be more than enough to trigger this bug in JVMs with up to 64 MB of max heap size (the default on many desktop machines/JVMs).\r\n\r\nThe test is set up to run in embedded mode only. The test can run in client/server mode as well, but it has to be slightly modified and recompiled - see implementation comments.\r\n\r\nThe test has not been added to any larger JUnit suite, because it a) takes a while to run and b) eats JVM resources if the bug is present.\r\n\r\nRun the test for example by doing: \r\n\r\njava junit.textui.TestRunner org.apache.derbyTesting.functionTests.tests.memory.ConnectionHandlingJunit\r\n\r\nTo observe test status (including memory \"usage\") while it is running, include -Dderby.tests.debug=true when starting the TestRunner.\r\n\r\nWithout Jeff's latest patch memory usage increases dramatically and an OutOfMemoryError is eventually thrown. With Jeff's patch, memory usage is very low and stable. I've run the test on Sun's JVMs 1.4.2_02, 1.5.0_07 and 1.6.0_01, using sane jars.\r\n\r\nThe test does not always fail when an OutOfMemoryError is thrown - I think this may be because the JVM is running out of resources and crashes before it gets that far. In any case, an alarm message should be printed when such an error occurs.\r\n\r\nPlease review/commit.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2007-04-17T12:46:52.570+0000","updated":"2007-04-17T12:46:52.570+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12489443","id":"12489443","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Hi John, thanks for the test! It works great for me: without the fix, the test fails for me\r\non iteration 109455, and with the fix the test passes.\r\n\r\nIf there are no other comments from other reviewers, I'll commit the fix and the\r\ntest to the trunk later this week.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-04-17T16:00:53.256+0000","updated":"2007-04-17T16:00:53.256+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12489510","id":"12489510","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"In addition to John's new test, all the existing regression tests ran cleanly for\r\nme with the two patches applied. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-04-17T18:50:02.842+0000","updated":"2007-04-17T18:50:02.842+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12365617/comment/12489884","id":"12489884","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Thanks Jeff for the bug report, and for the patch. Thanks John for reviewing\r\nthe change and contributing the test program. And thanks to the other\r\nreviewers for the comments and notes.\r\n\r\nI submitted both patches in a single change to the trunk as revision 530159.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-04-18T21:16:58.313+0000","updated":"2007-04-18T21:16:58.313+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2480/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06rzb:"}}
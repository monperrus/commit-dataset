{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12311848","self":"https://issues.apache.org/jira/rest/api/latest/issue/12311848","key":"DERBY-424","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12310615","id":"12310615","description":"","name":"10.1.2.1","archived":false,"released":true,"releaseDate":"2005-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2005-10-19 14:12:20.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"21949","customfield_12310222":"1_*:*_1_*:*_9830536000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_44389658113","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2005-10-23T03:26:22.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-424/watchers","watchCount":1,"isWatching":false},"created":"2005-07-01T08:44:06.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-03-20T21:54:00.112+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"See DERBY-405 for some discussion related this issue. I suspect this is because of statement caching. Derby doesn't seem to recognise we have a temporary table that just overloaded an existing physical table. \n\nIt would have been good to avoid permanent tables/views/synonyms in SESSION schema. Not sure what we should do now about this, though. \n\nij> create view session.st1 as select * from t; \n0 rows inserted/updated/deleted \nij> select * from session.st1; \nI |J |K \n----------------------------------- \n1 |1 |NULL \n2 |2 |NULL \n3 |3 |NULL \n4 |4 |NULL \n\n4 rows selected \nij> select * from t; \nI |J |K \n----------------------------------- \n1 |1 |NULL \n2 |2 |NULL \n3 |3 |NULL \n4 |4 |NULL \n\n4 rows selected \nij> declare global temporary table st1(c11 int, c12 int) on commit preserve rows \n not logged; \n0 rows inserted/updated/deleted \nij> select * from session.st1; \nI |J |K \n----------------------------------- \n1 |1 |NULL \n2 |2 |NULL \n3 |3 |NULL \n4 |4 |NULL \n\n4 rows selected \nij> select * from session.st1; <==== This statement has an extra space between FROM and session.st1 \nC11 |C12 \n----------------------- \n\n0 rows selected \n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40128","summary":"Queryplan for a query using SESSION schema view is incorrectly put in statement cache. This could cause incorrect plan getting executed later if a temp. table is created with that name.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"generic","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":2,"total":2,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311848/comment/12332443","id":"12332443","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I have attached a review package for this bug, hopefully, in time for 10.1.2 release. \r\n\r\nThe files affected by this change are\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\GenericStatement.java\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\FromList.java\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\GenericPreparedStatement.java\r\nM      java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\lang\\declareGlobalTempTableJava.java\r\nM      java\\testing\\org\\apache\\derbyTesting\\functionTests\\master\\declareGlobalTempTableJava.out\r\n\r\nThe changes for this fix are very localized, affecting only 3 files in Derby engine. Basically, the problem is that, during the compile phase of views, the reference to the view gets replaced by the view definition, which causes us to loose the information that the view might have belonged in SESSION schema. In order to fix this, during the bind phase in FromList, before the view gets replaced by its definition, I find out if the view is from SESSION schema, If yes, then I save this information in FromList and this gets used by FromList when it is asked if it has any items referencing SESSION schema objects. This information is again lost during the optimization and generate phase and hence I moved the check for SESSION schema reference to right after the bind phase in GenericStatement. If there is a reference to SESSION schema object, GenericStatement will remove the statement from the cache. \r\n\r\nI have put in quite a big of comments in the code which hopefully will make the patch easier to understand. I have added a new test for this and have run all the tests with no failures using Sun's jdk142 on Windows XP machine.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2005-10-19T14:12:20.000+0000","updated":"2005-10-19T14:12:20.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311848/comment/12332871","id":"12332871","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"The fix went into both 10.2 and 10.1.2. \r\nSome additional comments on the fix\r\n1)The reason for adding a new method referencesSessionSchema(QueryTreeNode qt) in GenericPreparedStatement----\r\nIf you look at the GenericStatement's prepMinion method, towards the beginning(line 167 onwards in the review package), we look for the statement in the cache. If it is found there, we set foundInCache to true. After that, we check if the statement found in the cache might be referencing SESSION schema object and if yes, then we do not want to use the statement plan from the cache, instead we want to build it again. The check to see if statement references SESSION schema is done by following code in GenericStatement's prepMinion method \r\n    if (foundInCache) {\r\n     if (preparedStmt.referencesSessionSchema()) {\r\n      // cannot use this state since it is private to a connection.\r\n      // switch to a new statement.\r\n      foundInCache = false; \r\n      preparedStmt = new GenericPreparedStatement(this);\r\n      break;\r\n     }\r\n    }\r\nGenericPreparedStatement or GenericStatement at the time of the check above donot have the query tree object and hence we can't simply call qt.referencesSessionSchema. For this reason, I had to add \r\npublic boolean referencesSessionSchema(QueryTreeNode qt) to GenericPreparedStatement(which gets called by the compile phase after the qt object is constructed) and the method saves the qt object's referencesSessionSchema() status in it's own local variable referencesSessionSchema. This local information is what will be used by the other referencesSessionSchema method to determine if statement found in cache should be discarded and compile phase should be re-executed. \r\n \r\nSo, to summarize, the new method after the bind phase, extracts the referencesSessionSchema information from the passed qt object and saves it in the local variable.\r\n public boolean referencesSessionSchema(QueryTreeNode qt)\r\n throws StandardException {\r\n  //If the query references a SESSION schema table (temporary or permanent), then mark so in this statement\r\n  referencesSessionSchema = qt.referencesSessionSchema();\r\n  return(referencesSessionSchema);\r\n }\r\n \r\nAnd, the existing referencesSessionSchema() method as shown below, uses the local variable (which was filled correctly last time the statement was compiled) to let the compile phase know if it should ignore the plan found in the cache and reconstruct the plan because the old plan had references to SESSION schema objects. \r\n public boolean referencesSessionSchema()\r\n {\r\n  return referencesSessionSchema;\r\n }\r\n\r\n3)How information about SESSION schema object reference gets lost during optimization phase-----\r\nAt the end of the bind phase for select * from session.st1; GenericStatement's qt (QueryTreeNode object which in this case is CursorNode) object has it's resultSet object as a SelectNode which has a fromList object with referencesSessionSchema field set to true because it was referencing an object from SESSION schema. \r\nWhen the optimize code is called on this bound qt object, the optimizer replaces the SelectNode resultSet object with a ProjectRestrictNode and in that process, we loose the referencesSessionSchema information which was part of the SelectNode's FromList object. Rather than trying to have that information some how be transferred to the new ResultSet object, it is more efficient to use the information right after bind phase and remove the plan from the statement cache. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2005-10-23T03:26:22.000+0000","updated":"2005-10-23T03:26:22.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-424/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i078en:"}}
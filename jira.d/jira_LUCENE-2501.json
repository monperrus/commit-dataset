{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12467096","self":"https://issues.apache.org/jira/rest/api/latest/issue/12467096","key":"LUCENE-2501","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310110","id":"12310110","key":"LUCENE","name":"Lucene - Core","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310110&avatarId=10061","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310110&avatarId=10061","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310110&avatarId=10061","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310110&avatarId=10061"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12319070","id":"12319070","description":"Major release after 3.5","name":"3.6","archived":false,"released":true,"releaseDate":"2012-04-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12322456","id":"12322456","description":"Beta release after 4.0-ALPHA","name":"4.0-BETA","archived":false,"released":true,"releaseDate":"2012-08-13"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321663","id":"12321663","description":"Current trunk","name":"Trunk","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-06-16 16:51:56.607","customfield_12312323":null,"customfield_12310420":"11322","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_67539235794_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-08-06T09:32:59.095+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-2501/watchers","watchCount":5,"isWatching":false},"created":"2010-06-16T16:39:03.776+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314401","id":"12314401","description":"Bugfixes for 3.0","name":"3.0.1","archived":false,"released":true,"releaseDate":"2010-02-26"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-10T10:43:04.914+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12310232","id":"12310232","name":"core/index","description":"issues with indexing code"}],"timeoriginalestimate":null,"description":"I'm seeing the following exception during indexing:\r\n{code}\r\nCaused by: java.lang.ArrayIndexOutOfBoundsException: 14\r\nat org.apache.lucene.index.ByteBlockPool.allocSlice(ByteBlockPool.java:118)\r\nat org.apache.lucene.index.TermsHashPerField.writeByte(TermsHashPerField.java:490)\r\nat org.apache.lucene.index.TermsHashPerField.writeVInt(TermsHashPerField.java:511)\r\nat org.apache.lucene.index.FreqProxTermsWriterPerField.writeProx(FreqProxTermsWriterPerField.java:104)\r\nat org.apache.lucene.index.FreqProxTermsWriterPerField.newTerm(FreqProxTermsWriterPerField.java:120)\r\nat org.apache.lucene.index.TermsHashPerField.add(TermsHashPerField.java:468)\r\nat org.apache.lucene.index.DocInverterPerField.processFields(DocInverterPerField.java:174)\r\nat org.apache.lucene.index.DocFieldProcessorPerThread.processDocument(DocFieldProcessorPerThread.java:246)\r\nat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:774)\r\nat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:757)\r\nat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:2085)\r\n... 37 more\r\n{code}\r\n\r\n\r\nThis seems to be caused by the following code:\r\n{code}\r\n    final int level = slice[upto] & 15;\r\n    final int newLevel = nextLevelArray[level];\r\n    final int newSize = levelSizeArray[newLevel];\r\n{code}\r\n\r\nthis can result in \"level\" being a value between 0 and 14\r\nthe array nextLevelArray is only of size 10\r\n\r\ni suspect the solution would be to either max the level to 10, or to add more entries to the nextLevelArray so it has 15 entries\r\nhowever, i don't know if something more is going wrong here and this is just where the exception hits from a deeper issue\r\n\r\n","customfield_10010":null,"timetracking":{},"customfield_12310120":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10121","value":"New","id":"10121"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"25509","summary":"ArrayIndexOutOfBoundsException in ByteBlockPool.allocSlice","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":22,"total":22,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/12879379","id":"12879379","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Hmmm, not good.  Can you boil this down to a smallish test case?\r\n\r\nlevel should never be > 9, because nextLevelArray[*] is no greater than 9.  Something more serious is up...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2010-06-16T16:51:56.607+0000","updated":"2010-06-16T16:51:56.607+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/12879382","id":"12879382","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"body":"thats what i was afraid of\r\n\r\ni got this report second hand, so i don't have access to the data that was being ingested\r\n\r\nand i currently don't know enough about this section of the indexing code to guess in order to create a unit test\r\ni'll try to create a test, but i expect it will be difficult (especially if no one else has ever seen this)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"created":"2010-06-16T16:58:25.364+0000","updated":"2010-06-16T16:58:25.364+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/12879389","id":"12879389","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Is this issue repeatable, on a different machine?\r\n\r\nWe do have a randomized test for this (TestByteSlices) -- I'll go start it w/ big random.multiplier.  Maybe it can uncover this ;)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2010-06-16T17:12:43.782+0000","updated":"2010-06-16T17:12:43.782+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/12879399","id":"12879399","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"What sized RAM buffer was being used for IW when this exception happened?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2010-06-16T17:19:44.679+0000","updated":"2010-06-16T17:19:44.679+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/12879403","id":"12879403","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"body":"Here's all the info i have available right now (will try to get more):\r\n\r\n16 core, 18-gig ram Windows 7 machine\r\n1 JVM\r\n16 index writers (each using default settings (64M ram, etc))\r\n300+ docs/sec ingestion (small documents)\r\ncommit every 10 minutes\r\noptimize every hour\r\n\r\nThe report i got indicated that every now and then one of these ArrayIndexOutOfBounds exceptions would occur\r\nthis would result in the document being indexed failing, but otherwise things would continue normally\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"created":"2010-06-16T17:23:35.989+0000","updated":"2010-06-16T17:23:35.989+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/12879422","id":"12879422","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"body":"Some more info:\r\n\r\ningestion is being performed in multiple threads\r\n\r\nArrayIndexOutOfBounds exception is occurring in bursts\r\nI suspect that these bursts of exceptions stop after the next commit (at which point the buffers are all reset) \r\nNOTE: i have not yet confirmed this, but i suspect it\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"created":"2010-06-16T17:57:30.557+0000","updated":"2010-06-16T17:57:30.557+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/12879483","id":"12879483","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"body":"Looks like this may be the original source of the errors\r\n\r\n{code}\r\nCaused by: org.apache.lucene.index.CorruptIndexException: docs out of order (607 <= 607 )\r\n\tat org.apache.lucene.index.FormatPostingsDocsWriter.addDoc(FormatPostingsDocsWriter.java:76)\r\n\tat org.apache.lucene.index.FreqProxTermsWriter.appendPostings(FreqProxTermsWriter.java:209)\r\n\tat org.apache.lucene.index.FreqProxTermsWriter.flush(FreqProxTermsWriter.java:127)\r\n\tat org.apache.lucene.index.TermsHash.flush(TermsHash.java:144)\r\n\tat org.apache.lucene.index.DocInverter.flush(DocInverter.java:72)\r\n\tat org.apache.lucene.index.DocFieldProcessor.flush(DocFieldProcessor.java:64)\r\n\tat org.apache.lucene.index.DocumentsWriter.flush(DocumentsWriter.java:583)\r\n\tat org.apache.lucene.index.IndexWriter.doFlushInternal(IndexWriter.java:3602)\r\n\tat org.apache.lucene.index.IndexWriter.doFlush(IndexWriter.java:3511)\r\n\tat org.apache.lucene.index.IndexWriter.flush(IndexWriter.java:3502)\r\n\tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:2103)\r\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"created":"2010-06-16T20:05:31.941+0000","updated":"2010-06-16T20:05:31.941+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/12879485","id":"12879485","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Are you certain about IW's RAM buffer size?  If the RAM buffer size was close to 2GB it could lead to exceptions like this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2010-06-16T20:18:43.126+0000","updated":"2010-06-16T20:18:43.126+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/12879486","id":"12879486","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"body":"ram buffer size is set to 64.0","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"created":"2010-06-16T20:25:47.761+0000","updated":"2010-06-16T20:25:47.761+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/12879487","id":"12879487","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Can you capture IW.setInfoStream output leading up to it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2010-06-16T20:29:14.847+0000","updated":"2010-06-16T20:29:14.847+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/12879489","id":"12879489","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"body":"will do\r\n\r\nmay take some time before it occurs again\r\n\r\nalso, if this boils down to a synchronization error of some sort, the extra file io done to write the trace info to disk may add some implicit synchronization/slowdown that may result in not being able to reproduce the issue (i've seen this occur on non-lucene related synchronization issues, add the extra debug logging and it never fails anymore)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"created":"2010-06-16T20:43:40.103+0000","updated":"2010-06-16T20:43:40.103+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/12879495","id":"12879495","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"bq. also, if this boils down to a synchronization error of some sort, the extra file io done to write the trace info to disk may add some implicit synchronization/slowdown that may result in not being able to reproduce the issue\r\n\r\nAhh yes, the Heisenbug (http://en.wikipedia.org/wiki/Unusual_software_bug#Heisenbug).  Still it's worth a shot to see if we can catch it in action...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2010-06-16T21:02:46.658+0000","updated":"2010-06-16T21:02:46.658+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/12881675","id":"12881675","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"body":"I've been informed that this exception is still happening\r\n\r\nhowever, whenever index tracing is turned on, it never seems to occur (extra logging seems to be preventing some lower level synchronization issue from surfacing)\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsmith","name":"tsmith","emailAddress":"tsmith at attivio dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Smith","active":true},"created":"2010-06-23T13:02:15.745+0000","updated":"2010-06-23T13:02:15.745+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/12881923","id":"12881923","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Could you still post the infoStream output?  I can at least look at this to see how IW is being used.\r\n\r\nDoes this occur on different machines?  (Hardware issues could lead to exceptions like this).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2010-06-23T22:19:27.508+0000","updated":"2010-06-23T22:19:27.508+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/13427179","id":"13427179","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gilinachum","name":"gilinachum","emailAddress":"gilinachum at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gili Nachum","active":true},"body":"Seeing a similar issue on 3.1.0. Was this ever resolved? or there's a workaround?\r\n\r\nStack:\r\n{quote}\r\n00000049 SeedlistOpera Failed to process operation ADD java.lang.ArrayIndexOutOfBoundsException at org.apache.lucene.index.ByteBlockPool.allocSlice(ByteBlockPool.java:135) at org.apache.lucene.index.TermsHashPerField.writeByte(TermsHashPerField.java:502) at org.apache.lucene.index.TermsHashPerField.writeVInt(TermsHashPerField.java:523) at org.apache.lucene.index.FreqProxTermsWriterPerField.writeProx(FreqProxTermsWriterPerField.java:106) at org.apache.lucene.index.FreqProxTermsWriterPerField.newTerm(FreqProxTermsWriterPerField.java:126) at org.apache.lucene.index.TermsHashPerField.add(TermsHashPerField.java:479) at org.apache.lucene.index.DocInverterPerField.processFields(DocInverterPerField.java:169) at org.apache.lucene.index.DocFieldProcessorPerThread.processDocument(DocFieldProcessorPerThread.java:248) at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:701) at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:2194) at \r\n...\r\n{quote}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gilinachum","name":"gilinachum","emailAddress":"gilinachum at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gili Nachum","active":true},"created":"2012-08-02T08:40:27.931+0000","updated":"2012-08-02T08:40:27.931+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/13427514","id":"13427514","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"OK I found a possible cause behind this ... it was something I had\r\nfixed but didn't pull out and backport to 3.x LUCENE-3684.\r\n\r\nIt's a thread safety issue, when FielfInfo.indexOptions changes from\r\nDOCS_AND_FREQS_AND_POSITIONS to not indexing positions.  If this\r\nhappens in one thread while a new thread is suddenly indexing a that\r\nsame field there's a narrow window where the 2nd thread's\r\nFreqProxTermsWriterPerField can mis-report the streamCount as 1 when\r\nit should be 2.\r\n\r\nAttached patch (3.6.x) should fix it.  I tried to get a thread test to\r\nprovoke this but couldn't ... I think the window is too small (if I\r\nforcefully add sleeps at the \"right time\" in\r\nFreqProxTermsWriterPerField then I could provoke it...).\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2012-08-02T18:25:46.193+0000","updated":"2012-08-02T18:25:46.193+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/13427517","id":"13427517","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simonw","name":"simonw","emailAddress":"simonw at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Willnauer","active":true},"body":"sneaky, glad that this stuff is single threaded in 4.0 :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simonw","name":"simonw","emailAddress":"simonw at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Willnauer","active":true},"created":"2012-08-02T18:36:31.006+0000","updated":"2012-08-02T18:36:31.006+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/13427518","id":"13427518","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"I'm glad too!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2012-08-02T18:41:00.925+0000","updated":"2012-08-02T18:41:00.925+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/13427531","id":"13427531","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rcmuir","name":"rcmuir","emailAddress":"rcmuir at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rcmuir&avatarId=10150","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rcmuir&avatarId=10150","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rcmuir&avatarId=10150","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rcmuir&avatarId=10150"},"displayName":"Robert Muir","active":true},"body":"+1","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rcmuir","name":"rcmuir","emailAddress":"rcmuir at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rcmuir&avatarId=10150","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rcmuir&avatarId=10150","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rcmuir&avatarId=10150","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rcmuir&avatarId=10150"},"displayName":"Robert Muir","active":true},"created":"2012-08-02T19:01:58.941+0000","updated":"2012-08-02T19:01:58.941+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/13427554","id":"13427554","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"I committed the patch, but I'll leave this open until we can hear back from Tim or Gili that this has resolved the issue ...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2012-08-02T19:47:53.991+0000","updated":"2012-08-02T19:47:53.991+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/13429006","id":"13429006","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gilinachum","name":"gilinachum","emailAddress":"gilinachum at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gili Nachum","active":true},"body":"Issue resolved successfully. Even when increasing the degree of concurrency, I can no longer reproduce with 16 threads over 4 core machine. \r\nThank you Michael!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gilinachum","name":"gilinachum","emailAddress":"gilinachum at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gili Nachum","active":true},"created":"2012-08-06T07:25:38.787+0000","updated":"2012-08-06T07:25:38.787+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467096/comment/13429045","id":"13429045","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Thanks for bringing closure, Gili.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2012-08-06T09:32:59.285+0000","updated":"2012-08-06T09:32:59.285+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-2501/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i04q73:"}}
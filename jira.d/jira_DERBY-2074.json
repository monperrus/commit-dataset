{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12355451","self":"https://issues.apache.org/jira/rest/api/latest/issue/12355451","key":"DERBY-2074","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314116","id":"12314116","description":"10.5.2 Release July 30 2009 (794445) Now deprecated","name":"10.5.2.0","archived":false,"released":true,"releaseDate":"2009-07-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313727","id":"12313727","description":"Feature release","name":"10.6.1.0","archived":false,"released":true,"releaseDate":"2010-05-18"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2008-11-17 21:09:55.124","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22872","customfield_12310222":"3_*:*_1_*:*_791687643_*|*_1_*:*_1_*:*_81993301318_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2009-06-28T14:44:51.961+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2074/watchers","watchCount":2,"isWatching":false},"created":"2006-11-13T10:55:03.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-01-21T17:49:28.726+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11412","id":"11412","name":"Store"}],"timeoriginalestimate":null,"description":"\r\n12:34:45,323 ERROR [pool-1-thread-3] history.helpers.HistoryDataAccessHelper - failed to read measurements, filter = (fromTime=Mon Nov 06 12:34:00 MSK 2006, toTime=Mon Nov 13 12:34:00 MSK 2006, , properties=2-6-2-value) org.springframework.jdbc.UncategorizedSQLException: PreparedStatementCallback; uncategorized SQLException for SQL [SELECT COUNT(DISTINCT sshis.measurement_time) FROM sshis_property_measurement sshis INNER JOIN sstmp_filter_3 filtertbl ON sshis.property_id = filtertbl.property_id WHERE sshis.measurement_time >= ? AND sshis.measurement_time < ?]; SQL state [XJ001]; error code [0]; Java exception:':\r\n java.lang.NullPointerException'.; nested exception is\r\norg.apache.derby.impl.jdbc.EmbedSQLException: Java exception: ': java.lang.NullPointerException'.\r\njava.lang.NullPointerException\r\n        at java.util.Hashtable.put(Unknown Source)\r\n        at org.apache.derby.impl.store.access.RAMAccessManager.registerAccessMethod(Unknown Source)\r\n        at org.apache.derby.impl.store.access.RAMAccessManager.findMethodFactoryByImpl(Unknown Source)\r\n        at org.apache.derby.impl.store.access.RAMTransaction.createSort(UnknownSource)\r\n        at org.apache.derby.impl.sql.execute.DistinctScalarAggregateResultSet.loadSorter(Unknown Source)\r\n        at org.apache.derby.impl.sql.execute.DistinctScalarAggregateResultSet.openCore(Unknown Source)\r\n        at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.openCore(Unknown Source)\r\n        at org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.open(Unknown Source)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)\r\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(Unknown Source)\r\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeQuery(Unknown Source)\r\n        at org.springframework.jdbc.core.JdbcTemplate$1.doInPreparedStatement(JdbcTemplate.java:535)\r\n        at org.springframework.jdbc.core.JdbcTemplate.execute(JdbcTemplate.java:476)\r\n        at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:528)\r\n        at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:561)\r\n        at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:579)\r\n        at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:589)\r\n        at org.springframework.jdbc.core.JdbcTemplate.queryForObject(JdbcTemplate.java:619)\r\n        at org.springframework.jdbc.core.JdbcTemplate.queryForObject(JdbcTemplate.java:629)\r\n        at org.springframework.jdbc.core.JdbcTemplate.queryForInt(JdbcTemplate.java:656)\r\n        at com.meshnetics.wsn.ctrl.dispatcher.services.history.helpers.MeasurementsSaveGetHelper.getMeasurements(MeasurementsSaveGetHelper.java:81)\r\n        at com.meshnetics.wsn.ctrl.dispatcher.services.history.helpers.HistoryDataAccessHelper$7.doInTransaction(HistoryDataAccessHelper.java:315)\r\n        at com.meshnetics.wsn.ctrl.dispatcher.services.history.helpers.HistoryDataAccessHelper$7.doInTransaction(HistoryDataAccessHelper.java:314)\r\n        at org.springframework.transaction.support.TransactionTemplate.execute(TransactionTemplate.java:117)\r\n        at com.meshnetics.wsn.ctrl.dispatcher.services.history.helpers.HistoryDataAccessHelper.getMeasurements(HistoryDataAccessHelper.java:313)\r\n        at com.meshnetics.wsn.ctrl.dispatcher.services.history.asyncread.MeasurementsReadTask.executeTask(MeasurementsReadTask.java:127)\r\n        at com.meshnetics.wsn.ctrl.dispatcher.services.history.asyncread.MeasurementsReadTask.run(MeasurementsReadTask.java:97)\r\n        at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source)\r\n        at java.util.concurrent.FutureTask$Sync.innerRun(Unknown Source)\r\n        at java.util.concurrent.FutureTask.run(Unknown Source)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\r\n        at java.lang.Thread.run(Unknown Source)\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37525","summary":"NullPointerException when two threads load sort factory concurrently","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akovylin","name":"akovylin","emailAddress":"akovylin at meshnetics dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kovylin Alexandr","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akovylin","name":"akovylin","emailAddress":"akovylin at meshnetics dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kovylin Alexandr","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"WinXP Professional, Java 1.5.0_06","customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":15,"total":15,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12648337","id":"12648337","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"This is a very old bug.  It was in component newcomer instead of store so didn't show up in the normal code bugs report.  Do you have any information on how to reproduce?  If not I will close it CannotReproduce.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-11-17T21:09:55.124+0000","updated":"2008-11-17T21:09:55.124+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12662443","id":"12662443","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Has there been any progress in getting a reproduction for this issue.  If not, perhaps we should close it Cannot Reproduce and then reopen when we have a repro.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-01-09T17:43:30.940+0000","updated":"2009-01-09T17:43:30.940+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12720021","id":"12720021","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heftrich_exec","name":"heftrich_exec","emailAddress":"Torsten at Heftrich dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Torsten Heftrich-Zoth","active":true},"body":"We experience this error on some installations at our customers. The error occurs only directly after starting the software during initialization. Problem is that it's not always reproducible, only about every third startup. Now I am able to reproduce it on a test system at our site as well. Is there a possibility for me to activate some logging or using a debug version of derby to shed some light on the problem?  The error also occurs with one database only. This DB has a size of about 100MB. The statement that is causing the problem is always the same. It is joining two large tables, but the output of the statement would be no row at all. Currently we are using 10.5.1.1, but we had the same error with 10.3.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heftrich_exec","name":"heftrich_exec","emailAddress":"Torsten at Heftrich dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Torsten Heftrich-Zoth","active":true},"created":"2009-06-16T09:50:54.545+0000","updated":"2009-06-16T09:50:54.545+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12720083","id":"12720083","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Hi Torsten,\r\n\r\nThere are some things you could try initially:\r\n\r\n1) Use a debug build of Derby 10.5.1.1 (available from the download site - http://db.apache.org/derby/releases/release-10.5.1.1.cgi) which performs some extra sanity checks and may provide a more useful error message.\r\n\r\n2) Set the properties derby.language.logStatementText and derby.language.logQueryPlan to true and post the plan for the problematic query (can be found in derby.log). See if the same plan is used when it fails and when it succeeds. If the plans differ, that may give a hint as to what's causing it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-06-16T11:56:27.407+0000","updated":"2009-06-16T11:56:27.407+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12720633","id":"12720633","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heftrich_exec","name":"heftrich_exec","emailAddress":"Torsten at Heftrich dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Torsten Heftrich-Zoth","active":true},"body":"It seems to me after some experimenting that this item is related to synchronization and multithreading. In my scenario the error does not occur when I use the debug version or activate the proposed logging. The error occurs not on my development machine but on an 8-core server. Additionally the error occurs more often when this server is nearly idle.\r\nAs explanation I may add, that in our application two servlets are initializing nearly at the same time and are executing the same expensive statement nearly simultaneously. When only one servlet is activated the errors also does never occur.\r\nFor now it seems I could solve the problem for us. I introduced some synchronization into our code which forces the two servlets to initialize after one another. \r\nI saved the setup which produces the error, so if you wish me to test some changes to derby or produce some log output for you, give me a hint.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heftrich_exec","name":"heftrich_exec","emailAddress":"Torsten at Heftrich dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Torsten Heftrich-Zoth","active":true},"created":"2009-06-17T11:50:07.638+0000","updated":"2009-06-17T11:50:07.638+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12720922","id":"12720922","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for that extra info, Torsten. I managed to create a small app that reliably reproduces the issue in my environment (quad core, OpenSolaris 2009.06, JDK 6u13) by executing a SELECT COUNT(DISTINCT...)) statement in ten parallel threads. Seems like there's a race condition of some kind the first time a SortFactory is loaded.\r\n\r\nThe stack trace on trunk with debug enabled is:\r\n\r\njava.lang.NullPointerException\r\n        at java.util.Hashtable.put(Hashtable.java:399)\r\n        at org.apache.derby.impl.store.access.RAMAccessManager.registerAccessMethod(RAMAccessManager.java:883)\r\n        at org.apache.derby.impl.store.access.RAMAccessManager.findMethodFactoryByImpl(RAMAccessManager.java:693)\r\n        at org.apache.derby.impl.store.access.RAMTransaction.createSort(RAMTransaction.java:1695)\r\n        at org.apache.derby.impl.sql.execute.DistinctScalarAggregateResultSet.loadSorter(DistinctScalarAggregateResultSet.java:362)\r\n        at org.apache.derby.impl.sql.execute.DistinctScalarAggregateResultSet.openCore(DistinctScalarAggregateResultSet.java:144)\r\n        at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.openCore(ProjectRestrictResultSet.java:168)\r\n        at org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.open(BasicNoPutResultSetImpl.java:248)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:416)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:297)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1235)\r\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1648)\r\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeQuery(EmbedPreparedStatement.java:270)\r\n        at LoadSorter$1.run(LoadSorter.java:21)\r\n        at java.lang.Thread.run(Thread.java:619)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-06-17T21:54:10.254+0000","updated":"2009-06-17T21:54:10.254+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12721736","id":"12721736","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"It looks like the problem is that TopService.bootModule() adds the new module to the vector moduleInstances before it boots the module. So when another thread concurrently checks if the module is available, it finds it in moduleInstances and uses it before it is properly initialized.\r\n\r\nI thought swapping the order (boot first, then add to the vector) was a possible solution, but that resulted in lots of assert failures during boot.\r\n\r\nAll the traversal of moduleInstances is synchronized on the TopService instance, except the code that adds and boots the module. If that code is moved inside one of the synchronized blocks, the NPE goes away. There may be a good reason why that code is not synchronized, but I cannot find anything about it in the comments. I'll investigate more.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-06-19T11:03:02.964+0000","updated":"2009-06-19T11:03:02.964+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12722566","id":"12722566","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Booting inside the synchronized block is at least problematic for replication, since SlaveDatabase.boot() creates a new thread (SlaveDatabaseBootThread) and waits for it to finish. SlaveDatabaseBootThread will also attempt to boot the database in order to perform recovery, but it's blocked because the main thread holds the synchronization lock. Both threads are waiting for each other, so we have a deadlock.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-06-22T11:39:04.624+0000","updated":"2009-06-22T11:39:04.624+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12722638","id":"12722638","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Here's an alternative fix (d2047-1a.diff). I'm not able to reproduce the bug when it's applied, and replication also works with this change. Will run the full regression test suite to see if it introduces any other problems, and I'll also see if I can add a JUnit test case.\r\n\r\nIn this patch, I've added a flag to ModuleInstance to indicate whether or not the instance has finished booting. TopService.bootModule() checks this flag when it walks through the moduleInstances list looking for an already booted instance to use, and skips the module instance if it isn't fully booted. This fixes the bug since the code that failed because the module was only partly initialized, will no longer be called unless it's fully initialized.\r\n\r\nIn the cases where we'd get a NullPointerException before, we'll now create and boot two separate instances of the module. But there's already a window in which it is possible to end up booting two instances of the same module (because we drop the synchronization while booting) and it is correctly handled by the existing code, so widening the window shouldn't cause any problems. TopService.bootModule() handles it by checking if someone else successfully added an instance while we were initializing ours. If so, our instance will be discarded and we'll fall back to the other newly created instance.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-06-22T15:26:52.638+0000","updated":"2009-06-22T15:26:52.638+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12723071","id":"12723071","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attaching patch 1b which is 1a + test case. The test case fails occasionally without the fix (more frequently on multi-core machines). It looks like it fails even less frequently if it's run as part of a test suite than if it's run standalone, but it does fail in that context too. I haven't seen it fail with the fix applied.\r\n\r\nAll the regression tests passed with the 1a patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-06-23T13:23:53.863+0000","updated":"2009-06-23T13:23:53.863+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12723072","id":"12723072","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Knut for the patch.  Before it is resolved, I think it would be good to change the summary on this issue to be more descriptive of the symptom.\r\n\r\nI didn't apply the patch but the indentation looks a bit off in the diff around\r\n+        module.setBooted();\r\n+\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-06-23T13:33:04.047+0000","updated":"2009-06-23T13:33:04.047+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12723079","id":"12723079","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks Kathey. I changed the summary to better describe the symptoms. As to the indentation, if you view the patch with tab size 4, as it is used in the code, I think the added code will line up with the surrounding code.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-06-23T14:04:59.153+0000","updated":"2009-06-23T14:04:59.153+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12724500","id":"12724500","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Committed to trunk with revision 788670.\r\n\r\nI'll keep the issue open until the fix has been merged to the 10.5 branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-06-26T12:17:10.237+0000","updated":"2009-06-26T12:17:10.237+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12724958","id":"12724958","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Merged to 10.5 and committed revision 789103.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-06-28T14:44:51.805+0000","updated":"2009-06-28T14:44:51.805+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12355451/comment/12780446","id":"12780446","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I am working with a user who may have hit this issue on 10.3.  The trace does indeed look quite similar.  I tried changing the reproduction to use a regular database instead of in memory and could not get the issue to reproduce on 10.3.  The fix itself ported easily, so I think I will just merge the code fix, check it in  and see if it fixes their problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-11-20T05:22:20.772+0000","updated":"2009-11-20T05:22:20.772+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2074/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06sc7:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12516862","self":"https://issues.apache.org/jira/rest/api/latest/issue/12516862","key":"DERBY-5367","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317968","id":"12317968","description":"second release on the 10.8 branch","name":"10.8.2.2","archived":false,"released":true,"releaseDate":"2011-10-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2011-08-11 08:24:17.57","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24799","customfield_12310222":"3_*:*_1_*:*_2179796510_*|*_1_*:*_1_*:*_2430560689_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2011-09-24T14:24:26.533+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5367/watchers","watchCount":2,"isWatching":false},"created":"2011-08-02T05:45:09.447+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"8.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316362","id":"12316362","description":"First release on the 10.8 branch","name":"10.8.1.2","archived":false,"released":true,"releaseDate":"2011-04-29"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-06-17T09:19:15.009+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11412","id":"11412","name":"Store"}],"timeoriginalestimate":null,"description":"Our product recently upgraded to version 10.8.1.2 in order to take advantage of the new 'case-insensitive' mode offered by Derby in the form of the \"collation=TERRITORY_BASED:PRIMARY\" connection parameter.\r\n\r\nUnfortunately, we have run into an issue whereby stale data appears to be retrieved from an index, even though the data in the table itself has changed.\r\n\r\nYou can see this issue in the IJ session below.  The database in question was created using this Java parameter when invoking IJ:\r\n\r\n-Dij.database=jdbc:derby:test;create=true;collation=TERRITORY_BASED:PRIMARY\r\n\r\nHere is the IJ session:\r\n\r\nCONNECTION0* - \tjdbc:derby:test\r\n* = current connection\r\n\r\nij> CREATE TABLE tag (\r\n    tag_id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,\r\n    tag VARCHAR(255) NOT NULL,\r\n    CONSTRAINT tag_pk PRIMARY KEY (tag_id),\r\n    CONSTRAINT tag_tag_unique UNIQUE (tag)\r\n);\r\n0 rows inserted/updated/deleted\r\n\r\nij> -- first insert a value 'Test', note the upper-case 'T' in 'Test'\r\nij> INSERT INTO tag (tag) VALUES ('Test');\r\n1 row inserted/updated/deleted\r\n\r\nij> SELECT * FROM tag;\r\nTAG_ID     |TAG                                                                                                                             \r\n--------------------------------------------------------------------------------------------------------------------------------------------\r\n1          |Test                                                                                                                            \r\n\r\n1 row selected\r\n\r\nij> -- Now delete the row\r\nij> DELETE FROM tag WHERE tag='Test';\r\n1 row inserted/updated/deleted\r\n\r\nij> -- You could run another SELECT here to verify it is gone, but it is.\r\n\r\nij> -- Now insert a new value 'test', note the lower-case 't' in 'test'\r\nij> INSERT INTO tag (tag) VALUES ('test');\r\n1 row inserted/updated/deleted\r\n\r\nij> -- Now verify that the table contains only the lower-case version: 'test'\r\nij> SELECT * FROM tag;\r\nTAG_ID     |TAG                                                                                                                             \r\n--------------------------------------------------------------------------------------------------------------------------------------------\r\n2          |test                                                                                                                            \r\n\r\n1 row selected\r\n\r\nij> -- Now, here is the bug.\r\nij> SELECT tag FROM tag;\r\nTAG                                                                                                                             \r\n--------------------------------------------------------------------------------------------------------------------------------\r\nTest                                                                                                                            \r\n\r\n1 row selected\r\nij> \r\n\r\nNote in the last SELECT we specify the 'tag' column specifically.  When we 'SELECT *', Derby performs a table-scan and the result is correct.  However, when we 'SELECT tag', Derby appears to use the index created for the 'tag_tag_unique' unique constraint.  As an optimization Derby, like many databases, will use values directly from the index in the case where the index covers all requested columns.\r\n\r\nThe bigger question is, why doesn't the DELETE action cause the entry in the tag_tag_unique index to be deleted?  Is this a further optimization?  If so, it is imperative that the index at least be updated when the new value is inserted.\r\n\r\nThis is rather a severe bug for us that causes stale data to be returned.\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10364","value":"Data corruption","id":"10364"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"36290","summary":"Stale data retrieved when using new collation=TERRITORY_BASED:PRIMARY feature","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Mac OS X, Windows","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":33,"total":33,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13083007","id":"13083007","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Verified the repro on trunk (Solaris 11 Express).\r\nReset the urgency flag, that's for the release manager to specify.\r\n\r\nCompressing the table makes the problem go away - this further strengthen the suspicion about a corrupted index.\r\nThe bug is also seen when issuing a delete without a where-clause.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-08-11T08:24:17.570+0000","updated":"2011-08-11T08:24:17.570+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13083033","id":"13083033","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Turns out the problem here is the insert into the index (see BTreeController.doIns).\r\nThere is optimization code in there to undelete a deleted row in a unique index if the \"same\" row is inserted again before the row has been purged. This assumes that the fields that are part of the key are equal, but this assumption may be broken when using collations.\r\n\r\nThe insert code is smart enough to update the row location of the index row, but it doesn't understand that the value stored in the base row has changed.\r\n\r\nI'm not very familiar with this code, so I'd like to get some feedback from more knowledgeable people.\r\nTo me these possible solutions come to mind:\r\n a) Deoptimize insert - always insert a new index row.\r\n b) Make conglomerate code aware of collations and take appropriate actions after comparing the new and the old value(s)\r\n\r\nI don't know what consequences the proposed solutions bring to the table.\r\nA quick and dirty fix of the code (where I updated the key field) made the repro pass.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-08-11T09:34:11.481+0000","updated":"2011-08-11T09:37:25.661+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13083165","id":"13083165","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"I think we would want to avoid turning off the optimization if we don't have to. \r\nBut is there a way to know what collations are \"safe\"? I think our default collation uses binary UTF comparisons, so those should be ok, cf. http://db.apache.org/derby/docs/10.8/devguide/cdevcollation.html . Perhaps you can determine if non-default collation is active and only deoptimize (or do an extra compare to determine if de-opt'ing needed) for those cases.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-08-11T15:28:03.093+0000","updated":"2011-08-11T15:28:03.093+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13084133","id":"13084133","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Attaching patch 1a, which replaces/updates the whole row if a deleted row is reused and collations are enabled.\r\n\r\nPatch ready for discussion and review.\r\nIt passed the regression tests and the bug demonstrated by the repro is addressed. I don't really expect to commit this one, but it demonstrates one possible solution.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-08-12T13:56:59.371+0000","updated":"2011-08-12T13:56:59.371+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13084804","id":"13084804","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Thanks Kristian.\r\n\r\nI have reviewed and tested the patch, and can't find any issues with it.  It seems like the minimal patch to existing code that would fix the bug.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2011-08-14T08:23:46.934+0000","updated":"2011-08-14T08:23:46.934+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13085073","id":"13085073","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Thanks for testing and reviewing the patch, Brett.\r\nI will work hard to have a fix committed in time for the upcoming 10.8.2-release, but I'd still like to get a comment from one of the store experts.\r\nThe store is tricky, and maybe there are other places in the code that isn't prepared for collations.\r\n\r\nAttaching patch 1b, with the following changes:\r\n o moved the check for collated types inside the sp.resultExact block. A further change may be to remove the instance variables altogether.\r\n o added a regression test in CollationTest2.\r\n\r\nThere might be room for improvement in the wording (both comments and method-names), since my vocabulary related to collations is rather thin :) Also, I believe we are applying a collation order even when there is no territory specified, so DVD.isCollatedType is maybe confusing?\r\n\r\nAnother question:\r\nThe block above the one where I applied the fix deals with the case where also the row location is the same.\r\nWhen does this case happen, and is it guaranteed that the row values are correct even when a (non-default) collation is being used?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-08-15T13:14:24.541+0000","updated":"2011-08-15T13:14:24.541+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13092984","id":"13092984","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I have not looked at patch yet.  First some answers to previous questions.  \r\n\r\nAs to the following:\r\na) Deoptimize insert - always insert a new index row. \r\n\r\nThis would be a bad idea.  Algorithms in the btree depend on every leaf row in the tree being unique, whether the rows are deleted or not.   There are 2 cases\r\nto consider: unique and non-unique btrees.  In the case of non-unique btrees each leaf row is made unique by including the trailing row location as part of the whole key.  In the case of unique btrees the keys should be unique not including the row location, and thus the search algo's don't include it as part of the key.\r\n\r\nThe kinds of things that depend on this may include the following:\r\no the various binary searches on the leafs assume a single unique final destination, if the code allows for multiple duplicate leafs then I think you might randomly end up in the middle of a list of keys depending on binary search, and the code does not expect to get to a destination and \"backup\" to beginning of\r\na list. \r\no the check for inserting a duplicate error assumes the binary search will get to exactly the ONE row that matches depending on unique vs non-unique\r\nparameters.  I think bugs will arise if there are more than one matching row.  \r\n\r\nAs to following question:\r\n>The block above the one where I applied the fix deals with the case where also the row location is the same.\r\n>When does this case happen, and is it guaranteed that the row values are correct even when a (non-default) collation is being used? \r\nLogically the code should handle this as Derby theoretically allows for reusable record ids.  In practice heap pages are marked to not allow them, so \r\ni don;t think this is a normal event.  It might happen as part of particular paths through crash recovery where we do logical undo vs. physical undo on\r\nbtree pages. \r\n\r\nI am not sure about the question about non-default collation.  At high level I believe it should work and the store should just count on the result \r\nof the collation code doing the compare.  If it says 2 different things are the same then it should just treat them as the same.\r\n\r\nNext I will look at patch.  Sorry about delay - have been out and away from list for awhile.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-08-29T17:21:32.724+0000","updated":"2011-08-29T17:21:32.724+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13093016","id":"13093016","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I looked at the patch, and I am leaning toward it is not worth putting in the special case code for collation.  I think it would be better if you just got rid of the optimization of only updating the row location, and just do the whole row update in the case of matching row always.  I think this path is not a very normal path and better to make the code \r\nsimple and not make the fast insert path for all inserts deal with checking for collation or not.   Extra benefit is we will get better testing with one code path\r\nand can optimize later if we need to.\r\n\r\nDo leave a comment why you are not doing the optimization, as it will seem strange without at least a reference to collation and why 2 things that compare the same might not actually be same value.  \r\n\r\nI do agree that in general the fix is the right one, in that you need to update the whole row rather than part in the collation case.\r\n\r\nEither as part of this fix or log another jira I do believe the other block that handles all fields being the same also should be fixed.  I posted a guess at those code paths, but to be sure probably easiest is to add a stack trace dump to standard out and run the full test suite.  Again I think it would be reasonable to \r\njust remove the optimization always and do a full update with a comment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-08-29T17:54:13.023+0000","updated":"2011-08-29T17:54:13.023+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13093057","id":"13093057","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"a comment on the caching of the work to determine if any collation fields exist.  The current patch optimizes this on a per open conglomerate basis.\r\nAbsolute performance would be best if users did all their inserts in one open, but many do not.  A better place to optimize this would be at compile\r\ntime, this is the usual place to push these kinds of optimizations in Derby.  I have not done work in this area for quite awhile, but the DynamicCompiledOpenConglomInfo of OpenBTree is the place to do such compile time optimizations.  If changes are done in this area it is important to bump the version number to invalidate existing compiled stored plans.\r\n\r\nAs I suggested I think it would be best to first check in a simple unoptimized fix, and then if necessary do the optimization based on measured\r\nperf diffs in the future. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-08-29T18:25:16.436+0000","updated":"2011-08-29T18:25:16.436+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13095531","id":"13095531","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Thanks, Mike.\r\n\r\nFirst, I wrote a very simple micro-benchmark. It ran an insert followed by a delete on a table with a primary key in a loop.\r\nWith 30 seconds warm up, 60 seconds steady state and the average of three runs per codebase I ended up with a performance degradation of around 3.6% (insane build, using in-memory back end). I'll run this with the disk-based back end later, but first I have another issue to deal with - so these number may be invalid after all...\r\n\r\nWith the simplest fix possible, which is to replace the updateFieldAtSlot with updateAtSlot, I'm getting a total of 33 errors in suites.All. I didn't see these when I tested the first patch, probably because the failing tests aren't using collations so the new code was never run in these tests. Here's what the core exception looks like, which can be reproduced by running lang.AlterTableTest (need only dropColumn + for instance testJira3175):\r\njava.lang.ArrayIndexOutOfBoundsException: -1\r\n        at org.apache.derby.impl.store.raw.data.BasePage.getHeaderAtSlot(BasePage.java:1881)\r\n        at org.apache.derby.impl.store.raw.data.StoredPage.storeRecordForUpdate(StoredPage.java:7316)\r\n        at org.apache.derby.impl.store.raw.data.StoredPage.storeRecord(StoredPage.java:7185)\r\n        at org.apache.derby.impl.store.raw.data.UpdateOperation.undoMe(UpdateOperation.java:201)\r\n        at org.apache.derby.impl.store.raw.data.PhysicalUndoOperation.doMe(PhysicalUndoOperation.java:147)\r\n        at org.apache.derby.impl.store.raw.log.FileLogger.logAndUndo(FileLogger.java:533)\r\n        at org.apache.derby.impl.store.raw.xact.Xact.logAndUndo(Xact.java:374)\r\n        at org.apache.derby.impl.store.raw.log.FileLogger.undo(FileLogger.java:1015)\r\n        at org.apache.derby.impl.store.raw.xact.Xact.abort(Xact.java:952)\r\n        at org.apache.derby.impl.store.access.RAMTransaction.abort(RAMTransaction.java:1985)\r\n        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.doRollback(GenericLanguageConnectionContext.java:1767)\r\n        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.userRollback(GenericLanguageConnectionContext.java:1675)\r\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.rollback(TransactionResourceImpl.java:245)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.rollback(EmbedConnection.java:1838)\r\n        at org.apache.derbyTesting.junit.JDBC.cleanup(JDBC.java:224)\r\n        at org.apache.derbyTesting.junit.BaseJDBCTestCase.tearDown(BaseJDBCTestCase.java:408)\r\n\r\nI do see that there are some differences related to undo-logic for the two method calls, but that may very well be a red herring. The problem does seem to be related to logging and transactions.\r\nSo, there's obviously something I don't understand here... I'll continue digging tomorrow - any hints would be helpful :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-01T18:54:51.764+0000","updated":"2011-09-01T18:54:51.764+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13095533","id":"13095533","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Attaching patch 2a, which produces the errors mentioned in the above comment.\r\nNot for commit.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-01T18:55:49.368+0000","updated":"2011-09-01T18:55:49.368+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13100322","id":"13100322","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Note to self that the new test should specify the English locale (there may not be a collation for the locale specified/used by the user).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-08T13:53:13.756+0000","updated":"2011-09-08T13:53:13.756+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13100597","id":"13100597","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"not sure what is going on.   Did you run the tests in SANE mode at all?  That -1 sometimes is indicative of some sort of page corruption with something overwriting something else.  Sometimes the SANE code will give a different more obvious error.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-09-08T19:11:35.347+0000","updated":"2011-09-08T19:11:35.347+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13100606","id":"13100606","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"on the benchmark, i assume that was your original patch.  3.6% seems high to me.  I understand that using in memory this is likely the worst case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-09-08T19:18:07.996+0000","updated":"2011-09-08T19:18:07.996+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13100632","id":"13100632","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I think the problem is that updateAtSlot interface can not be used in btree's in general.   It only supports physical undo which means that the row must be in exactly the same spot on the page as it was originally.  It is used in a couple of places in the btree code on the control row (ie. the row that is always in slot 0).  But otherwise rows move around in btrees and that is the purpose of the logical undo logic.  Updates of rows in btrees are always done as deletes followed by inserts.  But that does not help in this special case.  The updateFieldAtSlot interface does support logical undo.  \r\n\r\nOff hand seems like we could:\r\n1) write a updateAtSlot that does logical undo.  Before this it was not needed because an update of btree row would never \"know\" that it was going back to the same slot, so it was always cleaner to just do the delete and insert.  I would be willing to help with this, let me know.  \r\n\r\n2) a little ugly but might be interesting as a quick fix to see if it works is that you could do updateFieldAtSlot for each field in the row.\r\n\r\nI will think about this over night and see if I can come up with anything simpler.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-09-08T19:41:08.045+0000","updated":"2011-09-08T19:41:08.045+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13100662","id":"13100662","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Thanks for that information, Mike!\r\n\r\nI have written a patch for option 2 already, and suites.All ran without failure (sane build). I'll run derbyall too, and run a first simple performance experiment. I suppose the performance degradation will become worse with the number of key fields.\r\n\r\nAnother option would be to combine 2 with an improved version of what I did in my first patch - only update the full row if the data types in the key are collation sensitive.\r\n\r\nI have no experience in the area of option 1, so I will probably be unable to get something working before Monday...\r\n\r\nFYI, I saw the -1 with a sane build. The record isn't found and the store (I don't remember the method name) returns -1 as the slot.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-08T20:17:44.718+0000","updated":"2011-09-08T20:17:44.718+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13100709","id":"13100709","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"derbyall passed too.\r\nInitial perf numbers seems to be comparable with the previous ones when using the in-memory back end.\r\nI'll start some longer runs tomorrow with the on-disk back end and upload the test code.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-08T21:25:13.763+0000","updated":"2011-09-08T21:25:13.763+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13100756","id":"13100756","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"For benchmarks it seems like we would like to know results for 2 different types of benchmarks.  The worst case for this code would be primary key insert and delete repeated using the same key.  I think that is what you are doing.  Then also just a normal mix of insert/delete.  The question I would be trying to understand is it worth the overhead to the \"normal\" path to know if we can then optimize for the worst case path.  Basically 3.6% degredation for that worst case which I don't think is a normal usage pattern may be ok.  What I don't want to see is\r\nslowdown is \"normal\" case which I think we might have seen with patch 1 that did work in normal path to optimize the worst case path.\r\n\r\nI think option 2 is a reasonable approach for a bug fix to existing codelines.  Seems safe to me, and a good first step.  And doing it not \r\nspecial cased gets us full testing that caught the previous problem with the patch.\r\n\r\nWith more thought I don't think we should do option 1.  I think it might make sense to log a future project for the trunk to look into just going ahead a purging the deleted row and then retrying the insert.  Whie we have the latch we may just want to purge all committed deleted rows\r\nin a similar fashion to what we do previous to splitting the page.\r\nThe problem is that purge is tricky in that it has to be committed while holding the latch on the page, you can't just call it in-line in the current\r\ncode.  And you have to make sure that if you fork a transaction that parent is not conflicting with child to do the purge, otherwise might loop\r\nforever.  The purge will also address the RESOLVE in the code right now (since that comment was written HeapRowLocations are now variable in size based on CompressedNumber) .  And with the specific issue that is causing this issue it is also\r\npossible that updating \"equal\" fields might need more space given that different characters and chacter sequences can be \"equal\".  So the\r\nproblem is even possibly worse for the collation problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-09-08T22:35:20.814+0000","updated":"2011-09-08T22:35:20.814+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13101316","id":"13101316","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Attaching patch 3a, which I'm running tests with.\r\n\r\nCan you specify in some more detail what you mean with a normal mix of insert/delete?\r\n\r\nI have started the first batch of tests for the simple case - insert and delete the same key over and over again.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-09T16:39:52.694+0000","updated":"2011-09-09T16:39:52.694+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13102566","id":"13102566","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"I have run two simple benchmarks. The first one I cannot post the source code for, but it populates the database and then it starts deleting and inserting records. Here I saw around 7% performance decrease with the proposed fix.\r\n\r\nI'll attach the source for the other benchmark. It is very simple, and only inserts and deletes the same record over and over again. The insert and delete is done as one transaction.\r\nI ran with 60 s warmup and 300 s steady-state, ten runs per configuration. Unless stated otherwise, all settings are default. I just rounded the final numbers.\r\nExplanation for the \"bad\" runs follows further down.\r\n\r\n--- single column key\r\nclean, auto on: 637 tps\r\nd5367, auto on: 557 tps\r\n==> -12,5%\r\n\r\nclean, auto off: 3560 tps (5 \"bad\" runs)\r\nd5367, auto off: 2874 tps (3 \"bad\" runs)\r\n==> -19.5%\r\n(commit interval 5k)\r\n\r\n--- composite key, three columns\r\nclean, auto on: 551 tps\r\nd5367, auto on: 382 tps\r\n==> -30%\r\n\r\nclean, auto off: 2799 tps (1 \"bad\" runs)\r\nd5367, auto off: 1671 tps (0 \"bad\" runs)\r\n==> -40%\r\n\r\n--- max checkpoint interval and log switch interval (single column key)\r\nclean, auto off: 6272 tps (3 \"bad\" runs)\r\nd5367, auto off: 4908 tps (0 \"bad\" runs)\r\n==> -21,5%\r\n\r\nI tested the checkpoint interval and log switch settings because I saw runs with huge performance drops with the default settings. I wasn't able to get rid of these entirely. What I saw was runs with auto-commit off whose performance dropped roughly to the performance of the runs with auto-commit on. I haven't investigated further, but I'd like to know if the drops are limited duration events, or if the performance drop is permanent.\r\nThe numbers above are for worst case scenarios.\r\n\r\nI'm currently testing an alternative patch to see how performance is affected when we optimize to avoid updating all fields when there are no collated types in the conglomerate. This has the drawback that concerned Mike - there will be multiple code paths and the new code executed for collated types only will be a lot less tested.\r\nThis can be optimized further for composite keys, but that part is not high priority for me right now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-12T11:41:00.799+0000","updated":"2011-09-12T11:41:49.507+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13102991","id":"13102991","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Attaching patch 4a, which takes another approach when it comes to optimizing the code. The old/current code will be run on indexes which don't have collated types, whereas the for indexes with collated types all fields will be updated (one by one).\r\n\r\nHopefully, one should see identical performance in the normal case with this patch.\r\n\r\nWith collated types performance will drop as indicated in the performance results I posted above (worst case). It might be possible to trade CPU for IO, i.e. to compare the values before deciding to update the field. One can also avoid updating fields that aren't collated (only relevant for composite keys).\r\n\r\nPatch ready for review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-12T20:14:07.219+0000","updated":"2011-09-12T20:14:07.219+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13103485","id":"13103485","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Brett, do you have an idea of how often the insert-delete-insert pattern is executed in your application(s)? (on tables with an index, with or without collation)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-13T09:18:25.905+0000","updated":"2011-09-13T09:18:25.905+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13108026","id":"13108026","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Mike, what's your take on a fix along the lines of patch 4a?\r\nI'd have to run the same sets of benchmarks on non-collated database, first but if those results are looking okay I lean towards a commit.\r\n\r\nI don't have a good sense of how often this code will be run, so it's hard for me to say if we should just not optimize this at all. Judging by the performance numbers only, I would definitely do the optimization.\r\n\r\nI want to see a fix for this issue shortly, such that people affected can run off the head of 10.8 with their own build if they want to do so (with the risks associated of course).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-19T17:52:58.079+0000","updated":"2011-09-19T17:52:58.079+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13108310","id":"13108310","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Kristian,\r\n\r\nWith respect to this particular case (collation), the insert-delete-insert pattern is strictly based on user input.  How this was discovered was that a user created a \"tag\" on an entity in our system (eg. 'cisco'), realized they had mistyped, deleted 'cisco', and added 'Cisco'.  This resulted in the lower-case 'cisco' coming back (because of this bug).  So to answer you question, with respect to this bug, I would classify it as \"low frequency\".\r\n\r\nHowever, obviously, insert-delete-insert patterns are fairly common in general.  Any system that collects information in an automated fashion (news feeds, network data, seismic data, etc.) might delete a bunch of old rows and insert new rows with greater frequency.\r\n\r\nTo tell you the truth, because of https://issues.apache.org/jira/browse/DERBY-4279, I've abandoned this \"pattern\" almost completely in Derby.  Whenever I need to delete a bunch of rows ('bunch' being tens of) and insert a new batch in the same transaction, because of 4279, I now have to instead mark rows deleted (with an UPDATE statement) and then insert new rows.  Deletion of marked rows is handled later via a scheduled deletion job.\r\n\r\nThat of course is an aside (4279), but I'm surprised you can actually run your benchmark without running into it.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2011-09-20T01:22:44.391+0000","updated":"2011-09-20T01:22:44.391+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13109000","id":"13109000","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"If I understand this correctly the optimization is the old code (already well tested) which would still apply for non-collated dbs. So, the new code would only apply for the (already buggy) collated code path. If so, it seems justified to me to have the optimization. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-09-20T21:11:12.925+0000","updated":"2011-09-20T21:11:12.925+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13112159","id":"13112159","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I have reviewed the most recent patch.  Here are comments, none of which I would say should hold up a commit:\r\n\r\no I much prefer the current optimization as now it is a compile time decision.  I still would prefer if non-collated db's did not have to march through\r\n   all the collumns and calculate if the row has collated columns on every compile.  I might have pushed the work up to language by adding an\r\n   argument to OpenConglomerateScratchSpace to pass in hasCollatedTypes.  That would make most sense if the calling level has a better\r\n   understanding of the collation state of the DB and/or table and could avoid the calculation.\r\n\r\no I believe you said it, but just want to verify that you ran at least one set of tests where all tests went through the proposed collation code path just\r\n   to make sure it was tested once.  My guess is that the new codepath you are adding is probably not tested at all, without adding some new tests.\r\n   Seems like you should at least add some version of the test case from the bug report.\r\n\r\no I think the following is also a bug for same reason as you are working on - but not sure how to force the code path, but happy to have it as a separate JIRA - let me know if I should report it:\r\n if (this.getConglomerate().nKeyFields ==\r\n     this.getConglomerate().nUniqueColumns)\r\n {\r\n     // The row that we found deleted is exactly the new ro\r\n     targetleaf.page.deleteAtSlot(\r\n         insert_slot, false, this.btree_undo);\r\n\r\n     break;\r\n }\r\n\r\no longer term I think that we should not be doing the update at all, and instead doing purges.  I think that will solve some of the possible out of space issues.  But I think there are self deadlocking issues there so I am in favor of your approach especially for back porting to existing releases.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-09-21T22:08:46.906+0000","updated":"2011-09-21T22:08:46.906+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13112604","id":"13112604","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Mike,\r\n\r\nMy replies below, to your comments above.\r\n\r\n o I've changed this a bit again, see patch 4b.\r\n   I now detect if there are columns with other collations than UCS BASIC\r\n   when the conglomerate is created or opened. By tacking on to\r\n   ConglomerateUtil.readCollationIdArray this comes almost for free (need\r\n   one more boolean field in the conglom classes though), and we just have\r\n   to iterate through the ids once upon creation.\r\n   Derby always has to do an if on hasCollatedTypes(). This could maybe be\r\n   made final with some refactoring (not sure if that would matter though).\r\n\r\n o Yes, the new test I wrote, based on the bug report, will be included.\r\n   It is now part of patch 4b.\r\n   There are no other tests stressing this piece of code in suites.All.\r\n\r\n o Please report this. It looked suspicious to me the first time I saw it,\r\n   but I don't have the knowledge to add any more context.\r\n   FYI, the test jdbciapi.SURQueryMixTest triggers that piece of code.\r\n   (SUR = scrollable updatable resultset)\r\n\r\n o Noted. It would be good to log a JIRA for this if not already done.\r\n\r\nNow that it looks like there might be another RC, I'd like to get a fix for\r\nthis issue included. Unfortunately, I'll be away next week. I'll commit this\r\ntomorrow if I don't get any pushback before then.\r\nIf I commit and things go awry, back out the fix (it will be a single commit only).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-22T14:09:55.229+0000","updated":"2011-09-22T14:09:55.229+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13112991","id":"13112991","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Attaching patch 4c. The only difference from 4b is an extra assert in OpenConglomerateScratchSpace.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-22T22:53:05.692+0000","updated":"2011-09-22T22:53:05.692+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13112996","id":"13112996","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Committed patch 4c to trunk with revision 1174436.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-22T22:55:34.905+0000","updated":"2011-09-22T22:55:34.905+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13113232","id":"13113232","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Tests ran cleanly on 10.8 (with the fixed merged from trunk), with the exception of this error in testConcurrentInvalidation(org.apache.derbyTesting.functionTests.tests.lang.TruncateTableTest):\r\nHelper thread failed\r\n...\r\nFri Sep 23 01:19:36 CEST 2011 Thread[DRDAConnThread_77,5,derby.daemons] (XID = 24553), (SESSIONID = 31), (DATABASE = dbsqlauth), (DRDAID = ��������.��-808957766332849398{3}), Failed Statement is: select * from d4275\r\nERROR XSAI2: The conglomerate (4,448) requested does not exist.\r\n        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:286)\r\n        at org.apache.derby.impl.store.access.heap.HeapConglomerateFactory.readConglomerate(HeapConglomerateFactory.java:254)\r\n        at org.apache.derby.impl.store.access.RAMAccessManager.conglomCacheFind(RAMAccessManager.java:482)\r\n        at org.apache.derby.impl.store.access.RAMTransaction.findExistingConglomerate(RAMTransaction.java:394)\r\n        at org.apache.derby.impl.store.access.RAMTransaction.getDynamicCompiledConglomInfo(RAMTransaction.java:692)\r\n        at org.apache.derby.impl.sql.execute.TableScanResultSet.openCore(TableScanResultSet.java:245)\r\n        at org.apache.derby.impl.sql.execute.BulkTableScanResultSet.openCore(BulkTableScanResultSet.java:248)\r\n        at org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.open(BasicNoPutResultSetImpl.java:255)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:436)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:317)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1242)\r\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1686)\r\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(EmbedPreparedStatement.java:1341)\r\n        at org.apache.derby.impl.drda.DRDAStatement.execute(DRDAStatement.java:706)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThread.java:866)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:295)\r\nCleanup action completed\r\n\r\n\r\nI plan to backport the fix on Saturday.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-23T07:53:40.778+0000","updated":"2011-09-23T07:53:40.778+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13113813","id":"13113813","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"i reviewed the latest patch and it looks good to me.  I agree that overhead should be basically \"free\" now with the code working off the\r\nstored conglomerate info and not having to recalculate it.\r\n\r\nIt is great that your test case both tries the newly created conglomerate and shuts down the database and restarts testing the read conglomerate\r\nfrom disk case.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-09-23T22:28:24.953+0000","updated":"2011-09-23T22:28:24.953+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13113985","id":"13113985","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Committed to 10.8 with revision 1175171 (the fix went in with revision 1174436 on trunk).\r\n\r\nI don't expect more work on this issue now, but there seems to be related work in this area of Derby.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-24T14:24:26.566+0000","updated":"2011-09-24T14:24:26.566+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12516862/comment/13685174","id":"13685174","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"[bulk update] Close all resolved issues that haven't been updated for more than one year.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-06-17T09:19:15.006+0000","updated":"2013-06-17T09:19:15.006+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5367/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06kpr:"}}
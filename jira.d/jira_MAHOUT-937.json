{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12536475","self":"https://issues.apache.org/jira/rest/api/latest/issue/12536475","key":"MAHOUT-937","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310751","id":"12310751","key":"MAHOUT","name":"Mahout","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310751&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310751&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310751&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310751&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13060","id":"13060","description":"Apache Mahout","name":"Mahout"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316364","id":"12316364","description":"","name":"0.6","archived":false,"released":true,"releaseDate":"2012-02-06"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-12-28 15:32:39.983","customfield_12312323":null,"customfield_12310420":"222158","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_42503485_*|*_1_*:*_1_*:*_32591503_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2011-12-29T03:21:03.338+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAHOUT-937/watchers","watchCount":0,"isWatching":false},"created":"2011-12-28T06:29:28.549+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315255","id":"12315255","description":"","name":"0.5","archived":false,"released":true,"releaseDate":"2011-05-27"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-02-09T14:00:47.971+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[],"timeoriginalestimate":null,"description":"The first pass of the collocations discovery job (as described by CollocDriver.generateCollocations) uses the org.apache.mahout.vectorizer.collocations.llr.GramKeyPartitioner partitioner. \r\n\r\nThis partitoner has an instance variable offset that is supposed to be set by a call to setOffsets() but this call is never made (not sure why? is this method expected to be called by the Hadoop framework itself?) \r\n\r\nThe offset not being set results in getPartition always returning 0 and so all intermediate data is sent to the one reducer. \r\n\r\nI couldn't quite understand what this partitioning was meant to be doing, but simply hashing the Grams primary string representation (ie without the leading 'type' byte) does what is required...\r\n\r\n{code}\r\npublic class GramKeyPartitioner extends Partitioner<GramKey, Gram> {\r\n\r\n  @Override\r\n  public int getPartition(GramKey key, Gram value, int numPartitions) {\r\n    // exclude first byte which is the key type \r\n    byte[] keyBytesWithoutTypeByte = new byte[key.getPrimaryLength()-1]; \r\n    System.arraycopy(key.getBytes(), 1, keyBytesWithoutTypeByte, 0, keyBytesWithoutTypeByte.length); \r\n    int hash = WritableComparator.hashBytes(keyBytesWithoutTypeByte, keyBytesWithoutTypeByte.length);\r\n    return (hash & Integer.MAX_VALUE) % numPartitions;    \r\n  }\r\n  \r\n}\r\n{code}\r\n\r\n\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"22484","summary":"Collocations Job Partitioner not being configured properly","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mat_kelcey","name":"mat_kelcey","emailAddress":"matthew dot kelcey at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mat_kelcey&avatarId=10321","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mat_kelcey&avatarId=10321","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mat_kelcey&avatarId=10321","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mat_kelcey&avatarId=10321"},"displayName":"Mat Kelcey","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mat_kelcey","name":"mat_kelcey","emailAddress":"matthew dot kelcey at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mat_kelcey&avatarId=10321","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mat_kelcey&avatarId=10321","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mat_kelcey&avatarId=10321","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mat_kelcey&avatarId=10321"},"displayName":"Mat Kelcey","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":3,"total":3,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536475/comment/13176684","id":"13176684","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"body":"I agree this looks like it can't be right. The methods aren't called, and the result hashes 0 bytes every time. I think the simplest thing is to even avoid copying the byte array; here's my proposed patch, which has the same result. Tests pass. I'll commit soon if there are no objections since it seems like this can only be a fix, based on the semantics the tests imply.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"created":"2011-12-28T15:32:39.983+0000","updated":"2011-12-28T15:32:39.983+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536475/comment/13176691","id":"13176691","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mat_kelcey","name":"mat_kelcey","emailAddress":"matthew dot kelcey at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mat_kelcey&avatarId=10321","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mat_kelcey&avatarId=10321","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mat_kelcey&avatarId=10321","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mat_kelcey&avatarId=10321"},"displayName":"Mat Kelcey","active":true},"body":"I should have checked WritableComparator.hashBytes first, for some reason I had it in my head that the hashing was special. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mat_kelcey","name":"mat_kelcey","emailAddress":"matthew dot kelcey at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mat_kelcey&avatarId=10321","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mat_kelcey&avatarId=10321","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mat_kelcey&avatarId=10321","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mat_kelcey&avatarId=10321"},"displayName":"Mat Kelcey","active":true},"created":"2011-12-28T15:48:28.075+0000","updated":"2011-12-28T15:48:28.075+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536475/comment/13177031","id":"13177031","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","emailAddress":"jira at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true},"body":"Integrated in Mahout-Quality #1278 (See [https://builds.apache.org/job/Mahout-Quality/1278/])\r\n    MAHOUT-937 make partitioner send to different reducers (as intended it seems) by just using the hash of primary bytes\r\n\r\nsrowen : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1225420\r\nFiles : \r\n* /mahout/trunk/core/src/main/java/org/apache/mahout/vectorizer/collocations/llr/GramKeyPartitioner.java\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","emailAddress":"jira at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true},"created":"2011-12-29T07:00:19.742+0000","updated":"2011-12-29T07:00:19.742+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAHOUT-937/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i047iv:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12404207","self":"https://issues.apache.org/jira/rest/api/latest/issue/12404207","key":"LUCENE-1383","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310110","id":"12310110","key":"LUCENE","name":"Lucene - Core","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310110&avatarId=10061","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310110&avatarId=10061","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310110&avatarId=10061","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310110&avatarId=10061"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312681","id":"12312681","description":"","name":"2.4","archived":false,"released":true,"releaseDate":"2008-10-08"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2008-09-13 15:46:51.39","customfield_12312323":null,"customfield_12310420":"12368","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_222187238_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_2340950911","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-09-14T10:33:51.238+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-1383/watchers","watchCount":0,"isWatching":false},"created":"2008-09-11T20:50:44.732+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12310334","id":"12310334","description":"last 1.x release, has new 2.x APIs","name":"1.9","archived":false,"released":true,"releaseDate":"2006-02-27"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12310853","id":"12310853","description":"mostly 1.9 with deprecated items removed","name":"2.0.0","archived":false,"released":true,"releaseDate":"2006-05-26"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12310854","id":"12310854","description":"","name":"2.1","archived":false,"released":true,"releaseDate":"2007-02-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312328","id":"12312328","description":"","name":"2.2","archived":false,"released":true,"releaseDate":"2007-06-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312531","id":"12312531","description":"","name":"2.3","archived":false,"released":true,"releaseDate":"2008-01-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312975","id":"12312975","description":"Bug Fixes for the 2.3.0 release","name":"2.3.1","archived":false,"released":true,"releaseDate":"2008-02-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313057","id":"12313057","description":" Bug Fixes for the 2.3.1 release","name":"2.3.2","archived":false,"released":true,"releaseDate":"2008-05-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2008-10-11T12:49:42.148+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12310232","id":"12310232","name":"core/index","description":"issues with indexing code"}],"timeoriginalestimate":null,"description":"Java's ThreadLocal is dangerous to use because it is able to take a\nsurprisingly very long time to release references to the values you\nstore in it.  Even when a ThreadLocal instance itself is GC'd, hard\nreferences to the values you had stored in it are easily kept for\nquite some time later.\n\nWhile this is not technically a \"memory leak\", because eventually\n(when the underlying Map that stores the values cleans up its \"stale\"\nreferences) the hard reference will be cleared, and GC can proceed,\nits end behavior is not different from a memory leak in that under the\nright situation you can easily tie up far more memory than you'd\nexpect, and then hit unexpected OOM error despite allocating an\nextremely large heap to your JVM.\n\nLucene users have hit this many times.  Here's the most recent thread:\n\n  http://mail-archives.apache.org/mod_mbox/lucene-java-dev/200809.mbox/%3C6e3ae6310809091157j7a9fe46bxcc31f6e63305fcdc%40mail.gmail.com%3E\n\nAnd here's another:\n\n  http://mail-archives.apache.org/mod_mbox/lucene-java-dev/200807.mbox/%3CF5FC94B2-E5C7-40C0-8B73-E12245B91CEE%40mikemccandless.com%3E\n\nAnd then there's LUCENE-436 and LUCENE-529 at least.\n\nA google search for \"ThreadLocal leak\" yields many compelling hits.\n\nSun does this for performance reasons, but I think it's a terrible\ntrap and we should work around it with Lucene.","customfield_10010":null,"timetracking":{},"customfield_12310120":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10121","value":"New","id":"10121"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"26666","summary":"Work around ThreadLocal's \"leak\"","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":19,"total":19,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12630367","id":"12630367","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Attached patch.  All tests pass.\r\n\r\nThe patch adds o.a.l.util.CloseableThreadLocal.  It's a wrapper around ThreadLocal that wraps the values inside a WeakReference, but then also holds a strong reference to the value (to ensure GC doesn't reclaim it) until you call the close method.  On calling close, GC is then free to reclaim all values you had stored, regardless of how long it takes ThreadLocal's implementation to actually release its references.\r\n\r\nThere are a couple places in Lucene where I left the current usage of ThreadLocal.\r\n\r\nFirst, Analyzer.java uses ThreadLocal to hold reusable token streams.  There is no \"close\" called for Analyzer, so unless we are willing to add a finalizer to call CloseableThreadLocal.close() I think we can leave it.\r\n\r\nSecond, some of the contrib/benchmark tasks use ThreadLocal to store per-thread DateFormat which should use tiny memory.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2008-09-11T21:04:18.640+0000","updated":"2008-09-11T21:04:18.640+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12630784","id":"12630784","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrislusf","name":"chrislusf","emailAddress":"chris dot lu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Lu","active":true},"body":"I can confirm this patch fixed the memory problem, in general. Thanks!\r\n\r\nHowever, if not nitpicking, I did noticed in this patch, during the transition time between the previous index searcher/reader close and the new index searcher/reader open, there is a bump in the memory graph.\r\n  ____/\\____\r\nThere are 2 RAMDirectory instances in the memory for a short period of time.\r\n\r\nIn previous Lucene version without Lucene-1195, the memory graph looks more clean, with a V dip.\r\n____  ____\r\n         \\/\r\n\r\nAnd in one index refresh during the same index run, there were 2 RAMDirectory in the memory for a fairly long time. But not repeatable.\r\n\r\nSo I suspect the closing is kind of delayed. And sometimes it could be missed.\r\n\r\nAttaching the screenshot for the memory bump, and 2 the memory graphs of the begin and after of 2RAMDirecory in the memory(needed 2 because the time is fairly long)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrislusf","name":"chrislusf","emailAddress":"chris dot lu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Lu","active":true},"created":"2008-09-13T15:46:51.390+0000","updated":"2008-09-13T15:46:51.390+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12630785","id":"12630785","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrislusf","name":"chrislusf","emailAddress":"chris dot lu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Lu","active":true},"body":"A little bump when closing and opening the index. The test did the closing first, then opening.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrislusf","name":"chrislusf","emailAddress":"chris dot lu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Lu","active":true},"created":"2008-09-13T15:48:09.909+0000","updated":"2008-09-13T15:48:09.909+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12630786","id":"12630786","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrislusf","name":"chrislusf","emailAddress":"chris dot lu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Lu","active":true},"body":"Beginning of a memory increase of 2 RAMDirectory in the memory. This is also during a index closing, then opening.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrislusf","name":"chrislusf","emailAddress":"chris dot lu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Lu","active":true},"created":"2008-09-13T15:50:46.587+0000","updated":"2008-09-13T15:50:46.587+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12630787","id":"12630787","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrislusf","name":"chrislusf","emailAddress":"chris dot lu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Lu","active":true},"body":"Endding of a memory increase of 2 RAMDirectory in the memory. This is also during a index closing, then opening. No particular reason, but the RAMDirectory dropped back to 1.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrislusf","name":"chrislusf","emailAddress":"chris dot lu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Lu","active":true},"created":"2008-09-13T15:51:36.887+0000","updated":"2008-09-13T15:51:36.887+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12630789","id":"12630789","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrislusf","name":"chrislusf","emailAddress":"chris dot lu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Lu","active":true},"body":"The test is repeatedly close and open the index. \r\n\r\nAfter the repeat close/open test run finished, I closed the RAMDirectory based searcher/reader, and switched to FSDirectory, the RAMDirectory(which is fairly large) was left in the memory. I did several rounds of GC, but the RAMDirectory was not cleaned. At this time, I tried to do a memory dump, but an OOM occured.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrislusf","name":"chrislusf","emailAddress":"chris dot lu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Lu","active":true},"created":"2008-09-13T16:05:04.668+0000","updated":"2008-09-13T16:05:04.668+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12630811","id":"12630811","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Hmm, the sometimes long-lasting bump in Used memory is odd.\r\n\r\nWhen you close the old IndexSearcher & RAMDirectory do you forcefully dereference them (set all variables that point to them to null) before then reopening the new ones?  (Seems like you must, since you saw the V shape before LUCENE-1195, but I just want to verify).  If you simply re-assign the variable from old to new then two objects will exist at once until the opening of the new one finishes.\r\n\r\nI think the bump may just be GC taking its time collecting the objects, which should be harmless.  Maybe using a WeakReference to a long-lived object causes GC to take longer to collect?\r\n\r\nIs it possible to use the profiler to look for a reference to the old RAMDirectory while the bump is \"up\"?  That would be a smoking gun that we do still have a reference, unless it's only via the WeakReference.\r\n\r\nOr, could you try lowering the heap size in your JRE to something slightly less than 2X one RAMDirectory (but not so low that the \"other stuff\" you have in the JRE can't fit).  This would force GC to work harder / more immediately in reclaiming the unreachable objects.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2008-09-13T18:23:23.063+0000","updated":"2008-09-13T18:23:23.063+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12630845","id":"12630845","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrislusf","name":"chrislusf","emailAddress":"chris dot lu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Lu","active":true},"body":"On second thought, I think this is normal behavior. Like you said, the GC may take a while before really cleaning up stuff. So if I did not wait a while between the close and open, the little bump should be normal.\r\n\r\nSo I would say this bug is fixed. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrislusf","name":"chrislusf","emailAddress":"chris dot lu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Lu","active":true},"created":"2008-09-14T01:26:50.041+0000","updated":"2008-09-14T02:12:51.148+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12630846","id":"12630846","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrislusf","name":"chrislusf","emailAddress":"chris dot lu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Lu","active":true},"body":"this is the V shape memory graph using the patch. This also confirms the leak is fixed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrislusf","name":"chrislusf","emailAddress":"chris dot lu at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Lu","active":true},"created":"2008-09-14T02:14:54.476+0000","updated":"2008-09-14T02:14:54.476+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12630872","id":"12630872","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"OK super!  Thanks for testing Chris.  I'll commit shortly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2008-09-14T10:14:43.815+0000","updated":"2008-09-14T10:14:43.815+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12630875","id":"12630875","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Thanks Chris!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2008-09-14T10:33:51.218+0000","updated":"2008-09-14T10:33:51.218+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12630876","id":"12630876","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Committed revision 695184.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2008-09-14T10:34:02.926+0000","updated":"2008-09-14T10:34:02.926+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12636063","id":"12636063","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.tarau","name":"adrian.tarau","emailAddress":"adrian dot tarau at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Tarau","active":true},"body":"Even if the issue is closed, for those who want to know why ThreadLocal had to be fixed : http://www.javaspecialists.eu/archive/Issue164.html\r\n\r\n\"Best Practices\r\n\r\nIf you must use ThreadLocal, make sure that you remove the value as soon as you are done with it and preferably before you return your thread to a thread pool. Best practice is to use remove() rather than set(null), since that would cause the WeakReference to be removed immediately, together with the value.\r\n\r\nKind regards\r\n\r\nHeinz\"","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.tarau","name":"adrian.tarau","emailAddress":"adrian dot tarau at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Tarau","active":true},"created":"2008-10-01T15:32:23.330+0000","updated":"2008-10-01T15:32:23.330+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12636075","id":"12636075","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rengels%40ix.netcom.com","name":"rengels@ix.netcom.com","emailAddress":"rengels at ix dot netcom dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"robert engels","active":true},"body":"It doesn't need to be \"fixed\".\r\n\r\nIt works fine, you need to understand how to use it properly which may require calling remove() if your threads are long-lived.\r\n\r\nAlso, remove() was only added in 1.5, and that is why that technique is not valid for Lucene. It is also not valid, since you need to clear all values across all threads, remove() only clears the entry for the calling thread.\r\n\r\nThe current patch solves the problem suitably for Lucene, at the expense of some performance degradation.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rengels%40ix.netcom.com","name":"rengels@ix.netcom.com","emailAddress":"rengels at ix dot netcom dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"robert engels","active":true},"created":"2008-10-01T16:03:56.088+0000","updated":"2008-10-01T16:03:56.088+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12636082","id":"12636082","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"bq. The current patch solves the problem suitably for Lucene, at the expense of some performance degradation.\r\n\r\nThe performance degradation should be negligible in the case of long-lived threads.  No synchronized code was added in the get() path.\r\n\r\nbq. It is also not valid, since you need to clear all values across all threads, remove() only clears the entry for the calling thread.\r\n\r\nThis best practice does work correctly: you're supposed to call remove() from the very thread that had inserted something into the ThreadLocal.\r\n\r\nBesides the 1.5 issue, this is also difficult for Lucene because we don't have a clean point to \"know\" when the thread has finished interacting with Lucene.  A thread comes out of the pool, runs a search, gathers docIDs from in a collector, returns from the search, one by one looks up stored docs / term vectors for these docIDs, maybe does secondary search up front to build up filters, etc., finishes rendering the result and returns to the pool.  Unless we create a new method \"detachThread(...)\" somewhere in Lucene, there is no natural point now to do the remove().  And I don't like creating such a method because nobody will ever know they need to call it in their App server until they start hitting cryptic OOMs.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2008-10-01T16:21:09.584+0000","updated":"2008-10-01T16:21:09.584+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12636085","id":"12636085","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.tarau","name":"adrian.tarau","emailAddress":"adrian dot tarau at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Tarau","active":true},"body":"Ok, maybe \"fixed\" was too much and it sounded like ThreadLocal has a problem. ThreadLocal works fine except that it is tricky with long-lived threads.\r\n\r\nAnyway, it is a good article in case somebody wants to understand why this change in Lucene.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.tarau","name":"adrian.tarau","emailAddress":"adrian dot tarau at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Tarau","active":true},"created":"2008-10-01T16:30:18.596+0000","updated":"2008-10-01T16:30:18.596+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12636089","id":"12636089","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.tarau","name":"adrian.tarau","emailAddress":"adrian dot tarau at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Tarau","active":true},"body":"Michael,\r\n\r\nMaybe some sort of cleanup method should be created even if regular users will not call it. \r\n\r\nI presume it can be highlighted somewhere in the documentation, like in \"Best practices\" : http://wiki.apache.org/lucene-java/BestPractices \r\n\r\nI would really like to be able to control this, to be able to clean thread(s) storage programmatically.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.tarau","name":"adrian.tarau","emailAddress":"adrian dot tarau at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Tarau","active":true},"created":"2008-10-01T16:41:15.364+0000","updated":"2008-10-01T16:41:15.364+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12636095","id":"12636095","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rengels%40ix.netcom.com","name":"rengels@ix.netcom.com","emailAddress":"rengels at ix dot netcom dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"robert engels","active":true},"body":"You cannot control this 'externally\", since there is no way to force the cleaning of the stale entries (no API method).\r\n\r\nThe current patch sort of allows this - the entries are not cleared but the weak references in them are - via the close(), but if this method is called at the wrong time, everything will break (since the stream needs to be cached), thus it is not exposed to the outside world.\r\n\r\nIf you want to cleanup programatically, close the index readers and writers.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rengels%40ix.netcom.com","name":"rengels@ix.netcom.com","emailAddress":"rengels at ix dot netcom dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"robert engels","active":true},"created":"2008-10-01T16:56:05.156+0000","updated":"2008-10-01T16:56:05.156+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404207/comment/12636097","id":"12636097","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.tarau","name":"adrian.tarau","emailAddress":"adrian dot tarau at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Tarau","active":true},"body":"If closing all index readers and writers releases all Lucene  thread locals it's great.\r\n\r\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.tarau","name":"adrian.tarau","emailAddress":"adrian dot tarau at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Tarau","active":true},"created":"2008-10-01T17:05:32.871+0000","updated":"2008-10-01T17:05:32.871+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-1383/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i04xc7:"}}
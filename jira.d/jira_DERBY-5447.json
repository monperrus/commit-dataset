{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12526018","self":"https://issues.apache.org/jira/rest/api/latest/issue/12526018","key":"DERBY-5447","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317968","id":"12317968","description":"second release on the 10.8 branch","name":"10.8.2.2","archived":false,"released":true,"releaseDate":"2011-10-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2011-10-09 03:03:26.471","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"49573","customfield_12310222":"3_*:*_1_*:*_147022612_*|*_1_*:*_1_*:*_191960800_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2011-10-10T07:54:41.928+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5447/watchers","watchCount":0,"isWatching":false},"created":"2011-10-06T09:44:58.641+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12348169","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12348169","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12522236","key":"DERBY-5405","self":"https://issues.apache.org/jira/rest/api/2/issue/12522236","fields":{"summary":"Java deadlock in AutomaticIndexStatisticsTest.testShutdownWhileScanningThenDelete (BasePage and StoredPage)","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12344064","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12344064","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12514127","key":"DERBY-5336","self":"https://issues.apache.org/jira/rest/api/2/issue/12514127","fields":{"summary":"Repeated database creation causes OutOfMemoryError","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-02-13T07:42:52.601+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11415","id":"11415","name":"Services"}],"timeoriginalestimate":null,"description":"Java deadlock involving BasePage.releaseExclusive and Observable.deleteObserver, the observable being a BaseContainerHandle instance, seen when running  AutomaticIndexStatisticsTest.testShutdownWhileScanningThenDelete.\r\nThe activities involved are a scan of a conglomerate and the index statistics daemon being stopped as part of the database shutdown.\r\n\r\nHere are the relevant parts of the stack trace:\r\n\"index-stat-thread\" daemon prio=10 tid=0x00007f4e34244000 nid=0x380b waiting for monitor entry [0x00007f4e30aef000]\r\n   java.lang.Thread.State: BLOCKED (on object monitor)\r\n        at java.util.Observable.deleteObserver(Observable.java:95)\r\n        - waiting to lock <0x00000000f51132d0> (a org.apache.derby.impl.store.raw.data.BaseContainerHandle)\r\n        at org.apache.derby.impl.store.raw.data.BasePage.releaseExclusive(BasePage.java:1819)\r\n        - locked <0x00000000f6d5a280> (a org.apache.derby.impl.store.raw.data.StoredPage)\r\n        at org.apache.derby.impl.store.raw.data.CachedPage.releaseExclusive(CachedPage.java:531)\r\n        at org.apache.derby.impl.store.raw.data.StoredPage.releaseExclusive(StoredPage.java:1066)\r\n        at org.apache.derby.impl.store.raw.data.BasePage.unlatch(BasePage.java:1371)\r\n        at org.apache.derby.impl.store.access.btree.ControlRow.release(ControlRow.java:926)\r\n        at org.apache.derby.impl.store.access.btree.BTreeScan.savePositionAndReleasePage(BTreeScan.java:2146)\r\n        at org.apache.derby.impl.store.access.btree.BTreeForwardScan.fetchRows(BTreeForwardScan.java:442)\r\n        at org.apache.derby.impl.store.access.btree.BTreeScan.fetchNextGroup(BTreeScan.java:1681)\r\n        at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl$KeyComparator.fetchRows(IndexStatisticsDaemonImpl.java:1221)\r\n        at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.updateIndexStatsMinion(IndexStatisticsDaemonImpl.java:463)\r\n        at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.generateStatistics(IndexStatisticsDaemonImpl.java:323)\r\n        at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.processingLoop(IndexStatisticsDaemonImpl.java:794)\r\n        at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.run(IndexStatisticsDaemonImpl.java:710)\r\n        at java.lang.Thread.run(Thread.java:679)\r\n\r\n\"main\":\r\n        at org.apache.derby.impl.store.raw.data.BasePage.isLatched(BasePage.java:1383)\r\n        - waiting to lock <0x00000000f6d5a280> (a org.apache.derby.impl.store.raw.data.StoredPage)\r\n        at org.apache.derby.impl.store.raw.data.BasePage.update(BasePage.java:1621)\r\n        at java.util.Observable.notifyObservers(Observable.java:159)\r\n        at java.util.Observable.notifyObservers(Observable.java:115)\r\n        at org.apache.derby.impl.store.raw.data.BaseContainerHandle.informObservers(BaseContainerHandle.java:1008)\r\n        at org.apache.derby.impl.store.raw.data.BaseContainerHandle.close(BaseContainerHandle.java:414)\r\n        - locked <0x00000000f51132d0> (a org.apache.derby.impl.store.raw.data.BaseContainerHandle)\r\n        at org.apache.derby.impl.store.access.btree.OpenBTree.close(OpenBTree.java:490)\r\n        at org.apache.derby.impl.store.access.btree.BTreeScan.closeForEndTransaction(BTreeScan.java:2021)\r\n        at org.apache.derby.impl.store.access.btree.index.B2IForwardScan.closeForEndTransaction(B2IForwardScan.java:107)\r\n        at org.apache.derby.impl.store.access.RAMTransaction.closeControllers(RAMTransaction.java:245)\r\n        at org.apache.derby.impl.store.access.RAMTransactionContext.cleanupOnError(RAMTransactionContext.java:97)\r\n        at org.apache.derby.iapi.services.context.ContextManager.cleanupOnError(ContextManager.java:343)\r\n        at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.stop(IndexStatisticsDaemonImpl.java:919)\r\n        - locked <0x00000000f4a5a070> (a java.util.ArrayList)\r\n        at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.disableIndexStatsRefresher(DataDictionaryImpl.java:13891)\r\n        at org.apache.derby.impl.db.DatabaseContextImpl.cleanupOnError(DatabaseContextImpl.java:69)\r\n        at org.apache.derby.iapi.services.context.ContextManager.cleanupOnError(ContextManager.java:343)\r\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.cleanupOnError(TransactionResourceImpl.java:437)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.<init>(EmbedConnection.java:633)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection30.<init>(EmbedConnection30.java:73)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection40.<init>(EmbedConnection40.java:51)\r\n        at org.apache.derby.jdbc.Driver40.getNewEmbedConnection(Driver40.java:70)\r\n        at org.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:248)\r\n        at org.apache.derby.jdbc.EmbeddedDataSource.getConnection(EmbeddedDataSource.java:480)\r\n        at org.apache.derby.jdbc.EmbeddedDataSource.getConnection(EmbeddedDataSource.java:424)\r\n        at org.apache.derbyTesting.junit.JDBCDataSource.shutdownDatabase(JDBCDataSource.java:266)\r\n        at org.apache.derbyTesting.functionTests.tests.store.AutomaticIndexStatisticsTest.testShutdownWhileScanningThenDelete(AutomaticIndexStatisticsTest.java:187)\r\n\r\nI have access to a machine on which this can be reproduced pretty simple. It's an Intel(R) Core(TM)2 Duo CPU E8500 @ 3.16GHz running Fedora 15.\r\nJava is:\r\nOpenJDK Runtime Environment (IcedTea6 1.10.2) (fedora-58.1.10.2.fc15-x86_64)\r\nOpenJDK 64-Bit Server VM (build 20.0-b11, mixed mode)\r\n\r\nIn a way this bug is critical, since it causes two threads to hang forever. However, for it to happen the database must be shut down while the index statistics daemon is doing work and the timing must be right. There may be other ways to trigger the bug where Observable.update and BasePage.releaseExclusive are involved.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"36109","summary":"Deadlock in AutomaticIndexStatisticsTest.testShutdownWhileScanningThenDelete (BasePage.releaseExclusive and Observable.deleteObserver (BaseContainerHandle))","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":6,"total":6,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526018/comment/13121867","id":"13121867","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"The stack for the problem with an insane build:\r\n\"index-stat-thread\":\r\n\tat java.util.Observable.deleteObserver(Observable.java:95)\r\n\t- waiting to lock <0x00000000e83304a8> (a org.apache.derby.impl.store.raw.data.BaseContainerHandle)\r\n\tat org.apache.derby.impl.store.raw.data.BasePage.releaseExclusive(BasePage.java:1819)\r\n\t- locked <0x00000000e8c9f980> (a org.apache.derby.impl.store.raw.data.StoredPage)\r\n\tat org.apache.derby.impl.store.raw.data.CachedPage.releaseExclusive(CachedPage.java:531)\r\n\tat org.apache.derby.impl.store.raw.data.StoredPage.releaseExclusive(StoredPage.java:1066)\r\n\tat org.apache.derby.impl.store.raw.data.BasePage.unlatch(BasePage.java:1371)\r\n\tat org.apache.derby.impl.store.access.btree.ControlRow.release(ControlRow.java:926)\r\n\tat org.apache.derby.impl.store.access.btree.BTreeScan.positionAtNextPage(BTreeScan.java:505)\r\n\tat org.apache.derby.impl.store.access.btree.BTreeForwardScan.fetchRows(BTreeForwardScan.java:464)\r\n\tat org.apache.derby.impl.store.access.btree.BTreeScan.fetchNextGroup(BTreeScan.java:1681)\r\n\tat org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl$KeyComparator.fetchRows(IndexStatisticsDaemonImpl.java:1221)\r\n\tat org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.updateIndexStatsMinion(IndexStatisticsDaemonImpl.java:463)\r\n\tat org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.generateStatistics(IndexStatisticsDaemonImpl.java:323)\r\n\tat org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.processingLoop(IndexStatisticsDaemonImpl.java:794)\r\n\tat org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.run(IndexStatisticsDaemonImpl.java:710)\r\n\tat java.lang.Thread.run(Thread.java:679)\r\n\"main\":\r\n\tat org.apache.derby.impl.store.raw.data.BasePage.releaseExclusive(BasePage.java:1814)\r\n\t- waiting to lock <0x00000000e8c9f980> (a org.apache.derby.impl.store.raw.data.StoredPage)\r\n\tat org.apache.derby.impl.store.raw.data.CachedPage.releaseExclusive(CachedPage.java:531)\r\n\tat org.apache.derby.impl.store.raw.data.StoredPage.releaseExclusive(StoredPage.java:1066)\r\n\tat org.apache.derby.impl.store.raw.data.BasePage.update(BasePage.java:1625)\r\n\tat java.util.Observable.notifyObservers(Observable.java:159)\r\n\tat java.util.Observable.notifyObservers(Observable.java:115)\r\n\tat org.apache.derby.impl.store.raw.data.BaseContainerHandle.informObservers(BaseContainerHandle.java:1008)\r\n\tat org.apache.derby.impl.store.raw.data.BaseContainerHandle.close(BaseContainerHandle.java:414)\r\n\t- locked <0x00000000e83304a8> (a org.apache.derby.impl.store.raw.data.BaseContainerHandle)\r\n\tat org.apache.derby.impl.store.access.btree.OpenBTree.close(OpenBTree.java:490)\r\n\tat org.apache.derby.impl.store.access.btree.BTreeScan.closeForEndTransaction(BTreeScan.java:2021)\r\n\tat org.apache.derby.impl.store.access.btree.index.B2IForwardScan.closeForEndTransaction(B2IForwardScan.java:107)\r\n\tat org.apache.derby.impl.store.access.RAMTransaction.closeControllers(RAMTransaction.java:245)\r\n\tat org.apache.derby.impl.store.access.RAMTransactionContext.cleanupOnError(RAMTransactionContext.java:97)\r\n\tat org.apache.derby.iapi.services.context.ContextManager.cleanupOnError(ContextManager.java:343)\r\n\tat org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.stop(IndexStatisticsDaemonImpl.java:919)\r\n\t- locked <0x00000000e78b35b0> (a java.util.ArrayList)\r\n\tat org.apache.derby.impl.sql.catalog.DataDictionaryImpl.disableIndexStatsRefresher(DataDictionaryImpl.java:13891)\r\n\tat org.apache.derby.impl.db.DatabaseContextImpl.cleanupOnError(DatabaseContextImpl.java:69)\r\n\tat org.apache.derby.iapi.services.context.ContextManager.cleanupOnError(ContextManager.java:343)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.cleanupOnError(TransactionResourceImpl.java:437)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.<init>(EmbedConnection.java:633)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection30.<init>(EmbedConnection30.java:73)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection40.<init>(EmbedConnection40.java:51)\r\n\tat org.apache.derby.jdbc.Driver40.getNewEmbedConnection(Driver40.java:70)\r\n\tat org.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:248)\r\n\tat org.apache.derby.jdbc.EmbeddedDataSource.getConnection(EmbeddedDataSource.java:480)\r\n\tat org.apache.derby.jdbc.EmbeddedDataSource.getConnection(EmbeddedDataSource.java:424)\r\n\tat org.apache.derbyTesting.junit.JDBCDataSource.shutdownDatabase(JDBCDataSource.java:266)\r\n\tat org.apache.derbyTesting.functionTests.tests.store.AutomaticIndexStatisticsTest.testShutdownWhileScanningThenDelete(AutomaticIndexStatisticsTest.java:187)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-10-06T11:54:08.469+0000","updated":"2011-10-06T11:54:08.469+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526018/comment/13123512","id":"13123512","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Attaching patches 1a and 2a, both independently fixing the bug.\r\nPatch 1a makes changes in a core method in BasePage, it introduces a \"custom\" lock pattern, and it cannot guarantee that the monitor obtained last isn't already obtained elsewhere outside of this method (which would nullify the fix).\r\n\r\nPatch 2a makes changes to IndexStatisticsDaemonImpl.stop. It addresses this particular instance of the bug, but not the root cause, by making sure the worker thread has been shut down before starting the context cleanup operation.\r\n\r\nSince no other instances of the bug has been reported so far, I plan to commit patch 2a. It is simpler, and has far less risk associated with it. I further hope to get it into the upcoming 10.8.2. release.\r\n\r\nI will commit 2a as soon as the last regression run has completed. On Monday I hope to backport the fix to the 10.8 branch.\r\n\r\nI'm also rerunning the AutomaticIndexStatisticsTest due to a change in the patch. The previous patch ran the test more than 2200 times without hitting the deadlock. Without the fix, the deadlock is usually occurring in less than 50 iterations of the test (on a specific machine).\r\n\r\nPatch ready for review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-10-08T15:03:52.983+0000","updated":"2011-10-08T15:03:52.983+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526018/comment/13123602","id":"13123602","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Waiting with the context manager cleanup till the daemon thread is done (if any), seems a safe approach to me. +1\r\n\r\nI am not quite sure I understand you concern about patch 1a: if 2a doesn't fix the root cause, does the root cause deserve a new JIRA (as I understand it you are not sure if we have/do not have similar locking patterns elsewhere..)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-10-09T03:03:26.471+0000","updated":"2011-10-09T03:03:26.471+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526018/comment/13123930","id":"13123930","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Committed patch 2a to trunk with revision 1180790. Doing a final run on 10.8 before backporting.\r\nPatch 2a ran AutomaticIndexStatisticsTest nearly 1700 times without errors.\r\n\r\nDag, thanks for looking at the patch.\r\nMy concern with patch 1a is that it places a burden on the caller of releaseExclusive: the caller must ensure that the monitor on 'this' isn't already acquired. This can easily be broken, for instance by making BasePage.unlatch synchronized, or adding a new synchronized method calling releaseExclusive. This may have already been broken, as it's hard to verify. Since BasePage is a very mature piece of code, this would probably not be a problem in practice. On the other hand, I'm sure there are better ways to address the root cause. \r\n\r\nNow that this issue is fixed, I don't know how to provoke the problem. I think it must involve two threads using the Observable API, and an Observer.update-method that acquires the monitor of both the object being observed and the observer and calls back into the object being observed (i.e. typically removeObserver). If my IDE isn't fooling me, there are five other update-methods. A quick check didn't reveal the synchronization issue in those five implementations.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-10-10T07:25:17.556+0000","updated":"2011-10-10T07:25:17.556+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526018/comment/13123939","id":"13123939","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Backported to 10.8 with revision 1180811.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-10-10T07:54:41.976+0000","updated":"2011-10-10T07:54:41.976+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526018/comment/13141061","id":"13141061","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Closing issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-11-01T10:10:48.095+0000","updated":"2011-11-01T10:10:48.095+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5447/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06jlj:"}}
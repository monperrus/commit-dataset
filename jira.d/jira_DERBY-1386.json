{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12344089","self":"https://issues.apache.org/jira/rest/api/latest/issue/12344089","key":"DERBY-1386","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-06-08 18:28:23.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22473","customfield_12310222":"1_*:*_1_*:*_172081000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_2761790000","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-06-10T01:53:59.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1386/watchers","watchCount":0,"isWatching":false},"created":"2006-06-08T02:05:58.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12314377","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12314377","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12332422","key":"DERBY-1231","self":"https://issues.apache.org/jira/rest/api/2/issue/12332422","fields":{"summary":"LIKE does not match empty strings when used with a prepared statement","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-06-30T15:55:48.574+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"After the fix for DERBY-1262 was checked in, I'm noticing that the following query now returns different results.  Prior to the fix for DERBY-1262 the query returned 2 rows; now it doesn't return any rows.\n\ncreate table escTable (c1 char(10));\ninsert into escTable values ('%_\\a');\ninsert into escTable values ('%_b');\ninsert into escTable values ('%c');\ninsert into escTable values ('d');\ninsert into escTable values ('%_\\e');\nselect c1 from escTable where c1 like '\\%\\_\\\\%' ESCAPE '\\';\n\nBefore DERBY-1262, the SELECT returned:\n\nC1\n----------\n%_\\a\n%_\\e\n\n2 rows selected\n\nNow it returns:\n\nC1\n----------\n\n0 rows selected\n\nBrief inspection of the query and data suggest to me that these new results (i.e. no rows) are wrong, and that Derby should in fact return 2 rows/.\n\nBased on comments in DERBY-1262, I'm creating a new Jira issue for the regression since it has been checked into the 10.1 maintenance branch.  I've set the priority to \"Critical\" since this could potentially delay a 10.1.3 release--I.e. I don't think we'd want to release 10.1.3 knowing that we have a wrong results regression.  But if anyone thinks that's not the correct priority, feel free to speak up.\n\nOther option, of course, is to back out the change for DERBY-1262 in 10.1 and then lower the priority accordingly.  \n\nInput/feedback/comments would be appreciated.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10420","value":"Regression","id":"10420"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"38814","summary":"Wrong results with query using LIKE and ESCAPE clause that includes \"%\", \"\\\", and \"_\"","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10102","value":"Patch Available","id":"10102"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":7,"total":7,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12344089/comment/12415196","id":"12415196","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Oops, forgot to change the priority to Critical, per my comments in the description.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-06-08T02:11:57.000+0000","updated":"2006-06-08T02:11:57.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12344089/comment/12415324","id":"12415324","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I see the same results. However, when I use like to test the same values as constants, it correctly evaluates to true:\r\n\r\nij> select * from sysibm.sysdummy1 where '%_\\a' like '\\%\\_\\\\%' escape '\\';\r\nIBM&\r\n----\r\nY   \r\n\r\n1 row selected","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-06-08T18:28:23.000+0000","updated":"2006-06-08T18:28:23.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12344089/comment/12415340","id":"12415340","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"There is a bug in the unoptimized version of\r\nLike.lessThanString(). The bug was not introduced by DERBY-1262, just\r\nexposed by it. I will try to fix it in trunk and 10.1.\r\n\r\nlessThanString() searches for the first occurrence of % or _ in the\r\npattern string, and if the preceding character is an escape character,\r\nit is skipped. This leads to incorrect behaviour when % or _ is\r\npreceded by an escaped escape character.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-06-08T19:29:55.000+0000","updated":"2006-06-08T19:29:55.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12344089/comment/12415547","id":"12415547","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attached a patch (derby-1386-v1.diff) which removes the old, unused\r\nversion of lessThanString (the so-called optimized version) and\r\nrewrites the unoptimized version.\r\n\r\nFirst a description of what lessThanString() is supposed to do\r\n(somewhat simplified):\r\n\r\nWhen an SQL statement is compiled, LIKE expressions are rewritten to\r\nmake them more efficient. For instance,\r\n\r\n  SELECT * FROM T WHERE X LIKE 'abc_ef%'\r\n\r\nis rewritten to\r\n\r\n  SELECT * FROM T WHERE X >= 'abc' AND X < 'abd' AND X LIKE 'abc_ef%'\r\n\r\n(Well, 'abc' and 'abd' will actually be padded with nulls up to the\r\nmax length of X, but you get the point...)\r\n\r\nRewriting the statement like this is done to reduce the number of LIKE\r\ncomparisons (which are more expensive than >= and <) and to make it\r\npossible to use the index.\r\n\r\nThe role of lessThanString() is to generate the string used in the\r\nless than expression ('abd' in the example above). This string is the\r\nsub-string leading up to the first wildcard, but with the last\r\ncharacter incremented by one (and, again, the string is padded with\r\nnulls).\r\n\r\nCurrently, lessThanString() does this:\r\n\r\n  1) Find the first wildcard character, if it is preceded by an escape\r\n     character go to the next wildcard. (The error is in this step,\r\n     because the escape character can be escaped.)\r\n\r\n  2) Take the character right before the first wildcard and increment\r\n     it.\r\n\r\n  3) Build a new string of the pattern string up to the incremented\r\n     character, but without the escape characters.\r\n\r\n  4) Pad the string with nulls and return it.\r\n\r\nWith the patch, it does the following:\r\n\r\n  1) Build a new string based on the pattern string by walking the\r\n     pattern string, skipping escape characters and stopping when the\r\n     first unescaped wildcard is found.\r\n\r\n  2) Increment the last character of the newly built string.\r\n\r\n  3) Pad the string with nulls and return it.\r\n\r\nOther changes in the patch:\r\n\r\n  - the unused version of lessThanString() was removed\r\n\r\n  - some comments about what lessThanString() does were changed since\r\n    the code didn't do what they said\r\n\r\n  - new test cases in lang/dynamicLikeOptimization.sql\r\n\r\n\r\nDerbyall ran without errors on Sun JVM 1.5.0 / Solaris 10 x86.\r\n\r\nReviews would be most appreciated! Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-06-09T20:57:26.000+0000","updated":"2006-06-09T20:57:26.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12344089/comment/12415568","id":"12415568","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"I reviewed this patch and the changes look correct to me.  The old code matches the problem that Knut identified and the new code addresses the issues and does what is described in the previous comment.  I also verified that the repro passes with the patch applied, and that the new test cases fail without the patch and pass with it.\r\n\r\nI haven't run derbyall myself but since Knut ran it and said everything passed, I vote +1 to have this committed.\r\n\r\nThanks again for volunteering to address this, Knut, and for doing it so quickly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-06-09T23:51:49.000+0000","updated":"2006-06-09T23:51:49.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12344089/comment/12415597","id":"12415597","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks Army for reporting the issue and reviewing the patch so quickly that we could make it before the 10.1.3 code freeze.\r\n\r\nI have now run derbyall on 10.1 (Sun JVM 1.5.0, Solaris 10 x86) with two failures. One is T_Diagnosticable, which Andreas just reported that he has seen on Solaris as well, and the other one is testSecMec, which fails because the message text is slightly different from the canon.\r\n\r\nCommitted the patch into trunk with revision 413123 and into 10.1 with revision 413124. I have verified that the example provided by Army returns the correct results on both trunk and 10.1.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-06-10T01:53:59.000+0000","updated":"2006-06-10T01:53:59.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12344089/comment/12420385","id":"12420385","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Fix verified in 10.1 and 10.2, so I'm marking it closed.  Thanks Knut Anders!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-07-12T01:03:49.000+0000","updated":"2006-07-12T01:03:49.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1386/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i070an:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12536170","self":"https://issues.apache.org/jira/rest/api/latest/issue/12536170","key":"DERBY-5552","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314182","id":"12314182","description":"Old head of 10.5 branch","name":"10.5.3.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315370","id":"12315370","description":"Old head of 10.6 branch","name":"10.6.2.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315902","id":"12315902","description":"Head of 10.7 branch as of 2010-11-29","name":"10.7.1.4","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323456","id":"12323456","description":"Third release on the 10.8 branch","name":"10.8.3.0","archived":false,"released":true,"releaseDate":"2012-11-16"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2011-12-22 23:33:37.525","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"221853","customfield_12310222":"1_*:*_1_*:*_5886678665_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-02-28T19:06:14.067+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5552/watchers","watchCount":1,"isWatching":false},"created":"2011-12-22T15:54:55.485+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.png","name":"Blocker","id":"1"},"labels":["derby_triage10_9"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"14.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313142","id":"12313142","description":"","name":"10.3.3.0","archived":false,"released":true,"releaseDate":"2008-05-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313345","id":"12313345","description":"","name":"10.4.2.0","archived":false,"released":true,"releaseDate":"2008-09-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314117","id":"12314117","description":"Next release after 10.5.2.0 release candidate #1","name":"10.5.3.0","archived":false,"released":true,"releaseDate":"2009-08-21"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315343","id":"12315343","description":"Derby 10.6.2.1 Release","name":"10.6.2.1","archived":false,"released":true,"releaseDate":"2010-10-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315564","id":"12315564","description":"First release on the 10.7 branch.","name":"10.7.1.1","archived":false,"released":true,"releaseDate":"2010-12-14"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316362","id":"12316362","description":"First release on the 10.8 branch","name":"10.8.1.2","archived":false,"released":true,"releaseDate":"2011-04-29"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12317968","id":"12317968","description":"second release on the 10.8 branch","name":"10.8.2.2","archived":false,"released":true,"releaseDate":"2011-10-24"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12348695","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12348695","type":{"id":"12310010","name":"Incorporates","inward":"is part of","outward":"incorporates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310010"},"outwardIssue":{"id":"12544462","key":"DERBY-5633","self":"https://issues.apache.org/jira/rest/api/2/issue/12544462","fields":{"summary":"Add tests for state transition and behavior with Lock Timeout in XA Transaction (DERBY-5552 testing task)","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}},{"id":"12346536","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12346536","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12536233","key":"DERBY-5553","self":"https://issues.apache.org/jira/rest/api/2/issue/12536233","fields":{"summary":"System property for client tracing -Dderby.client.traceDirectory does not work with XADataSource","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-11-15T08:15:07.858+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11410","id":"11410","name":"Network Server"}],"timeoriginalestimate":null,"description":"The issue arrives when multiple XA transactions are done in parallel and there is either a lock timeout or a lock deadlock detected.  When this happens the connection is leaked in the Glassfish connection pool and the client thread hangs in \"org.apache.derby.client.netReply.fill(Reply.java:172)\".  \r\n\r\nShutting down the app server fails because the thread has a lock in \"org.apache.derby.client.net.NetConnection40\" and another task is calling \"org.apache.derby.client.ClientPooledConnection.close(ClientPooledConnection.java:214)\" which is waiting for the lock.\r\n\r\nKilling the appsever using \"kill\" and then attempting to shutdown Derby network server causes the Network Server to hang.  One of the threads hangs waiting for a lock at \"org.apache.derby.impl.drda.NeworkServerControlImpl.removeFromSessionTable(NetworkServerControlImpl.java:1525)\" and the \"main\" thread has this locked at \"org.apache.derby.impl.drda.NetworkServerControlImpl.executeWork(NetworkServerControlImpl.java:2242)\" and it itself is waiting for a lock which belongs to a thread that is stuck at \"org.apache.derby.impl.services.locks.ActiveLock.waitForGrant(ActiveLock.java:118) which is in the TIMED_WAITING state.\r\n\r\nOnly by killing the Network Server using \"kill\" is possible at this point.\r\n\r\nThere are transactions left even though all clients have been removed.  \r\n\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10365","value":"Crash","id":"10365"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10421","value":"Seen in production","id":"10421"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"35901","summary":"Derby threads hanging when using ClientXADataSource and a deadlock or lock timeout occurs","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10102","value":"Patch Available","id":"10102"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10424","value":"Repro attached","id":"10424"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Solaris 10, Glassfish V2.1.1,","customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10051","value":"Urgent","id":"10051"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":36,"total":36,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13174860","id":"13174860","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"Derby log file of showing the deadlock reporting and lock timeout reporting","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2011-12-22T15:58:30.495+0000","updated":"2011-12-22T15:58:30.495+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13174865","id":"13174865","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"Client side trace files","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2011-12-22T16:02:15.916+0000","updated":"2011-12-22T16:02:15.916+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13174869","id":"13174869","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"The transactions left over when there is no client connected (other than IJ querying this)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2011-12-22T16:03:05.082+0000","updated":"2011-12-22T16:03:05.082+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13174870","id":"13174870","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"The application server stack trace from jstack when the application server is hung at shutdown.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2011-12-22T16:03:53.828+0000","updated":"2011-12-22T16:03:53.828+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13174871","id":"13174871","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"The Network Server stack trace using jstack when hung at shutdown","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2011-12-22T16:04:53.698+0000","updated":"2011-12-22T16:04:53.698+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13175022","id":"13175022","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"I found one problem.  In BasicNoPutResultImpl.java around line 250 is the code:\r\n\r\n\t\ttry {\r\n\t\t\tLanguageConnectionContext lcc = getLanguageConnectionContext();\r\n\t\t\tif(lcc.getRunTimeStatisticsMode() && lcc.getXplainOnlyMode()) {\r\n\t\t\t\t// do nothing\r\n\t\t\t} else {\r\n\t\t\t\topenCore();\r\n\t\t\t}\r\n\r\n\t\t} catch (StandardException se) {\r\n\t\t\tactivation.checkStatementValidity();\r\n\t\t\tthrow se;\r\n\t\t}\r\n\r\nFor whatever reason (looks like something in my code), a lock timeout is being detected while executing in “openCore” and a StandardException is being thrown with SQLState “40XL2” and a report = 2 (REPORT_ALWAYS I Believe).  The exception is caught and then the \r\n\r\n\tActivation.checkStatementValidity()\r\n\r\nIs being called.  The statement appears not to be valid at that point and a new StandardExceptis thrown with SQLState.LANG_STATEMENT_NEEDS_RECOMPILE and report = REPORT_NEVER.  \r\n\r\nThe effect is that the Lock timeout exception is swallowed and the statement is recompiled and executed again.    This occurs over and over and the loop never ends.     This looks like the cause that the Network Server cannot shutdown in the bug.\r\n\r\nIt seems to me that if the exception being caught above is to be “REPORT_ALWAYS”, then the code should never check the statement validity and should just rethrow the original exception.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2011-12-22T20:10:56.861+0000","updated":"2011-12-22T20:10:56.861+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13175112","id":"13175112","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"I patched the files to look like this and am running my test setup now.  So far so good.  In fact I am not seeing the deadlocks or lock timeouts at all now.   Not sure why but it is all running smoothly with these changes:\r\n\r\n\r\nIndex: BasicNoPutResultSetImpl.java\r\n===================================================================\r\n--- BasicNoPutResultSetImpl.java\t(revision 1222480)\r\n+++ BasicNoPutResultSetImpl.java\t(working copy)\r\n@@ -256,7 +256,9 @@\r\n \t\t\t}\r\n \r\n \t\t} catch (StandardException se) {\r\n-\t\t\tactivation.checkStatementValidity();\r\n+            if (se.report() != StandardException.REPORT_ALWAYS) {\r\n+                activation.checkStatementValidity();\r\n+            }\r\n \t\t\tthrow se;\r\n \t\t}\r\n \r\nIndex: DeleteResultSet.java\r\n===================================================================\r\n--- DeleteResultSet.java\t(revision 1222480)\r\n+++ DeleteResultSet.java\t(working copy)\r\n@@ -201,7 +201,9 @@\r\n         \t\tsource.reopenCore();\r\n \t\t\t}\r\n \t\t} catch (StandardException se) {\r\n-\t\t\tactivation.checkStatementValidity();\r\n+            if (se.report() != se.REPORT_ALWAYS) {\r\n+    \t\t\tactivation.checkStatementValidity();\r\n+            }\r\n \t\t\tthrow se;\r\n \r\n \t\t}\r\nIndex: RowChangerImpl.java\r\n===================================================================\r\n--- RowChangerImpl.java\t(revision 1222480)\r\n+++ RowChangerImpl.java\t(working copy)\r\n@@ -372,7 +372,7 @@\r\n \t\t}\r\n \r\n \t\t} catch (StandardException se) {\r\n-\t\t\tif (activation != null)\r\n+\t\t\tif (se.report() != StandardException.REPORT_ALWAYS && activation != null)\r\n \t\t\t\tactivation.checkStatementValidity();\r\n \t\t\tthrow se;\r\n \t\t}\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2011-12-22T22:28:53.826+0000","updated":"2011-12-22T22:28:53.826+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13175113","id":"13175113","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"Here is the patch that I did to the 10.8 branch.  Basically all I did is to make sure not to swallow the exceptions if the \r\n\r\nStandardException.report() == StandardException.REPORT_ALWAYS\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2011-12-22T22:30:23.035+0000","updated":"2011-12-22T22:30:23.035+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13175151","id":"13175151","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Hi Brett,\r\n\r\nI am glad you are making progress as I was clearly misunderstanding your scenario.\r\n\r\nAlthough the residual xa transactions are there in the database, I looked at the client traces and don't see any indication that XA transactions are being used in the test in fact even the names of the the trace files _driver_? indicate a driver manager connection and not an xa datasource connection which would have been created in files _xads_?. Since there were no XA transactions, there was not the  SYNCCTL with possible missing   SYNCCRD exchanges that I was looking for.\r\n\r\nYour logic on the above change sounds reasonable to me, but I don't think I am the best person to review that change.  After you run tests, post a patch and mark patch available and I am sure the community will review and expedite commit of the change if it is the right thing. I think it would definitely be good to get a test checked in too so we don't regress.\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-12-22T23:33:37.525+0000","updated":"2011-12-22T23:33:37.525+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13175192","id":"13175192","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"I guess I am confused as well Kathey as I had the debugger attached and do see it going through the XA code in Derby on the client side.  The application server is setup with the ClientXADataSource and I do see it calling xa.commit and xa.end for example.   The ClientXADataSource is required otherwise the error:\r\n\r\n\tLocal transaction already has 1 non-XA Resource: cannot add more resources. \r\n\r\noccurs.  So although there is one database (Derby), it is using XA.   The database is being accessed through EJB's and through Eclipselink and also through a custom JCA interface driving Message Driven Beans.  \r\n\r\nFor the test case, I had to limit things to get my sanity.  So I stopped as much access to the database as I could but still trigger the problem.  Eventually I got down to one thread of control being processed by EJB's which do start new transactions.  Even with this one access going on, I hit the lockup issue that I posted.  That is when I found the issue that I mention.  So whether or not this is the real issue, I don't know but when I tried to get as simple a condition as possible, I ran into this.\r\n\r\nThinking now, I don't understand why this would not be hit in a normal case of a lock timeout being thrown. The only thing that I can think of is that the Activation.checkStatementValidity() is seeing the statement as valid and not going to try to recompile it.  Why it occurred in my case where I see the \"isValid\" member set to false, I don't know.  I will try to hitch up the debugger and try to determine the difference so that I can understand it better.\r\n\r\nI do believe that the code should not swallow and exception such as a lock timeout being reported regardless if the statement is no longer reporting to be valid.  This is definitely a condition that will cause an infinite loop of processing.\r\n\r\nAgain, I appreciate the help and your time.  If I gain an understanding of how the condition is triggered, I will look to write a test case for it.  I am reading the Derby testing docs that are relating to use JUnit which I assume is the correct path for newer test cases, correct?\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2011-12-23T00:19:30.493+0000","updated":"2011-12-23T00:19:30.493+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13175216","id":"13175216","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Yes, definitely you want your test to be the new Junit style so that is the place to look.\r\n\r\nI think I have solved the mystery of the missing XA client  traces and filed DERBY-5553 for that issue.\r\n\r\nI am trying to think of a scenario where we we execute a valid statement would get a lock timeout and then at the time of processing the exception the statement would have become invalid.  One reason for a statement becoming invalid would be for instance if a table had been altered, for example if we had a prepared statement \"SELECT * FROM TAB\" and then a column was added or dropped.  In that scenario the statement would be recompiled long before the lock timeout occurred.  If the problem statement is the one with the lock timeout it would seem to be:\r\n\r\n SELECT DISTINCT t3.ID, t3.OPLOCK FROM PKG_9145E10G.PLPM_PAIR t3, PKG_9145E10G.PLPM_CHASSIS_9145E10G_USER t2, CORE_V1.DEVICE_ENTITY_USER t1, CORE_V1.DEVICE_ENTITY t0 WHERE ((t0.ID = CAST (? AS INTEGER )) AND (((t2.PLPM_PAIR_ID = t3.ID) AND ((t2.ID = t1.ID) AND (t1.DTYPE = 'PlpmChassis9145E10GUser'))) AND (t0.ID = t1.DEVICE_ENTITY_ID))) with 1 parameters begin parameter #1: 249360 :end parameter \r\nERROR 40XL2: A lock could not be obtained within the time requested.  The lockTable dump is: \r\nThu Dec 22 07:03:07 PST 2011\r\n\r\n\r\nI am not sure how that could have gone invalid between the initial execution and the lock time out.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-12-23T01:17:32.589+0000","updated":"2011-12-23T01:17:32.589+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13176215","id":"13176215","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"It is the IndexStatisticsDaemonImpl that is invalidating the statement.  To verify this, I got my test case where it was in this loop.  With my printouts I was seeing that the isValid was being set by the thread that was stuck right after the timeout occurred and then I immediately saw makeInvalid being called with action = 40 (UPDATE_STATISTICS).  So I attached the debugger to the database engine and set a breakpoint in IndexStatisticsDaemonImpl  and then set  \"daemonDisabled\" to be \"false\".   Immediately the lock timeout got reported and the loop terminated and my test case continued on the way it should.\r\n\r\nSo the IndexStatisticsDaemonImpl has the ability to invalidate statements in use by other threads.  In this case, it is being invoked right after lock timeout occurs and before the lock timeout exception is being processed.  The code sees that the statement is invalid and swallows the lock exception and sets up to recompile and run the statement again.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2011-12-27T16:11:32.590+0000","updated":"2011-12-27T16:11:32.590+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13176216","id":"13176216","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"If I disable the istat daemon, I still the the timeout but now the error is reported as it should and the transaction is aborted and my code continues.  With the itstat deamon enabled, then the lock timeout is discovered and signaled by exception being thrown but between the time it gets caught and processed, the istat daemon has set the \"isValid\" property of the statement to \"false\".  The original lock timeout exception is caught but then the \r\n\r\n    Activation.checkStatementValidity()\r\n\r\nis called in the exception handler.  This finds that the statement is not valid (isValid == false) and throws its own exception indicating that a recompilation is required, swallowing the original lock timeout exception in the process.  This causes the existing statement to be rebuilt and re-executed but the locks are still present, the lock timeout will occur again, the lock timeout exception will be thrown, the istat daemon will set the \"isValid\" to false again, etc.  The process just continues forever.\r\n\r\nThe patch that I attached to the bug only calls\r\n\r\n    Activation.checkStatementValidity()\r\n\r\nin the exception handler if the caught exception is not set to REPORT_ALWAYS.  This seem okay and to make sense because if the code is handling an exception that is to be REPORT_ALWAYS, there is no sense looking for a statement that is invalid; just report the exception.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2011-12-27T16:11:57.282+0000","updated":"2011-12-27T16:11:57.282+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13177292","id":"13177292","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"I have found the cause of the problem.  When a lock timeout or deadlock is detected, the server calls XATransactionState.cleanupOnError.   This looks like:\r\n\r\n\r\n\tpublic void cleanupOnError(Throwable t) {\r\n\r\n\t\tif (t instanceof StandardException) {\r\n\r\n\t\t\tStandardException se = (StandardException) t;\r\n            \r\n            if (se.getSeverity() >= ExceptionSeverity.SESSION_SEVERITY) {\r\n                popMe();\r\n                return;\r\n            }\r\n\r\n\t\t\tif (se.getSeverity() == ExceptionSeverity.TRANSACTION_SEVERITY) {\r\n\r\n\t\t\t\tsynchronized (this) {\r\n\t\t\t\t\t// disable use of the connection until it is cleaned up.\r\n\t\t\t\t\tconn.setApplicationConnection(null);\r\n\t\t\t\t\tnotifyAll();\r\n\t\t\t\t\tassociationState = TRO_FAIL;\r\n\t\t\t\t\tif (SQLState.DEADLOCK.equals(se.getMessageId()))\r\n\t\t\t\t\t\trollbackOnlyCode = XAException.XA_RBDEADLOCK;\r\n\t\t\t\t\telse if (SQLState.LOCK_TIMEOUT.equals(se.getMessageId()))\r\n\t\t\t\t\t\trollbackOnlyCode = XAException.XA_RBTIMEOUT;\t\t\t\t\t\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\trollbackOnlyCode = XAException.XA_RBOTHER;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\nThe problem is the line of code:\r\n\r\n\t\t\t\t\tconn.setApplicationConnection(null);\r\n\r\nThe problem that occurs is on the client side, when the SQLException is received, it ends up calling Sqlca.getMessage() to retrieve the formatted exception message.  This makes a call back down to the server on the connection and ends up calling EmbedStatement.checkStatus() and now the EmbedConnection has a null \"applicationConnection\" and a noCurrentConnection is throw.   DRDA code that receives this exception in processing of Sqlca.getMessage() determines that there is a protocol error and disconnects from the server.\r\n\r\nThe XA transaction that was in process never has \"end\" called on it and the XA transaction on the client side is now lost.  Derby now has a XA transaction that will never end causing all kinds of havoc such as logging all new transactions in case the one lost ever does get rolled back.  The file system fill up with transaction logs, restarting the database engine takes days, etc.\r\n\r\nI have commented out the above line and now the proper lock error is actually reported at the client.  I don't know if there are any ramifications of doing so at this point however.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2011-12-29T18:02:38.566+0000","updated":"2011-12-29T18:02:38.566+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13178750","id":"13178750","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"This patch makes sure that if a StandardException is set to REPORT_ALWAYS, no check is made to see if the statement is invalid and rebuild; the exception is just thrown.  This stops lock timeouts and deadlocks from being swallowed.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2012-01-03T14:29:43.937+0000","updated":"2012-01-03T14:29:43.937+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13178752","id":"13178752","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"This patch removed the null'ing out of the application connection during cleanup from a lock timeout or lock deadlock.  The application connection is needed because the client code calls back on the connection to retrieve the formatted exception message and if this application connection is null, then a NoCurrentConnection SQLException is thrown during this.  This causes the client to see a DRDA protocol exception and terminate without ever ending an in progress XA transaction.   The XA transaction is now hanging around in the database, the client side has lost track of it, and all manner of things go wrong from that point.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2012-01-03T14:37:08.819+0000","updated":"2012-01-03T14:37:08.819+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13178857","id":"13178857","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I'll work on a test case for this issue and run the patch through regression tests.  I wouldn't  think a lock timeout wouldn't be a transaction level error but a deadlock would be.\r\n\r\n\tif (se.getSeverity() == ExceptionSeverity.TRANSACTION_SEVERITY) {\r\n\r\n\t\t\t\tsynchronized (this) {\r\n\t\t\t\t\t// disable use of the connection until it is cleaned up.\r\n\t\t\t\t\tconn.setApplicationConnection(null);\r\n\r\n\r\nIt makes sense that the connection is needed to retrieve the error message text, but clearly someone at some point thought it was important not to let anything happen on this connection until the transaction was cleaned up.  It would be good to understand the scenarios for which this this code was introduced.\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-01-03T17:49:22.160+0000","updated":"2012-01-03T17:49:22.160+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13178913","id":"13178913","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"I checked the original code and this has been in there since the initial import as far as I can tell from Subversion's history.  \r\n\r\nI also just check the code more.  The cleanup is synchronous (I believe this is true), so that thread of control will not use the connection until it returns. \r\n\r\nAs for other threads, each of the other methods are synchronized on the XATransactionState instance so no other thread will be allowed on the XATransactionState instance while the cleanup is in progress as it also synchronizes on the XATransactionState instance.\r\n\r\nThere are 3 other places where conn.setApplicationConnection(null) is called but all three are in XATransactionState.end(), which again, is synchronized on the XATransactionState instance.  \r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2012-01-03T18:53:34.274+0000","updated":"2012-01-03T18:53:34.274+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13179094","id":"13179094","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"What about getApplicationState which reads applicationConnection? For example, it seems this is called unsynchronized, e.g from EmbedResultSet#movePosition -> checkExecIfClosed -> getEmbedConnection().getApplicationConnection(). If applicationConnection is no nulled, could that break the logic in checkExecIfClosed? There are other cases of calls to getApplicationState which I didn't look at yet.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-01-03T22:44:08.613+0000","updated":"2012-01-03T22:44:08.613+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13179221","id":"13179221","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"I guess where I am coming from is that the cleanup for a lock timeout or deadlock is NOT closing the connection nor should it be.  The connection IS going to be used again right after the cleanup returns the error to retrieve the exception message text.  So nulling out the connection is wrong the way it is.  The other places where the connection is nulled out are when the XA end is being processed.  Now the application level connection is no longer being used because XA has been signaled that there is no more interaction using the connection, so to me this make sense.\r\n\r\nOne thing to remember is that the change is only affecting the XA transactions, not the general usagen.\r\n\r\nAs for the other calls not being synchronized, maybe they should be but I don't know.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2012-01-04T01:51:11.165+0000","updated":"2012-01-04T01:51:11.165+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13179995","id":"13179995","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"The attached reproduction ReproDerby5552LockTimeout.java shows the loss of connection with a lock timeout and resulting protocol error.   It doesn't show the hang, but as I understand it that might be a separate synchronization issue.\r\n$ java ReproDerby5552LockTimeout\r\nWed Jan 04 15:34:10 PST 2012 : Apache Derby Network Server - 10.9.0.0 alpha - (1227344) started and ready to accept conn\r\nections on port 1597\r\nExpected Exception java.sql.SQLTransactionRollbackException: DERBY SQL error: SQLCODE: -1, SQLSTATE: 40XL1, SQLERRMC: 40\r\nXL1\r\nConnection ok. got right value\r\nException in thread \"main\" java.sql.SQLNonTransientConnectionException: A network protocol error was encountered and the\r\n connection has been terminated: the requested command encountered an unarchitected and implementation-specific conditio\r\nn for which there was no architected message (additional information may be available in the derby.log file on the serve\r\nr)\r\n        at org.apache.derby.client.am.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:71)\r\n        at org.apache.derby.client.am.SqlException.getSQLException(SqlException.java:364)\r\n        at org.apache.derby.client.am.Connection.createStatement(Connection.java:379)\r\n        at org.apache.derby.client.am.LogicalConnection.createStatement(LogicalConnection.java:164)\r\n        at ReproDerby5552LockTimeout.checkConn(ReproDerby5552LockTimeout.java:85)\r\n        at ReproDerby5552LockTimeout.main(ReproDerby5552LockTimeout.java:66)\r\nCaused by: org.apache.derby.client.am.SqlException: A network protocol error was encountered and the connection has been\r\n terminated: the requested command encountered an unarchitected and implementation-specific condition for which there wa\r\ns no architected message (additional information may be available in the derby.log file on the server)\r\n        at org.apache.derby.client.am.SqlException.copyAsUnchainedSQLException(SqlException.java:511)\r\n        at org.apache.derby.client.am.Sqlca.chainDeferredExceptionsToAgentOrAsConnectionWarnings(Sqlca.java:346)\r\n        at org.apache.derby.client.am.Sqlca.getJDBCMessage(Sqlca.java:308)\r\n        at org.apache.derby.client.am.SqlException.getMessage(SqlException.java:408)\r\n        at org.apache.derby.client.am.SqlException.getSQLException(SqlException.java:364)\r\n        at org.apache.derby.client.am.Statement.executeQuery(Statement.java:486)\r\n        at ReproDerby5552LockTimeout.main(ReproDerby5552LockTimeout.java:57)\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-01-04T23:49:55.033+0000","updated":"2012-01-04T23:49:55.033+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13180258","id":"13180258","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Tried the repro, I had to replace \"new utilXid\" with XATestUtil.getXid calls, then it worked. FYI, the timeout property is misspelt as \"derby.locks.locktimeout\", I had to change it to \"derby.locks.waitTimeout\", not that it matters, I just was suprprised I had to wait to long (default is 60s) for the timeout to happen. \r\n\r\nInterestingly, if I use EmbeddedXADataSource instead of client ditto, the following call throws:\r\n\r\n     checkConn(conn2);\r\n\r\nagain, due to the error cleanup having nulled out\r\n\"applicationConnection\", cf. in this stack trace the frame\r\nEmbedStatement#getConnection which has this code:\r\n                             \r\n   java.sql.Connection appConn = getEmbedConnection().getApplicationConnection();\r\n\r\n   if ((appConn != applicationConnection) || (appConn == null)) {\r\n      throw Util.noCurrentConnection();\r\n\r\n\r\n---------------------------------------------------------------- repro output\r\nExpected Exception java.sql.SQLTransactionRollbackException: A\r\nlock could not be obtained within the time requested Connection\r\nok. got right value Exception in thread \"main\"\r\njava.sql.SQLNonTransientConnectionException: No current connection.\r\nat\r\norg.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:77)\r\nat org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:142)\r\nat org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:158)\r\nat org.apache.derby.impl.jdbc.Util.noCurrentConnection(Util.java:262)\r\nat\r\norg.apache.derby.impl.jdbc.EmbedStatement.getConnection(EmbedStatement.java:1039)\r\nat\r\norg.apache.derby.iapi.jdbc.BrokeredStatement.controlCheck(BrokeredStatement.java:525)\r\nat\r\norg.apache.derby.iapi.jdbc.BrokeredStatement.getResultSetHoldability(BrokeredStatement.java:469)\r\nat\r\norg.apache.derby.iapi.jdbc.BrokeredStatement.<init>(BrokeredStatement.java:63)\r\nat\r\norg.apache.derby.iapi.jdbc.BrokeredStatement40.<init>(BrokeredStatement40.java:37)\r\nat\r\norg.apache.derby.iapi.jdbc.BrokeredConnection40.newBrokeredStatement(BrokeredConnection40.java:260)\r\nat\r\norg.apache.derby.jdbc.XAStatementControl.<init>(XAStatementControl.java:64)\r\nat\r\norg.apache.derby.jdbc.EmbedXAConnection.wrapStatement(EmbedXAConnection.java:192)\r\nat\r\norg.apache.derby.iapi.jdbc.BrokeredConnection.createStatement(BrokeredConnection.java:100)\r\nat derby5552repro.Derby5552Repro.checkConn(Derby5552Repro.java:96) at\r\nderby5552repro.Derby5552Repro.main(Derby5552Repro.java:76) Caused by:\r\njava.sql.SQLException: No current connection.  at\r\norg.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:42)\r\nat\r\norg.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory40.java:122)\r\nat\r\norg.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:71)\r\n... 14 more Java Result: 1 BUILD SUCCESSFUL (total time: 21 minutes 51\r\nseconds)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-01-05T09:52:51.743+0000","updated":"2012-01-05T09:52:51.743+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13198327","id":"13198327","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Here is Brett's patch with a regression test. I am still not clear on the reason that the application connection was being set to null. There are other instances in the same files where this same approach is used on failure.  The connection seems still perfectly valid for use after the rollback.\r\n\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-02-01T23:37:42.187+0000","updated":"2012-02-01T23:37:42.187+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13204029","id":"13204029","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"reattaching patch to make minor comment correction. I still would like someone more familiar with this area to look and see removing the nulling of the connection is going to cause problems in some scenarios and what those scenarios might be.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-02-08T21:48:41.901+0000","updated":"2012-02-08T21:48:41.901+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13208194","id":"13208194","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"i tried to review the change, but am not familar with the assumptions at this level.  I agree with your concern that previous comment\r\nseems to be indicating it wants to disable the connection.  The comment \"disable use of the connection until it is cleaned up.\", seems\r\nto indicate maybe it meant to reenable it after the work of:\r\n                    notifyAll();\r\n                    associationState = TRO_FAIL;\r\n                    if (SQLState.DEADLOCK.equals(se.getMessageId()))\r\n                        rollbackOnlyCode = XAException.XA_RBDEADLOCK;\r\n                    else if (se.isLockTimeout())\r\n                        rollbackOnlyCode = XAException.XA_RBTIMEOUT;\r\n                    else\r\n                        rollbackOnlyCode = XAException.XA_RBOTHER;\r\n\r\nI reviewed the other comments in the issue, and agree with Brett's analysis of calls to cleanupOnError, and the single thread nature.\r\n\r\nDoes anyone think it worthwhile to null out the connection, perform the above code, and then reset the connection?\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-02-15T02:22:52.858+0000","updated":"2012-02-15T02:22:52.858+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13208434","id":"13208434","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"body":"It would be great to have picked the mind of the author of the comment and code but it appeared this was this way since the beginning.  I don't think it would hurt to do what you suggest but just to let you know, this code is not in production being exercised extensively (private build with this in it as I had a need to fix the problem now) with no issues found.  Just some empirical testing results.\r\n\r\nThanks for taking the time to look at it.\r\n\r\nBrett\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bbergquist","name":"bbergquist","emailAddress":"brett at thebergquistfamily dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Bergquist","active":true},"created":"2012-02-15T12:36:59.012+0000","updated":"2012-02-15T12:36:59.012+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13210477","id":"13210477","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Triage for 10.9. \r\nThis issue is in progress and should be committed soon.\r\n\r\nI think I am going to just double check that subsequent operations on the connection start a new local transaction and that the old global transaction is really dead.  The test confirms we cannot do an XA end but should probably also check the transaction table. If all that checks out I will  check in the change as is.\r\n\r\nThanks Mike and Brett for the input.\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-02-17T19:50:44.329+0000","updated":"2012-02-17T19:50:44.329+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13215046","id":"13215046","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Attached is a new patch derby-5552_withexpanded_test_diff.txt which expands the test to check the state of the connections and the transaction table after the lock timeout.  \r\n\r\nI think most things are working as expected. \r\n\r\n- The transaction (xid2) that was rolled back due the lock timeout  is no longer in the transaction table after the lock time out.\r\n\r\n- New statements on the connection after the lock timeout start a new local transaction.\r\n\r\n - XAResource.end()  on xid2 fails with an RB_TIMEOUT\r\n\r\n- Even though it is not in the transaction table and is holding no locks, xid2  has to be explicitly rolled back before it can be reused.  This is the one I am not sure about. Should this be necessary?\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-02-23T21:01:30.764+0000","updated":"2012-02-23T21:01:30.764+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13215209","id":"13215209","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Running derbyall I see one failure a test specifically for this case expecting no connection.\r\n$ cat xaSimpleNegative.diff\r\n*** Start: xaSimpleNegative jdk1.7.0 derbyall:xa 2012-02-23 14:23:29 ***\r\n202 del\r\n< ERROR 08003: No current connection.\r\n202a202,204\r\n> A         |B\r\n> ----------------------\r\n> ERROR 40XL1: A lock could not be obtained within the time requested\r\nTest Failed.\r\n*** End:   xaSimpleNegative jdk1.7.0 derbyall:xa 2012-02-23 14:23:45 ***\r\n\r\n\r\nSpecifically the master xaSimpleNegative.out shows we were expecting the connection to go away after the lock timeout. It also shows that we expected to be able to  still explicitly rollback the transaction. I think that is not something that would be persistent as the transaction is no longer in the transaction table.\r\n\r\nij(XA)> -- ERROR: deadlock, transaction trashed\r\nselect * from APP.negative;\r\nA         |B          \r\n----------------------\r\nERROR 40XL1: A lock could not be obtained within the time requested\r\nij(XA)> -- ERROR: should have no connection underneath\r\nselect * from APP.negative;\r\nERROR 08003: No current connection.\r\nij(XA)> -- ERROR: should have no connection underneath and xid 2 is gone\r\nxa_end xa_suspend 2;\r\nIJ ERROR: XA_RBTIMEOUT \r\nij(XA)> -- ERROR: should have no connection underneath and xid 2 is gone\r\nxa_end xa_fail 2;\r\nIJ ERROR: XA_RBTIMEOUT \r\nij(XA)> xa_rollback 2;\r\nij(XA)> disconnect;\r\n\r\nSo I am not sure exactly what to think.   Maybe it would be worthwhile to see what other databases do.\r\n\r\nAs an aside in my google research, I noticed I actually asked about this back in 2004!\r\nhttp://mail-archives.apache.org/mod_mbox/db-derby-dev/200411.mbox/%3C4186AA22.7000305@Sourcery.Org%3E\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-02-23T23:45:11.473+0000","updated":"2012-02-23T23:45:11.473+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13216159","id":"13216159","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Well, I tried this out with DB2 and things are interesting and different.  The first thing of note is that the default for DB2 is no lock timeout. I had to go into Control Center and change the database application parameter LOCKTIMEOUT to be something other than -1. \r\n\r\nWith DB2 after the lock timeout DB2 doesn't let you use the connection saying \r\nException trying to check conn2 after lock timeout but before explicit rollback\r\ncom.ibm.db2.jcc.am.SqlException: [jcc][t4][10342][11669][4.12.55] Application must execute a rollback. The unit of w\r\nhas already been rolled back in the database but other resource managers involved in this unit of work might not. To\r\nure integrity of this application, all SQL requests will be rejected until the application issues a rollback.  ERROR\r\n=-4497, SQLSTATE=null\r\n\r\n\r\nThen it won't actually let you do a rollback, but will let you do an end.  If you try rollback it fails with XAER_PROTO but a rollback after end fails with XAER_NOTA if you try to rollback after end. Statements after the end fail with XA_RBTIMEOUT  so I am not sure actually how one could use the connection again.\r\n\r\nBelow is the output and attached is the program I was playing with in case anyone is interested, but I think the main thing I have learned is that since the spec doesn't really offer any guidance on this, we just need to do something reasonable and make sure that the global transaction doesn't get used again except to rollback, which I think the behavior with the patch does effectively as the activity that happens on the connection after the implicit rollback happens in a new local transaction.\r\nSo I will go ahead and check in the latest patch  with the expanded test.\r\n\r\n$ java -Duser=xxxxx  -Dpassword=xxx  ReproDerby5552DB2\r\nGot Expected Lock Timeout Exception DB2 SQL Error: SQLCODE=-911, SQLSTATE=40001, SQLERRMC=68, DRIVER=4.12.55\r\nConnection ok. got right value\r\nException trying to check conn2 after lock timeout but before explicit rollback\r\ncom.ibm.db2.jcc.am.SqlException: [jcc][t4][10342][11669][4.12.55] Application must execute a rollback. The unit of work\r\nhas already been rolled back in the database but other resource managers involved in this unit of work might not. To ens\r\nure integrity of this application, all SQL requests will be rejected until the application issues a rollback.  ERRORCODE\r\n=-4497, SQLSTATE=null\r\n        at com.ibm.db2.jcc.am.hd.a(hd.java:660)\r\n        at com.ibm.db2.jcc.am.hd.a(hd.java:60)\r\n        at com.ibm.db2.jcc.am.hd.a(hd.java:75)\r\n        at com.ibm.db2.jcc.am.o.f(o.java:537)\r\n        at com.ibm.db2.jcc.am.o.a(o.java:495)\r\n        at com.ibm.db2.jcc.am.Sqlca.getJDBCMessage(Sqlca.java:334)\r\n        at com.ibm.db2.jcc.am.SqlExceptionContainer.getMessage(SqlExceptionContainer.java:78)\r\n        at com.ibm.db2.jcc.am.SqlTransactionRollbackException.getMessage(SqlTransactionRollbackException.java:52)\r\n        at ReproDerby5552DB2.main(ReproDerby5552DB2.java:61)\r\nDid not get exception on end as with Derby\r\nGot Exception checking conn2 after end\r\ncom.ibm.db2.jcc.am.SqlException: [jcc][t4][2041][11392][4.12.55] Error executing XAResource.end().  Server returned XA_R\r\nBTIMEOUT. ERRORCODE=-4203, SQLSTATE=null\r\n        at com.ibm.db2.jcc.am.hd.a(hd.java:660)\r\n        at com.ibm.db2.jcc.am.hd.a(hd.java:60)\r\n        at com.ibm.db2.jcc.am.hd.a(hd.java:94)\r\n        at com.ibm.db2.jcc.t4.zb.a(zb.java:2755)\r\n        at com.ibm.db2.jcc.t4.c.Xb(c.java:271)\r\n        at com.ibm.db2.jcc.am.o.g(o.java:340)\r\n        at com.ibm.db2.jcc.t4.a.g(a.java:631)\r\n        at com.ibm.db2.jcc.am.o.a(o.java:214)\r\n        at com.ibm.db2.jcc.am.mn.a(mn.java:3073)\r\n        at com.ibm.db2.jcc.am.mn.a(mn.java:686)\r\n        at com.ibm.db2.jcc.am.mn.executeQuery(mn.java:670)\r\n        at ReproDerby5552DB2.checkConn(ReproDerby5552DB2.java:106)\r\n        at ReproDerby5552DB2.main(ReproDerby5552DB2.java:86)\r\nRolling back xid2\r\nException in thread \"main\" com.ibm.db2.jcc.am.XaException: [jcc][t4][2041][12326][4.12.55] Error executing XAResource.ro\r\nllback().  Server returned XAER_NOTA. ERRORCODE=-4203, SQLSTATE=null\r\n        at com.ibm.db2.jcc.am.hd.c(hd.java:453)\r\n        at com.ibm.db2.jcc.t4.zb.b(zb.java:2773)\r\n        at com.ibm.db2.jcc.t4.ac.b(ac.java:1546)\r\n        at com.ibm.db2.jcc.t4.ac.a(ac.java:1326)\r\n        at com.ibm.db2.jcc.t4.ac.a(ac.java:1321)\r\n        at com.ibm.db2.jcc.t4.ac.rollback(ac.java:1310)\r\n        at ReproDerby5552DB2.main(ReproDerby5552DB2.java:94)\r\n\r\nkmarsden@IBM-JDPM42DBIO2 ~/repro/derby-5552\r\n$\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n$ java ReproDerby5552DB2\r\nGot Expected Lock Timeout Exception DB2 SQL Error: SQLCODE=-911, SQLSTATE=40001, SQLERRMC=6\r\nConnection ok. got right value\r\nException trying to check conn2 after lock timeout but before explicit rollback\r\ncom.ibm.db2.jcc.am.SqlException: [jcc][t4][10342][11669][4.12.55] Application must execute\r\nhas already been rolled back in the database but other resource managers involved in this u\r\nure integrity of this application, all SQL requests will be rejected until the application\r\n=-4497, SQLSTATE=null\r\n        at com.ibm.db2.jcc.am.hd.a(hd.java:660)\r\n        at com.ibm.db2.jcc.am.hd.a(hd.java:60)\r\n        at com.ibm.db2.jcc.am.hd.a(hd.java:75)\r\n        at com.ibm.db2.jcc.am.o.f(o.java:537)\r\n        at com.ibm.db2.jcc.am.o.a(o.java:495)\r\n        at com.ibm.db2.jcc.am.Sqlca.getJDBCMessage(Sqlca.java:334)\r\n        at com.ibm.db2.jcc.am.SqlExceptionContainer.getMessage(SqlExceptionContainer.java:7\r\n        at com.ibm.db2.jcc.am.SqlTransactionRollbackException.getMessage(SqlTransactionRoll\r\n        at ReproDerby5552DB2.main(ReproDerby5552DB2.java:61)\r\nDid not get exception on end as with Derby\r\nRolling back xid2\r\nException in thread \"main\" com.ibm.db2.jcc.am.XaException: [jcc][t4][2041][12326][4.12.55]\r\nllback().  Server returned XAER_NOTA. ERRORCODE=-4203, SQLSTATE=null\r\n        at com.ibm.db2.jcc.am.hd.c(hd.java:453)\r\n        at com.ibm.db2.jcc.t4.zb.b(zb.java:2773)\r\n        at com.ibm.db2.jcc.t4.ac.b(ac.java:1546)\r\n        at com.ibm.db2.jcc.t4.ac.a(ac.java:1326)\r\n        at com.ibm.db2.jcc.t4.ac.a(ac.java:1321)\r\n        at com.ibm.db2.jcc.t4.ac.rollback(ac.java:1310)\r\n        at ReproDerby5552DB2.main(ReproDerby5552DB2.java:86)\r\nCaused by: com.ibm.db2.jcc.am.XaException: [jcc][t4][2041][12326][4.12.55] Error executing\r\nurned XA_RBTIMEOUT. ERRORCODE=-4203, SQLSTATE=null\r\n        at com.ibm.db2.jcc.am.hd.c(hd.java:453)\r\n        at com.ibm.db2.jcc.t4.zb.b(zb.java:2773)\r\n        at com.ibm.db2.jcc.t4.ac.b(ac.java:1520)\r\n        ... 4 more\r\n\r\nkmarsden@IBM-JDPM42DBIO2 ~/repro/derby-5552\r\n$\r\n\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-02-25T00:24:40.721+0000","updated":"2012-02-25T00:24:40.721+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13216171","id":"13216171","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Change fix version to 10.9. Leaving open for backport.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-02-25T00:34:15.858+0000","updated":"2012-02-25T00:34:15.858+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13216174","id":"13216174","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"This issue has always been here. Changing affects version accordingly.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-02-25T00:38:16.266+0000","updated":"2012-02-25T00:38:16.266+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13218468","id":"13218468","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"link to testing task","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-02-28T18:54:40.777+0000","updated":"2012-02-28T18:54:40.777+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13218483","id":"13218483","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I backported the fix and test  to 10.5.   Reassigning to Brett who provided the code patch.\r\nFiled DERBY-5633 for the testing.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-02-28T19:05:13.570+0000","updated":"2012-02-28T19:05:13.570+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13218487","id":"13218487","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Resolving. I only went back as far is 10.5 but it certainly would be appropriate to backport further if needed.\r\n\r\nThanks Brett for tthe fix!\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-02-28T19:06:14.145+0000","updated":"2012-02-28T19:06:14.145+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12536170/comment/13823391","id":"13823391","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"[bulk update: close all resolved issues that haven't had any activity the last year]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-11-15T08:15:07.855+0000","updated":"2013-11-15T08:15:07.855+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5552/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06ibb:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12311724","self":"https://issues.apache.org/jira/rest/api/latest/issue/12311724","key":"DERBY-395","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-01-28 12:15:07.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"21931","customfield_12310222":"1_*:*_1_*:*_18735685000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_2_*:*_9690696000_*|*_4_*:*_1_*:*_68126000","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-05-01T00:05:09.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-395/watchers","watchCount":0,"isWatching":false},"created":"2005-06-28T09:24:49.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10992","id":"10992","name":"10.0.2.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-05-24T04:33:16.000+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11410","id":"11410","name":"Network Server"}],"timeoriginalestimate":null,"description":"Documentation in the Server & Admin guide talks about a \"derby.drda.traceAll\" system property and two trace commands available from the NetworkServerControl API: \"trace on\" and \"trace off\".   The \"trace on\" command is supposed to turn tracing on for all server sessions, unless a specific session number is passed in via the \"-s\" parameter.  Similarly, the \"trace off\" command is supposed to turn tracing off for all server sessions, unless a specific session number is passed in via the \"-s\" parameter.\n\nHowever, I've noticed the following behavior, which appears to be incorrect.\n\n1) if the server is started with derby.drda.traceAll=true, then subsequent attempts to turn tracing off do not work.  For example:\n\n// Start the server with 'traceAll' set to true.\n> java -Dderby.drda.traceAll=true org.apache.derby.drda.NetworkServerControl start\nServer is ready to accept connections on port 1527.\n\n// Try to turn tracing off.\n> java org.apache.derby.drda.NetworkServerControl trace off\nTrace turned off for all sessions.\n\nBut then, despite the message saying that trace was turned off, tracing is still enabled for all connections thereafter: if I connect three more times, I will see a 'ServerX.trace' file for each connection.\n\n2) If the server is started with derby.drda.traceAll=false, then attempts to turn tracing on _only_ affect the connection that enables tracing; tracing will NOT be done for any subsequent connections.  For ex:\n\n// Start the server with 'traceAll' set to false (which is also the default)\n> java -Dderby.drda.traceAll=false org.apache.derby.drda.NetworkServerControl start\nServer is ready to accept connections on port 1527.\n\n// Turn tracing on.\n> java org.apache.derby.drda.NetworkServerControl trace on\nTrace turned on for all sessions.\n\nNow I see a 'ServerX.trace' for the connection that was made to turn tracing on.  However, if I then connect three more times, I will _not_ see any 'ServerX.trace' files for those connections.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40678","summary":"Server-side \"trace on\" and \"trace off\" commands do not appear to be working correctly.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Running Derby Network Server with either JCC or Derby client.","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":7,"total":7,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311724/comment/12364291","id":"12364291","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"I believe that the issue here is that ClientThread.java was mistakenly maintaining its own private cache of the values of the derby.drda.traceDirectory and derby.drda.traceAll settings. The NetworkServerControl commands are properly changing the master values in NetworkServerControlImpl, but since ClientThread.java never re-fetched the updated values, the updates didn't seem to \"take\".\r\n\r\nI don't see any reason why ClientThread.java needs to maintain its own cache of these values, so I think the following change should do the trick. I've successfully tested the bug scenarios using this change and they seem to work well; I'm running derbyall just in case, though I don't think it touches any of these code paths. Assuming it runs clean, I'll attach the diff to this issue.\r\n\r\nIndex: java/drda/org/apache/derby/impl/drda/ClientThread.java\r\n===================================================================\r\n--- java/drda/org/apache/derby/impl/drda/ClientThread.java      (revision 373059)\r\n+++ java/drda/org/apache/derby/impl/drda/ClientThread.java      (working copy)\r\n@@ -30,8 +30,6 @@\r\n        ServerSocket serverSocket;\r\n        private int timeSlice;\r\n        private int connNum;\r\n-       private String traceDir;\r\n-       private boolean traceAll;\r\n\r\n                ClientThread (NetworkServerControlImpl nsi, ServerSocket ss) {\r\n\r\n@@ -42,8 +40,6 @@\r\n                        parent=nsi;\r\n                        serverSocket=ss;\r\n                        timeSlice=nsi.getTimeSlice();\r\n-                       traceDir=parent.getTraceDirectory();\r\n-                       traceAll=parent.getTraceAll();\r\n                }\r\n\r\n                public void run()\r\n@@ -88,7 +84,8 @@\r\n\r\n                                //create a new Session for this session\r\n                                clientSession = new Session(connNum, clientSocket,\r\n-                                       traceDir, traceAll);\r\n+                                       parent.getTraceDirectory(),\r\n+                                       parent.getTraceAll());\r\n\r\n                                //add to Session list\r\n                                parent.addToSessionTable(new Integer(connNum), clientSession);\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-01-28T12:15:07.000+0000","updated":"2006-01-28T12:15:07.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311724/comment/12364318","id":"12364318","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Attached is a proposed fix. derbyall passed. I put a small comment in the code. I didn't add any new tests, which is unfortunate, but I didn't have any brilliant inside about an easy way to add such tests. Testing with the server tracing is already somewhat of a PITA because the server tracing interacts poorly with things like the security manager. Suggestions for clean ways to add some tests here would be appreciated.\r\n\r\nThis is a very low priority bug, but if a committer has some time to check it, that would be great. The repro instructions in the bug description are very clear; it's just a matter of verifying that you can reproduce the problem without the patch, then verifying that the patch resolves the problem for you.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-01-29T01:58:46.000+0000","updated":"2006-01-29T01:58:46.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311724/comment/12364322","id":"12364322","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Bryan,\r\n\r\nI'll look into committing this patch","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-01-29T02:04:26.000+0000","updated":"2006-01-29T02:04:26.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311724/comment/12364362","id":"12364362","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Verified manually that bug ws fixed and checked in.\r\n\r\nDate: Sat Jan 28 21:54:06 2006\r\nNew Revision: 373291\r\n\r\nURL: http://svn.apache.org/viewcvs?rev=373291&view=rev\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-01-29T14:56:02.000+0000","updated":"2006-01-29T14:56:02.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311724/comment/12377127","id":"12377127","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Reopening to merge fix to 10.1","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-04-30T05:09:43.000+0000","updated":"2006-04-30T05:09:43.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311724/comment/12377170","id":"12377170","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Merged the fix from the trunk to the 10.1 branch. The merge was clean and the testing was successful.\r\n\r\nThe change is in revision 398382:\r\nhttp://svn.apache.org/viewcvs?rev=398382&view=rev","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-05-01T00:05:09.000+0000","updated":"2006-05-01T00:05:09.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311724/comment/12413003","id":"12413003","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Verified fix manually and it has been ported to 10.1.  So I'm marking it closed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-05-24T04:33:16.000+0000","updated":"2006-05-24T04:33:16.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-395/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i07bsv:"}}
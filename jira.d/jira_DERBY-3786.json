{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12400637","self":"https://issues.apache.org/jira/rest/api/latest/issue/12400637","key":"DERBY-3786","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313345","id":"12313345","description":"","name":"10.4.2.0","archived":false,"released":true,"releaseDate":"2008-09-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2008-07-21 10:38:15.767","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23844","customfield_12310222":"3_*:*_1_*:*_2719038765_*|*_1_*:*_1_*:*_130508063_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_347949477","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-08-23T07:48:16.059+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3786/watchers","watchCount":0,"isWatching":false},"created":"2008-07-21T08:15:49.231+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12321038","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12321038","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"outwardIssue":{"id":"12329452","key":"DERBY-1053","self":"https://issues.apache.org/jira/rest/api/2/issue/12329452","fields":{"summary":"stress.multi test on ibm142  in SANE builds fails with ASSERTION at org.apache.derby.impl.services.cache.CachedItem.unkeep(CachedItem.java:152)","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-05-04T18:22:25.844+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11415","id":"11415","name":"Services"}],"timeoriginalestimate":null,"description":"When running stress.multi on a machine with 32 hardware execution threads, I observed the following assert failure in two independent runs:\n-----\n2008-07-18 02:15:14.415 GMT Thread[Thread-8,5,workers] (XID = 94699), (SESSIONID = 16923), (DATABASE = mydb), (DRDAID = null), Failed Statement is: insert into a values (1)\norg.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED\n        at org.apache.derby.shared.common.sanity.SanityManager.ASSERT(SanityManager.java:98)\n        at org.apache.derby.impl.services.cache.CacheEntry.unkeepForRemove(CacheEntry.java:217)\n        at org.apache.derby.impl.services.cache.ConcurrentCache.remove(ConcurrentCache.java:446)\n        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.removeStatement(GenericLanguageConnectionContext.java:898)\n        at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.java:516)\n        at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:88)\n        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(GenericLanguageConnectionContext.java:794)\n        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:606)\n        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:555)\n        at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:329)\n        at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:508)\n        at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:350)\n        at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:248)\n        at org.apache.derby.impl.tools.ij.mtTestCase.runMe(mtTestCase.java:246)\n        at org.apache.derby.impl.tools.ij.mtTester.run(mtTester.java:91)\n        at java.lang.Thread.run(Thread.java:619)\nCleanup action completed\n-----\n\n\nIn stress.log:\n-----\nTester8: insert2 Fri Jul 18 04:15:12 CEST 2008\nTester6: TERMINATING due to unexpected error:\nFatalException: XJ001: Java exception: 'ASSERT FAILED: org.apache.derby.shared.common.sanity.AssertFailure'.\nTester1: SELECT2 Fri Jul 18 04:15:13 CEST 2008\nTester8: stopping on request after 820 iterations\nTester10: stopping on request after 859 iterations\nTester1: stopping on request after 847 iterations\nTester7: TERMINATING due to unexpected error:\nFatalException: XJ001: Java exception: 'ASSERT FAILED: org.apache.derby.shared.common.sanity.AssertFailure'.\nTester9: stopping on request after 722 iterations\nTester3: stopping on request after 880 iterations\nTester5: stopping on request after 858 iterations\nTester4: stopping on request after 839 iterations\nWARNING: testers didn't die willingly, so I'm going to kill 'em.\n        This may result in connection resources that aren't cleaned up\n        (e.g. you may see problems in the final script run with deadlocks).\n-----\n\nA few runs on a similar but slightly slower machine didn't experience the same failure, so the bug is likely timing dependent.\nI'll perform some more runs and see how hard it is to reproduce.\n\nI haven't investigated what will happen in an insane build.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39272","summary":"Assert failure in CacheEntry.unkeepForRemove when running stress.multi","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"32 hardware execution threads","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":10,"total":10,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12400637/comment/12615206","id":"12615206","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"It looks like one thread calls ConcurrentCache.remove() while another thread is blocked inside the same method. According to the javadoc for CacheManager.remove(), callers of remove() must synchronize so that no two threads try to remove the same object concurrently:\r\n\r\n\t/**\r\n\t\tDelete and remove an object from the cache. It is up to the user of the cache\r\n\t\tto provide synchronization of some form that ensures that only one caller\r\n\t\texecutes remove() on a cached object.\r\n\t\t<BR>","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-07-21T10:38:15.767+0000","updated":"2008-07-21T10:38:15.767+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12400637/comment/12615591","id":"12615591","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attaching code that reproduces the assert failure on my machine (dual core). It creates a table without committing in one transaction and starts 100 threads that prepare a query against that table in other transactions. The preparing of the query fails with a timeout exception, which leads to GenericLanguageConnectionContext.removeStatement() and CacheManager.remove() being called, and there seems to be a race condition between the threads that time out at approximately the same time.\r\n\r\nI also tried to run it on trunk in insane mode. Then the assert error didn't occur, of course, but more and more threads became idle, until all the threads were blocked.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-07-22T11:52:25.434+0000","updated":"2008-07-22T11:52:25.434+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12400637/comment/12615592","id":"12615592","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Tried the repro with JDK 1.4 to see if we get the same behaviour with the old cache manager (Clock) as with the new one (ConcurrentCache). I then got this assert failure:\r\n\r\njava.sql.SQLException: Java exception: 'ASSERT FAILED: org.apache.derby.shared.common.sanity.AssertFailure'.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)\r\n        at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:87)\r\n        at org.apache.derby.impl.jdbc.Util.javaException(Util.java:244)\r\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:403)\r\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:346)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2192)\r\n        at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:81)\r\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.<init>(EmbedPreparedStatement.java:146)\r\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement20.<init>(EmbedPreparedStatement20.java:82)\r\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement30.<init>(EmbedPreparedStatement30.java:63)\r\n        at org.apache.derby.jdbc.Driver30.newEmbedPreparedStatement(Driver30.java:99)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.prepareStatement(EmbedConnection.java:1533)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.prepareStatement(EmbedConnection.java:1361)\r\n        at d3786$1.run_(d3786.java:26)\r\n        at d3786$1.run(d3786.java:15)\r\n        at java.lang.Thread.run(Thread.java:534)\r\nCaused by: org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED\r\n        at org.apache.derby.shared.common.sanity.SanityManager.ASSERT(SanityManager.java:98)\r\n        at org.apache.derby.impl.services.cache.CachedItem.unkeep(CachedItem.java:144)\r\n        at org.apache.derby.impl.services.cache.Clock.remove(Clock.java:603)\r\n        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.removeStatement(GenericLanguageConnectionContext.java:898)\r\n        at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.java:516)\r\n        at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:88)\r\n        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(GenericLanguageConnectionContext.java:794)\r\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.<init>(EmbedPreparedStatement.java:128)\r\n        ... 8 more\r\n\r\n\r\nThe failing assert is this one in CachedItem.unkeep():\r\n\r\n\t\tif (SanityManager.DEBUG) {\r\n\t\t\tSanityManager.ASSERT(keepCount >= 0);\r\n\t\t}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-07-22T11:56:40.517+0000","updated":"2008-07-22T11:56:40.517+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12400637/comment/12615596","id":"12615596","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Looking at the stack trace from JDK 1.4, I think this issue is the same as DERBY-1053.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-07-22T12:02:34.242+0000","updated":"2008-07-22T12:02:34.242+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12400637/comment/12615643","id":"12615643","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The code that calls removeStatement() uses a synchronized flag and\r\nwait()+notifyAll() to prevent multiple threads from recompiling the\r\nsame statement concurrently. The code synchronizes on the\r\nGenericPreparedStatement instance that is being compiled. What\r\nhappens, is basically:\r\n\r\n  1. fetch the prepared statement from the statement cache, possibly\r\n  creating a new one if it isn't in the cache\r\n\r\n  2. release the statement (which means others can removed it from the\r\n  cache)\r\n\r\n  3. if someone else is recompiling the prepared statement, wait until\r\n  they have finished\r\n\r\n  4. recompile the statement and block others until finished\r\n\r\n  5. if an error happens during recompile\r\n\r\n    a) check if it exists in the cache\r\n\r\n    b) if it is in the cache, remove it\r\n\r\nIf two threads do this concurrently, they'll both get a reference to\r\nthe same prepared statement in the cache in step (1). Then one of the\r\nthreads is allowed to recompile the statement, whereas the other\r\nthread is blocked in (3). In the repro, the thread that is recompiling\r\nthe statement fails with a lock timeout, so it removes the statement\r\nfrom the cache. The other thread is allowed to continue, and also\r\nfails while recompiling. The statement is no longer in the cache, so\r\nit doesn't try to remove it, and everything is fine.\r\n\r\nNow, consider the possibility that a third thread tries to prepare the\r\nsame SQL text right after the first thread has removed the prepared\r\nstatement from the cache. This means that thread 3 doesn't find the\r\nstatement in the cache and therefore creates a new prepared\r\nstatement. Since this is another instance of GenericPreparedStatement\r\nthan the one thread 1 and thread 2 are working on, thread 3 won't\r\ndetect that others are recompiling the same statement.\r\n\r\nIf the compilation succeeds, it is no problem that two different\r\nGenericPreparedStatement instances are used for the same SQL\r\ntext. However, since also the third thread fails while compiling the\r\nstatement, and it is not synchronized with the second thread since\r\nthey don't have the same prepared statement, thread 2 and thread 3 may\r\nend up calling removeStatement() concurrently. Although their prepared\r\nstatements are different, they'll have the same key in the statement\r\ncache, so now thread 2 will find that the statement in fact is in the\r\ncache and try to remove it. Thread 3 also finds it in the cache and\r\ninvokes CacheManager.remove() at the same time. This breaks the\r\ncontract of CacheManager.remove(), and bad things start happening\r\n(assert failures and hangs).\r\n\r\nI think there are two ways to fix this:\r\n\r\n  1) In GenericLanguageConnectionContext.removeStatement(), only call\r\n  remove() if the prepared statement in the cache is exactly the same\r\n  as the prepared statement we tried to recompile. The patch\r\n  remove.diff shows this approach. I haven't run the regression tests,\r\n  but it seems to fix this problem (I don't see assert failures or\r\n  hangs with the repro anymore).\r\n\r\n  2) It may also be possible to fix it by not releasing the statement\r\n  in step (2). Then it's not possible to remove the statement from the\r\n  cache until it has been recompiled, and all the threads that try to\r\n  recompile it are guaranteed to work on the same\r\n  GenericPreparedStatement instance. Some extra logic would be needed\r\n  to prevent deadlocks, as the call to remove() would block until no\r\n  one holds that statement, and every other thread that is waiting to\r\n  recompile the same statement will be holding it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-07-22T15:17:42.278+0000","updated":"2008-07-22T15:17:42.278+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12400637/comment/12615778","id":"12615778","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Derbyall and suites.All ran cleanly with remove.diff, so unless there are any objections to the approach, I'll create a new patch with some comments added that we can consider for commit.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-07-22T20:30:04.843+0000","updated":"2008-07-22T20:30:04.843+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12400637/comment/12624121","id":"12624121","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Here's a new version of the patch with comments added. Derbyall and suites.All still run cleanly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-08-20T20:17:40.130+0000","updated":"2008-08-20T20:17:40.130+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12400637/comment/12624627","id":"12624627","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Committed revision 688027.\r\n\r\nSince this is also a problem in older versions, I'm leaving the issue open until the fix has been back-ported to the 10.4 branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-08-22T08:58:15.637+0000","updated":"2008-08-22T08:58:15.637+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12400637/comment/12625030","id":"12625030","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Merged to 10.4 with revision 688275.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-08-23T07:48:15.953+0000","updated":"2008-08-23T07:48:15.953+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12400637/comment/12626000","id":"12626000","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"I ran stress.multi successfully 80 times on the same machine where I first saw this problem.  I also ran the repro (d3786) for a while withouth failures. Thanks for the fix, Knut Anders.\r\n\r\nI'm closing this issue and the duplicate.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-08-27T08:27:25.448+0000","updated":"2008-08-27T08:27:25.448+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3786/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0734f:"}}
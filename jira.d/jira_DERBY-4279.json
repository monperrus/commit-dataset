{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12428429","self":"https://issues.apache.org/jira/rest/api/latest/issue/12428429","key":"DERBY-4279","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323456","id":"12323456","description":"Third release on the 10.8 branch","name":"10.8.3.0","archived":false,"released":true,"releaseDate":"2012-11-16"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323562","id":"12323562","description":"Head of 10.9 branch after releasing 10.9.1.0","name":"10.9.2.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321550","id":"12321550","description":"First release on the 10.10 branch","name":"10.10.1.1","archived":false,"released":true,"releaseDate":"2013-04-15"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-07-03 15:42:25.508","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24151","customfield_12310222":"3_*:*_1_*:*_68888590102_*|*_1_*:*_1_*:*_30762812122_*|*_5_*:*_2_*:*_2338233057_*|*_4_*:*_1_*:*_25967121","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-09-12T17:09:39.746+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4279/watchers","watchCount":8,"isWatching":false},"created":"2009-06-19T23:29:37.378+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":["derby_triage10_5_2"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10991","id":"10991","description":"snapshot","name":"10.0.2.1","archived":false,"released":true,"releaseDate":"2004-12-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313142","id":"12313142","description":"","name":"10.3.3.0","archived":false,"released":true,"releaseDate":"2008-05-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313345","id":"12313345","description":"","name":"10.4.2.0","archived":false,"released":true,"releaseDate":"2008-09-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316362","id":"12316362","description":"First release on the 10.8 branch","name":"10.8.1.2","archived":false,"released":true,"releaseDate":"2011-04-29"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12351753","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12351753","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12552109","key":"DERBY-5703","self":"https://issues.apache.org/jira/rest/api/2/issue/12552109","fields":{"summary":"Threads are stuck in ActiveLock.waitForGrant","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12333292","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12333292","type":{"id":"12310010","name":"Incorporates","inward":"is part of","outward":"incorporates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310010"},"outwardIssue":{"id":"12468091","key":"DERBY-4721","self":"https://issues.apache.org/jira/rest/api/2/issue/12468091","fields":{"summary":"NullPointerException on StressMultiTest in language layer","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-09-03T08:31:36.198+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"Due to a design flaw in the statement cache, a deadlock can occur if a prepared statement becomes out-of-date.\r\n\r\nI will illustrate this with the following example:\r\n\r\nThe application is using the embedded Derby driver. The application has two threads, and each thread uses its own connection.\r\n\r\nThere is a table named MYTABLE with column MYCOLUMN.\r\n\r\n1. A thread prepares and executes the query SELECT MYCOLUMN FROM MYTABLE. The prepared statement is stored in the statement cache (see org.apache.derby.impl.sql.GenericStatement for this logic)\r\n2. After some time, the prepared statement becomes invalid or out-of-date for some reason (see org.apache.derby.impl.sql.GenericPreparedStatement)\r\n3. Thread 1 begins a transaction and executes LOCK TABLE MYTABLE IN EXCLUSIVE MODE\r\n4. Thread 2 begins a transaction and executes SELECT MYCOLUMN FROM MYTABLE. The statement is in the statement cache but it is out-of-date. The thread begins to recompile the statement. To compile the statement, the thread needs a shared lock on MYTABLE. Thread 1 already has an exclusive lock on MYTABLE. Thread 2 waits.\r\n5. Thread 1 executes SELECT MYCOLUMN FROM MYTABLE. The statement is in the statement cache but it is being compiled. Thread 1 waits on the statement's monitor.\r\n6. We have a deadlock. Derby eventually detects a lock timeout, but the error message is not descriptive. The stacks at the time of the deadlock are:\r\n\r\nThis deadlock is unique because it can still occur in a properly designed database. You are only safe if all of your transactions are very simple and cannot be interleaved in a sequence that causes the deadlock, or if your particular statements do not require a table lock to compile. (For the sake of simplicity, I used LOCK TABLE in my example, but any UPDATE statement would fit.)","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10421","value":"Seen in production","id":"10421"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"35455","summary":"Statement cache deadlock","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stuckman","name":"stuckman","emailAddress":"stuckman at umd dot edu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Stuckman","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10424","value":"Repro attached","id":"10424"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stuckman","name":"stuckman","emailAddress":"stuckman at umd dot edu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Stuckman","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Windows Vista, OS X 10.5+","customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":69,"total":69,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12722088","id":"12722088","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stuckman","name":"stuckman","emailAddress":"stuckman at umd dot edu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Stuckman","active":true},"body":"Output from test case:\r\n\r\nInvalidating the prepared statements...\r\nTable locked.\r\nExecuting query 1. Query should block because other thread has lock.\r\nExecuting query 2. Query should not block because this thread already has the necessary locks.\r\njava.sql.SQLTransactionRollbackException: A lock could not be obtained within the time requested\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.Util.generateCsSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeQuery(Unknown Source)\r\n\tat Derby4279$Thread2.run(Derby4279.java:81)\r\n\tat java.lang.Thread.run(Thread.java:619)\r\nCaused by: java.sql.SQLException: A lock could not be obtained within the time requested\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(Unknown Source)\r\n\t... 11 more\r\nCaused by: ERROR 40XL1: A lock could not be obtained within the time requested\r\n\tat org.apache.derby.iapi.error.StandardException.newException(Unknown Source)\r\n\tat org.apache.derby.impl.services.locks.ConcurrentLockSet.lockObject(Unknown Source)\r\n\tat org.apache.derby.impl.services.locks.AbstractPool.lockObject(Unknown Source)\r\n\tat org.apache.derby.impl.services.locks.ConcurrentPool.lockObject(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.xact.RowLocking2.lockContainer(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.data.BaseContainerHandle.useContainer(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.data.BaseDataFileFactory.openContainer(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.data.BaseDataFileFactory.openContainer(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.openContainer(Unknown Source)\r\n\tat org.apache.derby.impl.store.access.conglomerate.OpenConglomerate.init(Unknown Source)\r\n\tat org.apache.derby.impl.store.access.heap.Heap.open(Unknown Source)\r\n\tat org.apache.derby.impl.store.access.RAMTransaction.openConglomerate(Unknown Source)\r\n\tat org.apache.derby.impl.store.access.RAMTransaction.openConglomerate(Unknown Source)\r\n\tat org.apache.derby.impl.sql.compile.ResultColumnList.generateHolderMethod(Unknown Source)\r\n\tat org.apache.derby.impl.sql.compile.FromBaseTable.getScanArguments(Unknown Source)\r\n\tat org.apache.derby.impl.sql.compile.FromBaseTable.generateResultSet(Unknown Source)\r\n\tat org.apache.derby.impl.sql.compile.FromBaseTable.generate(Unknown Source)\r\n\tat org.apache.derby.impl.sql.compile.IndexToBaseRowNode.generate(Unknown Source)\r\n\tat org.apache.derby.impl.sql.compile.ProjectRestrictNode.generateMinion(Unknown Source)\r\n\tat org.apache.derby.impl.sql.compile.ProjectRestrictNode.generate(Unknown Source)\r\n\tat org.apache.derby.impl.sql.compile.ProjectRestrictNode.generateMinion(Unknown Source)\r\n\tat org.apache.derby.impl.sql.compile.ProjectRestrictNode.generate(Unknown Source)\r\n\tat org.apache.derby.impl.sql.compile.ScrollInsensitiveResultSetNode.generate(Unknown Source)\r\n\tat org.apache.derby.impl.sql.compile.CursorNode.generate(Unknown Source)\r\n\tat org.apache.derby.impl.sql.compile.StatementNode.generate(Unknown Source)\r\n\tat org.apache.derby.impl.sql.GenericStatement.prepMinion(Unknown Source)\r\n\tat org.apache.derby.impl.sql.GenericStatement.prepare(Unknown Source)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.rePrepare(Unknown Source)\r\n\t... 5 more\r\nQuery 2 finished.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stuckman","name":"stuckman","emailAddress":"stuckman at umd dot edu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Stuckman","active":true},"created":"2009-06-19T23:32:48.873+0000","updated":"2009-06-19T23:32:48.873+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12722089","id":"12722089","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stuckman","name":"stuckman","emailAddress":"stuckman at umd dot edu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Stuckman","active":true},"body":"Test case","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stuckman","name":"stuckman","emailAddress":"stuckman at umd dot edu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Stuckman","active":true},"created":"2009-06-19T23:35:28.225+0000","updated":"2009-06-19T23:35:28.225+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12722093","id":"12722093","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stuckman","name":"stuckman","emailAddress":"stuckman at umd dot edu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Stuckman","active":true},"body":"One workaround is to set derby.language.statementCacheSize=0. However, the impact of setting this property may be unclear to users because it is not documented. (DERBY-4280)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stuckman","name":"stuckman","emailAddress":"stuckman at umd dot edu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Stuckman","active":true},"created":"2009-06-19T23:43:06.994+0000","updated":"2009-06-19T23:43:06.994+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12727011","id":"12727011","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Triaged for 10.5.2, checking \"repro attached\", setting \"normal\" urgency.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2009-07-03T15:42:25.508+0000","updated":"2009-07-03T15:42:25.508+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12727015","id":"12727015","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Seen back to 10.0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2009-07-03T15:54:19.839+0000","updated":"2009-07-03T15:54:19.839+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12877328","id":"12877328","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"This defect is a major issue for my company and product.  I am submitting a patch to address this defect.  The attached patch is against the 10.6 branch, but I would expect it to equally apply to the trunk.  The description in the initial report by Jeff Stuckman is accurate, please read it before studying the patch.\r\n\r\nLet me explain the patch, and the rationale behind it.  Some familiarity with the code in question is assumed.  Four files where touched:\r\n\r\norg.apache.derby.iapi.sql.PreparedStatement\r\norg.apache.derby.impl.sql.GenericStatement\r\norg.apache.derby.impl.sql.GenericActivationHolder\r\norg.apache.derby.impl.sql.GenericPreparedStatement\r\n\r\nBasically the previous code did this:\r\n\r\n   Block Thread B if it tries to recompile a statement that is being recompiled by Thread A\r\n\r\nThis would result in deadlock if Thread A needs the exclusive (DB) lock held by thread B.\r\n\r\nBasically the new code does this:\r\n\r\n   When Thread B tries to recompile a statement AND that statement is currently being recompiled (by another thread), don't block, simply create a new GenericPreparedStatement and compile that instead.  In essence, this is treated like a \"cache miss\".\r\n\r\nAt the GenericStatement level, there is no way to know what Storage level locks are being held.  Therefore, blocking Thread B (via a Java lock) while awaiting notification by a thread (Thread A) that might itself be waiting on a Storage level lock held by Thread B is bound to lead to deadlocks in this, and possibly other, scenarios.\r\n\r\nThis patch foregoes some [extremely] minor cache efficiencies by treating concurrent recompilation of a statement as a cache miss.  Recompilation by a single thread is not treated as a cache miss, and the code flow is unchanged in that case.  Unless a statement undergoes constant concurrent recompilation (defeating the statement cache anyway), I would expect this change to have an almost immeasurable performance impact on applications.  Certainly compared to the workaround of disabling the statement cache, well, there is no comparison.\r\n\r\nWhen studying this patch, I recommend reading in this order for clarity:\r\n\r\n1. PreparedStatement\r\n2. GenericPreparedStatement\r\n3. GenericActivationHolder\r\n4. GenericStatement\r\n\r\nPreparedStatement:\r\n   The interface was changed so that rePrepare() might return a new statement.\r\n\r\nGenericPreparedStatement:\r\n   In the \"rePrepare()\" implementation, account for the fact that a new statement may be returned.\r\n\r\nGenericActivationHolder:\r\n   In execute(), when a PreparedStatement is recognized as invalid and therefore rePrepare()'d, accept the re-prepared statement and use it.  99% of the time, the returned statement will be the same statement as the original.  But in the case of a concurrent re-preparation, a new statement will be returned.\r\n\r\nGenericStatement:\r\n   in prepMinion(), when we realize were in a \"concurrent re-compile\" situation, rather than block waiting for the \"other thread\" to complete recompiling the cached statement, simply create a new GenericPreparedStatement() and compile it instead.  This is where the rubber meets the road, and the deadlock is avoided.\r\n\r\nI ran the 'derbyall' test suite, and while I did receive two failures, they seem unrelated to this fix and have more to do with my environment.  I would appreciate someone reviewing the patch, applying it to their system (with a known passing test suite), and running it through a regression test pass.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-10T05:43:42.914+0000","updated":"2010-06-10T05:43:42.914+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12877329","id":"12877329","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Proposed patch for 4279.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-10T05:45:21.878+0000","updated":"2010-06-10T05:45:21.878+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12877365","id":"12877365","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Just a further comment.  We see this in a client/server setup.  The original bug mentions the Embedded driver, but because this code in common between the network server and the embedded driver, the issue is the same.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-10T08:06:12.817+0000","updated":"2010-06-10T08:06:12.817+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12877407","id":"12877407","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Hi Brett,\r\n\r\nI had a quick look at your patch, applied it and ran it through suites.All. I see the following error(s):\r\n\r\ntestStressMulti(org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest) FAILURE:\r\njunit.framework.AssertionFailedError: Caused by: \r\njava.sql.SQLException: Java exception: ': java.lang.NullPointerException'.\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:95)\r\n\tat org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:142)\r\n\tat org.apache.derby.impl.jdbc.Util.javaException(Util.java:299)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:403)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:346)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2269)\r\n\tat org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:81)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1321)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:625)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeQuery(EmbedStatement.java:152)\r\n\tat org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest$StressMultiRunnable.select(StressMultiTest.java:555)\r\n\tat org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest$StressMultiRunnable.run(StressMultiTest.java:429)\r\n\tat java.lang.Thread.run(Thread.java:619)\r\nCaused by: java.sql.SQLException: Java exception: ': java.lang.NullPointerException'.\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory40.java:119)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:70)\r\n\t... 12 more\r\nCaused by: java.lang.NullPointerException\r\n\tat org.apache.derby.impl.sql.GenericActivationHolder.execute(GenericActivationHolder.java:298)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:437)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:320)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1232)\r\n\t... 5 more\r\n\r\n\tat org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest.handleException(StressMultiTest.java:351)\r\n\tat org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest.access$200(StressMultiTest.java:70)\r\n\tat org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest$StressMultiRunnable.run(StressMultiTest.java:445)\r\n\tat java.lang.Thread.run(Thread.java:619)\r\n\r\ntestStressMulti(org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest) FAILURE:\r\njunit.framework.AssertionFailedError: Caused by: \r\njava.sql.SQLException: Java exception: ': java.lang.NullPointerException'.\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:95)\r\n\tat org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:142)\r\n\tat org.apache.derby.impl.jdbc.Util.javaException(Util.java:299)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:403)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:346)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2269)\r\n\tat org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:81)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1321)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:625)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeQuery(EmbedStatement.java:152)\r\n\tat org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest$StressMultiRunnable.select(StressMultiTest.java:555)\r\n\tat org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest$StressMultiRunnable.run(StressMultiTest.java:429)\r\n\tat java.lang.Thread.run(Thread.java:619)\r\nCaused by: java.sql.SQLException: Java exception: ': java.lang.NullPointerException'.\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory40.java:119)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:70)\r\n\t... 12 more\r\nCaused by: java.lang.NullPointerException\r\n\tat org.apache.derby.impl.sql.GenericActivationHolder.execute(GenericActivationHolder.java:298)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:437)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:320)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1232)\r\n\t... 5 more\r\n\r\n\tat org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest.handleException(StressMultiTest.java:351)\r\n\tat org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest.access$200(StressMultiTest.java:70)\r\n\tat org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest$StressMultiRunnable.run(StressMultiTest.java:445)\r\n\tat java.lang.Thread.run(Thread.java:619)\r\n\r\nI haven't had the time to investigate this further, others should definitely do so if they think they can contribute :)\r\nA first step would be to verify this error (running the multi.StressMultiTest).\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2010-06-10T12:43:09.425+0000","updated":"2010-06-10T12:43:09.425+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12877682","id":"12877682","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Thanks for the feedback.  Typo in my patch.  In GenericActivationHolder.java I had:\r\n\r\nnewPS = (ExecPreparedStatement) ps.rePrepare...\r\nnewGC = ps.getActivationClass();\r\n\r\nWhen I meant:\r\n\r\nnewPS = (ExecPreparedStatement) ps.rePrepare...\r\nnewGC = newPS.getActivationClass();\r\n\r\nI've run the multi stress suite, and it now passes without error.  I have updated the patch.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-11T01:28:02.821+0000","updated":"2010-06-11T01:28:02.821+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12877683","id":"12877683","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Updated patch file (10.6 base)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-11T01:29:33.486+0000","updated":"2010-06-11T01:29:33.486+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12877761","id":"12877761","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Hi Brett,\r\n\r\nThanks for contributing the patch. I think creating a new statement instead of waiting sounds like a reasonable approach to solve this bug.\r\n\r\nI have a couple of questions about the patch:\r\n\r\n1) The synchronized block in GenericActivationHolder.execute() is expanded. What's the reasoning behind this change?\r\n\r\n2) In GenericStatement, I noticed that the old code that generates a new statement if the session schema is references, sets foundInCache to false to prevent the call to removeStatement() in catch blocks further down. Should we do the same in the new code that checks the value of compilingStatement? I'm not sure if calling removeStatement() on a statement that's not in the cache does any harm, but I thought I'd mention it in any case.\r\n\r\n3) Since the patch removes the call to wait() on the prepared statement (the only call to wait() as far as I can tell), do you think it would be safe to also remove the calls to notifyAll() in GenericStatement and GenericPreparedStatement?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2010-06-11T09:51:25.971+0000","updated":"2010-06-11T09:51:25.971+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12877821","id":"12877821","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Hi Knut, thanks for taking a look.\r\n\r\n1) The synchronized block in GenericActivationHolder.execute() was actually completely commented out in the original -- but the comment regarding the synchronized block remained.  I'm actually unsure if there is indeed multi-threaded access to GenericActivationHolder -- but I believe there can be.  Because that method replaces several member variables, it seems unsafe to do so outside of the context of a synchronized block.  So, basically I just restored the synchronized block.  If it can be shown that there is no multi-threaded access -- for example because of a lock higher up the call chain, we can certainly remove it.  But being unfamiliar with the Derby codebase in general, I decided to err on the side of caution.\r\n\r\n2) My thinking on removing the statement from the cache was that the new statement is an equal candidate to be cached, and because it was just recompiled the one that does exist in the cache is stale in a sense.\r\n\r\n3) I thought that too.  I think it would indeed be safe to remove to calls to notifyAll(), at least in the case of GenericStatement.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-11T14:35:23.570+0000","updated":"2010-06-11T14:35:23.570+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12877841","id":"12877841","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"+1 to the strategy of the patch. I think the approach of allowing each caller to prepare\r\nthe statement independently is valid and useful. In this age of multi-core computing,\r\nI think doing possibly extra work like this in search of higher concurrency (and fewer\r\ndeadlocks) is a good technique.\r\n\r\nI, too, was worried about the patch's modifications to the synchronized() blocks, so\r\nI'd like to see that discussion resolved prior to commit.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2010-06-11T15:59:17.806+0000","updated":"2010-06-11T15:59:17.806+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12878516","id":"12878516","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"There's a smaller synchronized block within the block where the synchronization is commented out (both synchronized on ps). The inner synchronization was added to address DERBY-3260. The question was raised at that time too, why the synchronization had been commented out in the first place. Since we didn't know why, we went for the minimum needed to fix that bug. Unless there's some change in the patch that makes it necessary to synchronize on the entire block, I'd be more comfortable with leaving the synchronization as it is for now. It's not that I'm 100% convinced the current approach is correct, but if we find problems there, we could address them in a separate issue.\r\n\r\nAs to multi-threaded access to GenericActivationHolders, I don't think that will happen. I believe GenericActivationHolder instances are private to a transaction, and concurrent access will be prevented by synchronization at a higher level. The instance stored in the ps field can however be shared by multiple GenericActivationHolders, and the synchronization is there to give a consistent view of that object's state.\r\n\r\nAnother thing that makes me think we should be careful with adding synchronization here, is that it adds to the problem reported in DERBY-3024. I did a few runs on a 32-core machine with the test client attached there, and saw a 10-30% performance degradation for various multi-threaded configurations when the patch was applied.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2010-06-14T09:41:21.160+0000","updated":"2010-06-14T09:41:21.160+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12878726","id":"12878726","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"The synchronization was commented out before the code was open sourced.  The change was part of a fix for a java monitor deadlock while running a stress test.  Unfortunately the stress test is no longer available and will not run against the derby codeline.  \r\n\r\nI will attach the original stack trace, but the code has changed quite a bit so the routine names, locations, will have changed.  About the only thing relevant will be the monitor deadlock info.\r\n\r\nBased on this, I do not think we should just go ahead and put the synchronization back into GenericActivationHolder.execute(). \r\n\r\nDoes the new fix add any additional need for synchonization?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-06-14T20:14:24.444+0000","updated":"2010-06-14T20:14:24.444+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12878730","id":"12878730","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Attaching the stack trace for the monitor deadlock from a stress test which was seen with Cloudscape release and as a result, the synchornization code was commented.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2010-06-14T20:22:31.344+0000","updated":"2010-06-14T20:22:31.344+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12878829","id":"12878829","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Attached is a new patch with narrowed synchronization in GenericActivationHolder.  Still, the synchronization is not the same as previously because I think that synchronization was wrong.\r\n\r\nThe previous code had this logic OUTSIDE of synchronized blocks:\r\n\r\n284     newGC = gc;\r\n296     BaseActivation newAC = (BaseActivation) newGC.newInstance(lcc);\r\n298     DataTypeDescriptor[]  newParamTypes = ps.getParameterTypes();\r\n\r\nthen later:\r\n333     ac = newAC;\r\n334     gc = newGC;\r\n335     paramTypes = newParamTypes;\r\n...\r\n352     return ac.execute();  <-- Particularly dangerous\r\n\r\nThese unprotected accesses (both read and write) to member variables shared by multiple threads is inherently dangerous.\r\n\r\nThe new patch for GenericActivationHolder takes the approach of copying the member variables into local variables within a synchronized block, and then using those locals throughout.  At the end of the code path where a statement is re-prepared (and a new generated class, activation class, and parameter types created), the member variables are then updated within a synchronized block.\r\n\r\nI believe this approach should eliminate all synchronization issues within the execute() method while minimizing the synchronization windows.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-15T02:22:24.827+0000","updated":"2010-06-15T02:22:24.827+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12878831","id":"12878831","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Updated patch with synchronization changes in GenericActivationHolder.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-15T02:39:36.030+0000","updated":"2010-06-15T02:39:36.030+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12878886","id":"12878886","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for digging up this information, Mamta.\r\n\r\nBrett: The way I understand this code, GenericActivationHolder instances are private to a transaction, and therefore only accessed by a single thread (enforced by synchronization in EmbedStatement.execute()). So I think the synchronization on \"this\" added in the latest patch won't have any effect.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2010-06-15T08:31:45.031+0000","updated":"2010-06-15T08:31:45.031+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12879202","id":"12879202","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Knut, thanks for the code review.  I have updated the synchronization to synchronize on the ExecPreparedStatement (ps) object thoughout the execute()  method.  If you have time, please review the new uploaded patch.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-16T00:24:47.039+0000","updated":"2010-06-16T00:24:47.039+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12879203","id":"12879203","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Patch with updated synchronization.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-16T00:25:33.152+0000","updated":"2010-06-16T00:25:33.152+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12879293","id":"12879293","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The new synchronized blocks in execute() still only access fields local to GenericActivationHolder, so I'm not sure I understand the need to synchronize on the prepared statement there. I think it would be fine to use the second revision of the patch (the one that fixed the NPE) and change it so that it didn't uncomment the outer synchronization block.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2010-06-16T09:48:26.518+0000","updated":"2010-06-16T09:48:26.518+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12879337","id":"12879337","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"The original still had a synchronized block that synchronized on the prepared statement.  Was it unnecessary?  I'm not so sure...\r\n\r\nOne concern is the statement above \"GenericActivationHolder instances are private to a transaction\".  Private to a transaction, and private to a thread are two different things.  We run in an XA environment, and theoretically (as far as I understand XA), a transaction can span both connections and threads.\r\n\r\nAnother issue, is that, when running with the above patch I am seeing intermittent failures in our server application.  There are multiple threads doing \"DELETE FROM\" and \"INSERT INTO\" the same table, and I am seeing an occasional insert failure stating that the insert would cause a primary key violation.\r\n\r\nAt this point, I am not sure it is related to the patch or not because our server code has been shifting about as well.  However, a short run using 10.6.1.0 without the patch did not see this particular error.  Because the issue is intermittent, and I unsure whether the cause is the patch or application level code.  Further testing tomorrow should clarify.\r\n\r\nNote that running the derby test suite did not result in any errors.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-16T13:38:51.702+0000","updated":"2010-06-16T13:38:51.702+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12879388","id":"12879388","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"> The original still had a synchronized block that synchronized on the\r\n> prepared statement. Was it unnecessary? I'm not so sure...\r\n\r\nThe original synchronization block enclosed code that accessed the\r\nprepared statement, which may be shared between threads. So that\r\nsynchronization should not be removed, I was only talking about the\r\nsynchronization blocks that were added by the patch.\r\n\r\n> One concern is the statement above \"GenericActivationHolder instances\r\n> are private to a transaction\". Private to a transaction, and private\r\n> to a thread are two different things. We run in an XA environment, and\r\n> theoretically (as far as I understand XA), a transaction can span both\r\n> connections and threads.\r\n\r\nIn this case, \"private to a transaction\" meant \"private to a local\r\nDerby transaction\", so XA won't come into the picture. Still, it's\r\ntrue that a single transaction can run in multiple threads. For\r\nexample, I can prepare a statement in one thread, execute the\r\nstatement in another thread, and commit the transaction in a third\r\nthread. However, there's synchronization at a higher level that\r\nprevents multiple threads from running in the same transaction\r\nconcurrently. This is ensured at the entry points in EmbedConnection,\r\nEmbedStatement and EmbedResultSet. The engine code therefore safely\r\nassumes that \"private to a transaction\" implies \"not accessed by\r\nmultiple threads concurrently\".\r\n\r\n> Another issue, is that, when running with the above patch I am seeing\r\n> intermittent failures in our server application. There are multiple\r\n> threads doing \"DELETE FROM\" and \"INSERT INTO\" the same table, and I am\r\n> seeing an occasional insert failure stating that the insert would\r\n> cause a primary key violation.\r\n>\r\n> At this point, I am not sure it is related to the patch or not because\r\n> our server code has been shifting about as well. However, a short run\r\n> using 10.6.1.0 without the patch did not see this particular\r\n> error. Because the issue is intermittent, and I unsure whether the\r\n> cause is the patch or application level code. Further testing tomorrow\r\n> should clarify.\r\n\r\nThanks for investigating this further. It would be good to understand\r\nwhy you see this error before we proceed with getting the patch into\r\nthe code tree.\r\n\r\n> Note that running the derby test suite did not result in any errors.\r\n\r\nYes, the regression test suite doesn't have many multi-threaded tests\r\nand isn't good at catching such errors, unfortunately...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2010-06-16T17:11:51.828+0000","updated":"2010-06-16T17:11:51.828+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12880062","id":"12880062","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Thanks for the overview, it was helpful.  I have reverted the synchronization to it's former state.\r\n\r\nThe issue I was seeing with duplicate primary keys turned out to be a Hibernate bug, not related to this patch.  So, I am comfortable going forward with this patch.\r\n\r\nThanks all for the review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-18T03:24:59.669+0000","updated":"2010-06-18T03:24:59.669+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12880147","id":"12880147","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks Brett! The patch looks good to me. I'll run the regression tests and intend to commit it if they pass.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2010-06-18T09:57:16.038+0000","updated":"2010-06-18T09:57:16.038+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12880398","id":"12880398","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"+1. The latest version of the patch looks good to me. Thanks Brett for working on this problem.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2010-06-19T01:22:35.907+0000","updated":"2010-06-19T01:22:35.907+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12880755","id":"12880755","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"All the regression tests ran cleanly in my environment. Committed revision 956504.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2010-06-21T09:10:50.391+0000","updated":"2010-06-21T09:10:50.391+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12880770","id":"12880770","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Perhaps we should try to convert the test case Jeff provided to JUnit and add it to the regression test suite before we close the issue?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2010-06-21T09:50:10.734+0000","updated":"2010-06-21T09:50:10.734+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12881103","id":"12881103","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"The tinderbox test failed again with the following error in StressTestMulti:\r\n2010-06-21 16:02:44.542 GMT Thread[DRDAConnThread_1289,5,derby.daemons] (XID = 1929067), (SESSIONID = 61), (DATABASE = wombat), (DRDAID = NF000001.P530-869193450946392963{30}), Failed Statement is: null\r\njava.lang.NullPointerException\r\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.getMetaData(Unknown Source)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.writeSQLDARD(Unknown Source)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(Unknown Source)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.run(Unknown Source)\r\n\r\nIt looks suspicious that after the change from returning void to returning a PreparedStatement, the return value is ignored in EmbedPreparedStatement.getMetaData. Is this correct?\r\n\r\nAs for the error itself, it has already been reported (DERBY-3823).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2010-06-22T06:59:04.905+0000","updated":"2010-06-22T06:59:04.905+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12881209","id":"12881209","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"I need some input here, because I'm wading into unknown waters...\r\n\r\nCertainly, the return value from rePrepare() can be assigned back to preparedStatement on line 1080 ... along the lines of:\r\n\r\npreparedStatement = preparedStatement.rePrepare(lcc);\r\n\r\nBut I am concerned about synchronization issues.  While the getMetaData() method itself obtains a lock via:\r\n\r\nsynchronized (getConnectionSynchronization())\r\n{\r\n   ...\r\n}\r\n\r\nMany other places in EmbedPreparedStatement access the preparedStatement member variable without such synchronization.  It is safe to assume these other accesses are synchronized by some higher-level lock?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-22T14:24:05.260+0000","updated":"2010-06-22T14:24:05.260+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12881214","id":"12881214","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Along the same lines, GenericPreparedStatement line 250 (in getActivation()) receives the value of rePrepare() into a local PreparedStatement (post-patch), but only for the purpose of asserting that it didn't change.  This is also possibly incorrect ... but I'm not sure I grok all of the interactions between GenericPreparedStatement, GeneratedClass, GenericActivationHolder, LanguageConnectionContext, and EmbedPreparedStatement.\r\n\r\nI didn't encounter any errors in the stressmulti test, and I'm running on an 8-core box, so I am not sure how easily I can validate the robustness of this change.  I may require some assistance, and certainly knowledgable input is welcome.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-22T14:31:14.156+0000","updated":"2010-06-22T14:31:14.156+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12882166","id":"12882166","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I haven't studied the details of this code yet, but the synchronization on getConnectionSynchronization() is probably not enough to ensure safe access to the GenericPreparedStatement. getConnectionSynchronization() is used to ensure that a single connection cannot be executing in two threads at the same time, but one GenericPreparedStatement can be shared between multiple connections.\r\n\r\nAssuming this is the same issue as DERBY-3823/DERBY-1635 and it is getActivationClass() that returns null, it looks like getMetaData() must have been called when the statement was being recompiled by another thread, and that thread had already called preparedStatement.setActivationClass(null) in GenericPreparedStatement.prepMinion(). I'm not sure if more synchronization is what's needed to fix this bug, or if the code just needs to handle null returned from getActivationClass(), or perhaps both.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2010-06-24T14:34:06.360+0000","updated":"2010-06-24T14:34:06.360+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12882853","id":"12882853","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"A couple more suspected fallouts of this fix:\r\n\r\n- Mamta added a comment to DERBY-4167 about another NPE in StressMultiTest right after the fix was checked in.\r\n\r\n- Olav's nightly performance regression tests (http://home.online.no/~olmsan/derby/perf/) have not been able to complete after the check-in. It gets stuck in the multi-threaded delete tests. I'll investigate and try to isolate the problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2010-06-26T16:51:53.951+0000","updated":"2010-06-26T16:51:53.951+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12882926","id":"12882926","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"I recommend backing out this fix until synchronization/threading issues have been resolved.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-06-27T08:00:52.928+0000","updated":"2010-06-27T08:00:52.928+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12882984","id":"12882984","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I remember when a lot of the original Statement Cache work was being done the original multi stress test was particularly good at showing up issues.  There is a version that I don't think gets \r\nrun nightly that is even more of a load - StressMulti50x59.java, it runs 50 users for 59 minutes.\r\nEven then just passing this test once did not really prove anything as the issues often are very\r\nsubtle and timing dependent.  Often we would run this test over and over again as machine resources were available.  This week I will see if we can find a machine to do this but I don't think\r\nwe have anything more than a couple of processors.\r\n\r\nRunning this test on a machine with the most possible processors would be good to verify this\r\nfix.  \r\n\r\nDoes this fix mean that we never wait for an existing query plan?   Does anyone understand what this means about performance for queries that take extremely long to compile.  Unfortunately I have seen plans take many minutes to compile depending on how complex, and some customers often \"pre-load\" the plans at application startup, set the cache size such that the plan is expected to be in cache.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2010-06-27T19:42:37.165+0000","updated":"2010-06-27T19:42:37.165+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12883064","id":"12883064","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Attached 'client_stacktrace_activation_closed.txt', an error that happened a few times when running the test in a loop (\"Activation closed, operation execute not permitted\").\r\nAttaching it for reference, I'm not 100% sure it is valid since the test created a derby.log file of 108GB. This caused my disk to fill up and it was deleted when the process died.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2010-06-28T08:20:11.979+0000","updated":"2010-06-28T08:20:11.979+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12883081","id":"12883081","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Another error. I was trying to get a stack trace with line numbers for the getMetaData error, but this popped up instead.\r\n\r\n[Error/failure logged at Sat Jun 26 06:04:57 CEST 2010]\r\njunit.framework.AssertionFailedError: Caused by: \r\njava.sql.SQLException: Java exception: ': java.lang.NullPointerException'.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:95)\r\n        at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:142)\r\n        at org.apache.derby.impl.jdbc.Util.javaException(Util.java:299)\r\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:403)\r\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:346)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2269)\r\n        at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:81)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:614)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.executeQuery(EmbedStatement.java:152)\r\n        at org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest$StressMultiRunnable.select(StressMultiTest.java:555)\r\n        at org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest$StressMultiRunnable.run(StressMultiTest.java:429)\r\n        at java.lang.Thread.run(Thread.java:619)\r\nCaused by: java.sql.SQLException: Java exception: ': java.lang.NullPointerException'.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory40.java:119)\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:70)\r\n        ... 11 more\r\nCaused by: java.lang.NullPointerException\r\n        at org.apache.derby.impl.sql.GenericActivationHolder.<init>(GenericActivationHolder.java:129)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.getActivation(GenericPreparedStatement.java:257)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:609)\r\n        ... 4 more\r\n\r\n        at org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest.handleException(StressMultiTest.java:351)\r\n        at org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest.access$200(StressMultiTest.java:70)\r\n        at org.apache.derbyTesting.functionTests.tests.multi.StressMultiTest$StressMultiRunnable.run(StressMultiTest.java:445)\r\n        at java.lang.Thread.run(Thread.java:619)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2010-06-28T09:24:01.169+0000","updated":"2010-06-28T09:24:01.169+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12883093","id":"12883093","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I've backed out the fix from trunk. Committed revision 958529.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2010-06-28T10:06:49.182+0000","updated":"2010-06-28T10:06:49.182+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/12896623","id":"12896623","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"linking, because when further work is done on this, re-occurrence of DERBY-4721 needs to be prevented.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2010-08-09T17:08:36.426+0000","updated":"2010-08-09T17:08:36.426+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13095694","id":"13095694","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"I am changing this bug back to unassigned.  I have been unable to work on this issue, and leaving it as assigned to me potentially prevents another developer from picking it up.  This is still a major bug, and we still see it in our production server sporadically.\r\n\r\nI hope someone else can pick it up and run with it.  I could suggest looking at the patch here only to gain some understand of the pieces involved -- I think the general approach of the patch may be inherently incorrect.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2011-09-02T00:44:03.778+0000","updated":"2011-09-02T00:44:03.778+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13108421","id":"13108421","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Ticked \"Seen in production\". See DERBY-5367 (comment of 20/Sep/11 01:22) for an example of a workaround to avoid this bug. To me, that workaround seems like a significant burden for people implementing applications on top of Derby.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-09-20T07:49:28.745+0000","updated":"2011-09-20T07:49:28.745+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13146734","id":"13146734","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Funny you mention 5367 and the workaround there.  It was me who opened 5367, and mentioned my workaround.  I guess I should amend my comment there, because just today I discovered that my \"workaround\" does not in fact work.  It appeared to work, and seems somewhat less likely to trigger this deadlock, but ultimately under load it still encounters this issue.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2011-11-09T02:28:40.396+0000","updated":"2011-11-09T02:28:40.396+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13146735","id":"13146735","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"It is inappropriate to offer a \"bounty\" for this bug?  I'm willing to pay to have this fixed.  The amount of time I've spent trying to workaround this issue is ridiculous, and ultimately all such attempts have ended up distorting the readability of the code.\r\n\r\nI am actually stunned that more people are not encountering this bug.  Basically if two (or more) threads are SELECTing and UPDATEing the same table, they WILL hit this issue under load.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2011-11-09T02:32:43.034+0000","updated":"2011-11-09T02:32:43.034+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13262826","id":"13262826","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chaase3","name":"chaase3","emailAddress":"camilla dot haase at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kim Haase","active":true},"body":"If/when this issue is fixed, a documentation JIRA should be filed: the statements made for DERBY-4280 about setting the statementCacheSize property to 0 should be removed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chaase3","name":"chaase3","emailAddress":"camilla dot haase at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kim Haase","active":true},"created":"2012-04-26T18:26:52.700+0000","updated":"2012-04-26T18:26:52.700+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13400091","id":"13400091","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"I've been looking at 4279 again today...\r\n\r\n..and thinking of possible solutions, when a question arose.  First and foremost, the deadlock is caused by the fact that preparing a statement requires a table lock (shared) in Derby.  Why is this, technically?  If the requirement that a table lock is needed to prepare a statement can be removed, this deadlock can be\r\nfixed.\r\n\r\nAlternatively, if the requirement that a table lock is needed cannot be removed, a possible resolution for 4279 is to remove the concept that prepared statements are shared across connections and instead make the statement cache per-connection.  While this increases the memory overhead slightly -- I have to believe that the artifacts of a prepared statement are in fact extremely small -- it removes a lot of shared-cache synchronization code and probably increases concurrency in general.  If you've been in that code, the synchronization is pretty hairy (as you can see from the comments in 4279 as well) and there are synchronization blocks in there but commented out for reasons no existing developers can explain.\r\n\r\nIn fact, now that I think of it, it would be great if the requirement for a table lock could be removed when preparing a statement AND the cache made per-connection (to simplify the code to a point that humans can understand).\r\n\r\nI understand there is probably an edge case whereby performance would be degraded compared to existing code -- that being a scenario in which connections are created and discarded frequently.  But that is a scenario easily solved by connection re-use, either explicit or by use of a connection pool.\r\n\r\nThoughts?  I'm willing to put in some work if either of these approaches is acceptable.  I already put in considerable time on 4279 over a year ago, but eventually abandoned it (as you can see in the comments) due to synchronization issues in the shared cache.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2012-06-24T03:51:59.842+0000","updated":"2012-06-24T03:51:59.842+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13400683","id":"13400683","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I have not been following this issue, so not sure of the details and am not an expert in this area of the code but here is what I think.  I assume that Derby is getting a table level \"INTENT\" shared lock vs a table level \"SHARED\" lock.  This\r\nis a very different thing, but for your purposes is causing the same issue.  Intent locks conflict with other table level SHARED AND EXCLUSIVE locks but not with other\r\nintent locks.\r\n\r\nI think prepare gets these intent locks on the table to insure it gets a consistent view of all the ddl associated with the table that it is compiling.  The main goal is to block other ddl\r\nfrom happening during the prepare, the assumption is that ddl and table level share and exclusive locking is rare (obviously this assumption is not working in the case of your\r\napplication.)  I assume more people are not seeing this because most applications do not require table level shared and exclusive access.  Someone with more expertise\r\nis this area of the code should comment, but I wonder if we could either eliminate this lock or make it much shorter term if we guaranteed to check if ddl had happened\r\nduring the prepare at the very end - a lot of this information is cached so I wonder if the locks are actually doing the work I describe above or if you just need the locks\r\nshort term to consistently populate the caches.  \r\n\r\n Because all the information for a single table is spread across multiple catalogs one may need to do multiple probes to get all the information for a single prepare.\r\nAn example of the kind of bug that has happened in the past is that a prepare produces a plan that is not aware of a new index just added, and a subsequent insert using that\r\nplan does not update the index and thus results in a corrupt database.\r\n\r\nSharing plans across connections was a big performance improvement added to derby based on many customer applications and benchmarks.  Derby compile tiime is often very\r\nslow so anything that can be done to reduce/eliminate that compile time is important. There are a lot of applications out there that are getting performance boosts from the\r\nshared query cache without even knowing it, and yes they may be able to get similar results with application changes but instead now are gettting it automatically.  So I would\r\nnot support eliminating altogether, but Derby is built on modular concept.  If you wanted to add a change that allowed derby to boot in a mode that did not have a shared\r\ncache (while still supporting default of a shared cache), that might be a reasonable approach.  Similar to we default to derby working disk based, but allow it to booted with\r\na different module that allows it to be memory based.  I know at least the disk page cache is implemented in a module that was designed to be easily replaced, not sure about \r\ncurrent state of query cache.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-06-25T17:17:45.236+0000","updated":"2012-06-25T17:17:45.236+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13402024","id":"13402024","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Okay, here is my second cut a fix...\r\n\r\nFirst of all, the original report surmised that any DML, not just SELECT, could cause this deadlock.  I myself thought this as well, but it turns out not to be the case.\r\n\r\nThere are two places in the statement compilation code where openConglomerate() is called.   All compiled statement nodes ultimately inherit from StatementNode.  In StatementNode.lockTableForCompilation() you will find this logic:\r\n\r\nif (dataDictionary.getCacheMode() == DataDictionary.DDL_MODE)   <=== Important\r\n{\r\n    ...\r\n    heapCC = tc.openConglomerate(td.getHeapConglomerateId(),\r\n        false,\r\n        TransactionController.OPENMODE_FORUPDATE |\r\n        TransactionController.OPENMODE_FOR_LOCK_ONLY,\r\n        TransactionController.MODE_RECORD,\r\n        TransactionController.ISOLATION_SERIALIZABLE);   <=== Important\r\n    ...\r\n}\r\n\r\nThe method is preceded with this comment:\r\n\r\n\t/* We need to get some kind of table lock (IX here) at the beginning of\r\n\t * compilation of DMLModStatementNode and DDLStatementNode, to prevent the\r\n\t * interference of insert/update/delete/DDL compilation and DDL execution,\r\n\t * see beetle 3976, 4343, and $WS/language/SolutionsToConcurrencyIssues.txt\r\n\t */\r\n\r\nHowever, ultimately, according to the logic the lock is only obtained if the DataDictionary is in DDL_MODE.  This is all fine.\r\n\r\nNow to the heart of the issue.  The second place where openConglomerate() is called is in ResultColumnList.generateHolderMethod().  This is used for SELECT statements for columns that will ultimately appear in the ResultSet (or sub-SELECTs in nested queries).  In ResultColumnList.generateHolderMethod() you will find this logic:\r\n\r\ncc = getLanguageConnectionContext().getTransactionCompile().openConglomerate(\r\n        conglomerateId,\r\n        false,\r\n        0,\r\n        TransactionController.MODE_RECORD,\r\n        TransactionController.ISOLATION_READ_COMMITTED);   <=== Important\r\n\r\nNotice no conditional logic.  In other words, a lock on the conglomerate is unconditionally obtained.  It is this lock that contends with a table lock that may have been obtained elsewhere (possibly DDL, possibly an explicit lock).  The attached patch changes this code to the following:\r\n\r\nLanguageConnectionContext lcc = getLanguageConnectionContext();\r\nDataDictionary dd = lcc.getDataDictionary();\r\nint isolationLevel = (dd.getCacheMode() == DataDictionary.DDL_MODE) ?\r\n        TransactionController.ISOLATION_READ_COMMITTED : TransactionController.ISOLATION_NOLOCK;\r\ncc = lcc.getTransactionCompile().openConglomerate(\r\n        conglomerateId,\r\n        false,\r\n        0,\r\n        TransactionController.MODE_RECORD,\r\n        isolationLevel);\r\n\r\nBasically, it too checks the DataDictionary to see if it is in DDL_MODE.  If it is, it maintains the same locking level as the existing code.  However, if the DataDictionary is not being modified the code will not obtain a lock.\r\n\r\nWhat is the impact?  The original code has the effect of blocking DDL from execution by locking the table(s) during this compile phase.  And in turn, if DDL has locked the table(s), the compilation will be blocked.  The first I take to be an unintended side-effect (as you'll see).\r\n\r\nLet's take the second case first.  If DDL has occurred (and locked tables), the DataDictionary will be in DDL_MODE, and the new code behaves the same as the old code; the conglomerate is opened with READ_COMMITTED isolation and the compilation will be blocked just as before.\r\n\r\nNow the first case.  If compilation of a statement (that involves ResultColumnList) has started and no DDL is in-progress at that instant, no locks are obtained (because the cache mode is not DDL_MODE).  This is the same as other statement types [that extend from StatementNode].  If DDL occurs after compilation has started, it will not be blocked (but it was never blocked in all other cases).  Because it was never blocked in other cases (due to the conditional logic), I take this to be a side-effect.  However...\r\n\r\nIf DDL does happen to alter the table(s) involved there is already code to handle it.  All roads to ResultColumnList.generateHolderMethod() lead back to GenericStatement.prepare().  GenericStatement.prepare() has this logic fragment:\r\n\r\ntry {\r\n    return prepMinion(lcc, true, (Object[]) null, (SchemaDescriptor) null, forMetaData);\r\n} catch (StandardException se) {\r\n    // There is a chance that we didn't see the invalidation\r\n    // request from a DDL operation in another thread because\r\n    // the statement wasn't registered as a dependent until\r\n    // after the invalidation had been completed. Assume that's\r\n    // what has happened if we see a conglomerate does not exist\r\n    // error, and force a retry even if the statement hasn't been\r\n    // invalidated.\r\n    if (SQLState.STORE_CONGLOMERATE_DOES_NOT_EXIST.equals(se.getMessageId())) {\r\n        ... recompile ...\r\n    }\r\n}\r\n\r\nSo, even though the compile of a SELECT will no longer block DDL from occurring (remember UPDATE, DELETE, and all other DML never blocked it anyway) there is code in-place to handle the possibility that openConglomerate() in StatementNode or ResultColumnList might fail.  In that case, the compile is given one more shot before failing (recompile = true).\r\n\r\nIt is debatable now that the logic in ResultColumnList is the same as StatementNode, whether the isolation in ResultColumnList should also be ISOLATION_SERIALIZABLE like StatementNode given that it is now also conditional based on DataDictionary.getCacheMode() == DDL_MODE.  However, my approach was to be least impacting in terms of deviation from current known working code.\r\n\r\nOn a final note, this patch obviously fixed the test case attached to this issue, however past attempts to fix this bug did the same but ultimately failed in some of the long running stress tests.  It would be helpful if this patch could be applied and let run through the usual full barrage of tests.  That said, the previous patch attempted to fix the issue at the statement cache level with all of it's hairy synchronization.  This patch is considerably simpler both conceptually and implementation-wise.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2012-06-27T07:33:58.825+0000","updated":"2012-06-27T07:33:58.825+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13402147","id":"13402147","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Thanks for your continued effort on this problem, Brett.\r\n\r\nWithout having reviewed the approach used in the patch thoroughly, I can say that suites.All and derbyall passed with the patch applied in my environment.\r\n\r\nBW> So, even though the compile of a SELECT will no longer block DDL from occurring [...]\r\n\r\nI'm not convinced this is true. There's another mechanism in place in the data dictionary (DD) to stop that from happening. For a DDL operation to be allowed, there can't be any ongoing compilations. Note that the opposite isn't the case; compilations can occur even though a DDL is in progress. In the latter case the system catalogs are queried directly instead of going through the/a cache.\r\n\r\nNow, this mechanism relies on several state objects and is a bit complicated so I'm not 100% sure I'm correct. The methods startReading/doneReading and startWriting/transactionFinished in DataDictionaryImpl are good starting points to investigate this further. Note the use of the lock and the relevant counters.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2012-06-27T11:32:11.761+0000","updated":"2012-06-27T11:32:11.761+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13402191","id":"13402191","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Kristian,\r\n\r\nYou might be right, I could be mistaken about a SELECT not blocking DDL.  Be that as it may, this defect here is only tangential to DDL, and as the testcase shows, the deadlock occurs without any DDL per se.  Just simple table-locking.  As to whether this change could adversely affect DDL that is run concurrently with queries -- such as it used to block it but now doesn't, I am not sure.  I don't have a test that runs DDL concurrently with queries, do you know if any of the standard tests or stress tests do that?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2012-06-27T12:43:38.358+0000","updated":"2012-06-27T12:43:38.358+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13402899","id":"13402899","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Brett,\r\n\r\nI think store.AutomaticIndexStatisticsMultiTest may test this scenario.\r\nMy point was not to claim that there is something wrong with the patch, but rather to point out that I believe there is another mechanism in place that will block DDL if a compilation is taking place. Your patch doesn't change anything wrt that mechanism.\r\n\r\n\r\nNow, looking at that second call to openConglomerate it seems to me it's being done only to obtain a row location template. Only heaps can create row location objects. A heap row location template is nothing but a Java object wrapping a few primitive values that haven't been set. I don't immediately see why the conglomerate/heap even has to be open to obtain such an object, but maybe the restriction was put in place for a good reason (anyone?).\r\n\r\nI'm optimistic that the approach in the patch is sound. The question is if obtaining the lock can cause problems in DDL mode, and if we can skip taking it in that mode too. However, I haven't dug deep enough to understand the locking code. Can anyone with more experience in that area see if not taking the lock in RCL.generateHolderMethod has consequences the code isn't prepared to handle?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2012-06-28T07:19:04.125+0000","updated":"2012-06-28T07:19:04.125+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13402921","id":"13402921","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"As an experiment I ran the JUnit regression tests with the patch 'no-lock-experiment.diff'. It just hardcodes the use of a HeapRowLocation instead of opening the conglomerate and getting a lock.\r\n\r\nThe tests completed without any errors.\r\nThe problem is I don't really know if all aspects of the change has been tested, and since most of the tests are single-threaded having these tests pass doesn't really give me that much confidence about the change.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2012-06-28T08:10:42.843+0000","updated":"2012-06-28T08:10:42.843+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13403101","id":"13403101","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Kristian,\r\n\r\nNone of this is documented obviously, but here is my best guess why that code is the way that it is.  Trying to open the conglomerate acts as a check that the schema has not been modified by another thread/transaction.  There may be other locks in place, as you mentioned, that attempt to prevent DDL run running but my guess is there are still 'seams' where it can happen.  Hence the opening of the conglomerate, and note also (especially) the comments in the try...catch in GenericStatement.prepare() where the StandardException is caught and explicitly checked for an error.  The comment is:\r\n\r\n    // There is a chance that we didn't see the invalidation \r\n    // request from a DDL operation in another thread because \r\n    // the statement wasn't registered as a dependent until \r\n    // after the invalidation had been completed.  Assume that's \r\n    // what has happened if we see a conglomerate does not exist \r\n    // error...\r\n\r\nWhich implies to me that DDL might not always be blocked, and code was put in place to handle that case.  Since DDL is rare in a running system, catching an exception might therefore be much cheaper than some kind of read/write lock to try to prevent it.\r\n\r\nThe other possibility is that DDL and DML are completely protected/synchronized now (compared to when that code was written), and some of that code is simply unnecessary.  I'm not in a position to make that judgement.  Hence my attempt to retain as much as of the original behavior, be it inefficient or not, to minimize side-effects.\r\n\r\nI would be perfectly happy with the patch as submitted along with additional comments in the code basically asking 'Is the still necessary?' with a reference to this bug.  Maybe at some point in the future someone digging through the code will unravel the logic completely and determine that 'yes, it is necessary' or 'no, it is not'.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2012-06-28T13:51:30.685+0000","updated":"2012-06-28T13:51:30.685+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13403353","id":"13403353","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"commenting on RowLocation.  The system is designed such that one could implement multiple types of conglomerates.  Currently there are only 2 types, btree and heap - but a lot of structure to allow for more.  So in keeping with this callers know they need a RowLocation but it is up to each implementation to provide the \"hidden\" actual implementation, in this case the HeapRowLocation.  Getting\r\nthis row location from an open conglomerate seemed a natural place as almost all work with a conglomerate already has an open conglomerate of some sort. \r\n\r\nIf it helps to not have to open a conglomerate to get this RowLocation then it would be best to just add a new interface.  I think code could be written to just return the right kind of RowLocation based\r\non the conglomerate id.  At least with the current conglomerate inplementations there is nothing ddl related that would change the RowLocation object returned.  There might be future implementations\r\nthat might require a lock, but I would just add comments about the current problems with getting locks in this operation and the JIRA issue and let future implementers think about that.  \r\n\r\nNew interface would look something like:  TransactionController.newRowLocationTemplate(conglomerateId)\r\n\r\nIf it looks like this is needed let me know, I would be happy to submit a patch with this new interface - if the testing shows this to be helpful.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-06-28T18:46:29.934+0000","updated":"2012-06-28T18:46:29.934+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13403846","id":"13403846","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Thanks for sharing your knowledge on this, Mike.\r\nThe way I see it, the demand for a new interface is not strong enough based on this particular case only. It would be if it turns out using the existing interface is too costly performance-wise, but we don't have any data/indications on that.\r\n\r\nFor now I'd be content with using Brett's patch with ISOLATION_NOLOCK (assuming it does what it implies). It would be good to determine if we can use ISOLATION_NOLOCK in this particular case also when the dictionary is in DDL-mode (see comment below on the DD mode), but that can be done as a separate step.\r\n\r\nOne more comment on the DD modes.\r\nIf the DD is in compile only mode and a compilation is in progress, then no DDL will take place.\r\nIf the DD is in DDL mode and a compilation starts, then the compilation may be performed concurrently with DDL.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2012-06-29T11:45:03.522+0000","updated":"2012-06-29T11:45:03.522+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13403869","id":"13403869","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Kristian and Mike,\r\n\r\nThanks for both of your inputs on this issue.  It's been nagging me for 2 years now, I'll be glad to see it buried.  Let me know if there is anything else I can do.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2012-06-29T12:31:35.278+0000","updated":"2012-06-29T12:31:35.278+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13404148","id":"13404148","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I am not familiar with the synchronization code during stale prepared statement re-compile. But I was looking at the first patch submitted by Brett and suggestion by Knut about statements using session schema and how they do not get saved in the statement cache. \r\n\r\nI worked on statements involving session schema many years back and recall implementing logic which will prevent such statements from going into statement cache. \r\n\r\nWill a similar logic for this jira help with all the synchronization issues we are dealing with? ie, if a thread finds that the prepared statement is already in cache but it is being compiled by another thread, then go ahead and create a new GenericPreparedStatement and compile that instead(same as if the statement never existed in the cahce), BUT do not save this new statement in the statement cache(just like a statement referencing session schema). So, this newly compiled statement will not be available to any other thread. But that should be fine because original preapred statement in the cache is already getting compiled and hence it will be available to other threads in future. Like Brett mentioned, \"Unless a statement undergoes constant concurrent recompilation (defeating the statement cache anyway)\", throwing away a compiled statement after use by a thread if that thread finds previously compiled statement in invalid state and getting compiled by another thread should not be a big overhead.\r\n\r\nI am not sure if creating a GenericPreparedStatement for use by just one thread will solve the synchronization problem in this jira but I wanted to put it out anyways in case if this approach helps.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-06-29T19:41:41.837+0000","updated":"2012-06-29T19:41:41.837+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13404390","id":"13404390","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Mamta,\r\n\r\nThanks for your feedback.  From an efficiency point of view, I think your suggestion (and my initial attempt at a bug fix) is a good approach in general.  As Bryan Pendleton commented earlier,\r\n\r\n\"I think the approach of allowing each caller to prepare the statement independently is valid and useful. In this age of multi-core computing, I think doing possibly extra work like this in search of higher concurrency (and fewer deadlocks) is a good technique.\"\r\n\r\nI would however like to do that work under another bug (enhancement), as I think the most recent patch to fix this bug is both sufficient and correct to address this bug per se.  When this change has been accepted, I'll open another bug under which to do work on concurrency.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2012-06-30T04:52:04.819+0000","updated":"2012-06-30T04:52:04.819+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13411448","id":"13411448","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Can somebody with checkin privileges commit this patch?  It is complete as far as I am concerned.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2012-07-11T12:56:09.282+0000","updated":"2012-07-11T12:56:09.282+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13419085","id":"13419085","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":" I've just returned from vacation, and I'll to do that over the week end. I want to check a few last things before committing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2012-07-20T12:30:35.151+0000","updated":"2012-07-20T12:30:35.151+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13422261","id":"13422261","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"From what I can see, the lock, which is a \"container intention read lock\" (CIS), is released as soon as the controller is closed. I observed this by tracing the locks (derby.debug.true=LockTrace + a custom message to the log to navigate in derby.log). This is a very short time-span, and it happens independently of the isolation level of the transaction (separate sub-transaction for compilation?). Once my test-run has completed I will commit the patch.\r\n\r\nIf we observe the deadlock also when the mode is DDL_MODE I don't see why we can't use NO_LOCK in all cases, since the code appears to be prepared to handle that the conglomerate is dropped under its feet. However, it seems safer to me to keep the change minimal for the time being.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2012-07-25T13:39:41.298+0000","updated":"2012-07-25T13:39:41.298+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13422393","id":"13422393","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Committed patch 'derby4279_2.txt' to trunk with revision 1365661.\r\nI plan to backport this patch in a while.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2012-07-25T16:39:40.917+0000","updated":"2012-07-25T16:39:40.917+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13422398","id":"13422398","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Think I just found another keyboard shortcut or something... Reassigning back to Brett.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2012-07-25T16:42:02.191+0000","updated":"2012-07-25T16:42:02.191+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13435837","id":"13435837","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Backported the fix to 10.9 with revision 1373749.\r\nThe fix is pretty isolated, it may be possible to port it further back if anyone sees the need for that.\r\n\r\nIssue ready for verification/closing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2012-08-16T08:26:19.570+0000","updated":"2012-08-16T08:26:19.570+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13449992","id":"13449992","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=forcers","name":"forcers","emailAddress":"force_rs at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Force Rs","active":true},"body":"I don't think this fix is in 10.9.1.0.  If not, any idea when 10.9.1.1 will be released? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=forcers","name":"forcers","emailAddress":"force_rs at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Force Rs","active":true},"created":"2012-09-06T19:54:56.435+0000","updated":"2012-09-06T19:54:56.435+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13453872","id":"13453872","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Reopening for back-port to the 10.8 branch (with 10.8.3 as a potential release vehicle).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2012-09-12T09:56:52.657+0000","updated":"2012-09-12T09:56:52.657+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/13454131","id":"13454131","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Back-ported fix to 10.8 with revision 1384037. I don't plan to go further back.\r\n\r\nRegarding a 10.9 maintenance release, I haven't seen anyone come forward to be release manager so I guess there are no plans right now.\r\nIt appears a 10.8 maintenance release is being planned, although no information has been added to the wiki yet.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2012-09-12T17:09:39.757+0000","updated":"2012-09-12T17:09:39.757+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428429/comment/14119605","id":"14119605","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"[bulk update] Close all resolved issues that haven't been updated for more than one year.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-09-03T08:31:36.187+0000","updated":"2014-09-03T08:31:36.187+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4279/votes","votes":7,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06fk7:"}}
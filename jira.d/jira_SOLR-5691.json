{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12693130","self":"https://issues.apache.org/jira/rest/api/latest/issue/12693130","key":"SOLR-5691","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310230","id":"12310230","key":"SOLR","name":"Solr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310230&avatarId=22151","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310230&avatarId=22151","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310230&avatarId=22151","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310230&avatarId=22151"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12325573","id":"12325573","description":"Major release after 4.6","name":"4.7","archived":false,"released":true,"releaseDate":"2014-02-26"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321664","id":"12321664","description":"Current trunk","name":"Trunk","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-02-04 19:22:56.107","customfield_12312323":null,"customfield_12310420":"371716","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_131887933_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2014-02-06T04:49:18.444+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-5691/watchers","watchCount":4,"isWatching":false},"created":"2014-02-04T16:11:10.546+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12325762","id":"12325762","description":"Bugfix release after 4.6","name":"4.6.1","archived":false,"released":true,"releaseDate":"2014-01-28"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=markrmiller%40gmail.com","name":"markrmiller@gmail.com","emailAddress":"markrmiller at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=markrmiller%40gmail.com&avatarId=17267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=markrmiller%40gmail.com&avatarId=17267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=markrmiller%40gmail.com&avatarId=17267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=markrmiller%40gmail.com&avatarId=17267"},"displayName":"Mark Miller","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-03-16T13:04:13.970+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313841","id":"12313841","name":"SolrCloud"}],"timeoriginalestimate":null,"description":"I have a large SolrCloud setup, 7 nodes, each hosting few 1000 cores (leaders/replicas of same shard exist on different nodes), which is maybe making it easier to notice the problem.\r\n\r\nNode can randomly get into a state where it \"stops\" responding to PeerSync /get requests from other nodes. When that happens, threaddump of that node shows multiple entries like this one (one entry for each \"blocked\" request from other node; they don't go away with time):\r\n\r\n\"http-bio-8080-exec-1781\" daemon prio=5 tid=0x440177200000 nid=0x25ae  [ JVM locked by VM at safepoint, polling bits: safep ]\r\n   java.lang.Thread.State: RUNNABLE\r\n        at java.util.WeakHashMap.get(WeakHashMap.java:471)\r\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:351)\r\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:201)\r\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:243)\r\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)\r\n\r\nWeakHashMap's internal state can easily get corrupted when used in unsynchronized way, in which case it is known to enter infinite loop in .get() call. It is very likely that this happens here too. The reason why other maybe don't see this issue could be related to huge number of cores I have in this system. The problem is usually created when some node is starting. Also, it doesn't happen with each start, it obviously depends on \"correct\" timing of events which lead to map's corruption.\r\n\r\nThe fix may be as simple as changing:\r\n\r\nprotected final Map<SolrConfig, SolrRequestParsers> parsers = new WeakHashMap<SolrConfig, SolrRequestParsers>();\r\n\r\nto:\r\n\r\n  protected final Map<SolrConfig, SolrRequestParsers> parsers = Collections.synchronizedMap(\r\n      new WeakHashMap<SolrConfig, SolrRequestParsers>());\r\n\r\nbut there may be performance considerations around this since it is entrance into Solr.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"372016","summary":"Unsynchronized WeakHashMap in SolrDispatchFilter causing issues in SolrCloud","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bosmid","name":"bosmid","emailAddress":"bosmid at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bojan Smid","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bosmid","name":"bosmid","emailAddress":"bosmid at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bojan Smid","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":5,"total":5,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12693130/comment/13891055","id":"13891055","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=markrmiller%40gmail.com","name":"markrmiller@gmail.com","emailAddress":"markrmiller at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=markrmiller%40gmail.com&avatarId=17267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=markrmiller%40gmail.com&avatarId=17267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=markrmiller%40gmail.com&avatarId=17267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=markrmiller%40gmail.com&avatarId=17267"},"displayName":"Mark Miller","active":true},"body":"Hmm...what if we put the parser on the solrconfig object as a volatile? Volatiles that don't change are very fast and we avoid the ugly weakhashmap altogether:\r\n\r\n{noformat}\r\nIndex: solr/core/src/java/org/apache/solr/core/SolrConfig.java\r\n===================================================================\r\n--- solr/core/src/java/org/apache/solr/core/SolrConfig.java\t(revision 1564426)\r\n+++ solr/core/src/java/org/apache/solr/core/SolrConfig.java\t(working copy)\r\n@@ -18,6 +18,7 @@\r\n package org.apache.solr.core;\r\n \r\n import static org.apache.solr.core.SolrConfig.PluginOpts.*;\r\n+\r\n import org.apache.solr.common.SolrException;\r\n import org.apache.solr.common.SolrException.ErrorCode;\r\n import org.apache.solr.schema.IndexSchemaFactory;\r\n@@ -28,11 +29,11 @@\r\n import org.apache.solr.request.SolrRequestHandler;\r\n import org.apache.solr.response.QueryResponseWriter;\r\n import org.apache.solr.response.transform.TransformerFactory;\r\n-\r\n import org.apache.solr.search.CacheConfig;\r\n import org.apache.solr.search.FastLRUCache;\r\n import org.apache.solr.search.QParserPlugin;\r\n import org.apache.solr.search.ValueSourceParser;\r\n+import org.apache.solr.servlet.SolrRequestParsers;\r\n import org.apache.solr.update.SolrIndexConfig;\r\n import org.apache.solr.update.UpdateLog;\r\n import org.apache.solr.update.processor.UpdateRequestProcessorChain;\r\n@@ -40,10 +41,8 @@\r\n import org.apache.lucene.search.BooleanQuery;\r\n import org.apache.lucene.index.IndexDeletionPolicy;\r\n import org.apache.lucene.util.Version;\r\n-\r\n import org.slf4j.Logger;\r\n import org.slf4j.LoggerFactory;\r\n-\r\n import org.w3c.dom.Node;\r\n import org.w3c.dom.NodeList;\r\n import org.xml.sax.InputSource;\r\n@@ -89,6 +88,8 @@\r\n   private boolean handleSelect;\r\n \r\n   private boolean addHttpRequestToContext;\r\n+\r\n+  private volatile SolrRequestParsers solrRequestParsers;\r\n   \r\n   /** Creates a default instance from the solrconfig.xml. */\r\n   public SolrConfig()\r\n@@ -324,6 +325,13 @@\r\n     }\r\n     return result;\r\n   }\r\n+  \r\n+  public SolrRequestParsers getRequestParsers() {\r\n+    if (solrRequestParsers == null) {\r\n+      solrRequestParsers = new SolrRequestParsers(this);\r\n+    }\r\n+    return solrRequestParsers;\r\n+  }\r\n \r\n   /* The set of materialized parameters: */\r\n   public final int booleanQueryMaxClauseCount;\r\nIndex: solr/core/src/java/org/apache/solr/servlet/SolrDispatchFilter.java\r\n===================================================================\r\n--- solr/core/src/java/org/apache/solr/servlet/SolrDispatchFilter.java\t(revision 1564426)\r\n+++ solr/core/src/java/org/apache/solr/servlet/SolrDispatchFilter.java\t(working copy)\r\n@@ -103,7 +103,6 @@\r\n \r\n   protected String pathPrefix = null; // strip this from the beginning of a path\r\n   protected String abortErrorMessage = null;\r\n-  protected final Map<SolrConfig, SolrRequestParsers> parsers = new WeakHashMap<SolrConfig, SolrRequestParsers>();\r\n   \r\n   private static final Charset UTF8 = Charset.forName(\"UTF-8\");\r\n \r\n@@ -348,12 +347,7 @@\r\n         if( core != null ) {\r\n           final SolrConfig config = core.getSolrConfig();\r\n           // get or create/cache the parser for the core\r\n-          SolrRequestParsers parser = null;\r\n-          parser = parsers.get(config);\r\n-          if( parser == null ) {\r\n-            parser = new SolrRequestParsers(config);\r\n-            parsers.put(config, parser );\r\n-          }\r\n+          SolrRequestParsers parser = config.getRequestParsers();\r\n \r\n           // Handle /schema/* paths via Restlet\r\n           if( path.startsWith(\"/schema\") ) {\r\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=markrmiller%40gmail.com","name":"markrmiller@gmail.com","emailAddress":"markrmiller at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=markrmiller%40gmail.com&avatarId=17267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=markrmiller%40gmail.com&avatarId=17267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=markrmiller%40gmail.com&avatarId=17267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=markrmiller%40gmail.com&avatarId=17267"},"displayName":"Mark Miller","active":true},"created":"2014-02-04T19:22:56.107+0000","updated":"2014-02-04T19:22:56.107+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12693130/comment/13893027","id":"13893027","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1565069 from [~markrmiller@gmail.com] in branch 'dev/trunk'\r\n[ https://svn.apache.org/r1565069 ]\r\n\r\nSOLR-5691: Sharing non thread safe WeakHashMap across thread can cause problems.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-02-06T04:47:45.095+0000","updated":"2014-02-06T04:47:45.095+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12693130/comment/13893028","id":"13893028","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1565070 from [~markrmiller@gmail.com] in branch 'dev/branches/branch_4x'\r\n[ https://svn.apache.org/r1565070 ]\r\n\r\nSOLR-5691: Sharing non thread safe WeakHashMap across thread can cause problems.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-02-06T04:48:46.908+0000","updated":"2014-02-06T04:48:46.908+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12693130/comment/13893029","id":"13893029","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=markrmiller%40gmail.com","name":"markrmiller@gmail.com","emailAddress":"markrmiller at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=markrmiller%40gmail.com&avatarId=17267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=markrmiller%40gmail.com&avatarId=17267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=markrmiller%40gmail.com&avatarId=17267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=markrmiller%40gmail.com&avatarId=17267"},"displayName":"Mark Miller","active":true},"body":"Die WeakHashMap, die!\r\n\r\nThanks Bojan!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=markrmiller%40gmail.com","name":"markrmiller@gmail.com","emailAddress":"markrmiller at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=markrmiller%40gmail.com&avatarId=17267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=markrmiller%40gmail.com&avatarId=17267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=markrmiller%40gmail.com&avatarId=17267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=markrmiller%40gmail.com&avatarId=17267"},"displayName":"Mark Miller","active":true},"created":"2014-02-06T04:49:18.471+0000","updated":"2014-02-06T04:49:18.471+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12693130/comment/13893200","id":"13893200","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bosmid","name":"bosmid","emailAddress":"bosmid at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bojan Smid","active":true},"body":"Thanks for fixing!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bosmid","name":"bosmid","emailAddress":"bosmid at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bojan Smid","active":true},"created":"2014-02-06T09:18:26.530+0000","updated":"2014-02-06T09:18:26.530+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-5691/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1s28n:"}}
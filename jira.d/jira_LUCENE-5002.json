{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12647896","self":"https://issues.apache.org/jira/rest/api/latest/issue/12647896","key":"LUCENE-5002","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310110","id":"12310110","key":"LUCENE","name":"Lucene - Core","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310110&avatarId=10061","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310110&avatarId=10061","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310110&avatarId=10061","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310110&avatarId=10061"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324323","id":"12324323","description":"Major release after 4.3","name":"4.4","archived":false,"released":true,"releaseDate":"2013-07-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324404","id":"12324404","description":"Bugfix release after 4.3","name":"4.3.1","archived":false,"released":true,"releaseDate":"2013-06-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321663","id":"12321663","description":"Current trunk","name":"Trunk","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2013-05-16 08:40:06.315","customfield_12312323":null,"customfield_12310420":"328252","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_444079254_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2013-05-21T11:03:16.015+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-5002/watchers","watchCount":7,"isWatching":false},"created":"2013-05-16T07:41:56.787+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324143","id":"12324143","description":"Major release after 4.2","name":"4.3","archived":false,"released":true,"releaseDate":"2013-05-05"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simonw","name":"simonw","emailAddress":"simonw at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Willnauer","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-06-18T16:55:14.744+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[],"timeoriginalestimate":null,"description":"Hi all,\r\n\r\nWe have an obvious deadlock between a \"MaybeRefreshIndexJob\" thread\r\ncalling ReferenceManager.maybeRefresh(ReferenceManager.java:204) and a\r\n\"RebuildIndexJob\" thread calling\r\nIndexWriter.deleteAll(IndexWriter.java:2065).\r\n\r\nLucene wants to flush in the \"MaybeRefreshIndexJob\" thread trying to intrinsically lock the IndexWriter instance at {{DocumentsWriterPerThread.java:563}} before notifyAll()ing the flush. \r\n\r\nSimultaneously the \"RebuildIndexJob\" thread who already intrinsically locked the IndexWriter instance at IndexWriter#deleteAll wait()s at {{DocumentsWriterFlushControl.java:245}} for the flush forever causing a deadlock.\r\n\r\n{code}\r\n\"MaybeRefreshIndexJob Thread - 2\" daemon prio=10 tid=0x00007f8fe4006000 nid=0x1ac2 waiting for monitor entry [0x00007f8fa7bf7000]\r\n   java.lang.Thread.State: BLOCKED (on object monitor)\r\n\tat org.apache.lucene.index.IndexWriter.useCompoundFile(IndexWriter.java:2223)\r\n\t- waiting to lock <0x00000000f1c00438> (a org.apache.lucene.index.IndexWriter)\r\n\tat org.apache.lucene.index.DocumentsWriterPerThread.sealFlushedSegment(DocumentsWriterPerThread.java:563)\r\n\tat org.apache.lucene.index.DocumentsWriterPerThread.flush(DocumentsWriterPerThread.java:533)\r\n\tat org.apache.lucene.index.DocumentsWriter.doFlush(DocumentsWriter.java:422)\r\n\tat org.apache.lucene.index.DocumentsWriter.flushAllThreads(DocumentsWriter.java:559)\r\n\tat org.apache.lucene.index.IndexWriter.getReader(IndexWriter.java:365)\r\n\t- locked <0x00000000f1c007d0> (a java.lang.Object)\r\n\tat org.apache.lucene.index.StandardDirectoryReader.doOpenFromWriter(StandardDirectoryReader.java:270)\r\n\tat org.apache.lucene.index.StandardDirectoryReader.doOpenIfChanged(StandardDirectoryReader.java:245)\r\n\tat org.apache.lucene.index.StandardDirectoryReader.doOpenIfChanged(StandardDirectoryReader.java:235)\r\n\tat org.apache.lucene.index.DirectoryReader.openIfChanged(DirectoryReader.java:170)\r\n\tat org.apache.lucene.search.SearcherManager.refreshIfNeeded(SearcherManager.java:118)\r\n\tat org.apache.lucene.search.SearcherManager.refreshIfNeeded(SearcherManager.java:58)\r\n\tat org.apache.lucene.search.ReferenceManager.doMaybeRefresh(ReferenceManager.java:155)\r\n\tat org.apache.lucene.search.ReferenceManager.maybeRefresh(ReferenceManager.java:204)\r\n\tat jobs.MaybeRefreshIndexJob.timeout(MaybeRefreshIndexJob.java:47)\r\n\r\n\"RebuildIndexJob Thread - 1\" prio=10 tid=0x00007f903000a000 nid=0x1a38 in Object.wait() [0x00007f9037dd6000]\r\n   java.lang.Thread.State: WAITING (on object monitor)\r\n\tat java.lang.Object.wait(Native Method)\r\n\t- waiting on <0x00000000f1c0c240> (a org.apache.lucene.index.DocumentsWriterFlushControl)\r\n\tat java.lang.Object.wait(Object.java:503)\r\n\tat org.apache.lucene.index.DocumentsWriterFlushControl.waitForFlush(DocumentsWriterFlushControl.java:245)\r\n\t- locked <0x00000000f1c0c240> (a org.apache.lucene.index.DocumentsWriterFlushControl)\r\n\tat org.apache.lucene.index.DocumentsWriter.abort(DocumentsWriter.java:235)\r\n\t- locked <0x00000000f1c05370> (a org.apache.lucene.index.DocumentsWriter)\r\n\tat org.apache.lucene.index.IndexWriter.deleteAll(IndexWriter.java:2065)\r\n\t- locked <0x00000000f1c00438> (a org.apache.lucene.index.IndexWriter)\r\n\tat jobs.RebuildIndexJob.buildIndex(RebuildIndexJob.java:102)\r\n{code}","customfield_10010":null,"timetracking":{},"customfield_12310120":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10121","value":"New","id":"10121"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"328596","summary":"Deadlock in DocumentsWriterFlushControl","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergiusz.urbaniak","name":"sergiusz.urbaniak","emailAddress":"sergiusz dot urbaniak at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiusz Urbaniak","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergiusz.urbaniak","name":"sergiusz.urbaniak","emailAddress":"sergiusz dot urbaniak at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiusz Urbaniak","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"OpenJDK 64-Bit Server VM (23.7-b01 mixed mode)\r\nLinux Ubuntu Server 12.04 LTS 64-Bit","customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":14,"total":14,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12647896/comment/13659343","id":"13659343","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergiusz.urbaniak","name":"sergiusz.urbaniak","emailAddress":"sergiusz dot urbaniak at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiusz Urbaniak","active":true},"body":"Implementation note: we (obviously) use the same IndexWriter instance across all threads.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergiusz.urbaniak","name":"sergiusz.urbaniak","emailAddress":"sergiusz dot urbaniak at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiusz Urbaniak","active":true},"created":"2013-05-16T07:59:14.065+0000","updated":"2013-05-16T07:59:14.065+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12647896/comment/13659361","id":"13659361","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simonw","name":"simonw","emailAddress":"simonw at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Willnauer","active":true},"body":"here is a patch that has a test that hangs. Pretty straight forward though. Yet, the problem is that we are locking on the index writer in DWPT. Or on the other hand there are too many synch blocks in IW to make it safe to call into IW from DWPT. \r\n\r\nI need to look into that more closely to figure out how to fix that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simonw","name":"simonw","emailAddress":"simonw at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Willnauer","active":true},"created":"2013-05-16T08:40:06.315+0000","updated":"2013-05-16T08:40:06.315+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12647896/comment/13659407","id":"13659407","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"body":"bq. Yet, the problem is that we are locking on the index writer in DWPT.\r\n\r\nMy personal horror scenario! The worst thing you can do is to also externally synchronize on IW. This also causes deadlocks. We should maybe open an issue to fix the synchronization in IW and make it simplier, especially with using ju.concurrent.Lock implementations.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"created":"2013-05-16T10:13:21.771+0000","updated":"2013-05-16T10:13:21.771+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12647896/comment/13659508","id":"13659508","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergiusz.urbaniak","name":"sergiusz.urbaniak","emailAddress":"sergiusz dot urbaniak at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiusz Urbaniak","active":true},"body":"Hi,\r\n\r\nThanks for the quick feedback! As long as the sync issues on IW are unresolved we declare IW instances as *not thread-safe* for our development and synchronize access to it externally (of course as mentioned in the docs not on the IW instance itself).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergiusz.urbaniak","name":"sergiusz.urbaniak","emailAddress":"sergiusz dot urbaniak at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiusz Urbaniak","active":true},"created":"2013-05-16T13:21:18.429+0000","updated":"2013-05-16T13:21:18.429+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12647896/comment/13660559","id":"13660559","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"I think we should address this for 4.3.1?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2013-05-17T11:15:21.084+0000","updated":"2013-05-17T11:15:21.084+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12647896/comment/13660586","id":"13660586","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simonw","name":"simonw","emailAddress":"simonw at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Willnauer","active":true},"body":"Ok so I tried to make this work for an entire day and bottom line is that once I move the DocumentsWriter#abort() out of the sync block my test still fails all over the place. Yet, it's not hanging but concurrent access to IW while IW#deleteAll() is called is entirely broken IMO. I don't even know where to start, here is a small wrapup of the failures I saw:\r\n - asserts are tripped in global field map since we clear and concurrently index (remember indexing is non-blocking)\r\n - concurrent commits fail with fiel not found exception (even if we fully sync) seems like some state in IW is not cleared\r\n - updatePendingMerges fails with FNF when merges are updated concurrently.\r\n\r\nTo begin with I doubt that the semantics of IW#deleteAll() are correct today if you are accessing the IW concurrently. I mean we basically dropping everything and don't maintain any happens before relationship here at all, delete all files that are not referenced in any seg info wipe all the global field infos etc. We should address this properly.\r\n\r\nI agree that we have to fix this until 4.3.1!\r\n\r\nYet, Serguiuz  do you see any FileNotFoundExceptions or anything when you concurrently call deleteAll? I mean this seems entirely broken to me at this point. I suggest you to use deleteQuery(new MatchAllDocsQuery()) for now and not lock globally. \r\n\r\nsimon","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simonw","name":"simonw","emailAddress":"simonw at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Willnauer","active":true},"created":"2013-05-17T11:43:13.355+0000","updated":"2013-05-17T11:43:13.355+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12647896/comment/13660590","id":"13660590","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simonw","name":"simonw","emailAddress":"simonw at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Willnauer","active":true},"body":"here is a patch that fixes this issue and adds some asserts that make sure we don't wait while holding the IW lock. Yet, this is a pretty drastic step in the patch since I need to stop the world for this to be an operation that works correct in a concurrent world. I think it's ok for us do to a stop the world here but we really need to beast this patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simonw","name":"simonw","emailAddress":"simonw at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Willnauer","active":true},"created":"2013-05-17T11:46:15.514+0000","updated":"2013-05-17T11:46:15.514+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12647896/comment/13660592","id":"13660592","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"One (app level) workaround here is to not call deleteAll in one thread, while other threads are still indexing.\r\n\r\nBut we still have to fix the deadlock.  I think a simple fix in deleteAll is to move the sync down after docWriter.abort(), so we don't hold IW's intrinsic lock while calling docWriter.abort().  I tried this, but it leads to an AssertionError:\r\n\r\n{noformat}\r\nCaused by: java.lang.AssertionError\r\n\tat __randomizedtesting.SeedInfo.seed([60429B79D72112B5]:0)\r\n\tat org.apache.lucene.index.FieldInfos$Builder.addOrUpdateInternal(FieldInfos.java:284)\r\n\tat org.apache.lucene.index.FieldInfos$Builder.addOrUpdate(FieldInfos.java:266)\r\n\tat org.apache.lucene.index.DocFieldProcessor.processDocument(DocFieldProcessor.java:211)\r\n\tat org.apache.lucene.index.DocumentsWriterPerThread.updateDocument(DocumentsWriterPerThread.java:256)\r\n\tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:376)\r\n\tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1508)\r\n\tat org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1183)\r\n\tat org.apache.lucene.index.RandomIndexWriter.addDocument(RandomIndexWriter.java:152)\r\n\tat org.apache.lucene.index.RandomIndexWriter.addDocument(RandomIndexWriter.java:114)\r\n\tat org.apache.lucene.index.TestIndexWriterDelete$1.run(TestIndexWriterDelete.java:331)\r\n{noformat}\r\n\r\nSeparately we really need to overhaul / simplify IW/DW/BD's locking!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2013-05-17T11:46:40.868+0000","updated":"2013-05-17T11:46:40.868+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12647896/comment/13660655","id":"13660655","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"The patch is terrifying looking yet seems necessary, and on beasting seems to work (but: we have to either not use docValues, or prevent Lucene3x codec).\r\n\r\nI think stop-the-world is perfectly fine here: it's not like apps are calling deleteAll 1000s of times per second.\r\n\r\nI even think it'd be fine if concurrent indexing threads hit strange exceptions, and we document that you should not use other methods while deleteAll is invoked in one thread, as long as we can guarantee this never leads to index corruption.  This is just like you can call IW.close from one thread while other threads are still indexing but those other threads can hit strange exceptions.\r\n\r\nI'll open a new issue to somehow simplify IW's sync... it's a mess now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2013-05-17T12:01:00.861+0000","updated":"2013-05-17T12:01:00.861+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12647896/comment/13660658","id":"13660658","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"OK I opened LUCENE-5006.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2013-05-17T12:04:49.965+0000","updated":"2013-05-17T12:04:49.965+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12647896/comment/13660669","id":"13660669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergiusz.urbaniak","name":"sergiusz.urbaniak","emailAddress":"sergiusz dot urbaniak at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiusz Urbaniak","active":true},"body":"Simon,\r\n\r\nNo FileNotFoundExceptions what so ever. The stack trace above is \"complete\" except the crappy ejb stack forrest which is not relevant.\r\n\r\nAgain thanks for the quick reaction, we'll use deleteQuery(new MatchAllDocsQuery()) instead and omit the global lock.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergiusz.urbaniak","name":"sergiusz.urbaniak","emailAddress":"sergiusz dot urbaniak at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiusz Urbaniak","active":true},"created":"2013-05-17T12:19:00.493+0000","updated":"2013-05-17T12:19:00.493+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12647896/comment/13662852","id":"13662852","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simonw","name":"simonw","emailAddress":"simonw at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Willnauer","active":true},"body":"Mike, I want to commit this patch and let is bake in a bit on trunk and 4x, any objections? I will remove the DV use in 4x on trunk this is not a problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simonw","name":"simonw","emailAddress":"simonw at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Willnauer","active":true},"created":"2013-05-21T09:59:14.937+0000","updated":"2013-05-21T09:59:14.937+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12647896/comment/13662857","id":"13662857","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"+1 to commit","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2013-05-21T10:09:56.048+0000","updated":"2013-05-21T10:09:56.048+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12647896/comment/13686954","id":"13686954","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shalinmangar","name":"shalinmangar","emailAddress":"shalin dot mangar at lucidworks dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=shalinmangar&avatarId=19501","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=shalinmangar&avatarId=19501","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=shalinmangar&avatarId=19501","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=shalinmangar&avatarId=19501"},"displayName":"Shalin Shekhar Mangar","active":true},"body":"Bulk closing after 4.3.1 release","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shalinmangar","name":"shalinmangar","emailAddress":"shalin dot mangar at lucidworks dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=shalinmangar&avatarId=19501","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=shalinmangar&avatarId=19501","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=shalinmangar&avatarId=19501","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=shalinmangar&avatarId=19501"},"displayName":"Shalin Shekhar Mangar","active":true},"created":"2013-06-18T16:55:14.742+0000","updated":"2013-06-18T16:55:14.742+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-5002/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1kmvz:"}}
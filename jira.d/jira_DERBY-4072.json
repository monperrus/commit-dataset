{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12415621","self":"https://issues.apache.org/jira/rest/api/latest/issue/12415621","key":"DERBY-4072","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313478","id":"12313478","description":"Head of 10.1 branch. Maintenance version bump for sps update ","name":"10.1.3.3","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312251","id":"12312251","description":"Head of 10.2 branch","name":"10.2.2.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313143","id":"12313143","description":"Head of 10.3 branch","name":"10.3.3.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313401","id":"12313401","description":"Head of 10.4 branch","name":"10.4.2.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-02-27 18:40:53.244","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24008","customfield_12310222":"1_*:*_1_*:*_758499838_*|*_6_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2009-03-06T17:34:09.834+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4072/watchers","watchCount":0,"isWatching":false},"created":"2009-02-25T22:52:29.996+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313142","id":"12313142","description":"","name":"10.3.3.0","archived":false,"released":true,"releaseDate":"2008-05-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313345","id":"12313345","description":"","name":"10.4.2.0","archived":false,"released":true,"releaseDate":"2008-09-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-05-04T18:22:43.318+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11412","id":"11412","name":"Store"}],"timeoriginalestimate":null,"description":"I recently saw  case where a user was seeing the following error in the derby.log when trying to shutdown their database.\nNew exception raised during cleanup null\njava.lang.NullPointerException\n        at org.apache.derby.impl.store.raw.log.LogToFile.flush(LogToFile.java:3964)\n        at org.apache.derby.impl.store.raw.log.LogToFile.flush(LogToFile.java:1781)\n        at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.flush(BaseDataFileFa\n        at org.apache.derby.impl.store.raw.data.CachedPage.writePage(CachedPage.java:761\n        at org.apache.derby.impl.store.raw.data.CachedPage.clean(CachedPage.java:610)\n        at org.apache.derby.impl.services.cache.ConcurrentCache.cleanAndUnkeepEntry(Conc\n        at org.apache.derby.impl.services.cache.ConcurrentCache.cleanCache(ConcurrentCac\n        at org.apache.derby.impl.services.cache.ConcurrentCache.cleanAll(ConcurrentCache\n        at org.apache.derby.impl.services.cache.ConcurrentCache.shutdown(ConcurrentCache\n        at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.stop(BaseDataFileFac\n        at org.apache.derby.impl.services.monitor.TopService.stop(TopService.java:405)\n        at org.apache.derby.impl.services.monitor.TopService.shutdown(TopService.java:34\n        at org.apache.derby.impl.services.monitor.BaseMonitor.shutdown(BaseMonitor.java:\n        at org.apache.derby.impl.db.DatabaseContextImpl.cleanupOnError(DatabaseContextIm\n        at org.apache.derby.iapi.services.context.ContextManager.cleanupOnError(ContextM\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.cleanupOnError(Transaction\n        at org.apache.derby.impl.jdbc.EmbedConnection.<init>(EmbedConnection.java:584)\n        at org.apache.derby.jdbc.Driver40.getNewEmbedConnection(Driver40.java:68)\n        at org.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:238)\n        at org.apache.derby.jdbc.AutoloadedDriver.connect(AutoloadedDriver.java:119)\n        at java.sql.DriverManager.getConnection(DriverManager.java:316)\n        at java.sql.DriverManager.getConnection(DriverManager.java:273)\n\nIt ended up that some of the log files did not have proper write permissions because some operation on the database had been performed by root.   They had subsequently deleted their db.lck file so the database did not boot READ ONLY as it would if the root owned db.lck file still existed and the symptom was that they got this error on shutdown.\n\nClearly this was user error, but it would have been good if we gave a better error message.  To reproduce on Linux:\nAs a user with umask 0022, run the program \njava MakeDB\nthis will make the databases wombat and create a table.\nsu root\nwith umask 0022, run the program to insert data and remove the db.lck file:\njava InsertALot\nrm wombat/db.lck\ngo back to the original user\nrun the program:\njava ConnectAndShutdown\n\nThe application gets the normal shutdown exception but if you look in derby.log you will see the exception.\njava.lang.NullPointerException\n        at org.apache.derby.impl.store.raw.log.LogToFile.flush(LogToFile.java:3964)\n        ...\nI will attach the files.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39234","summary":"shutdown with incorrect permission on log files shows java.lang.NullPointerException  at org.apache.derby.impl.store.raw.log.LogToFile.flush(LogToFile.java:3964).  Should give bettter message.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10102","value":"Patch Available","id":"10102"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":10,"total":10,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415621/comment/12676805","id":"12676805","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Attaching files for reproduction. See description for reproduction information.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-02-25T22:53:39.406+0000","updated":"2009-02-25T22:53:39.406+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415621/comment/12677439","id":"12677439","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"So the exception we are not  reporting is:\r\njava.io.FileNotFoundException: /home/kmarsden/repro/10602/wombat/log/log28.dat (Permission denied)\r\n\tat java.io.RandomAccessFile.<init>(RandomAccessFile.java:218)\r\n\tat org.apache.derby.impl.io.DirRandomAccessFile.<init>(DirRandomAccessFile.java:57)\r\n\tat org.apache.derby.impl.io.DirFile4.getRandomAccessFile(DirFile4.java:250)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.run(LogToFile.java:5689)\r\n\tat java.security.AccessController.doPrivileged(AccessController.java:251)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.privRandomAccessFile(LogToFile.java:5579)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.checkJvmSyncError(LogToFile.java:5522)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.openLogFileInWriteMode(LogToFile.java:5471)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.recover(LogToFile.java:1074)\r\n\tat org.apache.derby.impl.store.raw.RawStore.boot(RawStore.java:339)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.boot(BaseMonitor.java:2019)\r\n\tat org.apache.derby.impl.services.monitor.TopService.bootModule(TopService.java:291)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.startModule(BaseMonitor.java:573)\r\n\tat org.apache.derby.iapi.services.monitor.Monitor.bootServiceModule(Monitor.java:427)\r\n\tat org.apache.derby.impl.store.access.RAMAccessManager.boot(RAMAccessManager.java:1019)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.boot(BaseMonitor.java:2019)\r\n\tat org.apache.derby.impl.services.monitor.TopService.bootModule(TopService.java:291)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.startModule(BaseMonitor.java:573)\r\n\tat org.apache.derby.iapi.services.monitor.Monitor.bootServiceModule(Monitor.java:427)\r\n\tat org.apache.derby.impl.db.BasicDatabase.bootStore(BasicDatabase.java:780)\r\n\tat org.apache.derby.impl.db.BasicDatabase.boot(BasicDatabase.java:196)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.boot(BaseMonitor.java:2019)\r\n\tat org.apache.derby.impl.services.monitor.TopService.bootModule(TopService.java:291)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.bootService(BaseMonitor.java:1856)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.startProviderService(BaseMonitor.java:1722)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.findProviderAndStartService(BaseMonitor.java:1602)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.startPersistentService(BaseMonitor.java:1021)\r\n\tat org.apache.derby.iapi.services.monitor.Monitor.startPersistentService(Monitor.java:550)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.bootDatabase(EmbedConnection.java:2581)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.<init>(EmbedConnection.java:374)\r\n\tat org.apache.derby.jdbc.Driver40.getNewEmbedConnection(Driver40.java:68)\r\n\tat org.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:238)\r\n\tat org.apache.derby.jdbc.AutoloadedDriver.connect(AutoloadedDriver.java:119)\r\n\tat java.sql.DriverManager.getConnection(DriverManager.java:316)\r\n\tat java.sql.DriverManager.getConnection(DriverManager.java:273)\r\n\tat ConnectAndShutdown.main(ConnectAndShutdown.java:9)java.io.FileNotFoundException: \r\n\r\nand the correspoinding code in LogToFile is ~1067\r\n\t\t\t\t\tif (!ReadOnlyDB)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t// if datafactory doesn't think it is readonly, we can\r\n\t\t\t\t\t\t// do some futher test of our own\r\n\t\t\t\t\t\ttry\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tif(isWriteSynced)\r\n\t\t\t\t\t\t\t\ttheLog = openLogFileInWriteMode(logFile);\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\ttheLog = privRandomAccessFile(logFile, \"rw\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcatch (IOException ioe)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\ttheLog = null;\r\n\t\t\t\t\t\t}\r\n                        if (theLog == null || !privCanWrite(logFile))\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tif (theLog != null)\r\n\t\t\t\t\t\t\t\ttheLog.close();\r\n\t\t\t\t\t\t\ttheLog = null;\r\n\r\n\t\t\t\t\t\t\tReadOnlyDB = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\nWe catch the exception and silently change the database to ReadOnly.\r\nLater ~~`1172 we fail to initialize logOut because theLog is null\r\n\t\tif (theLog != null)\r\n\t\t\t\t\tlogOut = new LogAccessFile(this, theLog, logBufferSize);\r\n\r\nThere is another area of similar code ~986\r\n\r\nfinally during flush logOut is null so we get the NPE.\r\n\r\nI was thinking we should \r\n1) Log the IOExceptions.\r\n2) Log whenever we change a database to ReadOnly.\r\n3) In flush() if the database is ReadOnly print a warning to the log that we cannot flush the log to a ReadOnlyDB and return.\r\n\r\nbut I don't know if this is overly verbose.  Are there normal instances of the IOException we might want to   silently ignore?\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-02-27T18:04:02.858+0000","updated":"2009-02-27T18:04:02.858+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415621/comment/12677455","id":"12677455","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I am not sure best way to do the following, but thought I would at least first comment on what the goal should be.  The whole \"readonly\" code I think is weak.  It was mostly put in to allow a derby db to be put on and run directly from something like a cd, and to be zero-admin, ie. not force people to somehow createdb a readonly db.  We expect to determine a readonly db when we get the lock on the database lock file which requires writing to the file.  it never really was \r\ndesigned for these \"half-readonly\" cases.\r\n\r\nThe problem as this case shows is that catching exceptions and interpreting them may lead to the wrong conclusions.  \r\n\r\nSo for instance I would say that we should not boot if we think the db is readonly but we find work to do during restart recovery.  This is effectively what the code does but delays the error to sometime in the future and a NPE.  The possible problems with allowing boot to continue are:\r\no if redo recovery has anything to do then it will fill up the cache with dirty pages, and on shutdown\r\n   or earlier we may try to write those pages out and if the db is read only get errors.\r\no if redo recovery has anything to abort then it will have to write extra stuff to the log file and if \r\n   existing log file is not writable or new logfiles are not writeable then we may get wierd errors\r\n   during boot.\r\nBoth the above may be existing problems in the code with a readonly cd version, I don't know.\r\nI think in both these cases we should fail the boot and make sure somehow errors get printed saying exactly why we thought the db was readonly and that recovery code not run as it found\r\nnecessary writable work to do.\r\n\r\nUnfortunately I think we still want to support finding some log files in a readonly db as a very normal situation would be for a customer to load up a db, then do a clean shutdown and then copy the full db to the cd.  This will still leave some log files, but no work to do.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2009-02-27T18:40:53.244+0000","updated":"2009-02-27T18:40:53.244+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415621/comment/12677465","id":"12677465","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"so, if nothing else is done I think it would be worthwhile to always log why we are booting a db as readonly, especially if it is not the standard place where we expect in getting the db lock.  It would be nicer if this was just part of the boot message rather than an additional message but not sure that fits in the code flow.\r\n\r\nI would be concerned about the last part suggested where we just ignore the flush error.\r\n\r\nIt would be good to know if the problems with this wierd installation are also problems with the expected read only medium.  To me the following are bugs:\r\no any attempt to add a writable page to the cache for a non-temp table should just get an early\r\n    error, rather than fail later at flush.\r\no any writable log action to a readonly db would be nice to get a reasonable error, rather npe.\r\n   this just makes support easier.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2009-02-27T18:50:49.796+0000","updated":"2009-02-27T18:50:49.796+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415621/comment/12677486","id":"12677486","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"\r\nI think for starters I will just log the places and the reason where we change to ReadOnly in LogToFile where we weren't ReadOnly before and leave the NPE. If we add the ReadOnly change logging that will come first in the log and will give sufficient information as to what the problem is.\r\n\r\nI think this will not affect existing read only users because their database will have been set ReadOnly earlier when we were accessing the lock. I will test a full read only database just to make sure.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-02-27T19:13:29.579+0000","updated":"2009-02-27T19:13:29.579+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415621/comment/12677539","id":"12677539","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Attached is a proposed path to improve the error logging when an error gaining write access to the log files causes the database status to change to read only (derby-4072_diff.txt)\r\n\r\nAttached also is a sample derby.log showing the new warning.\r\n\r\nI confirmed that for a totally read only database we just get  the READ ONLY boot message and these warnings don't show up.\r\n\r\nI am running test now.\r\n\r\nSorry for originally accidentally attaching this to DERBY-4077. Can't seem to keep my Jira issues straight today.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-02-27T21:27:37.296+0000","updated":"2009-02-27T21:27:37.296+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415621/comment/12677616","id":"12677616","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Tests passed except for known failure DERBY-3993.  Please review.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-02-28T01:28:33.058+0000","updated":"2009-02-28T01:28:33.058+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415621/comment/12678053","id":"12678053","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"I looked at the code and it seems reasonable to me.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2009-03-02T18:37:38.380+0000","updated":"2009-03-02T18:37:38.380+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415621/comment/12678056","id":"12678056","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I reviewed the proposed changes, they look good to me.  It will be nice to get more info to debug this on remote user sites.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2009-03-02T18:45:56.678+0000","updated":"2009-03-02T18:45:56.678+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415621/comment/12678062","id":"12678062","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Myrna and Mike for looking at the patch.  I submitted to trunk and will backport to 10.4,10.3,10.2, and 10.1 before closing this issue.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-03-02T19:02:17.583+0000","updated":"2009-03-02T19:02:17.583+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4072/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i072vz:"}}
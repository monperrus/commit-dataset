{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12428889","self":"https://issues.apache.org/jira/rest/api/latest/issue/12428889","key":"DERBY-4292","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314117","id":"12314117","description":"Next release after 10.5.2.0 release candidate #1","name":"10.5.3.0","archived":false,"released":true,"releaseDate":"2009-08-21"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313727","id":"12313727","description":"Feature release","name":"10.6.1.0","archived":false,"released":true,"releaseDate":"2010-05-18"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-07-03 14:00:49.077","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24161","customfield_12310222":"1_*:*_1_*:*_1932875145_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2009-07-18T04:37:33.121+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4292/watchers","watchCount":0,"isWatching":false},"created":"2009-06-25T19:42:57.976+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"9.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312876","id":"12312876","description":"","name":"10.3.2.1","archived":false,"released":true,"releaseDate":"2007-12-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313345","id":"12313345","description":"","name":"10.4.2.0","archived":false,"released":true,"releaseDate":"2008-09-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313727","id":"12313727","description":"Feature release","name":"10.6.1.0","archived":false,"released":true,"releaseDate":"2010-05-18"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-08-06T11:01:57.105+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11414","id":"11414","name":"Tools"}],"timeoriginalestimate":null,"description":"org.apache.derby.impl.tools.ij.Main has this code where the call to FileInputStream is not wrapped in a privilege block:\r\n\r\n                   try {\r\n                        in1 = new FileInputStream(file);\r\n                        if (in1 != null) {\r\n                            in1 = new BufferedInputStream(in1, utilMain.BUFFEREDFILESIZE);\r\n                            in = langUtil.getNewInput(in1);\r\n                        }\r\n                    } catch (FileNotFoundException e) {\r\n                        if (Boolean.getBoolean(\"ij.searchClassPath\")) {\r\n                            in = langUtil.getNewInput(util.getResourceAsStream(file));\r\n                        }\r\n\r\nThis can cause issues when running under SecurityManager","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10361","value":"Security","id":"10361"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"38341","summary":"creation of FileInputStream in org.apache.derby.impl.tools.ij.Main not wrapped in privilege  block which can cause problems running under SecurityManager","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10422","value":"High Value Fix","id":"10422"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10423","value":"Newcomer","id":"10423"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10424","value":"Repro attached","id":"10424"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":18,"total":18,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12726258","id":"12726258","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"The problem occurs when you specify a file to run on the ij command line when running under security manager.\r\n\r\nAttached is a reproduction for this issue.   Unzip derby4292.zip. Change run.sh to point to your location and run run.sh.\r\n\r\n\r\nWith the Sun JDK 1.6 JDK I get.\r\nException in thread \"main\" java.security.AccessControlException: access denied (java.io.FilePermission repro.sql read)\r\n        at java.security.AccessControlContext.checkPermission(AccessControlContext.java:323)\r\n        at java.security.AccessController.checkPermission(AccessController.java:546)\r\n        at java.lang.SecurityManager.checkPermission(SecurityManager.java:532)\r\n        at java.lang.SecurityManager.checkRead(SecurityManager.java:871)\r\n        at java.io.FileInputStream.<init>(FileInputStream.java:100)\r\n        at java.io.FileInputStream.<init>(FileInputStream.java:66)\r\n        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:117)\r\n        at org.apache.derby.impl.tools.ij.Main.main(Main.java:73)\r\n        at org.apache.derby.tools.ij.main(ij.java:59)\r\n\r\nWith IBM 1.6 I don't get an error but I think that is due to an IBM jvm bug which I will file soon.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-01T23:01:03.000+0000","updated":"2009-07-01T23:01:03.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12726970","id":"12726970","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Triaged for 10.5.2: checked \"repro attached\" and setting \"normal\" urgency.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2009-07-03T14:00:49.077+0000","updated":"2009-07-03T14:00:49.077+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12727277","id":"12727277","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"body":"I'm submitting two files to this issue. The ReproTest contains a test that reproduces the flaw. If this patch is applied and the test is ran *without* the fix, it should fail. This acknowledges the existence of the flaw.\r\n\r\nThe fix simply wraps the 'offending' code in a privilege block, making the repro test pass.\r\n\r\nThere's one issue with the test: since I am invoking ij manually from within the fixture, the output gets printed to the console. Does anyone have any suggestions to mute this output? We don't really need to see the output since we can handle the exception instead, in case it throws one.\r\n\r\nIt needs also to be noted that the policy file being used is the already existent util/derby_tests.policy since it serves the purpose of the test. However, a new file (tools/IjSecurityManagerTest.sql) is added that is used to reproduce the failure.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"created":"2009-07-04T23:10:01.927+0000","updated":"2009-07-04T23:10:01.927+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12728394","id":"12728394","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Tiago for the patch. Here are some comments.\r\n- Add Apache licence header to new files\r\n- For your privilege block in Main.java, use PrivilegedExceptionAction instead of PrivilegedAction so you can throw the original exception instead of creating a new one if the file is not found.  See PrivilegedFileOpsForTests.getFileOutputStream() for an example.\r\n- In the test if it is using the standard policy file, why do we need to copy it to a special one for this test?\r\n- The test should be added to  a suite.\r\n- I would keep the same name when copying IjSecurityManagerTest.sql\r\n- Regarding the output I am not sure the best way to handle it.  There is System.setOut that could be set and restored, but that seems extreme.  I will think about it.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-07T22:09:48.633+0000","updated":"2009-07-07T22:09:48.633+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12728402","id":"12728402","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"body":"Thank you for your comments Kathey.\r\n\r\n- You are right on the policy file bit. I had that code from another test and I was going under the assumption that it was ultimately necessary to copy the policy file; that isn't the case so I'll change that.\r\n\r\n- I'll create a new patch with all your other comments added.\r\n\r\nOn the output part, after having discussed this with Kathey on IRC, we landed on two options:\r\na) Run ij with execJavaCmd - this option implies having the policy file for this process defined through system properties. It also implies copying over a policy file.\r\n\r\nb) Run ij as it is (\"programatically\") and before it is ran, do:\r\nSystem.setOut(new PrintStream(new NullOutputStream));\r\n\r\nThis effectively mutes any output and after the fixture is ran, the plan is to restore it to the original System.out in a finally block.\r\n\r\nAt this point, this is the method we agreed would be less bad, so I'm going forward with this one on the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"created":"2009-07-07T22:48:26.245+0000","updated":"2009-07-07T22:48:26.245+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12728848","id":"12728848","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"body":"Attaching a new fix and repro test that takes Kathey's comments into consideration.\r\n\r\n- Add Apache licence header to new files -  CHECK\r\n- For your privilege block in Main.java, use PrivilegedExceptionAction instead of PrivilegedAction so you can throw the original exception instead of creating a new one if the file is not found. See PrivilegedFileOpsForTests.getFileOutputStream() for an example. - CHECK\r\n- In the test if it is using the standard policy file, why do we need to copy it to a special one for this test? - CHECK\r\n- The test should be added to a suite. - CHECK\r\n- I would keep the same name when copying IjSecurityManagerTest.sql - CHECK\r\n- Regarding the output I am not sure the best way to handle it. There is System.setOut that could be set and restored, but that seems extreme. I will think about it.  - CHECK\r\n\r\nPlease note that both patches have to be committed. One is the repro test that makes the bug show, the other is the fix to patch it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"created":"2009-07-08T18:54:21.038+0000","updated":"2009-07-08T18:54:21.038+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12728910","id":"12728910","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Hi Tiago I am still looking at the patch but noticed a few things that I wanted to mention.\r\n1) The repro that I posted originally doesn't seem to work with the patch.  I can't quite figure out why.   derby_tests.policy has this permission which should allow us to read repro.sql:\r\n\r\n  // Read all files under ${user.dir}\r\n  permission java.io.FilePermission \"${user.dir}${/}-\", \"read\";\r\n  \r\nbut yet I get:\r\nException in thread \"main\" java.security.AccessControlException: access denied (java.io.FilePermission repro\r\n        at java.security.AccessControlContext.checkPermission(AccessControlContext.java:323)\r\n        at java.security.AccessController.checkPermission(AccessController.java:546)\r\n        at java.lang.SecurityManager.checkPermission(SecurityManager.java:532)\r\n        at java.lang.SecurityManager.checkRead(SecurityManager.java:871)\r\n        at java.io.FileInputStream.<init>(FileInputStream.java:100)\r\n        at java.io.FileInputStream.<init>(FileInputStream.java:66)\r\n        at org.apache.derby.impl.tools.ij.Main$1.run(Main.java:124)\r\n        at java.security.AccessController.doPrivileged(Native Method)\r\n        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:120)\r\n        at org.apache.derby.impl.tools.ij.Main.main(Main.java:75)\r\n        at org.apache.derby.tools.ij.main(ij.java:59)\r\nI am attaching run.out.debugall which has the output when -Djava.security.debug=all is set. It seems to read the permission fine but not use it later. I must be missing something simple.\r\nThis is with:\r\njava version \"1.6.0_01\"\r\nJava(TM) SE Runtime Environment (build 1.6.0_01-b06)\r\nJava HotSpot(TM) Client VM (build 1.6.0_01-b06, mixed mode)\r\n\r\n2) The patch introduces a regression NullPointerException if the file is not found:\r\nException in thread \"main\" java.lang.NullPointerException\r\n        at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:207)\r\n        at org.apache.derby.impl.tools.ij.Main.go(Main.java:235)\r\n        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:190)\r\n        at org.apache.derby.impl.tools.ij.Main.main(Main.java:75)\r\n        at org.apache.derby.tools.ij.main(ij.java:59)\r\nvs \r\nIJ ERROR: file not found: test.sql\r\nbefore the patch.\r\n\r\n3) I noticed there is also a  Boolean.getBoolean(\"ij.searchClassPath\") in the same area of code which I think is going to need a privilege block too. We can handle that with this issue or create another one.\r\n4) In the test I think you can get rid of \r\n test = new SecurityManagerSetup(test, policyName);\r\nall together. That is the policy file that will get picked up by default.\r\n\r\n5) Even our little tiny sql file needs a header. See other sql files for an example.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-08T21:24:20.503+0000","updated":"2009-07-08T21:24:20.503+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12728957","id":"12728957","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"body":"This patch fixes the regression issue when the file does not exist.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"created":"2009-07-08T23:10:19.783+0000","updated":"2009-07-08T23:10:19.783+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12728958","id":"12728958","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"The AccessControlException with the fix and  my repro was user error.  I had an extra slash in my derbyTesting.codejar setting. The command line in run.sh should have been:\r\njava  -Dderby.system.home=C:/kmarsden/repro/derby-4292 -Djava.security.manager -DderbyTesting.codejar=file:/C:/svn4/trunk/jars/sane/ -Djava.security.policy=C:/kmarsden/repro/derby-4292/derby_tests.policy org.apache.derby.tools.ij repro.sql\r\n\r\nWith that change it works fine.\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-08T23:12:08.075+0000","updated":"2009-07-08T23:12:08.075+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12728965","id":"12728965","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Well it seems with your new patch we don't have a problem running under security manger when we hit the Boolean.getBoolean() call so I guess it is ok.  The javadoc also indicates that no checks are done. I don't know why.\r\nhttp://java.sun.com/javase/6/docs/api/java/lang/System.html#getProperty(java.lang.String)\r\n\r\nI verified that ij.searchClassPath is working ok by running:\r\n\r\njava  -Dderby.system.home=C:/kmarsden/repro/derby-4292 -Dij.searchClassPath=true -Djava.security.manager -DderbyTesting.codejar=file:/C:/svn4/trunk/jars/sane/ -Djava.security.policy=C:/kmarsden/repro/derby-4292/derby_tests.policy org.apache.derby.tools.ij /org/apache/derbyTesting/functionTests/tests/tools/IjSecurityManagerTest.sql\r\n\r\nIf I specify a resource that doesn't exist with ij.searchClassPath I get a pre-existing NPE:\r\nException in thread \"main\" java.lang.NullPointerException\r\n        at java.io.Reader.<init>(Reader.java:61)\r\n        at java.io.InputStreamReader.<init>(InputStreamReader.java:55)\r\n        at org.apache.derby.iapi.tools.i18n.LocalizedInput.<init>(LocalizedInput.java:32)\r\n        at org.apache.derby.iapi.tools.i18n.LocalizedResource.getNewInput(LocalizedResource.java:241)\r\n        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:131)\r\n        at org.apache.derby.impl.tools.ij.Main.main(Main.java:75)\r\n        at org.apache.derby.tools.ij.main(ij.java:59)\r\n\r\nI don't know if that needs  a bug since we don't seem to document this property.\r\n\r\n\r\nAs an aside, I don't like the way ij just prints the error to the output and returns instead of throwing an exception. This means it won't exit with an error code if it can't find the file.\r\n[C:/kmarsden/repro/derby-4292] java org.apache.derby.tools.ij notthere.sql\r\nIJ ERROR: file not found: notthere.sql\r\n[C:/kmarsden/repro/derby-4292] echo $?\r\n0\r\n\r\nThat too is preexisting.  \r\n\r\nSo with regard to your patch I think the fix looks fine. For the test patch you should remove the SecurityManager setup, and add a test if the file does not exist, and add the header to the sql file.\r\n\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-08T23:48:11.900+0000","updated":"2009-07-08T23:48:11.900+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12729044","id":"12729044","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"The original repro derby4292.zip had some problems with the script and the permissions in the policy file.  Updating with the corrected version which fails without the fix and passes with it just for the record.  Tiago's test seems to handle this all correctly.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-09T04:11:19.181+0000","updated":"2009-07-09T04:11:19.181+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12729168","id":"12729168","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"body":"I'm attaching the latest patch to this issue.\r\n\r\nKathey said:\r\n> \"...and add a test if the file does not exist...\"\r\nIs this really necessary? If the file does not exist in the Derby code tree, the SupportFilesSetup will blow up on its own, and if it does exist there, then it is safe to say that it will exist in the extinout folder.\r\n\r\nIf anything, I think we can later on change that ij behavior and make it throw an exception rather than an error message, so that the test fails when the file does not exist.\r\n\r\nWhat I'm thinking is that by putting such check on a test, we sort of are masking the problem with ij exiting with status 0 even when the file does not exist. If you think we should have that check anyway, I can easily do it with a new File().exists().\r\n\r\nFor this patch (just the Repro test) I removed the SecurityManager decorator and added the header to the sql file. The fix remains the same.\r\n\r\nI'll be running regressions today.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"created":"2009-07-09T10:53:17.454+0000","updated":"2009-07-09T10:53:17.454+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12729717","id":"12729717","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I think it is ok to check this patch in as is as soon as we get the results of your regression tests.\r\n\r\nRegarding the test for the non-existent file, I am not quite sure what you mean regarding the SupportFilesSetup as that wouldn't be used, we would just call ij and specify a file that does not exist.  I do however see how such a test would be problematic as long as we have the problem of the error just going to System.out. I guess that it would make the most sense to add that test when that issue is fixed.\r\n\r\nI think we need 2 new bugs after this one goes in, both minor or even trivial: One for the ij exit code when the file is not found and another for the NullPointerException if the resource  is not found with ij.searchClassPath.  Mark both newcomer.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-10T17:02:37.224+0000","updated":"2009-07-10T17:02:37.224+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12731194","id":"12731194","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Committed revision 794112.  I will leave this open because I think it would be good to backport to 10.5 although it probably won't make the Release candidate.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-14T23:14:17.848+0000","updated":"2009-07-14T23:14:17.848+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12731837","id":"12731837","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"body":"I've merged this patch into 10.5 with the following command:\r\nsvn merge -r 794111:794112 https://svn.apache.org/repos/asf/db/derby/code/trunk\r\n\r\nI also ran suites.All for 10.5 after the merge and I got no failures.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"created":"2009-07-16T07:09:38.515+0000","updated":"2009-07-16T07:09:38.515+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12732839","id":"12732839","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Submitted this fix to trunk and 10.5 branch\r\nThanks Tiago\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-18T04:37:33.035+0000","updated":"2009-07-18T04:37:33.035+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12732931","id":"12732931","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I accidentally checked in some unrelated test changes to BlobClob4BlobTest with the 10.5 checkin.   This caused three failures in the nightlies.  Corrected this with revision 795425. Sorry for the noise.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-18T20:03:49.635+0000","updated":"2009-07-18T20:03:49.635+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428889/comment/12739990","id":"12739990","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"body":"The patch has been committed and no failures were seen. Closing the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"created":"2009-08-06T11:01:56.931+0000","updated":"2009-08-06T11:01:56.931+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4292/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06xdj:"}}
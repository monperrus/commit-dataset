{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12454997","self":"https://issues.apache.org/jira/rest/api/latest/issue/12454997","key":"ARIES-137","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310981","id":"12310981","key":"ARIES","name":"Aries","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310981&avatarId=10065","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310981&avatarId=10065","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310981&avatarId=10065","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310981&avatarId=10065"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10520","id":"10520","description":"Apache Aries","name":"Aries"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314792","id":"12314792","description":"","name":"0.1","archived":true,"released":true,"releaseDate":"2010-05-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-02-02 09:53:03.666","customfield_12312323":null,"customfield_12310420":"93751","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1451894065_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2010-02-18T20:07:12.170+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ARIES-137/watchers","watchCount":1,"isWatching":false},"created":"2010-02-02T00:48:58.105+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-02-24T16:43:57.564+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313176","id":"12313176","name":"JPA","description":"RFC 143 JPA Integration"}],"timeoriginalestimate":null,"description":"EntityManagerFactory only gets registered for a unit if a matching PersistenceProvider service\r\nis bound before the persistence bundle is added to the tracker.\r\n\r\nThe PersistenceBundleManager will only attempt to setup an EntityManagerFactoryManager \r\nfor the PersistenceProvider services available at the point when a persistence bundle \r\nis first detected and subsequently only tracks the persistence bundles that get matched with a Provider.\r\nAny Persistence bundle added to the tracker before a (suitable) PersistenceProvider is\r\navailable will never get matched with a provider.\r\n\r\nThe PersistenceBundleManager#addingProvider method should check for persistence bundles \r\nthat are not matched with a provider and attempt to resolve.\r\n\r\nOne possible solution would be that the addingBundle and setUpManager methods use a \r\nnull object style pattern (or similar) for the EntityManagerFactoryManager so that \r\ndetected persistence bundles without a matching provider are still tracked. \r\nWhen a provider service is then bound to the PersistenceBundleManager via addingProvider, \r\niterate through all tracked persistence bundles and attempt to match those that do \r\nnot have a valid EntityManagerFactoryManager associated.\r\n(Note: MultiBundleTracker does not expose the bundles tracked, but by exposing getBundles()\r\nfor above and also using getObject() where the EntityManagerFactoryManager is being returned\r\nthere probably wouldn't be any need for bundleToManagerMap and associated synchronization)\r\n\r\nAlso I think an ExecutorService should be used for the setUpManager calls rather \r\nthan this work being done on a framework event thread.\r\n\r\n(I don't have time right now to look at this properly, so somebody might want to have a \r\nlook/take this in the meantime)","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"167935","summary":"Lifecycle issues with PersistenceBundleManager","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=keano","name":"keano","emailAddress":"alantkeane at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alan Keane","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=keano","name":"keano","emailAddress":"alantkeane at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alan Keane","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":3,"total":3,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454997/comment/12828567","id":"12828567","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"body":"The lifecycle issues in this area are somewhat complicated, and as you suggest, I'm sure there are improvements on the current design.\r\n\r\nThere are two main issues associated with the Persistence bundle manager:\r\n\r\n1) Persistence bundle lifecycle\r\n  Any call into the EntityManagerFactoryManager may be re-entrant, as it is possible that the side effects of the persistence bundle state change will cause it to change state again. However, we should not be synchronizing when using the PersistenceProvider service or when registering the EntityManagerFactory in the service registry. To add further complexity, each EntityManagerFactory should only be created once (until it is closed).\r\n\r\n2) Persistence provider lifecyle\r\n Any update to the list of accessible persistence providers needs to be thread safe, and ensure that any EntityManagerFactory services are unregsistered synchronously by that thread. We also need to eliminate the race condition where a new persistence bundle becomes available simultaneously with the persistence provider being added or removed. As only one of these calls comes through the bundle tracker, and the bundle tracker holds no locks, we cannot guarantee any call to getObject() will return the correct value.\r\n\r\nTo answer the points raised by this JIRA\r\n\r\na) The PersistenceBundleManager#addingProvider method should check for persistence bundles that are not matched with a provider and attempt to resolve. \r\n\r\n     Yes, it should. I had plans to do this when I started, but not the time to implement them. I could start on this once I've finished some of the logging tidy up and itests.\r\n\r\nb) MultiBundleTracker does not expose the bundles tracked, but by exposing getBundles() for above and also using getObject() where the EntityManagerFactoryManager is being returned there probably wouldn't be any need for bundleToManagerMap and associated synchronization\r\n\r\n     I did not write the MultiBundleTracker, but I imagine that it is somewhat difficult to get an atomic snapshot of the bundles and objects tracked without completely re-writing BundleTracker. In any event, the real problem here is a race condition between a thread removing a provider and a thread creating an EntityManagerFactoryManager. Until some point after the addingBundle call has completed there will be no object returned by getObject(), this means that when the provider is removed we can't get an atomic view of the bundles that might be using that provider unless we keep that view ourselves. It would be nice if the Tracker could be used, but I can't see any way to make the threading work.\r\n\r\n\r\nc) Also I think an ExecutorService should be used for the setUpManager calls rather than this work being done on a framework event thread. \r\n\r\n  Is it possible to do this safely when the provider may disappear at any time? It may make more sense if we create the manager first, then assign a provider. Another big issue here is really that we need to make calls out to the ManagedPersistenceUnitInfoFactory, allowing plug-ins to customize the bundle in some way (for example by adding a fragment). This could be worth looking at in the future if we can avoid breaking anything.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"created":"2010-02-02T09:53:03.666+0000","updated":"2010-02-02T09:53:03.666+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454997/comment/12828589","id":"12828589","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=keano","name":"keano","emailAddress":"alantkeane at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alan Keane","active":true},"body":"I should have clarified that the ExecutorService I was suggesting would actually be a single thread pool executor .\r\nThis in effect would work as an ordered queue of tasks submitted in the order the events are received. Executing\r\nthese tasks (adding/removing both providers and persistence bundles) in order removes a lot of the synchronization \r\nproblems (such as provider removed before addingBundle completes or while state change is being processed)\r\n\r\nI didn't look closely at MultiBundleTracker but from what I have seen this delegates to an underlying framework BundleTracker\r\nso the current state / bundles tracked should be available there.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=keano","name":"keano","emailAddress":"alantkeane at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alan Keane","active":true},"created":"2010-02-02T10:41:31.673+0000","updated":"2010-02-02T10:41:31.673+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454997/comment/12835377","id":"12835377","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"body":"I have updated the PersistenceBundleManager to track managers with no persistence provider, and to attempt to assign them as providers become available","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"created":"2010-02-18T20:07:12.135+0000","updated":"2010-02-18T20:07:12.135+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ARIES-137/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0t3v3:"}}
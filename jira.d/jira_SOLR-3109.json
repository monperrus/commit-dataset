{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12541750","self":"https://issues.apache.org/jira/rest/api/latest/issue/12541750","key":"SOLR-3109","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310230","id":"12310230","key":"SOLR","name":"Solr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310230&avatarId=22151","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310230&avatarId=22151","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310230&avatarId=22151","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310230&avatarId=22151"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12319065","id":"12319065","description":"Major release after 3.5","name":"3.6","archived":false,"released":true,"releaseDate":"2012-04-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314992","id":"12314992","description":"Alpha release of 4.x series","name":"4.0-ALPHA","archived":false,"released":true,"releaseDate":"2012-07-03"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-02-08 08:09:54.579","customfield_12312323":null,"customfield_12310420":"227037","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_459817691_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-02-13T13:09:58.536+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-3109/watchers","watchCount":2,"isWatching":false},"created":"2012-02-08T05:26:20.914+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"labels":["patch","performance"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317876","id":"12317876","description":"Major release after 3.4","name":"3.5","archived":false,"released":true,"releaseDate":"2011-11-27"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314992","id":"12314992","description":"Alpha release of 4.x series","name":"4.0-ALPHA","archived":false,"released":true,"releaseDate":"2012-07-03"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-10T10:39:27.237+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12310674","id":"12310674","name":"search","description":"Query the search collection"}],"timeoriginalestimate":null,"description":"During the second phase of a group query, the collator sends a query to each of the shards.  The purpose of this query is for shards to respond with the doc ids that match the set of group ids returned from the first phase.  The problem is that it sends this second query to each shard multiple times.  Specifically, in an environment with n shards, each shard will be hit with an identical query n times during the second phase of query processing, resulting in O(_n_ ^2^) performance where _n_ is the number of shards.\r\n\r\nI have traced this bug down to a single line in {{TopGroupsShardRequestFactory.java}}, and I am attaching a patch. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"18129","summary":"group=true requests result in numerous redundant shard requests","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"64-bit Linux, sharded environment","customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":21,"total":21,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13203303","id":"13203303","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"body":"The patch changes this line of code in {{TopGroupsShardRequestFactory.java}}:\r\n{code}\r\nsreq.actualShards = new String[] {shard};\r\n{code}\r\nbecomes \r\n{code}\r\nsreq.shards = new String[] {shard};\r\n{code}\r\n\r\nTo see why this was a problem, look at {{SearchHandler.java}} line 249:\r\n{code}\r\nsreq.actualShards = sreq.shards // sets actualShards to null\r\nif (sreq.actualShards==ShardRequest.ALL_SHARDS ) { //ALL_SHARDS is null\r\n  sreq.actualShards = rb.shards; // every shard!\r\n}\r\n\r\n{code}\r\nThis sets actualShards to null, which means send the request to *every* shard.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"created":"2012-02-08T05:59:32.564+0000","updated":"2012-02-08T05:59:32.564+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13203353","id":"13203353","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"body":"That doesn't look good... Thanks for bringing this up!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"created":"2012-02-08T08:09:54.579+0000","updated":"2012-02-08T08:09:54.579+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13203990","id":"13203990","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"body":"I noticed that the distributed test failed with this patch. After some digging I found out that the TopGroupsShardResponseProcessor can't really deal with multiple ShardRequests... I've updated the patch so that only one ShardRequest is created by the TopGroupsShardRequestFactory. Test passes now and I don't see any redundant real http requests being generated. \r\n\r\nRussell can you confirm this as well?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"created":"2012-02-08T21:14:12.057+0000","updated":"2012-02-08T22:25:43.662+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13204065","id":"13204065","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"body":"Martijn, I also noticed that {{TopGroupsShardResponseProcessor}} can't deal with multiple ShardRequests (although it looks like it wouldn't be to hard to add this ability).  At any rate, your approach of returning a single ShardRequest containing all relevant shards sounds like the right one.  I went one step further and refactored {{TopGroupsShardRequestFactory.java}} because there was significant code duplication in the class's two primary methods.  \r\n\r\nIn my testing I also discovered a closely related problem.  The bug is in the data structure used to map search groups to the shards which contain them.  {{ResponseBuilder.searchGroupToShard}} assumes that a given search group only resides on one shard.  I could not find this assumption documented anywhere, nor can I find a reason such a restriction need be imposed.  This structure is populated by {{SearchGroupShardResponseProcessor}}.  There is a race condition there, wherein the last shard to report a search group will be assumed to be the only shard containing the search group.  This data structure is used in {{TopGroupsShardRequestFactory.createRequestForSpecificShards()}} to know which shards to query.  This means you can get a different set of shards to query depending on shard query order.  \r\n\r\nI have changed the structure to allow a search group to be present in multiple shards.  \r\n\r\nPatch to follow.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"created":"2012-02-08T22:34:39.837+0000","updated":"2012-02-08T22:47:23.400+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13204362","id":"13204362","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"body":"Thanks for the refactoring!\r\n\r\n{quote}\r\nThe bug is in the data structure used to map search groups to the shards which contain them. ResponseBuilder.searchGroupToShard assumes that a given search group only resides on one shard. I could not find this assumption documented anywhere, nor can I find a reason such a restriction need be imposed.\r\n{quote}\r\nThere is no such restriction. A search group can reside on more than one shard. I wonder why this issue didn't result in test failure / bugs from the beginning. I guess b/c of the redundant requests all shards were queried and this way the end result was still correct. At least the latest patch I added should have resulted in a test failure but it didn't. Can you share how you did this testing? This can then be added to the TestDistributedGrouping test class.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"created":"2012-02-09T08:38:22.564+0000","updated":"2012-02-09T09:11:11.597+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13204533","id":"13204533","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"body":"The current {{TestDistributedGrouping}} test case is constructed in such a way that each record has a unique value for it's search group field ({{i1}}), so that there is never more than one record in any given search group.  This style of indexing conforms to the restriction discussed earlier.  This is likely the reason there were no test failures.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"created":"2012-02-09T14:01:53.498+0000","updated":"2012-02-09T16:06:40.402+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13204612","id":"13204612","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"body":"Yes, that might be the reason. The {{TestDistributedGrouping}} needs to be changed, so that a search group contains multiple records.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"created":"2012-02-09T16:12:08.602+0000","updated":"2012-02-09T16:12:08.602+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13204653","id":"13204653","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"body":"In {{TestDistributedGrouping}} you wrote the following comment:\r\n\r\n{code}\r\n // In order to validate this we need to make sure that during indexing that all documents of one group only occur on the same shard\r\n{code}\r\n\r\nI wanted to understand the reason for that comment before making any changes to the test case.  (Assuming you wanted me to update the test case -- if not, I'll leave the test case in your hands)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"created":"2012-02-09T17:04:27.800+0000","updated":"2012-02-09T17:04:27.800+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13204737","id":"13204737","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"body":"No worries :-) I didn't want to move this work to anyone. Just wanted to say that the test needs to be updated.\r\n\r\nI put that comment b/c in the following three lines group.ngroups and group.truncate features are tested. These features *only* work properly if documents belonging to a group reside in the same shard. If documents belonging to a group do occur in more than one shard then the results are very likely incorrect.\r\n\r\nTomorrow I will update the test case and get this patch committed. If you want to update the test case and have time for that that would be great!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"created":"2012-02-09T18:55:20.393+0000","updated":"2012-02-09T18:55:20.393+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13204745","id":"13204745","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"body":"I'll let you do the test case, as I don't have a lot of time to spend on this.  If there is a possibility of another 3.x release, I would like to backport the patch the 3x branch as well.  Let me know, and I can create the 3x backport once you have updated the test case and have your final 4.0 patch.  I have already created a 3_5 backport that we will be using internally until the next release.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"created":"2012-02-09T19:09:28.306+0000","updated":"2012-02-09T19:09:28.306+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13204773","id":"13204773","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"body":"You can share your 3.5 patch as you have it now. I think that applying the test changes to 3x branch isn't much effort.\r\nAs far as I know there will be a 3.6 release, so this bug fix will also be included in the this release. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"created":"2012-02-09T19:41:40.387+0000","updated":"2012-02-09T19:41:40.387+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13204778","id":"13204778","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"body":"Russell, when attaching a patch can you click on the option box with the label:\r\nGrant license to ASF for inclusion in ASF works \r\n\r\nAssuming that you want to include your bug fixes to Solr.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"created":"2012-02-09T19:46:49.777+0000","updated":"2012-02-09T19:46:49.777+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13204841","id":"13204841","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cyoung","name":"cyoung","emailAddress":"cody_y at shaw dot ca","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Cody Young","active":true},"body":"{quote}\r\nThe bug is in the data structure used to map search groups to the shards which contain them. ResponseBuilder.searchGroupToShard assumes that a given search group only resides on one shard. I could not find this assumption documented anywhere, nor can I find a reason such a restriction need be imposed.\r\n{quote}\r\n\r\nPerhaps this could be left in as an advanced option. It would be a performance boost for anyone who can guarantee that a group will reside wholly on a single shard.\r\n\r\ngroup.distributeGroupCollation=true|false defaults to true","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cyoung","name":"cyoung","emailAddress":"cody_y at shaw dot ca","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Cody Young","active":true},"created":"2012-02-09T20:48:09.723+0000","updated":"2012-02-09T20:48:09.723+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13204862","id":"13204862","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"body":"{quote}\r\nPerhaps this could be left in as an advanced option. It would be a performance boost for anyone who can guarantee that a group will reside wholly on a single shard.\r\n\r\ngroup.distributeGroupCollation=true|false defaults to true\r\n{quote}\r\n\r\nAs the patch currently stands, someone who can guarantee that a group will reside wholly on a single shard will benefit already because it will only send the query the shard that contains the group of interest.  There would be no need to have a separate advanced option.  I simply made the data structure allow for the _possibility_ of having multiple shards per group, but there is no additional overhead for the single-shard case.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"created":"2012-02-09T20:58:32.159+0000","updated":"2012-02-09T21:00:01.857+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13204886","id":"13204886","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gbowyer%40fastmail.co.uk","name":"gbowyer@fastmail.co.uk","emailAddress":"gbowyer at fastmail dot co dot uk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gbowyer%40fastmail.co.uk&avatarId=10420","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gbowyer%40fastmail.co.uk&avatarId=10420","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gbowyer%40fastmail.co.uk&avatarId=10420","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gbowyer%40fastmail.co.uk&avatarId=10420"},"displayName":"Greg Bowyer","active":true},"body":"Since I need to test this to see if it is responsible for my large profiler costs spent in scoring and grouping I also backported this\r\n\r\nPatch attached that does a backport to Solr 3.5 +\r\n\r\nIf my patch is terrifying please scream at me and replace it with a better one, but I figure it will be much the one already commented on.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gbowyer%40fastmail.co.uk","name":"gbowyer@fastmail.co.uk","emailAddress":"gbowyer at fastmail dot co dot uk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gbowyer%40fastmail.co.uk&avatarId=10420","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gbowyer%40fastmail.co.uk&avatarId=10420","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gbowyer%40fastmail.co.uk&avatarId=10420","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gbowyer%40fastmail.co.uk&avatarId=10420"},"displayName":"Greg Bowyer","active":true},"created":"2012-02-09T21:21:20.765+0000","updated":"2012-02-09T21:21:20.765+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13204973","id":"13204973","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"body":"Greg, I had some trouble applying your patch to my code base, although visually it looks like the right changes.  Is your patch intended for the 3_5 branch or 3x branch?  I have attached my own version of the patch.  It is a patch against the 3.5 branch (http://svn.apache.org/repos/asf/lucene/dev/branches/lucene_solr_3_5/).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"created":"2012-02-09T22:40:53.317+0000","updated":"2012-02-09T22:45:32.493+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13205088","id":"13205088","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gbowyer%40fastmail.co.uk","name":"gbowyer@fastmail.co.uk","emailAddress":"gbowyer at fastmail dot co dot uk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gbowyer%40fastmail.co.uk&avatarId=10420","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gbowyer%40fastmail.co.uk&avatarId=10420","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gbowyer%40fastmail.co.uk&avatarId=10420","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gbowyer%40fastmail.co.uk&avatarId=10420"},"displayName":"Greg Bowyer","active":true},"body":"Its for the 3.5 branch, but like I said I was jumping the gun, if your patch applies forget mine and go with that","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gbowyer%40fastmail.co.uk","name":"gbowyer@fastmail.co.uk","emailAddress":"gbowyer at fastmail dot co dot uk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gbowyer%40fastmail.co.uk&avatarId=10420","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gbowyer%40fastmail.co.uk&avatarId=10420","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gbowyer%40fastmail.co.uk&avatarId=10420","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gbowyer%40fastmail.co.uk&avatarId=10420"},"displayName":"Greg Bowyer","active":true},"created":"2012-02-10T00:14:28.978+0000","updated":"2012-02-10T00:14:28.978+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13205513","id":"13205513","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"body":"Re-uploaded the same 4.0 patch as before, this time with \"Grant license to ASF\" checked.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"created":"2012-02-10T15:48:27.634+0000","updated":"2012-02-10T15:48:27.634+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13206571","id":"13206571","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"body":"{quote}\r\nThe current TestDistributedGrouping test case is constructed in such a way that each record has a unique value for it's search group field (i1), so that there is never more than one record in any given search group. This style of indexing conforms to the restriction discussed earlier. This is likely the reason there were no test failures.\r\n{quote}\r\nI think this issue doesn't exist in the released versions of Solr / 4.0-dev. Due to the bug that all shards were queried for each ShardRequest instance and all the matching top search groups still arrived at the right shard. Only after applying the changes to TopGroupsShardRequestFactory I could let the distributed grouping test fail.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"created":"2012-02-13T00:14:03.496+0000","updated":"2012-02-13T00:14:03.496+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13206575","id":"13206575","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"body":"Committed to branch3x and trunk.\r\nThanks Russell and Greg for reporting and fixing this issue!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=martijn.v.groningen","name":"martijn.v.groningen","emailAddress":"martijn dot v dot groningen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=martijn.v.groningen&avatarId=15048","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=martijn.v.groningen&avatarId=15048","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=martijn.v.groningen&avatarId=15048","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=martijn.v.groningen&avatarId=15048"},"displayName":"Martijn van Groningen","active":true},"created":"2012-02-13T00:15:51.627+0000","updated":"2012-02-13T00:15:51.627+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12541750/comment/13206588","id":"13206588","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"body":"Thanks for the quick turnaround on this! It was fun to contribute.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rblack","name":"rblack","emailAddress":"black dot russell at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Russell Black","active":true},"created":"2012-02-13T00:35:27.507+0000","updated":"2012-02-13T00:35:27.507+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-3109/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i03gn3:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12406103","self":"https://issues.apache.org/jira/rest/api/latest/issue/12406103","key":"DERBY-3904","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313401","id":"12313401","description":"Head of 10.4 branch","name":"10.4.2.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2008-10-09 18:10:20.657","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23911","customfield_12310222":"1_*:*_1_*:*_1583805828_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-10-28T01:53:19.955+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3904/watchers","watchCount":0,"isWatching":false},"created":"2008-10-09T17:56:34.127+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10920","id":"10920","description":"initial source drop","name":"10.0.2.0","archived":false,"released":true,"releaseDate":"2004-08-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/10991","id":"10991","description":"snapshot","name":"10.0.2.1","archived":false,"released":true,"releaseDate":"2004-12-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12310615","id":"12310615","description":"","name":"10.1.2.1","archived":false,"released":true,"releaseDate":"2005-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312876","id":"12312876","description":"","name":"10.3.2.1","archived":false,"released":true,"releaseDate":"2007-12-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313142","id":"12313142","description":"","name":"10.3.3.0","archived":false,"released":true,"releaseDate":"2008-05-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313345","id":"12313345","description":"","name":"10.4.2.0","archived":false,"released":true,"releaseDate":"2008-09-05"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-07-13T19:16:52.562+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"Stanislav Bryzgalov reported that the following script raises an NPE on the last query (a left join involving an aggregate). I have verified this in my environment:\n\ndrop table t1;\ndrop table t2;\n\n-- create two simple tables\nCREATE TABLE T1( D1 DATE NOT NULL PRIMARY KEY, N1 VARCHAR( 10 ) );\nCREATE TABLE T2( D2 DATE NOT NULL PRIMARY KEY, N2 VARCHAR( 10 ) );\n\n-- insert some data, two recs in T1 and one in T2\nINSERT INTO T1 VALUES( DATE( '2008-10-01' ), 'something' ), ( DATE( '2008-10-02' ), 'something' );\nINSERT INTO T2 VALUES( DATE( '2008-10-01' ), 'something' );\n\n-- this runs fine, gives one record '2008-10-02'\nSELECT T1.D1\n  FROM T1\n  LEFT JOIN T2\n  ON T1.D1 = T2.D2\n  WHERE T2.D2 IS NULL;\n   \n-- this runs fine too, gives one record '2008-10-02'  \nSELECT MAX( T1.D1 ) as D\n  FROM T1\n  WHERE T1.D1 NOT IN ( SELECT T2.D2 FROM T2 );\n\n-- this one breaks!!!\n-- SQL State = XJ001 SQL Code = -1 SQL Message = DERBY SQL error: SQLCODE: -1, SQLSTATE: XJ001, SQLERRMC: java.lang.NullPointerException\nSELECT MAX( T1.D1 ) AS D\n  FROM T1\n  LEFT JOIN T2\n  ON T1.D1 = T2.D2\n  WHERE T2.D2 IS NULL;\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37949","summary":"NPE on left join with aggregate","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10422","value":"High Value Fix","id":"10422"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":12,"total":12,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12406103/comment/12638351","id":"12638351","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Here is the trace. This reproduces back to 10.0 so does not appear to be a regression.\r\n\r\n\r\nERROR XJ001: Java exception: ': java.lang.NullPointerException'.\r\njava.sql.SQLException: Java exception: ': java.lang.NullPointerException'.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:95)\r\n        at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:87)\r\n        at org.apache.derby.impl.jdbc.Util.javaException(Util.java:244)\r\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:403)\r\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:346)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2201)\r\n        at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:81)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:614)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:555)\r\n        at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:329)\r\n        at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:508)\r\n        at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:350)\r\n        at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:248)\r\n        at org.apache.derby.impl.tools.ij.Main.go(Main.java:215)\r\n        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:181)\r\n        at org.apache.derby.impl.tools.ij.Main.main(Main.java:73)\r\n        at org.apache.derby.tools.ij.main(ij.java:59)\r\nCaused by: java.sql.SQLException: Java exception: ': java.lang.NullPointerException'.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory40.java:11\r\n9)\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:70)\r\n        ... 16 more\r\n\r\nCaused by: java.lang.NullPointerException\r\n        at org.apache.derby.impl.sql.compile.GroupByNode.considerPostOptimizeOptimizations(GroupByNode.java:1194)\r\n        at org.apache.derby.impl.sql.compile.SelectNode.genProjectRestrict(SelectNode.java:1314)\r\n        at org.apache.derby.impl.sql.compile.SelectNode.modifyAccessPaths(SelectNode.java:1973)\r\n        at org.apache.derby.impl.sql.compile.DMLStatementNode.optimizeStatement(DMLStatementNode.java:307)\r\n        at org.apache.derby.impl.sql.compile.CursorNode.optimizeStatement(CursorNode.java:515)\r\n        at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.java:365)\r\n        at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:88)\r\n        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(GenericLanguageConne\r\nctionContext.java:796)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:606)\r\n        ... 9 more","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-10-09T18:10:20.657+0000","updated":"2008-10-09T18:10:20.657+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12406103/comment/12640857","id":"12640857","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"This is an interesting query. The first thing I noticed is that the stack trace occurs\r\nin GROUP BY processing, but the query does not specify a GROUP BY. \r\n\r\nI suppose that the presence of the MAX() aggregate in the select list is\r\nintroducing a GROUP BY processing of the data behind the scenes.\r\n\r\nMy guess is that this implicit GROUP BY doesn't have some of the data structures\r\nset up the way it expects. I'll have a more thorough look at the code.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2008-10-19T18:07:35.031+0000","updated":"2008-10-19T18:07:35.031+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12406103/comment/12640859","id":"12640859","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"GroupByNode.considerPostOptimizeOptimizations() is examining the query\r\nto see if it can perform a very special optimization involving a MIN or MAX query\r\non an indexed column, in which case we may be able to go directly to \r\nthe row with the MIN or MAX value by way of the index. The routine wants to\r\ncheck that:\r\n\r\n        /* Consider the optimization for min with asc index on that column or\r\n         * max with desc index on that column:\r\n         *  o  No group by\r\n         *  o  One of:\r\n         *      o  min/max(ColumnReference) is only aggregate && source is\r\n         *         ordered on the ColumnReference\r\n         *      o  min/max(ConstantNode)\r\n         * The optimization of the other way around (min with desc index or\r\n         * max with asc index) has the same restrictions with the additional\r\n         * temporary restriction of no qualifications at all (because\r\n         * we don't have true backward scans).\r\n         */\r\n\r\nSince T1.D1 is the PRIMARY KEY of the table, the result of the join is in fact\r\nordered on T1.D1.\r\n\r\nSo we examine the access path to learn more about the key columns in\r\nthe index that will be used.\r\n\r\nThere is a comment at this point:\r\n\r\n /* Check if we have an access path, this will be\r\n  * null in a join case (See Beetle 4423)\r\n  */\r\n\r\nHowever, even though we are in a join case, the access path is NOT null;\r\nrather it is a valid AccessPathImpl with a NULL conglomerate descriptor,\r\nand a non-null join strategy.\r\n\r\nSo then we hit the code:\r\n\r\n  AccessPath accessPath= getTrulyTheBestAccessPath();\r\n  if (accessPath == null)\r\n      return;\r\n  IndexDescriptor id = accessPath.\r\n                      getConglomerateDescriptor().\r\n                      getIndexDescriptor();\r\n  int[] keyColumns = id.baseColumnPositions();\r\n\r\nand the \"if (accessPath == null)\" test fails, since the accessPath is not null,\r\nbut the dereference to fetch the IndexDescriptor gets a NPE on the\r\nreturn from getConglomerateDescriptor().\r\n\r\nIt seems that the code expected that it would not run that line for\r\nan access path with a join strategy, but the check for a null\r\naccess path isn't working to catch that case.\r\n\r\nI'm wondering if I could improve that \"if\" test to be:\r\n\r\n  if (accessPath == null || accessPath.getJoinStrategy() != null)\r\n\r\nbut I need to study AccessPathImpl some more and see under what\r\ncircumstances it has a non-null join strategy.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2008-10-19T18:35:58.620+0000","updated":"2008-10-19T18:35:58.620+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12406103/comment/12640860","id":"12640860","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Anybody have access to the old tracker and can look up Beetle 4423?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2008-10-19T18:36:58.434+0000","updated":"2008-10-19T18:36:58.434+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12406103/comment/12640875","id":"12640875","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Beetle 4423 had summary:\r\n\r\nNullPointerException returned by max() aggregate function called on a column with an index in a join\r\n\r\nDescription:\r\nIf you call the max() aggregate function on a join statement \r\nwhere the column has an index as shown below:\r\nselect max(city_id)\r\n from cities c1, countries c2\r\n where \r\n  c1.city_id = 999\r\n\r\nJava.lang.NullPointerException is thrown.\r\n\r\nComment:\r\n The problem is that in \r\nattempting to determine whether we can optimize the execution \r\nof the query by looking at the index for the max or min we \r\ndon't check that the result set is coming directly from a base \r\ntable (i.e. has an index)or has been derived in some way in \r\nthis case from a join\r\n\r\nThe fix added the if condition to return if the accessPath was null\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-10-19T20:57:33.731+0000","updated":"2008-10-19T20:57:33.731+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12406103/comment/12640889","id":"12640889","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Hi Kathey, thanks for the info, that is very helpful.\r\n\r\nAdjusting the \"if\" statement as I surmised in my previous comment\r\ndoes seem to make the repro script pass.\r\n\r\nI'll try working up a more complete patch proposal for more testing.\r\n\r\nOne thing concerns me; we need to have a regression test which \r\nverifies that the Min/Max optimization feature is working correctly.\r\nI'll have to look to see if this information is available in the query\r\nplan and/or in the runtime statistics, and whether we can use those\r\nto fashion a regression test.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2008-10-20T00:09:46.485+0000","updated":"2008-10-20T00:09:46.485+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12406103/comment/12641270","id":"12641270","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"I don't think my proposed fix is correct, because in the statement:\r\n\r\n  select max(d1) from t1\r\n\r\nwhen I get to GroupByNode.considerPostOptimizeOptimizations,\r\naccessPath.getJoinStrategy() is non-null (the actual value is\r\na NestedLoopJoinStrategy).\r\n\r\nThis is not what I expected, and means that the proposed \"if\"\r\nstatement would interfere with the special optimization.\r\n\r\nMore study is needed.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2008-10-21T05:03:38.515+0000","updated":"2008-10-21T05:03:38.515+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12406103/comment/12641879","id":"12641879","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"One way to verify whether or not the Min/Max optimization\r\nfeature is working properly is to use the RuntimeStatistics\r\nor queryplan logging functionality to verify that\r\n\r\n  select max(d1) from t1\r\n\r\nconstructs a \"Last Key Index Scan ResultSet\" in its chosen plan.\r\n\r\nHere's an example of queryplan output which appears to\r\nindicate that the optimization is working properly:\r\n\r\n2008-10-22 14:28:58.696 GMT Thread[main,5,main] (XID = 214), (SESSIONID = 1), select max(d1) from t1\r\n ******* \r\nProject-Restrict ResultSet (4):\r\nNumber of opens = 1\r\nRows seen = 1\r\nRows filtered = 0\r\nrestriction = false\r\nprojection = true\r\n    constructor time (milliseconds) = 0\r\n    open time (milliseconds) = 0\r\n    next time (milliseconds) = 0\r\n    close time (milliseconds) = 0\r\n    restriction time (milliseconds) = 0\r\n    projection time (milliseconds) = 0\r\n    optimizer estimated row count:            1.00\r\n    optimizer estimated cost:           20.17\r\n\r\nSource result set:\r\n    Scalar Aggregate ResultSet:\r\n    Number of opens = 1\r\n    Rows input = 1\r\n        constructor time (milliseconds) = 0\r\n        open time (milliseconds) = 0\r\n        next time (milliseconds) = 0\r\n        close time (milliseconds) = 0\r\n        optimizer estimated row count:            7.00\r\n        optimizer estimated cost:           20.17\r\n\r\n    Index Key Optimization = true\r\n    Source result set:\r\n        Project-Restrict ResultSet (3):\r\n        Number of opens = 1\r\n        Rows seen = 1\r\n        Rows filtered = 0\r\n        restriction = false\r\n        projection = true\r\n            constructor time (milliseconds) = 0\r\n            open time (milliseconds) = 0\r\n            next time (milliseconds) = 0\r\n            close time (milliseconds) = 0\r\n            restriction time (milliseconds) = 0\r\n            projection time (milliseconds) = 0\r\n            optimizer estimated row count:            7.00\r\n            optimizer estimated cost:           20.17\r\n\r\n        Source result set:\r\n            Last Key Index Scan ResultSet for T1 using index SQL081019111017690at read committed isolation level using share row locking chosen by the optimizer\r\n            Number of opens = 1\r\n            Rows seen = 1\r\n                constructor time (milliseconds) = 0\r\n                open time (milliseconds) = 0\r\n                next time (milliseconds) = 0\r\n                close time (milliseconds) = 0\r\n                next time in milliseconds/row = 0\r\n\r\n                optimizer estimated row count:            7.00\r\n                optimizer estimated cost:           20.17\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2008-10-22T14:35:57.711+0000","updated":"2008-10-22T14:35:57.711+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12406103/comment/12642051","id":"12642051","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Here's a first patch proposal. It includes regression tests\r\nin GroupByTest, and a simple proposed fix to GroupByNode,\r\nto check the accessPath object more carefully before trying\r\nto use it for the last key index scan optimization.\r\n\r\nI haven't yet run the complete regression suite, just posting\r\nthis patch proposal now to get some early feedback.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2008-10-23T04:56:12.407+0000","updated":"2008-10-23T04:56:12.407+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12406103/comment/12642159","id":"12642159","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Regression test run was clean.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2008-10-23T13:34:53.952+0000","updated":"2008-10-23T13:34:53.952+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12406103/comment/12642793","id":"12642793","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Committed to the trunk as revision 708002. I'll investigate \r\nmerging this back to the 10.4 branch if no additional problems\r\nshow up in the trunk.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2008-10-26T15:07:55.385+0000","updated":"2008-10-26T15:07:55.385+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12406103/comment/12643115","id":"12643115","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Merged fix to the 10.4 branch with revision 708413.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2008-10-28T01:53:19.836+0000","updated":"2008-10-28T01:53:19.836+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3904/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06uyf:"}}
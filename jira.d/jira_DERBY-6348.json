{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12669236","self":"https://issues.apache.org/jira/rest/api/latest/issue/12669236","key":"DERBY-6348","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326659","id":"12326659","description":"candidate for Second release for 10.10 branch","name":"10.10.2.0","archived":false,"released":true,"releaseDate":"2014-04-15"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324243","id":"12324243","description":"First release on the 10.11 branch","name":"10.11.1.1","archived":false,"released":true,"releaseDate":"2014-08-26"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2013-10-25 13:05:36.939","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"349168","customfield_12310222":"3_*:*_1_*:*_1307590730_*|*_1_*:*_1_*:*_3698008718_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2013-11-15T10:43:29.326+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-6348/watchers","watchCount":4,"isWatching":false},"created":"2013-09-18T12:16:49.911+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313727","id":"12313727","description":"Feature release","name":"10.6.1.0","archived":false,"released":true,"releaseDate":"2010-05-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315564","id":"12315564","description":"First release on the 10.7 branch.","name":"10.7.1.1","archived":false,"released":true,"releaseDate":"2010-12-14"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316362","id":"12316362","description":"First release on the 10.8 branch","name":"10.8.1.2","archived":false,"released":true,"releaseDate":"2011-04-29"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321550","id":"12321550","description":"First release on the 10.10 branch","name":"10.10.1.1","archived":false,"released":true,"releaseDate":"2013-04-15"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12375433","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12375433","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12313741","key":"DERBY-534","self":"https://issues.apache.org/jira/rest/api/2/issue/12313741","fields":{"summary":"Support use of the WHEN clause in CREATE TRIGGER statements","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}},{"id":"12375432","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12375432","type":{"id":"12310050","name":"Regression","inward":"is broken by","outward":"breaks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310050"},"inwardIssue":{"id":"12405638","key":"DERBY-3897","self":"https://issues.apache.org/jira/rest/api/2/issue/12405638","fields":{"summary":"SQLSessionContext not correctly initialized in some non-method call nested contexts","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-01-21T00:23:45.262+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"With 10.5.1.1 and newer, the following ij session fails with a NullPointerException (production jars) or an assert failure (debug jars):\r\n\r\nij version 10.10\r\nij> connect 'jdbc:derby:db;create=true';\r\nij> create table t(x int);\r\n0 rows inserted/updated/deleted\r\nij> insert into t values 0;\r\n1 row inserted/updated/deleted\r\nij> create trigger tr1 after update on t values 1;\r\n0 rows inserted/updated/deleted\r\nij> create trigger tr2 after update on t for each row update t set x = x + 1 where x < 3;\r\n0 rows inserted/updated/deleted\r\nij> update t set x = x + 1;\r\nERROR XJ001: Java exception: ': java.lang.NullPointerException'.\r\n\r\nIt does not fail on 10.4.2.0:\r\n\r\nij version 10.4\r\nij> connect 'jdbc:derby:db;create=true';\r\nij> create table t(x int);\r\n0 rows inserted/updated/deleted\r\nij> insert into t values 0;\r\n1 row inserted/updated/deleted\r\nij> create trigger tr1 after update on t values 1;\r\n0 rows inserted/updated/deleted\r\nij> create trigger tr2 after update on t for each row update t set x = x + 1 where x < 3;\r\n0 rows inserted/updated/deleted\r\nij> update t set x = x + 1;\r\n1 row inserted/updated/deleted\r\nij> select * from t;\r\nX          \r\n-----------\r\n3          \r\n\r\n1 row selected","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10420","value":"Regression","id":"10420"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"349466","summary":"NPE or assert failure in recursive trigger","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10424","value":"Repro attached","id":"10424"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":13,"total":13,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12669236/comment/13770720","id":"13770720","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"It only seems to happen if one of the triggers that fire before the recursive trigger, has a trigger action that returns rows. See the TR1 trigger in the repro, where the trigger action is VALUES 1.\r\n\r\nThat particular trigger is of course rather pointless, but there are use cases where it makes sense to have a VALUES statement in the trigger action. For instance, the first example in the reference manual's CREATE TRIGGER statement topic shows how to call a function with side-effects from a trigger action using a VALUES statement.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-09-18T12:29:14.363+0000","updated":"2013-09-18T12:29:14.363+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12669236/comment/13770723","id":"13770723","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Full stack trace for the assert failure on trunk:\r\n\r\n{noformat}\r\norg.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED Expected sqlSessionContextForChildren to be non-null\r\n        at org.apache.derby.shared.common.sanity.SanityManager.ASSERT(SanityManager.java:120)\r\n        at org.apache.derby.impl.sql.execute.BaseActivation.getSQLSessionContextForChildren(BaseActivation.java:1396)\r\n        at org.apache.derby.impl.sql.execute.BaseActivation.setupSQLSessionContextForChildren(BaseActivation.java:1419)\r\n        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.setupSessionContextMinion(GenericLanguageConnectionContext.java:3694)\r\n        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.setupSubStatementSessionContext(GenericLanguageConnectionContext.java:3764)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.executeSubStatement(GenericPreparedStatement.java:306)\r\n        at org.apache.derby.impl.sql.execute.GenericTriggerExecutor.executeSPS(GenericTriggerExecutor.java:209)\r\n        at org.apache.derby.impl.sql.execute.StatementTriggerExecutor.fireTrigger(StatementTriggerExecutor.java:85)\r\n        at org.apache.derby.impl.sql.execute.TriggerEventActivator.notifyEvent(TriggerEventActivator.java:272)\r\n        at org.apache.derby.impl.sql.execute.UpdateResultSet.fireAfterTriggers(UpdateResultSet.java:739)\r\n        at org.apache.derby.impl.sql.execute.UpdateResultSet.open(UpdateResultSet.java:279)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:438)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.executeSubStatement(GenericPreparedStatement.java:308)\r\n        at org.apache.derby.impl.sql.execute.GenericTriggerExecutor.executeSPS(GenericTriggerExecutor.java:209)\r\n        at org.apache.derby.impl.sql.execute.RowTriggerExecutor.fireTrigger(RowTriggerExecutor.java:116)\r\n        at org.apache.derby.impl.sql.execute.TriggerEventActivator.notifyEvent(TriggerEventActivator.java:272)\r\n        at org.apache.derby.impl.sql.execute.UpdateResultSet.fireAfterTriggers(UpdateResultSet.java:739)\r\n        at org.apache.derby.impl.sql.execute.UpdateResultSet.open(UpdateResultSet.java:279)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:438)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:319)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1337)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:704)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:631)\r\n        at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:367)\r\n        at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:527)\r\n        at org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:369)\r\n        at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:245)\r\n        at org.apache.derby.impl.tools.ij.Main.go(Main.java:229)\r\n        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:184)\r\n        at org.apache.derby.impl.tools.ij.Main.main(Main.java:75)\r\n        at org.apache.derby.tools.ij.main(ij.java:59)\r\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-09-18T12:31:28.749+0000","updated":"2013-09-18T12:31:28.749+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12669236/comment/13770730","id":"13770730","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The failure is not seen prior to the following commit:\r\n\r\n------------------------------------------------------------------------\r\nr703295 | dag | 2008-10-10 01:53:03 +0200 (Fri, 10 Oct 2008) | 7 lines\r\n\r\nDERBY-3897 SQLSessionContext not correctly initialized in some non-method call nested contexts\r\n\r\nPatch derby-3897-3, which sets up the SQL session context correctly\r\nalso for substatements. See javadoc for\r\nLanguageConnectionContext#setupSubStatementSessionContext for an\r\nenumeration of these cases. Also adds test cases for this.\r\n\r\n------------------------------------------------------------------------","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-09-18T12:41:25.999+0000","updated":"2013-09-18T12:41:25.999+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12669236/comment/13770741","id":"13770741","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I originally noticed this when testing triggers with WHEN clauses in DERBY-534. Since the execution of the WHEN clause is essentially the same as the execution of a VALUES statement (in the sense that they are both expressions that return rows), a recursive trigger with a WHEN clause always triggers this bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-09-18T12:50:23.049+0000","updated":"2013-09-18T12:50:23.049+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12669236/comment/13805230","id":"13805230","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Can also be seen in non-recursive triggers. For example:\r\n\r\n{noformat}\r\nij> create table t(x int);\r\n0 rows inserted/updated/deleted\r\nij> create trigger tr1 after insert on t values 1;\r\n0 rows inserted/updated/deleted\r\nij> create trigger tr2 after insert on t values current_user;\r\n0 rows inserted/updated/deleted\r\nij> insert into t values 1;\r\nERROR 38000: The exception 'org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED Expected sqlSessionContextForChildren to be non-null' was thrown while evaluating an expression.\r\nERROR XJ001: Java exception: 'ASSERT FAILED Expected sqlSessionContextForChildren to be non-null: org.apache.derby.shared.common.sanity.AssertFailure'.\r\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-10-25T11:19:27.760+0000","updated":"2013-10-25T11:19:27.760+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12669236/comment/13805235","id":"13805235","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Inside of a trigger action, USER, CURRENT_USER and SESSION_USER return the name of the user that performed the operation that caused the trigger to fire. Is this correct? I thought maybe USER and CURRENT_USER were supposed to return the name of the user that owns the trigger, similar to how they work in procedures created with EXTERNAL SECURITY DEFINER.\r\n\r\nI'm asking because the assert failure seems to indicate there's a missing SQL session context, and I think USER and CURRENT_USER fetch the user name from the SQL session context, so the two observations may be related.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-10-25T11:28:48.590+0000","updated":"2013-10-25T11:28:48.590+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12669236/comment/13805282","id":"13805282","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Hi Knut,\r\n\r\nI think that the relevant sections of the SQL Standard are part 2, sections 4.38 (SQL-sessions), 4.39 (Triggers), and 11.49 (trigger definition).\r\n\r\nAll of the user/role related information is in the session context. There is a stack of session contexts. Each session context contains a stack of authorization contexts. Each session context also contains various execution contexts, including a statement execution context, a routine execution context, and a trigger execution context.\r\n\r\nAccording to section 4.38:\r\n\r\n\"The <value specification>s CURRENT_USER and CURRENT_ROLE identify the user name and role name on top of the authorization stack in the top of the stack of SQL-session contexts. The <value specification> SESSION_USER is the value of the SQL-session user identifier in the latest SQL-session execution context.\"\r\n\r\nI believe that the trigger execution context is a red-herring. That is because I don't see any user/role information in the trigger execution context. In addition, I do not see any language related to invoker vs. definer rights in 11.49 (trigger definition). In short, I'm not seeing any way that firing a trigger could push an authorization context or alter the current session user.\r\n\r\nThanks,\r\n-Rick\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2013-10-25T13:05:36.939+0000","updated":"2013-10-25T13:05:36.939+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12669236/comment/13805336","id":"13805336","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks, Rick. The reason why I thought CURRENT_USER might behave in a similar way in triggers as in procedures with definer rights, was that I found this sentence in [CREATE TRIGGER statement|http://db.apache.org/derby/docs/10.10/ref/rrefsqlj43125.html]:\r\n\r\n{quote}\r\nA trigger operates with the privileges of the owner of the trigger.\r\n{quote}\r\n\r\nAnd this paragraph in [Privileges on views, triggers, and constraints|http://db.apache.org/derby/docs/10.10/devguide/cdevcsecureprivileges.html]:\r\n\r\n{quote}\r\nAnother way of saying that privileges on objects belong to the owner is to call them definer rights, as opposed to invoker rights. This is the terminology used by the SQL standard.\r\n{quote}\r\n\r\nThe reference manual's topic on the [CURRENT_USER function|http://db.apache.org/derby/docs/10.10/ref/rrefsqlj42324.html] states clearly enough, though, that it's only within stored procedures with definers rights that it may return something different than SESSION_USER, so I think you're right that it's a red herring.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-10-25T14:27:08.804+0000","updated":"2013-10-25T14:27:08.804+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12669236/comment/13806875","id":"13806875","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I think I see why it's failing now. All the triggers seem to be executed with the same statement context. DERBY-3897 changed GenericTriggerExecutor.executeSPS() so that the trigger gets executed with executeSubStatement() instead of executeStatement(). executeSubStatement() records the current activation in the statement context. So when the second trigger fires, the current statement context points to the activation of the first trigger's SPS instead of the activation of the statement that caused the trigger to fire. This inconsistency eventually causes the session context lookup to go to the wrong activation, which again causes the assert/NPE.\r\n\r\nI tried to reset the current statement context's activation each time we retrieve the activation for a trigger SPS, see the attached set-activation.diff. This seems to solve all the problem cases mentioned in this issue, and it also passes all existing regression tests.\r\n\r\nI'm not sure if this is the best fix for the problem, or if it would be better to push (and pop) a new statement context for each trigger that's being executed. I think pushing a new context is more risky, though, as GenericTriggerExecutor.executeSPS() has some code to clean up errors in lower-level statement contexts, and changing the context stack may break assumptions in that code.\r\n\r\nThe approach in the patch is less risky, I believe, as it just sets the statement context's activation temporarily. It will be overwritten once executeSubStatement() is called shortly after, so it should only affect the currently executing trigger. Also, all other callers of executeSubStatement() (that is, EmbedResultSet's insertRow(), updateRow() and deleteRow() methods) do the same trick and temporarily set the statement context's activation while creating the nested activation.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-10-28T16:06:38.030+0000","updated":"2013-10-28T16:06:38.030+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12669236/comment/13808863","id":"13808863","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attaching an updated patch that includes tests (set-activation-and-tests.diff).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-10-30T08:58:05.930+0000","updated":"2013-10-30T08:58:43.400+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12669236/comment/13809998","id":"13809998","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1537393 from [~knutanders] in branch 'code/trunk'\r\n[ https://svn.apache.org/r1537393 ]\r\n\r\nDERBY-6348: NPE or assert failure in recursive trigger\r\n\r\nReset the activation in the statement context before setting up the\r\nactivation for the next trigger, so that the nested trigger activation\r\nis a child of the top-level activation, and not a child of the\r\nprevious trigger's activation.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2013-10-31T07:30:26.148+0000","updated":"2013-10-31T07:30:26.148+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12669236/comment/13823534","id":"13823534","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1542220 from [~knutanders] in branch 'code/branches/10.10'\r\n[ https://svn.apache.org/r1542220 ]\r\n\r\nDERBY-6348: NPE or assert failure in recursive trigger\r\n\r\nMerged revision 1537393 from trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2013-11-15T10:43:44.267+0000","updated":"2013-11-15T10:43:44.267+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12669236/comment/14284854","id":"14284854","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"bulk change to close all issues resolved but not closed and not changed since June 1, 2014.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2015-01-21T00:23:45.252+0000","updated":"2015-01-21T00:23:45.252+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-6348/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1o7g7:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12619138","self":"https://issues.apache.org/jira/rest/api/latest/issue/12619138","key":"ARIES-982","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310981","id":"12310981","key":"ARIES","name":"Aries","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310981&avatarId=10065","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310981&avatarId=10065","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310981&avatarId=10065","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310981&avatarId=10065"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10520","id":"10520","description":"Apache Aries","name":"Aries"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-12-07 13:36:09.756","customfield_12312323":null,"customfield_12310420":"296332","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_105771489_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-12-07T20:27:00.942+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ARIES-982/watchers","watchCount":2,"isWatching":false},"created":"2012-12-06T15:04:09.472+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316139","id":"12316139","description":"","name":"0.4","archived":true,"released":false}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-12-07T20:27:00.959+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313494","id":"12313494","name":"Subsystem"}],"timeoriginalestimate":null,"description":"We're sometimes seeing a deadlock between one thread that's passed through\r\n\r\n4XESTACKTRACE                at org/apache/aries/subsystem/core/internal/SubsystemServiceRegistrar.register(SubsystemServiceRegistrar.java:69)\r\n5XESTACKTRACE                   (entered lock: org/apache/aries/subsystem/core/internal/SubsystemServiceRegistrar@0xD6FEEAA0, entry count: 1)\r\n4XESTACKTRACE                at org/apache/aries/subsystem/core/internal/SubsystemResourceInstaller.installAriesSubsystem(SubsystemResourceInstaller.java:96)\r\n4XESTACKTRACE                at org/apache/aries/subsystem/core/internal/SubsystemResourceInstaller.install(SubsystemResourceInstaller.java:40)\r\n4XESTACKTRACE                at org/apache/aries/subsystem/core/internal/Subsystems.getRootSubsystem(Subsystems.java:130)\r\n5XESTACKTRACE                   (entered lock: org/apache/aries/subsystem/core/internal/Subsystems@0xD6FEEAB0, entry count: 1)\r\n4XESTACKTRACE                at org/apache/aries/subsystem/core/internal/Activator.activate(Activator.java:167)\r\n4XESTACKTRACE                at org/apache/aries/subsystem/core/internal/Activator.addingService(Activator.java:263)\r\n5XESTACKTRACE                   (entered lock: org/apache/aries/subsystem/core/internal/Activator@0xD6C83A70, entry count: 1)\r\n\r\nand another, \r\n3XMTHREADINFO      \"Blueprint Extender: 2\" J9VMThread:0x083A9800, j9thread_t:0x087B373C, java/lang/Thread:0xD6346650, state:B, prio=5\r\n3XMTHREADINFO1            (native thread ID:0x770F, native priority:0x5, native policy:UNKNOWN)\r\n3XMTHREADINFO2            (native stack address range from:0xD0278000, to:0xD02B9000, size:0x41000)\r\n3XMTHREADBLOCK     Blocked on: org/apache/aries/subsystem/core/internal/Activator@0xD6C83A70 Owned by: \"Blueprint Extender: 3\" (J9VMThread:0x087D5D00, java/lang/Thread:0xD66F2280)\r\n3XMTHREADINFO3           Java callstack:\r\n4XESTACKTRACE                at org/apache/aries/subsystem/core/internal/BundleEventHook.handleExplicitlyInstalledBundleBundleContext(BundleEventHook.java:55)\r\n4XESTACKTRACE                at org/apache/aries/subsystem/core/internal/BundleEventHook.handleInstalledEvent(BundleEventHook.java:93)\r\n4XESTACKTRACE                at org/apache/aries/subsystem/core/internal/BundleEventHook.event(BundleEventHook.java:41)\r\n\r\nThe problem looks to be caused by the call to Activator.getInstance() within BundleEventHook.handleExplicitlyInstalledBundleBundleContext(). One option would be to move that call into the BundleEventHook() constructor. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"232858","summary":"Deadlock between Subsystems EventHook and Activator","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mnuttall","name":"mnuttall","emailAddress":"mnuttall at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mark Nuttall","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mnuttall","name":"mnuttall","emailAddress":"mnuttall at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mark Nuttall","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":2,"total":2,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12619138/comment/13526389","id":"13526389","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"body":"The crux of the issue is that something is reacting to the root subsystem service registration (i.e. the initialization of subsystems) by spawning a new thread that installs a bundle. That something then parks on a future waiting for the other thread to finish before continuing. The subsystem bundle event hook reacts to the bundle installation to ensure it gets assigned to the proper subsystem (i.e. isolation scope). However, the bundle event hook cannot proceed because the subsystems initialization has not completed. Even though there are two different threads involved, the deadlock still occurs because of the parking. No matter how fine grained the locking strategy becomes, it will always hit that point. I think the right solution is to let the subsystem event hook become aware of this situation. If events are received while subsystems is still initializing, they will be stored and handled asynchronously once initialization is complete. Otherwise, the events will continue to be handled synchronously.\r\n\r\nAnother (simpler) solution would have been to simply handle all events asynchronously in the hook; however, this causes 3 of the 243 OSGi CT tests to fail. I believe these tests are too strict, but it might take a while to convince the EEG of that, so I'll go with a solution that can be counted on for now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"created":"2012-12-07T13:36:09.756+0000","updated":"2012-12-07T13:36:57.376+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12619138/comment/13526745","id":"13526745","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"body":"Fixed in http://svn.apache.org/viewvc?view=revision&revision=1418462.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"created":"2012-12-07T20:27:00.957+0000","updated":"2012-12-07T20:27:00.957+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ARIES-982/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i148lz:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12330232","self":"https://issues.apache.org/jira/rest/api/latest/issue/12330232","key":"DERBY-1108","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311972","id":"12311972","description":"","name":"10.1.3.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-03-16 07:57:36.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22309","customfield_12310222":"1_*:*_1_*:*_12417706000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_2_*:*_9298777000_*|*_4_*:*_1_*:*_348000","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-11-20T15:54:41.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1108/watchers","watchCount":0,"isWatching":false},"created":"2006-03-14T08:29:52.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12312430","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12312430","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12333553","key":"DERBY-1320","self":"https://issues.apache.org/jira/rest/api/2/issue/12333553","fields":{"summary":"Test lang/procedure.java fails with ibm1.5 jvm","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-06-29T22:58:05.053+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11413","id":"11413","name":"Test"}],"timeoriginalestimate":null,"description":"The test  jdbcapi/setTransactionIsolation.java fails with ibmjvm15.  I think the cause of this failure is , the jvm is not throwing an exception while trying to change the transaction isolation when there is holdable cursor on  a resultset. Other jvms like sun jdk1.5, ibm142 throws the expected exception. while ibm15 does allow to change the transaction isolation when there is a hold cursor on a result set.\n\nAlready reported this issue with the ibmjvm people and they are looking in to it","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10369","value":"Regression Test Failure","id":"10369"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"38917","summary":"The test jdbcapi/setTransactionIsolation.java fails with ibm jvm1.5","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"java version \"1.5.0\"\nJava(TM) 2 Runtime Environment, Standard Edition (build pwi32dev-20051104)\nIBM J9 VM (build 2.3, J2RE 1.5.0 IBM J9 2.3 Windows XP x86-32 j9vmwi3223-2005110\n3 (JIT enabled)\nJ9VM - 20051027_03723_lHdSMR\nJIT  - 20051027_1437_r8\nGC   - 20051020_AA)\nJCL  - 20051102","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":16,"total":16,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12370576","id":"12370576","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"body":"The stack trace given by all other jvms other than ibm15 is like this :\r\n\r\nERROR X0X03: Invalid transaction state - held cursor requires same isolation lev\r\nel\r\n        at org.apache.derby.iapi.error.StandardException.newException(StandardEx\r\nception.java:301)\r\n        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.setIs\r\nolationLevel(GenericLanguageConnectionContext.java:2353)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.setTransactionIsolation(Em\r\nbedConnection.java:1163)\r\n        at test.main(test.java:57)\r\nnull\r\n \r\n\r\nDoes anybody know how to track down which JDBC call is causing the problem so that you can give that information to the jvm team working on the issue?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"created":"2006-03-16T03:54:43.000+0000","updated":"2006-03-16T03:54:43.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12370613","id":"12370613","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Yes. It is so much harder when the problem is that you are *not*  throwing the error.   You have to trace back through the code and figure out what return value was not the value  expected.   My line numbers don't match up to yours but presumably verifyAllHeldResultSetsAreClosed() is returning false instead of the expected true value.\r\n\r\nIf you look at verifyAllHeldResultSetsAreClosed() you can see it is relying on this gc:\r\n\r\n// There may be open ResultSet's that are yet to be garbage collected\r\n// let's try and force these out rather than throw an error\r\n\t\tSystem.gc();\r\n\t\tSystem.runFinalization();\r\n\r\nThat would be my first guess as to the cause of the trouble.  Probably this JVM is not garbage collecting the open resultsets in this case.\r\n\r\nIn your test case has the resultSet  been explicitly closed or was it left open with the expectation of garbage collection before the setTransaction isolation call?\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-03-16T07:57:36.000+0000","updated":"2006-03-16T07:57:36.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12370615","id":"12370615","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"body":"No, The test does not close the resultSet explicitly","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"created":"2006-03-16T08:04:13.000+0000","updated":"2006-03-16T08:04:13.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12370621","id":"12370621","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Actually maybe I had this backward. Maybe this JVM is being more agressive with the gc().   Anyway, if your resultset is still referenced and the error is supposed to be there,  start with commenting out that gc() call and go from there.  Good Luck!\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-03-16T08:26:25.000+0000","updated":"2006-03-16T08:26:25.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12370623","id":"12370623","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"body":"Yes Kathey, You are right. When I commented out the gc(), I got the exception. Will be informing the jvm people about this. Thanks for your valuable information","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"created":"2006-03-16T08:38:10.000+0000","updated":"2006-03-16T08:38:10.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12377443","id":"12377443","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"body":"I'm attaching a simple reproduction. But still there are some gray areas why ibm15 is not throwing the expected exception. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"created":"2006-05-03T01:04:15.000+0000","updated":"2006-05-03T01:04:15.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12416665","id":"12416665","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I told Manjula I would post the response from the IBM JVM Team and what I know about the issue.\r\n\r\nJVM TEAM RESPONSE:\r\n\r\nI don't believe this is a bug in the IBM JVM - we are legitimately clearing out objects that are no-longer referenced. The difference is that the IBM JVM at Java 5.0 is more agressive at doing this than it was previously.\r\nThe behaviour with  BEA JRockit 5.0 is the same.\r\n\r\nThe IBM Java 5.0 implementation now carries out \"escape analysis\" - this means that an Object becomes eligable for garbage collection after the last time it is used which can be before you would classically expect it to be \"out of scope\". Below is a pathological example :\r\n\r\nvoid testMethod{\r\n\r\n\tString myString = new String(\"MyString\");\r\n\tmyString.toLowercase();\r\n\tSystem.out.println(myString);\r\n\t\t\t\t\t\t\t<--- Under Java 5.0 myString is eligable for GC here\r\n\tfor (int i = 0; i < 10; i++){\r\n\t\tSystem.out.println(\"Count is \"+i);\r\n\t}\r\n}\r\n\t\t\t\t\t\t\t<-- Under previous versions, myString is eligable for GC here.\r\n\r\n\r\nWHAT KATHEY KNOWS ABOUT THE ISSUE\r\nFrom  the  behavior we were  seeing and the test case,  that we did not get an exception for this open result set, when setTransactionIsolation was called,   I was under the assumption that it was the ResultSet rs that was getting garbage collected but it must be something else.  Someone will have to take a close look at  what is getting garbage collected here and try to understand how it correlates to escape analysis.    I tried forcing gc() and then using the result set and it seemed to continue to be accessible and retrieve results normally.\r\n\r\nThe test code: \r\n\r\n\t\ttry {\r\n\t\t\t\r\n\t\t\tPreparedStatement ps = conn.prepareStatement(\"SELECT * from TAB1\");\r\n\t\t\tResultSet rs = ps.executeQuery();\r\n\t\t\trs.next();\r\n\t\t\t// setTransactionIsolation should fail because we have \r\n\t\t\t// a holdable cursor open\r\n\t\t\t// conn.setTransactionIsolation does a gc/finalization and then checks if there are open holdable result sets.\r\n                        // should fail because holdable result set is open.\r\n\t\t\t    conn.setTransactionIsolation(java.sql.Connection.TRANSACTION_SERIALIZABLE);  \r\n\t\t} catch (SQLException se)\r\n\t\t{\r\n\t\t\tSystem.out.println(\"EXPECTED EXCEPTION SQLSTATE:\" + \r\n\t\t\t\t\t\t\t   se.getSQLState() + \" \" +\r\n\t\t\t\t\t\t\t   se.getMessage());\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\r\n\r\nCode to check result set status in  GenericLanguageConnectionContext, called as part of setTransactionIsolation: (Removing this gc causes setTransactionIsolation to fail as expected. )\r\n\r\n\r\n// There may be open ResultSet's that are yet to be garbage collected\r\n// let's try and force these out rather than throw an error\r\n\r\n\t\tSystem.gc();\r\n\t\tSystem.runFinalization();\r\n\r\n\r\n\t\t/* For every activation */\r\n\t\tfor (int i = acts.size() - 1; i >= 0; i--) {\r\n\t\t\t\t\r\n\t\t\tActivation a = (Activation) acts.elementAt(i);\r\n\r\n\t\t\tif (SanityManager.DEBUG)\r\n\t\t\t{\r\n\t\t\t\tSanityManager.ASSERT(a instanceof CursorActivation, \"a is not a CursorActivation\");\r\n\t\t\t}\r\n\r\n\t\t\tif (!a.isInUse())\r\n\t\t\t{\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (!a.getResultSetHoldability())\r\n\t\t\t{\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tResultSet rs = ((CursorActivation) a).getResultSet();\r\n\r\n\t\t\t/* is there an open held result set? */\r\n\t\t\tif ((rs != null) && !rs.isClosed() && rs.returnsRows())\r\n\t\t\t{\r\n\t\t\t\treturn(false);\r\n\t\t\t}\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-06-18T22:37:29.000+0000","updated":"2006-06-18T22:37:29.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12416823","id":"12416823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"I'm not very well acquainted with this code, but based on the example of \"escape analysis\" posted by the JVM team, I think I understand why this test is failing with IBM 1.5.\r\n\r\nIf we look at the test program again, we can see that it very closely mimics the example of \"escape analysis\" offered by the JVM team.  In particular:\r\n\r\n \t\tSystem.out.println(\"done creating table and inserting data.\");\r\n   \t\tconn.setTransactionIsolation(Connection.TRANSACTION_READ_COMMITTED);\r\n   \t\tResultSet rs = stmt.executeQuery(\"select * from T1\");\r\n==> Under Java 5.0 rs is eligible for GC here...\r\n   \t\tSystem.out.println(\"current isolation level: \" + getIsoLevelName(conn.getTransactionIsolation()));\r\n\t\tconn.setTransactionIsolation(java.sql.Connection.TRANSACTION_SERIALIZABLE);\r\n\t\tSystem.out.println(\"current isolation level: \" + getIsoLevelName(conn.getTransactionIsolation()));\r\n==> Under previous versions, rs is eligible for GC here...\r\n\r\nSo with ibm15, rs becomes eligible for GC _prior_ to the call to setTransactionIsolation because it (rs) is no longer referenced after it is created.  Then the call to gc() in verifyAllHeldResultSetsAreClosed() does the escape analysis, sees that rs is now eligible for GC and so collects it.  As part of that collection process the JVM calls \"finalize()\", which takes us to EmbedResultSet.finalize(), and there we see this:\r\n\r\n\t/**\r\n\t\tJDBC states that a ResultSet is closed when garbage collected.\r\n\t\tWe simply mark the activation as unused. Some later use\r\n\t\tof the connection will clean everything up.\r\n\r\n\t\t@exception Throwable Allows any exception to be thrown during finalize\r\n\t*/\r\n\tprotected void finalize() throws Throwable {\r\n\t\tsuper.finalize();\r\n\r\n\t\tif (finalizeActivation != null) {\r\n\t\t\tfinalizeActivation.markUnused();\r\n\t\t}\t\t\r\n\t}\r\n\r\nThus finalizeActiviation is now marked as \"unused\", which means we end up ignoring the activation in the verifyAllHeldResultSetsAreClosed() method:\r\n\r\n\tif (!a.isInUse())\r\n\t{\r\n\t\tcontinue;\r\n\t}\r\n\r\nAnd therefore we return \"true\" from the method and no error is thrown.\r\n\r\nTo prove this, I added a very simple (albeit meaningless) reference to \"rs\" after the call to setTransactionIsolation:\r\n\r\n \t\tSystem.out.println(\"done creating table and inserting data.\");\r\n   \t\tconn.setTransactionIsolation(Connection.TRANSACTION_READ_COMMITTED);\r\n   \t\tResultSet rs = stmt.executeQuery(\"select * from T1\");\r\n   \t\tSystem.out.println(\"current isolation level: \" + getIsoLevelName(conn.getTransactionIsolation()));\r\n\t\tconn.setTransactionIsolation(java.sql.Connection.TRANSACTION_SERIALIZABLE);\r\n\t\tSystem.out.println(\"current isolation level: \" + getIsoLevelName(conn.getTransactionIsolation()));\r\n\t\tSystem.out.println(rs);  // <== Added by Army\r\n\r\nWith this simple line, the escape analysis will *not* mark rs eligible for GC prior to setTransactionIsolation, which means we won't call \"finalize()\", which means the activation will remain \"in use\", and therefore we'll get the exception.\r\n\r\nAll of that said, I added System.outs to the test program to see what the object id of \"rs\" is before the call to setTransactionIsolation, and I also added System.outs to see what the object id of the \"rs\" is inside verifyAllHeldResultSetsAreClosed().  Not surprisingly, the objects are NOT the same.  In the test program we see:\r\n\r\norg.apache.derby.impl.jdbc.EmbedResultSet20@d0a0d0a\r\n\r\nbut in verifyAllHeldResultSetsAreClosed() we see:\r\n\r\norg.apache.derby.impl.sql.execute.BulkTableScanResultSet@42484248\r\n\r\nSo as far as I can tell, the test program no longer references the EmbedResultSet, so it's marked as \"eligible for GC\" and is garbage collected by escape analysis; however, that EmbedResultSet was in turn referencing another object--BulkTableScanResultSet--that *is* still referenced (by the activation), and that's the result set that should have caused the error--but since we \"bailed\" on the error checking because the activiation was no longer \"in use\", we never checked the underlying result set and therefore we didn't throw the exception.\r\n\r\nThat's my take on it after looking at it briefly.  I still don't know for sure who's \"at fault\" here (the JVM or Derby)--I'd have to look at it more to say one way or the other.  But that's my first take on the issue...\r\n\r\nComments/input/feedback are, as always, much appreciated...\r\nArmy","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-06-20T07:01:49.000+0000","updated":"2006-06-20T07:01:49.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12416825","id":"12416825","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Army for the comment.  I think I understand escape analysis better now and how it relatest to this issue and I think\r\n\r\n1) The JVM is ok.  \r\nIt should garbage collect and finalize  rs and all its innards because they can never really be used again.\r\n\r\n2) Derby is ok. \r\n setTransactionIsolation() does not need to consider a  ResultSet that can never be used again .\r\n\r\n3) The test is not ok. \r\n To test what it wants to test, that we can't change the isolation in the middle of retrieving results on a held cursor,  it should  have code to use rs after setTransactionIsolation, e.g. add an \r\nrs.next() after setTransactionIsolation()\r\n\r\nDoes that sound right?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-06-20T07:17:28.000+0000","updated":"2006-06-20T07:17:28.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12416921","id":"12416921","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"\r\n> 3) The test is not ok.\r\n> To test what it wants to test, that we can't change the isolation in the middle of retrieving results on a\r\n> held cursor, it should have code to use rs after setTransactionIsolation, e.g. add an\r\n> rs.next() after setTransactionIsolation()\r\n\r\n> Does that sound right? \r\n\r\nSounds goods to me.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-06-20T22:54:30.000+0000","updated":"2006-06-20T22:54:30.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12417208","id":"12417208","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"body":"I have made a patch with the rs.next after the setTransactionIsolation and the test passes with both ibm1.5 and sun jdk1.5. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"created":"2006-06-22T05:58:43.000+0000","updated":"2006-06-22T05:58:43.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12419891","id":"12419891","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Manjula for looking at this issue.\r\n\r\nI was not able to apply this patch in Eclipse. The message I got was not in patch format.  Looking at the patch it seems that some lines are split like:\r\n--- java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/setTransact\r\nionIsolation.java       (revision 416106)\r\n\r\nMaybe that is the trouble.  Perhaps a cut and paste of svn diff?\r\n\r\nIn terms of content it looks like a lot of white space was added.    It might be good just to revert add in the rs.next() with the comment and regenerate the patch with svn diff  redirected to file.  I'll uncheck patch available until a new patch is submitted.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-07-09T06:03:34.000+0000","updated":"2006-07-09T06:03:34.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12424630","id":"12424630","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"body":"Hi Kathey,\r\n\r\nThanks for your input. I'm attaching the diff again. Please have a look ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"created":"2006-07-31T19:52:42.000+0000","updated":"2006-07-31T19:52:42.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12425923","id":"12425923","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Tried test on IBM 1.5 SR2 and Sun JDK 1.4.2 Committed svn_diff.txt.\r\nDate: Fri Aug  4 18:50:47 2006\r\nNew Revision: 428937\r\n\r\nURL: http://svn.apache.org/viewvc?rev=428937&view=rev\r\n\r\nThanks Manjula for the fix.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-08-05T01:51:38.000+0000","updated":"2006-08-05T01:51:38.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12451342","id":"12451342","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"backporting this fix to 10.1 ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2006-11-20T15:48:53.000+0000","updated":"2006-11-20T15:48:53.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330232/comment/12451345","id":"12451345","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"merge didn't work, so I applied the change of revision 428937 manually with:\r\nhttp://svn.apache.org/viewvc?view=rev&revision=477228\r\n\r\nSending        java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\jdbcapi\\\r\nsetTransactionIsolation.java\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2006-11-20T15:54:41.000+0000","updated":"2006-11-20T15:54:41.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1108/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i070xj:"}}
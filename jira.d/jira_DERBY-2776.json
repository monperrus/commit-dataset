{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12371159","self":"https://issues.apache.org/jira/rest/api/latest/issue/12371159","key":"DERBY-2776","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":null,"customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23237","customfield_12310222":"1_*:*_1_*:*_1777796738_*|*_6_*:*_2_*:*_715983869_*|*_5_*:*_1_*:*_7744_*|*_4_*:*_1_*:*_29943","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2007-07-06T14:42:20.247+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2776/watchers","watchCount":0,"isWatching":false},"created":"2007-06-07T17:58:41.953+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12316357","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12316357","type":{"id":"12310010","name":"Incorporates","inward":"is part of","outward":"incorporates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310010"},"inwardIssue":{"id":"12368325","key":"DERBY-2599","self":"https://issues.apache.org/jira/rest/api/2/issue/12368325","fields":{"summary":"Set correct collation type and derivation on DataTypeDescriptor(DTD).","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-07-06T14:42:20.225+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"As per the wiki page http://wiki.apache.org/db-derby/BuiltInLanguageBasedOrderingDERBY-1478, Section Collation Determination, Rule 4), result of CAST will take the collation of the current compilation schema. This is what Derby 10.3 codeline has implemented for CAST in the CastNode.bindCastNodeOnly() method.\n \nBut that is not the right thing to do for CAST nodes that get generated internally. One specific example of such a case\n \nconnect 'jdbc:derby:c:/dellater/db1Norway;create=true;territory=no;collation=TERRITORY_BASED';\ncreate table t (id int, type char(10), typeVarchar varchar(10));\ninsert into t values (1,'CAR','CAR'),(2,'SUV','SUV'); \nset schema sys;\nSELECT  type FROM app.t WHERE CASE WHEN 1=1 THEN type ELSE typevarchar END = type; -- the sql in question\n \nNote that the DTD associated with THEN clause expression is of type CHAR and the DTD associated with ELSE clause expression is of type VARCHAR. And in Derby, VARCHAR has higher type precedence than CHAR.\n \nNow, during the compilation of the SELECT statement above, the ConditionalNode.bindExpression makes following call which causes ConditionalNode to have a DTD which has same properties as the DTD of ELSE clause expression which is of type VARCHAR(since VARCHAR has higher type precedence than CHAR) with collation type of territory based and collation derivation of IMPLICIT. So far, so good. \n  setType(thenElseList.getDominantTypeServices());\n \nLater, the ConditionalNode.bindExpression has following if statement which will return true for our specific SELECT statement\n  if (thenTypeId.typePrecedence() != condTypeId.typePrecedence())\nThis is because the datatype(CHAR) of \"type\" in THEN clause does not have same type precedence as datatype(VARCHAR) of ConditionalNode and so the code inside the if statement in ConditionalNode.bindExpression generates a CAST node on the top of the THEN clause expression and that CAST node uses the SAME physical DTD of the ConditionalNode, which in this case is a VARCHAR datatype with collation type of territory based and collation derivation of IMPLICIT. Next,  ConditionalNode.bindExpression calls bind on the newly created cast node using following\n   cast = cast.bindExpression(fromList, \n           subqueryList,\n           aggregateVector);\nDuring the bind of the CAST, we always have the CAST node take the collation of the current compilation schema, which in this case is SYS and hence we end up assigining collation type of UCS_BASIC to DTD associated with the CAST node.. But since the CAST is associated with the same physical DTD that is used by the ConditionalNode, the ConditionalNode ends up having it's collation type changed from territory based to UCS_BASIC and this causes the above SELECT statement to fail at compilation time because of mismatch of collation type between CASE... = type. The left hand side of CASE... = type ends up having collation of UCS_BASIC whereas right hand side \"type\" has collation type of territory based and hence the SELECT compilation fails. This is incorrect behavior. The CASE node should have held on to it's collation type of territory based. \n\nPossible solution to the problem as discussed on Derby mailing list under title \"Collation info of internally generated CAST node'\nThe setting of CAST node's collation type to current compilation schema's collation type can be moved out of CastNode.bindCastNodeOnly() method and into CastNode.bindExpression (). I checked through Derby code for internally generated CAST nodes and noticed that except for ConditionalNode, everywhere else, after the CAST node is created, we call CastNode.bindCastNodeOnly() method on it. For some unknown reason, ConditionalNode doesn't call just CastNode.bindCastNodeOnly() but instead calls CastNode.bindExpression(). So, the complete fix to the problem could be to have ConditionalNode call CastNode.bindCastNodeOnly() instead of CastNode.bindExpression() and the collation type setting moved into CastNode.bindExpression() from CastNode.bindCastNodeOnly().\n\nThis solution will be cleaner if with the above solution to also have an explicit boolean field in CastNode that indicates if the CAST is internal or not. The use of different methods (as above) probably works, but those current method names don't imply the behaviour we are expecting them to implement. So there's some chance in the future that a new call may\nbreak the assumptions. Having explicit code would be clear and easy to understand.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39891","summary":"Internally generated CAST nodes should not use the collation of the current compilation schema. Instead they should use collation of target type passed to it.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":2,"total":2,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12371159/comment/12508407","id":"12508407","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Committed the patch for this jira entry into main codeline (10.4) using revision 551033. The commit comments are as follows. This should be ported to 10.3 codeline.\r\n\r\nDERBY-2776 Internally generated CAST nodes should not pick up the collation of the current schema. In order to implement this, the CAST nodes generated directly by the user sql (parser) will set a flag on the cast node to indicate that they are externally generated CAST nodes. During the bind phase of a CAST node, we will check if the node is externally generated. If yes, then we will have it pick up \r\nthe collation of the compilation schema otherwise we will leave the collation unchanged.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2007-06-27T04:21:20.957+0000","updated":"2007-06-27T04:21:20.957+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12371159/comment/12508760","id":"12508760","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"With revision 551485, now the changes have been commited to 10.3 codeline also.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2007-06-28T07:48:38.487+0000","updated":"2007-06-28T07:48:38.487+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2776/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i076xz:"}}
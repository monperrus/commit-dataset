{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12532553","self":"https://issues.apache.org/jira/rest/api/latest/issue/12532553","key":"DERBY-5514","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2011-11-24 09:49:00.176","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"218286","customfield_12310222":"1_*:*_1_*:*_405738243_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2011-11-28T17:22:15.589+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5514/watchers","watchCount":1,"isWatching":false},"created":"2011-11-24T00:39:57.426+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12371678","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12371678","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"outwardIssue":{"id":"12394911","key":"DERBY-3647","self":"https://issues.apache.org/jira/rest/api/2/issue/12394911","fields":{"summary":"EMMA is unable to write coverage information from network server when it is started in a separate process with default security policy","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-07-08T12:37:28.125+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11413","id":"11413","name":"Test"}],"timeoriginalestimate":null,"description":"When running SecureServerTest with jars instrumented with EMMA using the ant emma-all target, I see:\r\n\r\n[junit] (net)derbynet.SecureServerTest.testServerStartup used 8475 ms junit.framework.TestListener: endTest(testServerStartup)\r\n    [junit] START-SPAWNED:SpawnedNetworkServer ERROR OUTPUT:\r\n    [junit] java.security.policy: error adding Entry:\r\n    [junit] \tjava.net.MalformedURLException: no protocol: /export/home/dag/java/sb/sb1/tools/java/emma.jar\r\n    [junit] java.security.AccessControlException: access denied (java.io.FilePermission coverage.ec read)\r\n    [junit] \tat java.security.AccessControlContext.checkPermission(AccessControlContext.java:374)\r\n    [junit] \tat java.security.AccessController.checkPermission(AccessController.java:546)\r\n    [junit] \tat java.lang.SecurityManager.checkPermission(SecurityManager.java:532)\r\n    [junit] \tat java.lang.SecurityManager.checkRead(SecurityManager.java:871)\r\n    [junit] \tat java.io.File.exists(File.java:731)\r\n    [junit] \tat com.vladium.emma.data.DataFactory.persist(DataFactory.java:525)\r\n    [junit] \tat com.vladium.emma.data.DataFactory.persist(DataFactory.java:86)\r\n    [junit] \tat com.vladium.emma.rt.RTCoverageDataPersister.dumpCoverageData(RTCoverageDataPersister.java:54)\r\n    [junit] \tat com.vladium.emma.rt.RTExitHook.run(RTExitHook.java:32)\r\n    [junit] \tat java.lang.Thread.run(Thread.java:662)\r\n    [junit] Exception in thread \"EMMA shutdown handler thread\" java.lang.RuntimeException: EMMA failed to dump coverage data: java.security.AccessControlException: access denied (java.io.FilePermission coverage.ec read)\r\n    [junit] \tat com.vladium.emma.rt.RTCoverageDataPersister.dumpCoverageData(RTCoverageDataPersister.java:71)\r\n    [junit] \tat com.vladium.emma.rt.RTExitHook.run(RTExitHook.java:32)\r\n    [junit] \tat java.lang.Thread.run(Thread.java:662)\r\n    [junit] END-SPAWNED  :SpawnedNetworkServer ERROR OUTPUT:\r\n\r\nThis is presumably because the test spawns a server which runs with the default server policy.\r\n\r\nAnother thing is that is seems dangerous to let the spawned process write to EMMA's \"coverage.ec\", since we don't know when the parent process will write to it. This behavior could be what's been causing our corrutions in the EMMA runs earlier. The missing permissions just highlight what's happening.\r\n\r\nIn this case the spawned process was started with this command line (I instrumented the code):\r\n\r\nXXX server startup command = /usr/jdk/instances/jdk1.6.0/jre/bin/java -classpath /<my sandbox>/tools/java/emma.jar:/<my sandbox>/jars/sane/derbyTesting.jar:/<my sandbox>/jars/emma/lib/derbyclient.jar:/<my sandbox>/jars/emma/lib/derbynet.jar:/<my sandbox>/jars/emma/lib/derby.jar:/<my sandbox>/jars/emma/lib/derbytools.jar:/<my sandbox>/jars/emma/lib/derbyrun.jar:/<my sandbox>/tools/java/junit.jar:/usr/share/lib/ant/ant-launcher.jar:/usr/share/lib/ant/ant.jar:/usr/share/lib/ant/ant-junit.jar org.apache.derby.drda.NetworkServerControl start -h localhost -p 1527 \r\n\r\nPossible approaches:\r\n         run the spawned VMs with plain jars (downside: we won't get coverage for those)\r\n         run the spawned with a special default policy file when we run with EMMA ++\r\n         run the spawned VM with -noSecurityManager if with EMMA jars\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"36138","summary":"SecureServerTest (and others) don't play nice with EMMA: AccessControlException","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":14,"total":14,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12532553/comment/13156456","id":"13156456","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Uploading a patch which implements the third approach. This made the test complete with EMMA instrumented jars. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-11-24T01:44:38.990+0000","updated":"2011-11-24T01:44:38.990+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12532553/comment/13156497","id":"13156497","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Related: RuntimeInfoTest  fails due to asserting on the output from the spawned process: output contains EMMA info.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-11-24T03:45:52.939+0000","updated":"2011-11-24T03:45:52.939+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12532553/comment/13156611","id":"13156611","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Running the network server with a special default policy file when we run with EMMA is probably the right thing to do, but running with -noSecurityManager also sounds perfectly acceptable.\r\n\r\nThe patch didn't compile in my environment:\r\n\r\njunitcomponents:\r\n    [javac] Compiling 1 source file to /code/derby/trunk/classes\r\n    [javac] /code/derby/trunk/java/testing/org/apache/derbyTesting/junit/NetworkServerTestSetup.java:264: cannot find symbol\r\n    [javac] symbol  : method contains(java.lang.String)\r\n    [javac] location: class java.lang.String\r\n    [javac]                 classpath.contains(\"emma.jar\"))\r\n    [javac]                          ^\r\n    [javac] 1 error\r\n\r\nChanging contains() to indexOf() made it work, and I could run SecureServerTest without seeing the stack traces getting printed.\r\n\r\nIf I added the following line to NetworkServerTestSetup.startSeparateProcess()\r\n    al.add(\"-Demma.verbosity.level=silent\");\r\nI didn't have to change the assert in SecureServerTest.\r\n\r\nSecureServerTest.runServerCommand() and Driver40UnbootedTest.test_notBooted() also set this property to prevent that EMMA interferes with the canons.\r\n\r\nAs to the problem with spawned processes possibly corrupting coverage.ec, perhaps we could run the spawned processes with the emma.coverage.out.file system property set, and use a counter to prevent name clashes? If so, I'd prefer that we do that in BaseTestCase.execJavaCmd() so that it works for most of the tests. NetworkServerTestSetup doesn't use BaseTestCase.execJavaCmd() yet, but making it do so should be trivial. Maybe it would also make sense to push the setting of emma.verbosity.level down to that method too, so that we don't have to do that in every test that happens to spawn a process.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-11-24T09:49:00.176+0000","updated":"2011-11-24T09:49:00.176+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12532553/comment/13156618","id":"13156618","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"> If I added the following line to NetworkServerTestSetup.startSeparateProcess()\r\n>     al.add(\"-Demma.verbosity.level=silent\");\r\n> I didn't have to change the assert in SecureServerTest.\r\n\r\nI spoke too soon. This removed the unexpected line \"EMMA: collecting runtime coverage data ...\" from the output, but it still didn't show the security manager information expected by the test (because the security manager is not used), so the assert still fails.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-11-24T09:56:28.337+0000","updated":"2011-11-24T09:56:28.337+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12532553/comment/13156875","id":"13156875","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"I found that the default test policy has the following entry for EMMA (granted to derby.jar)\r\n\r\n  // These permissions are needed when testing code instrumented with EMMA.\r\n  // They will only be used if the emma.active system property property is set,\r\n  // which should be set to \"\" for the permissions to be correct.\r\n  permission java.util.PropertyPermission \"${emma.active}user.dir\", \"read\";\r\n  permission java.io.FilePermission \"${emma.active}${user.dir}${/}coverage.ec\", \"read, write\";\r\n  permission java.lang.RuntimePermission \"${emma.active}writeFileDescriptor\";\r\n\r\nI tried approach two above, to craft a special policy file for the server and grant these privileges to *emma.jar* (for SecureServerTest).  This worked in part, except for a case where there was a lacking permission for writeFileDescriptor (same stack trace as below).\r\n\r\nNow, in the tools suite I found a similar issue after running SysinfoLocaleTest:\r\n\r\n[junit] java.security.AccessControlException: access denied (java.lang.RuntimePermission writeFileDescriptor)\r\n    [junit] \tat java.security.AccessControlContext.checkPermission(AccessControlContext.java:374)\r\n    [junit] \tat java.security.AccessController.checkPermission(AccessController.java:546)\r\n    [junit] \tat java.lang.SecurityManager.checkPermission(SecurityManager.java:532)\r\n    [junit] \tat java.lang.SecurityManager.checkWrite(SecurityManager.java:937)\r\n    [junit] \tat java.io.FileOutputStream.<init>(FileOutputStream.java:219)\r\n    [junit] \tat com.vladium.emma.data.DataFactory$UCFileOutputStream.<init>(DataFactory.java:292)\r\n    [junit] \tat com.vladium.emma.data.DataFactory$RandomAccessFileOutputStream.<init>(DataFactory.java:375)\r\n    [junit] \tat com.vladium.emma.data.DataFactory.writeEntry(DataFactory.java:715)\r\n    [junit] \tat com.vladium.emma.data.DataFactory.persist(DataFactory.java:672)\r\n    [junit] \tat com.vladium.emma.data.DataFactory.persist(DataFactory.java:86)\r\n    [junit] \tat com.vladium.emma.rt.RTCoverageDataPersister.dumpCoverageData(RTCoverageDataPersister.java:54)\r\n    [junit] \tat com.vladium.emma.rt.RTExitHook.run(RTExitHook.java:32)\r\n    [junit] \tat java.lang.Thread.run(Thread.java:662)\r\n\r\nexcept this time there is no spawned VM, so the code is running under the default test policy, which does have the EMMA permissions shown above. Note that this thread doesn't have any code from derby.jar on the stack, so the fact the derby.jar has the required privileges doesn't help: we still get AccessControlException.\r\n\r\nI downloaded the EMMA sources and wrapped the call to RTCoverageDataPersister#DataFactory.persist (cdataView, outFile, merge) in a doPrivilegedException call. That made it work. \r\n\r\nThere is no other use of doPrivileged in EMMA's code, so we may see other similar problems.\r\n\r\nThe exception seen above is later followed by this warning:\r\n\r\n  [report] processing input file [/export/home/dag/java/sb/sb1/junit_20111124_1520/coverage.ec] ...\r\n  [report] java.io.UTFDataFormatException: malformed input around byte 0\r\n\r\nwhich is may be the (partial?) reason why the coverage file gets corrupted.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-11-24T19:08:25.783+0000","updated":"2011-11-24T19:08:25.783+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12532553/comment/13156887","id":"13156887","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Small correction to the above: the default policy file for the tests does contain explicit permissions for the emma jar. But, that isn't enough when emma doesn't call doPrivileged, of course. The default server policy does not contain permissions for Emma.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-11-24T19:58:45.355+0000","updated":"2011-11-24T23:39:07.524+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12532553/comment/13156936","id":"13156936","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"With the patch to Emma, the fix to DERBY-5512 (thanks, Knut) and setting the path the the old releases when calling ant (since i'm behind a firewall), I was able to make all tests in ant target \"derby-core\" run with emma jars, albeit a few at a time. I'll start all the tests now passing larger heap size etc in via ANT_OPTS, so I'll see how far I get with Emma running the \"emma-all\" target. It would be nice to have it running again. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-11-24T23:37:08.785+0000","updated":"2011-11-24T23:37:08.785+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12532553/comment/13157093","id":"13157093","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for that info, Dag! So it seems that the problem is that the JVM's runtime libraries don't have the permissions required by the EMMA code, and the lack of doPrivileged blocks in EMMA requires all code to have those permissions (except if Derby code that contains doPrivileged blocks itself is on the stack and limits the privilege checking).\r\n\r\nBased on that observation, I tried a different approach that didn't require modifying the EMMA source (see d5514-emma-permissions-to-all.diff). Instead, I changed the policy files to grant the permissions required by EMMA to all code bases when running with the instrumented code. That's basically the same as the current policy files do, except they explicitly grant the permissions to all the jar files we know about, whereas my patch grants them to all code bases the JVM knows about. (This also simplifies the policy files a bit, since we now only need one grant rule that covers all code bases, instead of one grant rule per code base.)\r\n\r\nI ran \"ant -DderbyTesting.oldReleasePath=... emma-all\" with my attached patch and Dag's initial patch for SecureServerTest. I saw two failures in RuntimeInfoTest, but it sounds like Dag already has a fix for that test in his sandbox (by setting the emma.verbosity.level property?).\r\n\r\nI also had to make a small change to RoutineSecurityTest. It contained negative test cases that tried to get the value of various system properties from within a stored procedure. Among these properties were user.dir, on which EMMA requires a read permission. Since EMMA's permissions are now granted to a wider set of code bases, getting that property now unexpectedly succeeded.\r\n\r\nBecause of this, the patch skips the negative test case for user.dir. There are negative test cases for many other system properties, so I think RoutineSecurityTest still tests what it intended to test. Also, as a compensation, I enabled the negative test case for the user.home property in the same test. That test case has been disabled since the test was first checked in, but there is no comment saying why it's disabled, and it didn't fail in my environment (tested from both classes and jars, since they have different permissions granted to them, and also both sane and insane).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-11-25T10:51:39.862+0000","updated":"2011-11-25T10:51:39.862+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12532553/comment/13157219","id":"13157219","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Thanks, Knut! Good if we can get away without changing the Emma source. Yes, added \"-Demma.verbosity.level=silent\" to RuntimeInfoTest#RuntimeinfoCmd and RuntimeinfoLocaleCmd. Seems we are good to code for the emma-all target, then. Btw, the ANT_OPTS may not be required as you said offline, since ant starts each suite separately.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-11-25T16:15:54.996+0000","updated":"2011-11-25T16:15:54.996+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12532553/comment/13157324","id":"13157324","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Uploading patch derby-5514-2, which \r\n\r\n- fixes the usa of String#contains,\r\n- adds -Demma.verbosity.level=silent to RuntimeInfoTest\r\n- adds the convenience method runsWithEmma to BaseTestCase\r\n- adds fixes to NetworkServerTestSetup to \r\n  a) always use Emma verbosity silent when spawning a server in separate VM, and also \r\n  b) refrains from starting the server with the security manager when running with Emma since the default server policy doesn't contain permissions for Emma, and finally\r\n- skips the assertion for the security manager being used in\r\n  SecureServerTest (it is not, see preceding item)\r\n\r\nWith these fixes *and* my patch to Emma (it will not be required when Knut's fixes to the policy files are added), \"ant emma-all\" completed successfully (see https://people.apache.org/~dag/coverage.html).\r\n\r\nI notice emma-all doesn't contain the following tests which we may consider including:\r\n\r\n- LobLimitsLiteTest \r\n- StressMultiTest\r\n- i18n._Suite\r\n- ReplicationSuite\r\n\r\nwhich are all run as part of PackagesAll in the regressions.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-11-25T23:04:20.558+0000","updated":"2011-11-25T23:04:20.558+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12532553/comment/13157413","id":"13157413","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Committed d5514-emma-permissions-to-all.diff with revision 1206409.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-11-26T08:20:58.334+0000","updated":"2011-11-26T08:20:58.334+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12532553/comment/13158442","id":"13158442","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I ran suites.All (which includes the above mentioned test suites that are not part of emma-all/junit-all) successfully with derby-5514-2.diff and instrumented jars. +1 to commit.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-11-28T13:33:11.243+0000","updated":"2011-11-28T13:33:11.243+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12532553/comment/13158583","id":"13158583","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Committed derby-5514-2 as svn 1207471, resolving.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-11-28T17:21:52.540+0000","updated":"2011-11-28T17:21:52.540+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12532553/comment/13685138","id":"13685138","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"[bulk update] Close all resolved issues that haven't been updated for more than one year.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-06-17T09:19:08.802+0000","updated":"2013-06-17T09:19:08.802+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5514/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06jrz:"}}
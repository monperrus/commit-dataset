{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12430835","self":"https://issues.apache.org/jira/rest/api/latest/issue/12430835","key":"DERBY-4315","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315564","id":"12315564","description":"First release on the 10.7 branch.","name":"10.7.1.1","archived":false,"released":true,"releaseDate":"2010-12-14"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316362","id":"12316362","description":"First release on the 10.8 branch","name":"10.8.1.2","archived":false,"released":true,"releaseDate":"2011-04-29"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2010-02-09 02:07:38.447","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24179","customfield_12310222":"1_*:*_1_*:*_42567164805_*|*_6_*:*_1_*:*_1818988093_*|*_5_*:*_2_*:*_4424508780_*|*_4_*:*_1_*:*_1209067872","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2011-02-16T23:32:10.800+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4315/watchers","watchCount":1,"isWatching":false},"created":"2009-07-18T01:10:01.299+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":["derby_backport_reject_10_6"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313142","id":"12313142","description":"","name":"10.3.3.0","archived":false,"released":true,"releaseDate":"2008-05-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313345","id":"12313345","description":"","name":"10.4.2.0","archived":false,"released":true,"releaseDate":"2008-09-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314116","id":"12314116","description":"10.5.2 Release July 30 2009 (794445) Now deprecated","name":"10.5.2.0","archived":false,"released":true,"releaseDate":"2009-07-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313727","id":"12313727","description":"Feature release","name":"10.6.1.0","archived":false,"released":true,"releaseDate":"2010-05-18"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12325803","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12325803","type":{"id":"12310010","name":"Incorporates","inward":"is part of","outward":"incorporates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310010"},"inwardIssue":{"id":"12354260","key":"DERBY-2017","self":"https://issues.apache.org/jira/rest/api/2/issue/12354260","fields":{"summary":"Client driver can insert and commit partial data when a LOB stream throws IOException or does not match the specified length","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12325973","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12325973","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12430773","key":"DERBY-4312","self":"https://issues.apache.org/jira/rest/api/2/issue/12430773","fields":{"summary":"SQLException XJ215 on insert  with setCharacterStream() and autocommit off in mailjdbc test","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-06-17T09:19:35.328+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11407","id":"11407","name":"JDBC"}],"timeoriginalestimate":null,"description":"If a user attempts to reuse a stream set as a parameter to a prepared statement, the statement execution should fail with SQL State XJ001.  Instead client fails with a protocol error and inserts wrong data. See the attached java program ReproReuseStream.java for a reproduction.\r\n[C:/kmarsden/repro/reusestream] java ReproReuseStream\r\nInsert row 1\r\nTry to insert row 2 with reused streams\r\njava.sql.SQLException: Network protocol error: end of stream prematurely reached, parameter #4.  Remaining data has been\r\n padded with 0x0.\r\n        at org.apache.derby.client.am.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:96)\r\n        at org.apache.derby.client.am.SqlException.getSQLException(SqlException.java:358)\r\n        at org.apache.derby.client.am.PreparedStatement.executeUpdate(PreparedStatement.java:399)\r\n        at ReproReuseStream.main(ReproReuseStream.java:41)\r\nCaused by: org.apache.derby.client.am.SqlException: Network protocol error: end of stream prematurely reached, parameter\r\n #4.  Remaining data has been padded with 0x0.\r\n        at org.apache.derby.client.net.Request.writePlainScalarStream(Request.java:490)\r\n        at org.apache.derby.client.net.Request.writeScalarStream(Request.java:264)\r\n        at org.apache.derby.client.net.NetStatementRequest.buildEXTDTA(NetStatementRequest.java:951)\r\n        at org.apache.derby.client.net.NetStatementRequest.writeExecute(NetStatementRequest.java:147)\r\n        at org.apache.derby.client.net.NetPreparedStatement.writeExecute_(NetPreparedStatement.java:178)\r\n        at org.apache.derby.client.am.PreparedStatement.writeExecute(PreparedStatement.java:1801)\r\n        at org.apache.derby.client.am.PreparedStatement.flowExecute(PreparedStatement.java:2031)\r\n        at org.apache.derby.client.am.PreparedStatement.executeUpdateX(PreparedStatement.java:404)\r\n        at org.apache.derby.client.am.PreparedStatement.executeUpdate(PreparedStatement.java:390)\r\n        ... 1 more\r\nGo ahead and commit so we can see the wrong data.\r\nID         |MNAME\r\n                    |MVALUE     |BYTEDATA\r\n                                         |CHARDATA\r\n\r\n------------------------------------------------------------------------------------------------------------------------\r\n------------------------------------------------------------------------------------------------------------------------\r\n------------------------------------------------------------------------------------------------------------------------\r\n--------------------------------------------------\r\n1          |mname\r\n                    |0          |636363636363636363636363636363636363636363636363636363636363636363636363636363636363636\r\n3636363636363636363636363636363636363636&|cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc\r\nccccccccccccccccccccccccccccccccccccccccccccccccc&\r\n2          |mname\r\n                    |0          |000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\n0000000000000000000000000000000000000000&|\r\n                                                 &\r\n\r\nTo workaround the issue users should not attempt to reuse streams but we should give a better message and not insert wrong data.\r\n\r\nThe code was extracted from StreamingColumnTest testDerby500 but the commits were removed.\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10363","value":"Embedded/Client difference","id":"10363"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10366","value":"Wrong query result","id":"10366"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"36097","summary":"Attempt to reuse streams in client on insert gives protocol exception and inserts wrong data","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10422","value":"High Value Fix","id":"10422"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10424","value":"Repro attached","id":"10424"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10427","value":"Workaround attached","id":"10427"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10051","value":"Urgent","id":"10051"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":21,"total":21,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12732812","id":"12732812","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Right now this bocks the DERBY-4312 fix because StreamingColumnTest fails.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-18T01:12:18.536+0000","updated":"2009-07-18T01:12:18.536+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12732813","id":"12732813","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Attaching reproduction for this issue.  Start network server and run java ReproReuseStream","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-18T01:13:41.306+0000","updated":"2009-07-18T01:15:09.233+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12732816","id":"12732816","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"This is perhaps a more specific case of DERBY-2017, but maybe there is something specific that can be done for stream reuse if a general solution is too hard.  \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-18T01:26:01.157+0000","updated":"2009-07-18T01:26:01.157+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12732818","id":"12732818","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"verified back to 10.1\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-18T01:43:36.094+0000","updated":"2009-07-18T01:43:36.094+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12831255","id":"12831255","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"I think it would be OK if Derby just throws an exception indicating EOF here, since we probably won't support using the same stream for two placeholders in a prepared statement either. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2010-02-09T02:07:38.447+0000","updated":"2010-02-09T02:07:38.447+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12910163","id":"12910163","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Note that from 10.6 (both client and server must be 10.6 or later) padded data won't be inserted into the database. This was fixed by DERBY-2017.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2010-09-16T14:15:18.455+0000","updated":"2010-09-16T14:15:18.455+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12933520","id":"12933520","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"The fix for DERBY-2017 appears to have stopped Derby from inserting bogus data. The protocol error remains, though. Here's what the repro produces now:\r\n\r\nDrop exception ok:'DROP TABLE' cannot be performed on 'TEST' because it does not exist.\r\nInsert row 1 \r\nTry to insert row 2 with reused streams \r\njava.sql.SQLException: Network protocol error: end of stream prematurely reached, parameter #4.  Remaining data has been padded with 0x0.\r\n\tat org.apache.derby.client.am.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:96)\r\n\tat org.apache.derby.client.am.SqlException.getSQLException(SqlException.java:358)\r\n\tat org.apache.derby.client.am.PreparedStatement.executeUpdate(PreparedStatement.java:403)\r\n\tat ReproReuseStream.main(ReproReuseStream.java:41)\r\nCaused by: org.apache.derby.client.am.SqlException: Network protocol error: end of stream prematurely reached, parameter #4.  Remaining data has been padded with 0x0.\r\n\tat org.apache.derby.client.net.Request.writePlainScalarStream(Request.java:339)\r\n\tat org.apache.derby.client.net.Request.writeScalarStream(Request.java:247)\r\n\tat org.apache.derby.client.net.NetStatementRequest.buildEXTDTA(NetStatementRequest.java:983)\r\n\tat org.apache.derby.client.net.NetStatementRequest.writeExecute(NetStatementRequest.java:152)\r\n\tat org.apache.derby.client.net.NetPreparedStatement.writeExecute_(NetPreparedStatement.java:178)\r\n\tat org.apache.derby.client.am.PreparedStatement.writeExecute(PreparedStatement.java:1791)\r\n\tat org.apache.derby.client.am.PreparedStatement.flowExecute(PreparedStatement.java:2021)\r\n\tat org.apache.derby.client.am.PreparedStatement.executeUpdateX(PreparedStatement.java:408)\r\n\tat org.apache.derby.client.am.PreparedStatement.executeUpdate(PreparedStatement.java:394)\r\n\t... 1 more\r\nGo ahead and commit so we can see the wrong data.\r\nID         |MNAME                                                                                                                           |MVALUE     |BYTEDATA                                                                                                                        |CHARDATA                                                                                                                        \r\n--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n1          |mname                                                                                                                           |0          |6363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636&|ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc&\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-11-18T18:47:59.602+0000","updated":"2010-11-18T18:47:59.602+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12933534","id":"12933534","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching a revised version of the repro. This version runs the test on both the embedded and client/server drivers. To run this version, you need to specify the port which the server is listening on:\r\n\r\njava ReproReuseStream 8246\r\n\r\n########################################################\r\n#\r\n#\tjdbc:derby:memory:db1;create=true\r\n#\r\n########################################################\r\n\r\nDrop exception ok:'DROP TABLE' cannot be performed on 'TEST' because it does not exist.\r\nInsert row 1 \r\nTry to insert row 2 with reused streams \r\nCaught SQLException. SQLState = XSDA4\r\nAn unexpected exception was thrown\r\njava.sql.SQLException: An unexpected exception was thrown\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:95)\r\n\tat org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:142)\r\n\tat org.apache.derby.impl.jdbc.Util.seeNextException(Util.java:278)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:403)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:348)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2284)\r\n\tat org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:82)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1333)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1686)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeUpdate(EmbedPreparedStatement.java:308)\r\n\tat ReproReuseStream.execute(ReproReuseStream.java:64)\r\n\tat ReproReuseStream.main(ReproReuseStream.java:27)\r\nCaused by: java.sql.SQLException: An unexpected exception was thrown\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory40.java:119)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:70)\r\n\t... 11 more\r\nCaused by: java.sql.SQLException: Java exception: 'Stream has already been read and end-of-file reached and cannot be re-used.: java.io.EOFException'.\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory40.java:119)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:70)\r\n\tat org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:142)\r\n\tat org.apache.derby.impl.jdbc.Util.javaException(Util.java:299)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:408)\r\n\t... 9 more\r\nCaused by: java.io.EOFException: Stream has already been read and end-of-file reached and cannot be re-used.\r\n\tat org.apache.derby.iapi.types.RawToBinaryFormatStream.read(RawToBinaryFormatStream.java:254)\r\n\tat org.apache.derby.impl.store.raw.data.MemByteHolder.write(MemByteHolder.java:146)\r\n\tat org.apache.derby.impl.store.raw.data.RememberBytesInputStream.fillBuf(RememberBytesInputStream.java:135)\r\n\tat org.apache.derby.impl.store.raw.data.StoredPage.logColumn(StoredPage.java:6197)\r\n\tat org.apache.derby.impl.store.raw.data.StoredPage.logRow(StoredPage.java:3972)\r\n\tat org.apache.derby.impl.store.raw.data.InsertOperation.writeOptionalDataToBuffer(InsertOperation.java:370)\r\n\tat org.apache.derby.impl.store.raw.data.InsertOperation.<init>(InsertOperation.java:115)\r\n\tat org.apache.derby.impl.store.raw.data.LoggableActions.actionInsert(LoggableActions.java:139)\r\n\tat org.apache.derby.impl.store.raw.data.BasePage.insertNoOverflow(BasePage.java:602)\r\n\tat org.apache.derby.impl.store.raw.data.BasePage.insertAtSlot(BasePage.java:523)\r\n\tat org.apache.derby.impl.store.raw.data.StoredPage.insertAtSlot(StoredPage.java:6771)\r\n\tat org.apache.derby.impl.store.raw.data.BasePage.insert(BasePage.java:629)\r\n\tat org.apache.derby.impl.store.access.heap.HeapController.doInsert(HeapController.java:255)\r\n\tat org.apache.derby.impl.store.access.heap.HeapController.insertAndFetchLocation(HeapController.java:599)\r\n\tat org.apache.derby.impl.sql.execute.RowChangerImpl.insertRow(RowChangerImpl.java:452)\r\n\tat org.apache.derby.impl.sql.execute.InsertResultSet.normalInsertCore(InsertResultSet.java:1028)\r\n\tat org.apache.derby.impl.sql.execute.InsertResultSet.open(InsertResultSet.java:505)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:436)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:317)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1241)\r\n\t... 4 more\r\nGo ahead and commit so we can see the wrong data.\r\nID         |MNAME                                                                                                                           |MVALUE     |BYTEDATA                                                                                                                        |CHARDATA                                                                                                                        \r\n--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n1          |mname                                                                                                                           |0          |6363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636&|ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc&\r\n\r\n########################################################\r\n#\r\n#\tjdbc:derby://localhost:8246/memory:db2;create=true\r\n#\r\n########################################################\r\n\r\nInsert row 1 \r\nTry to insert row 2 with reused streams \r\nCaught SQLException. SQLState = XN017\r\nNetwork protocol error: end of stream prematurely reached, parameter #4.  Remaining data has been padded with 0x0.\r\njava.sql.SQLException: Network protocol error: end of stream prematurely reached, parameter #4.  Remaining data has been padded with 0x0.\r\n\tat org.apache.derby.client.am.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:96)\r\n\tat org.apache.derby.client.am.SqlException.getSQLException(SqlException.java:358)\r\n\tat org.apache.derby.client.am.PreparedStatement.executeUpdate(PreparedStatement.java:403)\r\n\tat ReproReuseStream.execute(ReproReuseStream.java:64)\r\n\tat ReproReuseStream.main(ReproReuseStream.java:28)\r\nCaused by: org.apache.derby.client.am.SqlException: Network protocol error: end of stream prematurely reached, parameter #4.  Remaining data has been padded with 0x0.\r\n\tat org.apache.derby.client.net.Request.writePlainScalarStream(Request.java:339)\r\n\tat org.apache.derby.client.net.Request.writeScalarStream(Request.java:247)\r\n\tat org.apache.derby.client.net.NetStatementRequest.buildEXTDTA(NetStatementRequest.java:983)\r\n\tat org.apache.derby.client.net.NetStatementRequest.writeExecute(NetStatementRequest.java:152)\r\n\tat org.apache.derby.client.net.NetPreparedStatement.writeExecute_(NetPreparedStatement.java:178)\r\n\tat org.apache.derby.client.am.PreparedStatement.writeExecute(PreparedStatement.java:1791)\r\n\tat org.apache.derby.client.am.PreparedStatement.flowExecute(PreparedStatement.java:2021)\r\n\tat org.apache.derby.client.am.PreparedStatement.executeUpdateX(PreparedStatement.java:408)\r\n\tat org.apache.derby.client.am.PreparedStatement.executeUpdate(PreparedStatement.java:394)\r\n\t... 2 more\r\nGo ahead and commit so we can see the wrong data.\r\nID         |MNAME                                                                                                                           |MVALUE     |BYTEDATA                                                                                                                        |CHARDATA                                                                                                                        \r\n--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n1          |mname                                                                                                                           |0          |6363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636&|ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc&\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-11-18T19:29:48.637+0000","updated":"2010-11-18T19:29:48.637+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12933876","id":"12933876","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching StreamError.java. This class shows another error related to the exception processing in this part of our network driver.\r\n\r\nThe attached StreamError class raises an ArrayIndexOutOfBoundsException half way through reading the input stream. All sorts of Exceptions could be raised by a user-written InputStream. But the network client only looks for IOExceptions. If the network client sees an IOException, then you get the behavior described by this bug report: the user sees a puzzling protocol error when there is no real protocol error. The error is in the InputStream which is running purely on the client-side. If the InputStream raises an exeption other than an IOException, then a protocol error does not return to the user. Instead, the error raised by the stream percolates up to higher levels of exception management in the client driver. However, in that case a real protocol error follows and you see two consequences:\r\n\r\n1) In the server log you see the following protocol error:\r\n\r\norg.apache.derby.impl.drda.DRDAProtocolException: Execution failed because of a Distributed Protocol Error:  DRDA_Disconnect; CODPNT arg  = 0; Error Code Value = 0,DDMReader.fill(),InputStream.read(),insufficient data,*\r\n\tat org.apache.derby.impl.drda.DRDAProtocolException.newDisconnectException(DRDAProtocolException.java:325)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.markCommunicationsFailure(DRDAConnThread.java:503)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.markCommunicationsFailure(DRDAConnThread.java:472)\r\n\tat org.apache.derby.impl.drda.DDMReader.fill(DDMReader.java:1965)\r\n\tat org.apache.derby.impl.drda.DDMReader.ensureALayerDataInBuffer(DDMReader.java:1684)\r\n\tat org.apache.derby.impl.drda.DDMReader.readDSSContinuationHeader(DDMReader.java:1225)\r\n\tat org.apache.derby.impl.drda.DDMReader.readLOBChunk(DDMReader.java:1122)\r\n\tat org.apache.derby.impl.drda.DDMReader.readLOBContinuationStream(DDMReader.java:1099)\r\n\tat org.apache.derby.impl.drda.StandardEXTDTAReaderInputStream.nextBuffer(StandardEXTDTAReaderInputStream.java:183)\r\n\tat org.apache.derby.impl.drda.StandardEXTDTAReaderInputStream.read(StandardEXTDTAReaderInputStream.java:116)\r\n\tat java.io.FilterInputStream.read(FilterInputStream.java:116)\r\n\tat org.apache.derby.iapi.services.io.LimitInputStream.read(LimitInputStream.java:74)\r\n\tat org.apache.derby.iapi.types.RawToBinaryFormatStream.read(RawToBinaryFormatStream.java:273)\r\n\tat org.apache.derby.impl.store.raw.data.MemByteHolder.write(MemByteHolder.java:146)\r\n\tat org.apache.derby.impl.store.raw.data.RememberBytesInputStream.fillBuf(RememberBytesInputStream.java:135)\r\n\tat org.apache.derby.impl.store.raw.data.StoredPage.logColumn(StoredPage.java:6197)\r\n\tat org.apache.derby.impl.store.raw.data.StoredPage.logLongColumn(StoredPage.java:6044)\r\n\tat org.apache.derby.impl.store.raw.data.InsertOperation.writeOptionalDataToBuffer(InsertOperation.java:367)\r\n\tat org.apache.derby.impl.store.raw.data.InsertOperation.<init>(InsertOperation.java:115)\r\n\tat org.apache.derby.impl.store.raw.data.LoggableActions.actionInsert(LoggableActions.java:139)\r\n\tat org.apache.derby.impl.store.raw.data.BasePage.insertLongColumn(BasePage.java:938)\r\n\tat org.apache.derby.impl.store.raw.data.BasePage.insertAllowOverflow(BasePage.java:763)\r\n\tat org.apache.derby.impl.store.raw.data.BasePage.insert(BasePage.java:632)\r\n\tat org.apache.derby.impl.store.access.heap.HeapController.doInsert(HeapController.java:307)\r\n\tat org.apache.derby.impl.store.access.heap.HeapController.insert(HeapController.java:575)\r\n\tat org.apache.derby.impl.sql.execute.RowChangerImpl.insertRow(RowChangerImpl.java:457)\r\n\tat org.apache.derby.impl.sql.execute.InsertResultSet.normalInsertCore(InsertResultSet.java:1028)\r\n\tat org.apache.derby.impl.sql.execute.InsertResultSet.open(InsertResultSet.java:505)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:436)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:317)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1241)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1686)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(EmbedPreparedStatement.java:1341)\r\n\tat org.apache.derby.impl.drda.DRDAStatement.execute(DRDAStatement.java:672)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(DRDAConnThread.java:4316)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(DRDAConnThread.java:4133)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThread.java:1021)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:294)\r\n\r\n2) After that, an attempt to shutdown the server results in the following error on the client (the next attempt to shutdown the server succeeds, however):\r\n\r\nFri Nov 19 09:00:38 PST 2010 : Invalid reply header from network server: Invalid string ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-11-19T17:25:05.271+0000","updated":"2010-11-19T17:25:05.271+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12933878","id":"12933878","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-4315-01-aa-regularizeExceptionHandling.diff. This patch causes the offending logic in the network client to catch all exceptions from InputStreams, and not just IOExceptions. Running regression tests now.\r\n\r\nAfter applying this patch, we will not see protocol errors when InputStream.read() raises an exception other than an IOException. However, those other exceptions will be wrapped with the bogus protocol error status described by this bug.\r\n\r\nTouches the following files:\r\n\r\nM      java/client/org/apache/derby/client/net/Request.java\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-11-19T17:31:51.143+0000","updated":"2010-11-19T17:31:51.143+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12933960","id":"12933960","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching a second rev of this initial patch, derby-4315-01-ab-regularizeExceptionHandling.diff. The tests ran cleanly except for a suspicious error in NetworkServerMBeanTest. I have revamped the patch to improve error messages for the cases touched by this patch. I will re-run the tests.\r\n\r\nThe error messages no longer falsely claim that a protocol error occurred. In addition, I tried to clarify the description of how the client driver recovers from the exception.\r\n\r\nThis is the suspicious error I saw in NetworkServerMBeanTest. When I ran the test standalone, I saw no errors. However, we know from past experience that NetworkServerMBeanTest is sensitive to interference from tests which run before it:\r\n\r\n1) testAttributeAccumulatedConnectionCount(org.apache.derbyTesting.functionTests.tests.management.NetworkServerMBeanTest)java.security.PrivilegedActionException: javax.management.InstanceNotFoundException: org.apache.derby:type=NetworkServer,system=c013800d-012c-658f-2b31-ffffe1d7aa3e\r\n\tat java.security.AccessController.doPrivileged(Native Method)\r\n\tat org.apache.derbyTesting.functionTests.tests.management.MBeanTest.getAttribute(MBeanTest.java:379)\r\n\tat org.apache.derbyTesting.functionTests.tests.management.NetworkServerMBeanTest.testAttributeAccumulatedConnectionCount(NetworkServerMBeanTest.java:93)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\r\n\tat org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:109)\r\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)\r\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:21)\r\n\tat junit.extensions.TestSetup.run(TestSetup.java:25)\r\n\tat org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)\r\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:21)\r\n\tat junit.extensions.TestSetup.run(TestSetup.java:25)\r\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)\r\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:21)\r\n\tat junit.extensions.TestSetup.run(TestSetup.java:25)\r\n\tat org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\nCaused by: javax.management.InstanceNotFoundException: org.apache.derby:type=NetworkServer,system=c013800d-012c-658f-2b31-ffffe1d7aa3e\r\n\tat com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.getMBean(DefaultMBeanServerInterceptor.java:1010)\r\n\tat com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.getAttribute(DefaultMBeanServerInterceptor.java:627)\r\n\tat com.sun.jmx.mbeanserver.JmxMBeanServer.getAttribute(JmxMBeanServer.java:659)\r\n\tat org.apache.derbyTesting.functionTests.tests.management.MBeanTest$4.run(MBeanTest.java:382)\r\n\t... 41 more\r\n\r\nFAILURES!!!\r\nTests run: 8871,  Failures: 0,  Errors: 1\r\n\r\n----------------\r\n\r\nTouches the following files:\r\n\r\nM      java/engine/org/apache/derby/loc/messages.xml\r\nM      java/shared/org/apache/derby/shared/common/reference/SQLState.java\r\nM      java/client/org/apache/derby/client/net/Request.java\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-11-19T20:24:46.879+0000","updated":"2010-11-19T20:24:46.879+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12934075","id":"12934075","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Tests passed cleanly for me on derby-4315-01-ab-regularizeExceptionHandling.diff except for the ping test which regularly fails on mac os x.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-11-20T01:49:22.454+0000","updated":"2010-11-20T01:49:22.454+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12934462","id":"12934462","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Committed derby-4315-01-ab-regularizeExceptionHandling.diff at subversion revision 1037716.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-11-22T13:44:52.393+0000","updated":"2010-11-22T13:44:52.393+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12934471","id":"12934471","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-4315-02-aa-cleanupEndOfStreamMessage.diff. This patch cleans up the error reporting in the case when the InputStream at the client has fewer bytes than expected. The message no longer says that there is a protocol error. Running tests now.\r\n\r\nTouches the following file:\r\n\r\nM      java/engine/org/apache/derby/loc/messages.xml\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-11-22T14:12:22.800+0000","updated":"2010-11-22T14:12:22.800+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12934502","id":"12934502","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Committed derby-4315-02-aa-cleanupEndOfStreamMessage.diff at subversion revision 1037764. The tests passed cleanly for me although I did see the following exception on the console while running the JUnit tests:\r\n\r\nException in thread \"DRDAConnThread_508\" org.apache.derby.iapi.error.ShutdownException: \r\n\tat org.apache.derby.iapi.services.context.ContextManager.checkInterrupt(ContextManager.java:437)\r\n\tat org.apache.derby.iapi.services.context.ContextManager.getContext(ContextManager.java:155)\r\n\tat org.apache.derby.iapi.services.context.ContextService.getContextOrNull(ContextService.java:249)\r\n\tat org.apache.derby.iapi.util.InterruptStatus.restoreIntrFlagIfSeen(InterruptStatus.java:158)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:356)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2284)\r\n\tat org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:82)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.closeActions(EmbedPreparedStatement.java:261)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.close(EmbedStatement.java:307)\r\n\tat org.apache.derby.impl.drda.DRDAStatement.close(DRDAStatement.java:1027)\r\n\tat org.apache.derby.impl.drda.Database.close(Database.java:364)\r\n\tat org.apache.derby.impl.drda.Session.close(Session.java:115)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.closeSession(DRDAConnThread.java:8289)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:315)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-11-22T16:20:30.066+0000","updated":"2010-11-22T16:20:30.066+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12934517","id":"12934517","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Ported 1037716 from trunk to 10.7 branch at subversion revision 1037776.\r\n\r\nPorted 1037764 from trunk to 10.7 branch at subversion revision 1037777.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-11-22T17:18:44.757+0000","updated":"2010-11-22T17:18:44.757+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12934519","id":"12934519","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"I believe that both parts of this bug have been addressed now. The bad row is not being inserted anymore and the EOF error no longer asserts that there was a protocol error.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-11-22T17:22:45.988+0000","updated":"2010-11-22T17:22:45.988+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12989886","id":"12989886","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Reopen for backport.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-02-02T23:41:02.968+0000","updated":"2011-02-02T23:41:02.968+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12995573","id":"12995573","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"While the commit with this issue merges cleanly to 10.5, it is I think a patch to regularize the exception handling between server and client.  Since it changes the SQLState, I don't think it is such a good candidate for backport. The actual fix is with DERBY-2017 which looks too hairy to me if not impossible to backport to 10.5 as it makes some protocol changes that might be problematic with mixed version, but I have not looked that closely.  I think I will take this one off the backport list.  I am thinking I should introduce a label for tracking issues that have been considered and then rejected for backport. I will send a separate mail to derby-dev for that.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-02-16T23:14:30.896+0000","updated":"2011-02-16T23:14:30.896+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/12995580","id":"12995580","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Resolve issue. Decided against backport.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-02-16T23:32:10.809+0000","updated":"2011-02-16T23:32:10.809+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430835/comment/13685290","id":"13685290","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"[bulk update] Close all resolved issues that haven't been updated for more than one year.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-06-17T09:19:35.320+0000","updated":"2013-06-17T09:19:35.320+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4315/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06jiv:"}}
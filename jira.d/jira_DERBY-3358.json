{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12387364","self":"https://issues.apache.org/jira/rest/api/latest/issue/12387364","key":"DERBY-3358","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2008-01-29 10:34:44.631","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23593","customfield_12310222":"1_*:*_1_*:*_5956341600_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-04-07T08:51:43.090+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3358/watchers","watchCount":0,"isWatching":false},"created":"2008-01-29T10:19:21.490+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"12.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12319400","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12319400","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"inwardIssue":{"id":"12390029","key":"DERBY-3489","self":"https://issues.apache.org/jira/rest/api/2/issue/12390029","fields":{"summary":"Error message XRE04 does not include the right port number.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-02T02:29:13.422+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312050","id":"12312050","name":"Replication"}],"timeoriginalestimate":null,"description":"Slave and master servers started.\n\nstartSlave:\nCONNECT 'jdbc:derby://atum11:9999/test;startSlave=true;slaveHost=atum11;slavePort=8989';\nERROR XRE08: DERBY SQL error: SQLCODE: -1, SQLSTATE: XRE08, SQLERRMC: Replication slave mode started successfully for database 'test'. Connection refused because the database is in replication slave mode. \n\nstartMaster without specifying slavePort - will use default?\nCONNECT 'jdbc:derby://atum11:8888/test;startMaster=true;slaveHost=atum11';\nERROR XRE04: DERBY SQL error: SQLCODE: -1, SQLSTATE: XRE04, SQLERRMC: nullXRE04\nmaster derby.log:\n2008-01-29 10:02:53.097 GMT:\n Booting Derby version The Apache Software Foundation - Apache Derby - 10.4.0.0 alpha - (615841M): instance c013800d-0117-c4fb-9156-000003bf6570\non database directory /export/home/tmp/os136789/Replication_common_Trunk/master/test  \n\nDatabase Class Loader started - derby.database.classpath=''\n2008-01-29 10:02:53.256 GMT Thread[DRDAConnThread_2,5,main] (XID = 419), (SESSIONID = 0), (DATABASE = test), (DRDAID = {1}), Cleanup action starting\njava.sql.SQLException: Could not establish a connection to the peer of the replicated database 'null'.\n.\n.\nCleanup action completed\n2008-01-29 10:02:53.260 GMT Thread[DRDAConnThread_2,5,main] (DATABASE = test), (DRDAID = {1}), Could not establish a connection to the peer of the replicated database 'null'.\n\nstartMaster specyfying slavePort:\nCONNECT 'jdbc:derby://atum11:8888/test;startMaster=true;slaveHost=atum11;slavePort=8989';\nERROR XRE04: DERBY SQL error: SQLCODE: -1, SQLSTATE: XRE04, SQLERRMC: nullXRE04\nmaster derby.log:\n2008-01-29 10:03:38.201 GMT Thread[DRDAConnThread_2,5,main] (XID = 420), (SESSIONID = 1), (DATABASE = test), (DRDAID = {2}), Cleanup action starting\njava.sql.SQLException: Could not establish a connection to the peer of the replicated database 'null'.\n.\n.\nCleanup action completed\n2008-01-29 10:03:38.205 GMT Thread[DRDAConnThread_2,5,main] (DATABASE = test), (DRDAID = {2}), Could not establish a connection to the peer of the replicated database 'null'.\n\n\n\n\nAdditional observation/comment:\n----------------------------------------\nIt would be helpful for debugging if slaveHost and slavePort were written in error messages and into derby.log.\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37343","summary":"After an incorrect(unsuccesfull) startMaster comand, further correct startMaster attempts also fail.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=olesolberg","name":"olesolberg","emailAddress":"Ole dot Solberg at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ole Solberg","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=olesolberg","name":"olesolberg","emailAddress":"Ole dot Solberg at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ole Solberg","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Trunk (615841) + patch DERBY-3205/stopSlave_v1b","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":33,"total":33,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12563456","id":"12563456","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"body":"I think this is caused by not unplugging the Socket in MasterController when the master replication functionality is turned off.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"created":"2008-01-29T10:34:44.631+0000","updated":"2008-01-29T10:34:44.631+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12563458","id":"12563458","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=olesolberg","name":"olesolberg","emailAddress":"Ole dot Solberg at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ole Solberg","active":true},"body":"If in this state we do a stopMaster command a NPE is thrown:\r\n\r\nCONNECT 'jdbc:derby://atum11:8888/test;stopMaster=true';\r\nERROR XJ001: DERBY SQL error: SQLCODE: -1, SQLSTATE: XJ001, SQLERRMC: java.lang.NullPointerExceptionXJ001.U\r\n\r\nmaster derby.log:\r\n2008-01-29 10:24:07.228 GMT Thread[DRDAConnThread_4,5,main] (XID = 423), (SESSIONID = 4), (DATABASE = test), (DRDAID = {6}), Cleanup action starting\r\njava.lang.NullPointerException\r\n\tat org.apache.derby.impl.services.replication.master.MasterController.stopMaster(MasterController.java:213)\r\n\tat org.apache.derby.impl.store.raw.RawStore.stopReplicationMaster(RawStore.java:526)\r\n\tat org.apache.derby.impl.store.access.RAMAccessManager.stopReplicationMaster(RAMAccessManager.java:938)\r\n\tat org.apache.derby.impl.db.BasicDatabase.stopReplicationMaster(BasicDatabase.java:388)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.handleStopReplicationMaster(EmbedConnection.java:683)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.<init>(EmbedConnection.java:344)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection30.<init>(EmbedConnection30.java:73)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection40.<init>(EmbedConnection40.java:54)\r\n\tat org.apache.derby.jdbc.Driver40.getNewEmbedConnection(Driver40.java:68)\r\n\tat org.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:211)\r\n\tat org.apache.derby.jdbc.AutoloadedDriver.connect(AutoloadedDriver.java:119)\r\n\tat org.apache.derby.impl.drda.Database.makeConnection(Database.java:234)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.getConnFromDatabaseName(DRDAConnThread.java:1346)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.verifyUserIdPassword(DRDAConnThread.java:1296)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.parseSECCHK(DRDAConnThread.java:3033)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.parseDRDAConnection(DRDAConnThread.java:1090)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThread.java:932)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:277)\r\nCleanup action completed\r\n2008-01-29 10:24:07.228 GMT Thread[DRDAConnThread_4,5,main] Cleanup action starting\r\njava.lang.NullPointerException\r\n\tat org.apache.derby.impl.services.replication.master.MasterController.stopMaster(MasterController.java:213)\r\n\tat org.apache.derby.impl.store.raw.RawStore.stopReplicationMaster(RawStore.java:526)\r\n\tat org.apache.derby.impl.store.access.RAMAccessManager.stopReplicationMaster(RAMAccessManager.java:938)\r\n\tat org.apache.derby.impl.db.BasicDatabase.stopReplicationMaster(BasicDatabase.java:388)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.handleStopReplicationMaster(EmbedConnection.java:683)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.<init>(EmbedConnection.java:344)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection30.<init>(EmbedConnection30.java:73)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection40.<init>(EmbedConnection40.java:54)\r\n\tat org.apache.derby.jdbc.Driver40.getNewEmbedConnection(Driver40.java:68)\r\n\tat org.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:211)\r\n\tat org.apache.derby.jdbc.AutoloadedDriver.connect(AutoloadedDriver.java:119)\r\n\tat org.apache.derby.impl.drda.Database.makeConnection(Database.java:234)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.getConnFromDatabaseName(DRDAConnThread.java:1346)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.verifyUserIdPassword(DRDAConnThread.java:1296)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.parseSECCHK(DRDAConnThread.java:3033)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.parseDRDAConnection(DRDAConnThread.java:1090)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThread.java:932)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:277)\r\nCleanup action completed\r\n2008-01-29 10:24:07.231 GMT Thread[DRDAConnThread_4,5,main] (DATABASE = test), (DRDAID = {6}), Java exception: ': java.lang.NullPointerException'.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=olesolberg","name":"olesolberg","emailAddress":"Ole dot Solberg at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ole Solberg","active":true},"created":"2008-01-29T10:36:27.487+0000","updated":"2008-01-29T10:36:27.487+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12566992","id":"12566992","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"The boot method of the service module is called only once upon boot time. On all other times\r\nthis method will not be called. We pass the host name and the port number in a properties\r\nobject where the attributes replicationMode, slavehost, slaveport, dbname are initialized.\r\n(I confirmed this by printing the slavehost and the slaveport in the boot method and noticed that\r\nthis gets printed only once during the initial initialization).\r\n\r\nThe first time startMaster happens with the wrong port number these attributes are intialized\r\nand do not get initialized on subsequent calls to startMaster since the boot method is never\r\ncalled. Hence we keep trying with the first initialized values resulting in the connection\r\nproblems.\r\n\r\nA simple solution would be to move initialization of the attributes to the call to startMaster.\r\n\r\nI think a similar thing would need to be done for the other replication commands as well.\r\n\r\nI am not an expert in the Module and Monitor part of the codebase. I am hoping that people who\r\nare familiar with this area could pls tell me if my analysis is correct and if the fix proposed\r\nwould be the right one to go with.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-08T11:33:55.683+0000","updated":"2008-02-08T11:33:55.683+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12567023","id":"12567023","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"body":"I don't think the problem is best solved by moving code from MasterController#boot to MC#startMaster, but rather to unboot the MasterFactory if startMaster fails by throwing an exception. \r\n\r\nWhile experimenting with this I found another closely related bug though: after a successful startMaster, a new startMaster connection attempt will hang. Instead of a hang, it should throw an exception.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"created":"2008-02-08T12:51:36.044+0000","updated":"2008-02-08T12:51:36.044+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12567026","id":"12567026","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"body":"Hang in master server if startMaster command is given twice already reported by  Ole Solberg: https://issues.apache.org/jira/browse/DERBY-3374","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"created":"2008-02-08T12:57:11.010+0000","updated":"2008-02-08T12:57:11.010+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12568058","id":"12568058","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":">I don't think the problem is best solved by moving code from MasterController#boot \r\n>to MC#startMaster, but rather to unboot the MasterFactory if startMaster fails by \r\n>throwing an exception.\r\n\r\nA module can be stopped. I guess that is what you meant by unbooted here. The\r\njavadoc for the stop method says this\r\n\r\n\"The module may be found via a findModule() method until some time after\r\n this method returns. Therefore the factory must be prepared to reject requests\r\n to it once it has been stopped. In addition other modules may cache a reference\r\n to the module and make requests of it after it has been stopped, these requests\r\n should be rejected as well.\"\r\n\r\nBasically you would not be clearing the startup parameters or making the findServiceModule\r\nreturn a null or invalid value by stopping(unbooting). It is upto to the logic within the\r\nMasterController to handle this.\r\n\r\nI still do not think hostName and portNumber ought to be startup parameters for the MasterController\r\nmodule.\r\n\r\nI think they are parameters for the master start (replication start) functionality and ought to form\r\npart of the paramters of the startMasterController method.\r\n\r\nSuppose the other functionality provided stop, failover required specific paramters to be passed\r\nwe would need to pass them while calling these methods, what would happen if one of these parameters\r\nhad been wrong? I think the same case applies to startMaster as well. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-12T11:29:22.109+0000","updated":"2008-02-12T11:29:22.109+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12568063","id":"12568063","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"body":"No, what I mean with \"unboot\" is to remove the module from the monitor. The monitor should in turn be calling MasterFactory#stop.\r\n\r\nUnless we remove the module from the monitor, there will always be a reference to this object even when replication is not running. Hence, gc cannot remove the object from memory. I think that qualifies as a memory leak.\r\n\r\nI have no idea how to unboot a module. I have the same problem with removing the SlaveFactory after a successful failover. I experimented a little bit with Monitor.getMonitor().shutdown(slaveFac) in SlaveDatabase, but it seems to shutdown the entire database. This is, of course, unacceptable.\r\n\r\nI see this text in the Monitor class javadoc:\r\n\r\n\"Optionally -  an individual module within a service may be shutdown, this will in turn shutdown any modules it started if those module are not in use by other modules within the service. This would be handled by the monitor, not the module itself. \"\r\n\r\nHowever, I can't see that this functionality has been implemented.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"created":"2008-02-12T11:54:02.153+0000","updated":"2008-02-12T11:54:02.153+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12568107","id":"12568107","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":">However, I can't see that this functionality has been implemented.\r\n\r\ni did not either and that is why I thought that you had thought about stop.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-12T13:30:37.043+0000","updated":"2008-02-12T13:30:37.043+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12571983","id":"12571983","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"There seems to be no satisfactory solution to unbooting a module.\r\n\r\nHence I am going ahead with the workaround suggested by me earlier.\r\n\r\nPlease find below the workaround implementation explained in more detail.\r\n\r\nImplementation description\r\n---------------------------\r\n\r\nThe properties object that is passed to the boot method can no longer\r\nbe used to initialize the MasterController startup parameters. This needs\r\nto be moved to the startMaster method.\r\n\r\nA successful startup should be recorded by a boolean variable (active).\r\n\r\nEach of the methods (other than startMaster) in the MasterController that form the interface to this module\r\n\r\n* stopMaster\r\n* startFailover\r\n\r\nshould check for the boolean variable active. If it is false they should throw an exception stating that\r\nthe master module is not active.\r\n\r\nactive should be set to false in \r\n\r\n* stopMaster and \r\n* when startMaster fails.\r\n\r\nA few observations\r\n------------------\r\n\r\nstopMaster is called from printStackAndStopMaster. printStackAndStopMaster is specifically a method\r\nthat logs log shipper exceptions. So doing a logShipper.flushBuffer() in stopMaster does not seem logical.\r\nI will wait till later today to raise a separate JIRA for this. I do not want to fix this issue as part of this JIRA.\r\n\r\nA possible fix for the above would be to separate the flushBuffer and the stopMaster operations.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-24T23:24:20.480+0000","updated":"2008-02-24T23:24:20.480+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12572038","id":"12572038","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"Please find below a file by file explanation of the changes for this patch\r\n\r\nM      java/engine/org/apache/derby/impl/services/replication/master/MasterController.java\r\n\r\n* Added a variable boolean that indicates whether the master controller is currently running or has\r\n  been stopped. I thought I could manage with the earlier boolean variable stopMasterController but\r\n  decided against it because it seemed more tied with the stopMaster operation.\r\n\r\n* moved start up parameter initialization from boot to startMaster method. This makes the canSupport\r\n  method also a place holder that returns true always.\r\n\r\n* changed the startMaster, stopMaster and the startFailover methods to take into account the boolean\r\n  active.\r\n\r\n* replaced the earlier uses of stopMasterController with active.\r\n  \r\nM      java/engine/org/apache/derby/impl/store/raw/RawStore.java\r\n\r\n* The replication properties that are part of the bootServiceModule call no longer contain the\r\n  startup parameters. These have instead been moved to the startMaster method.\r\n\r\n* The replicationProps are empty and not null because a null passed to a bootServiceModule call\r\n  results in a NullPointerException.\r\n\r\nM      java/engine/org/apache/derby/iapi/services/replication/master/MasterFactory.java\r\n\r\n* Changed the startMaster declaration to now accept the startup parameters as the method arguments.\r\n\r\nM      java/engine/org/apache/derby/loc/messages.xml\r\nM      java/shared/org/apache/derby/shared/common/reference/SQLState.java\r\n\r\n* Added two new messages for the cases when the master has already been booted and when the given\r\n  replication mode is not supported.\r\n\r\n--------------------------------------------------------------------------------------------------\r\n\r\nI tried running a repro where I connected multiple times with the wrong port number to the slave and finally attempted\r\na right connection. It works OK for me.\r\n\r\nij> connect 'jdbc:derby://localhost:1527/replicationdb';\r\nij> connect 'jdbc:derby://localhost:1527/replicationdb;startMaster=true;slaveHost=localhost;slavePort=8002';\r\nERROR XJ001: DERBY SQL error: SQLCODE: -1, SQLSTATE: XJ001, SQLERRMC: java.lang.NullPointerExceptionXJ001.U\r\nij> connect 'jdbc:derby://localhost:1527/replicationdb;startMaster=true;slaveHost=localhost;slavePort=8003';\r\nERROR XJ001: DERBY SQL error: SQLCODE: -1, SQLSTATE: XJ001, SQLERRMC: java.lang.NullPointerExceptionXJ001.U\r\nij> connect 'jdbc:derby://localhost:1527/replicationdb;startMaster=true;slaveHost=localhost;slavePort=8004';\r\nERROR XJ001: DERBY SQL error: SQLCODE: -1, SQLSTATE: XJ001, SQLERRMC: java.lang.NullPointerExceptionXJ001.U\r\nij>  connect 'jdbc:derby://localhost:1527/replicationdb;startMaster=true;slaveHost=localhost;slavePort=8001';\r\nij(CONNECTION1)> select * from employee;\r\nEMPNO      |NAME                          \r\n------------------------------------------\r\n1          |narayanan                     \r\n2          |satya                         \r\n3          |sanjay                        \r\n4          |Anurag                        \r\n\r\n4 rows selected\r\nij(CONNECTION1)> drop table employee;\r\n0 rows inserted/updated/deleted\r\nij(CONNECTION1)> create table test(i int primary key, name varchar(40));\r\n0 rows inserted/updated/deleted\r\nij(CONNECTION1)> insert into test values(1,'N');\r\n1 row inserted/updated/deleted\r\nij(CONNECTION1)> insert into test values(2,'A');\r\n1 row inserted/updated/deleted\r\nij(CONNECTION1)> insert into test values(3,'R');\r\n1 row inserted/updated/deleted\r\nij(CONNECTION1)> select * from test;\r\nI          |NAME                                    \r\n----------------------------------------------------\r\n1          |N                                       \r\n2          |A                                       \r\n3          |R                                       \r\n\r\n3 rows selected\r\nij(CONNECTION1)> connect 'jdbc:derby://localhost:1527/replicationdb;failover=true';\r\nERROR XRE20: DERBY SQL error: SQLCODE: -1, SQLSTATE: XRE20, SQLERRMC: Failover performed successfully for database 'replicationdb', the database has been shutdown.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-25T09:53:50.318+0000","updated":"2008-02-25T09:53:50.318+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12572441","id":"12572441","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"Thanks, for your patch Narayanan.  I tried testing the patch, but the\r\nbug reported in DERBY-3454 seems to get in the way.  Her are my\r\ncomments: \r\n\r\n1. MasterController:\r\n\r\n   a. boot():  An explanation of why boot is empty would be good.\r\n      \r\n   b. canSupport(): I do not see that it is necessary to change this\r\n      implementation.  This implementation implemenation still only\r\n      supports asynchronous replication.\r\n\r\n   c. I feel the comments regarding the testing of active in\r\n      startMaster, stopMaster, and startFailover is a bit confusing.\r\n      It seems to be more a documentation of the change that is made\r\n      than of the resulting code, and I fear that it may confuse\r\n      people who do not know the history of the code.  Also, I am not\r\n      sure your use of 'idempotent' makes sense.\r\n\r\n   d. startMaster(): Why not merge the to tests that give\r\n      REPLICATION_MODE_NOT_SUPPORTED in the same if statement?\r\n\r\n2. RawStore:\r\n\r\n   a. It seems unecessary that RawStore#startReplicationMaster convert\r\n      port number to String, and that MasterController#startMaster\r\n      needs to convert it back to int.\r\n\r\n3. Messages\r\n\r\n   a. To be similar to the existing messages, I suggest leaving 'the'\r\n      in '... has already been booted for the database ...'\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-02-26T11:57:25.704+0000","updated":"2008-02-26T11:57:25.704+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12572796","id":"12572796","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"Oystein says\r\n\r\n> Also, I am not sure your use of 'idempotent' makes sense.\r\n\r\nComments in the patch\r\n\r\n> This makes the stopMaster\r\n> //operation idempotent, will keep returning successfully when\r\n> //repeatedly called on an already started replication instance.\r\n\r\nA link I found on the web\r\n\r\nhttp://nostalgia.wikipedia.org/wiki/Idempotent\r\n\r\nThe link says\r\n\r\n>In computing, the term idempotent refers to something \r\n>which has the same  effect if used multiple times as it does \r\n>if used only once.\r\n\r\nI find the usage of idempotent appropriate in the context of the stopMaster\r\nmethod. I do not think it is mis-placed. But I have no problems removing the\r\nword and replacing it with a simpler sentence.\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-27T05:47:33.410+0000","updated":"2008-02-27T05:47:33.410+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12572798","id":"12572798","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":">I feel the comments regarding the testing of active in\r\n>startMaster, stopMaster, and startFailover is a bit confusing.\r\n>It seems to be more a documentation of the change that is made\r\n>than of the resulting code, and I fear that it may confuse\r\n>people who do not know the history of the code.\r\n\r\nGeneral view (my thinking when I wrote the comments)\r\n\r\nI wrote the comments from the point of view of a person who\r\nwould try to understand this code while single stepping using\r\nan IDE.\r\n\r\nI have also tried to explain why I tried to write the methods the\r\nway I have in the individual methods.\r\n\r\nI would really appreciate it if you could give an example for just\r\none method, re-wording the comments in a way you think is right\r\nso that I can follow the same on the other methods. \r\n\r\ncomments in startMaster\r\n\r\n>//Check if the master has already been started. It is wrong to attempt \r\n>//startMaster on a already running master since the start parameters\r\n>//can vary with each start and the question of idempotence is not\r\n>//applicable here (unlike stopMaster).\r\n\r\nI was trying to say that taking a connection with the startMaster\r\nattribute repeatedly should throw an exception. Can you please give\r\nan example as to what would be an appropriating re-wording here?\r\nWas the problem with the usage of the word idempotent? Was the mention\r\nof the start parameters a implementation specific thing that should\r\nbe avoided?\r\n\r\ncomments in stopMaster\r\n\r\n>//This can happen only if the replication master module was\r\n>//loaded previously and was later stopped. If replication was\r\n>//never loaded an exception would be thrown because the master\r\n>//factory module will not be found. This makes the stopMaster\r\n>//operation idempotent, will keep returning successfully when\r\n>//repeatedly called on an already started replication instance.\r\n\r\nThis comment explains what would happen if a bootServiceModule\r\nwas called and was later stopped by calling a stopMaster or the\r\nboot itself fails. active becomes false.\r\n\r\nI can remove this comment if you think it is inappropriate but\r\nI think it serves to explain why I made the method return harmlessly\r\nwhen it is called repeatedly\r\n\r\nstartFailover\r\n\r\n>//It is not correct to stop the master and then attempt a failover.\r\n>//The control would come here because the master module is already\r\n>//loaded and a findService for the master module will not fail. But\r\n>//since this module has been stopped failover does not suceed.\r\n\r\nI guess you are suggesting that usage of words like findService which is\r\ncode specific is not right?\r\n\r\nBut I thought anyone who would follow the code while sigle-stepping using\r\nan IDE would find this useful because it would explain when the control\r\nwould come here","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-27T06:03:52.703+0000","updated":"2008-02-27T06:03:52.703+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12572800","id":"12572800","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":">boot():  An explanation of why boot is empty would be good.\r\n\r\n>It seems to be more a documentation of the change that is made\r\n>than of the resulting code, and I fear that it may confuse\r\n>people who do not know the history of the code\r\n\r\nIn order to explain why the boot method is empty I would need to\r\nexplain why the change was made (i.e.) mention that the boot\r\nmethod is loaded only once and because of that the boot time\r\nparameters once wrong would result in repeated startMaster attempts\r\nfailing.\r\n\r\nI would in doing the above be contradicting the comment change\r\nrequested in the latter part of the comment I have pasted.\r\n\r\nOr again I am making a mistake of not wording the comments correctly.\r\nCan you please help me with your view of what you think would be a \r\nright wording of the comments here?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-27T06:10:07.919+0000","updated":"2008-02-27T06:10:07.919+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12573137","id":"12573137","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"In the attached patch I have addressed all the comments except\r\nthe following\r\n\r\n>d. startMaster(): Why not merge the to tests that give\r\n>REPLICATION_MODE_NOT_SUPPORTED in the same if statement? \r\n\r\nI have moved this test to canSupport as suggested. So I did not\r\nneed to do this change.\r\n\r\nI added the comments to the boot method, but am not sure\r\nif it matches your expectation. If it does not pls do mention and\r\nI shall submit a new patch.\r\n\r\nI have not changed the comments to active in startMaster, stopMaster and\r\nstartFailover. Here again I am not sure about the nature of the modification\r\nyou expected me to do. I request for more help from you here on the\r\nstyle of the comments that would be expected. I shall submit a new\r\npatch with the suggested modification.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-28T03:03:24.437+0000","updated":"2008-02-28T03:03:24.437+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12573145","id":"12573145","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":">Thanks, for your patch Narayanan. I tried testing the patch, but the\r\n>bug reported in DERBY-3454 seems to get in the way.\r\n\r\nYou are correct. Every wrong connection attempt keeps throwing a\r\nNPE. But when the correct port is mentioned the connection succeeds.\r\nIf the earlier bug, reported in this patch, had existed it would not have\r\nsucceeded, but would have continued with the NPE's.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-28T04:21:29.648+0000","updated":"2008-02-28T04:21:29.648+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12574489","id":"12574489","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"Naraynan, sorry for the late response to your questions to the\r\ncomments I made on your code comments.  I will try to clarify:\r\n\r\n - startMaster: You say: \"It is wrong to attempt startMaster on a\r\n   already running master since the start parameters can vary with\r\n   each start and the question of idempotence is not applicable here\r\n   (unlike stopMaster).\"  In my opinion, attempting startMaster on an\r\n   already running master, should give an exception, not because\r\n   parameters may vary, but because you by definition cannot start an\r\n   already started master.\r\n\r\n - stopMaster: It seems I have misunderstood what the code actually\r\n   does here.  I thought that stopMaster when replication was not on,\r\n   would be flagged as an error, and in my opinion that would be the\r\n   right thing to do.  Anyhow, your implementation does not make\r\n   stopMaster fully idempotent since you will write another\r\n   REPLICATION_MASTER_STOPPED message to derby.log.  I do not think\r\n   that is a good idea since it will make it more difficult to tell\r\n   when the replication was actually stopped.\r\n\r\n - startFailover:  Comment is ok, but should be placed inside if\r\n   statement.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-03-03T13:15:30.943+0000","updated":"2008-03-03T13:15:30.943+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12574492","id":"12574492","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"In addition to my previous post, I have the following comments to the\r\nv2 patch:\r\n\r\n - It seems you have not addressed by 3a comment.  I guess that may be\r\n   my fault since I wrote \"leaving 'the'\" when I meant \"leaving out\r\n   'the'\".\r\n\r\n - MasterFactory: It seems the comment /* Property values */ have been\r\n   moved.  I guess that was not intentional.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-03-03T13:26:14.581+0000","updated":"2008-03-03T13:26:14.581+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12575552","id":"12575552","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"Thank you for the comments Oystein\r\n\r\n>- startMaster: [comment snipped]\r\n\r\nChanged the comment to\r\n\r\n//It is wrong to attempt startMaster on a already\r\n//started master.\r\n\r\nand moved it inside if.\r\n\r\n>- stopMaster: [comment snipped]\r\n\r\nIf the master is not active I now throw an exception\r\n\r\nthrow StandardException.newException\r\n                    (SQLState.REPLICATION_NOT_IN_MASTER_MODE);\r\n\r\n>- startFailover: Comment is ok, but should be placed inside if\r\n>  statement. \r\n\r\nfixed!\r\n\r\n>- It seems you have not addressed by 3a comment. I guess that may be\r\n>  my fault since I wrote \"leaving 'the'\" when I meant \"leaving out\r\n>  'the'\". \r\n\r\nXRE11, XRE06, XRE04 also seem to be using the article 'the'.\r\n\r\nJust to learn more about the use of 'the' I nosed into the\r\nWren and Martin in the rack nearby and found out that 'the'\r\nis a definite article that is used to point out some particular\r\nperson or thing.\r\n\r\nSo in our case we are pointing out a particular specific database!\r\n\r\nBut I agree that the general consensus is leaving out the\r\narticle and also that exceptions messages rarely follow grammatical\r\nrules ( :-D ) but\r\n\r\nplace more emphasis on clarity in summarizing exception cause and in\r\nconformance with messages in the same family!\r\n\r\nfixed it!\r\n\r\n>- MasterFactory: It seems the comment /* Property values */ have been\r\n>  moved. I guess that was not intentional. \r\n\r\nSorry, mea culpa, fixed it!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-03-06T04:00:44.076+0000","updated":"2008-03-06T04:00:44.076+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12575572","id":"12575572","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"oops, I hurried in submitting v3. I found a few problems which I shall duly enumerate\r\nwhen I submit a v4 with the problems I found corrected. I also missed running the repro\r\non this.\r\n\r\nI request v3 to be please ignored","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-03-06T06:20:00.169+0000","updated":"2008-03-06T06:20:00.169+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12575579","id":"12575579","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"In this comment there are two things being suggested for the implementation\r\n\r\n>- stopMaster: It seems I have misunderstood what the code actually\r\n>   does here. I thought that stopMaster when replication was not on,\r\n>   would be flagged as an error, and in my opinion that would be the\r\n>   right thing to do. \r\n\r\nThrow an exception if replication has been stopped\r\n\r\n>   Anyhow, your implementation does not make\r\n>   stopMaster fully idempotent since you will write another\r\n>   REPLICATION_MASTER_STOPPED message to derby.log. I do not think\r\n>   that is a good idea since it will make it more difficult to tell\r\n>   when the replication was actually stopped. \r\n\r\nThis part is confusing,\r\n\r\nI agree that it is not a good idea to write a replication stopped message\r\neach time stopMaster is called\r\n\r\nBut is throwing an exception if replication is stopped suggested? \r\n\r\nOr should the stop master method exit without doing anything?\r\n\r\nI would personally go for throwing the exception, because upon retrospection it\r\nseems the right thing to do to tell the user that replication has been stopped\r\nrather than just be quiet.\r\n\r\nWondering what pushed me towards idempotence in the first place :-/ .\r\n\r\nI will modify v3 to throw an exception. Pls do mention if this is not the right thing\r\nto do.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-03-06T06:31:58.646+0000","updated":"2008-03-06T06:31:58.646+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12575623","id":"12575623","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"Modified stopMaster to throw\r\n\r\nthrow StandardException.newException(SQLState.REPLICATION_MASTER_ALREADY_BOOTED, dbname);\r\n\r\nstopMaster is used in  printStackAndStopMaster(Throwable t). I modified stopMaster to log\r\na ReplicationLogger.logError(MessageId.REPLICATION_MASTER_STOPPED, t, dbname);. The master\r\nis stopped anyways, so I thought it would be OK to use that SQLState.\r\n\r\nThe rest of the changes are identical to the previous patch","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-03-06T09:23:06.494+0000","updated":"2008-03-06T09:23:06.494+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12575624","id":"12575624","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"The repro worked on v4 without problems","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-03-06T09:23:27.477+0000","updated":"2008-03-06T09:23:27.477+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12575651","id":"12575651","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"Thanks for the follow-up on my comments Narayanan.\r\nI have checked that the reported issue has been fixed.\r\nPatch v4 committed as revsion 634218.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-03-06T10:52:39.367+0000","updated":"2008-03-06T10:52:39.367+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12575705","id":"12575705","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"body":"Since stopMaster throws StandardException - isn't it a bit overkill to catch Throwable?\r\n\r\n+        try {\r\n+            stopMaster();\r\n+        } catch (Throwable t_stopmaster) {\r\n+            //The stop master threw an exception saying the replication\r\n+            //has been stopped already.\r\n+            ReplicationLogger.\r\n+                logError(MessageId.REPLICATION_MASTER_STOPPED, t, dbname);\r\n+        }\r\n\r\nBTW: did you mean to log the stack trace of t here or should it be t_stopmaster?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"created":"2008-03-06T13:41:59.376+0000","updated":"2008-03-06T13:41:59.376+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12575729","id":"12575729","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"> Since stopMaster throws StandardException - isn't it a bit overkill to catch Throwable? \r\n\r\nNo I do not think it is Overkill!\r\n\r\nWhen printStackAndStopMaster(Throwable t)  catches all exceptions as a Throwable I think \r\nit only makes it more uniform that the stopMaster exception is caught as a Throwable\r\ntoo.\r\n\r\nI see that logging the stack trace as a issue that needs a follow-up. I meant it to be\r\nt_stopmaster.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-03-06T14:58:35.704+0000","updated":"2008-03-06T14:58:35.704+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12575735","id":"12575735","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"body":"Ok, but is it intentional to e.g. log an OutOfMemoryError as a replication master stopped message?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"created":"2008-03-06T15:09:52.537+0000","updated":"2008-03-06T15:09:52.537+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12575738","id":"12575738","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":">Ok, but is it intentional to e.g. log an OutOfMemoryError as a replication master stopped message?\r\n\r\nThe whole point of a printStackTrace and stop master method I believe was to log the exception stack\r\nfor the problem and let the process from where the method was called proceed unaffected wasn't it?\r\nIf that was the aim I really do not see why I would throw this isolated exception and not log it and\r\nlet it disturb for example the shutdown process of the derby system.\r\n\r\nIf I were to use the stopmaster method as I am going to do for the issue Derby-3447 I would rather log\r\nthe \"OutOfMemory\" error thrown from the \"stopMaster\", and let the Monitor succeed in shutting\r\ndown this module, than cause it to fail the shutdown process for the derby system.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-03-06T15:19:48.721+0000","updated":"2008-03-06T15:19:48.721+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12575759","id":"12575759","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"The attached patch throw t_stopmaster instead of t in the printStackAndStopMaster\r\nmethod.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-03-06T16:30:42.615+0000","updated":"2008-03-06T16:30:42.615+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12576102","id":"12576102","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"body":"I now understand why you are catching Throwable. I still don't agree that it is a good thing to do because there are many pitfalls, but I guess that's just a matter of opinion. Here is some food-for-thought:\r\n\r\n* The class javadoc of java.lang.Error says:\r\n\"An Error is a subclass of Throwable that indicates serious problems that a reasonable application should not try to catch. Most such errors are abnormal conditions.\"\r\n\r\nI interpret this as being something \"bigger\" than replication that should be reported further up the system. I checked how TransactionResourceImpl#handleException deals with Errors and found, e.g., that it has special treatment for ThreadDeath Errors.\r\n\r\n* Looking more closely at ThreadDeath, the javadoc says:\r\n\"An application should catch instances of this class only if it must clean up after being terminated asynchronously. If ThreadDeath is caught by a method, it is important that it be re-thrown so that the thread actually dies.\"\r\n\r\nI haven't checked the other Errors, but there may be similar pitfalls around. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"created":"2008-03-07T09:43:30.481+0000","updated":"2008-03-07T09:43:30.481+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12576108","id":"12576108","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"On retrospection I think you are right. Thank you for the digging up\r\nmore on the StandardException issue. \r\n\r\nPls find attached a patch that catches a StandardException.\r\n\r\nThe previous patch had been broken by a checkin so I had to\r\nregenerate the patch anyway.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-03-07T10:04:02.556+0000","updated":"2008-03-07T10:04:02.556+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12576240","id":"12576240","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"Thanks, Narayanan for the follow-up.\r\nPatch committed as revision 634694.\r\nI took the liberty to modify the signature of  printStackAndStopMaster to take Exception instead of Throwable.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-03-07T15:36:41.493+0000","updated":"2008-03-07T15:36:41.493+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387364/comment/12586278","id":"12586278","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"All relevant patches have been submitted and committed.\r\nResolving issue!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-04-07T08:51:43.067+0000","updated":"2008-04-07T08:51:43.067+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3358/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06r7r:"}}
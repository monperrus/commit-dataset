{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12313323","self":"https://issues.apache.org/jira/rest/api/latest/issue/12313323","key":"DERBY-501","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2005-08-23 04:03:06.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"21986","customfield_12310222":"3_*:*_1_*:*_1821041000_*|*_1_*:*_1_*:*_24837182000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_47058416042","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-06-16T17:17:46.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-501/watchers","watchCount":0,"isWatching":false},"created":"2005-08-12T04:14:03.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"8.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10991","id":"10991","description":"snapshot","name":"10.0.2.1","archived":false,"released":true,"releaseDate":"2004-12-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12312418","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12312418","type":{"id":"10020","name":"Cloners","inward":"is cloned by","outward":"is a clone of","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10020"},"inwardIssue":{"id":"12333155","key":"DERBY-1288","self":"https://issues.apache.org/jira/rest/api/2/issue/12333155","fields":{"summary":"Bring Derby into JDBC compliance by supporting executeQuery() on escaped procedure invocations","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}},{"id":"12310503","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12310503","type":{"id":"12310010","name":"Incorporates","inward":"is part of","outward":"incorporates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310010"},"inwardIssue":{"id":"32841","key":"DERBY-310","self":"https://issues.apache.org/jira/rest/api/2/issue/32841","fields":{"summary":"Document and/or change Derby client code to match behavior with Embedded driver where possible.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-06-30T16:12:53.403+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11407","id":"11407","name":"JDBC"}],"timeoriginalestimate":null,"description":"It is possible to invoke a stored procedure that returns a single dynamic result using CallableStatement.executeQuery using Derby Client. The embedded JDBC driver, however, throws an exception like:\n\nTest starting ...url = jdbc:derby:tdb\nException in thread \"main\" ERROR X0Y78: Statement.executeQuery() cannot be called with a statement that returns a row count.\n        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:301)\n        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:434)\n        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1142)\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1323)\n        at org.apache.derby.impl.jdbc.EmbedCallableStatement.executeStatement(EmbedCallableStatement.java:109)\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeQuery(EmbedPreparedStatement.java:241)\n        at Test1.main(Test1.java:26)\n\nI think the embedded driver behavior is incorrect here, though I would double check that the JDBC spec says. \n\nTo reproduce the problem,\n\n1) Create a database called 'tdb' and a table called COMPANY as create table COMPANY(name char(10));\n2) Insert two rows as: insert into COMPANY values 'IBM', 'SUN';\n3) register a procedure as:\nCREATE PROCEDURE GETALLCOMPANIES() PARAMETER STYLE JAVA LANGUAGE JAVA READS SQL DATA DYNAMIC RESULT SETS 1 EXTERNAL NAME 'Test.getAllCompanies'\n4) Set server classpath\n5) Compile two attached java programs, Test and Test1\n6) Execute 'java Test1 1' to run as a client program and 'java Test1 2' to run as an embedded program.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"38743","summary":"Client and embedded drivers differ on invoking a procedure that returns a single Dynamic resultSet using CallableStatement.executeQuery()","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10101","value":"Release Note Needed","id":"10101"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"All Platforms","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":19,"total":19,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12318527","id":"12318527","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"body":"Linking this to DERBY-310, though in this case, we probably want to change the embedded driver to match network client.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"created":"2005-08-12T04:20:28.000+0000","updated":"2005-08-12T04:20:28.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12318543","id":"12318543","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"body":"Just checked JDBC 4.0 spec... It confirms CallableStatement.executeQuery() should be supported for Stored Procedures that return a single resultset. See section 13.3.3.1.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"created":"2005-08-12T06:17:07.000+0000","updated":"2005-08-12T06:17:07.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12319634","id":"12319634","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"I don't think executeQuery() is correct,. a definition of a single result set does not preclude the procedure returning one or more update counts, which cannot be handled by  executeQuery. Even though Derby doesn't support upfates counts with procedures it might in the future.\r\n\r\nThe code in 13.3.3.1 (also in JDBC 3) is an example, not part of the spec. We don't see how the called function/procedure GETINFO is defined, maybe in that system it is defined to only return a single result set and no update counts. 13.3.3.1 is only true if it is guaranteed that the statement only returns a single result set, I don't see how in Derby that guarantee can be made.\r\n\r\nSection 13.3.3.3 is the true case (I believe here) quote:\r\n\r\n'If the type or number of results returned by a CallableStatement object are not\r\nknown until run time, the CallableStatement object should be executed with the\r\nmethod execute'\r\n\r\nNote, 'type or number of results', not number of result sets.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2005-08-23T04:03:06.000+0000","updated":"2005-08-23T04:03:06.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12319760","id":"12319760","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"body":"Thanks Dan for your comments. You did raise an important issue about attempting to execute a procedure using executeQuery() when the procedure might also return an update count. I think this case can be handled at run-time... It would be possible to throw an exception if the procedure also returns an update count. (which Derby doesn't currently.)\r\n\r\nSo, I think it should still be possible to use executeQuery() to retrieve results of a single resultset stored procedure. JDBC spec seems to indicate this should be allowed and Derby Client already does allow this. We should, however, catch incorrect invocations when the procedure might return an update count.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"created":"2005-08-24T02:48:48.000+0000","updated":"2005-08-24T02:48:48.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12378783","id":"12378783","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"body":"I am not working on this bug. It would be good to address this, but busy with other activities.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"created":"2006-05-10T06:43:04.000+0000","updated":"2006-05-10T06:43:04.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12413408","id":"12413408","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"It turns out that the issue can be fixed just by not throwing the\r\nexception when exactly one result set is produced by the stored\r\nprocedure. EmbedStatement.executeStatement() will do the right thing\r\nif the exception is not raised.\r\n\r\nThe attached patch fixes it by counting the number of returned result\r\nsets and raising an exception if it is not one. It also adds a new\r\ntest, jdbcapi/ProcedureTest.junit, which tests executeQuery() with\r\nstored procedures in Statement, PreparedStatement and\r\nCallableStatement.\r\n\r\nDerbyall ran successfully. The patch is ready for review. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-05-26T16:13:53.000+0000","updated":"2006-05-26T16:13:53.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12413478","id":"12413478","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"Is the rollback behaviour correct with this patch? \r\nSee the comment in GenericPreparedStatement around line 392 where the current exceptions are thrown for a mismatch of executeQuery/Update with a DML/query statement.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-05-26T21:32:41.000+0000","updated":"2006-05-26T21:32:41.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12413483","id":"12413483","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for looking at the patch, Dan! I'm pretty sure the rollback behaviour is correct (if it was correct before). I didn't touch the executeUpdate part, only executeQuery. If you execute a DDL/insert/update/delete statement with executeQuery(), the exception will be thrown at the same point as before. I'll look more into it on Monday.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-05-26T21:59:48.000+0000","updated":"2006-05-26T21:59:48.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12413493","id":"12413493","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"The patch is not correct. It is obtaining the count of result sets directly from the raw data using:\r\n\r\nresultSet.getActivation().getDynamicResults()\r\n\r\nThe list of returned result sets may include result sets that will not be returned to the application.\r\nThus the count in the new code could be three, whereas the actual return count to the application would be one.\r\n\r\nSee EmbedStatement.processDynamicResults for the various reasons a result set may not be returned to the application.\r\n\r\nThe rollback, I agree matches the previous behaviour, the case I was thinking of was a DML statement executed within a procedure that returned multiple result sets and was executed using executeQuery. In that case an exception is thrown and the results of the DML within the procedure should be rolled back.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-05-26T23:32:02.000+0000","updated":"2006-05-26T23:32:02.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12413576","id":"12413576","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks, great catch! I had missed that.\r\n\r\nThis means that a stored procedure is free to return any ResultSet\r\nobject, but only the ones that are still open and were created by the\r\nconnection which called the stored proc are visible to the user? I\r\nfind this, um, fascinating...\r\n\r\nFor instance, I tried to execute this procedure\r\n\r\n    public static void myProc(ResultSet[] rs1, ResultSet rs2[])\r\n        throws SQLException\r\n    {\r\n        rs1[0] =\r\n            DriverManager.getConnection(\"jdbc:postgresql://localhost/mydb\",\r\n                                        \"test\", \"test\").\r\n            createStatement().executeQuery(\"select * from t\");\r\n        rs2[0] =\r\n            DriverManager.getConnection(\"jdbc:default:connection\").\r\n            createStatement().executeQuery(\"select * from t\");\r\n    }\r\n\r\nand it succeeded, but only returned the result set created by\r\njdbc:default:connection. Is it intentional that we silently ignore the\r\nresult sets from other connections and closed result sets? Isn't it\r\nmore appropriate to raise an exception, or at least a warning?\r\n\r\nAnyway, it seems like the test for the result set count has to be\r\nmoved from GenericPreparedStatement.execute() to\r\nEmbedStatement.executeStatement(). Otherwise, we would have to import\r\nimpl.jdbc classes into impl.sql, which does not sound like a good\r\nidea. According to the comment in GenericPreparedStatement, moving the\r\ntest could affect rollback, but I believe it is unaffected as long as\r\nthe test is performed inside the try block in ES.executeStatement(),\r\nand before the commit logic. I also think moving the test from the sql\r\nexecution code to the jdbc code will make the code cleaner, since we\r\nthen get rid of the executeQuery/executeUpdate flags that currently\r\nhave to be passed to GPS.execute().\r\n\r\nI'll add test cases for the other scenarios you mentioned as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-05-27T18:35:10.000+0000","updated":"2006-05-27T18:35:10.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12413586","id":"12413586","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"Yes, the behaviour on result sets not created by jdbc:default:connection  is intentional.\r\n\r\nSQL part 13 states: Section 8.3, clause 17b\r\n\r\n\"b) If any element of RS is not an object returned by a connection to the current SQL system and SQL\r\nsession, then the effect is implementation-defined.\"\r\n\r\nDerby's implementation defined behaviour is to discard such result sets.\r\n\r\nThen for the closed ones:\r\n\r\nSQL part 13 states: Section 8.3, clause 19\r\n\"If R is an external Java routine, then let FRC be a copy of the elements of RS that\r\nremain open in the order that they were opened in SQL.\"\r\n\r\nI can't see anything in the spec that indicates an exception or warning should be raised if the JDBC ResultSet\r\nis closed when it is returned to the SQL engine.\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-05-27T23:02:56.000+0000","updated":"2006-05-27T23:02:56.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12413820","id":"12413820","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I wrote a test where a stored procedure created a table and did not\r\nreturn any result set. It was executed with executeQuery() and\r\nauto-commit was enabled. The different drivers did this:\r\n\r\n  Embedded: The query failed with an SQLException, and the creation of\r\n  the table was rolled back.\r\n\r\n  Client driver and JCC: The query failed with an SQLException, but\r\n  the creation of the table was not rolled back.\r\n\r\nI believe the embedded driver behaves correctly, and the client driver\r\n(and JCC) should be changed to match embedded.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-05-30T19:40:15.000+0000","updated":"2006-05-30T19:40:15.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12414932","id":"12414932","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attached new patch (derby-501-v2.diff).\r\n\r\nThis patch modifies EmbedStatement.processDynamicResults() so that it\r\nreturns the number of dynamic results instead of a\r\nboolean. EmbedStatement.executeStatement() uses this number to decide\r\nwhether an exception is to be raised. With this change, the\r\nexecuteQuery and executeUpdate parameters are no longer needed in\r\nGenericPreparedStatement.execute().\r\n\r\nMany new test cases have been added to ProcedureTest. The new test\r\ncases test executeUpdate() (which the previous patch didn't touch) and\r\nthe rollback behaviour. Seven of the test cases fail with the client\r\ndriver and JCC, but I expect all of them to succeed with the client\r\ndriver after DERBY-1314 and DERBY-1364 have been fixed.\r\n\r\nDerbyall ran cleanly on Sun JVM 1.5.0 / Solaris 10 x64.\r\n\r\nPlease review the patch. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-06-06T16:23:12.000+0000","updated":"2006-06-06T16:23:12.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12415310","id":"12415310","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Committed the new test class in the v2 patch with revision 412711 (to make it easier to work on DERBY-1314 and DERBY-1364). Didn't commit the code changes since the patch is not reviewed yet.\r\n\r\nI have uploaded a v3 patch which is identical to v2, but without the test class. I'd appreciate if someone could review it. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-06-08T17:05:29.000+0000","updated":"2006-06-08T17:05:29.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12415332","id":"12415332","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Might this change affect existing applications?\r\nCould you describe any behaviour change that might impact users as it might  be documented in the Release Notes.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-06-08T19:11:40.000+0000","updated":"2006-06-08T19:11:40.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12415350","id":"12415350","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I don't think it is very likely that existing applications are\r\naffected, but they *might* be. To be on the safe side, we could add a\r\nline to the release notes saying:\r\n\r\n  The behaviour of executeQuery() and executeUpdate() has been\r\n  modified to follow the JDBC standard when executing stored\r\n  procedures. It is now possible to use executeQuery() to execute a\r\n  stored procedure that returns exactly one ResultSet (this would fail\r\n  in previous releases of Derby). executeUpdate() will raise an\r\n  exception if it is used to execute a stored procedure that returns\r\n  one or more ResultSets (this would succeed in previous releases of\r\n  Derby).\r\n\r\nNote that this only applies to the embedded driver. There will be some\r\nchanges to the client driver in DERBY-1314, but not the same\r\nchanges. When writing the release notes, it is probably best to write\r\none note describing both DERBY-501 and DERBY-1314.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-06-08T20:00:01.000+0000","updated":"2006-06-08T20:00:01.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12416185","id":"12416185","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Does anyone have comments to the approach used in the latest patch? I intend to commit if I don't hear anything in a couple of days. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-06-14T19:05:49.000+0000","updated":"2006-06-14T19:05:49.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12416473","id":"12416473","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Committed revision 414795.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-06-16T17:17:46.000+0000","updated":"2006-06-16T17:17:46.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12313323/comment/12551284","id":"12551284","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"body":"This issue has been resolved for over a year with no further movement. Closing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"created":"2007-12-13T09:04:41.808+0000","updated":"2007-12-13T09:04:41.808+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-501/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06zuv:"}}
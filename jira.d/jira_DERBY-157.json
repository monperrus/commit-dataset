{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"30565","self":"https://issues.apache.org/jira/rest/api/latest/issue/30565","key":"DERBY-157","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2005-03-04 11:15:25.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"21803","customfield_12310222":"1_*:*_1_*:*_1908116000_*|*_6_*:*_2_*:*_32897036000_*|*_5_*:*_1_*:*_74000_*|*_4_*:*_1_*:*_87000","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-04-11T00:40:48.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-157/watchers","watchCount":0,"isWatching":false},"created":"2005-03-04T04:32:15.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-04-11T00:40:48.000+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11410","id":"11410","name":"Network Server"}],"timeoriginalestimate":null,"description":"NOTE: This bug is NOT the same as DERBY-149, although the two bugs reproduce in the same kind of scenario.  DERBY-149 describes a problem that occurs when an invalid date/time string is specified using the Universal Driver (JDBC); this bug describes a problem that occurs when a date/time string is deemed as \"valid\" by an ODBC driver (in this case, the DB2 Runtime Client) but as \"invalid\" by the server.\n\nBACKGROUND:\n\nWhen a client program passes a datetime string value to Derby Network Server, the driver first does a check of the string to see if it's valid.  For JDBC programs using the Universal Driver (JCC), the JCC driver appears to base it's check on the java.sql.Date/Time/Timestamp specifications, which only allow specific forms of the strings.  For example, the JDBC spec for \"java.sql.Date.valueOf\" says that the string value must represent a date in the format \"yyyy-mm-dd\".\n\nDerby Network Server _assumes_ that the java.sql.Date/Time/Timestamp specifications in this regard will hold true for the value in question, and so <b> it does NOT have logic to see if the received string causes an error </b>.  This is fine when using the JCC driver because the formats rejected by Network Server are also the formats rejected by the JCC driver, and so invalid datetime strings shouldn't ever make it to the server (they'll be caught by the driver).\n\nPROBLEM:\n\nOther drivers--and in particular, ODBC drivers--can have different notions about what a valid datetime string is.  In the particular case that prompted this bug, the DB2 Runtime Client allows a date string of the format \"yyyy/mm/dd\", and so if it sees a string with this format, it will pass it on to Network Server.  However, since Network Server only recognizes the form \"yyyy-mm-dd\" (per JDBC spec), it will throw a java.lang.IllegalArgumentException.  \n\nCurrently, Derby Network Server doesn't catch this exception (because it assumes the datetime is either valid or else caught by the driver, as is the case with JCC), and so the exception is interpreted by the server as \"unexpected\".  This causes the server to throw a generic protocol exception and deallocate the connection.\n\nREPRO:\n\nHere is a fragment of a C++ program that shows how to recreate the problem, assuming that 1) table \"u.tt1\" has been created as \"u.tt1(d date)\", 2) \"hstmt\" has been properly initalized as a statement on a connection to a Derby database, and 3) the DB2 Runtime Client is being used.\n\n----\n\nSQLRETURN RetCode = SQL_SUCCESS;\nSQLCHAR SQLStmt[255];\nSQLCHAR dateObj[10];\n\nstrcpy((char *) SQLStmt, \"insert into u.tt1 values (?)\");\nRetCode = SQLPrepare(hstmt, SQLStmt, SQL_NTS);\n\n// Bind the parameter marker used in the SQL statement to\n// an application variable\nRetCode = SQLBindParameter(hstmt, 1, SQL_PARAM_INPUT, SQL_C_CHAR, \n\tSQL_DATE, sizeof(dateObj), \n\t0, dateObj, sizeof(dateObj), NULL);\n\n// Populate the bound variable with a datetime value that will\n// pass the ODBC driver check but that is NOT recognized by the\n// Derby Network Server.\nstrcpy(dateObj, \"1948/04/08\");\n\n// Execute the SQL statement\nRetCode = SQLExecute(hstmt);\nif (RetCode == SQL_SUCCESS) {\n\tprintf(\"OK, all good.\\n\");\n}\nelse {\n\tprintf(\"Error executing insert statement:\\n\");\n\t(error-handling-code)\n}\n\n----\n\nThe result of this fragment will be:\n\n[IBM][CLI Driver] SQL30020N  Execution failed because of a Distributed Protocol Error that will affect the successful execution of subsequent commands and SQL statements:  Reason Code \"0x124C\"(\"011D\")\"\".  SQLSTATE=58009\n\nNOTES:\n\nThe fix for this problem is straightforward; one just needs to add \"try-catch\" logic to catch the IllegalArgumentException in the server and then re-throw it as a valid SQLException.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40761","summary":"Server throws DRDA protocol exception for certain date/time strings passed from an ODBC client.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"I found this problem using Derby Network Server with the DB2 Runtime Client, but I imagine it could occur for other clients, as well...","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":3,"total":3,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/30565/comment/60173","id":"60173","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jboynes","name":"jboynes","emailAddress":"jboynes at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Boynes","active":true},"body":"Attach patch sent to list by Army <qozinx@sbcglobal.net>","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jboynes","name":"jboynes","emailAddress":"jboynes at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Boynes","active":true},"created":"2005-03-04T11:15:25.000+0000","updated":"2005-03-04T11:15:25.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/30565/comment/61568","id":"61568","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Patch committed 03/24/05, revision 158935.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2005-03-26T06:34:11.000+0000","updated":"2005-03-26T06:34:11.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/30565/comment/12373884","id":"12373884","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Reopening issue to set Fixin...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-04-11T00:39:21.000+0000","updated":"2006-04-11T00:39:21.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-157/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i07cbb:"}}
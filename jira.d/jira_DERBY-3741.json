{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12399203","self":"https://issues.apache.org/jira/rest/api/latest/issue/12399203","key":"DERBY-3741","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313143","id":"12313143","description":"Head of 10.3 branch","name":"10.3.3.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313345","id":"12313345","description":"","name":"10.4.2.0","archived":false,"released":true,"releaseDate":"2008-09-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2008-07-21 18:49:29.469","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23819","customfield_12310222":"1_*:*_1_*:*_4039303636_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_7690206644","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-08-13T16:52:39.265+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3741/watchers","watchCount":0,"isWatching":false},"created":"2008-06-27T22:50:55.629+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"9.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313142","id":"12313142","description":"","name":"10.3.3.0","archived":false,"released":true,"releaseDate":"2008-05-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12323201","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12323201","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12413606","key":"DERBY-4040","self":"https://issues.apache.org/jira/rest/api/2/issue/12413606","fields":{"summary":"SQLChar.getLength returns wrong length for some data values","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12320775","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320775","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12398650","key":"DERBY-3732","self":"https://issues.apache.org/jira/rest/api/2/issue/12398650","fields":{"summary":"SQL Length function materializes BLOB  into memory","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-06-30T16:02:42.427+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"Similar to DERBY-3732, the SQL LENGTH function also materializes CLOB's into memory.  See attached repro.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"38791","summary":"SQL LENGTH function materializes CLOB into memory","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10422","value":"High Value Fix","id":"10422"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":18,"total":18,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12608940","id":"12608940","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"to reproduce run \r\njava -Xmx16M LengthLargeClob\r\n\r\nCaused by: java.lang.OutOfMemoryError: Java heap space\r\n        at org.apache.derby.iapi.types.SQLChar.readExternal(SQLChar.java:734)\r\n        at org.apache.derby.iapi.types.SQLChar.getString(SQLChar.java:358)\r\n        at org.apache.derby.iapi.types.SQLChar.getLength(SQLChar.java:315)\r\n        at org.apache.derby.impl.sql.execute.BaseActivation.getDB2Length(BaseActivation.java:1684)\r\n        at org.apache.derby.exe.acf81e0010x011axcc3cx23cbx00000040a4181.e1(Unknown Source)\r\n        at org.apache.derby.impl.services.reflect.DirectCall.invoke(ReflectGeneratedClass.java:141)\r\n        at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.doProjection(ProjectRestrictResultSet.java:497)\r\n        at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.getNextRowCore(ProjectRestrictResultSet.java:291)\r\n        at org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.getNextRow(BasicNoPutResultSetImpl.java:460)\r\n        at org.apache.derby.impl.jdbc.EmbedResultSet.movePosition(EmbedResultSet.java:423)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-06-27T22:53:39.004+0000","updated":"2008-06-27T22:53:39.004+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12610277","id":"12610277","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Reattaching LargeLengthClob.zip, was missing file before.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-07-03T16:56:51.132+0000","updated":"2008-07-03T16:56:51.132+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12615304","id":"12615304","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Suran asked me off-line for some pointers on this issue, but I am posting my response to the issue to keep the discussion on the list and allow room for anyone to correct me if what I say is wrong.\r\n\r\nProbably the first best approach is to write the test. Write a test ClobMemTest which is similar to BlobMemTest and add it to the memory suite.  Make sure you have some multibyte characters so we are sure we are getting the character length and not the byte length when we fix this.  The test should pass normally but fail when run with the target junit-lowmem.\r\n\r\nAs for the code change, I think we are looking to change SQLChar.getLength(). I believe the character length is encoded in the stream in some cases so we want to retrieve that if possible and if not read (skip)  the entire stream to get the character length. Either way we will need to reset the stream in the end to make sure we are positioned back at the beginning of the stream.  The changes should be the same as those made to SQLBinary.getLength() for BLOBS (DERBY-3732)  but not exactly the same because we are dealing with characters.\r\n\r\nHope this helps. Please let us know as you have more questions.\r\n\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-07-21T16:50:54.989+0000","updated":"2008-07-21T16:50:54.989+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12615360","id":"12615360","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"body":"In a subsequent discussion, Kathey pointed out that the following path might be the one to take.\r\nFor not so large CLOBs, if the stream is resettable, get the utf8length with readExternal() and return that IF it's not zero.\r\nIf it's zero, (i.e. stream could be longer than 65535) can use the UTF8Util class' skipUntilEOF() method to get how many chars are in the stream, \r\nbut resetting the stream after that.\r\nIf the stream is not Resetable, will have to go with getString().length.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"created":"2008-07-21T18:49:29.469+0000","updated":"2008-07-21T18:49:29.469+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12615868","id":"12615868","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"body":"Attaching ClobMemTest testcase for review. This is based entirely on BlobMemTest. This is NOT intended as a patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"created":"2008-07-23T02:40:54.000+0000","updated":"2008-07-23T02:40:54.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12616334","id":"12616334","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"body":"Attaching patch derby-3741-1.diff  for initial review only. Test suites not run.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"created":"2008-07-24T03:28:48.677+0000","updated":"2008-07-24T03:28:48.677+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12616503","id":"12616503","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"On the code I just have one comment.  Should we check to see if the stream is instanceof ObjectInput as well as Resettable since we cast it?  I realize SQLBinary has the same problem.\r\n\r\nI ran the test with 16M heap and it fails.  It looks like we are  materializing the lob for  client. (I thought we had fixed that #:(.   Perhaps you could disable this part of the test for client and file a bug that the client is materializing the lob into memory.  I noticed BlobMemTest with 16M is failing with a similar error (It passed  a few weeks ago), so it looks like a regression.  Here is the ClobMemTest failure.   \r\n\r\nThere was 1 error:\r\n1) testClobLength(org.apache.derbyTesting.functionTests.tests.memory.ClobMemTest)java.sql.SQLException: Attempt to fully\r\n materialize lob data that is too large for the JVM.  The connection has been terminated.\r\n        at org.apache.derby.client.am.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:46)\r\n        at org.apache.derby.client.am.SqlException.getSQLException(SqlException.java:362)\r\n        at org.apache.derby.client.am.ResultSet.next(ResultSet.java:281)\r\n        at org.apache.derbyTesting.functionTests.tests.memory.ClobMemTest.testClobLength(ClobMemTest.java:116)\r\n        at org.apache.derbyTesting.functionTests.tests.memory.ClobMemTest.testClobLength(ClobMemTest.java:171)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:64)\r\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n        at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:104)\r\n        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)\r\n        at junit.extensions.TestSetup.run(TestSetup.java:23)\r\n        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\n        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)\r\n        at junit.extensions.TestSetup.run(TestSetup.java:23)\r\n        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)\r\n        at junit.extensions.TestSetup.run(TestSetup.java:23)\r\n        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\n        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)\r\n        at junit.extensions.TestSetup.run(TestSetup.java:23)\r\nCaused by: org.apache.derby.client.am.DisconnectException: Attempt to fully materialize lob data that is too large for t\r\nhe JVM.  The connection has been terminated.\r\n        at org.apache.derby.client.net.NetStatementReply.copyEXTDTA(NetStatementReply.java:1528)\r\n        at org.apache.derby.client.net.NetResultSetReply.parseCNTQRYreply(NetResultSetReply.java:143)\r\n        at org.apache.derby.client.net.NetResultSetReply.readFetch(NetResultSetReply.java:42)\r\n        at org.apache.derby.client.net.ResultSetReply.readFetch(ResultSetReply.java:41)\r\n        at org.apache.derby.client.net.NetResultSet.readFetch_(NetResultSet.java:206)\r\n        at org.apache.derby.client.am.ResultSet.flowFetch(ResultSet.java:4275)\r\n        at org.apache.derby.client.net.NetCursor.getMoreData_(NetCursor.java:1243)\r\n        at org.apache.derby.client.am.Cursor.stepNext(Cursor.java:176)\r\n        at org.apache.derby.client.am.Cursor.next(Cursor.java:195)\r\n        at org.apache.derby.client.am.ResultSet.nextX(ResultSet.java:302)\r\n        at org.apache.derby.client.am.ResultSet.next(ResultSet.java:272)\r\n        ... 38 more\r\nCaused by: java.lang.OutOfMemoryError\r\n        at java.io.ByteArrayOutputStream.write(ByteArrayOutputStream.java:116)\r\n        at org.apache.derby.client.net.Reply.getData(Reply.java:787)\r\n        at org.apache.derby.client.net.NetStatementReply.copyEXTDTA(NetStatementReply.java:1520)\r\n        ... 48 more\r\n\r\nFAILURES!!!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-07-24T15:25:29.270+0000","updated":"2008-07-24T15:25:29.270+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12616669","id":"12616669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Hi Suran,\r\n\r\nAfter the wild goose chase of DERBY-3745 I have some more comments on the patch.\r\n\r\nThere is a problem with the patch setting rawLenth to the length without having the corresponding rawData value set. This led to problems like the one I saw with the getProcedures not returning the correct value.    The getLength() function should not attempt to set rawLength.\r\nSee https://issues.apache.org/jira/browse/DERBY-3795?focusedCommentId=12616661#action_12616661\r\nfor the getProcedures problem I mentioned.\r\n\r\nAlso you have code:\r\n   if (rawLength != -1)\r\n            return rawLength;\r\n        if (stream != null) {\r\n            if (rawLength != -1) {\r\n                return rawLength;\r\n              .....\r\n\r\nThere is no need to check rawLength again after checking that the stream is not null, because you would have already returned it.\r\n\r\nThanks \r\n\r\nKathey\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-07-24T21:41:18.020+0000","updated":"2008-07-24T21:41:18.020+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12617317","id":"12617317","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"body":"Made changes according to Kathey's suggestions. Please review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"created":"2008-07-27T17:25:55.271+0000","updated":"2008-07-27T17:25:55.271+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12617535","id":"12617535","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Suran for the patch.  I committed revision 680478.  Before you close the issue though, could you add a test for small and large clobs with multibyte characters.\r\n\r\nThanks \r\n\r\nKathey\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-07-28T20:22:29.925+0000","updated":"2008-07-28T20:22:29.925+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12619208","id":"12619208","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"body":"derby-3741-multibyte_test.diff adds a test for small and large clobs with multibyte characters. \r\nPlease review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"created":"2008-08-02T12:19:52.439+0000","updated":"2008-08-02T12:19:52.439+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12619561","id":"12619561","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I am attaching a patch that makes a  couple minor modifiications to the test.  It changes the pageCacheSize to 100 so the test can be run with low memory configurations and it also changes the test to check the contents of the stream when it reads it back in.    I'd go ahead and commit this change, but one thing I noticed was that the client test for the large clob seems really slow. 525000ms vs 9578ms  for embedded.  So the test will add about 9 minutes to the suite.   Two  questions:\r\n\r\n1) Is there a client bug logged that would explain the extreme difference?\r\n2) Is it acceptable to check in this test since it adds so much time to suites.All. One option to shorten the run is to only run for embedded.  For this bug we are mostly testing that LENGTH  is returning the right value for multibyte characters and not consuming too much memory, so for that an embedded run would have us covered.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-08-04T15:57:40.163+0000","updated":"2008-08-04T15:57:40.163+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12621527","id":"12621527","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"body":"This patch, derby-2741-mergeto-10.4.diff, adds the changes for derby-3741 to the 10.4 code branch.\r\n\r\nIt incorporates changes from trunk svn revisions \r\n674565 : SQLChar file reformat\r\n680478\r\n682693.\r\n\r\nThe commands used for merging are as follows. (on Windows)\r\n---------------------------------------------------------------------------------------------------------------------------\r\nsvn merge -r 674564:674565 https://svn.apache.org/repos/asf/db/derby/code/trunk/\r\n\r\nsvn merge -r 680477:680478 https://svn.apache.org/repos/asf/db/derby/code/trunk/\r\n\r\nsvn revert java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\memory\\ClobMemTest.java\r\n\r\nsvn add java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\memory\\ClobMemTest.java\r\n\r\nsvn merge -r 682692:682693 https://svn.apache.org/repos/asf/db/derby/code/trunk/\r\n\r\nsvn revert java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\memory\\MultiByteClobTest.java\r\n\r\nsvn add java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\memory\\MultiByteClobTest.java\r\n----------------------------------------------------------------------------------------------------------------------------------\r\n\r\nWhen running tests (suites.All), there was a lot of test failures. \r\ne.g.\r\njdbcapi/AuthenticationTest\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"created":"2008-08-11T17:58:36.109+0000","updated":"2008-08-11T17:58:36.109+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12621529","id":"12621529","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"body":"Pls see previous comment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"created":"2008-08-11T18:00:41.605+0000","updated":"2008-08-11T18:00:41.605+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12621548","id":"12621548","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"jdbcapi/AuthenticationTest runs ok for me with your patch. (Actually I ran the merge commands and fixed up the setAutocommit calls.)  Can you post the stack trace from your failure and the derby.log so we can try to find out what's wrong with your test.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-08-11T18:55:39.209+0000","updated":"2008-08-11T18:55:39.209+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12621551","id":"12621551","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"body":"Attaching derby.log file from the failed tests. This file is from the \r\nderby-10.4\\tests\\fail\\DerbyNetClient\\AuthenticationTest\\testChangePasswordAndDatabasePropertiesOnly\r\n\r\nfolder.\r\nBefore running the test, I had cleaned the tests folder.\r\n\r\nI used the following commands to run the tests.\r\n\r\nset CLASSPATH=..\\classes;..\\tools\\java\\junit.jar;..\\tools\\java\\jakarta-oro-2.0.8.jar\r\njava -XX:MaxPermSize=128M -Xmx1024M -Xms512M -Dderby.tests.trace=true junit.textui.TestRunner org.apache.derbyTesting.functionTests.tests.jdbcapi.AuthenticationTest","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"created":"2008-08-11T19:01:24.559+0000","updated":"2008-08-11T19:01:24.559+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12621564","id":"12621564","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"body":"Resubmitting 10.4 merge patch with references to setAutoCommit() replaced with the old usage of getConnection().setAutoCommit().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"created":"2008-08-11T19:36:48.105+0000","updated":"2008-08-11T19:36:48.105+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12399203/comment/12622275","id":"12622275","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I checked this into 10.4 with revision 685028.  Resolving it for now. I might backport it to 10.3 later but this will get it in the 10.4 release  notes.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-08-13T16:52:39.241+0000","updated":"2008-08-13T16:52:39.241+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3741/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0705j:"}}
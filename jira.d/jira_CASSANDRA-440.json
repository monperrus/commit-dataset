{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12435431","self":"https://issues.apache.org/jira/rest/api/latest/issue/12435431","key":"CASSANDRA-440","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310865","id":"12310865","key":"CASSANDRA","name":"Cassandra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310865&avatarId=12034","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310865&avatarId=12034","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310865&avatarId=12034","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310865&avatarId=12034"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11961","id":"11961","description":"Apache Cassandra related projects","name":"Cassandra"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313862","id":"12313862","description":"","name":"0.4","archived":false,"released":true,"releaseDate":"2009-09-27"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314040","id":"12314040","description":"","name":"0.5","archived":false,"released":true,"releaseDate":"2010-01-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-09-11 15:36:55.084","customfield_12312322":null,"customfield_12312323":null,"customfield_12310222":"1_*:*_1_*:*_306992001_*|*_5_*:*_1_*:*_0","customfield_12310420":"19690","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2009-09-15T02:54:29.605+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-440/watchers","watchCount":0,"isWatching":false},"created":"2009-09-11T13:37:57.604+0000","customfield_10022":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12311124":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-09-15T02:54:29.577+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312978","id":"12312978","name":"Core"}],"timeoriginalestimate":null,"description":"I'm running Cassandra on 5 nodes using the\r\nOrderPreservingPartitioner, and have populated Cassandra with 78\r\nrecords, and I can use get_key_range via Thrift just fine.  Then, if I\r\nmanually kill one of the nodes (if I kill off node #5), the node (node\r\n#1) which I've been using to call get_key_range will timeout and the\r\nerror:\r\n\r\n Thrift: Internal error processing get_key_range\r\n\r\nThe Cassandra output traceback:\r\n\r\nERROR - Encountered IOException on connection:\r\njava.nio.channels.SocketChannel[closed]\r\njava.net.ConnectException: Connection refused\r\n       at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)\r\n       at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:592)\r\n       at org.apache.cassandra.net.TcpConnection.connect(TcpConnection.java:349)\r\n       at org.apache.cassandra.net.SelectorManager.doProcess(SelectorManager.java:131)\r\n       at org.apache.cassandra.net.SelectorManager.run(SelectorManager.java:98)\r\nWARN - Closing down connection java.nio.channels.SocketChannel[closed]\r\nERROR - Internal error processing get_key_range\r\njava.lang.RuntimeException: java.util.concurrent.TimeoutException:\r\nOperation timed out.\r\n       at org.apache.cassandra.service.StorageProxy.getKeyRange(StorageProxy.java:573)\r\n       at org.apache.cassandra.service.CassandraServer.get_key_range(CassandraServer.java:595)\r\n       at org.apache.cassandra.service.Cassandra$Processor$get_key_range.process(Cassandra.java:853)\r\n       at org.apache.cassandra.service.Cassandra$Processor.process(Cassandra.java:606)\r\n       at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:253)\r\n       at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\r\n       at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\r\n       at java.lang.Thread.run(Thread.java:675)\r\nCaused by: java.util.concurrent.TimeoutException: Operation timed out.\r\n       at org.apache.cassandra.net.AsyncResult.get(AsyncResult.java:97)\r\n       at org.apache.cassandra.service.StorageProxy.getKeyRange(StorageProxy.java:569)\r\n       ... 7 more\r\n\r\n\r\nThe error starts as soon as the downed node #5 goes down and lasts\r\nuntil I restart the downed node #5.\r\n\r\nbin/nodeprobe cluster is accurate (it knows quickly when #5 is down,\r\nand when it is up again)\r\n\r\nSince I set the replication set to 3, I'm confused as to why (after\r\nthe first few seconds or so) there is an error just because one host\r\nis down temporarily.\r\n\r\n(Jonathan Ellis and I discussed this on the mailing list, let me know if more information is needed.)","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12419312","id":"12419312","filename":"440.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-11T15:36:55.078+0000","size":63970,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12419312/440.patch"}],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"91259","summary":"get_key_range problems when a node is down","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simongsmith","name":"simongsmith","emailAddress":"simongsmith at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Smith","active":true},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simongsmith","name":"simongsmith","emailAddress":"simongsmith at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Smith","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"customfield_12311420":null,"customfield_12311421":null,"environment":"64-bit 4GB Rackspace-cloud boxes running FC11 (saw problem on 32-bit platform as well)","customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":3,"total":3,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12435431/comment/12754174","id":"12754174","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"refactor findSuitableEndpoint to throw UnavailableException (instead of letting callers error out with NPE) when no replica is alive.  also check for endpoint live-ness in getNextEndpoint.\r\n\r\npatch is against trunk but should also apply to 0.4.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-11T15:36:55.084+0000","updated":"2009-09-11T15:36:55.084+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12435431/comment/12755230","id":"12755230","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simongsmith","name":"simongsmith","emailAddress":"simongsmith at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Smith","active":true},"body":"Jonathan:\r\n\r\nI tried out the patch you attached above, I applied it to 0.4, and it works for me.  Now, as soon as I take a node down, there may be one or two seconds of the thrift-internal error, the timeout (which I totally expect, and this is obviously OK) but as soon as the host doing the querying can see the node is down, the error stops, and valid output is given by the get_key_range query again.  And there isn't any disruption when the node comes back up.\r\n\r\nThanks! \r\n\r\nSimon Smith","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simongsmith","name":"simongsmith","emailAddress":"simongsmith at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Smith","active":true},"created":"2009-09-14T22:37:13.606+0000","updated":"2009-09-14T22:37:13.606+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12435431/comment/12755317","id":"12755317","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"committed to 0.4 and 0.5 branches","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-15T02:54:29.549+0000","updated":"2009-09-15T02:54:29.549+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-440/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0fyxz:"}}
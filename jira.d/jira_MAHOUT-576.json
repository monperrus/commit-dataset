{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12494709","self":"https://issues.apache.org/jira/rest/api/latest/issue/12494709","key":"MAHOUT-576","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310751","id":"12310751","key":"MAHOUT","name":"Mahout","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310751&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310751&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310751&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310751&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13060","id":"13060","description":"Apache Mahout","name":"Mahout"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315255","id":"12315255","description":"","name":"0.5","archived":false,"released":true,"releaseDate":"2011-05-27"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-01-05 15:02:55.373","customfield_12312323":null,"customfield_12310420":"9485","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_884469120_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2011-01-15T16:30:11.008+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAHOUT-576/watchers","watchCount":0,"isWatching":false},"created":"2011-01-05T10:49:01.888+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314396","id":"12314396","description":"","name":"0.4","archived":false,"released":true,"releaseDate":"2010-10-31"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-05-21T03:18:55.121+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312503","id":"12312503","name":"Collaborative Filtering","description":"Taste and any other CF stuff"}],"timeoriginalestimate":null,"description":"the JDBC version of the DiffStorage is not using a RunningAverage in the removePreference case, and ends up making incorrect calculations.\r\nIn a scenario where users are setting and removing a lot of preferences, the AVG stored in the diff table quickly diverges from the correct value because of this.\r\n\r\nRight now, the input to updateItemPref comes from SlopeOneRecommender, and in the case of removePreference, it is *the old preference* value, not a delta. However, the code uses it as if it were a delta. Thus the calculation is off by PEER(removedpreference,userid)/count everytime a user removes a preference.\r\n\r\nAt first glance, the code should compute the old delta instead of the old preference, and use this in the updateItemPref ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"22842","summary":"AbstractJDBCDiffStorage.updateItemPref is updating the AVG incorrectly in most cases","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bruyeron%40fullsix.com","name":"bruyeron@fullsix.com","emailAddress":"bruyeron at fullsix dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Renaud Bruyeron","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bruyeron%40fullsix.com","name":"bruyeron@fullsix.com","emailAddress":"bruyeron at fullsix dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Renaud Bruyeron","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":"2011-01-14","customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":7,"total":7,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12494709/comment/12977749","id":"12977749","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bruyeron%40fullsix.com","name":"bruyeron@fullsix.com","emailAddress":"bruyeron at fullsix dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Renaud Bruyeron","active":true},"body":"\r\nThe problem also exists in the setPreference() case when no previous rating exists for this user_id,item_id pair.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bruyeron%40fullsix.com","name":"bruyeron@fullsix.com","emailAddress":"bruyeron at fullsix dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Renaud Bruyeron","active":true},"created":"2011-01-05T12:05:29.932+0000","updated":"2011-01-05T12:05:29.932+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12494709/comment/12977769","id":"12977769","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bruyeron%40fullsix.com","name":"bruyeron@fullsix.com","emailAddress":"bruyeron at fullsix dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Renaud Bruyeron","active":true},"body":"\r\nI am looking for a way to fix this, and it seems that something is missing in the DiffStorage API:\r\n{code}\r\n  /**\r\n   * <p>\r\n   * Updates internal data structures to reflect an update in a preference value for an item.\r\n   * </p>\r\n   * \r\n   * @param itemID\r\n   *          item to update preference value for\r\n   * @param prefDelta\r\n   *          amount by which preference value changed (or its old value, if being removed\r\n   * @param remove\r\n   *          if <code>true</code>, operation reflects a removal rather than change of preference\r\n   */\r\n  void updateItemPref(long itemID, float prefDelta, boolean remove) throws TasteException;\r\n{code}\r\n\r\nthis works when we have a true update (i.e. neither a removal nor a *new* preference).\r\nHowever in the case of a removal or a new preference, this method is not enough: the implementations actually need to have the delta with the peers and not just the value being removed.\r\ni.e.:\r\nif user X removes preference Pa on item A, we need Pb of all items B that impacted by this removal (because in fine we need Pb-Pa in the calculation, and not just Pa)\r\n\r\nI suspect an API change is needed here: split the method in 2 like this:\r\n{code}\r\n// this must be used only for true update, will throw TE if used on a removal or insertion\r\nvoid updateItemPref(long itemID, float prefDelta) throws TasteException;\r\n\r\n// this must be used for removal or insertion\r\nvoid removeItemPref(long itemID, long userID, float pref, boolean removal) throws TasteException;\r\n{code}\r\n\r\nuserID is needed to efficiently get at the peer preferences and compute deltas, I reckon. What do you think?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bruyeron%40fullsix.com","name":"bruyeron@fullsix.com","emailAddress":"bruyeron at fullsix dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Renaud Bruyeron","active":true},"created":"2011-01-05T13:56:05.912+0000","updated":"2011-01-05T13:56:05.912+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12494709/comment/12977786","id":"12977786","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"body":"Yep I'll get on this. You are right about the issue and the shape of the change.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"created":"2011-01-05T15:02:55.373+0000","updated":"2011-01-05T15:02:55.373+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12494709/comment/12979176","id":"12979176","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"body":"If you'd be willing to try this out I'd be grateful. It's a fairly overhauled approach. I haven't tested it so won't promise there aren't a few typos in there but should be close enough you can perhaps get it working if necessary and upload a modified patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"created":"2011-01-08T19:00:14.447+0000","updated":"2011-01-08T19:00:14.447+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12494709/comment/12980155","id":"12980155","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bruyeron%40fullsix.com","name":"bruyeron@fullsix.com","emailAddress":"bruyeron at fullsix dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Renaud Bruyeron","active":true},"body":"\r\nI just applied the patch to my checkout, will try it in the coming days. From perusing the code, it looks pretty good though.\r\nThanks for the quick turnaround!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bruyeron%40fullsix.com","name":"bruyeron@fullsix.com","emailAddress":"bruyeron at fullsix dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Renaud Bruyeron","active":true},"created":"2011-01-11T16:08:23.010+0000","updated":"2011-01-11T16:08:23.010+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12494709/comment/12982124","id":"12982124","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"body":"While there could be a snag in here, I'm confident enough about this change to commit and resolve for now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"created":"2011-01-15T16:30:10.936+0000","updated":"2011-01-15T16:30:10.936+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12494709/comment/12982146","id":"12982146","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","emailAddress":"jira at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true},"body":"Integrated in Mahout-Quality #557 (See [https://hudson.apache.org/hudson/job/Mahout-Quality/557/])\r\n    MAHOUT-576\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","emailAddress":"jira at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true},"created":"2011-01-15T18:32:38.464+0000","updated":"2011-01-15T18:32:38.464+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAHOUT-576/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i049qf:"}}
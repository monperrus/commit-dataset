{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12434665","self":"https://issues.apache.org/jira/rest/api/latest/issue/12434665","key":"CASSANDRA-414","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310865","id":"12310865","key":"CASSANDRA","name":"Cassandra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310865&avatarId=12034","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310865&avatarId=12034","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310865&avatarId=12034","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310865&avatarId=12034"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11961","id":"11961","description":"Apache Cassandra related projects","name":"Cassandra"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314040","id":"12314040","description":"","name":"0.5","archived":false,"released":true,"releaseDate":"2010-01-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-09-04 17:13:39.619","customfield_12312322":null,"customfield_12312323":null,"customfield_12310222":"1_*:*_1_*:*_686766181_*|*_5_*:*_1_*:*_0","customfield_12310420":"27556","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2009-09-10T18:48:25.305+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-414/watchers","watchCount":0,"isWatching":false},"created":"2009-09-02T20:02:19.124+0000","customfield_10022":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12311124":null,"customfield_12312334":null,"customfield_12310310":"7.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-09-11T12:56:42.420+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312978","id":"12312978","name":"Core"}],"timeoriginalestimate":null,"description":null,"customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12418985","id":"12418985","filename":"ASF.LICENSE.NOT.GRANTED--0001-CASSANDRA-414-combine-addToList-and-storeLocation-ren.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-08T22:59:19.392+0000","size":6585,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12418985/ASF.LICENSE.NOT.GRANTED--0001-CASSANDRA-414-combine-addToList-and-storeLocation-ren.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12418639","id":"12418639","filename":"ASF.LICENSE.NOT.GRANTED--0001-CASSANDRA-414-combine-addToList-and-storeLocation-ren.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-04T15:59:47.039+0000","size":5292,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12418639/ASF.LICENSE.NOT.GRANTED--0001-CASSANDRA-414-combine-addToList-and-storeLocation-ren.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12418426","id":"12418426","filename":"ASF.LICENSE.NOT.GRANTED--0001-CASSANDRA-414-combine-addToList-and-storeLocation-ren.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-02T20:02:41.317+0000","size":5292,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12418426/ASF.LICENSE.NOT.GRANTED--0001-CASSANDRA-414-combine-addToList-and-storeLocation-ren.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12418986","id":"12418986","filename":"ASF.LICENSE.NOT.GRANTED--0002-convert-ssTables_-to-a-Set-since-the-filename-is-enca.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-08T22:59:19.456+0000","size":6665,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12418986/ASF.LICENSE.NOT.GRANTED--0002-convert-ssTables_-to-a-Set-since-the-filename-is-enca.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12418640","id":"12418640","filename":"ASF.LICENSE.NOT.GRANTED--0002-remove-sstableLock.-re-order-a-few-ops-so-that-we-can.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-04T15:59:47.048+0000","size":10032,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12418640/ASF.LICENSE.NOT.GRANTED--0002-remove-sstableLock.-re-order-a-few-ops-so-that-we-can.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12418427","id":"12418427","filename":"ASF.LICENSE.NOT.GRANTED--0002-remove-sstableLock.-re-order-a-few-ops-so-that-we-can.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-02T20:02:41.406+0000","size":9892,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12418427/ASF.LICENSE.NOT.GRANTED--0002-remove-sstableLock.-re-order-a-few-ops-so-that-we-can.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12418987","id":"12418987","filename":"ASF.LICENSE.NOT.GRANTED--0003-Replace-sstableLock-with-SSTableTracker-which-perform.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-08T22:59:19.473+0000","size":36351,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12418987/ASF.LICENSE.NOT.GRANTED--0003-Replace-sstableLock-with-SSTableTracker-which-perform.txt"}],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"91233","summary":"remove sstableLock","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"customfield_12311420":null,"customfield_12311421":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":17,"total":17,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12751507","id":"12751507","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"rebased.\r\n\r\n02\r\n    remove sstableLock.  re-order a few ops so that we can never \"lose\" data temporarily -- always remove old sstable _after_ adding the new ones.  so at worst a few read ops will merge data from an sstable that is obsolete -- this is ok and better than Stop The World locking\r\n\r\n01\r\n    combine addToList and storeLocation; rename to addSSTable\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-04T16:00:36.604+0000","updated":"2009-09-04T16:00:36.604+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12751532","id":"12751532","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"body":"We need to add a comment to CFS.snapshot, indicating that it's a fuzzy one, instead of point-at-time one. Also, the following unit tests failed on me.\r\n\r\n[junit] Testcase: testNameSort10(org.apache.cassandra.db.NameSortTest):     Caused an ERROR\r\n[junit] /home/junrao/local/cassandra_test/build/test/cassandra/data/Keyspace1/Super1-50-Data.db (No such file or directory)\r\n[junit] java.io.FileNotFoundException: /home/junrao/local/cassandra_test/build/test/cassandra/data/Keyspace1/Super1-50-Data.db (No such file or directory)\r\n[junit]     at java.io.RandomAccessFile.open(Native Method)\r\n[junit]     at java.io.RandomAccessFile.<init>(RandomAccessFile.java:212)\r\n[junit]     at java.io.RandomAccessFile.<init>(RandomAccessFile.java:98)\r\n[junit]     at org.apache.cassandra.io.BufferedRandomAccessFile.<init>(BufferedRandomAccessFile.java:142)\r\n[junit]     at org.apache.cassandra.db.filter.SSTableSliceIterator$ColumnGroupReader.<init>(SSTableSliceIterator.java:110)\r\n[junit]     at org.apache.cassandra.db.filter.SSTableSliceIterator.<init>(SSTableSliceIterator.java:56)\r\n[junit]     at org.apache.cassandra.db.filter.SliceQueryFilter.getSSTableColumnIterator(SliceQueryFilter.java:64)\r\n[junit]     at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1347)\r\n[junit]     at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1283)\r\n[junit]     at org.apache.cassandra.db.Table.get(Table.java:564)\r\n[junit]     at org.apache.cassandra.db.NameSortTest.validateNameSort(NameSortTest.java:113)\r\n[junit]     at org.apache.cassandra.db.NameSortTest.testNameSort(NameSortTest.java:94)\r\n[junit]     at org.apache.cassandra.db.NameSortTest.testNameSort10(NameSortTest.java:48)\r\n[junit]\r\n[junit]\r\n[junit] Testcase: testNameSort100(org.apache.cassandra.db.NameSortTest):    Caused an ERROR\r\n[junit] /home/junrao/local/cassandra_test/build/test/cassandra/data/Keyspace1/Super1-582-Data.db (No such file or directory)\r\n[junit] java.io.FileNotFoundException: /home/junrao/local/cassandra_test/build/test/cassandra/data/Keyspace1/Super1-582-Data.db (No such file or directory\r\n[junit]     at java.io.RandomAccessFile.open(Native Method)\r\n[junit]     at java.io.RandomAccessFile.<init>(RandomAccessFile.java:212)\r\n[junit]     at java.io.RandomAccessFile.<init>(RandomAccessFile.java:98)\r\n[junit]     at org.apache.cassandra.io.BufferedRandomAccessFile.<init>(BufferedRandomAccessFile.java:142)\r\n[junit]     at org.apache.cassandra.db.filter.SSTableSliceIterator$ColumnGroupReader.<init>(SSTableSliceIterator.java:110)\r\n[junit]     at org.apache.cassandra.db.filter.SSTableSliceIterator.<init>(SSTableSliceIterator.java:56)\r\n[junit]     at org.apache.cassandra.db.filter.SliceQueryFilter.getSSTableColumnIterator(SliceQueryFilter.java:64)\r\n[junit]     at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1347)\r\n[junit]     at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1283)\r\n[junit]     at org.apache.cassandra.db.Table.get(Table.java:564)\r\n[junit]     at org.apache.cassandra.db.NameSortTest.validateNameSort(NameSortTest.java:113)\r\n[junit]     at org.apache.cassandra.db.NameSortTest.testNameSort(NameSortTest.java:94)\r\n[junit]     at org.apache.cassandra.db.NameSortTest.testNameSort100(NameSortTest.java:55)\r\n[junit]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"created":"2009-09-04T17:13:39.619+0000","updated":"2009-09-04T17:13:39.619+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12751624","id":"12751624","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"when compaction completes it modifies CFS.sstables_ as follows:\r\n\r\n    - sstables_.put(new compacted sstable)\r\n    - remove the source sstables & delete their file on disk\r\n\r\nnow, NonBlockingHashMap guarantees that \"Iterators and Enumerations return elements reflecting the state of the hash table at some point at or since the creation of the iterator/enumeration.\"  BUT this has no effect on other parts of the system, particularly the delete!\r\n\r\nso the fundamental problem exhibeted by the unit tests is this:\r\n\r\n    - thread A starts iterating over sstables_\r\n    - compaction thread finishes and does its thing.  now some of the files A needs to see a consistent view of the data are gone: the set of sstables being iterated over was in fact consistent but because we're violating encapsulation by doing the delete and remove separately, we can get incorrect results.\r\n\r\nI think the simplest solution is to use pseudo-finalizers to do the actual file delete once no references to the owning SSTableReader exist anymore.  These can be done using http://java.sun.com/javase/6/docs/api/java/lang/ref/ReferenceQueue.html and http://java.sun.com/javase/6/docs/api/java/lang/ref/PhantomReference.html.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-04T21:34:20.241+0000","updated":"2009-09-04T21:34:20.241+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12751700","id":"12751700","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"body":"Keeping references to SSTableReader may not be enough. The iterator could iterate file A. Then just before an SSTableReader is opened on A, A is removed from sstables and deleted on disk. Now, you can get the same \"file not found\" exception as above.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"created":"2009-09-05T03:56:55.946+0000","updated":"2009-09-05T03:56:55.946+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12751755","id":"12751755","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"The iterator will either have a reference to A, or not.  If it does, then A will not be deleted until the iterator is done since the delete is no longer done by compaction but by the referencequeue.  If it does not, it will have a reference to the new sstable instead.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-05T13:36:31.283+0000","updated":"2009-09-05T13:36:31.283+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12751781","id":"12751781","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"body":"The question is when a reference is added to the referencequeue. If it's at SSTableReader open time, it may be too late. Between file A is iterated and SSTableReader is opened on A, a compaction can remove A, assuming no one else is reading A at that time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"created":"2009-09-05T19:08:35.474+0000","updated":"2009-09-05T19:08:35.474+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12751784","id":"12751784","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"No, it has nothing to do with whether someone is actually reading (has a BufferedRAF open) on A, only whether any reference to the SSTR object itself exists.  Which is no earlier than when the last iterator that might open a BRAF is done.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-05T19:52:53.984+0000","updated":"2009-09-05T19:52:53.984+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12751785","id":"12751785","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"Remember, SSTR objects are not transitory -- we only have one such object for each file on disk ever.  Even the compaction code uses SSTR.get to use a reference to the open object, and does not open new ones (except for the newly compacted files of course, which is in turn the only time open is called on those).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-05T19:56:12.036+0000","updated":"2009-09-05T19:56:12.036+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12751824","id":"12751824","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"I checked the source for NBHM and couldn't find any evidence that my literal reading of the iterator contract (\"Iterators and Enumerations return elements reflecting the state of the hash table at some point at or since the creation of the iterator/enumeration\") was correct.  So I asked the author for clarification here: https://sourceforge.net/forum/message.php?msg_id=7611241.\r\n\r\nHe replied, and sure enough, Jun's suspicions were correct and even if the compaction thread is careful to add the new SSTR before removing the old ones from sstables_, iterator threads may see the absence of the latter but not the presence of the former.\r\n\r\nSo I think that this approach is not going to work.  But I think we can still cut the lock penalty dramatically from what it is now.  I should have some code for that approach Monday.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-06T04:42:01.498+0000","updated":"2009-09-06T04:42:01.498+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12752473","id":"12752473","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","emailAddress":"jira at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true},"body":"Integrated in Cassandra #191 (See [http://hudson.zones.apache.org/hudson/job/Cassandra/191/])\r\n    Revert \"remove sstableLock.  re-order a few ops so that we can never \"lose\" data temporarily -- always remove old sstable references _after_ adding the new ones.  so at worst a few read ops will merge data from an sstable that is obsolete -- this is ok and better than Stop The World locking\"\r\nand \" combine addToList and storeLocation; rename to addSSTable\"\r\n\r\nThese were works in progress (and broken); accidentally committed w/ the 418 fix.\r\n combine addToList and storeLocation; rename to addSSTable\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","emailAddress":"jira at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true},"created":"2009-09-08T12:35:48.775+0000","updated":"2009-09-08T12:35:48.775+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12752812","id":"12752812","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"03\r\n    Replace sstableLock with SSTableTracker, which performs updates to the sstable list atomically\r\n    without readers ever having to block.  (Readers will always either see the old list, or the new.)\r\n    We avoid a race on the delete of the old SSTable files on-disk by using a ReferenceQueue:\r\n    when the last reference is gone, a PhantomReference is added to the queue and can do cleanup.\r\n    In case Cassandra is killed between compaction and this cleanup, a -Compacted empty file\r\n    is written to disk; Cassandra removes any files thus tagged on startup.\r\n\r\n02\r\n    convert ssTables_ to a Set, since the filename is encapsulated in the SSTR object now\r\n\r\n01\r\n    CASSANDRA-414 combine addToList and storeLocation; rename to addSSTable\r\n\r\nready for review.\r\n\r\nthere is a good summary of how PhantomReference and ReferenceQueue work here: http://www.kdgregory.com/index.php?page=java.refobj","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-08T23:01:07.469+0000","updated":"2009-09-08T23:01:07.469+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12753759","id":"12753759","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"body":"+1","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"created":"2009-09-10T18:37:52.331+0000","updated":"2009-09-10T18:37:52.331+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12753764","id":"12753764","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"committed","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-10T18:48:25.244+0000","updated":"2009-09-10T18:48:25.244+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12753966","id":"12753966","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"body":"Maybe I don''t understand how PhantomReference works, but the code in SSTableReader dealing with finalizerQueue doesn't look right to me. What gets enqueued in finalizerQueue is SSTR. It doesn't seem like that you can cast it directly to FileDeletingReference. It seems to me that you have to maintain a map btw SSTR and FileDeletingReference. Every time you dequeue an item from finalizerQueue, you can lookup the map to find the corresponding FileDeletingReference.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"created":"2009-09-11T03:26:53.784+0000","updated":"2009-09-11T03:26:53.784+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12753970","id":"12753970","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"Yeah, it's a little subtle.  The article I linked is a good explanation, the javadoc alone isn't sufficient or at least wasn't for me.\r\n\r\nA Reference of any type has a get() method that returns the actual referent.  Here that would be the SSTR.  But ReferenceQueue holds the Reference wrapper, not the actual SSTRs.  (When you pass a RQ to the Reference constructor, the Reference will be enqueued on that RQ when its referent is GC'd.  The referent itself already GC'd or in the process of being GC'd so it can't be put on the RQ or you would get back to the Bad Old Days of finalizer resurrection bugs.)\r\n\r\nNow, if the referent is no longer live, get() will return null.  Since the point of the RQ design is to do cleanup after the object is dead, we subclass PhantomReference and store a reference to the path, so we don't actually need the SSTR to do the delete.  (In fact for PR in particular get() _always_ returns null but that is not really essential to understanding what is going on here.)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-11T03:38:48.941+0000","updated":"2009-09-11T03:38:48.941+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12753972","id":"12753972","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"It's easy enough to check the logs with e.g. stress.py: the cleanup does happen.  If it were the SSTR being enqueued then\r\n\r\n                        r = (FileDeletingReference) finalizerQueue.remove();\r\n\r\nwould generate ClassCastException and nothing would get cleaned up (until server restart).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-09-11T03:40:30.571+0000","updated":"2009-09-11T03:40:30.571+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12434665/comment/12754116","id":"12754116","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","emailAddress":"jira at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true},"body":"Integrated in Cassandra #194 (See [http://hudson.zones.apache.org/hudson/job/Cassandra/194/])\r\n    Replace sstableLock with SSTableTracker, which performs updates to the sstable list atomically\r\nwithout readers ever having to block.  (Readers will always either see the old list, or the new.)\r\nWe avoid a race on the delete of the old SSTable files on-disk by using a ReferenceQueue:\r\nwhen the last reference is gone, a PhantomReference is added to the queue and can do cleanup.\r\nIn case Cassandra is killed between compaction and this cleanup, a -Compacted empty file\r\nis written to disk; Cassandra removes any files thus tagged on startup.\r\n\r\npatch by jbellis; reviewed by Chris Goffinet for \r\nconvert ssTables_ to a Set, since the filename is encapsulated in the SSTR object now\r\npatch by jbellis; reviewed by Chris Goffinet for \r\ncombine addToList and storeLocation; rename to addSSTable\r\npatch by jbellis; reviewed by Chris Goffinet for \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","emailAddress":"jira at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true},"created":"2009-09-11T12:56:42.362+0000","updated":"2009-09-11T12:56:42.362+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-414/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0fys7:"}}
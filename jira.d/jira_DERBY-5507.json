{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12531995","self":"https://issues.apache.org/jira/rest/api/latest/issue/12531995","key":"DERBY-5507","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2011-11-21 12:57:49.287","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"217731","customfield_12310222":"3_*:*_1_*:*_243637596_*|*_1_*:*_1_*:*_2399127082_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2011-12-19T11:04:05.841+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5507/watchers","watchCount":0,"isWatching":false},"created":"2011-11-18T20:58:01.203+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":["derby_backport_reject_10_8"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12362400","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12362400","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12384511","key":"DERBY-3272","self":"https://issues.apache.org/jira/rest/api/2/issue/12384511","fields":{"summary":"BUILTIN authentication: Passwords stored in a database are not hashed if also defined as system property","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-07-05T12:43:42.032+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11400","id":"11400","name":"Miscellaneous"}],"timeoriginalestimate":null,"description":"The following script raises an assertion on the last line. We are failing during the encryption of the password. The assertion prints out the plaintext of the password. I ran the script with the following command line:\r\n\r\njava \\\r\n  -Dderby.connection.requireAuthentication=true  \\\r\n  -Dderby.authentication.provider=BUILTIN \\\r\n  -Dderby.user.test_dbo=test_dbopassword \\\r\n  org.apache.derby.tools.ij $SCRIPT\r\n\r\nHere is the script:\r\n\r\nconnect 'jdbc:derby:memory:db;create=true;user=test_dbo;password=test_dbopassword';\r\n\r\ncall syscs_util.syscs_set_database_property( 'derby.connection.requireAuthentication', 'true' );\r\ncall syscs_util.syscs_set_database_property( 'derby.authentication.provider', 'BUILTIN' );\r\n\r\n-- shutdown works correctly if you comment out the following two lines\r\ncall syscs_util.syscs_set_database_property( 'derby.user.test_dbo', 'test_dbopassword' );\r\ncall syscs_util.syscs_set_database_property( 'derby.database.propertiesOnly', 'true' );\r\n\r\n-- fails to authenticate correct credentials\r\nconnect 'jdbc:derby:memory:db;shutdown=true;user=test_dbo;password=test_dbopassword';\r\n\r\nHere is the assertion printed on the screen:\r\n\r\nERROR XJ001: Java exception: 'ASSERT FAILED Unknown authentication scheme for token test_dbopassword: org.apache.derby.shared.common.sanity.AssertFailure'.\r\n\r\nHere is the stack trace in derby.log:\r\n\r\norg.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED Unknown authentication scheme for token test_dbopassword\r\n\tat org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:162)\r\n\tat org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:147)\r\n\tat org.apache.derby.impl.jdbc.authentication.BasicAuthenticationServiceImpl.encryptPasswordUsingStoredAlgorithm(BasicAuthenticationServiceImpl.java:282)\r\n\tat org.apache.derby.impl.jdbc.authentication.BasicAuthenticationServiceImpl.authenticateUser(BasicAuthenticationServiceImpl.java:199)\r\n\tat org.apache.derby.impl.jdbc.authentication.AuthenticationServiceBase.authenticate(AuthenticationServiceBase.java:279)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.checkUserCredentials(EmbedConnection.java:1220)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.<init>(EmbedConnection.java:422)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection30.<init>(EmbedConnection30.java:73)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection40.<init>(EmbedConnection40.java:51)\r\n\tat org.apache.derby.jdbc.Driver40.getNewEmbedConnection(Driver40.java:70)\r\n\tat org.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:255)\r\n\tat org.apache.derby.jdbc.AutoloadedDriver.connect(AutoloadedDriver.java:143)\r\n\tat java.sql.DriverManager.getConnection(DriverManager.java:582)\r\n\tat java.sql.DriverManager.getConnection(DriverManager.java:154)\r\n\tat org.apache.derby.impl.tools.ij.ij.dynamicConnection(ij.java:1528)\r\n\tat org.apache.derby.impl.tools.ij.ij.ConnectStatement(ij.java:1358)\r\n\tat org.apache.derby.impl.tools.ij.ij.ijStatement(ij.java:1143)\r\n\tat org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(utilMain.java:347)\r\n\tat org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:245)\r\n\tat org.apache.derby.impl.tools.ij.Main.go(Main.java:229)\r\n\tat org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:184)\r\n\tat org.apache.derby.impl.tools.ij.Main.main(Main.java:75)\r\n\tat org.apache.derby.tools.ij.main(ij.java:59)\r\n\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10361","value":"Security","id":"10361"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"36146","summary":"Orderly shutdown fails if you are using BUILTIN authentication and turn on derby.database.propertiesOnly","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":9,"total":9,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12531995/comment/13154144","id":"13154144","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The failing ASSERT was added in 10.6.1.0 as part of DERBY-4483, but the repro also fails on earlier versions. On 10.5.1.1:\r\n\r\nij> -- fails to authenticate correct credentials\r\nconnect 'jdbc:derby:memory:db;shutdown=true;user=test_dbo;password=test_dbopassword';\r\nERROR 08004: Connection authentication failure occurred.  Reason: Invalid authentication..\r\n\r\nIt looks as if the password is stored as plaintext in the database if it is also defined in a system property.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-11-21T12:57:49.287+0000","updated":"2011-11-21T12:57:49.287+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12531995/comment/13154155","id":"13154155","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Here's a minimal repro that shows the problem:\r\n\r\n$ java -Dderby.user.abc=def -jar derbyrun.jar ij\r\nij version 10.9\r\nij> connect 'jdbc:derby:memory:db;create=true';\r\nij> call syscs_util.syscs_set_database_property('derby.user.abc', 'test');\r\n0 rows inserted/updated/deleted\r\nij> values syscs_util.syscs_get_database_property('derby.user.abc');\r\n1                                                                                                                               \r\n--------------------------------------------------------------------------------------------------------------------------------\r\ntest                                                                                                                            \r\n\r\n1 row selected\r\n\r\nThe expected result is that the password is stored as a hashed token, which is what happens if the derby.user.<NAME> system property isn't set:\r\n\r\n$ java -jar derbyrun.jar ij\r\nij version 10.9\r\nij> connect 'jdbc:derby:memory:db;create=true';\r\nij> call syscs_util.syscs_set_database_property('derby.user.abc', 'test');\r\n0 rows inserted/updated/deleted\r\nij> values syscs_util.syscs_get_database_property('derby.user.abc');\r\n1                                                                                                                               \r\n--------------------------------------------------------------------------------------------------------------------------------\r\n3b6170e0f1ade11debb6732029c267095e092b5b43ff271d4f8d9158cb004322f38b:SHA-256                                                    \r\n\r\n1 row selected","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-11-21T13:13:33.438+0000","updated":"2011-11-21T13:14:32.825+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12531995/comment/13154174","id":"13154174","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Hashing of the password before storing it is skipped because of this code in PropertyValidation.doValidateApplyAndMap():\r\n\r\n\t\t\t\t\t// if this property should not be used then\r\n\t\t\t\t\t// don't call apply. This depends on where\r\n\t\t\t\t\t// the old value comes from\r\n\t\t\t\t\t// SET_IN_JVM - property will not be used\r\n\t\t\t\t\t// SET_IN_DATABASE - propery will be used\r\n\t\t\t\t\t// SET_IN_APPLICATION - will become SET_IN_DATABASE\r\n\t\t\t\t\t// NOT_SET - will become SET_IN_DATABASE\r\n\r\n\t\t\t\t\tif (!dbOnlyProperty && key.startsWith(\"derby.\")) {\r\n\t\t\t\t\t\tif (PropertyUtil.whereSet(key, d) == PropertyUtil.SET_IN_JVM)\r\n\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\r\nThe repros pass when this code is commented out, but I suppose that the code is there for a reason so this isn't the proper fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-11-21T13:34:42.251+0000","updated":"2011-11-21T13:34:42.251+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12531995/comment/13154265","id":"13154265","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"FWIW, no regression tests failed when the problematic piece of code in PropertyValidation.doValidateApplyAndMap() was commented out.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-11-21T15:55:45.979+0000","updated":"2011-11-21T15:55:45.979+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12531995/comment/13154269","id":"13154269","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Hm, that mysterious piece of code goes back to the first release of Derby so there are no clues available in our code archaeology. Could someone with access to the original Cloudscape repository and bug tracker try to chase this one down? Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-11-21T16:09:29.492+0000","updated":"2011-11-21T16:09:29.492+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12531995/comment/13154554","id":"13154554","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"Unfortunately, the original Cloudscape repository comments do not reference bug trackers for this change.\r\n\r\nI did follow this code snippet (minus the 'derby' clause, of course) through the creation of the PropertyValidation class from code in the PropertyConglomerate class to its first inclusion on Aug 27, 1999, by djd, but the only comment on the check-in is: \"Lock manager properties\" (cloudscape revision 11958, for reference).\r\n\r\nBefore that, ValidateAndApplyMap looked like this:\r\n\r\n\tprivate Serializable validateApplyAndMap(TransactionController tc,\r\n\t\t\t\t\t\t\t\t\t\t\t String key, Serializable value)\r\n\t\t throws StandardException\r\n\t{\r\n\t\tDictionary d = new Hashtable();\r\n\t\tgetProperties(tc,d,false/*!stringsOnly*/,false/*!defaultsOnly*/);\r\n\t\tSerializable mappedValue = null;\r\n \t\tif (notifyOnSet != null) {\r\n\t\t\tsynchronized (this) {\r\n\r\n\t\t\t\tfor (int i = 0; i < notifyOnSet.size() ; i++) {\r\n\t\t\t\t\tPropertySetCallback psc = (PropertySetCallback) notifyOnSet.elementAt(i);\r\n\t\t\t\t\tif (!psc.validate(key, value, d))\r\n\t\t\t\t\t\tcontinue;\r\n\r\n\t\t\t\t\tServiceable s;\r\n\t\t\t\t\tif ((s = psc.apply(key,value,d)) != null)\r\n\t\t\t\t\t\t((TransactionManager) tc).addPostCommitWork(s);\r\n\t\t\t\t\tif (mappedValue == null)\r\n \t\t\t\t\t\tmappedValue = psc.map(key, value, d);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t//\r\n\t\t// RESOLVE: log device cannot be changed on the fly right now\r\n\t\tif (key.equals(Attribute.LOG_DEVICE))\r\n\t\t\tthrow RawStoreStatementException.cannotChangeLogDevice();\r\n\r\n\t\tif (mappedValue == null)\r\n\t\t\treturn value;\r\n\t\telse\r\n\t\t\treturn mappedValue;\r\n\t}\r\n\r\n\r\nAt the time of this change, the method AddPropertySetNotification was also considerably changed, it had code added that also mentioned those SET_IN_* values/comments; \r\n                // set up the initial values by calling the validate and apply methods.\r\n\t\t// the map methods are not called as they will have been called\r\n\t\t// at runtime when the user set the property.\r\n                [...more code added...]\r\n\t\t\t\tif (!who.validate(key, value, d))\r\n\t\t\t\t\tcontinue;\r\n\r\n\t\t\t\t// SET_IN_JVM - need to get value\r\n\t\t\t\t// SET_IN_DATABASE - use the stored value\r\n\t\t\t\t// SET_IN_APPLICATION - need to get value\r\n\t\t\t\t// NOT_SET - can't happen cos it does exist in d\r\n\r\n\t\t\t\tif (!dbOnly) {\r\n\t\t\t\t\tint whereSet = PropertyUtil.whereSet(key, d);\r\n\t\t\t\t\tif (whereSet != PropertyUtil.SET_IN_DATABASE)\r\n\t\t\t\t\t\tvalue = PropertyUtil.getSystemProperty(key);\r\n\t\t\t\t}\r\n                   [...]\r\nbut that code was subsequently removed again (in cloudscape revision 12007, on Aug 30, 1999, by djd) with check-in comment:\r\n\"Fix bug with missing read lock configuration parameters.\"\r\n\r\nAt that time, (in addition to adding of a locks.waitTimeout property), it looks like an init method was added to PropertySetCallback, to SinglePool, some dummy init methods were added to some other classes, and PropertyUtil got a new method with signature:\r\npublic static String getPropertyFromSet(boolean dbOnly, Dictionary set, String key) \r\n\r\nPerhaps the code snippet in the method doValidateAndApplyMap should also have been removed at that time?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2011-11-21T21:29:34.558+0000","updated":"2011-11-21T21:29:34.558+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12531995/comment/13170994","id":"13170994","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for digging through the old code, Myrna. I think I understand now.\r\n\r\nOur documentation says that system properties take precedence over database properties. This code is in place to ensure that setting a database property does not override the value in the system property. Currently, only the lock manager properties and the derby.database.classpath property have implemented a PropertySetCallback.apply() method, so that's probably what the \"Lock manager properties\" commit message referred to. If the call to apply() had not been skipped, setting the lock timeout as a database property would have overridden the lock timeout that was already set as a system property.\r\n\r\nIt's not the call to PropertySetCallback.apply() that causes problems for us, but rather the call to PropertySetCallback.map(). The comment in the code only mentions that apply() shouldn't be called. No mentioning of map():\r\n\r\n\t\t\t\t\t// if this property should not be used then\r\n\t\t\t\t\t// don't call apply.\r\n\r\nI believe calling map(), also in the case where we don't call apply(), would be the right thing to do. Since we're storing the property in the database (although not actually using the value until the database is rebooted without the system property set), we must store the correct value. And to store the correct value, we need to perform the mapping.\r\n\r\nSince AuthenticationServiceBase is the only class that implements a map() method that's not a no-op, making that change should only affect the password properties, so it sounds like a limited and relatively safe change to make.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-12-16T14:37:07.482+0000","updated":"2011-12-16T14:37:07.482+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12531995/comment/13171021","id":"13171021","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Here's a patch that makes PropertyValidation.doValidateApplyAndMap() do the mapping also if the property already exists as a system property. It still does not call apply() in those cases.\r\n\r\nThe patch includes a test case that verifies that the password is not stored in plaintext in the database. The test case fails without the fix. I've also verified that Rick's repro script passes with the fix.\r\n\r\nRunning regression tests.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-12-16T15:23:20.287+0000","updated":"2011-12-16T15:23:20.287+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12531995/comment/13172188","id":"13172188","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"All the regression tests passed.\r\nCommitted revision 1220685.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-12-19T11:04:05.874+0000","updated":"2011-12-19T11:04:05.874+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5507/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06jtr:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12430539","self":"https://issues.apache.org/jira/rest/api/latest/issue/12430539","key":"SOLR-1283","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310230","id":"12310230","key":"SOLR","name":"Solr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310230&avatarId=22151","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310230&avatarId=22151","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310230&avatarId=22151","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310230&avatarId=22151"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314371","id":"12314371","description":"Major release after 1.4.1","name":"3.1","archived":false,"released":true,"releaseDate":"2011-03-31"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314992","id":"12314992","description":"Alpha release of 4.x series","name":"4.0-ALPHA","archived":false,"released":true,"releaseDate":"2012-07-03"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-07-16 20:10:05.629","customfield_12312323":null,"customfield_12310420":"6364","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_48398803786_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2011-01-26T23:58:03.952+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-1283/watchers","watchCount":3,"isWatching":false},"created":"2009-07-15T19:51:20.166+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312486","id":"12312486","description":"","name":"1.3","archived":false,"released":true,"releaseDate":"2008-09-16"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-01-22T04:54:33.390+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[],"timeoriginalestimate":null,"description":"When indexing large (1 megabyte) documents I get a lot of exceptions with stack traces like the below.  It happens both in the Solr 1.3 release and in the July 9 1.4 nightly.  I believe this to NOT be the same issue as SOLR-42.  I found some further discussion on solr-user: http://www.nabble.com/IOException:-Mark-invalid-while-analyzing-HTML-td17052153.html \r\n\r\nIn that discussion, Grant asked the original poster to open a Jira issue, but I didn't see one so I'm opening one; please feel free to merge or close if it's redundant. \r\n\r\nMy stack trace follows.\r\n\r\nJul 15, 2009 8:36:42 AM org.apache.solr.core.SolrCore execute\r\nINFO: [] webapp=/solr path=/update params={} status=500 QTime=3 \r\nJul 15, 2009 8:36:42 AM org.apache.solr.common.SolrException log\r\nSEVERE: java.io.IOException: Mark invalid\r\n        at java.io.BufferedReader.reset(BufferedReader.java:485)\r\n        at org.apache.solr.analysis.HTMLStripReader.restoreState(HTMLStripReader.java:171)\r\n        at org.apache.solr.analysis.HTMLStripReader.read(HTMLStripReader.java:728)\r\n        at org.apache.solr.analysis.HTMLStripReader.read(HTMLStripReader.java:742)\r\n        at java.io.Reader.read(Reader.java:123)\r\n        at org.apache.lucene.analysis.CharTokenizer.next(CharTokenizer.java:108)\r\n        at org.apache.lucene.analysis.StopFilter.next(StopFilter.java:178)\r\n        at org.apache.lucene.analysis.standard.StandardFilter.next(StandardFilter.java:84)\r\n        at org.apache.lucene.analysis.LowerCaseFilter.next(LowerCaseFilter.java:53)\r\n        at org.apache.solr.analysis.WordDelimiterFilter.next(WordDelimiterFilter.java:347)\r\n        at org.apache.lucene.index.DocInverterPerField.processFields(DocInverterPerField.java:159)\r\n        at org.apache.lucene.index.DocFieldConsumersPerField.processFields(DocFieldConsumersPerField.java:36)\r\n        at org.apache.lucene.index.DocFieldProcessorPerThread.processDocument(DocFieldProcessorPerThread.java:234)\r\n        at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:765)\r\n        at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:748)\r\n\tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:2512)\r\n\tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:2484)\r\n\tat org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:240)\r\n\tat org.apache.solr.update.processor.RunUpdateProcessor.processAdd(RunUpdateProcessorFactory.java:61)\r\n\tat org.apache.solr.handler.XMLLoader.processUpdate(XMLLoader.java:140)\r\n\tat org.apache.solr.handler.XMLLoader.load(XMLLoader.java:69)\r\n\tat org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:54)\r\n\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:131)\r\n\tat org.apache.solr.core.SolrCore.execute(SolrCore.java:1292)\r\n\tat org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:338)\r\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:241)\r\n\tat org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1089)\r\n\tat org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:365)\r\n\tat org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:216)\r\n\tat org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:181)\r\n\tat org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:712)\r\n\tat org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:405)\r\n\tat org.mortbay.jetty.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:211)\r\n\tat org.mortbay.jetty.handler.HandlerCollection.handle(HandlerCollection.java:114)\r\n\tat org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:139)\r\n\tat org.mortbay.jetty.Server.handle(Server.java:285)\r\n\tat org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:502)\r\n\tat org.mortbay.jetty.HttpConnection$RequestHandler.content(HttpConnection.java:835)\r\n\tat org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:641)\r\n\tat org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:208)\r\n\tat org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:378)\r\n\tat org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:226)\r\n\tat org.mortbay.thread.BoundedThreadPool$PoolThread.run(BoundedThreadPool.java:442)\r\n\r\nThanks.\r\n\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"19914","summary":"Mark Invalid error on indexing","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=solrize1","name":"solrize1","emailAddress":"no at email dot please","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"solrize","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=solrize1","name":"solrize1","emailAddress":"no at email dot please","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"solrize","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Ubuntu 8.04, Sun Java 6","customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":14,"total":14,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430539/comment/12732126","id":"12732126","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"We should make the buffer size configurable, I guess.  However, there's always the potential to go past it or use up a lot of memory in the meantime (if one is expecting really large files)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2009-07-16T20:10:05.629+0000","updated":"2009-07-16T20:10:05.629+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430539/comment/12732206","id":"12732206","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=solrize","name":"solrize","emailAddress":"no at email dot please","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"solrize","active":true},"body":"Right now I'm getting a ton of these errors.  It doesn't seem strictly dependent on the doc size.  If I can crank up the buffer size enough that the error happens only occasionally instead of frequently, that would be a big improvement over the present situation.  Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=solrize","name":"solrize","emailAddress":"no at email dot please","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"solrize","active":true},"created":"2009-07-16T22:20:29.003+0000","updated":"2009-07-16T22:20:29.003+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430539/comment/12734207","id":"12734207","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=solrize","name":"solrize","emailAddress":"no at email dot please","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"solrize","active":true},"body":"Is the buffer size the parameter DEFAULT_READ_AHEAD (set to 8192) in HTMLStripReader.java?\r\n\r\nShould I set it to be the same as maxFieldLength from solrconfig.xml?  That would let it hold the entire document.  I currently have that config parameter set to 10000000 (10 MB).\r\n\r\nThanks\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=solrize","name":"solrize","emailAddress":"no at email dot please","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"solrize","active":true},"created":"2009-07-22T17:33:47.783+0000","updated":"2009-07-22T17:33:47.783+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430539/comment/12734815","id":"12734815","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=solrize","name":"solrize","emailAddress":"no at email dot please","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"solrize","active":true},"body":"I now have a workaround.  The documents I'm indexing don't actually have html in them, but the schema was set up to use HTMLStripReader anyway.  I switched to the standard analyzer and the problem went away, and indexing also seems to be running faster than before.  I do still think the issue needs fixing since I'm sure some people use solr to index large web pages which do need html stripping.  Anyway, thanks to Erik H. for advice about this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=solrize","name":"solrize","emailAddress":"no at email dot please","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"solrize","active":true},"created":"2009-07-23T22:14:54.810+0000","updated":"2009-07-23T22:14:54.810+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430539/comment/12770586","id":"12770586","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dbowen","name":"dbowen","emailAddress":"davidlbowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Bowen","active":true},"body":"It seems to me that the code should bail out and just assume that a \"<\" did not begin an HTML tag if it still isn't sure after reading the DEFAULT_READ_AHEAD (8,192) characters.  It looks like the code was intended to do that (see the checks against safeReadAheadLimit) but must be missing some case.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dbowen","name":"dbowen","emailAddress":"davidlbowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Bowen","active":true},"created":"2009-10-27T17:29:52.220+0000","updated":"2009-10-27T17:29:52.220+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430539/comment/12805083","id":"12805083","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cyrius","name":"cyrius","emailAddress":"julien dot coloos+jira at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Julien Coloos","active":true},"body":"The issue is also happening in current trunk (revision 903234), with the class {{HTMLStripCharFilter}} (replacing deprecated {{HTMLStripReader}} it seems).\r\n\r\nExample of stacktrace:\r\n{noformat}\r\n26 janv. 2010 16:02:56 org.apache.solr.common.SolrException log\r\nGRAVE: java.io.IOException: Mark invalid\r\n        at java.io.BufferedReader.reset(BufferedReader.java:485)\r\n        at org.apache.lucene.analysis.CharReader.reset(CharReader.java:63)\r\n        at org.apache.solr.analysis.HTMLStripCharFilter.restoreState(HTMLStripCharFilter.java:172)\r\n        at org.apache.solr.analysis.HTMLStripCharFilter.read(HTMLStripCharFilter.java:734)\r\n        at org.apache.solr.analysis.HTMLStripCharFilter.read(HTMLStripCharFilter.java:748)\r\n        at java.io.Reader.read(Reader.java:122)\r\n        at org.apache.lucene.analysis.CharTokenizer.incrementToken(CharTokenizer.java:77)\r\n        at org.apache.lucene.analysis.ISOLatin1AccentFilter.incrementToken(ISOLatin1AccentFilter.java:43)\r\n        at org.apache.lucene.analysis.TokenStream.next(TokenStream.java:383)\r\n        at org.apache.lucene.analysis.ISOLatin1AccentFilter.next(ISOLatin1AccentFilter.java:64)\r\n        at org.apache.solr.analysis.WordDelimiterFilter.next(WordDelimiterFilter.java:379)\r\n        at org.apache.lucene.analysis.TokenStream.incrementToken(TokenStream.java:318)\r\n        at org.apache.lucene.analysis.StopFilter.incrementToken(StopFilter.java:225)\r\n        at org.apache.lucene.analysis.LowerCaseFilter.incrementToken(LowerCaseFilter.java:38)\r\n        at org.apache.solr.analysis.SnowballPorterFilter.incrementToken(SnowballPorterFilterFactory.java:116)\r\n        at org.apache.lucene.analysis.TokenStream.next(TokenStream.java:406)\r\n        at org.apache.solr.analysis.BufferedTokenStream.read(BufferedTokenStream.java:97)\r\n        at org.apache.solr.analysis.BufferedTokenStream.next(BufferedTokenStream.java:83)\r\n        at org.apache.lucene.analysis.TokenStream.incrementToken(TokenStream.java:321)\r\n        at org.apache.lucene.index.DocInverterPerField.processFields(DocInverterPerField.java:138)\r\n        at org.apache.lucene.index.DocFieldProcessorPerThread.processDocument(DocFieldProcessorPerThread.java:244)\r\n        at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:781)\r\n        at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:764)\r\n        at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:2630)\r\n        at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:2602)\r\n        at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:241)\r\n        at org.apache.solr.update.processor.RunUpdateProcessor.processAdd(RunUpdateProcessorFactory.java:61)\r\n        at org.apache.solr.handler.XMLLoader.processUpdate(XMLLoader.java:139)\r\n        at org.apache.solr.handler.XMLLoader.load(XMLLoader.java:69)\r\n        at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:54)\r\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:131)\r\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1317)\r\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:341)\r\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:244)\r\n        at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1089)\r\n        at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:365)\r\n        at org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:216)\r\n        at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:181)\r\n        at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:712)\r\n        at org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:405)\r\n        at org.mortbay.jetty.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:211)\r\n        at org.mortbay.jetty.handler.HandlerCollection.handle(HandlerCollection.java:114)\r\n        at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:139)\r\n        at org.mortbay.jetty.Server.handle(Server.java:285)\r\n        at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:502)\r\n        at org.mortbay.jetty.HttpConnection$RequestHandler.content(HttpConnection.java:835)\r\n        at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:723)\r\n        at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:208)\r\n        at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:378)\r\n        at org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:226)\r\n        at org.mortbay.thread.BoundedThreadPool$PoolThread.run(BoundedThreadPool.java:442)\r\n{noformat}\r\n\r\nAfter a quick code review, it seems this one is due to the {{peek}} function which can read a byte from the input stream, while not incrementing the {{numRead}} variable (as done in the {{next}} function): functions checking whether _read ahead_ limit was reached rely on {{numRead}}.\r\nThe exception can then be triggered when reading exceeds the _read ahead_ limit, as for example with a big document containing a malformed processing instruction like\r\n{noformat}\r\n<?>   ?????\r\n... (anything except  '?>')\r\n{noformat}\r\nNote: the issue is triggered here because {{readProcessingInstruction}} calls {{peek}} whenever the character '{{?}}' was found (to check whether it is followed by '{{>}}').\r\n\r\n\r\nYou will find attached a patch to fix the issue, as well as an updated JUnit test (which actually only checks for the malformed processing instruction, maybe you will find a more general test to perform on the {{next}}/{{peek}} functions).\r\n\r\n\r\nRegards","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cyrius","name":"cyrius","emailAddress":"julien dot coloos+jira at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Julien Coloos","active":true},"created":"2010-01-26T16:37:27.762+0000","updated":"2010-01-26T16:37:27.762+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430539/comment/12884860","id":"12884860","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"body":"Updates patch to trunk (where the charfilter stuff has been refactored into the new top level \"modules\" directory)\r\n\r\nI'm not familiar with the HTMLStripCharFilter stuff, so i can't say whether the \"fix\" is correct (no idea if \"peek\" should be incrementing that counter -- that's why even private methods should have javadocs), but the test certainly looks valid to me","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"created":"2010-07-02T23:41:25.477+0000","updated":"2010-07-02T23:41:25.477+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430539/comment/12884862","id":"12884862","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"body":"we have a patch that *seems* to work, so we should dfinitely try to get this into the next release ... i'm hoping someone more familiar with the code can sanity check it soon.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"created":"2010-07-02T23:45:47.052+0000","updated":"2010-07-02T23:45:47.052+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430539/comment/12884886","id":"12884886","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"From IRC:\r\n{quote}\r\nI wonder if the issue isn't that in next()\r\n[21:35] gsingers: if it gets something off the stack (pushed) it doesn't increment numRead\r\n[21:37] gsingers: but, I guess one could argue that numRead should track exactly what is read off the InputStream\r\n[21:38] gsingers: and in that case, peek is still doing a read\r\n[21:38] gsingers: so it should inc. it\r\n[21:38] gsingers: I suppose the only harm in more aggressively incrementing it is that you don't hold as much in buffer as you could otherwise\r\n{quote}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2010-07-03T01:40:44.644+0000","updated":"2010-07-03T01:40:44.644+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430539/comment/12885658","id":"12885658","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"body":"As i mentioned in IRC (prior to Grant's previously posted comments) the core issue is: what is the intended purpose of the \"numRead\" counter?\r\n\r\n* If it's suppose to count the number of times \"input.read()\" is called (ie: \"num read from inner stream\"), then \"peek\" has a bug by not incrementing.\r\n* If it's  suppose to count the number of times \"next()\" returns a char (ie: \"num read from outer stream\"), then as grant mentioned \"next\" has a bug by not incrementing when using the stack.\r\n\r\nThe patch currently assumes the former and seems to fix the bug, i haven't tried the same test case with an approach to the later, but i suspect that may also work. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"created":"2010-07-06T19:53:32.902+0000","updated":"2010-07-06T19:53:32.902+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430539/comment/12987253","id":"12987253","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"body":"Since it looks like the primary use of numRead is in relation to mark() and reset() on the underlying stream, it does look like #1 is the correct interpretation (i.e. the patch looks correct)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"created":"2011-01-26T22:05:50.605+0000","updated":"2011-01-26T22:05:50.605+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430539/comment/12987307","id":"12987307","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"body":"Committed to 3x and trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"created":"2011-01-26T23:58:03.895+0000","updated":"2011-01-26T23:58:03.895+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430539/comment/13013102","id":"13013102","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"body":"Bulk close for 3.1.0 release","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsingers","name":"gsingers","emailAddress":"gsingers at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Grant Ingersoll","active":true},"created":"2011-03-30T15:45:32.790+0000","updated":"2011-03-30T15:45:32.790+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12430539/comment/13190605","id":"13190605","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"body":"The below-listed exception, which appears to be the same as that in other reports on this issue, is triggered when processing with {{HTMLStripCharFilter}} the ClueWeb09 documents with TREC-IDs clueweb09-en0000-00-14171, clueweb09-en0000-00-14228, clueweb09-en0000-00-14235, clueweb09-en0000-00-14240, clueweb09-en0000-00-14248, and clueweb09-en0000-00-14265:\r\n\r\n{noformat}\r\njava.io.IOException: Mark invalid\r\n        at java.io.BufferedReader.reset(BufferedReader.java:485)\r\n        at org.apache.lucene.analysis.CharReader.reset(CharReader.java:69)\r\n        at org.apache.lucene.analysis.charfilter.HTMLStripCharFilter.restoreState(HTMLStripCharFilter.java:171)\r\n        at org.apache.lucene.analysis.charfilter.HTMLStripCharFilter.read(HTMLStripCharFilter.java:734)\r\n{noformat}\r\n\r\nOnce LUCENE-3690 has been committed, this will only affect the (deprecated) old implementation, which will be renamed to {{LegacyHTMLStripCharFilter}}.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"created":"2012-01-22T04:54:33.219+0000","updated":"2012-01-22T04:54:33.219+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-1283/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i03rnr:"}}
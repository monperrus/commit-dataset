{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"28865","self":"https://issues.apache.org/jira/rest/api/latest/issue/28865","key":"DERBY-94","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2004-12-09 23:04:24.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"21768","customfield_12310222":"1_*:*_1_*:*_3735447000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_96746000","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2005-01-20T04:39:27.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-94/watchers","watchCount":1,"isWatching":false},"created":"2004-12-07T23:02:00.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10991","id":"10991","description":"snapshot","name":"10.0.2.1","archived":false,"released":true,"releaseDate":"2004-12-06"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsuresh","name":"tsuresh","emailAddress":"suresh dot thalamati at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suresh Thalamati","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-05-16T04:11:24.000+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11412","id":"11412","name":"Store"}],"timeoriginalestimate":null,"description":"In the following scenario: \n<code snippet>\n           String sel = \"select * from t1 FOR UPDATE of i2\";\n  \t   PreparedStatement ps1 = conn.prepareStatement (sel);\n   \t   int val = 300;\n\t   ps1.setMaxRows(val);\n\t   ResultSet rs = ps1.executeQuery();\n\n   \t   String ins = \"Update t1 set i2=? WHERE CURRENT OF \"+rs.getCursorName() ;\n   \t   PreparedStatement ps2 = conn.prepareStatement(ins);\n           ps2.setInt(1,iteration);\n\n           while(rs.next())\n           {\n     \t      ps2.executeUpdate();\n   \t   };\n\n   \t   // print lock table information\n   \t   System.out.println(\"Lock Table before commit transaction\");\n   \t   printLockTable(conn);\n   \t   conn.commit();\n<end code snippet>\nRunning the above transaction twice causes a lock timeout the second time.\n\nIt seems like locks are not being released properly on the table even after the transaction commits and the connection is closed. Also, this condition seems to  happen only when lock escalation to table lock occurs. By increasing lock  escalation threshold to prevent lock escalation and with only row level locking, the locks are released properly.\n\nI printed out the locks information and see a U row level lock on the table , and also a table level lock as a result of lock escalation. After commit, and resultset being closed, the U row level lock is not released. Thus in the second iteration of the test, the unreleased U row level lock causes a lock timeout to happen.  In case of the second iteration of the test, the lock table shows the previous U row lock with a null transaction id. This is not right. \n\nThe transactions are running at the default isolation level ( read committed).\n\nBy default, the lock escalation threshold is set to 5000\nhttp://incubator.apache.org/derby/manuals/tuning/perf80.html#IDX547\n\nI will be attaching the program for reproduction.  To reproduce the problem with less number of rows in the table, please run the program with the following derby properties set \nderby.locks.deadlockTrace=true\nderby.locks.escalationThreshold=110\n ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40693","summary":"Lock not being released properly, possibly related to occurence of lock escalation","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"all","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":4,"total":4,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/28865/comment/56351","id":"56351","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"Program to reproduce the problem described in Derby 94. \r\nTo run the program\r\njava -Dderby.locks.escalationThreshold=110 -Dderby.locks.deadlockTrace=true Derby94Test \r\n\r\nDerby94Test_Output is a sample output of the lock table information that is written out to standard out.  Note in the second iteration a lock timeout error is thrown. \r\n\r\nDerby.log has the lock timeout exception","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2004-12-07T23:14:37.000+0000","updated":"2004-12-07T23:14:37.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/28865/comment/56477","id":"56477","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"Here is how I have debugged these kinds of issues in the past:\r\n\r\n1) get a lot of disk space\r\n2) run the repro in a SANE build\r\n3) enable the debug option which prints a stack trace with each lock request to the derby.log (see code in opensource/java/engine/org/apache/derby/impl/services/locks/SinglePool.java, \r\nConstants.java).  This will produce a very large derby.log file, depending\r\non how many locks are requested in test case.\r\n4) Find the lock that is left over after the transaction commits and then search backward\r\n     in the log to find the code which requested the lock.\r\n\r\npast bugs like this have happened if a lock is not put on the transaction list, and then for\r\nsome reason does not get explicitly removed.  In this case the escalation is probably the\r\ncause.  \r\n\r\nIn normal case locks get put on transaction list and then all locks on transaction list are removed at end of transaction.  I can't remember the\r\nlast time I saw problems in this area.\r\n\r\nLocks which need to be released before end transaction, ie. read committed,\r\n are put on temporary lists which are keyed by the open conglomerate,\r\nand then we either explicitly unlock them or we unlock all the ones on the list when the coglomerate\r\nis closed at the end.  probably something going wrong in this area. \r\n\r\n/mikem","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2004-12-09T23:04:24.000+0000","updated":"2004-12-09T23:04:24.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/28865/comment/57790","id":"57790","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsuresh","name":"tsuresh","emailAddress":"suresh dot thalamati at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suresh Thalamati","active":true},"body":"This issue has been fixed with SVN COMMIT r123267.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsuresh","name":"tsuresh","emailAddress":"suresh dot thalamati at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suresh Thalamati","active":true},"created":"2005-01-20T04:39:27.000+0000","updated":"2005-01-20T04:39:27.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/28865/comment/57860","id":"57860","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"I have tested it and it works ok, so closing the bug. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2005-01-21T07:31:53.000+0000","updated":"2005-01-21T07:31:53.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-94/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i07bw7:"}}
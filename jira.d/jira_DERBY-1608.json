{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12346863","self":"https://issues.apache.org/jira/rest/api/latest/issue/12346863","key":"DERBY-1608","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-07-30 00:18:19.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22596","customfield_12310222":"1_*:*_1_*:*_298280000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_34023000","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-08-01T06:15:17.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1608/watchers","watchCount":0,"isWatching":false},"created":"2006-07-28T19:23:57.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-08-01T15:42:20.000+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"1. Create a database in 10.1\n2. Full upgrade to 10.2 - Booting using 10.2 jars by specifying \"upgrade=true\" in the connection URL.\n3. Execute a function e.g: VALUES { fn ACOS(0.0707) }. This passes as expected.\n4. Set database property derby.database.sqlAuthorization=true.\n5. Shutdown and reconnect to database for the property to take effect.\n6. Re-execute the function. This gives NPE.\n\nRepro using ij:\n\n--------------------------------------------------------------------------------\nSteps using 10.1 jar:\n--------------------------------------------------------------------------------\nij version 10.1\nij> connect 'jdbc:derby:old_db;create=true';\nij> exit;\n\n--------------------------------------------------------------------------------\nSteps using 10.2 jar:\n--------------------------------------------------------------------------------\nij version 10.2\nij> connect 'jdbc:derby:old_db;upgrade=true';\nij> VALUES { fn ACOS(0.0707) };\n1\n----------------------\n1.5000372950430991\n\n1 row selected\nij> call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('derby.database.sqlAuthorization', 'true');\n0 rows inserted/updated/deleted\nij> connect 'jdbc:derby:old_db;shutdown=true';\nERROR 08006: Database 'old_db' shutdown.\nij> connect 'jdbc:derby:old_db';\nij(CONNECTION1)> VALUES { fn ACOS(0.0707) };\nERROR XJ001: Java exception: ': java.lang.NullPointerException'.\nij(CONNECTION1)>\n\n--------------------------------------------------------------------------------\nStack trace of failure:\n--------------------------------------------------------------------------------\nERROR XJ001: Java exception: ': java.lang.NullPointerException'.\njava.lang.NullPointerException\n        at org.apache.derby.iapi.sql.dictionary.RoutinePermsDescriptor.<init>(RoutinePermsDescriptor\n.java:54)\n        at org.apache.derby.iapi.sql.dictionary.RoutinePermsDescriptor.<init>(RoutinePermsDescriptor\n.java:62)\n        at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getRoutinePermissions(DataDictionary\nImpl.java:9902)\n        at org.apache.derby.iapi.sql.dictionary.StatementRoutinePermission.check(StatementRoutinePer\nmission.java:55)\n        at org.apache.derby.impl.sql.conn.GenericAuthorizer.authorize(GenericAuthorizer.java:157)\n        at org.apache.derby.exe.ac6b91c056x010cxb687x3eb7x00000012d1c00.fillResultSet(Unknown Source\n)\n        at org.apache.derby.exe.ac6b91c056x010cxb687x3eb7x00000012d1c00.execute(Unknown Source)\n        at org.apache.derby.impl.sql.GenericActivationHolder.execute(GenericActivationHolder.java:32\n6)\n        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:\n355)\n        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1181)\n        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:584)\n        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:516)\n        at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:313)\n        at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:433)\n        at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:312)\n        at org.apache.derby.impl.tools.ij.Main.go(Main.java:207)\n        at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:173)\n        at org.apache.derby.impl.tools.ij.Main14.main(Main14.java:55)\n        at org.apache.derby.tools.ij.main(ij.java:60)","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40461","summary":"Execution of builtin functions by a user who is not the owner of system schemas gives NPE when authentication and SQL authorization are on.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10051","value":"Urgent","id":"10051"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":6,"total":6,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346863/comment/12424204","id":"12424204","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"This problem is not related to upgrade. This was noticed in the upgraded database because of a known issue in upgrade (the owner of system schemas is not changed from \"DBA\" to the user invoking upgrade)\r\n\r\nEarlier, I could not repro it with a new database in 10.2 as I was trying only as default user. Looking at the code, it seemed that this could also happen in a new 10.2 database. I could repro this when I turned authentication on and tried executing a builtin function as a user who is not the owner of system schemas. To repro in 10.2: \r\n\r\n1)  Start ij with following in derby.properties file: \r\n\r\nderby.connection.requireAuthentication=true\r\nderby.database.sqlAuthorization=true\r\n\r\nderby.user.creator=pswd\r\nderby.user.deepa=pswd\r\n\r\n2) In ij, run the following commands:\r\nij> connect 'jdbc:derby:newdb;create=true;user=creator;password=pswd';\r\nij> VALUES { fn ACOS(0.0707) };\r\n1\r\n----------------------\r\n1.5000372950430991\r\n\r\n1 row selected\r\nij> connect 'jdbc:derby:newdb;user=deepa;password=pswd';\r\nij(CONNECTION1)> VALUES { fn ACOS(0.0707) };\r\nERROR XJ001: Java exception: ': java.lang.NullPointerException'.\r\nij(CONNECTION1)> exit;\r\n\r\nIn general, NPE is thrown whenever we try to execute a builtin function as a user who is not the owner of the system schemas.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-07-28T23:06:04.000+0000","updated":"2006-07-28T23:06:04.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346863/comment/12424333","id":"12424333","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"body":"I can fix this problem. Some of the newly added SYSFUN builtin functions don't exist in system catalogs but pretend to be routines during resolution process. Since these routines are builtin functions that don't need privilege checking, need to bypass creating StatementPermission objects for them. Currently SQL authorization mechanism is looking for routine descriptors to create StatementPermission and hence fails, as they don't really have aliasIDs.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"created":"2006-07-30T00:18:19.000+0000","updated":"2006-07-30T00:18:19.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346863/comment/12424334","id":"12424334","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"body":"Deepa, I did not realize you had this defect assigned to you, until after I assigned it myself. If you want to fix it yourself, feel free to assign it back to yourself. Otherwise, I can take care of it. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"created":"2006-07-30T00:20:52.000+0000","updated":"2006-07-30T00:20:52.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346863/comment/12424757","id":"12424757","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"body":"Submitted a fix to trunk and also added test cases.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"created":"2006-08-01T06:15:16.000+0000","updated":"2006-08-01T06:15:16.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346863/comment/12424758","id":"12424758","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"body":"Deepa, I submitted a fix to trunk just now. If you can rerun your test and confirm the test passes now, can you either let me know or close this bug yourself? I think the submitter is supposed to close the bug after confirming, if possible, according to JIRA docs.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"created":"2006-08-01T06:18:00.000+0000","updated":"2006-08-01T06:18:00.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346863/comment/12424904","id":"12424904","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Verified fix by running the repros and the modified upgrade test. Thanks Satheesh.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-08-01T15:42:20.000+0000","updated":"2006-08-01T15:42:20.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1608/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i07agn:"}}
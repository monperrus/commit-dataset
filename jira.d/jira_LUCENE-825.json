{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12364313","self":"https://issues.apache.org/jira/rest/api/latest/issue/12364313","key":"LUCENE-825","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310110","id":"12310110","key":"LUCENE","name":"Lucene - Core","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310110&avatarId=10061","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310110&avatarId=10061","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310110&avatarId=10061","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310110&avatarId=10061"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312328","id":"12312328","description":"","name":"2.2","archived":false,"released":true,"releaseDate":"2007-06-19"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2007-03-07 08:22:16.895","customfield_12312323":null,"customfield_12310420":"12915","customfield_12312320":null,"customfield_12310222":"3_*:*_1_*:*_1460736_*|*_1_*:*_1_*:*_25824504_*|*_6_*:*_1_*:*_0_*|*_5_*:*_2_*:*_8870032000_*|*_4_*:*_1_*:*_113656029","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2007-03-08T18:06:30.126+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-825/watchers","watchCount":0,"isWatching":false},"created":"2007-03-07T01:12:02.033+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12310854","id":"12310854","description":"","name":"2.1","archived":false,"released":true,"releaseDate":"2007-02-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-06-19T08:14:55.267+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[],"timeoriginalestimate":null,"description":"Found this bug while running unit tests to verify an upgrade of our system from 1.4.3 to 2.1.0.  This bug did *not* occur during 1.4.3, it is new to 2.x (I'm pretty sure it's 2.1-only)\n\nIf the index directory gets deleted out from under Lucene after the FSDirectory has been created, then attempts to open an IndexWriter or IndexReader will result in an NPE.  Lucene should be throwing an IOException in this case.\n\nRepro:\n    1) Create an FSDirectory pointing somewhere in the filesystem (e.g. /foo/index/1)\n    2) rm -rf the parent dir (rm -rf /foo/index)\n    3) Try to open an IndexReader\n\nResult: NullPointerException on line \"for(int i=0;i<files.length;i++) { \" -- 'files' is NULL.\n \nExpect: IOException\n\n\n....  \n\nThis is happening because of a missing NULL check in SegmentInfos$FindSegmentsFile.run():\n\n        if (0 == method) {\n          if (directory != null) {\n            files = directory.list();\n          } else {\n            files = fileDirectory.list();\n          }\n\n          gen = getCurrentSegmentGeneration(files);\n\n          if (gen == -1) {\n            String s = \"\";\n            for(int i=0;i<files.length;i++) { \n              s += \" \" + files[i];\n            }\n            throw new FileNotFoundException(\"no segments* file found: files:\" + s);\n          }\n        }\n\n\nThe FSDirectory constructor will make sure the index dir exists, but if it is for some reason deleted out from underneath Lucene after the FSDirectory is instantiated, then java.io.File.list() will return NULL.  Probably better to fix FSDirectory.list() to just check for null and return a 0-length array:\n\n(in org/apache/lucene/store/FSDirectory.java)\n314c314,317\n<         return directory.list(IndexFileNameFilter.getFilter());\n---\n>     String[] toRet = directory.list(IndexFileNameFilter.getFilter());\n>     if (toRet == null)\n>         return new String[]{};\n>     return toRet;\n","customfield_10010":null,"timetracking":{},"customfield_12310120":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10121","value":"New","id":"10121"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10120","value":"Patch Available","id":"10120"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"27223","summary":"NullPointerException from SegmentInfos.FindSegmentsFile.run() if FSDirectory.list() returns NULL ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timbrennan","name":"timbrennan","emailAddress":"tim at zimbra dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Brennan","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timbrennan","name":"timbrennan","emailAddress":"tim at zimbra dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Brennan","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":5,"total":5,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12364313/comment/12478704","id":"12478704","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Whoa, thanks for catching this!\r\n\r\nI would rather leave FSDirectory.list() returning null when the\r\ndirectory does not exist because that would be an API change that\r\nmakes me a little nervous.\r\n\r\nI'll instead fix it in SegmentInfos and add a unit test showing the\r\nbug.\r\n\r\nIndex: src/java/org/apache/lucene/index/SegmentInfos.java\r\n===================================================================\r\n--- src/java/org/apache/lucene/index/SegmentInfos.java\t(revision 515317)\r\n+++ src/java/org/apache/lucene/index/SegmentInfos.java\t(working copy)\r\n@@ -481,6 +481,10 @@\r\n             files = fileDirectory.list();\r\n           }\r\n \r\n+          if (files == null) {\r\n+            throw new FileNotFoundException(\"no segments* file found in directory \" + directory + \": list() returned null\");\r\n+          }\r\n+\r\n           gen = getCurrentSegmentGeneration(files);\r\n \r\n           if (gen == -1) {\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2007-03-07T08:22:16.895+0000","updated":"2007-03-07T08:22:16.895+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12364313/comment/12478714","id":"12478714","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Thanks Tim.  Keep the patches coming!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2007-03-07T08:46:47.118+0000","updated":"2007-03-07T08:46:47.118+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12364313/comment/12478733","id":"12478733","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timbrennan","name":"timbrennan","emailAddress":"tim at zimbra dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Brennan","active":true},"body":"The reason I suggested changing FSDirectory is that a quick look through the callers of Directory.list() show that pretty much none of the callsites expect a null return from this function. \r\n\r\n Check out:\r\n\r\n1) SegmentInfos.java - boolean hasSeparateNorms():\r\n        String[] result = dir.list();\r\n        String pattern;\r\n        pattern = name + \".s\";\r\n        int patternLength = pattern.length();\r\n        for(int i = 0; i < result.length; i++){\r\n          if(result[i].startsWith(pattern) && Character.isDigit(result[i].charAt(patternLength)))\r\n(accesses result.length w/o null check on result)\r\n\r\n\r\n2) IndexFileDeleter.java - void findDeletableFiles():\r\n    String[] files = directory.list();\r\n\r\n    for (int i = 0; i < files.length; i++) {\r\n(access to files.length w/o null check)\r\n\r\n3) Directory.java - static void copy(...)\r\n....same thing...\r\n\r\n\r\nShould probably fix all those callsites as well, if we really expect Directory.list() to return null...\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timbrennan","name":"timbrennan","emailAddress":"tim at zimbra dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Brennan","active":true},"created":"2007-03-07T10:19:22.951+0000","updated":"2007-03-07T10:19:22.951+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12364313/comment/12478738","id":"12478738","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Excellent point.  I will do that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2007-03-07T10:32:05.618+0000","updated":"2007-03-07T10:32:05.618+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12364313/comment/12478749","id":"12478749","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Attached patch to check all places internal to Lucene where we call Directory.list().  I also updated the javadoc of that method to state that it may return null.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2007-03-07T11:16:41.194+0000","updated":"2007-03-07T11:16:41.194+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-825/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i050rz:"}}
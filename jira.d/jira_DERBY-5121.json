{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12500978","self":"https://issues.apache.org/jira/rest/api/latest/issue/12500978","key":"DERBY-5121","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315902","id":"12315902","description":"Head of 10.7 branch as of 2010-11-29","name":"10.7.1.4","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316362","id":"12316362","description":"First release on the 10.8 branch","name":"10.8.1.2","archived":false,"released":true,"releaseDate":"2011-04-29"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2011-03-14 21:41:40.654","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24666","customfield_12310222":"1_*:*_1_*:*_1692919423_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2011-03-29T16:55:38.783+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5121/watchers","watchCount":0,"isWatching":false},"created":"2011-03-10T02:40:19.372+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":["derby_backport_reject_10_5"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"18.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315564","id":"12315564","description":"First release on the 10.7 branch.","name":"10.7.1.1","archived":false,"released":true,"releaseDate":"2010-12-14"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316362","id":"12316362","description":"First release on the 10.8 branch","name":"10.8.1.2","archived":false,"released":true,"releaseDate":"2011-04-29"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12338068","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12338068","type":{"id":"12310050","name":"Regression","inward":"is broken by","outward":"breaks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310050"},"inwardIssue":{"id":"12345511","key":"DERBY-1482","self":"https://issues.apache.org/jira/rest/api/2/issue/12345511","fields":{"summary":"Update triggers on tables with blob columns stream blobs into memory even when the blobs are not referenced/accessed.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-06-14T17:29:02.725+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"When executing an UPDATE trigger, the following error is raised. I will attach a test case:\r\n\r\nERROR XCL12: An attempt was made to put a data value of type 'org.apache.derby.impl.jdbc.EmbedClob' into a data value of type 'INTEGER'.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10364","value":"Data corruption","id":"10364"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10420","value":"Regression","id":"10420"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10421","value":"Seen in production","id":"10421"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"35457","summary":"Data corruption when executing an UPDATE trigger","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10101","value":"Release Note Needed","id":"10101"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10424","value":"Repro attached","id":"10424"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10050","value":"Blocker","id":"10050"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":52,"total":52,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13004952","id":"13004952","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching DummyProc.java and triggerBug.sql, a repro for this issue. Compile DummyProc then run triggerBug via ij.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-10T02:42:14.011+0000","updated":"2011-03-10T02:42:14.011+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13005823","id":"13005823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Changing the description of this bug since experiments show that it is more general. The triggered action seems to expect a row which just contains the columns necessary to execute the action. However, if the UPDATE touches columns which aren't mentioned by the trigger, those columns turn up in the row passed to the action. These extra columns can be in the middle of the action row. This throws off the column number of the compiled action and springs this bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-11T20:39:54.856+0000","updated":"2011-03-11T20:39:54.856+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13005828","id":"13005828","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching a second version of the triggerBug.sql repro. This does not need the procedure class because it demonstrates the bug using an INSERT action. The repro shows that the bug occurs when an extra column is set by the UPDATE statement.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-11T20:47:36.558+0000","updated":"2011-03-11T20:47:36.558+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13006441","id":"13006441","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"It turns out that this bug can manifest itself as data corruptions. I will attach a repro showing that. The bug does not appear in 10.6.2.1 but it does appear in 10.7.1.1. Changing the title of this issue and marking it as a data corrupting regression.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-14T14:52:27.305+0000","updated":"2011-03-14T14:52:27.305+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13006442","id":"13006442","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching triggeredCorruption.sql, a script which demonstrates how this bug can corrupt data.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-14T14:53:52.209+0000","updated":"2011-03-14T14:53:52.209+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13006521","id":"13006521","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Through binary search I have identified the checkin which introduced this data corruption:\r\n\r\nr956763 | mamta | 2010-06-21 19:41:48 -0700 (Mon, 21 Jun 2010) | 5 lines\r\n\r\nDERBY-1482\r\n\r\nOnly read the needed columns for the update trigger when create trigger has identified the columns which will be used in trigger action through the REFERENCING clause. This will avoid reading columns that are not needed thus avoiding OOM problems if the underlying table has large LOBs.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-14T17:13:16.321+0000","updated":"2011-03-14T17:13:16.321+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13006605","id":"13006605","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks for picking up this issue, Mamta. I am raising the urgency to Blocker. I feel that this issue will affect a lot of applications when they upgrade to 10.7 or 10.8. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-14T20:01:56.493+0000","updated":"2011-03-14T20:01:56.493+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13006651","id":"13006651","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Frist of all, thanks so much for having such an easy reproducible test case. \r\n\r\nI looked at the generated code for the trigger action and see the problem Rick described. The purpose of DERBY-1482 was to avoid reading the columns that are not needed by the trigger action, especially the LOB columns which could result in OOM problems. The code that I added for DERBY-1482 looked at the columns referenced in trigger action and *assumed* that the resultset would have just those columns during the trigger execution time. So, in following example, the trigger action references only 2 out of the 3 columns, the 1st and the 3rd column. The trigger action thus assumes that the resultset would have just columns 1 and 3 in the resultset's column positions 1 and 2. But it did not take into account where the triggering SQL might need additional columns of it's own. In the given example, the triggering UPDATE statement is using the column in position 2 from the trigger table and this causes the trigger action to start using the columns in incorrect column positions.\r\n\r\nI understand the urgency of this jira and based on that, I will see if I can disable the optimization introduced by DERBY-1482. Once that is done, I will look into what could be other ways to solve the unnecessary column reads algorithm. One thing that comes to my mind is to may be read all the columns upto the highest column position required by the trigger action. So in our eg, triggeredCorruption.sql, the trigger action is looking at column positions 1 and 3 and hence we should read columns 1, 2 and 3 even though the trigger action does not need the column 2. Any columns after the highest column position required by the trigger action will be read if the triggering SQL requires it but it will not affect the column positions getting used inside the trigger action.\r\n\r\nI will also think of any other possible way to tackle the column reading optimization. If anyone has any other ideas, please let me know.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-14T21:41:40.654+0000","updated":"2011-03-14T21:41:40.654+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13006670","id":"13006670","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"at the trigger execution time is there no way to determine the column position in the table vs the column position in the row of the update result set?  If I understand the problem the current code is correctly indicating to the update which columns are necessary, we are just accessing the wrong ones.   Seems \r\nlike there just needs to be some column fixup or different logic in column accessing for the trigger execution code.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-14T22:14:59.698+0000","updated":"2011-03-14T22:14:59.698+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13006897","id":"13006897","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"It looks to me as though the row set which is passed to the trigger action is already wrapped in another ResultSet. In the case of row-at-a-time triggers, this is a TemporaryRowHolderResultSet. It may be attractive to put some column remapping logic in the TemporaryRowHolderResultSet. I haven't looked at the end-of-statement triggers, but I suspect that there's a wrapper ResultSet there too and some more column remapping logic could be put there. Extra credit if the remapping logic could be factored out and shared.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-15T12:50:57.584+0000","updated":"2011-03-15T12:50:57.584+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13006958","id":"13006958","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching triggeredBug2.sql. This adds a test for a related case involving statement-scope (rather than row-scope) triggers. The problem does not seem to affect statement-scope triggers, at least not in this test case. I see that in both the statement-scope and row-scope cases, the row passed to the trigger is wrapped in a TemporaryRowHolderResultSet.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-15T15:09:33.744+0000","updated":"2011-03-15T15:09:33.744+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13007034","id":"13007034","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"This data corruption regression is in 10.8 and 10.7 codelines.\r\n\r\nI should have a patch for review soon today which will disable the column reading optimization and hence any newly created triggers will work fine. There will be still be issues with triggers already created. This can be a problem with 10.7 since we may already have customers using that release. Fortunately, 10.8 is not out yet to impact any customers. For 10.7, the users will have to drop and recreate their triggers(only the triggers which are defined at row level and which use REFERENCING clause. All the other triggers will work fine).\r\n\r\nOnce we have the patch reviewed and committed, I would like to see how I can do the selective column reading and correct column mapping to the resultset at runtime. With the buggy 10.7 and 10.8 code, at the create trigger time, I do the column mapping for the trigger action columns making the assumptions that those columns are the only columns which will exist in the runtime resultset. That assumption is incorrect as shown in the test cases attached to this jira. I am thinking of pursuing the solution where the trigger action sql should not be generated at the create trigger time. Instead, it should be generated when the trigger gets fired and the column position mapping of trigger action columns should happen based on what columns exist in what positions in the runtime resultset. Please let me know if anyone sees a problem with this approach. Any existing generated trigger action sql for existing triggers will be disregarded and it will be just generated at the trigger firing time. This approach will take care of the existing triggers and the new triggers. Once we have this fix in, the 10.7 users will not have to drop and recreate their triggers.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-15T17:26:04.241+0000","updated":"2011-03-15T17:26:04.241+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13007049","id":"13007049","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Rick, this data corruption should only occur with row level triggers which are using columns in trigger action through REFERENCING clause. All the other kinds of triggers including statement level triggers should not be impacted.\r\n\r\nI will soon submit a patch for review which will have the test cases provided by you in triggeredBug2.sql.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-15T17:53:43.006+0000","updated":"2011-03-15T17:53:43.006+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13007081","id":"13007081","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks, Mamta. This sounds like good progress. I don't understand the performance implications of compiling the trigger action every time a firing statement is compiled. I suspect that the actions are pre-compiled because someone believed that would yield a performance boost. At a high level, I like the idea of compiling the trigger action along with the firing statement, if only because it gets us out of the business of asking people to drop and recreate their triggers when we correct problems like this. Ever since my stint at Sybase, I have not been a big fan of stored prepared statements--I believe they are a runtime optimization with a thousand brittle consequences.\r\n\r\nAt a minimum we would want to make sure that this approach does not break recompilations of prepared statements which may happen because of table changes. For instance, I am thinking about what happens when someone alters the table which is the target of the trigger action.\r\n\r\nThanks,\r\n-Rick","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-15T18:36:26.892+0000","updated":"2011-03-15T18:36:26.892+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13007356","id":"13007356","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Th attached patch(derby5121_patch1_diff.txt) will disable the selective column reading for row level triggers which was introduced by DERBY-1482. As a result of this, Derby will be required to read all the columns from the trigger table. The generated trigger action sql's columns will refer to the columns using theie actual column positions in the trigger table. I have disabled the selective colunm reading by simply assuming in the create trigger code that we are dealing with pre-10.7 database(as if we are in soft upgrade mode from pre-10.7). During the soft-upgrade mode with 10.7 and higher releases, we do not do column reading optimization because the system tables in pre-10.7 are not equipped to keep additional information about trigger action columns. \r\n\r\nThis code change was done in DataDictionaryImpl.getTriggerActionString and looks as follows\r\n\t\tboolean in10_7_orHigherVersion = false;\r\nIn addition to the above change, I also had to catch the column missing error in this same method. This can happen if ALTER TABLE DROP COLUMN is dropping a column from the trigger table and that column is getting referenced in the trigger action sql. This scenario currently in the 10.7 and 10.8 codelines get caught when we find that the column being dropped is getting used in trigger action's referenced column list and if so, then we go ahead and drop that trigger if we are doing alter table drop column cascade or we throw an error for trigger dependency if the alter table drop column restrict is being performed. But since with this patch, we do not keep the trigger action's referenced column list anymore, we can't catch the drop column's dependency in the trigger action's referenced column list. Because of this, I have to see if the trigger action column is not found, then I should throw a column not found exception. The catch of that exception will drop the trigger is we are dealing with alter table drop column cascade or it will throw a trigger dependency exception if we are dealing with alter table drop column restrict.\r\n\r\nIn addition to the above 2 changes, I had to make following change in TriggerDescriptor.getActionSPS. The if condition used to be\r\n\t\tif((!actionSPS.isValid() ||\r\n\t\t\t\t (actionSPS.getPreparedStatement() == null)) && \r\n\t\t\t\t isRow && \r\n\t\t\t\t referencedColsInTriggerAction != null) \r\nBut now with this patch, we don't maintain the information in list referencedColsInTriggerAction and because of that, the above if would always be false. We want to catch triggers that are using REFERENCING clause and because of this, the new if condition will look as follows\r\n\t\tif((!actionSPS.isValid() ||\r\n\t\t\t\t (actionSPS.getPreparedStatement() == null)) && \r\n\t\t\t\t isRow && (referencingOld || referencingNew))\r\n\r\nIn addition to the above three changes, I have added new test to incorporate Rick's reproducible case.\r\n\r\nI have not changed the comments in the code yet because I hope to work on the fix that I proposed earlier in the jira. Once I have that fix in, I can go ahead and change the comments to match that fix.\r\n\r\nderbyall and junit suite ran fine with my changes. If no one has any comments, I can go ahead and checkin this fix Wednesday evening.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-16T05:33:55.262+0000","updated":"2011-03-16T05:54:53.427+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13007358","id":"13007358","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"This patch is based on 10.7 codeline.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-16T05:53:45.590+0000","updated":"2011-03-16T05:53:45.590+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13007520","id":"13007520","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks for the patch, Mamta. I can verify that this patch causes the test case to succeed. I believe there is no value in testing this on the production system where the original problem surfaced. That is because that system uses a 10.7.1.0 database. Once we have a fix which works on soft-upgrade from 10.7.1.0 I will run some tests on that production system. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-16T15:53:37.452+0000","updated":"2011-03-16T15:53:37.452+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13007684","id":"13007684","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I know you said you were not \"fixing\" the existing comments, but I believe the following change is worth a comment to at least associated it with this issue, and indicating this is the key place that is disabling previous work to not fetch unneeded columns:\r\n\r\n-\t\tboolean in10_7_orHigherVersion =\r\n-\t\t\tcheckVersion(DataDictionary.DD_VERSION_DERBY_10_7,null);\r\n+\t\tboolean in10_7_orHigherVersion = false;\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-16T20:38:15.531+0000","updated":"2011-03-16T20:38:15.531+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13008168","id":"13008168","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I am working on backporting this simple fix to disbale the column read optimization from 10.7 to trunk but I am seeing OOM errors for a subset of org.apache.derbyTesting.functionTests.tests.memory.TriggerTests. \r\n\r\nThe OOM should depend on how much heap the test gets run with. On both 10.7 and trunk(with 10.7 changes backported). I see no failures if I run the test with higher heap as shown below\r\njava  -Dderby.tests.trace=true  -Xmx256M -XX:MaxPermSize=128M junit.textui.TestRunner org.apache.derbyTesting.functionTests.tests.memory.TriggerTests\r\n\r\nBut if I run the test on both 10.7 and trunk(with 10.7 changes backported) with lower heap, I see OOM errors\r\njava  -Dderby.tests.trace=true  -Xmx16M -Dderby.storage.pageCacheSize=100 junit.textui.TestRunner org.apache.derbyTesting.functionTests.tests.memory.TriggerTests\r\n\r\nSo the behavior on the 2 codelines with restricted and generous heap is the same when the test is run directly. But when I run the junit suite as follows, I get OOM errors on trunk but not on 10.7 codeline. At this point, I am not sure why. Is there a way that we change the available heap on trunk for org.apache.derbyTesting.functionTests.tests.memory.TriggerTests when it is run through the functionTests.suites.All junit suite? That's the only reason I can think why the test would fail anywere. It appears that on 10.7, we do not change the heap for org.apache.derbyTesting.functionTests.tests.memory.TriggerTests when it is run through the functionTests.suites.All junit suite? Does anyone have any clue about this difference in behavior between 10.7 and trunk? thanks\r\njava  -Dderby.tests.trace=true  -Xmx256M -XX:MaxPermSize=128M junit.textui.TestRunner org.apache.derbyTesting.functionTests.suites.All > runall.out 2>&1\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-17T21:45:40.853+0000","updated":"2011-03-17T21:45:40.853+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13008230","id":"13008230","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"Is it possible a test got added in trunk that sets memory settings but doesn't set them back?\r\nDo you see this behavior only with suites.All, or also with memory._Suite ?\r\nI sometimes use a little non-checked in TempSuite class that basically similates AllPackages (called from suites.All) \r\nbut leaves sections out, to find offending tests...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2011-03-17T23:54:53.078+0000","updated":"2011-03-17T23:54:53.078+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13008241","id":"13008241","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Myrna, thanks for taking the time go over the OOM problem. I will try to narrow down the suites to see where things might be going wrong on trunk. \r\n\r\nBTW, running memory._Suite by itself does not run into OOM.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-18T00:31:29.111+0000","updated":"2011-03-18T00:31:29.111+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13008486","id":"13008486","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Hi Mamta, for the IBM JVM's there is a tool tool that you can use to analyze heap dumps and memory issues , the .phd file that is generated when you get an out of memory.\r\nhttp://www.alphaworks.ibm.com/tech/heapanalyzer\r\n\r\nYou run it like java -Xmx1200m -jar ha21.jar <phd file>\r\n\r\nAnd in a box that comes up on the first screen it  shows the heap size. The menu options allow you to identify leak suspects and it has other features.\r\n\r\nI don't know how the heap size could be changed at runtime though. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-03-18T16:04:51.929+0000","updated":"2011-03-18T16:04:51.929+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13008582","id":"13008582","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I am debugging the code to see what happens at the execution time of trigger firing. Rick, you mentioned TemporaryRowHolderResultSet in one of your comments. I will debug that further but do you know offhand if each trigger gets it's own copy of TemporaryRowHolderResultSet. If so, then I can probably maddle with how column mapping happens. This mapping can be different for different triggers on the same table and I didn't want to mess up TemporaryRowHolderResultSet if it is being shared by all the triggers on the table which are going to get fired. Thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-18T19:08:32.926+0000","updated":"2011-03-18T19:08:32.926+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13008602","id":"13008602","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Hi Mamta,\r\n\r\nIt appears to me that each trigger gets its own TemporarayRowHolderResultSet. See the calls to getNewRSOnCurrentRow(). Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-18T19:54:51.288+0000","updated":"2011-03-18T19:54:51.288+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13009188","id":"13009188","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching Test_5121.java. This test exhaustively walks through all subsets and permutations of columns for a trigger which inserts into a side table based on updates to a master table. The test runs cleanly with Mamta's patch applied. I think this will be a good acceptance test for the solution. Here is how you run this test:\r\n\r\nUsage:\r\n\r\n    java Test_5121 connectionURL columnCount debug\r\n\r\n    where\r\n\r\n        connectionURL is the url to the database\r\n        columnCount is the number of columns in the triggering table\r\n        debug indicates whether to print out extra debug information\r\n\r\n    E.g.:\r\n\r\n    java Test_5121 \"jdbc:derby:memory:db;create=true\" 3 false\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-21T15:57:17.441+0000","updated":"2011-03-21T15:57:17.441+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13009345","id":"13009345","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Rick, your test will be very useful with the code changes I am making in the my codeline. When I have the patch ready I will add these tests as part of our junit test harness.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-21T20:15:36.760+0000","updated":"2011-03-21T20:15:36.760+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13009350","id":"13009350","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I just wanted to summarize the problem here to make it easier to understand the issue and the solution I am working on.\r\n\r\nSome background information : With DERBY-1482, we decided to read only the columns really needed during trigger execution. Trigger only knows about trigger columns and columns in it's trigger action used through the REFERENCING clause. And so DERBY-1482 made the assumption that those will be the only columns read from the trigger table and it uses the relative column positions in that resultset to access the columns in it's trigger action when we generate the internal sql for the trigger action. The problem is that there can be cases when the SQL causing the trigger to fire needs to read more columns than just what the trigger needs. eg\r\ncreate table t1( id int, name varchar( 50 ) );\r\ncreate table t2\r\n(\r\n\tname\tvarchar( 50 )\tnot null,\r\n\tdescription\tint\tnot null,\r\n\tid\tinteger\r\n);\r\ninsert into t2( name, description ) values ( 'Foo Name', 0 );\r\n\r\ncreate trigger t2UpdateTrigger\r\nafter UPDATE of name\r\non t2\r\nreferencing \r\nnew row as nr\r\nfor each ROW\r\ninsert into t1 values ( nr.id, nr.name );\r\n\r\nThe trigger above only needs columns \"name\" and \"id\" from the trigger table and hence it will assume that the runtime resultset will have just those 2 columns, \"name\" as first column in the resultset and \"id\" as the 2nd column in the resultset and using that assumption, it will change trigger action sql \"insert into t1 values ( nr.id, nr.name )\" to following \"insert into t1 values ( CAST(org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getNewRow().getObject(2) AS INTEGER) , CAST (org.apache.derby.iapi.db.Factory::getTriggerExecutionContext().getNewRow().getObject(1) AS VARCHAR(50))  )\r\n\r\nBut the following triggering sql needs more columns than just  \"name\" and \"id\", it also needs \"description\".(The list of columns required by triggering sql are columns used by the triggering sql and columns needed by the triggers which will get fired).\r\nupdate t2 set name = 'Another name' , description = 1;\r\nSo the runtime resulset will end up having columns \"name\", \"description\"  and \"id\". So the column \"id\" is the 3rd column in the resultset and not 2nd column in the resultset as expected by the trigger.\r\n\r\nThe solution I am working on is to see if we can map out only the columns needed by the trigger from the actual runtime resulset created by the triggering sql. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-21T20:21:57.787+0000","updated":"2011-03-21T20:21:57.787+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13009459","id":"13009459","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"Are you still planning on first backporting the fix made to 10.7 into the trunk line?  Have you done any more work to determine if the out of memory is this change or something in your environment?    Given the issues we have had with triggers it may make more sense to go with the safe change for 10.8 and then later after 10.8 is cut you can check in your new fix to trunk and get testing there before putting it into a released codeline.\r\n\r\nMy interpretation of reviewing the change is that it should be safe and not cause unexpected out of memory.  It is basically just\r\nmaking all code go through the existing code path that all pre 10.7 databases are already executing.\r\n\r\nIf you are uncomfortable with your current testing maybe you could post the exact patch against trunk that you are trying and someone else can run tests based on it.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-21T22:59:31.249+0000","updated":"2011-03-21T22:59:31.249+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13009508","id":"13009508","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I am attaching the patch for trunk which is trying to backport changes made to 10.7 to backout DERBY-1482 changes. But these changes on trunk cause a subset of trigger tests to run out of memory. Maybe someone else can try running junit suite if they have the cycle to see if they see the problem too.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-22T01:41:44.010+0000","updated":"2011-03-22T01:41:44.010+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13009701","id":"13009701","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-5121-01-aa-runTimeRemapping.diff. This patch remaps columns at run time in order to fix the bug. I think this at least demonstrates the feasibility of column remapping. An improvement on this patch would be to calculate the remapping at compile time rather than run time.\r\n\r\nSome trickiness is involved because some of the compiled column maps are 0-based and others are 1-based. I have run Test_5121 on this patch and it passes cleanly for 1, 2, 3, and 4 column tables. I stopped running experiments then because the 4 column table gave rise to 61440 test cases.\r\n\r\nI will run the full regression suite to see if that shows any problems.\r\n\r\nTouches the following files:\r\n\r\nM      java/engine/org/apache/derby/impl/sql/execute/TemporaryRowHolderResultSet.java\r\nM      java/engine/org/apache/derby/impl/sql/execute/InsertResultSet.java\r\nM      java/engine/org/apache/derby/impl/sql/execute/GenericTriggerExecutor.java\r\nM      java/engine/org/apache/derby/impl/sql/execute/TriggerEventActivator.java\r\nM      java/engine/org/apache/derby/impl/sql/execute/StatementTriggerExecutor.java\r\nM      java/engine/org/apache/derby/impl/sql/execute/DeleteResultSet.java\r\nM      java/engine/org/apache/derby/impl/sql/execute/RowTriggerExecutor.java\r\nM      java/engine/org/apache/derby/impl/sql/execute/UpdateResultSet.java\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-22T16:28:45.210+0000","updated":"2011-03-22T16:28:45.210+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13009736","id":"13009736","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I believe the tests that you see failing in your run were written specifically to test \t\r\nDERBY-1482.  In order to test that blobs are not being read into memory the tests specifically are coded\r\nto read blobs into memory in the cases that DERBY-1482 fixes.  It is ASSUMED that in the normal suite run\r\nthat there will be enough memory for the tests to pass, and that when the same tests are run as part of the\r\n\"small memory\" test suite that the bugs will be caught.  But maybe due to timing, machine resources, or\r\nprevious tests run these tests no longer successfully run guaranteed in default suite run on trunk.  It would\r\nseem like disabling DERBY-1482 should also disable the memory specific tests if we think those tests are\r\nnot valid once the feature is disabled.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-22T17:40:19.890+0000","updated":"2011-03-22T17:40:19.890+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13009760","id":"13009760","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I am attaching a new patch (DERBY_5121_backoutDerby1492_changes_patch3_trunk_diff.txt)  for trunk which will backport DERBY-1482 changes from trunk, same as 10.7 and will do some additional work(this patch has additional changes than DERBY_5121_patch2_trunk_diff.txt). \r\n\r\nThe patch will also disable the tests that were added for DERBY-1482. \r\n\r\nWith DERBY-1482, these tests would not read in large object columns into memory because the triggers didn't need them. But now that DERBY-1482 changes are being backed out, the large object columns will be read in which can cause the test to run out of memory depending on how much heap is available to it. \r\n\r\nI am running the junit suite just one more time to make sure that I don't run into any OOMs. Once the junit tests run fine, I will go ahead and commit this patch to trunk, thus backing out DERBY-1482 changes. \r\n\r\nThe patch also has a comment in DataDictionaryImpl:getTriggerActionString explaining the code changes for backout. I will add that comment in 10.7 too.\r\n\r\nOnce the tests run fine on trunk, I will disable DERBY-1482 tests on 10.7 too.\r\n\r\nIf any comments, please feel free to post them.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-22T18:27:41.557+0000","updated":"2011-03-22T18:27:41.557+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13009763","id":"13009763","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Hi Rick, thanks for the patch. BTW, I have a patch too to do the remapping of the columns. It is lacking comments at this point. I will work on adding comments so it is easier to understand. I ran your extensive tests with my changes and the tests worked fine. I haven't finished running the junit and derbyall suite with it yet, junit suite is running right now. I hope to put a patch with comments sometime soon today.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-22T18:32:16.379+0000","updated":"2011-03-22T18:32:16.379+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13009769","id":"13009769","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"The derby-5121-01-aa-runTimeRemapping.diff patch creates a shower of problems in the regression tests.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-22T18:36:10.831+0000","updated":"2011-03-22T18:36:10.831+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13009771","id":"13009771","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks, Mamta. Just want to clarify: After you check in your disabling fix, additional work will still be needed to throw away the trigger actions which have been compiled in 10.7 databases? Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-22T18:39:19.860+0000","updated":"2011-03-22T18:39:19.860+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13009830","id":"13009830","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Hi Rick.\r\n\r\nThe backout of DERBY-1482 changes will only take care of of new triggers. \r\n\r\nUnfortunately, the old triggers(created in 10.7) will still have problems and will have to be manually dropped and recreated. The triggers impacted are the row level triggers with REFERENCING clause. Thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-22T20:43:38.941+0000","updated":"2011-03-22T20:43:38.941+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13009832","id":"13009832","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"As a bigger solution to having to ask the users to drop and recreate the triggers during upgrade, it will be ideal if we could internally do this ourselves. I think there are 2 possibilites\r\n1)mark the SPS associated with trigger actions as invalid at the time of upgrade. This way, when they get used next time, we will recreate the correction trigger action sql\r\n2)drop and recreate the trigger action SPSs at the time of upgrade. I am not sure though if this will run into privileges/roles issues since the user doing the upgrade may not have permissions to touch the system tables.\r\n\r\nI would like to investigate option 1) and see if it is doable. I will hold on to posting my patch of remapping and will concentrate on option 1) because if the option 1) works than we can avoid having to ask the users to drop and recreate the triggers. Thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-22T20:47:42.308+0000","updated":"2011-03-22T20:47:42.308+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13011512","id":"13011512","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I looked through the upgrade code and saw that we already mark all the SPS invalid during soft and hard upgrade. This is great because at the time of trigger execution, we check if the trigger is invalid, it is row level and it has REFERENCING clause then we should regenerate the trigger action sql. So, when a user with 10.7.1.1(the version where the triggers can cause data corruption) upgrades to a release which has DERBY-1482 changes backed out (at this moment, that would be 10.8 and next release of 10.7. I will work on bumping the release number of 10,7), the buggy triggers will get fixed and will not cause any data corruption.\r\n\r\nAdditionally, once we have the right fix for DERBY-1482 so that the resultset received by the trigger during execution matches trigger's expectation of column numbering, we can introduce column reading from trigger table to only the columns that are really necessary rather than reading all the columns (which is what we do right now after backing out DERBY-1482 changes).\r\n\r\nI have created upgrade test for 10.8 which will test the behavior explained above.\r\n\r\nIn other words, the users do not have to drop and recreate their triggers anymore after upgrading to a release which has DERBY-1482 changes backed out.\r\n\r\nIf there are any questions, please let me know.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-26T00:09:21.174+0000","updated":"2011-03-26T00:09:21.174+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13012555","id":"13012555","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Attaching the release note for this issue. I will go ahead and close this issue. The work to do selective column reading during trigger execution and providing the correct resultset to trigger at execution time can go as part of DERBY-1482. DERBY-1482 is the original issue to provide this functionality.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-29T16:54:26.657+0000","updated":"2011-03-29T16:54:26.657+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13012605","id":"13012605","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks, Mamta. I'm afraid I can't close this issue yet. I built a quick 10.8.1.0 distribution and ran the production application with it. The good news is that the original error went away. Unfortunately, now I'm getting a new error when the update trigger fires. I will put some effort into scripting the problem. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-29T18:37:17.027+0000","updated":"2011-03-29T18:37:17.027+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13012618","id":"13012618","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Rick, I was hoping that this would fix all the problems since we took out DERBY-1482 changes but looks like not. Can you please post what error you are seeing and I will start poking in the code to see if I can find a reason before you have a repro case? Thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-29T18:53:26.018+0000","updated":"2011-03-29T18:53:26.018+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13012651","id":"13012651","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching a repro for the new problem I am seeing. I haven't had time to trim this down to a smaller case, but I wanted to get this posted quickly Before running this repro, first compile Proc_5121.java. Then do the following:\r\n\r\n1) Using 10.7.1.1, run 5121_create.sql through ij. This will create a 10.7 database with a table which has a bad update trigger. The last statement in the script fails--it is the original statement which disclosed the original problem.\r\n\r\n2) Using the trunk, run 5121_upgrade.sql through ij. You will have to set -Dderby.database.allowPreReleaseUpgrade=true in order to get the soft upgrade to run. The script contains one command, namely, the statement which disclosed the original problem. Now this statement fails with the following error:\r\n\r\nERROR 38000: The exception 'java.sql.SQLException: Column '6' not found.' was thrown while evaluating an expression.\r\nERROR S0022: Column '6' not found.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-29T19:54:24.973+0000","updated":"2011-03-29T19:54:24.973+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13012672","id":"13012672","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"it might be useful to run this test case where step 2 is executed against  main version without the changes submitted for DERBY-5121 .  I am wondering if this is a different bug associated with automatic recompile of triggers where the trigger is a procedure call?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-29T20:31:02.234+0000","updated":"2011-03-29T20:31:02.234+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13012776","id":"13012776","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Hi Rick, I found the problem behind the failure. This happened because DERBY-1482 wasn't completely backed out. We have backed out the code for the triggers so that now that look for the columns in their actual column positions at execution time. But DERBY-1482 also made changes to UPDATE code to read only the colunms needed by it and the triggers that it is going to fire. We need to backout the changes to UPDATE code to make sure that it reads all the columns from the trigger table and not do selective column reading.\r\n\r\nIn the attached patch(based on trunk), I have made that change and run the test you provided and it now runs with no exception. I haven't done any other testing on it. Please feel free to use this patch for testing with the problem 10.7.1.1 database that you are working with.\r\n\r\nI would like to work on following\r\n1)spend little more time on the DERBY-1482 changes to make sure that I am backing out everything relevant. \r\n2)run existing junit and derbyall tests once I have accomplished 1)\r\n3)Add an upgrade test case for the latest example you provided.\r\n\r\nThe reason we didn't see this failure with your last test case was that UPDATE sql was coincidentally reading all the columns upto the highest column position required by the trigger and hence all the columns were available in their right positions even though not all the columns may have been read from the trigger table.\r\n\r\nPlease let me know if you have any questions. I would also appreciate if you would post on the list how your testing goes with my patch if you find time to do any testing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-29T23:38:45.830+0000","updated":"2011-03-29T23:38:45.830+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13012901","id":"13012901","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I have spent some time analyzing the changes that went into UpdateNode as part of DERBY-1482 and I believe that the attached patch, DERBY_5121_NotReadForCommit_patch4_trunk_diff.txt, does the correct job of undoing those changes from UpdateNode. The patch I attached on March 29th(DERBY_5121_NotReadForCommit_patche_trunk_diff.txt) did not remove those changes properly.\r\n\r\nI have also written an upgrade case testing the behavior of UPDATE reading correct columns from the trigger table so that trigger finds the columns it needs.\r\n\r\nI am running junit suite right now to make sure nothing breaks with the attached patch. will also run derbyall suite once junit is finished successfully.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-30T09:55:35.219+0000","updated":"2011-03-30T09:55:35.219+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13012952","id":"13012952","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks, Mamta. I have verified that the production problem goes away if I apply DERBY_5121_NotReadForCommit_patch4_trunk_diff.txt. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-30T13:32:49.117+0000","updated":"2011-03-30T13:32:49.117+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13013615","id":"13013615","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching Test_5121_Upgrade.java. This is a modification of the previous test of column subsets and permutations. This splits the schema creation apart from the DML so that the schema can be created under 10.7 and the UPDATE statements and trigger-firings can be tested under 10.8.\r\n\r\nTo run this test, do the following:\r\n\r\n1) Create the schema by setting your classpath to include the 10.7 jars. Delete the db database. Then do the following to create the schema for 3 column tables:\r\n\r\njava Test_5121_Upgrade \"jdbc:derby:db;create=true\" 3 false\r\n\r\n2) Now set your classpath to include the 10.8 jars. Test trigger-firing after soft-upgrade by doing the following:\r\n\r\njava -Dderby.database.allowPreReleaseUpgrade=true Test_5121_Upgrade \"jdbc:derby:db\" 3 false\r\n\r\nI have verified that Mamta's latest patch fixes the soft-upgrade problem for 1, 2, 3, and 4 column tables.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-30T19:47:45.164+0000","updated":"2011-03-30T19:47:45.164+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13013619","id":"13013619","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Thanks Rick, I really appreciate all the testing you have done with my changes.\r\n\r\nThe DERBY_5121_NotReadForCommit_patch4_trunk_diff.txt has been committed to trunk. I am now working on making the same engine changes to 10.7 codeline. The upgrade test can't be copied from trunk to 10,7 because at this point, there is no way to test upgrades between point releases. It will be good to have the framework in place. I will create a jira for that.\r\n\r\nOnce the derbyall and junit run fine on 10.7, I will commit the changes on that codeline too.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-30T20:07:21.295+0000","updated":"2011-03-30T20:07:21.295+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13013622","id":"13013622","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching a second version of the detailed release note. This version gives users more information about what kinds of triggers are vulnerable to this corruption. I hope that I have described the situation accurately.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-30T20:15:12.854+0000","updated":"2011-03-30T20:15:12.854+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13013848","id":"13013848","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Hi Rick, I looked at the release note and it looks good to me.\r\n\r\nAlso, I have backported engine related changes from trunk(revision 1087049) to 10,7 codeline","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-31T06:19:46.410+0000","updated":"2011-03-31T06:19:46.410+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13013858","id":"13013858","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I do not forsee any further code changes related to backing out DERBY-1482 changes so I think it should be safe to resolve this issue so we don't have any blockers for 10.8 release.\r\n\r\nThe right fix for DERBY-1482 can go in as part of DERBY-1482 even after 10.8 release is out. Those changes can then be made available as next point release of 10.8 and since at the time of upgrade, the trigger SPSes get marked invalid, any changes made for DERBY-1482 will get automatically picked up. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-03-31T06:35:09.742+0000","updated":"2011-03-31T06:35:09.742+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500978/comment/13036919","id":"13036919","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I have converted Rick's test into junit test with revision 1125453. Rick. please feel free to add comments to the junit test if you think it needs any.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2011-05-20T16:40:54.846+0000","updated":"2011-05-20T16:40:54.846+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5121/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06fkn:"}}
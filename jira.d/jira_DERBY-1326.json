{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12340130","self":"https://issues.apache.org/jira/rest/api/latest/issue/12340130","key":"DERBY-1326","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-05-20 02:15:00.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22439","customfield_12310222":"3_*:*_1_*:*_1115906000_*|*_1_*:*_1_*:*_10320482000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_20430000","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-09-25T09:14:24.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1326/watchers","watchCount":0,"isWatching":false},"created":"2006-05-16T00:27:56.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"11.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12313297","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12313297","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12349317","key":"DERBY-1817","self":"https://issues.apache.org/jira/rest/api/2/issue/12349317","fields":{"summary":"Race condition in network server's thread pool","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-09-25T14:54:54.000+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11410","id":"11410","name":"Network Server"}],"timeoriginalestimate":null,"description":"This issue was found when working on DERBY-1219. More details can be found in the comments at http://issues.apache.org/jira/browse/DERBY-1219","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40378","summary":"Network server may abandon sessions when Derby system is shutdown and this causes intermittent hangs in the client","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":48,"total":48,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12402448","id":"12402448","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"To repro this issue, run the test jdbcapi/checkDataSource.java with client framework. The test will hang intermittently. \r\n\r\nTo avoid this hang, the code for system shutdown is currently not executed when running with client driver. This condition has to be removed when this issue is resolved.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-05-16T05:48:09.000+0000","updated":"2006-05-16T05:48:09.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12412579","id":"12412579","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"I am interested in working on this problem. I have some thoughts and ideas which I will try to develop on the wiki and on the mailing list. As the discussion evolves, hopefully the proper solution will become clear.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-05-20T02:15:00.000+0000","updated":"2006-05-20T02:15:00.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12412653","id":"12412653","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"I've placed some background notes at http://wiki.apache.org/db-derby/NetworkServerSessionManagement. I'd like to get some review and checking of this background material before moving on to the next step. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-05-21T06:48:17.000+0000","updated":"2006-05-21T06:48:17.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12412804","id":"12412804","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Bryan, I took a quick look at excellent Wiki page you created about network server session management. I have one minor comment. In the sections for Session lifetime, it may be good to note that these are also ended when the network server restarts (when Derby system is shutdown) or shuts down. For DRDAConnThread lifetime, it would be good to mention about network server restart as this seems to be the cause of the bugs we are seeing.\r\n\r\nI am also attaching a smaller repro 'repro1326.java' I had created to simulate the hang. With this repro too, the hang is intermittent. I have not been able to get a predictable hang so far. To run the repro, start network server on port 1527 and run 'java -Dframework=DerbyNetClient repro1326'. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-05-23T00:18:49.000+0000","updated":"2006-05-23T00:18:49.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12413203","id":"12413203","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"I've been experimenting with the attached patch \"sessionMgmt1.diff\". In my environment, it resolves the hang in checkDataSource, and it also passes Deepa's custom \"repro1326\" test, even after I modified that test to run the shutdown test case 200 times. So I'm starting to feel it's pretty reliable as far as avoiding hangs.\r\n\r\nHowever, I'm not completely happy with it. One issue is that I'm still seeing situations in which a closed() DRDAConnThread is given a non-closed Session to run, which I think is incorrect behavior (non-closed sessions should only be assigned to non-closed threads).\r\n\r\nSo I've still got a ways to go on this problem. But since I've had some significant progress, I wanted to post the work-in-progress changes in order to get feedback, and in order not to lose them.\r\n\r\nComments and suggestions most welcome!\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-05-25T09:14:05.000+0000","updated":"2006-05-25T09:14:05.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12413319","id":"12413319","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Bryan, I applied the patch and ran the repro. I do not get the hang but seeing this exception instead of the usual shutdown exception after a system shutdown:\r\n\r\nEXPECTED EXCEPTION: Insufficient data while reading from the network - expected a minimum of 6 bytes and received only -1 bytes.  The connection has been terminated.\r\n\r\ninstead of\r\n\r\nEXPECTED EXCEPTION: DERBY SQL error: SQLCODE: -1, SQLSTATE: XJ015, SQLERRMC: Derby system shutdown.\r\n\r\nI am still looking at the changes but wanted to check if you get the same results with the patch ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-05-26T06:51:50.000+0000","updated":"2006-05-26T06:51:50.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12413488","id":"12413488","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Hi Deepa, thanks very much for looking at the patch!\r\n\r\nThe new message that you see is definitely  a result of this patch; I see it as well, \r\nand should have mentioned it when I attached the patch. \r\n\r\nI believe that the new symptom is a result of the code I added to DRDAConnThread's\r\nrun() method, to try to handle the case when a thread returns from getNextSession() to\r\nfind itself in the interesting situation of having been given a Session to run, but also having\r\nbeen closed():\r\n\r\n                if (closed())\r\n+        {\r\n+            // FIXME -- I think that if we return from\r\n+            // getNextSession() with a non-null Session, but\r\n+            // we ourselves have been closed(), this indicates\r\n+            // a bug in the Network Server session management,\r\n+            // as it shouldn't have assigned a valid session\r\n+            // to a closed thread. Closing the session here\r\n+            // is rude, but at least it prevents a hard hang. (DERBY-1326)\r\n+            try {\r\n+                if (session != null)\r\n+                    session.close();\r\n+            }catch (Exception e) { e.printStackTrace(); }\r\n                    break;\r\n+        }\r\n\r\nIt's clear that this code is wrong, as evidenced by the symptoms you see.\r\n\r\nNote also that in my code I didn't know what to do if I hit an exception; this is\r\nvery closely related to bug DERBY-1020 (thanks Kathey for pointing this out).\r\n\r\nThe question I have is (and this is the main question left in this bug, I think):\r\n\r\n  what should the DRDAConnThread do in this situation?\r\n\r\nThe possibilities I've thought of include:\r\n - ignore that fact that we've been closed; re-open ourselves and handle\r\n   the Session we've been given\r\n - give the Session back to the NetworkServerControlImpl and ask it to\r\n   assign a different thread to this task\r\n - hard-close the Session, then exit the thread. This was the solution I tried,\r\n   and as you can see it has some awkard side-effects.\r\n\r\nEither of the first two seems like it might be a reasonable approach in the\r\ncase where the Network Server was restarted, not shut down, but they both\r\nseem wrong in the case where the Network Server was shut down; in that\r\ncase it seems that the Session is doomed and we should just pack our\r\nbags and leave quietly.\r\n\r\nPlease let me know what you think about how best to handle this case.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-05-26T22:46:06.000+0000","updated":"2006-05-26T22:46:06.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12413495","id":"12413495","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Hi Bryan,\r\n\r\nI saw your question and suggestions in the previous comment while I was working on this new combined patch. So this comment may sound off-base but I am just posting my thoughts. \r\n\r\nI was experimenting a bit with your patch and I think it is not the code that you added in DRDAConnThread.run method which makes this new exception appear intstead of the old one. Reason I say this is I modified your patch trying to see how we can avoid the closed_thread_getting_valid_session scenario. In this patch, I removed the code you commented with //FIXME in DRDAConnThread.run. Even after that, I see the same exception instead of the usual shutdown exception. However, I have not figured out what is causing this new exception.\r\n\r\nIn the attached trial patch 'sessionMgmt1_and_nosessionsforclosedthreads.diff', I combined your patches 'sessionMgmt1.diff' and 'no-sessions-for-closed-threads.diff'. To me, it looked like 'sessionMgmt1.diff' solves all problems which we found except for closed_thread_getting_valid_session scenario. This scenario seems to be solved by your previous patch 'no-sessions-for-closed-threads.diff'. The problem which we found previously with 'no-sessions-for-closed-threads.diff' was that the \"createSession\" was thinking there are freeThreads (freeThreads !=0 ). But actually the threads it were thinking as available were already closed. For the combined patch to work, freeThreads must become 0 after a restart. This is to ensure that a new thread is created when a  new session comes in after a restart. I think the interrupt calls and the added synchronization assure that freeThreads will become 0 before we start accepting new sessions. Does this sound right?\r\n\r\nI have run the repro multiple times with this patch and did not see the hang.  If you think this patch makes sense, can you please try it on the machine where you can repro the hang easily to see if solves the hang? Thanks.\r\n\r\nI will think more about your question and suggestions in the previous comment as I am planning to look at DERBY-803/DERBY-1020 later today.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-05-26T23:55:50.000+0000","updated":"2006-05-26T23:55:50.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12414193","id":"12414193","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"I think that the cause of the new \"Insufficient data\" exception that is appearing with sessionMgmt1.diff\r\nhas to do with a specific part of the change to the NetworkServerControlImpl restart processing.\r\n\r\nI changed the restart processing so that, instead of just closing the Session objects on the RunQueue,\r\nthe restart code closes *all* the Session objects in the sessionTable. In general, I think that this is\r\nthe right thing to do, as restart processing needs to close all the sessions, not just those that are\r\ncurrently waiting for a free thread.\r\n\r\nHowever, the new code is too powerful, because it also closes the current Session, which is the\r\nsession which is performing the shutdown.\r\n\r\nClosing the current Session terminates it before it has a chance to format and return the Shutdown Exception\r\nmessage back to the client. When the client doesn't get the expected Shutdown Exception, it reports\r\nthis as \"Insufficient data\".\r\n\r\nIf I tweak the patch so that the restart logic is changed back to just closing the Sessions on the RunQueue,\r\nthe nasty \"Insufficient data\" exception disappears, and the client gets a much more reasonable message:\r\n\r\n  ERROR XJ015: DERBY SQL error: SQLCODE: -1, SQLSTATE: XJ015, SQLERRMC: Derby system shutdown.\r\n\r\nSo I think that the patch should be slightly modified, so that this critical loop in the restart processing\r\ngets implemented as:\r\n\r\n  \"For each Session in the sessionTable, *except for the Session performing the shutdown*, close it\"\r\n\r\nBut I'm not quite sure how to code that \"except\" clause.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-06-01T09:52:41.000+0000","updated":"2006-06-01T09:52:41.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12414198","id":"12414198","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Deepa, I was experimenting with your \"sessionMgmt1_and_nosessionsforclosedthreads.diff\" patch.\r\n\r\nI definitely cannot reproduce any hang with this diff; the only problem I can reproduce is the\r\n\"Insufficient Data\" exception which I discussed in the previous comment above\r\n(http://issues.apache.org/jira/browse/DERBY-1326#action_12414193).\r\n\r\nHowever, I am concerned about a comment you made several weeks back, when we\r\nwere first discussing this problem in the context of DERBY-1219:\r\nhttp://issues.apache.org/jira/browse/DERBY-1219#action_12378954\r\n\r\nI think that your comment is still quite valid, and I am wondering how you think we should address it?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-06-01T10:33:41.000+0000","updated":"2006-06-01T10:33:41.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12414236","id":"12414236","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Bryan,\r\nCombined with your code changes in \"sessionMgmt1.diff ', I think my previous comment about 'no-sessions-for-closed-threads.diff' does not hold good. This is the reason I think the combined patch is okay:\r\n\"\r\nThe problem which we found previously with 'no-sessions-for-closed-threads.diff' was that the \"createSession\" was thinking there are freeThreads (freeThreads !=0 ). But actually the threads it were thinking as available were already closed. For the combined patch to work, freeThreads must become 0 after a restart. This is to ensure that a new thread is created when a new session comes in after a restart. I think the interrupt calls and the added synchronization assure that freeThreads will become 0 before we start accepting new sessions.\r\n\"\r\n\r\nTo rephrase it,\r\n\r\n1) With only 'no-sessions-for-closed-threads.diff', we can get to the following scenario: When client starts a new session, the \"createSession\" logic in the server will check if freeThreads are available. Because of the restart, the freeThreads counter may be invalid (freeThreads !=0). This makes the \"createSession\" logic to think there are some free threads available. Hence, it will not create a new thread for the incoming session. Instead, the incoming session is put on the runQueue. However, all the existing threads were marked closed by the restart. And we do not give sessions to closed threads. So this session keeps waiting for a thread. When we start another session (e.g with ij), the hang goes away. When the connection from ij comes in, the newly created thread is able to work on the waiting session and resolve the hang. I think the patch does the right thing by not giving sessions to closed threads. However, it can sometimes cause the case of stranded sessions because of incorrect value of freeThreads counter in \"createSession\" logic.\r\n\r\n2) With the combined patch \"sessionMgmt1_and_nosessionsforclosedthreads.diff\", I think we can assume freeThreads counter will have the correct value when a new session comes in after a restart. The interrupt calls and the added synchronization assure that freeThreads will become 0 before we start accepting new sessions. If this assumption is correct, then we will not have the case of stranded sessions mentioned in 1) above.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-06-01T20:57:04.000+0000","updated":"2006-06-01T20:57:04.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12414497","id":"12414497","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Hi Deepa, thank you for the excellent analysis. It is very helpful.\r\n\r\nThe only part that troubles me is this:\r\n\r\n> The interrupt calls and the added synchronization assure that freeThreads will \r\n> become 0 before we start accepting new sessions\r\n\r\nI am not yet able to see why that is necessarily true.\r\n\r\nI agree that we issue the interrupt() calls prior to completing the restart and prior\r\nto accepting new sessions.\r\n\r\nHowever, the thread which is interrupted responds to this interrupt asynchronously.\r\n\r\nI believe that the only guarantee made by Java is that the thread which we are interrupting\r\nwill receive that interrupt some time in the future, but not necessarily immediately,\r\nand not necessarily before we reach the end of the startNetworkServer() method\r\nand declare the restart complete.\r\n\r\nIn practice, given that the startNetworkServer() method is going to unload the \r\nembedded engine, call System.gc(), and then reload the embedded engine,\r\nthat's probably enough work so that we have a very good chance that all the\r\nold threads have received and responded to their interrupt() before we complete.\r\n\r\nBut I don't think it's actually *guaranteed* by the current changes in the combined patch.\r\n\r\nI may be being too picky here. What do you think?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-06-03T01:54:27.000+0000","updated":"2006-06-03T01:54:27.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12414508","id":"12414508","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Hi Bryan, I don't think you are being picky. After reading your explanation, I agree the combined patch still has some chance of causing a hang. As you explain, the following need not be always true: \"The interrupt calls and the added synchronization assure that freeThreads will become 0 before we start accepting new sessions \". So the assumption that we will have the right value for freeThreads (=0) when a new session comes in after a restart does not hold good. \r\n\r\nKeeping the code to reset \"freeThreads = 0\" during restart seems to be an option. But that will cause the problem that you describe under \"freeThreads counter maintenance\" in http://wiki.apache.org/db-derby/NetworkServerSessionManagement. The counter can become negative. \r\n\r\nIf we plan to use this patch, we need to find out some way to ensure freeThreads counter is maintained correctly. \r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-06-03T02:46:52.000+0000","updated":"2006-06-03T02:46:52.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12414585","id":"12414585","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"I had an idea about how to address the \"failure to create a new thread\" aspect\r\nof the hang, as follows:\r\n\r\nSuppose that, at the end of restart processing, we go ahead and create a new\r\nDRDAConnThread instance, even though at this instance there may not be\r\nany sessions for it to process yet. If not, it will just go into getNextSession and wait.\r\n\r\nWith the current combined patch, during restart processing, we \"poison\" each\r\nof the DRDAConnThread instances by closing and interrupting them, so that\r\nwe know that at some point those threads will die.\r\n\r\nThe problem that we had was that if a new session came in while all those\r\npoisoned threads were still in the process of dieing, then the create-new-session\r\nlogic might not realize that it needed to create a new thread because it might\r\nmistakenly see a non-zero freeThreads count which was counting only poisoned\r\nthreads.\r\n\r\nBut if we always create at least one new thread, then we know that the new\r\nsession will eventually get processed by that new thread.\r\n\r\nIn order for this to be 100% solid I think we have to change runQueueAdd to do\r\na notifyAll(), but that's a slightly different topic, and I think I'll put that bit into\r\nthe Wiki page, because it should live beyond this bug.\r\n\r\nSo, in conclusion, here is my latest idea:\r\n1) At the end of restart processing, create a new thread even though we may not\r\nhave any new sessions for it to process yet.\r\n2) change runQueueAdd to do a notifyAll(), not a notify().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-06-03T22:19:51.000+0000","updated":"2006-06-03T22:19:51.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12414654","id":"12414654","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"This latest attachment, 'withNewThreadAndNoShutdownOfCurrentSession.diff',\r\ncontains the following changes relative to the previous patch proposal\r\n(sessionMgmt1_and_nosessionsforclosedthreads.diff):\r\n\r\n1) runQueueAdd now calls runQueue.notifyAll() rather than runQueue.notify()\r\n2) startNetworkServer now primes the thread pool by starting the first\r\nDRDAConnThread right away, rather than waiting for the first Session to come\r\nin. To make this work, I had to make a few small tweaks to DRDAConnThread\r\ninitialization so that it would defer its initialization until it had its first Session.\r\n3) startNetworkServer now takes the calling Session as an argument. In the\r\ninitial server start case this is null, but if a restart is triggered by a shutdown\r\nexception, the caller passes its Session in. startNetworkServer uses this to\r\navoid closing the Session which is triggering the restart, so it can stay open\r\nlong enough to return the shutdown exception back to the client.\r\n4) The client-masters for checkDataSource and checkDataSource30 are\r\nmodified to add the shutdown exception. This modification of the master file\r\ngoes hand-in-hand with the modification of the test program to re-enable\r\nthe server shutdown/restart during the test.\r\n\r\nPlease take a look at this latest proposal and let me know your comments.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-06-05T00:11:33.000+0000","updated":"2006-06-05T00:11:33.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12414853","id":"12414853","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"I read through the changes in 'withNewThreadAndNoShutdownOfCurrentSession.diff' patch and I think they address all the problems found in the previous comments. I could not apply the patch to my workspace. I think some intermediate check-ins changed the same file. \r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-06-06T03:55:51.000+0000","updated":"2006-06-06T03:55:51.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12414869","id":"12414869","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Thanks for desk-checking the patch, Deepa! I updated my workspace and resolved the merge conflicts in DRDAConnThread, and am re-attaching the patch proposal as 'resolve_DRDAConnThread_conflict.diff'. Hopefully you can now apply this patch to the head of the trunk.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-06-06T04:54:08.000+0000","updated":"2006-06-06T04:54:08.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12414883","id":"12414883","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"I applied 'resolve_DRDConnThread_conflict.diff' and ran the repro 50 times without any hang. This patch solves the hang mentioned in this issue. Also resolves the problems discovered while working on this issue.\r\n\r\nI have only minor comments:\r\n* Indentation seems to be out of place in NetworkServerControlImpl.java in the comment added to startNetworkServer method. Also in the changes in checkDataSource.java\r\n* It may be useful to have some more comment in startNetworkServer method as to why we interrupt the threads in addition to calling close on them.\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-06-06T06:50:45.000+0000","updated":"2006-06-06T06:50:45.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12415066","id":"12415066","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"I am seeing a hang in the test derbynet/DerbyNetNewServer.java with 'resolve_DRDConnThread_conflict.diff'' patch. \r\n\r\nI was using the same workspace where I had applied this patch to try out some things for DERBY-803. I started seeing a hang in derbynet/DerbyNetNewServer.java test. On looking at the .tmp file, I found that the test itself was running to the end. It looked like it was waiting for network server process to stop. I rechecked by reverting my changes, reapplying the patch and running a full build. I was still getting a hang in the test. It looks like there are additional changes in network server shutdown introduced by this patch. \r\n\r\nIn an earlier mail, Bryan had mentioned that derbyall ran successfully with this patch. This could be because of \"timeout=60\" property specified in derbynetclientmats suite. To check this, I ran the test by specifying \"-Dtimeout=3\" on the command line. Then, the test process ran to the end within the timeout period and the test passed. It had this additional line on the console:\r\n\"Server Process did not complete in time. Destroying...\"\r\n\r\nBryan, if you still have the results from derbyall run with this patch, can you please check to see how long the test derbynet/DerbyNetNewServer.java took? If it took close to an hour to complete, it will confirm what I just observed. Otherwise, it may be a problem with my test environment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-06-07T05:59:10.000+0000","updated":"2006-06-07T05:59:10.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12415277","id":"12415277","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Well this is very interesting! There is always something new to learn :)\r\n\r\nThe test program intends to do the following:\r\n - start up the Network Server\r\n - check that it started successfully\r\n - shut it down\r\n - start it up with a slightly different configuration\r\n - check that it started successfully\r\n - shut it down\r\n\r\nSo we think we are starting it up twice and shutting it down twice\r\n\r\nWhen I investigated the hang that Deepa discovered, however, I learned that\r\nin fact we are starting up the Network Server *four* times, and shutting it down\r\ntwice. These extra Network Server instances didn't harm anything in the past,\r\nbecause it was just a waste of memory to start up the extra instances.\r\n\r\nHowever, when I added the new thread creation code in the network server\r\nstartup, it meant that whenever the network server started, a DRDAConnThread\r\nwas also started. And if that network server wasn't shut down, then the\r\nDRDAConnThread instance remained, and prevented the server from shutting\r\ndown, causing the hang.\r\n\r\nThe reason that we are getting the extra NetworkServerControlImpl instances is very\r\nsimple: when you call NetworkServerControlImpl.start, it does the following:\r\n\r\npublic void start(PrintWriter consoleWriter)\r\n    throws Exception\r\n{\r\n    DRDAServerStarter starter = new DRDAServerStarter();\r\n    starter.setStartInfo(hostAddress,portNumber,consoleWriter);\r\n    startNetworkServer(null);\r\n    starter.boot(false,null);\r\n}\r\n\r\nThat is, it directly starts this instance, then it spawns a background thread to\r\nrun the DRDAServerStarter code, which instantiates *another* NetworkServerControlImpl\r\n\r\nMy first idea was to remove the call to startNetworkServer() from this method, and just\r\nlet DRDAServerStarter start up the Network Server.\r\n\r\nSure enough, this fixes the hang in DerbyNetNewServer.\r\n\r\nAnd, conceptually, it seems like a good change to make, because it doesn't seem\r\nlike we should be starting the Network Server twice.\r\n\r\nHowever, removing the call to startNetworkServer causes test failures in a bunch of\r\nother Network Server tests, such as NSinSameJVM, dataSourcePermissions_net,\r\nownServerTests, and testSecMec.\r\n\r\nSo, there's a bunch more investigation to do here :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-06-08T12:05:48.000+0000","updated":"2006-06-08T12:05:48.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12415766","id":"12415766","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Attached is 'unify_NSImpl_instances.diff', with these notes to explain. This\r\npatch belongs with the rest of the DERBY-1326 changes, but I've extracted it\r\nout into a standalone patch to make it easier to study and review.\r\n\r\nRecently, I've been investigating that hang that Deepa uncovered which occurs\r\nwith the latest patch proposal for DERBY-1326.\r\nhttp://issues.apache.org/jira/secure/attachment/12334997/withNewThreadAndNoShutdownOfCurrentSession.diff\r\n\r\nInvestigating that problem has taken me through some interesting analysis\r\nof NetworkServer startup/shutdown issues, which I'd like to describe here, to\r\nsee what sort of reaction I get from the team.\r\n\r\nThere are several different ways to start up the Network Server, but after\r\nsome twists and turns there appear to be two essential techniques:\r\n1) You can instantiate a NetworkServerControl object, and call the start()\r\n   method on it.\r\n2) You can define the derby.drda.startNetworkServer property to true, and then\r\n   start the embedded engine.\r\n\r\nThese two code paths proceed somewhat differently, but end up getting to the\r\nsame place:\r\n1) NetworkServerControl.start() delegates to NetworkServerControlImpl.start(),\r\n   which calls NetworkServerControlImpl.startNetworkServer(), then instantiates\r\n   a DRDAServerStarter object and calls its boot() method.\r\n2) Loading the embedded engine eventually calls JDBCBoot.boot(), which notices\r\n   that derby.drda.startNetworkServer has been set, and calls\r\n   Monitor.startSystemModule() to instantiate a DRDAServerStarter object and\r\n   call its boot() method.\r\n\r\nThe DRDAServerStarter.boot() method uses reflection to:\r\n - dynamically load the Network Server code\r\n - create an instance of NetworkServerControlImpl\r\n - create a daemon server thread, which will then:\r\n - call NetworkServerControlImpl.blockingStart()\r\n\r\nSo whichever way that we start the Network Server, we end up constructing\r\na NetworkServerControlImpl instance and calling blockingStart() on that\r\ninstance from a background thread. This is good.\r\n\r\nHowever, there is an important and interesting difference between the two\r\nstartup methods:\r\n\r\n   DRDAServerStarter.boot() always creates its own instance of the\r\n   NetworkServerControlImpl object and calls blockingStart() on that instance.\r\n   So if you start the Network Server by instantiating a NetworkServerControl\r\n   object in your own code, that NetworkServerControl instance creates a\r\n   NetworkServerControlImpl instance, but then when it calls DRDAServerStarter,\r\n   we end up creating a *second* NetworkServerControlImpl instance to use as\r\n   the master instance, and we never really use the NetworkServerControlImpl\r\n   instance that was used by the NetworkServerControl object that you created.\r\n\r\nWorse, *both* NetworkServerControlImpl instances are started up, in a certain\r\nsense, because NetworkServerControlImpl.startNetworkServer() is called on\r\neach instance:\r\n - NetworkServerControlImpl.start() calls startNetworkServer() on itself before\r\n   it instantiates the DRDAServerStarter object and calls boot()\r\n - NetworkServerControlImpl.blockingStart() calls startNetworkServer() on\r\n   itself as its first action.\r\n\r\nSo if you start up the Network Server by calling NetworkServerControl.start(),\r\nyou end up actually creating *two* Network Server instances, although one of\r\nthem doesn't really do very much. This is the source of the hang that I created\r\nwith the most recent patch proposal to DERBY-1326: when I changed the\r\nstartNetworkServer() method to create a new thread, that code ends up being\r\ncalled twice, but we don't shut down both of these instances, so we never\r\nshut down the extra thread that I created, and that caused the process to\r\nhang and not terminate.\r\n\r\nClearly, one way out of this problem is to re-arrange the thread creation logic\r\nso that the thread is only created when the *real* NetworkServerControlImpl\r\ninstance is started.\r\n\r\nBut I was curious about why there were two NetworkServerControlImpl instances,\r\nsince it seems quite clear to me that the NetworkServerControlImpl class is\r\ndesigned to behave as a singleton object. I thought that if I had made this\r\nassumption that there would only ever be a single instance in a Java app,\r\nothers might tend to make this same assumption in the future, and more bugs\r\nlike the one I accidentally introduced might get introduced in the future.\r\n\r\nSo, for the last week or so, I've been studying this code, trying to figure\r\nout if we really need to have two NetworkServerControlImpl instances, or\r\nwhether it would be cleaner to just have a single instance.\r\n\r\nMy conclusion is that, for the most part, we *don't* need to have both\r\ninstances, and it *is* cleaner to just have a single instance, but there\r\nare a few messy details.\r\n\r\nThe changes that I've been experimenting with in this area are as follows:\r\n1) Refactor the DRDAServerStarter code slightly so that the caller can\r\n   optionally pass in the NetworkServerControlImpl instance to use. If the\r\n   caller does not pass in an instance, DRDAServerStarter creates one via\r\n   reflection, as it does now.\r\n2) Simplify NetworkServerControlImpl.start() so that it no longer calls\r\n   startNetworkServer() on itself, but instead simply calls DRDAServerStarter,\r\n   passing the \"this\" pointer in as the instance to use for starting the server.\r\n3) Modify the DRDAServerStarter boot code so that it loads the embedded\r\n   engine. The current DRDAServerStarter code assumes that the embedded engine\r\n   has already been started; I believe that this is the main reason for the\r\n   current code's call to startNetworkServer() from NetworkServerControlImpl's\r\n   start() method, as a side effect of startNetworkServer() is to load the\r\n   embedded engine. It seems simple to have DRDAServerStarter load the\r\n   embedded engine itself, but an alternative would be to load the embedded\r\n   engine in NetworkServerControlImpl.start().\r\n\r\nWith these changes in place, the Network Server startup and shutdown code\r\nseems substantially cleaner to me, and the tests seem to run very well.\r\nI'm pleased with the results.\r\n\r\nHowever, there is one messy detail that remains to be resolved, and it\r\ninvolves the Network Server shutdown processing. The shutdown() method for\r\nthe Network Server, in NetworkServerControlImpl.shutdown(), uses the following\r\nalgorithm:\r\n - tell the server to shut down\r\n - loop for a while, ping'ing the Network server, until we get an error\r\n\r\nUnfortunately, during this \"ping loop\", the code wants to ensure that no\r\nstray messages from the failed ping operation escape to the user, so the\r\ncode intentionally disables the Network Server console.\r\n\r\nWhen there were two NetworkServerControlImpl instances in play, intentionally\r\ndisabling the console of the one instance was a relatively safe thing to do.\r\n\r\nHowever, when there is only a single instance in the process, disabling the\r\nconsole is a quite disruptive action, because it affects *all* the messages\r\nthat the Network Server might want to print, including the \"normal shutdown\"\r\nmessage that the Network Server prints at the conclusion of shutdown.\r\n\r\nTherefore, I'm coming to believe that we shouldn't disable the console\r\nduring shutdown, but rather should implement a variant \"ping\" operation which\r\ndoesn't print any messages when it fails, but instead just throws an exception,\r\nwhich the shutdown code could catch and handle. Unfortunately, this is not\r\na trivial one-line change, as the code which prints error messages to the\r\nNetwork Server console is buried *deep* in the Network Server command\r\nprocessing code.\r\n\r\nObviously, I've still got more work to do here. But I'm attaching the current\r\nstate of my changes anyway, since I think it's a useful intermediate stage\r\nand would be interesting to reviewers.\r\n\r\nThe other comment to be made is that this change is now becoming quite large,\r\nand probably should be split into multiple smaller patches. I'll pursue that\r\nstrategy later, once I get to a point where I have code that seems solid.\r\n\r\nThanks in advance for all comments, suggestions, and other feedback!\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-06-12T00:47:57.000+0000","updated":"2006-06-12T00:47:57.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12415929","id":"12415929","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Thanks again for posting a detailed description. I read through the description and patch \"unify_NSImpl_instances.diff \" quickly. \r\n\r\nI have few small comments/questions:\r\n\r\n* Currently, the patch does the following \"Modify the DRDAServerStarter boot code so that it loads the embedded engine. \" The description also mentions this: \"an alternative would be to load the embedded engine in NetworkServerControlImpl.start()\". I like this alternative. I am thinking of the scenario where derby.drda.startNetowrkServer property is set and we boot embedded driver. In this scenario, if we load the embedded engine in the DRDAServerStarter boot code, it will appear that we are trying to boot the embedded driver twice. However, this will not do any harm as it will be a no-op. I think it would be better to avoid doing this as it causes confusion why we are loading the driver again when we trace the path from loading embedded engine.\r\n\r\n* There is a slightly different code path when we start network server from the command line. In this case, we create an instance of NetworkServerControlImpl and then call executeWork which processes the \"start\" command by calling blockingStart(). There is no DRDAServerStarter involved here as we do not need to launch another thread. This is not very relevant for the current patch but just mentioning it in case we plan to re-organize the code. \r\n\r\n* It looks like the only purpose of calling DRDAServerStarter in NetworkServerControlImpl.start method is to launch a separate thread. The javadoc comment for NetworkServerControlImpl.start says:\r\n\t/**\r\n\t * Start a network server.  Launches a separate thread with \r\n\t * DRDAServerStarter.  Want to use Monitor.startModule,\r\n\t * so it can all get shutdown when cloudscape shuts down, but \r\n\t * can't get it working right now.\r\n\r\nFrom  current behaviour, we do not shutdown network server when we shutdown Derby. Does anyone know if there is any plan to do as indicated by the comment: \"Want to use Monitor.startModule, so it can all get shutdown when cloudscape shuts down, but can't get it working right now.\" ? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-06-13T05:49:41.000+0000","updated":"2006-06-13T05:49:41.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12416494","id":"12416494","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"> Deepa Remesh commented:\r\n> -----------------------\r\n\r\n[snip]\r\n\r\n> From  current behaviour, we do not shutdown network server when we shutdown Derby. Does anyone know if there is any plan to do as indicated by the comment: \"Want to use Monitor.startModule, so it can all get shutdown when cloudscape shuts down, but can't get it working right now.\" ? \r\n\r\n\r\nSpeaking of current behaviour, here are some observations I have made recently:\r\n\r\na) In the \"embedded server using properties\" scenario, the Network Server starts when the embedded driver is loaded and stops when it is \"unloaded\", i.e. when the Derby system is shut down: DriverManager.getConnection(\"jdbc:derby:;shutdown=true\");\r\n\r\nb) In the \"embedded server using NetworkServerControl API\" scenario, the Network server of course starts when NetworkServerControl.start() is called, and stops when shutdown() is called. However, if the Derby system is shut down (by loading the embedded driver and doing as shown above), clients can no longer connect (getting \"No suitable driver\". Why?). The Network Server port seems to be listening on the same port still, though, according to netstat. Then, if I try to restart the server using the API (without calling shutdown() first), I get the message \"Could not listen on port 1527 on host 0.0.0.0.\". This makes sense, since the port is already in use. However, after start() is called the second time, clients _are_ in fact able to connect. There seems to be something happening when start() is called, even if the port is busy, that is needed to make the server able to accept connections again.\r\n\r\nI have not done any code inspection in these cases, so I don't know if this is very helpful with regards to this Jira issue. I just reacted when I saw the above comment.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2006-06-16T20:48:48.000+0000","updated":"2006-06-16T20:48:48.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12419031","id":"12419031","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"I want to thank all the reviewers for their helpful feedback! Those are very good suggestions.\r\n\r\nI am hoping to return to this bug and continue working on it, incorporating the various ideas.\r\n\r\nI was dismayed by how hard it seemed it was going to be to make a variation of the Network Server \"ping\" API which was silent.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-07-04T06:35:02.000+0000","updated":"2006-07-04T06:35:02.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12432883","id":"12432883","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"I'm not actively working on this. I hope to return to it in the future, but if somebody else has time in the meantime, please feel free to explore this issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-09-06T15:58:59.000+0000","updated":"2006-09-06T15:58:59.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434123","id":"12434123","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attaching a repro (Restart.java) which always causes a hang in my environment. What it does is:\r\n\r\n  1) Open 20 connections to the server.\r\n  2) Close all connections.\r\n  3) Shut down the engine (will make the server restart).\r\n  4) Open and close a connection 20 times (usually hangs on the second connection).\r\n\r\nAfter (3), the server has 20 threads sleeping in runQueue.wait(). All of these are closed, but when they start waking up in (4), they don't notice that they have been closed until they have picked up a session from the run queue. That session will be abandoned, and the client hangs.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-12T11:27:45.000+0000","updated":"2006-09-12T11:27:45.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434209","id":"12434209","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Restart.java reliably reproduces the hang in my environment as well. Very nice.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-09-12T16:36:37.000+0000","updated":"2006-09-12T16:36:37.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434296","id":"12434296","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"It is not clear to me why an engine shutdown should close down all DRDAConnThreads. I kind of understand why the sessions are closed (although that would happen implicitly anyway) since their embedded connections are closed as part of the engine shutdown. The DRDAConnThreads are however merely worker threads which don't have any dependencies on the engine instance that was active when they were created, so there is no reason why they can't be reused after the restart of the engine. Does anyone see problems with reusing the threads? In my opinion, it would be easier to ensure a consistent state after a restart if the threads were kept.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-12T22:19:46.000+0000","updated":"2006-09-12T22:19:46.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434299","id":"12434299","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"> Does anyone see problems with reusing the threads?\r\n\r\nDeepa and I discussed this a fair amount in DERBY-1219; you should\r\nprobably review that discussion to see if there's more you can learn from it.\r\nIn particular, the discussion regarding \"skipThreads.diff\" at:\r\nhttp://issues.apache.org/jira/browse/DERBY-1219#action_12378300\r\n\r\nIf we didn't close down the threads, would we do anything to notify them of\r\nthe shutdown? Were you proposing to leave them alone entirely? Or were\r\nyou proposing to notify them of the shutdown, but not require the threads to exit?\r\n\r\nAre you sure a DRDAConnThread doesn't have dependencies on the engine\r\ninstance? The thread has a pointer to a session, and a session seems like\r\nit could point to database objects (like Connection objects, e.g.)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-09-12T22:35:00.000+0000","updated":"2006-09-12T22:35:00.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434306","id":"12434306","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=forsini","name":"forsini","emailAddress":"francois dot orsini at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Francois Orsini","active":true},"body":"Well, we do connect to the Derby engine instance from the network server layer so if the embedded Derby engine goes down, we would have to reinstantiate the database connections (logic is not there right now if am not mistaken), which means some state(s) have to be kept around and some logic has to be added. But then, how do you handle incoming request from the client(s), especially if it takes some time to recover the database(s)...What is there is a corruption and some database cannot be recovered? What if after a reboot of the engine some derby properties have affected the behavior and configuration of the recovered databases - For instance, some database properties are static, so they won't be taken into account until the next reboot, which can also mean that a client (user) would no longer be allowed to authenticate if the authentication provider was changed before the next reboot - This is true for Strong Password Substitute which only works with BUILT-IN or NONE authentication providers right now...Hence in this last case, a security mechanism negotiation needs to happen between the client and the network server...Another case if that if you enable authentication at the engine level but derby instance has not rebooted yet, you will then not be able to re-authenticate based on the cached database info per DRDA session - Simply because a password may not be cached at all since there was no authentication required beforehand and now there is because the static property got picked-up by the database in question at the next engine/database reboot...The connection with the database would not work and the client would probably get confused with some authentication exception where he/she was already authenticated before the Derby engine got shutdown...\r\n\r\nWere you actually implying some auto database reconnect of the current DRDA threads created in the network server once the Derby engine or/and databases are brought back up?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=forsini","name":"forsini","emailAddress":"francois dot orsini at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Francois Orsini","active":true},"created":"2006-09-12T22:51:50.000+0000","updated":"2006-09-12T22:51:50.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434398","id":"12434398","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Francois wrote:\r\n\r\n> Were you actually implying some auto database reconnect of the\r\n> current DRDA threads created in the network server once the Derby\r\n> engine or/and databases are brought back up?\r\n\r\nYes, when the server detects that one of the clients has shut down the\r\nengine (it checks the SQLSTATE of exceptions before sending them to\r\nthe client), it (a) closes all sessions that are in the run queue\r\nwaiting for a thread, (b) poisons all DRDAConnThreads, and (c) reboots\r\nthe engine. Because the poisoned DRDAConnThreads are left around, they\r\nwill eventually pick up a session but abandon it.\r\n\r\nBryan wrote:\r\n\r\n> Deepa and I discussed this a fair amount in DERBY-1219; you should\r\n> probably review that discussion to see if there's more you can learn\r\n> from it.  In particular, the discussion regarding \"skipThreads.diff\"\r\n> at: http://issues.apache.org/jira/browse/DERBY-1219#action_12378300\r\n\r\nThere are many interesting patches attached to that issue (though I am\r\ndefinitely not going for any solution which involves\r\nThread.interrupt()). skipThreads.diff seems to do exactly what I\r\nproposed. From the comments, it seems like there were two objections:\r\n\r\n  1) It didn't fix all of the hangs.\r\n  2) Removing the cleanup code didn't feel quite right, but if the\r\n     threads could be reused after a restart, it should be okay.\r\n\r\nThe hangs mentioned in (1) could be the same ones as DERBY-1817\r\nfixed. I also believe that the threads can be reused after a restart.\r\n\r\n> If we didn't close down the threads, would we do anything to notify\r\n> them of the shutdown? Were you proposing to leave them alone\r\n> entirely? Or were you proposing to notify them of the shutdown, but\r\n> not require the threads to exit?\r\n\r\nI don't think we need to notify them about the shutdown. If a thread\r\nis waiting for runQueue notification in getNextSession(), it is not\r\nbound to a session and hence doesn't need to know about the\r\nshutdown. If a thread has a session bound to it, it would stay\r\nsleeping (and unavailable for new sessions) until the client closes\r\nthe connection or disconnects. This is quite similar to the current\r\nbehaviour (the closed threads are not freed until there is some\r\nactivity on them).\r\n\r\nFor the latter (threads with sessions), it would make sense to notify\r\nthem about the shutdown so they could drop their invalid sessions\r\nearlier, but that would be an optimization and not a correctness\r\nissue, I think.\r\n\r\n> Are you sure a DRDAConnThread doesn't have dependencies on the\r\n> engine instance? The thread has a pointer to a session, and a\r\n> session seems like it could point to database objects (like\r\n> Connection objects, e.g.)\r\n\r\nAll DRDAConnThread's dependencies on the engine go through the session\r\npointer. For free threads, the session pointer is null, hence there\r\nare no dependencies. If it picks up a new session, it would depend on\r\nthe new session's engine, not the old one.\r\n\r\nFor active DRDAConnThread instances, there are dependencies on the old\r\nengine after the shutdown. However, this is also the case for the\r\ncurrent code (the thread is marked as closed, but the session is not\r\nabandoned and the thread is not stopped until the client tries to\r\nperform an operation on the connection).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-13T10:13:13.000+0000","updated":"2006-09-13T10:13:13.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434428","id":"12434428","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I'm also exploring these options:\r\n  1) Poisoning all active threads (those with session != null) and keeping the free threads.\r\n  2) Poisoning all threads and make poisoned threads put sessions back in runQueue. This would also require moving the creation of new threads to runQueueAdd() in order to prevent the queue from growing bigger than the pool of free threads.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-13T12:39:29.000+0000","updated":"2006-09-13T12:39:29.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434481","id":"12434481","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"> For the latter (threads with sessions), it would make sense to notify\r\n> them about the shutdown so they could drop their invalid sessions\r\n> earlier, but that would be an optimization and not a correctness\r\n> issue, I think. \r\n\r\nI think there could be a correctness issue here, actually.\r\n\r\nOne of my worries had to do with DERBY-51, and whether there was\r\nany implicit or explicit contract about how Network Server shutdown and\r\nengine/database shutdown were linked.\r\n\r\nThat is, it seems to me that a user might expect that if they shut down\r\nthe Network Server, that when that call returned to them, their application\r\ncould assume that the database was also shut down as of that point.\r\n\r\nNOTE: I'm not saying that this is how things currently work; I'm just saying\r\nthat it seems to me that users might make that assumption and we\r\nhaven't been explicit about it one way or another. But that's DERBY-51,\r\nproperly, not this bug.\r\n\r\nStill, if we make a change for this bug that forces our hand w.r.t. DERBY-51,\r\nwe should make it clear that we're doing so intentionally so that we don't\r\nlater reverse that change and re-introduce this problem.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-09-13T15:53:22.000+0000","updated":"2006-09-13T15:53:22.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434547","id":"12434547","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Thanks Knut for working on this.\r\n\r\nSome questions/thoughts:\r\n* I think it is okay to re-use free/idle threads without closing them. It may not be okay to re-use active threads without closing/poisoning them. If we do this, wouldn't we end up with threads getting invalid/closed sessions to work on?\r\n\r\n* Isn't this a possible scenario which can cause a hang in a client: When restart is in progress, a new client session comes in and gets added to runQueue. After the session is added, the restart code closes the new session or clears the runQueue. So the server just discards the new session and the client keeps waiting.\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-09-13T21:26:12.000+0000","updated":"2006-09-13T21:26:12.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434697","id":"12434697","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attaching a patch (derby-1326-cleanup_exceptions.diff) with two small\r\ncleanups in preparation for the real fix (for which the approach\r\nhasn't been chosen yet). None of the two cleanups will fix the hang.\r\n\r\nDescription of cleanup in DRDAConnThread.handleException(): When I was\r\nstress testing one possible fix for the hang, I noticed a new type of\r\nhang that I didn't understand. After a bit of investigation, I found\r\nthat the stress test triggered a NullPointerException while running\r\nhandleException(). handleException() is written so that all code paths\r\nend with closeSession() and close(). However, if a runtime exception\r\nis thrown, closeSession() and close() are skipped, and the\r\nDRDAConnThread stops without closing the session (which leads to a\r\nhang on the client). To fix this, I refactored handleException() so\r\nthat closeSession() and close() are called from a finally clause.\r\n\r\nDescription of cleanup in NetworkServerControlImpl.startNetworkServer():\r\nCurrently, the restart code closes and removes all sessions in\r\nrunQueue, but it leaves them in sessionTable as long as the network\r\nserver runs. Fix: Remove them from sessionTable as well. Also, a\r\nsynchronized block was added around the runQueue loop in case\r\naddSession() or getNextSession() modifies the size of runQueue while\r\nthe loop is running.\r\n\r\nI thought it would be better to get in these changes in advance to\r\nmake the real fix smaller and cleaner.\r\n\r\nDerbyall ran cleanly with these changes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-14T14:39:40.000+0000","updated":"2006-09-14T14:39:40.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434718","id":"12434718","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Bryan, I'm not sure I understand what impact this could have on\r\nDERBY-51. DERBY-51 is about server shutdown, whereas this issue is\r\nabout a client opening a connection which has the side effect of\r\nshutting down the engine.\r\n\r\n> That is, it seems to me that a user might expect that if they shut\r\n> down the Network Server, that when that call returned to them, their\r\n> application could assume that the database was also shut down as of\r\n> that point.\r\n\r\nIf the network server is started from command line and the user\r\ninvokes NetworkServerControl.shutdown() this is exactly what happens\r\nin Derby 10.2. In 10.1, and in 10.2 when the server is not started\r\nfrom command line, the server does not shut down the engine/databases\r\non shutdown. However, getConnection(\"...;shutdown=true\") does not shut\r\ndown the server, only the engine.\r\n\r\nI don't see that poisoning or not poisoning the threads should affect\r\nthat behaviour or \"force our hands\" in any way w.r.t. DERBY-51. When\r\nthe *server* at a later point is told to shut down, it is free to shut\r\ndown (or not to shut down) the *engine* regardless of threads with old\r\nsessions hanging around. Also, threads with old sessions can be\r\npresent on the server for a long time after an engine shutdown even in\r\nthe current code (there is no call to Thread.interrupt() after the\r\nengine has been shut down).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-14T15:53:20.000+0000","updated":"2006-09-14T15:53:20.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434752","id":"12434752","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Deepa wrote:\r\n\r\n> * I think it is okay to re-use free/idle threads without closing\r\n>   them. It may not be okay to re-use active threads without\r\n>   closing/poisoning them. If we do this, wouldn't we end up with\r\n>   threads getting invalid/closed sessions to work on?\r\n\r\nYes, that is correct. This is also the case with the current code. The\r\nactive threads remain alive until the client sends a new\r\ncommand. Since the embedded connection is closed, it gets a\r\nconnection-closed exception and closes the session, before it\r\ndiscovers that the thread is closed as well, and exits. If we don't\r\nclose the threads, we get the same behaviour, except that the thread\r\nis reused instead of closed down after the connection-closed\r\nexception.\r\n\r\n> * Isn't this a possible scenario which can cause a hang in a client:\r\n>   When restart is in progress, a new client session comes in and gets\r\n>   added to runQueue. After the session is added, the restart code\r\n>   closes the new session or clears the runQueue. So the server just\r\n>   discards the new session and the client keeps waiting.\r\n\r\nThis is a possible scenario, but it won't cause a hang. Since the\r\nsession and its socket streams have been closed, the client will get\r\nan IOException on read() (seen as DRDAProtocolException, for instance:\r\ninsufficient data, read -1 bytes, expected 6).\r\n\r\n(But there is in fact a similar situation that can occur in the\r\ncurrent code, and that will cause a hang: If a new session is added to\r\nrunQueue after the restart code has closed all sessions in runQueue,\r\nbut before it has called runQueue.clear(), the new session will be\r\nremoved from runQueue without being closed, and the client will\r\nhang. derby-1326-cleanup_exceptions.diff should fix that issue.)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-14T17:56:51.000+0000","updated":"2006-09-14T17:56:51.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434834","id":"12434834","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Hi Knut Anders, thanks for the clarifications. I am comfortable with your explanation.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-09-14T22:29:16.000+0000","updated":"2006-09-14T22:29:16.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434851","id":"12434851","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Thanks Knut for the answers. I still cannot wrap my head around old sessions hanging around in the server. I think this concerns the current code and not related to your patch. The cleanups you suggested sound good to me.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-09-14T23:55:15.000+0000","updated":"2006-09-14T23:55:15.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434908","id":"12434908","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Committed derby-1326-cleanup_exceptions.diff with revision 446538.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-15T08:14:32.000+0000","updated":"2006-09-15T08:14:32.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434975","id":"12434975","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attaching patch (derby-1326-skipThreads.diff) which modifies NetworkServerControlImpl the same way as Bryan's skipThreads.diff (attached to DERBY-1219). I cannot reproduce the hang with the patch. Derbyall ran cleanly on Solaris 10 x86, Sun JVM 1.5.0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-15T13:40:42.000+0000","updated":"2006-09-15T13:40:42.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434985","id":"12434985","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Deepa wrote:\r\n> I still cannot wrap my head around old sessions hanging around in the server.\r\n\r\nThey hang around in the server because the DRDAConnThread could be blocked in a read() call. read() will block until the socket stream is closed (either by the client or the server) or the client sends data. Calling close() on the DRDAConnThread only sets a flag, so this won't interrupt read(). I think Bryan was very close to solving this when he went through sessionTable and closed each session (which will take down the socket stream and make read() return -1 immediately). See one of his earlier comments about this. I don't think that issue is directly related to the hang or abandoning of sessions, so it should probably be filed as a separate issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-15T14:05:12.000+0000","updated":"2006-09-15T14:05:12.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12434998","id":"12434998","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"I'll file a separate issue for removing all the existing sessions after a restart. From Knut's comments, this is only an optimization issue.\r\n\r\nAs derby-1326-skipThreads.diff resolves this hang, we can re-enable the shutdown in the test jdbcapi/checkDataSource.java. This was commented out as it caused the test to hang intermittently. It may be good to add the new repro \"Restart.java\" to the regression tests as it reliably reproduces this hang.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-09-15T14:42:55.000+0000","updated":"2006-09-15T14:42:55.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12435462","id":"12435462","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for the suggestions, Deepa. I committed skipThreads with revision 447375. Will post a new patch with the suggested test changes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-18T11:45:42.000+0000","updated":"2006-09-18T11:45:42.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12435519","id":"12435519","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"derby-1326-checkds.diff re-enables the shutdown in checkDataSource. Without the skipThreads patch, checkDataSource and checkDataSource30 hung intermittently. With the skipThreads patch, they didn't. Derbyall ran cleanly. Committed with revision 447462.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-18T16:35:07.000+0000","updated":"2006-09-18T16:35:07.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12437487","id":"12437487","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attaching a patch which makes derbynet/ShutDownDBWhenNSShutsDownTest.junit run the repro (Restart.java) as a JUnit test case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-25T09:06:09.000+0000","updated":"2006-09-25T09:06:09.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12437489","id":"12437489","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Committed derby-1326-restartTest.diff with revision 449616. Marking as fixed in 10.2.1.5 since the fix (but not all tests) made it into the release candidate.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-25T09:14:24.000+0000","updated":"2006-09-25T09:14:24.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12340130/comment/12437581","id":"12437581","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Closing the issue as the fix is available in 10.2 and trunk. Thanks to Knut, Bryan (and others involved) in resolving this issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-09-25T14:54:54.000+0000","updated":"2006-09-25T14:54:54.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1326/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i079y7:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12414620","self":"https://issues.apache.org/jira/rest/api/latest/issue/12414620","key":"DERBY-4053","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313401","id":"12313401","description":"Head of 10.4 branch","name":"10.4.2.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314116","id":"12314116","description":"10.5.2 Release July 30 2009 (794445) Now deprecated","name":"10.5.2.0","archived":false,"released":true,"releaseDate":"2009-07-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313727","id":"12313727","description":"Feature release","name":"10.6.1.0","archived":false,"released":true,"releaseDate":"2010-05-18"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-02-24 19:26:54.46","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23995","customfield_12310222":"1_*:*_1_*:*_13288082885_*|*_6_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2009-07-15T17:36:22.774+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4053/watchers","watchCount":0,"isWatching":false},"created":"2009-02-11T22:28:19.889+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"12.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12325609","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12325609","type":{"id":"10032","name":"Blocker","inward":"is blocked by","outward":"blocks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10032"},"inwardIssue":{"id":"12422507","key":"DERBY-4155","self":"https://issues.apache.org/jira/rest/api/2/issue/12422507","fields":{"summary":"jdbcapi/XATest.java  doesn't seem to be running anywhere","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12326070","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12326070","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12423504","key":"DERBY-4180","self":"https://issues.apache.org/jira/rest/api/2/issue/12423504","fields":{"summary":"SQLTransactionRollbackException in XATransactionTest when testing client/server compatibility","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12325641","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12325641","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12430250","key":"DERBY-4304","self":"https://issues.apache.org/jira/rest/api/2/issue/12430250","fields":{"summary":"Network Server shutdown should handle exceptions and finish the server shutdown completely","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}},{"id":"12325645","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12325645","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12386268","key":"DERBY-3319","self":"https://issues.apache.org/jira/rest/api/2/issue/12386268","fields":{"summary":"Logical connections do not check if a transaction is active on close","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-08-31T21:31:33.275+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11410","id":"11410","name":"Network Server"},{"self":"https://issues.apache.org/jira/rest/api/2/component/11413","id":"11413","name":"Test"}],"timeoriginalestimate":null,"description":"Running suites.All with IBM 1.5  on 10.5.0.0 alpha - (743198)  I got a hang in the test run.  The last test to run successfully was xtestNestedSavepoints, but I am not sure exactly what test caused  the hang.  I took a thread dump which I will attach, which showed network server up and running but no ClientThread and a ping attempt blocked.\r\n\r\nThis hang is very similar to the hang that was seen after the fix attempts for DERBY-1465 but that change was backed out so it is not related to that change.   It could be that the change for DERBY-1465 just made this highly intermittent problem more likely.\r\n\r\n\r\n\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10369","value":"Regression Test Failure","id":"10369"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"38327","summary":"Network Server's failure to rollback local transactions on shutdown can cause  hang on startup with message java.net.BindException: Address already in use: NET_Bind in derby.log ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10050","value":"Blocker","id":"10050"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":56,"total":56,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12672818","id":"12672818","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Attached are the derby.log, java core dump at the time of the hang, and the System.out of the run.  This was run on a single CPU machine. Windows XP\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-02-11T22:58:26.641+0000","updated":"2009-02-11T22:58:26.641+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12676372","id":"12676372","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"I've seen this also with 10.4 and ibm 1.5, on a machine with 2 cpu, with 'hyperthreading' switched on. \r\nI'll experiment and see if it changes things if I switch off the hyperthreading.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2009-02-24T19:26:54.460+0000","updated":"2009-02-24T19:26:54.460+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12682759","id":"12682759","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"The frequency of the hangs on the machine where I run 10.4 tests have diminished a lot after I had hyperthreading switched off. With it switched on, it was practically every run, and not in the same test everytime.\r\nHowever, I did see one more recently.\r\nIn addition to the Net-Bind messages in system/derby.log, I also got this in the test output, not sure if that was an environment quirk or if it's related to the problem:\r\ntestAllDataSources used 313 ms java.net.SocketException: Connection reset\r\n\tat java.net.SocketInputStream.read(SocketInputStream.java:197)\r\n\tat java.net.SocketInputStream.read(SocketInputStream.java:116)\r\n\tat org.apache.derby.impl.drda.NetworkServerControlImpl.fillReplyBuffer(Unknown Source)\r\n\tat org.apache.derby.impl.drda.NetworkServerControlImpl.readResult(Unknown Source)\r\n\tat org.apache.derby.impl.drda.NetworkServerControlImpl.pingWithNoOpen(Unknown Source)\r\n\tat org.apache.derby.impl.drda.NetworkServerControlImpl.ping(Unknown Source)\r\n\tat org.apache.derby.drda.NetworkServerControl.ping(Unknown Source)\r\n\tat org.apache.derbyTesting.junit.NetworkServerTestSetup.pingForServerUp(NetworkServerTestSetup.java:546)\r\n\tat org.apache.derbyTesting.junit.NetworkServerTestSetup.pingForServerStart(NetworkServerTestSetup.java:615)\r\n\tat org.apache.derbyTesting.junit.NetworkServerTestSetup.setUp(NetworkServerTestSetup.java:191)\r\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:18)\r\n\tat junit.framework.TestResult.runProtected(TestResult.java:124)\r\n\tat junit.extensions.TestSetup.run(TestSetup.java:23)\r\n\tat org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:19)\r\n\tat junit.framework.TestResult.runProtected(TestResult.java:124)\r\n\tat junit.extensions.TestSetup.run(TestSetup.java:23)\r\n\tat junit.framework.TestSuite.runTest(TestSuite.java:208)\r\n\tat junit.framework.TestSuite.run(TestSuite.java:203)\r\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:19)\r\n\tat junit.framework.TestResult.runProtected(TestResult.java:124)\r\n\tat junit.extensions.TestSetup.run(TestSetup.java:23)\r\n\tat org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\n\tat junit.framework.TestSuite.runTest(TestSuite.java:208)\r\n\tat junit.framework.TestSuite.run(TestSuite.java:203)\r\n\tat junit.framework.TestSuite.runTest(TestSuite.java:208)\r\n\tat junit.framework.TestSuite.run(TestSuite.java:203)\r\n\tat junit.framework.TestSuite.runTest(TestSuite.java:208)\r\n\tat junit.framework.TestSuite.run(TestSuite.java:203)\r\n\tat junit.textui.TestRunner.doRun(TestRunner.java:116)\r\n\tat junit.textui.TestRunner.start(TestRunner.java:172)\r\n\tat junit.textui.TestRunner.main(TestRunner.java:138)\r\nF.\r\n----------------------\r\nAfter this, there were a couple more fixtures that apparently went ok:\r\n----------------------\r\nconnectionJdbc20 used 2109 ms .\r\nresultsetJdbc20 used 781 ms .\r\nmaxfieldsize used 67593 ms .\r\nSetQueryTimeoutTest used 43750 ms .\r\nrsgetXXXcolumnNames used 125 ms .\r\nsavepointJdbc30_JSR169 used 6594 ms .\r\ntestRelative used 94 ms .\r\nsavepointJdbc30_XA used 6516 ms \r\n----------------------\r\n      And after that, nothing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2009-03-17T18:59:55.105+0000","updated":"2009-03-17T18:59:55.105+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12697647","id":"12697647","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I hit this on the head of trunk  revision 758826 with some minor changes that shouldn't affect this.\r\n\r\njava version \"1.6.0\"\r\nJava(TM) SE Runtime Environment (build pwi3260sr3-20081106_07(SR3))\r\nIBM J9 VM (build 2.4, J2RE 1.6.0 IBM J9 2.4 Windows XP x86-32 jvmwi3260-20081105_25433 (JIT enabled, AOT enabled)\r\nJ9VM - 20081105_025433_lHdSMr\r\nJIT  - r9_20081031_1330\r\nGC   - 20081027_AB)\r\nJCL  - 20081106_01\r\n\r\nThe hang happened  after testDerby3799 used 0 ms\r\n\r\nAttempts to bring down network server to get my run going again also failed and I had to kill the run and start over.\r\n\r\nlast entry in the log had the tell tale error:\r\n2009-04-09 20:34:58.156 GMT : Could not listen on port 1527 on host 127.0.0.1:\r\n java.net.BindException: Address already in use: JVM_Bind\r\n\r\nAn exception was thrown during network server startup. DRDA_ListenPort.S:Could not listen on port 1527 on host 127.0.0.1:\r\n java.net.BindException: Address already in use: JVM_Bind\r\n\r\njava.lang.reflect.InvocationTargetException\r\n\r\n\tat sun.reflect.GeneratedMethodAccessor1950.invoke(Unknown Source)\r\n\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:37)\r\n\r\n\tat java.lang.reflect.Method.invoke(Method.java:599)\r\n\r\n\tat org.apache.derby.iapi.jdbc.DRDAServerStarter.run(DRDAServerStarter.java:236)\r\n\r\n\tat java.lang.Thread.run(Thread.java:735)\r\n\r\nCaused by: java.lang.Exception: DRDA_ListenPort.S:Could not listen on port 1527 on host 127.0.0.1:\r\n java.net.BindException: Address already in use: JVM_Bind\r\n\r\n\tat org.apache.derby.impl.drda.NetworkServerControlImpl.consolePropertyMessageWork(NetworkServerControlImpl.java:3179)\r\n\r\n\tat org.apache.derby.impl.drda.NetworkServerControlImpl.consolePropertyMessage(NetworkServerControlImpl.java:1861)\r\n\r\n\tat org.apache.derby.impl.drda.NetworkServerControlImpl.blockingStart(NetworkServerControlImpl.java:731)\r\n\r\n\t... 5 more\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-04-09T21:03:12.700+0000","updated":"2009-04-09T21:03:12.700+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12697995","id":"12697995","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I stumbled across a reliable reproduction for this issue when  trying to enable XATest (DERBY-4155).  To reproduce apply the patch derby-4053_repro_dont_commit_diff.txt and run jdbcapi._ShortSuite.\r\n\r\n_ShortSuite runs only XATest,DataSourceReferenceTest and J2EEDataSourceTest\r\nThe run gets an invalid reply failure on  testDataSourceReference during a ping and then the hang after testDerby3799.\r\n\r\nI ran with \r\njava version \"1.6.0\"\r\nJava(TM) SE Runtime Environment (build pwi3260sr3-20081106_07(SR3))\r\nIBM J9 VM (build 2.4, J2RE 1.6.0 IBM J9 2.4 Windows XP x86-32 jvmwi3260-20081105_25433 (JIT enabled, AOT enabled)\r\nJ9VM - 20081105_025433_lHdSMr\r\nJIT  - r9_20081031_1330\r\nGC   - 20081027_AB)\r\nJCL  - 20081106_01\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-04-10T21:55:45.991+0000","updated":"2009-04-10T22:14:51.619+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12697998","id":"12697998","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"It doesn't seem to reproduce with the sun jvm\r\njava version \"1.6.0_01\"\r\nJava(TM) SE Runtime Environment (build 1.6.0_01-b06)\r\nJava HotSpot(TM) Client VM (build 1.6.0_01-b06, mixed mode)\r\n\r\nI get neither the Invalid Reply, nor the hang.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-04-10T22:04:20.765+0000","updated":"2009-04-10T22:04:20.765+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12698543","id":"12698543","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"I tried that repro with the same 1.6 sr3 on my windows machine, sane classes, and sane jars, but it didn't  reproduce for me...\r\nclasspath (in case it matters) was: derby.jar;derbytools.jar;derbynet.jar;derbyclient.jar;derbyrun.jar;derbyTesting.jar;junit.jar\r\n(with appropriate paths to the various jars).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2009-04-13T20:34:52.886+0000","updated":"2009-04-13T20:34:52.886+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12700873","id":"12700873","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"body":"When testing client/server compatibility with 10.5.1.1.-rc2 and 10.4.2.0 I encountered what seems to be a reproduction of this issue. \r\nEnvironment: AMD Phenom II Quad Core CPU, 4GB Ram, Vista 64\r\n\r\njava version \"1.6.0_10\"\r\nJava(TM) SE Runtime Environment (build 1.6.0_10-b33)\r\nJava HotSpot(TM) Client VM (build 11.0-b15, mixed mode, sharing)\r\n\r\n\r\nClient - 10.4.2.0. Jars\r\n-------------------\r\nderbyTesting.jar\r\nderbyClient.jar\r\n\r\nServer - 10.5.1.1. Jars\r\n-------------------\r\nderby.jar\r\nderbynet.jar\r\nderbytools.jar\r\nderbyLocale*.jar\r\nderbyrun.jar\r\n\r\nXA40Test.testCallableStatementPoolable fails with the following exception. And then the suite hangs.\r\n-----------------------------------------------------------------------------------------------------\r\ntestPreparedStatementPoolable used 1 ms .\r\ntestCallableStatementPoolable used 2 ms java.lang.Exception: DRDA_InvalidReplyTooShort.S:Invalid reply from network server: Insufficient data.\r\n        at org.apache.derby.impl.drda.NetworkServerControlImpl.consolePropertyMessageWork(Unknown Source)\r\n        at org.apache.derby.impl.drda.NetworkServerControlImpl.consolePropertyMessage(Unknown Source)\r\n        at org.apache.derby.impl.drda.NetworkServerControlImpl.fillReplyBuffer(Unknown Source)\r\n        at org.apache.derby.impl.drda.NetworkServerControlImpl.readResult(Unknown Source)\r\n        at org.apache.derby.impl.drda.NetworkServerControlImpl.pingWithNoOpen(Unknown Source)\r\n        at org.apache.derby.impl.drda.NetworkServerControlImpl.ping(Unknown Source)\r\n        at org.apache.derby.drda.NetworkServerControl.ping(Unknown Source)\r\n        at org.apache.derbyTesting.junit.NetworkServerTestSetup.pingForServerUp(NetworkServerTestSetup.java:546)\r\n        at org.apache.derbyTesting.junit.NetworkServerTestSetup.pingForServerStart(NetworkServerTestSetup.java:615)\r\n        at org.apache.derbyTesting.junit.NetworkServerTestSetup.setUp(NetworkServerTestSetup.java:191)\r\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:20)\r\n        at junit.framework.TestResult.runProtected(TestResult.java:124)\r\n        at junit.extensions.TestSetup.run(TestSetup.java:25)\r\n        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\n        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)\r\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:21)\r\n        at junit.framework.TestResult.runProtected(TestResult.java:124)\r\n        at junit.extensions.TestSetup.run(TestSetup.java:25)\r\n        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)\r\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:21)\r\n        at junit.framework.TestResult.runProtected(TestResult.java:124)\r\n        at junit.extensions.TestSetup.run(TestSetup.java:25)\r\n        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\n        at junit.framework.TestSuite.runTest(TestSuite.java:230)\r\n        at junit.framework.TestSuite.run(TestSuite.java:225)\r\n        at junit.framework.TestSuite.runTest(TestSuite.java:230)\r\n        at junit.framework.TestSuite.run(TestSuite.java:225)\r\n        at junit.textui.TestRunner.doRun(TestRunner.java:121)\r\n        at junit.textui.TestRunner.start(TestRunner.java:185)\r\n        at junit.textui.TestRunner.main(TestRunner.java:143)\r\nF.\r\ntestCreateClob used 16 ms .\r\ntestCreateBlob used 9 ms .\r\ntestConnectionIsValid used 674 ms\r\n----------<hang>----------------------\r\n\r\n\r\n\r\nThe log shows the following\r\n--------------------------------------\r\n2009-04-20 16:41:07.264 GMT : Apache Derby Network Server - 10.5.1.1 - (764942) started and ready to accept connections on port 1527\r\n2009-04-20 16:41:10.618 GMT : Invalid reply from network server: Insufficient data.\r\n2009-04-20 16:41:10.618 GMT : Could not listen on port 1527 on host 127.0.0.1:\r\n java.net.BindException: Address already in use: JVM_Bind\r\n2009-04-20 16:41:12.416 GMT : Could not listen on port 1527 on host 127.0.0.1:\r\n java.net.BindException: Address already in use: JVM_Bind\r\n\r\n\r\nThis hang occurred both times I ran suites.All and also when I ran jdbc4._Suite alone , always on new test folders.\r\nIn the last instance, attempting to kill the hung test with\r\njava org.apache.derby.drda.NetworkServerControl shutdown\r\nalso hung.\r\n\r\n\r\nJavacore file attached.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"created":"2009-04-20T17:32:57.871+0000","updated":"2009-04-20T17:32:57.871+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12700877","id":"12700877","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"body":"javacore  for 10.4Client/10.5server compat testing hang. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"created":"2009-04-20T17:35:58.060+0000","updated":"2009-04-20T17:35:58.060+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12718953","id":"12718953","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"Looking at the javacore the tests are hung waiting on a ping:\r\n\"main\" prio=6 tid=0x003e9c00 nid=0x10ac runnable [0x0023f000..0x0023fe28]\r\n   java.lang.Thread.State: RUNNABLE\r\n        at java.net.SocketInputStream.socketRead0(Native Method)\r\n        at java.net.SocketInputStream.read(SocketInputStream.java:129)\r\n        at java.net.SocketInputStream.read(SocketInputStream.java:90)\r\n        at org.apache.derby.impl.drda.NetworkServerControlImpl.fillReplyBuffer(Unknown Source)\r\n        at org.apache.derby.impl.drda.NetworkServerControlImpl.readResult(Unknown Source)\r\n        at org.apache.derby.impl.drda.NetworkServerControlImpl.pingWithNoOpen(Unknown Source)\r\n        at org.apache.derby.impl.drda.NetworkServerControlImpl.ping(Unknown Source)\r\n        at org.apache.derby.drda.NetworkServerControl.ping(Unknown Source)\r\n        at org.apache.derbyTesting.junit.NetworkServerTestSetup.pingForServerUp(NetworkServerTestSetup.java:546)\r\n        at org.apache.derbyTesting.junit.NetworkServerTestSetup.pingForServerStart(NetworkServerTestSetup.java:615)\r\n        at org.apache.derbyTesting.junit.NetworkServerTestSetup.setUp(NetworkServerTestSetup.java:191)\r\n\r\n\r\nIf anyone can reproduce this it might be interesting to instrument pingForServerUp to\r\nsee what path it is taking through this code.  Did the while loop go more than once,\r\nwhat are all the variables to the routine, did it hit any of the try/catch blocks (some \r\ndon't do anything), ...\r\n\r\nIt seems like this setup code should be changed to not wait forever in the ping since\r\nthe tests seem to be able to break the network server and make it not ping.  So maybe some sort of timer thread could be used to make the ping not take forever.  \r\nIt would be best to understand why the ping is taking forever and maybe if we did\r\nnot hang then we could add more diagnostics to this routine to figure why the ping\r\nis not returning.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2009-06-12T19:46:21.306+0000","updated":"2009-06-12T19:46:21.306+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12719001","id":"12719001","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"My gut instinct is that this is some sort of shutdown timing problem with all the server side cleanup that starts about line 807 in NetworkServerControlImpl or perhaps a problem with bring it up in the first place.   The key thing  I notice is there is no ClientThread running which normally accepts new requests, but it does not seem the server socket was closed because there is one DRDAConnThread that is blocked on a read and one ping thread blocked on read that would terminate if the server.socket were closed.\r\n\r\nIt would be interesting to trace when this occurs.\r\n1) calls to shutdown and start\r\n2) Entry into the for (;;)  loop in ClientThread\r\n3) returns out of the ClientThread loop\r\n4)     Remove the if(!parent.getShudown()) in this code so we always print the IOException if it occurs. Perhaps there is an exception we are not seeing.\r\n if (!parent.getShutdown()) {\r\n                            parent.consoleExceptionPrintTrace(ioe);\r\n                            if (clientSocket != null)\r\n                                clientSocket.close();\r\n                        }\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-06-12T22:18:47.811+0000","updated":"2009-06-12T22:18:47.811+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12721062","id":"12721062","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I noticed this happened on the IBM 10.4 run last night and  had the DRDA_InvalidReplyTooShort.S:Invalid reply from network server: Insufficient data trace on a ping shortly before the hang.  I looked briefly at how this might occur, that a ping would return insufficient data.\r\n\r\nA ping would go through this code in DRDAConnThread:\r\nprivate void sessionInitialState()\r\n\t\tthrows Exception\r\n\t{\r\n\t\t// process NetworkServerControl commands - if it is not either valid protocol  let the \r\n\t\t// DRDA error handling handle it\r\n\t\tif (reader.isCmd())\r\n\t\t{\r\n\t\t\ttry {\r\n\t\t\t\tserver.processCommands(reader, writer, session);\r\n\t\t\t\t// reset reader and writer\r\n\t\t\t\treader.initialize(this, null);\r\n\t\t\t\twriter.reset(null);\r\n\t\t\t\tcloseSession();\r\n\t\t\t} catch (Throwable t) {\r\n\t\t\t\tif (t instanceof InterruptedException)\r\n\t\t\t\t\tthrow (InterruptedException)t;\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tserver.consoleExceptionPrintTrace(t);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\nIn NetworkServerControlImpl during shutdown we do the following which might interrupt  the thread:\r\n\tsynchronized (threadList)\r\n\t\t{\r\n \t\t\t//interupt any connection threads still active\r\n \t\t\tfor (int i = 0; i < threadList.size(); i++)\r\n \t\t\t{\r\n\t\t\t\tfinal DRDAConnThread threadi = (DRDAConnThread)threadList.get(i);\r\n                \r\n \t\t\t\tthreadi.close();\r\n\t\t\t\tAccessController.doPrivileged(\r\n\t\t\t\t\t\t\tnew PrivilegedAction() {\r\n\t\t\t\t\t\t\t\tpublic Object run() {\r\n\t\t\t\t\t\t\t\t\tthreadi.interrupt();\r\n\t\t\t\t\t\t\t\t\treturn null;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t});\r\n \t\t\t}\r\n \t\t\tthreadList.clear();\r\n\t\t}\r\n\r\nIt seems a kind of abrupt way to shutdown the threads. Would calling threadi() close()  be more appropriate so it could finish what it was doing?  I am also unclear about the state of the cleanup when such an interrupt occurs during the middle of writing a response.\r\n\r\nTomorrow I will try putting a sleep between the reply header and the OK byte on the ping response and try to shutdown at the same time  to  see if I can get the InvalidReplyTooShort and then see if subsequent connection attempts hang.\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-06-18T04:51:39.302+0000","updated":"2009-06-18T04:51:39.302+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12725630","id":"12725630","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Based on Kathey's suggestion, I tried putting sleep in the Network Server code right in the middle of ping protocol handshake.\r\n\r\nFollowing is what happens for ping on the server side (in NetworkServerControlImpl)\r\nprivate void sendOK(DDMWriter writer) throws Exception \r\n{ \r\n      writeCommandReplyHeader(writer); \r\n      writer.writeByte(OK); \r\n      writer.flush(); \r\n} \r\nI have copied the sendOK code inline where the ping is handled in NetworkServerControlImpl.processCommands(). Additionally, I changed that copied code to have the server sleep after writing the header but before sending the ok to the ping client as shown below.\r\n      writeCommandReplyHeader(writer);\r\n      writer.flush();\r\n      System.out.println(\"before going to sleep\");\r\n      Thread.sleep(10000);\r\n      System.out.println(\"after sleep\");\r\n      writer.writeByte(OK);\r\n      System.out.println(\"after sending OK\");\r\n      writer.flush();\r\n      System.out.println(\"after flushing OK\");\r\nWith the code changes above, I thought I would be able to reproduce the bug if I tried shutting down server while the server was still sleeping during ping handshake (ie before the ping protocol handshake is all finished). What I found was that the server shutdown properly, ping client got expected Invalid reply from network server: Insufficient data. We thought that if we tried bringing the server back up and tried ping on the new server session, it will hang because of the earlier insufficient data but that didn't happen. A hang here would have probably duplicated the intermittent hang behavior that we see when the nightly tests are running.\r\n\r\nLittle more info on exact steps for the test case above\r\nWindow 1 : Start the server\r\n\tjava org.apache.derby.drda.NetworkServerControl -noSecurityManager start -p 1639\r\nWindow 2 : ping the server (this put the server in the sleep mode)\r\n\tjava org.apache.derby.drda.NetworkServerControl ping -p 1639\r\nWindow 3: while server is sleeping, send shutdown request\r\n\tjava org.apache.derby.drda.NetworkServerControl shutdown -p 1639\r\n\r\nAfter spending more time on the experiment above, found that the ping client was getting\r\ninsufficient data because of the \"writer.flush()\" which I added right before \r\nThread.sleep(...). This happened both with Sun and IBM jvms(1.6 versions). once I took the \r\nadditional writer.flush() out, the ping client ran successfully and there was no insufficient\r\ndata error.\r\n\r\nThe goal here is to get a consistently (small) reproducible test case which will make debugging the problem easier but have not been to cause the ping to run into insufficient data in a small repro yet. Will brainstorm more but in the meantime, if anyone has any ideas\r\non what may be causing the insufficient data error, I can pursue those.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-06-30T13:59:13.963+0000","updated":"2009-06-30T13:59:13.963+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12726172","id":"12726172","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Wanted to post some progress on this issue\r\n1)First of all, I don't need to run the entire suite anymore to run into hang problem. Just running the jdbc4 suite is enough to repro the problem. that is saving tons of time with reproducing the bug on my machine when running with 10.5 server jars and 10.4 client jars\r\n2)jdbc4 suite is consistently hanging in jdbc4.ConnectionMethodsTest\r\n3)The problem is not really with the test that is hung, rather it is the previous test jdbc4.UnsupportedVetter\r\n4)After lonts and lots of printlns in the network server code, it appears the problem might be that XA connections may not be cleaning up properly and hence the server can't shutdown successfully. But ofcourse as this jira shows, we do not handle that case properly. This leads into server not getting shutdown when the junit test is expecting it to be shutdown. The next test when it tries to bring the server up can't do that successfully.\r\n\r\nThe next step is to come up with a XA test case to repro the improper cleanup of XA connection.\r\n\r\nFollowing is the stack trace that I have added into my codeline showing XA connection not closing properly\r\n\r\njava.sql.SQLException: Cannot close a connection while a transaction is still active.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:95)\r\n        at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:87)\r\n        at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:103)\r\n        at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Util.java:167)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.newSQLExceptionEmbedConnection.java:2948)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.checkForTransactionInProgress(EmbedConnection.java:1806)\r\n        at org.apache.derby.jdbc.EmbedPooledConnection.checkCloseEmbedPooledConnection.java:459)\r\n        at org.apache.derby.jdbc.EmbedXAConnection.checkCloseEmbedXAConnection.java:152)\r\n        at org.apache.derby.iapi.jdbc.BrokeredConnection.close(BrokeredConnection.java:169)\r\n        at org.apache.derby.impl.drda.Database.close(Database.java:362)\r\n        at org.apache.derby.impl.drda.Session.close(Session.java:115)\r\n        at org.apache.derby.impl.drda.NetworkServerControlImpl.blockingStart(NetworkServerControlImpl.java:838)\r\n        at sun.reflect.GeneratedMethodAccessor28.invoke(Unknown Source)\r\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:37)\r\n        at java.lang.reflect.Method.invoke(Method.java:599)\r\n        at org.apache.derby.iapi.jdbc.DRDAServerStarter.run(DRDAServerStarter.java:236)\r\n        at java.lang.Thread.run(Thread.java:735)\r\nCaused by: java.sql.SQLException: Cannot close a connection while a transaction is still active.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory40.java:119)\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:73)\r\n        ... 16 more","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-01T18:34:35.635+0000","updated":"2009-07-01T18:34:35.635+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12726225","id":"12726225","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"With the DERBY-3319 fix I think this is much more likely to occur at a user site.  Marking Urgent to try to get it into the 10.5.2 release.\r\n\r\nI actually would have thought this would be a regression associated with 10.5 after DERBY-3319, but Myrna has reported the problem on 10.4 as well.  If it is a regression, it should probably move to BLOCKER.\r\nThank you Mamta for tracking down this issue.\r\n\r\nI see three  parts to the fix:\r\n1) Do a better job of cleaning up XA Connections.  For local transactions we can rollback, but we need to be more careful to do the right thing if a global transaction is in progress.  We cannot simply rollback a prepared transaction.\r\n\r\n2) Make sure an exception during shutdown processing does not prevent the remaining shutdown tasks, like closing the server socket from occurring.\r\n\r\n3) Make sure any exceptions that occur in shutdown processing are reported to the console.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-01T20:56:27.469+0000","updated":"2009-07-01T20:56:27.469+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12726251","id":"12726251","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Taking this from memory... I thought XA wasn't supposed to be affected by DERBY-3319. See my comment dated 07/Jul/08 01:57 AM on that issue. Or perhaps it was just global XA transactions that weren't affected by it. Will have to check later.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-07-01T22:41:00.201+0000","updated":"2009-07-01T22:41:00.201+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12726413","id":"12726413","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I checked the code, and connections associated with a global XA transaction can still be closed without being committed or rolled back first. Local XA connections will fail if they are attempted closed while they have uncommitted operations.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-07-02T09:51:34.663+0000","updated":"2009-07-02T09:51:34.663+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12726437","id":"12726437","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"This code in impl.drda.Database.close() probably needs to be changed to check if the connection is a global XA transaction, and not only that it's XA:\r\n\r\n\t\t\tif ((conn != null) && !conn.isClosed())\r\n\t\t\t{\r\n\t\t\t\tif (! forXA)\r\n\t\t\t\t{\r\n\t\t\t\t\tconn.rollback();\r\n\t\t\t\t}\r\n\t\t\t\tconn.close();\t\t\t\t\t\r\n\t\t\t}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-07-02T11:30:53.641+0000","updated":"2009-07-02T11:30:53.641+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12727536","id":"12727536","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I think that sounds fine for item #1 in my list above. Perhaps we need a new method in the EngineConnection interface (inLocalTransaction()) to determine the transaction state?  Then we also need to take care of the other two items I listed above so we don't have problems in the future with errors in shutdown causing this kind of difficult to track down problem.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-06T14:00:27.856+0000","updated":"2009-07-06T14:00:27.856+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12728768","id":"12728768","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Changing to blocker urgency for 10.5.2 at least for the XA hang. The other parts of the fix (proper handling of all exceptions that occur on shutdown and log to console when they occur) could be handled post 10.5.2 with a follow-up issue.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-08T16:30:39.525+0000","updated":"2009-07-08T16:30:39.525+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729074","id":"12729074","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I'll try to fix the XA hang along the lines suggested above.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-07-09T06:54:37.302+0000","updated":"2009-07-09T06:54:37.302+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729079","id":"12729079","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Oops. Just noticed that Kathey had sent a mail to derby-dev asking Mamta to fix this. Unassigning so that I don't block the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-07-09T07:22:33.953+0000","updated":"2009-07-09T07:22:33.953+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729297","id":"12729297","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"This patch DERBY4053_patch1_diff_July092009.txt is not yet intended for checkin. \r\n\r\nI thought this patch should fix the XA cleanup issue where we were not differentiating between global XA vs local XA transaction and hence not roling back local XA transaction before trying to close the connection. \r\n\r\nUnless my code changes are wrong, it appears though that all the XA tests in jdbc4 suite are non-global XA transactions. Is that right? The reason I ask is, I had printlns in all the implementations of the new method isInGlobalTransaction and they all always return false. I was expecting following method in EmbedXAConnection.java to return true sometimes because we are dealing with global XA transaction.\r\nIndex: java/engine/org/apache/derby/jdbc/EmbedXAConnection.java\r\n===================================================================\r\n--- java/engine/org/apache/derby/jdbc/EmbedXAConnection.java    (revision 792143\r\n)\r\n+++ java/engine/org/apache/derby/jdbc/EmbedXAConnection.java    (working copy)\r\n@@ -22,6 +22,7 @@\r\n package org.apache.derby.jdbc;\r\n\r\n import org.apache.derby.impl.jdbc.Util;\r\n+import org.apache.derby.iapi.jdbc.BrokeredConnectionControl;\r\n import org.apache.derby.iapi.jdbc.EngineConnection;\r\n import org.apache.derby.iapi.jdbc.ResourceAdapter;\r\n\r\n@@ -53,6 +54,11 @@\r\n                 xaRes = new EmbedXAResource (this, ra);\r\n        }\r\n\r\n+    /** @see BrokeredConnectionControl#isInGlobalTransaction() */\r\n+    public boolean isInGlobalTransaction() {\r\n+       return isGlobal();\r\n+    }\r\n+\r\n     /**\r\n      * Check if this connection is part of a global XA transaction.\r\n      *\r\nCan someone review this patch for me? There are not many comments yet. I will put those soon.\r\n\r\nI am right now also trying to work on a standalone repro case  which will reproduce our theory of local XA transaction not getting rolled back before connection.close and hence the server shutdown does not happen correctly causing next server start to hang. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-09T15:35:02.241+0000","updated":"2009-07-09T15:35:02.241+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729312","id":"12729312","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Hi Mamta,\r\n\r\nI took a look at DERBY4053_patch1_diff_July092009.txt.  On visual inspection it seems like it should do what we want.\r\nThere is an import of BrokeredConnectionControl in EmbedConnection which should be removed.  \r\n\r\nIn your mail to derby-dev, you said \"Despite the\r\nchange, I still get the hang. \"  Do you still get the InvalidReply? If you put the try/catch block around the shutdown operations, do you still see an exception?\r\n\r\nI did some grepping on the tests in jdbc4 and I think you are right that they only use local transactions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-09T16:20:41.289+0000","updated":"2009-07-09T16:20:41.289+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729330","id":"12729330","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Sorry, I wasn't completely awake when i posted on derby-dev that \"Despite the change, I still get the hang\". With my changes, I do not see the hang in jdbc4 suite.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-09T17:08:01.188+0000","updated":"2009-07-09T17:08:01.188+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729334","id":"12729334","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Ahh, good news.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-09T17:15:30.252+0000","updated":"2009-07-09T17:15:30.252+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729427","id":"12729427","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I have a standalone repro of the problem which demonstrates the problem with local XA transaction. I am copying the comments from the program to descibe what it is doing. Next, I will add a test like this in our regression suite and put more comments in the Derby code changes.\r\n\r\n/**\r\n * This test does following \r\n * 1)Start the network server\r\n * 2)Start a local xa transaction\r\n * 3)Do not commit the local XA transaction\r\n * 4)Shutdown the network server\r\n * 5)Start the server again\r\n * \r\n * Before the fix for DERBY-4053 went in, step 4) would not shutdown the\r\n * server properly because of the pending local XA transaction. During the\r\n * server shutdown, we try to close all the open connections and close on\r\n * the XA connection results into an exception because there is still a\r\n * pending transaction. That exception is not handled by the server and\r\n * because of that, all the code necessary to shutdown the server is not\r\n * executed. The next time around, step 5), when we try to bring up the\r\n * server again, it ends up hanging \r\n * 2009-07-09 21:21:28.828 GMT : Invalid reply from network server: Insufficient data.\r\n * 2009-07-09 21:21:28.843 GMT : Could not listen on port 1527 on host 127.0.0.1: java.net.BindException: Address already in use: JVM_Bind\r\n * \r\n * The patch attached to the jira makes sure that before calling close on\r\n * local XA transaction, we first rollback any transaction active on the\r\n * connection. We should also work on server shutdown code to handle the\r\n * exceptions better so that it does not stop half way.\r\n * \r\n */\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-09T21:54:15.900+0000","updated":"2009-07-09T21:56:52.104+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729428","id":"12729428","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Recopying the standalone repro with correct name this time around.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-09T21:59:19.662+0000","updated":"2009-07-09T21:59:19.662+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729731","id":"12729731","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Attaching the patch DERBY4053_patch2_diff_July102009.txt which is ready for commit. I have added a new test which will not hang anymore because of the pending local XA transaction. If there are no comments on the patch, I will plan on committing it early next week. I will also go ahead and enter new jira entry for doing a better job of handling the exception during server shutdown.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-10T17:23:13.286+0000","updated":"2009-07-10T17:23:13.286+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729738","id":"12729738","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thank you Mamta for your continued work on this issue. I didn't apply the patch but just looked at the diff and have the following comments. In EmbedConnection we have:\r\nimport org.apache.derby.iapi.jdbc.BrokeredConnectionControl;\r\nwhich I don't think is needed.\r\n\r\nand a small typo in the test \"why\" instead of \"while\"\r\nbring the server down why the local xa transaction is still active\r\n\r\nI wonder if it would be cleaner instead of:\r\nClientXADataSource ds = new ClientXADataSource();\r\n+        ds.setPortNumber(TestConfiguration.getCurrent().getPort());\r\n+    \tds.setDatabaseName(\"wombat\");\r\n+    \tds.setCreateDatabase(\"create\");\r\n\r\nto use J2EEDataSource.getXADataSource()\r\n\r\nDo you think you can check this into 10.5 on  Monday so we get a nightly run before I make the RC on Tuesday?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-10T17:34:26.517+0000","updated":"2009-07-10T17:34:26.517+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729749","id":"12729749","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Thanks for looking at the patch, Kathey. I will work on your comments and go ahead and commit the patch. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-10T18:08:56.532+0000","updated":"2009-07-10T18:08:56.532+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729790","id":"12729790","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Mamta, could you also run jdbcapi.XATest with your patch. It hasn't been enabled (DERBY-4155) because it sometimes hung when run in a suite because of this issue.   You will need to sync up to run it because I just checked in a fix to the test to make it run cleanly.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-10T19:41:11.388+0000","updated":"2009-07-10T19:41:11.388+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729806","id":"12729806","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Kathey, when I ran the XATest, it failed\r\n$ java junit.textui.TestRunner org.apache.derbyTesting.functionTests.tests.jdbcapi.XATest\r\n.....EE\r\nTime: 10.031\r\nThere were 2 errors:\r\n1) XATest:embeddedjava.sql.SQLException: The conglomerate (-1) requested does not exist.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:95)\r\n        at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Util.java:201)\r\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:391)\r\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:346)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2201)\r\n        at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:81)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1323)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:625)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.executeUpdate(EmbedStatement.java:175)\r\n        at org.apache.derbyTesting.junit.JDBC.dropSchema(JDBC.java:323)\r\n        at org.apache.derbyTesting.junit.CleanDatabaseTestSetup.removeObjects(CleanDatabaseTestSetup.java:231)\r\n        at org.apache.derbyTesting.junit.CleanDatabaseTestSetup.cleanDatabase(CleanDatabaseTestSetup.java:164)\r\n        at org.apache.derbyTesting.junit.CleanDatabaseTestSetup.tearDown(CleanDatabaseTestSetup.java:151)\r\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:20)\r\n        at junit.extensions.TestSetup.run(TestSetup.java:23)\r\n        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\nCaused by: java.sql.SQLException: The conglomerate (-1) requested does not exist.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory40.java:119)\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:70)\r\n        ... 21 more\r\nCaused by: ERROR XSAI2: The conglomerate (-1) requested does not exist.\r\n        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:286)\r\n        at org.apache.derby.impl.store.access.RAMTransaction.findExistingConglomerate(RAMTransaction.java:399)\r\n        at org.apache.derby.impl.store.access.RAMTransaction.openConglomerate(RAMTransaction.java:1308)\r\n        at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.isSchemaReferenced(DataDictionaryImpl.java:2310)\r\n        at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.isSchemaEmpty(DataDictionaryImpl.java:2245)\r\n        at org.apache.derby.iapi.sql.dictionary.SchemaDescriptor.drop(SchemaDescriptor.java:419)\r\n        at org.apache.derby.impl.sql.execute.DropSchemaConstantAction.executeConstantAction(DropSchemaConstantAction.java:99)\r\n        at org.apache.derby.impl.sql.execute.MiscResultSet.open(MiscResultSet.java:64)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:416)\r\n        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:297)\r\n        at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1235)\r\n        ... 15 more\r\n2) XATest:clientjava.sql.SQLException: The conglomerate (-1) requested does notexist.\r\n        at org.apache.derby.client.am.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:96)\r\n        at org.apache.derby.client.am.SqlException.getSQLException(SqlException.java:358)\r\n        at org.apache.derby.client.am.Statement.executeUpdate(Statement.java:509)\r\n        at org.apache.derbyTesting.junit.JDBC.dropSchema(JDBC.java:323)\r\n        at org.apache.derbyTesting.junit.CleanDatabaseTestSetup.removeObjects(CleanDatabaseTestSetup.java:231)\r\n        at org.apache.derbyTesting.junit.CleanDatabaseTestSetup.cleanDatabase(CleanDatabaseTestSetup.java:164)\r\n        at org.apache.derbyTesting.junit.CleanDatabaseTestSetup.setUp(CleanDatabaseTestSetup.java:109)\r\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:18)\r\n        at junit.extensions.TestSetup.run(TestSetup.java:23)\r\n        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\n        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)\r\n        at junit.extensions.TestSetup.run(TestSetup.java:23)\r\n        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\n        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)\r\n        at junit.extensions.TestSetup.run(TestSetup.java:23)\r\nCaused by: org.apache.derby.client.am.SqlException: The conglomerate (-1) requested does not exist.\r\n        at org.apache.derby.client.am.Statement.completeSqlca(Statement.java:1833)\r\n        at org.apache.derby.client.am.Statement.completeExecuteImmediate(Statement.java:1421)\r\n        at org.apache.derby.client.net.NetStatementReply.parseEXCSQLIMMreply(NetStatementReply.java:208)\r\n        at org.apache.derby.client.net.NetStatementReply.readExecuteImmediate(NetStatementReply.java:59)\r\n        at org.apache.derby.client.net.StatementReply.readExecuteImmediate(StatementReply.java:45)\r\n        at org.apache.derby.client.net.NetStatement.readExecuteImmediate_(NetStatement.java:128)\r\n        at org.apache.derby.client.am.Statement.readExecuteImmediate(Statement.java:1417)\r\n        at org.apache.derby.client.am.Statement.flowExecute(Statement.java:2120)\r\n        at org.apache.derby.client.am.Statement.executeUpdateX(Statement.java:514)\r\n        at org.apache.derby.client.am.Statement.executeUpdate(Statement.java:500)\r\n        ... 22 more\r\n\r\nFAILURES!!!\r\nTests run: 5,  Failures: 0,  Errors: 2\r\n\r\n$\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-10T20:40:21.597+0000","updated":"2009-07-10T20:40:21.597+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729853","id":"12729853","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Strange, but I am not able to reproduce the conglomerate does not exist error any more. Not sure why i got it. I cleaned up the test dir and reran the tests and XATest runs fine after that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-10T21:50:52.064+0000","updated":"2009-07-10T21:50:52.064+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729854","id":"12729854","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Posting an updated patch DERBY4053_patch3_diff_July102009.txt. It has changes suggested by Kathey on the previous patch. I will run the entire junit suite and derbyall. This is on trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-10T21:52:03.217+0000","updated":"2009-07-10T21:52:03.217+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12729857","id":"12729857","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Hi Mamta,\r\n\r\nShort story is I don't think this is because of your change and if you start with a clean directory the test should pass.\r\n\r\nI think maybe you got this because you did not clean up your test  directory after synching up the DERBY-712 changes.  If I create a schema with the 10.6.0.0.791528 build (before DERBY-712)  and then try to drop it with a build after the change I get the same error.\r\nij> drop schema myschema restrict;\r\nERROR XSAI2: The conglomerate (-1) requested does not exist.\r\n\r\nI think this is to be expected. Suran could you confirm that all 10.6 databases made before the DERBY-712 patch are expected to be unusable?\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-10T21:58:29.784+0000","updated":"2009-07-10T21:58:29.784+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730018","id":"12730018","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for doing this, Mamta. Patch #3 looks fine to me, except some nits like mixing tabs and spaces on the same line and trailing blanks. It would also be good if the comment in Database.close() explained why and not only what the code does. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-07-11T21:49:53.963+0000","updated":"2009-07-11T21:49:53.963+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730093","id":"12730093","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"body":"With reference to \r\nhttp://issues.apache.org/jira/browse/DERBY-712?focusedCommentId=12728739&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12728739\r\nI think it's safe to say 1.6 databases from before the DERBY-712 changes will now be unusable.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suranjay","name":"suranjay","emailAddress":"suranjay at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suran Jayathilaka","active":true},"created":"2009-07-12T15:02:18.337+0000","updated":"2009-07-12T15:02:18.337+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730126","id":"12730126","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Knut, thanks for looking at the patch. I will add comments to Database.close() for the code changes that I have made. As for mixing tabs and spaces, maybe someone can help me with that. I am using eclipse and it must be adding the tabs automatically because when I start a new codeline, it puts me automatically on what appears to be right place on that line to right the code. Maybe I need to change some settings. \r\n\r\nAlso, I ran derball and junit and they all ran fine. After adding the comments, I will go ahead and check in the changes into trunk and then work on merging it to 10.5 codeline.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-12T18:25:10.842+0000","updated":"2009-07-12T18:25:10.842+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730352","id":"12730352","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Committed changes to trunk with revision 793588 and with commit comments\r\n**************\r\nDERBY-4053 The local XA connections were not getting rollback during Database close and\r\nthis resulted into exception at connection close if the connection object had any pending\r\ntransaction. Made changes so that all the connections(except global XA connections) will \r\nhave their transactions rolled back before those connections are closed.\r\n**************\r\n\r\nAlso, I think have taken care of space and tab mixing. Will work on migrating this to 10.5","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-13T13:58:04.189+0000","updated":"2009-07-13T13:58:04.189+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730428","id":"12730428","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Mamta for the fix.  I still can't quite figure why this would occur on 10.4.   DERBY-3319 wasn't fixed there. Does anyone have any theories?  Perhaps the 10.4 issue is some other problem during shutdown that will be exposed/resolved once we properly handle and log exceptions during shutdown.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-13T17:56:15.402+0000","updated":"2009-07-13T17:56:15.402+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730443","id":"12730443","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Created DERBY-4304 for \r\n1) Make sure an exception during shutdown processing does not prevent the remaining shutdown tasks, like closing the server socket from occurring. \r\n2) Make sure any exceptions that occur in shutdown processing are reported to the console. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-13T18:17:14.406+0000","updated":"2009-07-13T18:17:14.406+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730505","id":"12730505","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"This is my second time running junit suite on 10.5 codeline after merging the changes into 10.5 and both times I am running into problems with upgrade tests. Not sure if there is a known issue with running upgrade tests on 10.5.  I see quite a different errors. Wish had run the junit tests in text runner rather than gui runner. But here are couple failures\r\ntestOldVersion:Old minor(driver): expected<1> but was <5>\r\ntestGrantRevokeStatements(...Changes10_2)Unexpected SQL state expected <..X01> but was <..Z60>\r\ntestDatabaseOwnerChange(..10_3)AUTHORIZATIONID not valid for SYSIBM expected:<DBA> but was <APP>\r\n....\r\n\r\nDoes anyone have the cycle to merge my trunk patch to 10.5 codeline and see if the tests run fine on their machine?\r\n\r\nIn the meantime, I will run the derbyall on merged 10.5 and see how that goes","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-13T20:44:20.372+0000","updated":"2009-07-13T20:44:20.372+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730541","id":"12730541","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Hi Mamta, I have a test run going now but will test your patch as soon as that is done.  I have never seen these failures before but I don't think upgrade tests run for network server at all so think probably this is not related to your change.  I'll let you know how my run goes.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-13T21:54:59.958+0000","updated":"2009-07-13T21:54:59.958+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730564","id":"12730564","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"derbyall ran fine out my machine with intermittent failure (I had seen this failure on trunk too. forgot to mention it)\r\n********* Diff file derbyall/storeall/storeunit/T_RawStoreFactory.diff\r\n*** Start: T_RawStoreFactory jdk1.6.0 storeall:storeunit 2009-07-13 14:34:14 ***\r\n2 del\r\n< -- Unit Test T_RawStoreFactory finished\r\n2 add\r\n> Shutting down due to unit test failure.\r\nTest Failed.\r\n*** End:   T_RawStoreFactory jdk1.6.0 storeall:storeunit 2009-07-13 14:34:31 ***\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-13T22:38:52.138+0000","updated":"2009-07-13T22:38:52.138+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730573","id":"12730573","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"That's like DERBY-2635 (which is closed)...But I think it's important to check on derby.log with this test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2009-07-13T22:55:03.111+0000","updated":"2009-07-13T22:55:03.111+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730575","id":"12730575","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"or DERBY-3993 I have seen the test fail with the signature you describe but it has the observers error in derby.log.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-13T23:02:21.632+0000","updated":"2009-07-13T23:02:21.632+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730586","id":"12730586","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I looked through derby.log and see that it has observers error in derby.log\r\n[main] FAIL - org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED There should be 0 observers, but we still have 1 observers.\r\norg.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED There should be 0 observers, but we still have 1 observers.\r\n\tat org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:162)\r\n\tat org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:147)\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.doComplete(Xact.java:1969)\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.preComplete(Xact.java:1925)\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.prepareCommit(Xact.java:769)\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.commit(Xact.java:882)\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.commit(Xact.java:679)\r\n\tat org.apache.derbyTesting.unitTests.store.T_Util.t_commit(T_Util.java:840)\r\n\tat org.apache.derbyTesting.unitTests.store.T_RawStoreFactory.TC001(T_RawStoreFactory.java:7310)\r\n\tat org.apache.derbyTesting.unitTests.store.T_RawStoreFactory.runTempTests(T_RawStoreFactory.java:417)\r\n\tat org.apache.derbyTesting.unitTests.store.T_RawStoreFactory.runTestSet(T_RawStoreFactory.java:248)\r\n\tat org.apache.derbyTesting.unitTests.harness.T_MultiIterations.runTests(T_MultiIterations.java:95)\r\n\tat org.apache.derbyTesting.unitTests.harness.T_MultiThreadedIterations.runTests(T_MultiThreadedIterations.java:92)\r\n\tat org.apache.derbyTesting.unitTests.harness.T_Generic.Execute(T_Generic.java:118)\r\n\tat org.apache.derbyTesting.unitTests.harness.BasicUnitTestManager.runATest(BasicUnitTestManager.java:184)\r\n\tat org.apache.derbyTesting.unitTests.harness.BasicUnitTestManager.runTests(BasicUnitTestManager.java:246)\r\n\tat org.apache.derbyTesting.unitTests.harness.BasicUnitTestManager.boot(BasicUnitTestManager.java:93)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.boot(BaseMonitor.java:2021)\r\n\tat org.apache.derby.impl.services.monitor.TopService.bootModule(TopService.java:333)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.bootService(BaseMonitor.java:1858)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.startServices(BaseMonitor.java:997)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.runWithState(BaseMonitor.java:429)\r\n\tat org.apache.derby.impl.services.monitor.FileMonitor.<init>(FileMonitor.java:60)\r\n\tat org.apache.derby.iapi.services.monitor.Monitor.startMonitor(Monitor.java:289)\r\n\tat org.apache.derbyTesting.unitTests.harness.UnitTestMain.main(UnitTestMain.java:51)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-13T23:23:32.910+0000","updated":"2009-07-13T23:23:32.910+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730654","id":"12730654","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Hi Mamta,\r\n\r\nI got no failures on 10.5 with suites.All after merging this change to the branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-14T02:39:41.490+0000","updated":"2009-07-14T02:39:41.490+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730839","id":"12730839","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Thanks for running the tests, Kathey. Appreciate it. Will go ahead and commit the changes into 10.5","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-14T13:38:11.155+0000","updated":"2009-07-14T13:38:11.155+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730842","id":"12730842","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Migrated into 10.5 with revision 793900.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-07-14T13:41:48.216+0000","updated":"2009-07-14T13:41:48.216+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12730941","id":"12730941","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Bad news: On trunk, I updated to get Mamta's change and ran tests with 2 other changes. First I applied Tiago's patch for DERBY-4292.  Second I tried to enable XATest.   I ran suites.All and hit DERBY-4053.  I think it was the addition of XATest that did it, not Tiago's change because the initial InvalidReply came during XATest.  I will catch and print any exception in shutdown and rerun and hopefully will hit it again and we can see what the issue is now that local transactions are rolling back.\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-14T16:18:35.451+0000","updated":"2009-07-14T16:18:35.451+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12731047","id":"12731047","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Tiago offered to try to reproduce as well.   Attached is the patch that prints out any exceptions during shutdown. This is not for commit.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-14T18:54:03.958+0000","updated":"2009-07-14T18:54:03.958+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12731152","id":"12731152","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"With the diag patch, XATest, and the change to check unordered results for checkXATransactionView, and running jdbcapi._Suite  I can reproduce the error on shutdown described here: https://issues.apache.org/jira/browse/DERBY-4155?focusedCommentId=12731086&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12731086\r\n\r\nfollowed later by an InvalidReply and the hang with bind exception in the derby.log\r\n \r\n\r\n\r\nI also see the following issue shutting down  which does not cause problems restarting the server because the JMX cleanup comes after serverSocket.close()\r\ntestSystemShutdown used 406 ms java.lang.NullPointerException\r\n        at org.apache.derby.impl.services.jmx.JMXManagementService.unregisterMBean(JMXManagementService.java:286)\r\n        at org.apache.derby.impl.services.jmx.JMXManagementService.unregisterMBean(JMXManagementService.java:277)\r\n        at org.apache.derby.impl.drda.NetworkServerControlImpl.blockingStart(NetworkServerControlImpl.java:864)\r\n        at sun.reflect.GeneratedMethodAccessor596.invoke(Unknown Source)\r\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:37)\r\n        at java.lang.reflect.Method.invoke(Method.java:599)\r\n        at org.apache.derby.iapi.jdbc.DRDAServerStarter.run(DRDAServerStarter.java:236)\r\n        at java.lang.Thread.run(Thread.java:735)\r\n.\r\ntestPoolDS used 5234 ms .\r\n\r\n\r\nIn general ur failure to report and handle errors on shutdown has been masking other issues.\r\n\r\nI think we should proceed as follows:\r\n1) Change the title of DERBY-4053 to: Network Server does not rollback local transactions on XAConnections  on shutdown causing hang on restart with message java.net.BindException: Address already in use: NET_Bind in derby.log \r\n\r\n2) File two new issues described above.\r\n\r\n3)Continue work on DERBY-4304 to expose additonal issues and eliminate the bind error on other circumstances.\r\n \r\n4) Add the unordered result set check as part of the DERBY-4155\r\n\r\n\r\nI don't think these tasks should hold up 10.5.2\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-14T21:58:32.716+0000","updated":"2009-07-14T21:58:32.716+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12731580","id":"12731580","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Verified fix in 10.5 and trunk. There were other issues on shutdown identified that may cause a similar symptom, but those will be logged separately.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-07-15T17:36:22.684+0000","updated":"2009-07-15T17:36:22.684+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414620/comment/12749632","id":"12749632","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Backported chages to 10.4 and 10.3 codelines","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2009-08-31T21:31:33.273+0000","updated":"2009-08-31T21:31:33.273+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4053/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06xaf:"}}
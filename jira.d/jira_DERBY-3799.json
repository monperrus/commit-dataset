{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12401011","self":"https://issues.apache.org/jira/rest/api/latest/issue/12401011","key":"DERBY-3799","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313345","id":"12313345","description":"","name":"10.4.2.0","archived":false,"released":true,"releaseDate":"2008-09-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2008-07-25 15:01:37.496","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23849","customfield_12310222":"3_*:*_1_*:*_345809051_*|*_1_*:*_1_*:*_259255938_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_196983627","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-08-01T14:00:15.194+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3799/watchers","watchCount":0,"isWatching":false},"created":"2008-07-25T13:55:50.205+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-05-04T18:22:10.321+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11690","id":"11690","name":"Network Client"}],"timeoriginalestimate":null,"description":"After returning a pooled connection to the pool and getting it again a NullPointerException is thrown when a clob field is accessed again. This may be related to the following post: http://mail-archives.apache.org/mod_mbox/db-derby-user/200803.mbox/%3C47CD3431.5020205@sun.com%3E\n\nHere is the stack trace:\njava.lang.NullPointerException\n        at org.apache.derby.client.am.PreparedStatement.setIntX(Unknown Source)\n        at org.apache.derby.client.am.CallableLocatorProcedures.clobGetLength(Unknown Source)\n        at org.apache.derby.client.am.Clob.getLocatorLength(Unknown Source)\n        at org.apache.derby.client.am.Lob.sqlLength(Unknown Source)\n        at org.apache.derby.client.am.Clob.length(Unknown Source)\n        at org.apache.derby.client.am.Cursor.getString(Unknown Source)\n        at org.apache.derby.client.am.ResultSet.getString(Unknown Source)\n        at derbyerr.Main.main(Main.java:65)\n\n\nHere is the code to reproduce the problem:\n\npackage derbyerr;\n\nimport java.sql.Connection;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\nimport javax.sql.PooledConnection;\nimport org.apache.derby.jdbc.ClientConnectionPoolDataSource;\n\n\npublic class Main {\n  \n  public static void main (String[] args) {\n    org.apache.derby.tools.sysinfo.main (args) ;\n    \n    ClientConnectionPoolDataSource creator = new ClientConnectionPoolDataSource () ;\n    // There should be an empty db named testdb\n    creator.setDatabaseName (\"testdb\") ;\n    \n    try {\n      PooledConnection pc = creator.getPooledConnection () ;\n      \n      Connection c = pc.getConnection () ;\n      PreparedStatement ps ;\n      ResultSet rs ;\n      String s ;\n\n      // Drop the table \"test\", if it exsists\n      try {\n        ps = c.prepareStatement (\"drop table test\") ;\n        ps.execute () ;\n        ps.close () ;\n      } catch (Exception e) {\n      }\n      \n      // Create a test table with a clob field\n      ps = c.prepareStatement (\"create table test (pkey varchar(255) not null primary key, value clob)\") ;\n      ps.execute () ;\n      ps.close () ;\n      \n      // Insert a record\n      ps = c.prepareStatement (\"insert into test values ('123', 'abc')\") ;\n      ps.execute () ;\n      ps.close () ;\n\n      // Query the record and...\n      ps = c.prepareStatement (\"select * from test\") ;\n      rs = ps.executeQuery () ;\n      rs.next () ;\n      // ...access the clob field - this works\n      s = rs.getString (2) ;\n      assert s.equals (\"abc\") ;\n      rs.close () ;\n      ps.close () ;\n      \n      // Simulate connection pooling: close the connection and get it again\n      c.close () ;\n      c = pc.getConnection () ;\n\n      // Now again query the record...\n      ps = c.prepareStatement (\"select * from test\") ;\n      rs = ps.executeQuery () ;\n      rs.next () ;\n      // ...and access the clob - this fails\n      s = rs.getString (2) ;\n      assert s.equals (\"abc\") ;\n      rs.close () ;\n      ps.close () ;\n      \n    } catch (Exception e) {\n      e.printStackTrace () ;\n    }\n  }\n  \n}\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39313","summary":"NullPointerException when accessing a clob through a pooled connection","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rlovec","name":"rlovec","emailAddress":"ralf dot lovec at adimsystems dot ch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ralf Lovec","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rlovec","name":"rlovec","emailAddress":"ralf dot lovec at adimsystems dot ch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ralf Lovec","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"------------------ Java-Informationen ------------------\nJava-Version: 1.6.0\nJava-Anbieter: Sun Microsystems Inc.\nJava-Home: C:\\Program Files\\Java\\jdk1.6.0\\jre\nJava-Klassenpfad: C:\\PHS\\db-derby\\db-derby-10.4.1.3-bin\\lib\\derbyclient.jar;C:\\PHS\\db-derby\\db-derby-10.4.1.3-bin\\lib\\derbytools.jar;C:\\PHS\\Dvlp\\Schop\\derby-err\\build\\classes\nName des Betriebssystems: Windows XP\nArchitektur des Betriebssystems: x86\nBetriebssystemversion: 5.1\nJava-Benutzername: Ralf Lovec\nJava-Benutzerausgangsverzeichnis: C:\\Documents and Settings\\Ralf Lovec\nJava-Benutzerverzeichnis: C:\\PHS\\Dvlp\\Schop\\derby-err\njava.specification.name: Java Platform API Specification\njava.specification.version: 1.6\n--------- Derby-Informationen --------\nJRE - JDBC: Java SE 6 - JDBC 4.0\n[C:\\PHS\\db-derby\\db-derby-10.4.1.3-bin\\lib\\derbytools.jar] 10.4.1.3 - (648739)\n[C:\\PHS\\db-derby\\db-derby-10.4.1.3-bin\\lib\\derbyclient.jar] 10.4.1.3 - (648739)\n------------------------------------------------------\n----------------- Informationen zur L�ndereinstellung -----------------\nAktuelle L�ndereinstellung:  [Deutsch/Deutschland [de_DE]]\nEs wurde Unterst�tzung f�r die folgende L�ndereinstellung gefunden: [cs]\n         Version: 10.4.1.3 - (648739)\nEs wurde Unterst�tzung f�r die folgende L�ndereinstellung gefunden: [de_DE]\n         Version: 10.4.1.3 - (648739)\nEs wurde Unterst�tzung f�r die folgende L�ndereinstellung gefunden: [es]\n         Version: 10.4.1.3 - (648739)\nEs wurde Unterst�tzung f�r die folgende L�ndereinstellung gefunden: [fr]\n         Version: 10.4.1.3 - (648739)\nEs wurde Unterst�tzung f�r die folgende L�ndereinstellung gefunden: [hu]\n         Version: 10.4.1.3 - (648739)\nEs wurde Unterst�tzung f�r die folgende L�ndereinstellung gefunden: [it]\n         Version: 10.4.1.3 - (648739)\nEs wurde Unterst�tzung f�r die folgende L�ndereinstellung gefunden: [ja_JP]\n         Version: 10.4.1.3 - (648739)\nEs wurde Unterst�tzung f�r die folgende L�ndereinstellung gefunden: [ko_KR]\n         Version: 10.4.1.3 - (648739)\nEs wurde Unterst�tzung f�r die folgende L�ndereinstellung gefunden: [pl]\n         Version: 10.4.1.3 - (648739)\nEs wurde Unterst�tzung f�r die folgende L�ndereinstellung gefunden: [pt_BR]\n         Version: 10.4.1.3 - (648739)\nEs wurde Unterst�tzung f�r die folgende L�ndereinstellung gefunden: [ru]\n         Version: 10.4.1.3 - (648739)\nEs wurde Unterst�tzung f�r die folgende L�ndereinstellung gefunden: [zh_CN]\n         Version: 10.4.1.3 - (648739)\nEs wurde Unterst�tzung f�r die folgende L�ndereinstellung gefunden: [zh_TW]\n         Version: 10.4.1.3 - (648739)\n------------------------------------------------------\n","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":5,"total":5,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12401011/comment/12616919","id":"12616919","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"I had a quick look at the bug. Thank you very much for the repro. I verified that the bug is also present in trunk (development version).\r\n\r\nAt the moment I don't have much to offer, but you can run with JDBC statement caching as a workaround by adding \"creator.setMaxStatements(<how-many-statements-you-want-to-cache>);\".\r\nPlease note that the client-side JDBC statement cache is not ready for production with 10.4.1.3. There were some bugs on the server in how the connections were handled, causing a resource leak that lead to increased GC overhead.\r\n\r\nThe cause of the NPE is that the parameter meta data has been nulled out and not been reset. I hope to be able to have a closer look on Monday.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-07-25T15:01:37.496+0000","updated":"2008-07-25T15:01:37.496+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12401011/comment/12617438","id":"12617438","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"'derby-3799-1a-checkIfClosed.diff' fixes the reported problem and adds a regression test.\r\n\r\nWhen a logical connection is closed all open statements are closed. The LOB stored procedure code did not detect this, as it only checked if the reference to the CallableStatement was null or not.\r\nI fixed this by also checking if the CallableStatement is open on the client. The fix implies that the stored procedure calls must be prepared for each logical connection, if the LOB stored procedures are needed. This does not happen when the JDBC statement cache is enabled.\r\n\r\nComments on the fix approach and the patch are welcome!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-07-28T14:38:37.375+0000","updated":"2008-07-28T14:38:37.375+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12401011/comment/12619018","id":"12619018","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Committed patch 1a to trunk with revision 681694.\r\nBackported to 10.4 with revision 681697.\r\n\r\nIssue can be closed when the fix has been verified.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-08-01T14:00:15.117+0000","updated":"2008-08-01T14:00:15.117+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12401011/comment/12619375","id":"12619375","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rlovec","name":"rlovec","emailAddress":"ralf dot lovec at adimsystems dot ch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ralf Lovec","active":true},"body":"I have tested trunk and the backport to 10.4 and in both versions the problem has been resolved.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rlovec","name":"rlovec","emailAddress":"ralf dot lovec at adimsystems dot ch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ralf Lovec","active":true},"created":"2008-08-03T20:41:47.928+0000","updated":"2008-08-03T20:41:47.928+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12401011/comment/12619427","id":"12619427","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Thanks for the quick feedback, Ralf :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-08-04T06:34:42.397+0000","updated":"2008-08-04T06:34:42.397+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3799/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i073dj:"}}
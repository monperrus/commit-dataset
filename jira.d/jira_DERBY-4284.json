{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12428537","self":"https://issues.apache.org/jira/rest/api/latest/issue/12428537","key":"DERBY-4284","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314182","id":"12314182","description":"Old head of 10.5 branch","name":"10.5.3.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313727","id":"12313727","description":"Feature release","name":"10.6.1.0","archived":false,"released":true,"releaseDate":"2010-05-18"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-07-03 14:22:26.818","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24156","customfield_12310222":"3_*:*_1_*:*_929760063_*|*_1_*:*_1_*:*_5834906429_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2009-09-08T14:53:12.071+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4284/watchers","watchCount":1,"isWatching":false},"created":"2009-06-22T07:48:45.579+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"7.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12326697","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12326697","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12373447","key":"DERBY-2916","self":"https://issues.apache.org/jira/rest/api/2/issue/12373447","fields":{"summary":"Change/error? in 'Ordered null semantics' output from 'SYSCS_UTIL.SYSCS_GET_RUNTIMESTATISTICS()' in lang/wisconsin.java","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"New"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12326696","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12326696","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12371145","key":"DERBY-2775","self":"https://issues.apache.org/jira/rest/api/2/issue/12371145","fields":{"summary":"DataTypeDescriptor should be immutable so that multiple ValueNode referring to the same DTD do not have unexpected state changes.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"New"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-01-21T17:52:28.829+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11407","id":"11407","name":"JDBC"},{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"Consider following:-\r\n\r\ncreate table person (\r\n  id varchar(20) not null,\r\n  name varchar(100) not null\r\n);\r\n\r\ncreate table car (\r\n  id varchar(20) not null,\r\n  person_id varchar(20) not null,\r\n  model varchar(100) not null,\r\n  plat_no varchar(100) not null\r\n);\r\n\r\nWhen select :-\r\nselect\r\np.name,\r\nc.model,\r\nc.plat_no\r\nfrom person p\r\nleft join car c on (p.id = c.person_id);\r\n\r\nFrom the ResultSet, get the ResultSetMetaData and inspect each column's isNullable() value, which is always = 1 (always nullable).  Expected : column 'p.name' isNullable = 0 (not nullable), but I get 'p.name' isNullable = 1 (nullable)","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37229","summary":"All Columns become Nullable when Using left join","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chuacheeseng83","name":"chuacheeseng83","emailAddress":"quai83 at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chua Chee Seng","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chuacheeseng83","name":"chuacheeseng83","emailAddress":"quai83 at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chua Chee Seng","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Microsoft Windows XP SP3, Sun JDK 6 Update 14","customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":15,"total":15,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12726980","id":"12726980","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Uploading a repro; Main.java.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2009-07-03T14:22:26.818+0000","updated":"2009-07-03T14:22:26.818+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12726981","id":"12726981","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Triaged for 10.5.2, checking \"repro attached\" and setting \"normal\" urgency.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2009-07-03T14:23:55.476+0000","updated":"2009-07-03T14:23:55.476+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12727179","id":"12727179","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chuacheeseng83","name":"chuacheeseng83","emailAddress":"quai83 at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chua Chee Seng","active":true},"body":"hi Dag H. Wanyik,\r\n\r\nThanks for attending the issue, our application framework is depending on this thus it becomes show stopper to run our applicaiton on Apache Derby, it will be great if it is going to be fixed in version 10.5.2.\r\n\r\nThanks!\r\n\r\nBest Regards,\r\nChee Seng","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chuacheeseng83","name":"chuacheeseng83","emailAddress":"quai83 at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chua Chee Seng","active":true},"created":"2009-07-04T02:34:05.684+0000","updated":"2009-07-04T02:34:05.684+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12748825","id":"12748825","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"JoinNode.buildRCL() correctly makes all the columns from the right side of the join nullable in a left outer join, and leaves the nullability of the columns on the left side untouched. However, this code in SelectNode.bindResultColumns() later marks all the columns as nullable:\r\n\r\n\t\t/* Fix nullability in case of any outer joins in the fromList */\r\n\t\tif (fromList.hasOuterJoins())\r\n\t\t\tresultColumns.setNullability(true);\r\n\r\nI'm running tests now to see if just removing the code causes any problems. Removing it does give the expected nullability for the query in the description (name non-nullable, model nullable, plat_no nullable).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-08-28T14:07:45.182+0000","updated":"2009-08-28T14:07:45.182+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12748976","id":"12748976","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Many regression tests failed with the change (2 failures in suites.All, 21 failures in derbyall). I haven't studied the failures in detail, but it looks like most of them, if not all, are caused by differences in ij's formatting when columns are changed from nullable to non-nullable. For instance, a CHAR(2) NOT column is given space for two characters in the output, whereas a CHAR(2) column is given space for four characters (to allow NULL to be printed). I believe this difference is to be expected.\r\n\r\nThe code below illustrates how ij formats nullable and non-nullable columns differently:\r\n\r\nij> create table t(col1 char(2) not null, col2 char(2));\r\n0 rows inserted/updated/deleted\r\nij> select * from t;\r\nC&|COL2\r\n-------\r\n\r\n0 rows selected","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-08-28T20:50:20.157+0000","updated":"2009-08-28T20:50:20.157+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12749470","id":"12749470","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I'm attaching a patch with the code changes I believe are necessary to fix this bug. It also contains a regression test which verifies that the nullability is as expected in a left outer join and in a right outer join.\r\n\r\nI'll post an updated patch which contains the necessary updates to the test canons once I've gone through all the test failures and verified that they are expected. However, I'm posting this minimal patch now to make it easier for reviewers to see the actual code changes.\r\n\r\nThe patch is not ready for commit due to the regression test failures seen with it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-08-31T11:15:04.363+0000","updated":"2009-08-31T11:15:04.363+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12749474","id":"12749474","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"At least one of the test failures shows an actual problem. store/xaOffline1.sql defines the following view as a right outer join between two diagnostic tables:\r\n\r\ncreate view lock_table as\r\nselect \r\n    cast(username as char(8)) as username,\r\n    cast(t.type as char(8)) as trantype,\r\n    cast(l.type as char(8)) as type,\r\n    cast(lockcount as char(3)) as cnt,\r\n    mode,\r\n    cast(tablename as char(12)) as tabname,\r\n    cast(lockname as char(10)) as lockname,\r\n    state,\r\n    status\r\nfrom \r\n    syscs_diag.lock_table l  right outer join syscs_diag.transaction_table t\r\non l.xid = t.xid where l.tableType <> 'S' and t.type='UserTransaction';\r\n\r\nWithout the patch, all the columns returned by the view are nullable. That's not correct. However, with the patch, the columns CNT, TABNAME and LOCKNAME are incorrectly reported as non-nullable. Since those columns come from the left side of a right outer join, they should be nullable.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-08-31T12:03:05.199+0000","updated":"2009-08-31T12:03:05.199+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12749486","id":"12749486","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The problematic query in store/xaOffline1.sql was also used in many other tests, so most of the test failures were caused by that problem.\r\n\r\nI'm uploading a new patch, still not ready for commit, which updates the canons for the tests that had only the expected changes in the output (nist/dml148.sql, nist/dml162.sql, lang/outerjoin.sql).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-08-31T13:13:37.354+0000","updated":"2009-08-31T13:13:37.354+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12749508","id":"12749508","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The problem seems to be related to the cast. Here's some code that exposes the problem without using the diagnostic tables:\r\n\r\nij> create table t1 (x varchar(10) not null);\r\n0 rows inserted/updated/deleted\r\nij> create table t2 (y varchar(10) not null);\r\n0 rows inserted/updated/deleted\r\nij> create view v1 as select x,y from t1 left outer join t2 on 1=1;\r\n0 rows inserted/updated/deleted\r\nij> describe v1;\r\nCOLUMN_NAME         |TYPE_NAME|DEC&|NUM&|COLUM&|COLUMN_DEF|CHAR_OCTE&|IS_NULL&\r\n------------------------------------------------------------------------------\r\nX                   |VARCHAR  |NULL|NULL|10    |NULL      |20        |NO      \r\nY                   |VARCHAR  |NULL|NULL|10    |NULL      |20        |YES     \r\n\r\n2 rows selected\r\nij> create view v2 as select x,cast(y as char(2))y from t1 left outer join t2 on 1=1;\r\n0 rows inserted/updated/deleted\r\nij> describe v2;\r\nCOLUMN_NAME         |TYPE_NAME|DEC&|NUM&|COLUM&|COLUMN_DEF|CHAR_OCTE&|IS_NULL&\r\n------------------------------------------------------------------------------\r\nX                   |VARCHAR  |NULL|NULL|10    |NULL      |20        |NO      \r\nY                   |CHAR     |NULL|NULL|2     |NULL      |4         |NO      \r\n\r\n2 rows selected\r\n\r\nY is correctly reported as nullable without the cast, but it is reported as non-nullable if it is cast to CHAR(2).\r\n\r\nWithout the patch, both X and Y are nullable, which is also wrong. Only Y should be nullable in these two queries.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-08-31T14:19:19.442+0000","updated":"2009-08-31T14:19:19.442+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12750445","id":"12750445","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Here's a new patch which addresses the remaining issues. It also adds more test cases. All the regression tests ran cleanly with the patch.\r\n\r\nDescription of the changes:\r\n\r\nSelectNode.java:\r\n\r\n* bindResultColumns(): Don't make all the columns nullable just because the query contains an outer join.\r\n\r\nFromList.java:\r\n\r\n* Removed helper method hasOuterJoins() which is no longer used after the changes in SelectNode.\r\n\r\nJoinNode.java:\r\n\r\n* getMatchingColumn(): If the join is a \"half\" outer join, and the matching column is found on the logical right side of the join (logical right side == left side in a right outer join), make that column nullable before returning it. Although JoinNode already has code in buildRCL() that makes all columns on the logical right side nullable, getMatchingColumn() may be called before the RCL has been built, which causes the problem with casts mentioned in the previous comment.\r\n\r\nlang/JoinTest.java:\r\nlang/_Suite.java:\r\n\r\n* Test cases for this bug.\r\n\r\ndml148.out:\r\ndml162.out:\r\nouterjoin.out:\r\n\r\n* Updated master with formatting changes caused by nullable column becoming non-nullable.\r\n\r\nwisconsin.out:\r\n\r\n* Updated printed query plan for an outer join because a scan stopped using \"ordered null sematics\" on a column now that it sees that it's not nullable.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-09-02T14:01:22.088+0000","updated":"2009-09-02T14:01:22.088+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12750448","id":"12750448","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"That wisconsin.out change is intriguing. I vaguely remember a situation several years back when we updated the query plan in the ref file due to an ordered null semantics diff, and we couldn't figure out what had caused it, or why. Unfortunately I can't remember more of the details, but I'm hopeful that with this latest change we now have a tighter grip on the nullability of result columns. Thanks for investigating these issues in such detail!\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2009-09-02T14:15:48.478+0000","updated":"2009-09-02T14:15:48.478+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12750731","id":"12750731","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for that hint, Bryan. It looks like my changes to wisconsin.out are the exact reverse of the following commit:\r\n\r\n------------------------------------------------------------------------\r\nr562113 | djd | 2007-08-02 16:10:47 +0200 (to, 02 aug 2007) | 2 lines\r\n\r\nDERBY-2916 Fix wisconsin canon file due to changes that allowed a valid optimization to the plan.\r\n\r\n------------------------------------------------------------------------\r\n\r\nIf the root cause of DERBY-2916 is found and fixed, it will hopefully be possible to revert the changes I have suggested for JoinNode.getMatchingColumn(), as it feels somewhat dirty to have to set the nullability two different places (both buildRCL() and getMatchingColumn()). For the record, I did try to move setting the nullability from buildRCL(), which is called from bindResultColumn(), to bindExpressions() which is called before bindResultColumn() and also before the cast node is bound. That seemed to fix the issues for most queries, but for multi-level nested outer joins the left/right child result sets hadn't always initialized their RCLs at that time, so that broke down.\r\n\r\nI didn't find any single place to put the nullability code so that it was executed sufficiently early so that all nodes on top of it would see the correct nullability, and at the same time sufficiently late so that the child result sets were properly bound. Though I must admit I don't fully understand JoinNode's bind logic with bindExpressions() followed by bindResultColumns() again followed by deferredBindExpressions().\r\n\r\nIt sounds very likely that the problem with the cast node not seeing the correct nullability is caused by the DERBY-2775 changes. Before DERBY-2775, when the nullability of the result column in the join node was changed, the change in nullability would automatically cascade up to the cast node since it had a reference to the exact same data type descriptor.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-09-02T23:26:36.387+0000","updated":"2009-09-02T23:26:36.387+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12750944","id":"12750944","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The 1d patch updates the comment in JoinNode.getMatchingColumn() and explains that it's a workaround for the problem logged as DERBY-2916.\r\n\r\nI now feel confident that the patch is ok, and plan to commit it shortly. The changes in SelectNode and FromList look rather obvious, I think. The change in JoinNode didn't feel quite right, but now that we have found that it's another manifestation of DERBY-2916, I think it is fine to leave the workaround there and add a note to DERBY-2916 saying that it should be removed once the underlying cause has been found and fixed.\r\n\r\nAlso, the proposed patch moves the workaround for DERBY-2916 from the test canons to the product code, which I think is a slight improvement, even though the best solution would be to fix the root cause of DERBY-2916.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-09-03T09:50:28.508+0000","updated":"2009-09-03T09:50:28.508+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12750954","id":"12750954","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Committed to trunk with revision 810860. I'll leave the issue open until the fix has been back-ported to 10.5.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-09-03T10:15:14.346+0000","updated":"2009-09-03T10:15:14.346+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12428537/comment/12752552","id":"12752552","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Merged to the 10.5 branch and committed revision 812536.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-09-08T14:53:12.005+0000","updated":"2009-09-08T14:53:12.005+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4284/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06qif:"}}
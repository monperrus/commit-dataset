{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12312748","self":"https://issues.apache.org/jira/rest/api/latest/issue/12312748","key":"DERBY-479","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-02-08 19:15:44.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"21974","customfield_12310222":"1_*:*_1_*:*_19134613000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_131991000","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-03-07T12:45:25.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-479/watchers","watchCount":0,"isWatching":false},"created":"2005-07-29T01:35:12.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"7.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12328067","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12328067","type":{"id":"10032","name":"Blocker","inward":"is blocked by","outward":"blocks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10032"},"inwardIssue":{"id":"12442110","key":"DERBY-4459","self":"https://issues.apache.org/jira/rest/api/2/issue/12442110","fields":{"summary":"Verification error at execute-time when an outer function which takes a primitive arg is wrapped around an inner function which returns the corresponding Java wrapper object","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12311910","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12311910","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12329346","key":"DERBY-1030","self":"https://issues.apache.org/jira/rest/api/2/issue/12329346","fields":{"summary":"In some situations a RETURNS NULL ON NULL function is called when one ot its parameters is NULL","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-12-01T18:10:45.554+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"Error in ij (RN_RADIANS is a function declared as returns null on null input)\n\nij> VALUES CAST( CALL_COS(RN_RADIANS(90.0)) AS DECIMAL(3,2));\nERROR XBCM1: Java linkage error thrown during load of generated class org.apache.derby.exe.ace5214067x0105x5e41x7a46xffff855452e375.\nERROR XJ001: Java exception: '(class: org/apache/derby/exe/ace5214067x0105x5e41x\n7a46xffff855452e375, method: e0 signature: ()Ljava/lang/Object;) Expecting to find double on stack: java.lang.VerifyError'.\n\n\nextract from derby.log\n\n2005-07-28 16:23:43.836 GMT Thread[main,5,main] Wrote class org.apache.derby.exe\n.ace5214067x0105x5e41x7a46xffff855452e375 to file C:\\_work\\svn_pb\\trunk\\systest\\\nout\\functions\\ace5214067x0105x5e41x7a46xffff855452e375.class. Please provide sup\nport with the file and the following exception information: java.lang.VerifyErro\nr: (class: org/apache/derby/exe/ace5214067x0105x5e41x7a46xffff855452e375, method\n: e0 signature: ()Ljava/lang/Object;) Expecting to find double on stack\n\n\nI will add a test case to lang/functions.sql commented with this bug number. Test cases\nthat fail will be commented out.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"38275","summary":"Passing the return of  a RETURN NULL ON NULL INPUT function to another function call throws linkage error.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":20,"total":20,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12365538","id":"12365538","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I spent some time on this bug and was able to reproduce it without casting and multiple functions. The following simpler test case will run into similar linkage error as the one reported in the bug\r\nCREATE FUNCTION RN_abs(A int) RETURNS int\r\nEXTERNAL NAME 'java.lang.Math.abs(int)'\r\nRETURNS NULL ON NULL INPUT\r\nLANGUAGE JAVA PARAMETER STYLE JAVA;\r\nVALUES ( RN_abS(RN_abs(90)));\r\n\r\nThe function is defined such that if the argument to it is null, it should simply return null w/o invoking the function. But, in order to return null, the function's return type can't be primitive (it is int in this example). To get around this, the generator generates the output of the RN_abs function as java.lang.Integer. But since in the given example, (RN_abs(90)) is input to another function which is expecting to get a primitive data type of int, and not java.lang.Integer, Derby raises an error for type mismatch because (RN_abs(90)) is going to return java.lang.Integer and not int. \r\n\r\nI will continue to look into this, but does this explanation trigger a thought process in anyone's mind? \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2006-02-08T19:15:44.000+0000","updated":"2006-02-08T19:15:44.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12365609","id":"12365609","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"It helps in these situations to be clear about SQL function vs. Java method. For example the the first sentence in the last comment should be:\r\n\r\n> The function is defined such that if the argument to it is null, it should simply return null w/o invoking the method.\r\n\r\nThen this leads to the next sentence saying:\r\n\r\n> But, in order to return null, the method's return type can't be primitive\r\n\r\nThis is wrong, if it relates to the first sentence, if the method is never being called when the input is SQL NULL, then it doesn't matter\r\nwhat the return type of the method is (since the method is never called).  \r\n\r\nIt is correct however if the method needs to return a NULL value when the input parameters are not NULL, or the SQL function\r\nis declared as CALLED ON  NULL INPUT. then the Java method does need to have a return type of  java.lang.Integer.\r\n\r\nOne thought is related to the handling of converting types between the SQL domain and the Java domain. The nodes pushed for such\r\nan expression are something like:\r\n\r\n JavaToSQL( StaticMethodCall(  SQLtoJava ( JavaToSQL ( StaticMethodCall (constant 90) ) ) ) ) \r\n\r\nThat is any compiled node that results in a Java value is automatically wrapped in a JavaToSQL node that  converts the value\r\nfrom the Java space (a Java object ot primitive) to the SQL space (a DataValueDescriptor). The assumption is the Java value\r\nis most likely returned to the SQL space. If a SQL value needs to be pushed into the Java space the converse node is used.\r\n\r\nWhen a SQLtoJava  wraps a JavaToSQL node   (or vice versa) the compiler (I think) will just remove these two nodes so that \r\nthere is no performance overhead due to the no-op conversion . I think the logic for this removal was not updated for the RETURNS\r\nNULL ON NULL INPUT case, because this clause means the double conversion is not  no-op.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-02-09T03:25:25.000+0000","updated":"2006-02-09T03:25:25.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12366243","id":"12366243","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Hi,\r\n\r\nI have a patch for this bug. The patch description in brief is as follows.\r\n\r\nI have taken an example to explain the patch. Consider following sql function.(Notice it is defined with RETURNS NULL ON NULL INPUT)\r\n\r\nCREATE FUNCTION RN_abs(A int) RETURNS int\r\nEXTERNAL NAME 'java.lang.Math.abs(int)'\r\nRETURNS NULL ON NULL INPUT\r\nLANGUAGE JAVA PARAMETER STYLE JAVA;\r\nVALUES CAST( RN_abS(RN_abs(90)) AS INTEGER);\r\n\r\nFirst let's start out by a VALUES query that does work fine.\r\nVALUES RN_abs(90)\r\n\r\nDuring the bind phase of VALUES RN_abs(90), following nodes are created\r\nJavaToSQL ( StaticMethodCall (SQLToJava (NumericConstantNode for constant 90) ) )\r\n\r\nDuring code generation, StaticMethodCallNode, for each of the parameters, calls generateOneParameter. In this eg, there is only one parameter and the node for that parameter is SQLToJavaValueNode. This node first generates the SQL value by calling generate on NumericConstantNode. NumericConstantNode generates code to get NumberDataValue for constant 90. This is the right type for the SQL domain but since this needs to be passed into Java domain, we need to do some casting. The java domain value would be to get a primitive int from NumberDataValue. To achieve this, SQLToJavaValueNode in it's generateJavaValue generates the code to get primitive value from NumberDataValue. In this case, it will be generating code to call getInt() on NumberDataValue so that we have the correct type for the java domain.\r\n\r\nStaticMethodCallNode after generating each parameter checks if the argument type to SQL function is same\r\nas the parameter type to the Java method. In this case, the SQL argument type is java.lang.Integer and Java method parameter type is int. Because of this, it casts the item on the top of the stack to Java method parameter type. \r\n\r\nAfter taking care of parameter code generation, StaticMethodCallNode checks if the sql function is defined to return null if any of its arguments are null. This is true for our specific sql function. To take care of this, StaticMethodNode needs to have a return type of Object rather than primitive int type. After generating code to call java.lang.Math.abs, it generates the code to return java.lang.Math.abs's return value as java.lang.Integer This is where VALUES ( RN_abS(RN_abs(90))) runs into problem. \r\n\r\nSo, now let's look at the problem sql.\r\nVALUES ( RN_abS(RN_abs(90)));\r\n\r\nIn the bind phase, following nodes are created for VALUES ( RN_abS(RN_abs(90)))\r\nJavaToSQL ( StaticMethodCall ( StaticMethodCall (SQLToJava (NumericConstantNode for constant 90) ) )  )\r\n\r\nIn generate phase, SQLToJavaValueNode generates code for SQL domain NumberDataValue first. But since the value needs to be returned to Java domain, it generates code to call getInt on NumberDataValue to get int for the Java domain. The inside StaticMethodCallNode finds that SQL function argument type is not same as Java parameter type and hence it generates code to cast the stack value to Java method parameter type. StaticMethodNode then generates the code to call java.lang.Math.abs and it converts the int type of the Java method return value into java.lang.Integer because the sql function has been defined to return null on null input. In order to be able to return null, the return type can't be primitive, it has to be an Object which in this case is java.lang.Integer. So far the code generation is same as for simple VALUES RN_abs(90). The problem happens during code generation for outside StaticMethodCallNode. Outside StaticMethodCallNode is expecting an int type but inside StaticMethodNode returned java.lang.Integer to cover return null on null state definition of the sql function. This type mismatch is what causes the linkage exception. \r\n\r\nI have resolved this type mismatch for outside sql function call by retrieving int value from java.lang.Integer with the help of the DataValueFactory, as shown below (I have added the code for this in MethodCallNode.generateParameters. The new code has !!! in front of them in following code)\r\n   if (!parameterType.equals(argumentType))\r\n   {\r\n    // since we reached here through method resolution\r\n    // casts are only required for primitive types.\r\n    // In any other case the expression type must be assignable\r\n    // to the parameter type.\r\n    if (classInspector.primitiveType(parameterType)) {\r\n!!!     //The type on the stack for this parameter will not be primitive if this parameter\r\n!!!     //is a call to another sql function which is defined to return null on null input.\r\n!!!     //To take care of such a case, first generate the code to extract primitive type\r\n!!!     //from the value on the top of the stack. Derby479. eg \r\n!!!     //CREATE FUNCTION RN_abs(A int) RETURNS int\r\n!!!     //EXTERNAL NAME 'java.lang.Math.abs(int)'\r\n!!!     //RETURNS NULL ON NULL INPUT\r\n!!!     //LANGUAGE JAVA PARAMETER STYLE JAVA;\r\n!!!     //VALUES ( RN_abS(RN_abs(90)));\r\n!!!     //Inside RN_abs is returning a java.lang.Math so that it can return null if the argument\r\n!!!     //to it is null. But inside RN_abS is expecting primitive type int as input argument.\r\n!!!     //Following piece of code extract primitive value from the Object value.\r\n!!!     TypeId temp = methodParms[param].getJSQLType().getSQLType().getTypeId();\r\n!!!     acb.generateDataValue(mb, getTypeCompiler(temp), (LocalField) null);\r\n!!!     mb.callMethod(VMOpcode.INVOKEINTERFACE, ClassName.DataValueDescriptor,\r\n!!!       getTypeCompiler(temp).getPrimitiveMethodName(), \r\n!!!       getTypeCompiler(temp).getCorrespondingPrimitiveTypeName(), 0);\r\n     mb.cast(parameterType);\r\n    } else {\r\nBecause of these changes to MethodCallNode, mb.cast doesn't run into casting exception anymore. I have attached the code changes to the JIRA entry.\r\n\r\nsvn stat\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\ActivationClassBuilder.java\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\MethodCallNode.java\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\CursorNode.java\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\SQLToJavaValueNode.java\r\nM      java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\lang\\functions.sql\r\nM      java\\testing\\org\\apache\\derbyTesting\\functionTests\\master\\functions.out\r\n\r\nI ran derbyall on my Windows XP with Sun's jdk14 and everything ran fine.\r\n\r\nPlease send any feedback you might have.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2006-02-14T06:24:45.000+0000","updated":"2006-02-14T06:24:45.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12366445","id":"12366445","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"The reason for this exception lies in the parsing phase where MethodCallNode.addParams(Vector) tries to do some optimization. Rather than putting SQLToJavaValueNode on top of JavaToSQLValueNode, it directly gets the JavaValueNode. The comment for this shortcircuit in MethodCallNode.addParams(Vector) says \"In general, we want to avoid converting the same value back and forth between the SQL and Java domains,\" But going directly to java domain value causes type mismatch for a SQL function defined with return null on null input and when that SQL function is used as an argument to another SQL function. In order to generate the correct code for such a SQL function, we need access to both SQL domain value and Java domain value. In my patch, I have removed the optimization code from MethodCallNode.addParams(Vector) so that now, we do create a SQLToJavaValueNode on top of JavaToSQLValueNode. This change fixes the problem. I have attached the patch for it to JIRA. Please send any comments you might have after the review.\r\n\r\nI have run derbyall suite on Windows XP with Sun jdk14 and there were no problems. \r\n\r\nsvn stat\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\ActivationClassBuilder.java\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\MethodCallNode.java\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\CursorNode.java\r\nM      java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\lang\\functions.sql\r\nM      java\\testing\\org\\apache\\derbyTesting\\functionTests\\master\\functions.out","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2006-02-15T15:23:45.000+0000","updated":"2006-02-15T15:23:45.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12366484","id":"12366484","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"The patch seems to always remove the optimization, isn't the optimization still useful for functions that are CALLED ON NULL INPUT?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-02-15T23:16:13.000+0000","updated":"2006-02-15T23:16:13.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12366523","id":"12366523","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"In the parsing phase, we do not yet know whether the sql function is defined as RETURN NULL ON NULL INPUT or as CALLED ON NULL INPUT and hence the optimization for CALLED ON NULL INPUT can't done in MethodCallNode.addParams(Vector). But during the bind phase, after all the parameters are bound (StaticMethodCallNode.bindExpression line number 170), we get information about the  underlying sql function from the system tables. At this point (StaticMethodCallNode.bindExpression line number 241), we can find out whether the function is defined as CALLED ON NULL INPUT and possibly can optimize the parameter code for CALLED ON NULL INPUT by going directly to java value rather than going JavaToSQLValueNode and then SLQToJavaValueNode on top of it. Let me know if anyone has any comments on this approach. If not, I will investigate in putting the shortcut code in for CALLED ON NULL INPUT.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2006-02-16T04:06:16.000+0000","updated":"2006-02-16T04:06:16.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12366661","id":"12366661","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I have attached a patch (Derby479LinkageErrorReturnNullIfNulldiff021606.txt) which solves the problem by leaving SQLToJavaValueNode wrapper on top of JavaToSQLValueNode in case of a SQL function defined as RETURN NULL ON NULL INPUT. This is because, such a function requires access to both SQL domain value and Java domain value. This is not required for SQL function defined as CALLED ON NULL INPUT and hence we will continue to do the optimization for such functions by removing the wrapper classes SQLToJavaValueNode\r\nand JavaToSQLValueNode and going directly to java domain value. This happens in StaticMethodCallNode.bindExpression()\r\n\r\nsvn stat\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\ActivationClassBuilder.java\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\MethodCallNode.java\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\CursorNode.java\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\StaticMethodCallNode.java\r\nM      java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\lang\\functions.sql\r\nM      java\\testing\\org\\apache\\derbyTesting\\functionTests\\master\\functions.out","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2006-02-17T03:58:28.000+0000","updated":"2006-02-17T03:58:28.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12366726","id":"12366726","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"Thanks for the updated patch:\r\nMinor comments now:\r\n\r\n- You removed all the comment in MethodCallNode, but it seems half of that comment was still applicable.\r\n    At least the code's that left needs some comments.\r\n\r\n- I like the separate optimizeDomainValueConversion method\r\n\r\n- optimizeDomainValueConversion, can you make the comments to this method javadoc comments.\r\n\r\n  /**\r\n  */\r\n before the method defintiion. This means they will appear in the javadoc and in eclipse when the cursor is hovering\r\nover a call to this method. In general always use /** */ javadoc comments for classes, methods and fields.\r\n\r\n- In optimizeDomainValueConversion when can methodParms[parm] be null?\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-02-17T09:35:24.000+0000","updated":"2006-02-17T09:35:24.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12366820","id":"12366820","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Thanks for reviewing the patch. As for the last comment about methodParms[parm] null check, I did it because there are several such checks in MethodCallNode. Based on that, I assumed that it is required for some edge case. (I have to admit that I did wonder why there was such a check and probably should have asked the list). I have taken that null check out and rerunning the tests right now to make sure nothing breaks. Will post a new patch once the tests have completed successfully.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2006-02-18T02:35:06.000+0000","updated":"2006-02-18T02:35:06.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12367052","id":"12367052","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I reran the tests after removing the \"if (methodParms[parm] != null)\" from StaticMethodCallNBode.optimizeDomainValueConversion and this caused lang/wisconsin.java test to fail. I am not sure exactly why, but if I put the null check back, the wisconsin test doesnot fail. I have attached the original master as wisconsin.out and the failed wisconsin results as wisconsinAfterRemovingNullChk.out to this JIRA entry to shows what the diffs are. Does this ring a bell to anyone? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2006-02-21T01:54:46.000+0000","updated":"2006-02-21T01:54:46.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12367149","id":"12367149","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Dan, I have addressed all your comments in this (Derby479Version4LinkageErrorReturnNullIfNull022006.txt) patch. Also, as Myrna mentioned on the derby list, I indeed was running into intermittent failures of wisconsin.java test. Thanks, Myrna. I ran the test many times, with and without the parameter null check, and the test passed majority of the times. It intermittently failed for both with and without the parameter null check. Based on this, I have removed the parameter null check from StaticMethodCallNode.optimizeDomainValueConversion(). If anyone has any comments, please let me know. Otherwise, can a committer please commit this patch?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2006-02-21T15:12:36.000+0000","updated":"2006-02-21T15:12:36.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12367150","id":"12367150","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"The svn stat for Derby479Version4LinkageErrorReturnNullIfNull022006.txt is as follows\r\nM java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\ActivationClassBuilder.java\r\nM java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\MethodCallNode.java\r\nM java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\CursorNode.java\r\nM java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\StaticMethodCallNode.java\r\nM java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\lang\\functions.sql\r\nM java\\testing\\org\\apache\\derbyTesting\\functionTests\\master\\functions.out","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2006-02-21T15:18:08.000+0000","updated":"2006-02-21T15:18:08.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12367261","id":"12367261","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"The comment you added/modified in MethodCallNode is:\r\n\r\n+\t\t\t** If the parameter is a SQL ValueNode, then put a\r\n+\t\t\t** SQLToJavaValueNode on top of it.\r\n\r\nI see that as a comment that doesn't add any value, from the code I can see that is being done, the real value in a comment is explaining *why* something is done.\r\n\r\nLooking more at StaticMethodCallNode.optimizeDomainValueConversion() I'm not convinced it is correct.\r\nThe comments and code seem to say if I have\r\n\r\n f1(f2())\r\n\r\nthen if f2() is CALLED ON NULL INPUT then I can take the java value directly from f2() and pass it to f1().\r\n\r\nBut, what if f1() is RETURNS NULL ON NULL INPUT, don't I need the SQL nodes to perform the NULL check?\r\nThus don't both methods, the one being called and the one providing the parameter have to be CALLED ON NULL INPUT to take allow the conversion nodes to be dropped?\r\n\r\nIn the optimizeDomainValueConversion I think you need to check for the node being an instance of StaticMethodCallNode and not MethodCallNode, and I think for routine being null. StaticMethodCallNode and MethodCallNode are stil used for internal SQL that uses Java expressions directly and are not defined SQL routines.\r\n\r\nAnother aspect that may not be important, but before this change the conversion nodes are always dropped if they are between Java expressions, and that was incorrect in one situation, functions with RETURNS NULL ON NULL INPUT. Now you have changed it so they are only dropped in one situation, both methods being CALLED ON NULL INPUT (assuming a modified patch). Thus the optimization is being lost in situations where it is useful. Maybe this is not an issue because those siutations typically don't arise any more, but some internal statements that use Java expressions may be losing this optimization.\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-02-22T06:12:40.000+0000","updated":"2006-02-22T06:12:40.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12367315","id":"12367315","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Dan, you are probably right about following \r\n>>>>>>>>> Dan's review comments start\r\n\"Looking more at StaticMethodCallNode.optimizeDomainValueConversion() I'm not convinced it is correct. \r\nThe comments and code seem to say if I have \r\n\r\n f1(f2()) \r\n\r\nthen if f2() is CALLED ON NULL INPUT then I can take the java value directly from f2() and pass it to f1(). \r\n\r\nBut, what if f1() is RETURNS NULL ON NULL INPUT, don't I need the SQL nodes to perform the NULL check? \r\nThus don't both methods, the one being called and the one providing the parameter have to be CALLED ON NULL INPUT to take allow the conversion nodes to be dropped? \"\r\n>>>>>>>>> Dan's review comments end\r\n\r\nBut I wanted to write an example for what you have described above to test what exactly happens with my changes.\r\n\r\nFollowing is the example I came up with and it worked fine with my changes\r\n\r\nCREATE FUNCTION f2(A varchar(128)) RETURNS varchar(128)\r\nEXTERNAL NAME 'org.apache.derbyTesting.functionTests.util.ProcedureTest.function2AlwaysReturnsNull'\r\nCALLED ON NULL INPUT\r\nLANGUAGE JAVA PARAMETER STYLE JAVA;\r\n\r\nCREATE FUNCTION f1(A varchar(128)) RETURNS varchar(128)\r\nEXTERNAL NAME 'org.apache.derbyTesting.functionTests.util.ProcedureTest.function1AlwaysReturnsAAA'\r\nRETURNs NULL ON NULL INPUT\r\nLANGUAGE JAVA PARAMETER STYLE JAVA;\r\n\r\nThe java methods invoked by the 2 sql functions are as follows\r\n\tpublic static String function1AlwaysReturnsAAA(String a) throws SQLException\r\n\t{\r\n\t\treturn \"AAA\";\r\n\t}\r\n\r\n\tpublic static String function2AlwaysReturnsNull(String a) throws SQLException\r\n\t{\r\n\t\treturn (String)null;\r\n\t}\r\n\r\nThen I tried following in ij and both of them returned null which is the correct value\r\nvalues f1(f2('sss'));\r\n1\r\n--------------------------------------------------------------------------------\r\nNULL\r\n\r\nvalues f1(f2(null));\r\n1\r\n--------------------------------------------------------------------------------\r\nNULL\r\n\r\nI have spent couple of hours on trying to come up with another example where I can see that my changes won't work but I haven't succedded. Do you have an example in mind which I can try? Thanks\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2006-02-22T16:55:21.000+0000","updated":"2006-02-22T16:55:21.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12367394","id":"12367394","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"Single patch could fix DERBY-479 and DERBY-1030","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-02-23T05:02:10.000+0000","updated":"2006-02-23T05:02:10.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12367396","id":"12367396","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"Single patch could fix DERBY-479 and DERBY-1030","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-02-23T05:03:19.000+0000","updated":"2006-02-23T05:03:19.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12367473","id":"12367473","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Based on today's mail sent by Dan where he identified another issue with functions (Derby-1030), I am submitting a patch(Derby479Version5LinkageErrorReturnNullIfNull022206.txt) that just addresses Derby-479. I will work on Derby-1030 after finishing up feature development work for 10.2 \r\n(Dan's mail is titled Re: [jira] Commented: (DERBY-479) Passing the return of a RETURN NULL ON NULL INPUT function to another function call throws linkage error) (For some reason, that mail from Dan is not showing up in derby dev archives and hence I don't have a direct html link to post here), ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2006-02-23T14:50:59.000+0000","updated":"2006-02-23T14:50:59.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12368068","id":"12368068","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"Patch submitted  - minus changes that were not related to this issue.\r\n\r\nSending        java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\MethodCallNode.java\r\nSending        java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\StaticMethodCallNode.java\r\nSending        java\\testing\\org\\apache\\derbyTesting\\functionTests\\master\\functions.out\r\nSending        java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\lang\\functions.sql\r\nTransmitting file data ....\r\nCommitted revision 381553","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-02-28T12:56:40.000+0000","updated":"2006-02-28T12:56:40.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12369157","id":"12369157","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"The patch fixes the problem test case in functions.sql. Dan, if you have no further comments on this particular issue, I will close it on Wednesday.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2006-03-07T12:45:25.000+0000","updated":"2006-03-07T12:45:25.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12312748/comment/12413279","id":"12413279","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"Back in an earlier comment I said:\r\n\r\nAnother aspect that may not be important, but before this change the conversion nodes are always dropped if they are between Java expressions, and that was incorrect in one situation, functions with RETURNS NULL ON NULL INPUT. Now you have changed it so they are only dropped in one situation, both methods being CALLED ON NULL INPUT (assuming a modified patch). Thus the optimization is being lost in situations where it is useful. Maybe this is not an issue because those siutations typically don't arise any more, but some internal statements that use Java expressions may be losing this optimization.\r\n\r\nHaving worked on triggers recently for DERBY-438 I see that Java expressions are heavily used in accessing data with a trigger's action statement. Thus it would be best to reinstate the optimization of dropping conversion nodes for pure java expressions to avoid performance degradation in 10.2","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-05-26T00:12:37.000+0000","updated":"2006-05-26T00:12:37.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-479/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06wyv:"}}
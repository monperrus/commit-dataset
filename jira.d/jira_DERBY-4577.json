{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12458326","self":"https://issues.apache.org/jira/rest/api/latest/issue/12458326","key":"DERBY-4577","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315564","id":"12315564","description":"First release on the 10.7 branch.","name":"10.7.1.1","archived":false,"released":true,"releaseDate":"2010-12-14"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2010-06-25 09:42:27.718","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24346","customfield_12310222":"1_*:*_1_*:*_9994478206_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2010-06-29T16:57:13.329+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4577/watchers","watchCount":0,"isWatching":false},"created":"2010-03-06T00:42:35.123+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313727","id":"12313727","description":"Feature release","name":"10.6.1.0","archived":false,"released":true,"releaseDate":"2010-05-18"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12332739","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12332739","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12361813","key":"DERBY-2286","self":"https://issues.apache.org/jira/rest/api/2/issue/12361813","fields":{"summary":"Exception NoSpaceOnPage does not provide SQLState or exception text","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12347270","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12347270","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12539208","key":"DERBY-5581","self":"https://issues.apache.org/jira/rest/api/2/issue/12539208","fields":{"summary":"store.LongColumnTest fails with testThreeColumnsShortAndLongAndShort(org.apache.derbyTesting.functionTests.tests.store.LongColumnTest: Unexpected SQL state. expected:<[XSCB6]> but was:<[nospc]>","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"New"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12355332","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12355332","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12598679","key":"DERBY-5858","self":"https://issues.apache.org/jira/rest/api/2/issue/12598679","fields":{"summary":"java.sql.SQLException: nospc.U trying to update a row","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"New"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12367989","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12367989","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12644558","key":"DERBY-6203","self":"https://issues.apache.org/jira/rest/api/2/issue/12644558","fields":{"summary":"Intermittent assert failure in StoredPage.initSlotTable() when running upgrade tests on 10.9 branch","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12330628","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12330628","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12361813","key":"DERBY-2286","self":"https://issues.apache.org/jira/rest/api/2/issue/12361813","fields":{"summary":"Exception NoSpaceOnPage does not provide SQLState or exception text","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-06-19T17:20:09.534+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11412","id":"11412","name":"Store"}],"timeoriginalestimate":null,"description":"An update of a long row piece on an overflow page that has limited row used space, row reserved space, and page free space can throw the nospc.U error on an update.  I will attach a patch with a simple junit test that reproduces this\r\nissue.  \r\n\r\nThis issue is probably the same as DERBY-2286.  Logging a new issue so that it is clear the associated changes fix\r\nthe attached repro.  The repro for DERBY-2286 is random and I could only get it to fail on one machine.  If after the fix\r\nfor this goes in and no one can repro, then we can close DERBY-2286 as a repro.\r\n\r\nThe nospc errror is never meant to get to the user.  The code path that can raise it is shared by insert and update.  \r\nInsert has code that internally catches the error and does the right thing.  The error should never be raised for an update.  What is meant to happen for updates is that on update on any page, including an overflow page should always\r\nin the worst case have enough room to transform the row piece from whatever it is to a just a row header with an\r\noverflow pointer to the next piece.  \r\n\r\nFor the attached test the row piece on the overflow page is 12 bytes reserved, and 0 bytes free on the page.  So \r\nfar in the code path the code has written a preliminary row header that is 4 bytes, and then has noticed that the\r\nremaining 8 bytes are not enough for an overflow pointer (worst case 8 bytes for page number + 4 bytes for record\r\nid).  \r\n\r\nI think the real problem is that not enough minimum space is being reserved on the overflow page.  There should be\r\n12 bytes reserved + the maximum size of a record header that does not include an overflow pointer.   I think the\r\ncode does the right thing in the case of head pages where the minimum reserved space is 12 for the \"user\" portion\r\nof the data, but it looks like we don't apply this reserved space to just user portion on overflow pages.\r\n\r\nI need to research more, but it looks like on overflow pages we apply the minimum reserved space to the entire row\r\nrather than just the user space.\r\n\r\nThe stack trace being thrown in this case is:\r\n2010-03-06 00:18:40.750 GMT:\r\n Booting Derby version The Apache Software Foundation - Apache Derby - 10.6.0.0 alpha - (1): instance 3405c0cb-0127-30d6-6168-ffffe7\r\n008b2c\r\non database directory C:\\derby\\s2\\systest\\out\\junit\\system\\wombat\r\n^M\r\nDatabase Class Loader started - derby.database.classpath=''^M\r\n2010-03-06 00:18:41.171 GMT Thread[main,5,main] (XID = 253), (SESSIONID = 1), (DATABASE = wombat), (DRDAID = null), Cleanup action s\r\ntarting^M\r\n2010-03-06 00:18:41.171 GMT Thread[main,5,main] (XID = 253), (SESSIONID = 1), (DATABASE = wombat), (DRDAID = null), Failed Statement\r\n is: UPDATE testBadUpdate set value = ? where id = ? with 2 parameters begin parameter #1: BLOB:Length=120000 :end parameter begin p\r\narameter #2: 0 :end parameter ^M\r\nERROR nospc: nospc.U^M\r\n    at org.apache.derby.impl.store.raw.data.StoredPage.logRow(StoredPage.java:4106)^M\r\n    at org.apache.derby.impl.store.raw.data.UpdateOperation.writeOptionalDataToBuffer(UpdateOperation.java:255)^M\r\n    at org.apache.derby.impl.store.raw.data.UpdateOperation.<init>(UpdateOperation.java:106)^M\r\n    at org.apache.derby.impl.store.raw.data.LoggableActions.actionUpdate(LoggableActions.java:80)^M\r\n    at org.apache.derby.impl.store.raw.data.StoredPage.doUpdateAtSlot(StoredPage.java:8551)^M\r\n    at org.apache.derby.impl.store.raw.data.BasePage.updateAtSlot(BasePage.java:1062)^M\r\n    at org.apache.derby.impl.store.access.conglomerate.GenericConglomerateController.replace(GenericConglomerateController.java:472)\r\n^M\r\n    at org.apache.derby.impl.sql.execute.RowChangerImpl.updateRow(RowChangerImpl.java:523)^M\r\n    at org.apache.derby.impl.sql.execute.UpdateResultSet.collectAffectedRows(UpdateResultSet.java:554)^M\r\n    at org.apache.derby.impl.sql.execute.UpdateResultSet.open(UpdateResultSet.java:254)^M\r\n    at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:436)^M\r\n    at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:317)^M\r\n    at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1232)^M\r\n    at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1673)^M\r\n    at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeUpdate(EmbedPreparedStatement.java:303)^M\r\n    at org.apache.derbyTesting.functionTests.tests.store.DerbyBugTest2.run_one(DerbyBugTest2.java:224)^M\r\n    at org.apache.derbyTesting.functionTests.tests.store.DerbyBugTest2.testOne(DerbyBugTest2.java:84)^M\r\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)^M\r\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:48)^M\r\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:37)^M\r\n    at java.lang.reflect.Method.invoke(Method.java:600)^M\r\n    at junit.framework.TestCase.runTest(TestCase.java:154)^M\r\n    at junit.framework.TestCase.runBare(TestCase.java:127)^M\r\n    at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:109)^M\r\n    at junit.framework.TestResult$1.protect(TestResult.java:106)^M\r\n    at junit.framework.TestResult.runProtected(TestResult.java:124)^M\r\n    at junit.framework.TestResult.run(TestResult.java:109)^M\r\n    at junit.framework.TestCase.run(TestCase.java:118)^M\r\n    at junit.framework.TestSuite.runTest(TestSuite.java:208)^M\r\n    at junit.framework.TestSuite.run(TestSuite.java:203)^M\r\n    at junit.framework.TestSuite.runTest(TestSuite.java:208)^M\r\n    at junit.framework.TestSuite.run(TestSuite.java:203)^M\r\n    at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)^M\r\n    at junit.extensions.TestSetup$1.protect(TestSetup.java:19)^M\r\n    at junit.framework.TestResult.runProtected(TestResult.java:124)^M\r\n    at junit.extensions.TestSetup.run(TestSetup.java:23)^M\r\n    at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)^M\r\n    at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)^M\r\n    at junit.extensions.TestSetup$1.protect(TestSetup.java:19)^M\r\n    at junit.framework.TestResult.runProtected(TestResult.java:124)^M\r\n    at junit.extensions.TestSetup.run(TestSetup.java:23)^M\r\n    at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)^M\r\n    at junit.framework.TestSuite.runTest(TestSuite.java:208)^M\r\n    at junit.framework.TestSuite.run(TestSuite.java:203)^M\r\n    at junit.textui.TestRunner.doRun(TestRunner.java:116)^M\r\n    at junit.textui.TestRunner.start(TestRunner.java:172)^M\r\n    at junit.textui.TestRunner.main(TestRunner.java:138)^M\r\nCleanup action completed^M","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"35610","summary":"An expanding update fails with an nospc.U error.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10422","value":"High Value Fix","id":"10422"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10101","value":"Release Note Needed","id":"10101"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10424","value":"Repro attached","id":"10424"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":11,"total":11,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12458326/comment/12842134","id":"12842134","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"it is likely that this is same bug as is demonstrated on some machines by the test associated with DERBY-2286.  Defintely has same stack.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2010-03-06T00:43:56.948+0000","updated":"2010-03-06T00:43:56.948+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12458326/comment/12842135","id":"12842135","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"patch with junit test that repro's the bug.  not ready for commit.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2010-03-06T00:46:43.744+0000","updated":"2010-03-06T00:46:43.744+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12458326/comment/12882354","id":"12882354","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"updated note - this fix did not pass tests.  See subsequent patch.\r\n\r\nworking copy of fix.  preliminary, not ready for commit yet.  still running tests.  After \r\nfurther debugging the problem does seem to be isolated to overflow pages.  This \r\npatch fixes the test case which is also in the patch.  That test case was 100%\r\nreproducible on my machine. \r\n\r\nThe overall issue is that the current design to handle expanding updates of rows on both main pages and overflow pages is that it is assumed that each piece can always in the worst case of an expanding update be updated to have a piece that is just an overflow row pointer with all the data moved to another overflow page.  The worst case size of this is 17 bytes which is 1 byte status, 4 bytes record id, 8 bytes overflow page, 4 bytes oveflow record id.  In some cases the space to do this is actually longer than the actual space of an existing row (ie. something like a 1 column blob that has no data in it).  \r\n\r\nOn main pages this is taken care of by the minimum reserve space. The main intent of minimum reserve space is to allow user to specify the amount of space to save for the \"user\" portion of the row.   The system sets a minimum user reserve space of 12 for main page rows.  This works around \"reserve for overflow\" problem as it means there is always space for just the overflow pointer part to come out of the user portion does not include the record header part.  \r\n\r\nOn overflow pages the code does not enforce minimum reserve space, because for user rows it does not make sense.  The point of reserve space is to avoid oveflowing the row on expanding updates to another page.   The system only maintains this reserve space on main pages.\r\n\r\nThus a different mechanism is needed to also insure on overflow pages that there is enough space reserved for the \"reserve for overflow\" problem.  This current patch does this by just making sure overflow rows on insert are always >= 17 bytes including reserve space for the row.  It also changes the code that deals with reclaiming space from shrinking updates to also maintain this 17 byte minimum.  \r\n\r\nGoing through the code the use of minimum reserve space was confusing and I believe inconsistent.  Sometimes it was applied to user space, sometimes to the whole row.  The patch changes the use of this in a few places to make it more consistent.  \r\n\r\nFor anyone reviewing the patch, it is probably easier to look side by side at \r\ncompactRecord() and checkRowReservedSpace() than at the diffs.   Some reformats along with \"real\" code changes went into this area as I was having a\r\nhard time understanding the original logic.   \r\n\r\nThe goal of the change is to only affect the minimum length of rows on overflow pages, so that short rows on main pages should remain the same length.  Also \r\nthis fix only stops the bug from happening to future inserted rows.  Existing \r\noverflow rows may have the problem.  Running offline compress should fix an\r\nexisting table that runs into the problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2010-06-24T21:55:18.347+0000","updated":"2010-06-26T08:10:00.196+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12458326/comment/12882509","id":"12882509","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Hi Mike,\r\n\r\nJust had a quick look at the patch out of curiosity, I did not review the logic properly.\r\nI verified that the test succeeds with the patch, and fails without it.\r\n\r\nSome nits to consider for a next revision (if any):\r\n - any reason why you're not using Math.max() when calculating size_to_reserve?\r\n - mixing tabs and spaces for indentation on changed/new lines\r\n - wrong class name in license header for the test","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2010-06-25T09:42:27.718+0000","updated":"2010-06-25T09:42:27.718+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12458326/comment/12882824","id":"12882824","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"The previous patch had one problem with btree root split, shown up when running\r\nthe full suite in the databasemetadata tests, while running with SANE causing it to throw an assert.   The root had gotten full and had some rows with less than 17 bytes and some more, and the copy to leaf routine was incorrectly applying the 17 byte minimum to all the copied rows and the copy did not work.  \r\n\r\nThe intent of the fix is to only apply the 17 byte minimum to overflow pages, so needed to change storeRecordForInsert to do so.\r\n\r\nThis patch passed all tests run against a SANE against ibm16 on a windows machine.\r\n\r\nI ran the previous patch against the user provided repro in DERBY-2286 and it not fail in a couple of hours against a normal server on a 2 processor, fast linux box.  I got a wierd logging error when I tried to run it against a durability=test build - I believe that is\r\nmore about timing in the logging system than anything I am changing.  I'll file something separate on that if I can reproduce.\r\n\r\nI will run some linux insane tests and look to commit to trunk sometime next week.\r\n\r\nI addressed the test issue brought up.  Will look at doing something about mixed space and leading tabs after the fix.  I just didn't think of the max routine, all this code is pretty low level critical - any opinions on if Math.max is as fast as hand coding using ? operator.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2010-06-26T08:27:01.380+0000","updated":"2010-06-26T08:27:01.380+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12458326/comment/12882879","id":"12882879","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I haven't tested this, but I think it is a fair assumption to expect that the code using the Math.max() method will end up getting optimized to the same native code as the hand-coded expression. Math.max() is a static method and should be easy to inline, according to this writeup [1] by the JVM experts. (It talks about static methods in general, though, not about Math.max() in particular. I read this under Methods: \"Static, private, final, and/or \"special\" invocations are easy to inline.\") And max(int,int) is implemented [2] just like the hand-crafted code in the patch, so inlining the call should be enough to get identical performance.\r\n\r\n[1] http://wikis.sun.com/display/HotSpotInternals/PerformanceTechniques\r\n[2] http://hg.openjdk.java.net/jdk7/jdk7/jdk/file/tip/src/share/classes/java/lang/Math.java","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2010-06-26T18:46:00.801+0000","updated":"2010-06-26T18:46:00.801+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12458326/comment/12883045","id":"12883045","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"For the record, my comment about Math.max was for improved readability only - it's less verbose and people know what the method does.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2010-06-28T07:04:57.248+0000","updated":"2010-06-28T07:04:57.248+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12458326/comment/12883384","id":"12883384","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":" Fixes problem in previous patch where main page rows were being affected during compact rows.  Passes full set of tests on windows and linux.  Also ran with no error against stress test submitted with DERBY-2286","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2010-06-29T02:04:58.027+0000","updated":"2010-06-29T16:45:01.293+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12458326/comment/12883609","id":"12883609","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"change 959027 commits this fix to trunk.\r\ns1_ibm16:16>svn commit\r\n\r\nSending        java\\engine\\org\\apache\\derby\\iapi\\store\\raw\\RawStoreFactory.java\r\nSending        java\\engine\\org\\apache\\derby\\impl\\store\\raw\\data\\StoredPage.java\r\nSending        java\\engine\\org\\apache\\derby\\impl\\store\\raw\\data\\StoredRecordHead\r\ner.java\r\nAdding         java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\store\\Derby4577Test.java\r\nSending        java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\store\\_Suite.java\r\nTransmitting file data .....\r\nCommitted revision 959027.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2010-06-29T16:52:05.480+0000","updated":"2010-06-29T16:52:05.480+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12458326/comment/12883990","id":"12883990","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"adding a release note.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2010-06-30T17:28:13.505+0000","updated":"2010-06-30T17:28:13.505+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12458326/comment/12931508","id":"12931508","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Updating the release note, incorporating Dag's comments on the 10.7.1 release notes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-11-12T19:44:29.793+0000","updated":"2010-11-12T19:44:29.793+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4577/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06gin:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12384857","self":"https://issues.apache.org/jira/rest/api/latest/issue/12384857","key":"DERBY-3288","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313142","id":"12313142","description":"","name":"10.3.3.0","archived":false,"released":true,"releaseDate":"2008-05-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2007-12-18 12:26:11.241","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23548","customfield_12310222":"1_*:*_1_*:*_4511439712_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-02-08T16:37:51.895+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3288/watchers","watchCount":0,"isWatching":false},"created":"2007-12-18T11:27:12.183+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312876","id":"12312876","description":"","name":"10.3.2.1","archived":false,"released":true,"releaseDate":"2007-12-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12318724","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12318724","type":{"id":"12310010","name":"Incorporates","inward":"is part of","outward":"incorporates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310010"},"inwardIssue":{"id":"12354628","key":"DERBY-2034","self":"https://issues.apache.org/jira/rest/api/2/issue/12354628","fields":{"summary":"Tracking of bugs that lead to incorrect results being stored or returned to the client","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/5","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/trivial.png","name":"Trivial","id":"5"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/3","id":"3","description":"A task that needs to be done.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/task.png","name":"Task","subtask":false}}}},{"id":"12319243","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12319243","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12343690","key":"DERBY-1357","self":"https://issues.apache.org/jira/rest/api/2/issue/12343690","fields":{"summary":"Short-circuit logic in optimizer appears to be incorrect...","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-01-21T17:51:14.357+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"The DDL to reproduce the bug is:\n\nCREATE TABLE tab_a (PId BIGINT NOT NULL);\n\nCREATE TABLE tab_c (Id BIGINT NOT NULL PRIMARY KEY, PAId BIGINT NOT NULL, PBId BIGINT NOT NULL);\n\nINSERT INTO tab_c VALUES (91, 81, 82);\nINSERT INTO tab_c VALUES (92, 81, 84);\nINSERT INTO tab_c VALUES (93, 81, 88);\nINSERT INTO tab_c VALUES (96, 81, 83);\n\nCREATE TABLE tab_v (OId BIGINT NOT NULL , UGId BIGINT NOT NULL, val CHAR(1) NOT NULL);\nCREATE UNIQUE INDEX tab_v_i1 ON tab_v (OId, UGId, val);\nCREATE INDEX tab_v_i2 ON tab_v (UGId, val, OId);\n\nINSERT INTO tab_v VALUES (81, 31, 'A'); \nINSERT INTO tab_v VALUES (82, 31, 'A'); \nINSERT INTO tab_v VALUES (83, 31, 'A'); \nINSERT INTO tab_v VALUES (84, 31, 'A'); \nINSERT INTO tab_v VALUES (85, 31, 'A'); \nINSERT INTO tab_v VALUES (86, 31, 'A'); \nINSERT INTO tab_v VALUES (87, 31, 'A'); \nINSERT INTO tab_v VALUES (81, 32, 'A'); \nINSERT INTO tab_v VALUES (82, 32, 'A'); \nINSERT INTO tab_v VALUES (83, 32, 'A'); \nINSERT INTO tab_v VALUES (84, 32, 'A'); \nINSERT INTO tab_v VALUES (85, 32, 'A'); \nINSERT INTO tab_v VALUES (86, 32, 'A'); \nINSERT INTO tab_v VALUES (87, 32, 'A');\n\nCREATE TABLE tab_b (Id BIGINT NOT NULL PRIMARY KEY, OId BIGINT NOT NULL);\n\nINSERT INTO tab_b VALUES (141, 81);\nINSERT INTO tab_b VALUES (142, 82);\nINSERT INTO tab_b VALUES (143, 84);\nINSERT INTO tab_b VALUES (144, 88);\nINSERT INTO tab_b VALUES (151, 81);\nINSERT INTO tab_b VALUES (152, 83);\n\nCREATE TABLE tab_d (Id BIGINT NOT NULL PRIMARY KEY, PAId BIGINT NOT NULL, PBId BIGINT NOT NULL);\n\nINSERT INTO tab_d VALUES (181, 141, 142);\nINSERT INTO tab_d VALUES (182, 141, 143);\nINSERT INTO tab_d VALUES (186, 151, 152);\n\n\nThe query returning the wrong result is:\n\nSELECT tab_b.Id\nFROM tab_b JOIN tab_c ON (tab_b.OId = tab_c.PAId OR tab_b.OId = tab_c.PBId) \nLEFT OUTER JOIN tab_a ON tab_b.OId = PId \nWHERE EXISTS (SELECT 'X' FROM tab_d WHERE (PAId = 141 AND PBId = tab_b.Id) OR (PBId = 141 AND PAId = tab_b.Id)) \n  AND EXISTS (SELECT 'X' FROM tab_v WHERE OId = tab_b.OId AND UGId = 31 AND val = 'A')\n\nThe result should consist of two rows (142),(143), but it returns only one row (142).\n\nThe correct result would be returned if the index tab_v_i1 had been created as non-unique.\n\nThe correct result would also be returned if the condition ...AND val='A' had been replaced by ...AND val='A'  || ''.\n\n\n\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10420","value":"Regression","id":"10420"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37356","summary":"wrong query result in presence of a unique index","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gekhin","name":"gekhin","emailAddress":"g dot khin at ids-scheer dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gerald Khin","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gekhin","name":"gekhin","emailAddress":"g dot khin at ids-scheer dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gerald Khin","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":12,"total":12,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12384857/comment/12552730","id":"12552730","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Marking the issue as a regression, since it works correctly on Derby 10.1.3.1 and earlier releases.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-12-18T12:26:11.241+0000","updated":"2007-12-18T12:26:11.241+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12384857/comment/12555792","id":"12555792","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Regression occurs as of svn # 423754, for DERBY-1357.\r\n\r\nAttaching DERBY-3288.html with some background information and a description of the problem, along with a possible solution.\r\n\r\nAlso attaching a quick patch to implement the solution mentioned in DERBY-3288.html.  The patch is called d3288_incomplete_v1.patch. It is incomplete for two reasons:\r\n\r\n  1) I have not yet added an appropriate test case to the regression suites.\r\n  2) There was one failure in derbyall when I ran with this change\r\n     (SpaceTable.sql). I still need to investigate the failure to see what\r\n     might be going wrong.  suites.All ran cleanly.\r\n\r\nNot sure when I'll have time to follow-up, but I will post when I know more...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2008-01-04T04:38:35.631+0000","updated":"2008-01-04T04:38:35.631+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12384857/comment/12556774","id":"12556774","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Hi Army, thanks for looking at this issue (I marked it as assigned to you).\r\n\r\nYour assessment makes complete sense to me; thanks for writing\r\nthe issues up so clearly and completely!\r\n\r\nTwo questions occurred to me as I read your writeup:\r\n\r\n1) Why is it that TAB_D is dependent on HOJ but TAB_V is not?\r\nBoth of the exists subqueries look very similar to me; they each\r\nseem to be correlated to TAB_B in the HOJ, and isn't that where\r\nthe dependency arises? It isn't really directly relevant to the bug,\r\nI was just hoping you could educate me on why the one subquery\r\nwas dependent on the B-C-A join but the other wasn't.\r\n\r\n2) The way I read your patch, you basically caused steps (3) and (4)\r\nto be done as part of step (1b), which makes complete sense to\r\nme. But it surprised me a bit that you didn't seem to *move* that\r\ncode; rather you inserted *new* code into step (1b). That is, it now\r\nseems like there are multiple places in OptimizerImpl.getNextPermutation()\r\nwhich all seem to be doing the same thing:\r\n - your new code to be inserted at line 589 or so\r\n - The hunk of code at line 809 or so, starting with the comment\r\n    \"We are going to try an optimizable at the current join order position\"\r\n - The hunk of code at line 1093 or so, starting with the comment\r\n    \"Clear the assigned table map\"\r\n\r\nI'm afraid I don't really have a very clear comment to make here; I'm\r\njust observing that getNextPermutation() appears to compute the\r\n\"pullMe\" optimizable twice, and in one case it clears the assignedTableMap\r\nbits but in the other it doesn't, and your patch adds a 3rd place where\r\nwe compute the pullMe optimizable (and clear the assignedTableMap bits).\r\n\r\nPerhaps this question puts my finger most closely on my confusion:\r\n\r\n  Why don't we need to clear the assigned table map bits at line 809?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2008-01-07T23:56:51.055+0000","updated":"2008-01-07T23:56:51.055+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12384857/comment/12556789","id":"12556789","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Thanks for the great questions, Bryan.\r\n\r\n> 1) Why is it that TAB_D is dependent on HOJ but TAB_V is not? \r\n\r\nI admit I don't know.  The process of flattening EXISTS subqueries into specialized FromBaseTables that are called \"existsBaseTables\" is one I have not investigated.  I know it happens, and I know that an \"exist base table\" is one of the primary reasons that dependencies exist, at least according to the comment in FromBaseTable.legalJoinOrder():\r\n\r\n    public boolean legalJoinOrder(JBitSet assignedTableMap)\r\n    {\r\n        // Only an issue for EXISTS FBTs\r\n        if (existsBaseTable)\r\n        {\r\n            /* Have all of our dependencies been satisfied? */\r\n            return assignedTableMap.contains(dependencyMap);\r\n        }\r\n        return true;\r\n    }\r\n\r\nAs you say, it seems like the two EXISTS subqueries are pretty similar, but I do not know what is it that causes a dependency on TAB_D only.  I haven't spent time in that particular piece of the code...\r\n\r\n> 2) [...] It surprised me a bit that you didn't seem to *move* that\r\n> code; rather you inserted *new* code into step (1b). \r\n\r\nI agree with you on this.  I was originally thinking to reorg the code a bit, but then I just wanted to see if I was on track by making the \"quick fix\" and checking the results.  It solved the reported problem so I posted it; but yes, the patch is incomplete and a more formal reorganization of the relevant methods would be a good idea.  I don't know how much time I'll have to look at this over the next many days, so I just did a quick \"drop\" posting of what I found--which is one of the reasons I hadn't officially assigned myself to the issue :)  But you bring up a good point.\r\n\r\n> Why don't we need to clear the assigned table map bits at line 809?\r\n\r\nI don't think this is necessary because the other pullMe code (line 1093) will eventually (in a round-a-bout way) clean up after the missing \"clear assigned table map\" from 809--at least in most cases.  But adding the appropriate code to line 809 may fix this bug and render the other use unnecessary, as well.  If that's true then that would probably be the best final approach.\r\n\r\nAnd of course, there's still the SpaceTable.sql issue to investigate...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2008-01-08T00:58:50.137+0000","updated":"2008-01-08T00:58:50.137+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12384857/comment/12563325","id":"12563325","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Attaching d3288_v2.patch, which is a first attempt a complete solution for this issue.  The patch does the following:\r\n\r\n  1. Move all of the existing \"pull optimizable\" processing out\r\n     of the getNextPermutation() method and into its own method,\r\n     pullOptimizableFromJoinOrder(), for the sake of clarity.\r\n\r\n  2. Add a call to pullOptimizableFromJoinOrder() that updates\r\n     assignedTableMap to correctly reflect the pulling of the\r\n     optimizable in question.\r\n     \r\n  3. Make the getNextPermutation() metod call the new method\r\n     (pullOptimizableFromJoinOrder()) **BEFORE** trying to\r\n     determine what the next legal optimizable for the join\r\n     order can be.\r\n\r\nChanges 1 thru 3 above fix the query as reported in this Jira.\r\n\r\nBut with those changes, store/SpaceTable.sql was failing with an ASSERT failure just as it did for d3288_incomplete_v1.patch.  I looked into this and eventually tracked it down to the fact that the FromVTI class misuses the \"referencedTableMap\" field that it inherits from ResultSetNode.java.  More specifically, that field is intended to hold table numbers for all FromTables which appear at or _beneath_ a given FromTable in the query tree.  But for FromVTI, the referencedTableMap was holding table numbers for all FromTables which were referenced by the _arguments_ to the FromVTI.  As an example, take the following query (which is pulled from store/SpaceTable.sql):\r\n\r\n  select conglomeratename, isindex,\r\n    numallocatedpages, numfreepages, pagesize, estimspacesaving\r\n  from SYS.SYSSCHEMAS s, SYS.SYSTABLES t,\r\n     new org.apache.derby.diag.SpaceTable(SCHEMANAME,TABLENAME) v\r\n  where s.SCHEMAID = t.SCHEMAID\r\n  and s.SCHEMANAME = 'APP'\r\n  order by conglomeratename;\r\n\r\nIn this query SpaceTable will be parsed as a FromVTI and will get its own table number; SYSSCHEMAS and SYSTABLES will each get its own table number, as well.\r\n\r\nThat said, the referencedTableMap for the FromVTI should only contain the table number of the FromVTI itself--because there are no other FromTables beneath the FromVTI in the query tree (esp. FromVTI doesn't have any children nodes that are instances of FromTable).  But with the current codeline, the arguments for SpaceTable will be processed and their table numbers will be added to FromVTI's referencedTableMap, so that FromVTI's referenced table map will contain:\r\n\r\n  { SYSSCHEMAS, SYSTABLES, SpaceTable }\r\n\r\ninstead of\r\n\r\n  { SpaceTable }\r\n\r\nThis confuses the optimizer's dependency checking, which assumes that a FromTable's referenced map only contains table numbers for itself and any FromTable children. The result of this confusion is a join order that puts SpaceTable _before_ SYSSCHEMAS and SYSTABLES, which means that attempts to generate the FromVTI wll fail because the tables that it references have not yet been generated.\r\n\r\nNote that FromVTI _does_ have a dependency on SYSSCHEMAS and SYSTABLES as a result of its arguments--that part is correct.  And the current code _does_ try to enforce that dependency.  But the misuse of referencedTableMap causes the current code to do the wrong thing.  This is because the assignedTableMap used by the Optimizer sets/unsets bits based on the referenced table map.  So we end up in a situation like this:\r\n\r\n  Join order:       { SYSTABLES, SYSSCHEMAS, SpaceTable }\r\n  assignedTableMap: { SYSTABLES, SYSSCHEMAS, SpaceTable }\r\n\r\n  -- Pull SpaceTable from the join order.  We do an XOR between\r\n     assignedTableMap and SpaceTable's referenced table map. Since\r\n\t SpaceTable's referenced table (incorrectly) includes bits\r\n\t for SYSSCHEMAS and SYSTABLES, the XOR yields:\r\n\r\n       Join order:       { SYSTABLES, SYSSCHEMAS, -- }\r\n       assignedTableMap: { }  // this is WRONG!\r\n\r\n     Note how the assignedTableMap is now empty.  This is wrong--\r\n     after the pull there are still two tables in the join order,\r\n     so assignedTablemap should reflect those tables.  But due\r\n     to the FromVTI's incorrect referenced map, assignedTableMap\r\n     no longer matches the join order.\r\n\r\n  -- Pull SYSSCHEMAS from the join order.  We do an XOR between\r\n\t assignedTableMap and SYSSCHEMA's referenced table map,\r\n     yielding:\r\n\r\n       Join order:       { SYSTABLES, --, -- }\r\n       assignedTableMap: { SYSSCHEMAS }\r\n\r\n\t Note how assignedTableMap is STILL wrong here.  Since we\r\n     (incorrectly) cleared assignedTableMap above, the XOR with\r\n     SYSSCHEMAS actually _added_ SYSSCHEMAS to the assigned\r\n     table map, which is the opposite of what were supposed\r\n\t to do.  Since SYSSCHEMAS is no longer in the join order,\r\n\t it should not show up in assignedTableMap.\r\n\r\n  -- Attempt to place SpaceTable in the join order. Since it\r\n     depends on { SYSSCHEMAS, SYSTABLES } and assignedTableMap\r\n     does not include both of those, we can't place it.  So\r\n     we'll pull again...\r\n\r\n  -- Pull SYSTABLES from the join order.  We do an XOR between\r\n\t assignedTableMap and SYSTABLES's referenced table map,\r\n     yielding:\r\n\r\n       Join order:       { --, --, -- }\r\n       assignedTableMap: { SYSSCHEMAS, SYSTABLES }\r\n\r\n\t So our assignedTableMap is completely wrong at this point.\r\n\t Since we (incorrectly) cleared assignedTableMap when we\r\n\t pulled SpaceTable, our assigned table map now indicates that\r\n\t SYSSCHEMAS and SYSTABLES are both already in the join order,\r\n     when in truth the join order is EMPTY at this point.\r\n\r\n  -- Attempt to place SpaceTable in the join order.  Since it\r\n     depends on { SYSSCHEMAS, SYSTABLES } and since assignedTableMap\r\n     incorrectly includes both of those, the optimizer will place\r\n     SpaceTable into the first position in the join order.  We\r\n     end up with:\r\n\r\n       Join order:       { SpaceTable, --, -- }\r\n       assignedTableMap: { SYSSCHEMAS, SYSTABLES, SpaceTable }\r\n\r\nThis becomes the \"cheapest\" join order that the optimizer finds, so this is what Derby will try to generate.  But since SpaceTable depends on SYSSCHEMAS and SYSTABLES, which will only be generated _after_ SpaceTable (because FromTables are generated in the order in which they appear in the join order), the generation code for SpaceTable will fail.\r\n\r\nAll of that to say that FromVTI should not include table numbers for its arguments in its referencedTableMap.  So with that in mind, the d3288_v2.patch also does the following:\r\n\r\n  4. Fix FromVTI to correctly set up its referencedTableMap and\r\n     dependency map, without mixing the two together.\r\n\r\n  5. Remove some assignedTableMap \"clear\" (XOR) logic that appears\r\n     to only have been necessary due to the bug in FromVTI--at least\r\n     as far as I can tell.  Removing this logic makes it so that\r\n     there is now a _single_ place in the code where we \"add to\" the\r\n     assigned table map (namely, when placing an optimizable), and\r\n     there is a _single_ place where we \"remove from\" the assigned\r\n     table map (namely, when pulling an optimizable).\r\n\r\n  6. Add the repro for this issue to the existing lang/subqueryFlattening.sql\r\n     tests, since that's where EXISTS flattening is currently tested.\r\n\r\nI ran derbyall and suites.All with an earlier version of this patch and everything ran cleanly.  Since then I have added a few ASSERT statements to sanity check the contents of assignedTableMap at certain points during the join order processing.  I have not yet run the regression suites with these ASSERTs in place, but plan to do so shortly.\r\n\r\nIn the meantime, if anyone has any comments on the patch as posted, I'd be glad to hear them.\r\n\r\nNote to reviewers: The patch itself is 929 lines, but the vast majority of that comes from the relocation of \"pull optimizable\" processing into its own method.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2008-01-28T22:41:31.323+0000","updated":"2008-01-28T22:41:31.323+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12384857/comment/12563870","id":"12563870","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"I ran the regression tests (derbyall and suites.All) with Sun JVM 1.6.0_04 on Solaris x86 and saw no failures. I have not reviewed the code.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-01-30T07:21:09.101+0000","updated":"2008-01-30T07:21:09.101+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12384857/comment/12565421","id":"12565421","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Thanks for running the regression tests, Kristian.\r\n\r\nIf there are no other comments on this patch, I plan to commit it sometime tomorrow (Tuesday, 02/05 PST), and will  look at porting it to 10.3 by the end of the week...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2008-02-04T16:55:33.904+0000","updated":"2008-02-04T16:55:33.904+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12384857/comment/12565976","id":"12565976","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Committed d3288_v2.patch to trunk with svn # 618841:\r\n\r\n  URL: http://svn.apache.org/viewvc?rev=618841&view=rev\r\n\r\nSetting Fix In to 10.4 and unchecking the \"Patch Available\" flag.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2008-02-06T00:47:38.091+0000","updated":"2008-02-06T00:47:38.091+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12384857/comment/12567084","id":"12567084","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"I ran the \"svn merge\" command to port this change back to 10.3, but the command failed due to a conflict in FromVTI.java caused by changes in were made in 10.4 (as part of DERBY-716) but which were not ported back to 10.3.\r\n\r\nI manually resolved the conflict and created \"d3288_10_3_merge.patch\" for the port to 10.3.  With this patch applied I ran derbyall and suites.All on Linux with ibm142 and saw no failures.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2008-02-08T16:34:53.553+0000","updated":"2008-02-08T16:34:53.553+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12384857/comment/12567087","id":"12567087","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Committed d3288_10_3_merge.patch to 10.3 with svn # 619932:\r\n\r\n  URL: http://svn.apache.org/viewvc?rev=619932&view=rev\r\n\r\nGerald, if you have time to try out the fix, can you do so and report back?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2008-02-08T16:37:51.867+0000","updated":"2008-02-08T16:37:51.867+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12384857/comment/12567660","id":"12567660","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gekhin","name":"gekhin","emailAddress":"g dot khin at ids-scheer dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gerald Khin","active":true},"body":"Army, I tried out the fix you provided: Works fine. Great job!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gekhin","name":"gekhin","emailAddress":"g dot khin at ids-scheer dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gerald Khin","active":true},"created":"2008-02-11T15:13:08.349+0000","updated":"2008-02-11T15:13:08.349+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12384857/comment/12584392","id":"12584392","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"I don't know if fixes for wrong results *regressions* really need a release note or not, but I'm attaching one here anyway.  I am *not* checking the \"Existing Application Impact\" box as I don't know what the rules are for regressions.  If it is agreed that release notes are good for regression fixes, as well, then someone can check the appropriate box to have the release note picked up by the generator tool.  Note: the html file will have to be \"scrubbed\" in order to play nicely with the release note tool.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2008-04-02T03:35:06.040+0000","updated":"2008-04-02T03:35:06.040+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3288/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06ran:"}}
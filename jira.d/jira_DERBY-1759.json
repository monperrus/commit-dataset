{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12348560","self":"https://issues.apache.org/jira/rest/api/latest/issue/12348560","key":"DERBY-1759","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-09-09 04:41:47.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22687","customfield_12310222":"1_*:*_1_*:*_1406305000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_8295000","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-09-09T22:02:47.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1759/watchers","watchCount":0,"isWatching":false},"created":"2006-08-24T15:24:22.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12313170","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12313170","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12325435","key":"DERBY-688","self":"https://issues.apache.org/jira/rest/api/2/issue/12325435","fields":{"summary":"Enhancements to XML functionality to move toward XPath/XQuery support...","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2008-07-25T17:45:29.566+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"The SQL/XML specification dictates that, when serializing a sequence of XML items, the XMLSERIALIZE operator must first \"normalize\" the sequence based on the rules defined here:\n\n  http://www.w3.org/TR/xslt-xquery-serialization/#serdm\n\nThe current Derby implementation doesn't perform such normalization, which leads to two ways in which the results of an XMLSERIALIZE operator may not agree with the required behavior:\n\n  1. Sequences of atomic values will not have spaces between, but\n     the space is required as part of step 3 of the normalization\n     rules at the above link.\n\n  2. Derby will allow serialization of a sequence even if it has\n     a top-level Attribute node in it, but the rules of normalization\n     dictate that an error should be thrown instead (step 7).\n\nBoth of these behaviors can be seen with the following query.\n\nvalues\n  xmlserialize(\n    xmlquery('/ageinfo/@*' passing by ref\n      xmlparse(\n        document '<ageinfo age=\"48\" birthdate=\"1900-02-08\"/>'\n        preserve whitespace\n      )\n      empty on empty\n    )\n    as char(50)\n  )\n\nDerby will currently return the following result from this statement:\n\n1\n--------------------------------------------------\n481900-02-08\n\nThis result does not abide by SQL/XML specification because a) Derby allowed serialization of a sequence having a top-level attribute node (actually, the sequence had two), and b) the atomic values produced from the attributes were displayed without a space between them.\n\nThe correct behavior for the above example is to return a serialization error caused by the presence of an Attribute node in the sequence.\n\nIf the example was rewritten as, say:\n\n-    xmlquery('/ageinfo/@*' passing by ref\n+    xmlquery('fn:data(/ageinfo/@*)' passing by ref\n\nthen the attribute nodes are no longer present--we only have their atomic values, which is allowed.  Thus the correct result should then be:\n\n1\n--------------------------------------------------\n48 1900-02-08\n\nNote, though, that Xalan doesn't appear to support the \"fn:data\" function, so this rewritten query won't actually work.  I tried using Xalan's built-in string function, as follows:\n\n-    xmlquery('/ageinfo/@*' passing by ref\n+    xmlquery('string(/ageinfo/@*)' passing by ref\n\nbut Xalan only returns the first attribute in that case; it doesn't return the second one.  So part of this Jira issue is probably going to involve figuring out how to allow a user to retrieve a sequence of attribute *values* (as opposed to attribute nodes) using Xalan and still abide by the SQL/XML rules.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39418","summary":"XMLSERIALIZE operator doesn't follow SQL/XML spec in some areas when serializing a sequence.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10051","value":"Urgent","id":"10051"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":7,"total":7,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348560/comment/12433286","id":"12433286","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"\r\nAttaching a patch for this issue, d1759_v1.patch.  The patch does the following:\r\n\r\n  1. Adds logic to SqlXmlUtil.serializeToString() to perform the\r\n     steps of \"sequence normalization\" as required by XML serialization\r\n     rules.  This includes throwing an error if the user attempts to\r\n     explicitly serialize a sequence that contains one or more top-level\r\n     attribute nodes.\r\n\r\n  2. In order to ensure that the serialization error is only thrown\r\n     when the user performs an explicit XMLSERIALIZE, I added a\r\n     new field, \"containsTopLevelAttr\", to the XML class.  This field\r\n     indicates whether or not the XML value corresponds to a sequence\r\n     with a top-level attribute node.  If the user calls XMLSERIALIZE\r\n     on an XMLDataValue for which containsTopLevelAttr is true,\r\n     then we'll throw the serialization error 2200W as dictated by\r\n     SQL/XML. \r\n\r\n  3. Adds appropriate test cases to lang/xml_general.sql to verify\r\n     the fix.\r\n\r\n  4. Since Xalan doesn't provide a built-in way to retrieve a sequence\r\n     of attribue values (as opposed to attribute nodes), I also included\r\n     in lang/xml_general.sql a (rather ugly) way to accomplish that\r\n     task within the serialization restrictions of SQL/XML.\r\n\r\nI also added logic to put spaces between adjacent atomic values in a result sequence, per XML \"sequence normalization\" rules.  However, I didn't add any test cases for this because I couldn't come up with an XPath query that would actually return such a sequence.  Nonetheless, the relevant logic seems straightforward and I have included it in this patch.\r\n\r\nI ran xmlSuite with these changes against insane jars with ibm142 on Windows 2000 and all tests passed.  I plan to run derbyall as a sanity check tonight but do not expect any failures since the changes are all limited to XML.  In the meantime, any early feedback/review/comments would be much appreciated.  Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-09-08T00:52:33.000+0000","updated":"2006-09-08T00:52:33.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348560/comment/12433423","id":"12433423","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"I ran derbyall against insane jars with ibm142 on Red Hat Linux and there were no new failures.  So the d1759_v1.patch is ready for review/commit.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-09-08T15:25:40.000+0000","updated":"2006-09-08T15:25:40.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348560/comment/12433561","id":"12433561","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"I'm afraid I don't have much to offer regarding the sequence-of-attribute-values issue.\r\n\r\nThe patch applied and built cleanly. My derbyall run was also successful. With Xalan 2.7,\r\nI got the expected results for lang/xmlBinding.java and lang/xml_general.sql. The\r\npatch description is clear and makes sense, and the code in the patch appears to\r\nmatch the patch description.\r\n\r\nI committed this patch to subversion as revision 441740. Thanks as usual for the\r\nclear patch description, the careful commenting and attention to detail in the code,\r\nand the test cases. Reviewing such changes is a pleasure!\r\n\r\nDo we need to merge this change to 10.2?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-09-09T04:41:47.000+0000","updated":"2006-09-09T04:41:47.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348560/comment/12433600","id":"12433600","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Thanks, as always, for the careful review and subsequent commit, Bryan.  I appreciate your time!\r\n\r\nYes, I would like this patch to be merged to 10.2, if possible.  Should I leave \"Patch Available\" checked until that happens, or uncheck that box and just leave the issue open?\r\n\r\nThanks again!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-09-09T14:14:22.000+0000","updated":"2006-09-09T14:14:22.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348560/comment/12433602","id":"12433602","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"I intend to merge revision 441740 to the 10.2 branch today. The merge and build were clean.\r\nI'm running some tests just to be sure.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-09-09T14:30:42.000+0000","updated":"2006-09-09T14:30:42.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348560/comment/12433650","id":"12433650","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Merged from trunk to 10.2 branch. Merge was clean, build and tests went well.\r\nCommitted to subversion as revision 441864. Army, can you confirm and close?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-09-09T22:02:47.000+0000","updated":"2006-09-09T22:02:47.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348560/comment/12433653","id":"12433653","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Verified that changes are in main and 10.2 branches by visual inspection and by running the XML tests.  So closing the issue.\r\n\r\nThanks Bryan!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-09-10T00:21:02.000+0000","updated":"2006-09-10T00:21:02.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1759/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0740v:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12346494","self":"https://issues.apache.org/jira/rest/api/latest/issue/12346494","key":"DERBY-1574","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-07-25 20:24:28.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22573","customfield_12310222":"1_*:*_1_*:*_2030196000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_39579678540","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-08-15T12:57:45.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1574/watchers","watchCount":1,"isWatching":false},"created":"2006-07-23T01:01:09.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10920","id":"10920","description":"initial source drop","name":"10.0.2.0","archived":false,"released":true,"releaseDate":"2004-08-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/10991","id":"10991","description":"snapshot","name":"10.0.2.1","archived":false,"released":true,"releaseDate":"2004-12-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/10992","id":"10992","name":"10.0.2.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12310615","id":"12310615","description":"","name":"10.1.2.1","archived":false,"released":true,"releaseDate":"2005-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12311972","id":"12311972","description":"","name":"10.1.3.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313478","id":"12313478","description":"Head of 10.1 branch. Maintenance version bump for sps update ","name":"10.1.3.3","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12330290","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12330290","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12456398","key":"DERBY-4549","self":"https://issues.apache.org/jira/rest/api/2/issue/12456398","fields":{"summary":"NPE in JBitSet","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-07-05T17:32:55.881+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"The following statements generate a NullPointerException:\n\nCREATE TABLE t1 (i INTEGER);\nCREATE TABLE t2 (i INTEGER);\n\nUPDATE t1\n   SET i = COALESCE(\n      (SELECT i FROM t2 WHERE t2.i=t1.i),\n      0);\n\nAny further SQL statements generate an internal error in RawStore, e.g.:\nSELECT * FROM t1;","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37974","summary":"NullPointerException in UPDATE with COALESCE and subquery","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chdh%40inventec.ch","name":"chdh@inventec.ch","emailAddress":"chdh at inventec dot ch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Christian d'Heureuse","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chdh%40inventec.ch","name":"chdh@inventec.ch","emailAddress":"chdh at inventec dot ch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Christian d'Heureuse","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Java 1.5.0_06","customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":9,"total":9,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346494/comment/12423439","id":"12423439","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"If at all possible always include the full stack trace from derby.log when reporting a bug.  Here is the \r\nstack  from the original problem against the trunk showing that the issue is in the optimizer:\r\n\r\n2006-07-25 20:19:59.104 GMT Thread[main,5,main] (XID = 131), (SESSIONID = 0), (D\r\nATABASE = wombat), (DRDAID = null), Failed Statement is: UPDATE t1^M\r\n   SET i = COALESCE(^M\r\n      (SELECT i FROM t2 WHERE t2.i=t1.i),^M\r\n      0)^M\r\njava.lang.NullPointerException^M\r\n    at org.apache.derby.iapi.util.JBitSet.or(JBitSet.java:241)^M\r\n    at org.apache.derby.impl.sql.compile.OptimizerImpl.<init>(OptimizerImpl.java\r\n:254)^M\r\n    at org.apache.derby.impl.sql.compile.Level2OptimizerImpl.<init>(Level2Optimi\r\nzerImpl.java:76)^M\r\n    at org.apache.derby.impl.sql.compile.Level2OptimizerFactoryImpl.getOptimizer\r\nImpl(Level2OptimizerFactoryImpl.java:98)^M\r\n    at org.apache.derby.impl.sql.compile.OptimizerFactoryImpl.getOptimizer(Optim\r\nizerFactoryImpl.java:159)^M\r\n    at org.apache.derby.impl.sql.compile.ResultSetNode.getOptimizer(ResultSetNod\r\ne.java:1635)^M\r\n    at org.apache.derby.impl.sql.compile.SelectNode.optimize(SelectNode.java:163\r\n9)^M\r\n    at org.apache.derby.impl.sql.compile.SubqueryNode.optimize(SubqueryNode.java\r\n:1683)^M\r\n    at org.apache.derby.impl.sql.compile.SubqueryList.optimize(SubqueryList.java\r\n:121)^M\r\n    at org.apache.derby.impl.sql.compile.SelectNode.optimize(SelectNode.java:166\r\n4)^M\r\n    at org.apache.derby.impl.sql.compile.DMLStatementNode.optimize(DMLStatementN\r\node.java:328)^M\r\n    at org.apache.derby.impl.sql.compile.DMLModStatementNode.optimize(DMLModStat\r\nementNode.java:1352)^M\r\n    at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.ja\r\nva:395)^M\r\n    at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:\r\n118)^M\r\n    at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareIn\r\nternalStatement(GenericLanguageConnectionContext.java:713)^M\r\n    at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:567\r\n)^M\r\n    at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:516\r\n)^M\r\n    at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:313)^M\r\n    at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:433)^M\r\n    at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:310)^M\r\n    at org.apache.derby.impl.tools.ij.Main.go(Main.java:207)^M\r\n    at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:173)^M\r\n    at org.apache.derby.impl.tools.ij.Main14.main(Main14.java:55)^M\r\n    at org.apache.derby.tools.ij.main(ij.java:60)^M\r\nCleanup action completed^M\r\n\r\nSubsequent errors in raw store indicates there is also an error handling problem in the optimizer code\r\nwhich leaves the execution context unusable for subsequent queries.  The error is:\r\n\r\nERROR 40XT0: An internal error was identified by RawStore module.^M\r\n    at org.apache.derby.iapi.error.StandardException.newException(StandardExcept\r\nion.java:294)^M\r\n    at org.apache.derby.impl.store.raw.xact.Xact.setActiveState(Xact.java:1772)^\r\nM\r\n    at org.apache.derby.impl.store.raw.xact.Xact.openContainer(Xact.java:1271)^M\r\n    at org.apache.derby.impl.store.access.conglomerate.OpenConglomerate.init(Ope\r\nnConglomerate.java:865)^M\r\n    at org.apache.derby.impl.store.access.heap.Heap.open(Heap.java:614)^M\r\n    at org.apache.derby.impl.store.access.RAMTransaction.openConglomerate(RAMTra\r\nnsaction.java:478)^M\r\n    at org.apache.derby.impl.store.access.RAMTransaction.openConglomerate(RAMTra\r\nnsaction.java:1315)^M\r\n    at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getDescriptorViaInde\r\nx(DataDictionaryImpl.java:7339)^M\r\n    at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.locateSchemaRow(Data\r\nDictionaryImpl.java:1532)^M\r\n    at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getSchemaDescriptor(\r\nDataDictionaryImpl.java:1442)^M\r\n    at org.apache.derby.impl.sql.compile.QueryTreeNode.getSchemaDescriptor(Query\r\nTreeNode.java:1504)^M\r\n    at org.apache.derby.impl.sql.compile.QueryTreeNode.getSchemaDescriptor(Query\r\nTreeNode.java:1456)^M\r\n    at org.apache.derby.impl.sql.compile.FromBaseTable.bindTableDescriptor(FromB\r\naseTable.java:2379)^M\r\n    at org.apache.derby.impl.sql.compile.FromBaseTable.bindNonVTITables(FromBase\r\nTable.java:2107)^M\r\n    at org.apache.derby.impl.sql.compile.FromList.bindTables(FromList.java:300)^\r\nM\r\n    at org.apache.derby.impl.sql.compile.SelectNode.bindNonVTITables(SelectNode.\r\njava:472)^M\r\n    at org.apache.derby.impl.sql.compile.DMLStatementNode.bindTables(DMLStatemen\r\ntNode.java:220)^M\r\n    at org.apache.derby.impl.sql.compile.DMLStatementNode.bind(DMLStatementNode.\r\njava:158)^M\r\n    at org.apache.derby.impl.sql.compile.CursorNode.bind(CursorNode.java:252)^M\r\n    at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.ja\r\nva:344)^M\r\n    at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:\r\n118)^M\r\n    at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareIn\r\nternalStatement(GenericLanguageConnectionContext.java:713)^M\r\n    at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:567\r\n)^M\r\n    at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:516\r\n)^M\r\n    at org.apache.derby.impl.tools.ij.ij.executeImmediate(ij.java:313)^M\r\n    at org.apache.derby.impl.tools.ij.utilMain.doCatch(utilMain.java:433)^M\r\n    at org.apache.derby.impl.tools.ij.utilMain.go(utilMain.java:312)^M\r\n    at org.apache.derby.impl.tools.ij.Main.go(Main.java:207)^M\r\n    at org.apache.derby.impl.tools.ij.Main.mainCore(Main.java:173)^M\r\n    at org.apache.derby.impl.tools.ij.Main14.main(Main14.java:55)^M\r\n    at org.apache.derby.tools.ij.main(ij.java:60)^M\r\nCleanup action completed^M","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2006-07-25T20:24:28.000+0000","updated":"2006-07-25T20:24:28.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346494/comment/12423449","id":"12423449","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"> Here is the stack from the original problem against the trunk showing that the issue is in the optimizer: \r\n\r\nFor the record, I ran the simple repro against an early version of 10.1(10.1.2.3) and also against 10.0, and the NPE reproduces for both of those codelines, as well.  So in case anyone is wondering (I know I was), this is *not* a regression.  For what that's worth...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-07-25T20:46:17.000+0000","updated":"2006-07-25T20:46:17.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346494/comment/12423453","id":"12423453","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"AS posted to list:\r\nA B commented on DERBY-1574:\r\n----------------------------\r\nFor the record, I ran the simple repro against an early version of 10.1(10.1.2.3) and also against 10.0, and the NPE reproduces for both of those codelines, as well.  So in case anyone is wondering (I know I was), this is *not* a regression.  For what that's worth...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2006-07-25T20:57:57.000+0000","updated":"2006-07-25T20:57:57.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346494/comment/12423456","id":"12423456","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Adding additional versions to the \"Affects\" list, per my previous comment.  Since I was able to reproduce the problem in my 10.0, 10.1, and 10.2 codelines I just set everything from 10.0 and forward as affected.  If that's not the correct thing to do, please advise and/or update as appropriate.  Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-07-25T21:03:08.000+0000","updated":"2006-07-25T21:03:08.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346494/comment/12423755","id":"12423755","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"I looked at it out of curiosity (I am not very familiar with this part\r\nof the code); it seems the problem is related to the fact that the\r\npreprocess phase has not been run prior to the optimize phase for the\r\nsubquery, leading to the referencedTableMap being empty (immediate\r\ncause for NPE).\r\n\r\nI made this experiment patch which seems to work for the case in the\r\nissue.  It should not be committed until someone more knowledgeable of\r\nthis part of the code has looked at it (it may be altogether the wrong\r\nsolution for all I know). Also I had to guess a bit at where the call to\r\npreprocess should be placed as well as the arguments, so caveats apply.\r\n\r\nI ran derbylang, but had a small diff in the execution plan (enclosed).\r\nIt may not be a problem, not sure.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2006-07-27T02:41:44.000+0000","updated":"2006-07-27T02:41:44.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346494/comment/12423885","id":"12423885","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"body":"To me it seems CoalesceFunctionNode should provide a preprocess method but I'm not an authority either! While working on 883, I noticed that CoalesceFunctionNode didn't implement the accept method which caused a NPE with group by's. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"created":"2006-07-27T18:26:20.000+0000","updated":"2006-07-27T18:26:20.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346494/comment/12424182","id":"12424182","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Thanks, Manish!\r\nSo I tried to put the preprocess forwarding into CoalesceFunctionNode,\r\nand that works too. It also looks more in line with the\r\npresent design, so I have proceeded with that solution.\r\n\r\nThis patch \r\n- adds a preprocess method to CoalesceFunctionNode to override the one\r\n  in ValueNode, thus making sure the arguments get handled.\r\n- adds a printSubNodes method to CoalesceFunctionNode (was missing\r\n  too, I discovered, when I was trying to look at the parse tree after\r\n  binding).\r\n- adds a new test case to coalesceTests.java and an updated master\r\n\r\nI have run derbyall without errors and also run the modified test to verify that \r\nit exposes the problem in absence of the fix. The patch is ready for review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2006-07-28T21:40:43.000+0000","updated":"2006-07-28T21:40:43.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346494/comment/12426994","id":"12426994","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"body":"I have reviewed the latest patch and it looks good.  I confirmed that without this patch, it will throw NPE from the above case.  After applying the patch, The arguments in the coalesce now gets handled properly and returns the expected result:\r\n\r\nij> update t1 set i = coalesce((select i from t2 where t2.i=t1.i), 0);\r\n0 rows inserted/updated/deleted\r\nWARNING 02000: No row was found for FETCH, UPDATE or DELETE; or the result of a query is an empty table.\r\n\r\nI think this patch is ready to be committed.  +1","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"created":"2006-08-09T17:57:13.000+0000","updated":"2006-08-09T17:57:13.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12346494/comment/12428124","id":"12428124","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks Dag for fixing the bug, and Yip for reviewing the patch. Committed revision 431593.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-08-15T12:57:45.000+0000","updated":"2006-08-15T12:57:45.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1574/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06v3z:"}}
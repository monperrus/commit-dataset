{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12352818","self":"https://issues.apache.org/jira/rest/api/latest/issue/12352818","key":"DERBY-1947","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2007-03-24 16:32:21.888","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22809","customfield_12310222":"1_*:*_1_*:*_16916635945_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_17857570682","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2007-04-23T22:47:25.945+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1947/watchers","watchCount":3,"isWatching":false},"created":"2006-10-10T03:43:30.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"11.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10920","id":"10920","description":"initial source drop","name":"10.0.2.0","archived":false,"released":true,"releaseDate":"2004-08-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/10991","id":"10991","description":"snapshot","name":"10.0.2.1","archived":false,"released":true,"releaseDate":"2004-12-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12310615","id":"12310615","description":"","name":"10.1.2.1","archived":false,"released":true,"releaseDate":"2005-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12315877","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12315877","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12346613","key":"DERBY-1585","self":"https://issues.apache.org/jira/rest/api/2/issue/12346613","fields":{"summary":"derbylang/procedureInTrigger: not able to create trigger due to an open ResultSet","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12315570","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12315570","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12365617","key":"DERBY-2480","self":"https://issues.apache.org/jira/rest/api/2/issue/12365617","fields":{"summary":"DriverManager.getConnection leaks memory when connecting to a non-existent database","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-11-16T15:13:36.613+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11415","id":"11415","name":"Services"}],"timeoriginalestimate":null,"description":"I came across this OOM issue while running some system tests involving\nbackup and restore against  Derby. The test is expected to run forever but\nusing the default heap space it runs into OOM within 2 days. I earlier mentioned about this\nin my reply to the 10.2.1.6 vote - http://www.nabble.com/Re%3A--VOTE--10.2.1.6-release-p6650528.html\n\n\nAlso there has been some discussions on the list on the related topic:\nhttp://issues.apache.org/jira/browse/DERBY-23 and\nhttp://www.nabble.com/question-about-shutdown-tf2300504.html\n\n\nBasic Analysis:\n--------------------\n\nWrote a simple Java app (attached to this issue) that booted and shutdown the same \ndatabase multiple times. Depending on the heapsize the program ran into the\nOOM at some point, as expected. Some heap dump analysis using the IBM HeapAnalyzer \nand revealed that the HashSet (allContexts) within org.apache.derby.iapi.services.context.ContextService \nclass seemed to be location of the leak (snapshot of the heapanalysis attached).\n\nA little bit of debugging shows that:\n - for every:connection two ContextManager objects (say, cm1, cm2) are added to the HashSet\n - for every shutdown a new ContextManager object (say, cm3) is added and two objects are removed\n - the object removed are cm2 and cm3 - in that sequence\n - but the object cm1 gets left behind\n\nThis happens for every connect/shutdown sequence and since one of the ContextManager objects added to the \nHashSet is not removed as a part of the cleanup, it contributes to growth in memory usage, hence\nan OOM eventually.\n\nFor example:\n============\nA 64M heap could allow about 1107 iterations of connect/shutdown only before running into OOM and \ncreated 1108 un-used ContextManager objects in the memory.\n\njava -Xmx64M testEmbedAndClient\n++++Debug: add() Size of allContexts HashSet obj= 1\n----Debug: remove() Size of allContexts HashSet obj= 0\n++++Debug: add() Size of allContexts HashSet obj= 1\n----Debug: remove() Size of allContexts HashSet obj= 0\n++++Debug: add() Size of allContexts HashSet obj= 1\n++++Debug: add() Size of allContexts HashSet obj= 2\n\n==== Database booted in embedded ====\n\n++++Debug: add() Size of allContexts HashSet obj= 3\n----Debug: remove() Size of allContexts HashSet obj= 2\n----Debug: remove() Size of allContexts HashSet obj= 1\n\n==== Shutdown complete in embedded ====\n\n++++Debug: add() Size of allContexts HashSet obj= 2\n++++Debug: add() Size of allContexts HashSet obj= 3\n\n==== Database booted in embedded ====\n\n++++Debug: add() Size of allContexts HashSet obj= 4\n----Debug: remove() Size of allContexts HashSet obj= 3\n----Debug: remove() Size of allContexts HashSet obj= 2\n..\n..\n..\n==== Database booted in embedded ====\n\n++++Debug: add() Size of allContexts HashSet obj= 1109\n----Debug: remove() Size of allContexts HashSet obj= 1108\n----Debug: remove() Size of allContexts HashSet obj= 1107\n\n==== Shutdown complete in embedded ====\n\n++++Debug: add() Size of allContexts HashSet obj= 1108\n++++Debug: add() Size of allContexts HashSet obj= 1109\n----Debug: remove() Size of allContexts HashSet obj= 1108\njava.sql.SQLException: Failed to start database 'testdb', see the next exception\n for details.\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)\n        at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:89)\n        at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:95)\n        at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Util.java:174)\n\n        at org.apache.derby.impl.jdbc.EmbedConnection.newSQLException(EmbedConnection.java:1985)\n        at org.apache.derby.impl.jdbc.EmbedConnection.bootDatabase(EmbedConnection.java:1649)\n        at org.apache.derby.impl.jdbc.EmbedConnection.<init>(EmbedConnection.java:223)\n        at org.apache.derby.impl.jdbc.EmbedConnection30.<init>(EmbedConnection30.java:73)\n        at org.apache.derby.jdbc.Driver30.getNewEmbedConnection(Driver30.java:74)\n        at org.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:210)\n\n----Debug: remove() Size of allContexts HashSet obj= 1107\n        at org.apache.derby.jdbc.AutoloadedDriver.connect(AutoloadedDriver.java:117)\n        at java.sql.DriverManager.getConnection(DriverManager.java:525)\n        at java.sql.DriverManager.getConnection(DriverManager.java:193)\n        at testEmbedAndClient.testInEmbedded(testEmbedAndClient.java:40)\n        at testEmbedAndClient.main(testEmbedAndClient.java:19)\njava.lang.OutOfMemoryError: Java heap space\n\nOOM happened after 1107 iterations\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39766","summary":"OutOfMemoryError after repeated calls to boot and shutdown a database","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kartha","name":"kartha","emailAddress":"kartha02 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Kartha","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kartha","name":"kartha","emailAddress":"kartha02 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Kartha","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Any","customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":16,"total":16,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12441042","id":"12441042","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kartha","name":"kartha","emailAddress":"kartha02 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Kartha","active":true},"body":"Attaching the files I mentioned in the description of this issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kartha","name":"kartha","emailAddress":"kartha02 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Kartha","active":true},"created":"2006-10-10T03:45:26.000+0000","updated":"2006-10-10T03:45:26.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12483854","id":"12483854","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"My analysis of this problem:\r\n\r\n* When EmbedConnection#close is called from testEmbedAndClient.java:50, the\r\n  call fails to clean up the connection properly, since the call to the\r\n  private EmbedConnection#close(StandardException) never happens.\r\n\r\n  This is due to the fact that the public close method first checks if\r\n  the connection is already closed via a call to\r\n  EmbedConnection#isClosed(). If so, close just returns,\r\n\r\n  EmbedConnection#isClosed() returns true even though the connection is still\r\n  marked as active, because the underlying database has been shut down. This\r\n  fact makes TransactionResourceImpl#isActive() return false.\r\n\r\n  Now, the connection objects and the TransactionResourceImpl will eventually\r\n  be garbage collected, but the ContextManager object owned by\r\n  TransactionResourceImpl, will not, leading to the memory leak.  This is\r\n  because the ContextManager object is referenced from the HashSet\r\n  'allContexts' of the ContextService.\r\n\r\n  Normally, the context manager object is removed from 'allContexts' when the\r\n  EmbedConnection#close(exceptionclose) calls\r\n  TransactionResourceImpl#cleanupOnError. However, it does not happen here\r\n  since isClosed returns true, so EmbedConnection#close() never gets\r\n  to call EmbedConnection#close(exceptionclose).\r\n\r\n  Modifying the repro to never close the connection object, I also see\r\n  the leak, since EmbedConnection#finalize similarly fails to call\r\n  EmbedConnection#close(exceptionclose) when isClosed() returns true.\r\n\r\n  More detail (feel free to skip ;)\r\n\r\n  TransactionResourceImpl#cleanupOnError, in turn, calls\r\n  ContextManager#cleanupOnError which, when popping its stack of contexts\r\n  finally calls the stack's bottom SystemContext#cleanupOnError, which again\r\n  makes this call on line 62:\r\n\r\n      :\r\n      getContextManager().owningCsf.removeContext(getContextManager());\r\n      :\r\n\r\n  which releases the context manager from 'allContexts' so it can be garbage\r\n  collected.\r\n\r\n\r\n* I have made a patch which makes the repro (and the modified repro I\r\n  mentioned) work without running out of space: DERBY-1947-1.{diff,stat}.\r\n\r\n  It modifies EmbedConnection#close to clean up in the case described\r\n  above.\r\n\r\n  It also adds a finalizer method to TransactionResourceImpl which\r\n  calls ContextManager#cleanupOnError with an argument of\r\n  StandardException.closeException(), if not done already.  This\r\n  catches the case when no close is called on the connection.  This\r\n  change would make the leak go away on its own for both repro cases,\r\n  but I added the change to EmbedConnection#close also, since it\r\n  purports to release database resources in its Javadoc.\r\n\r\n  So, when the connection is closed or garbage collected, the\r\n  ContextManager will be cleaned up as well, and the leak is plugged.\r\n\r\n  suites.All and derbyall ran without incident on Sun JDK 1.6, Solaris\r\n  10/x86.\r\n\r\n* There is a related issue, DERBY-2480, for which Jeff Clary has\r\n  produced a patch. They overlap, in that that both patches makes a\r\n  changes to EmbedConnection#close, so we need to reconcile them for\r\n  that method. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2007-03-24T16:32:21.888+0000","updated":"2007-03-24T16:32:21.888+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12483856","id":"12483856","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Please disregard the paragraph quoted below in my previous comment, the\r\ncorrect version is given below (the original text reflects my first attempt\r\nat the patch :)\r\n\r\n> It also adds a finalizer method to TransactionResourceImpl which\r\n> calls ContextManager#cleanupOnError with an argument of\r\n> StandardException.closeException(), if not done already. \r\n\r\nIt also adds a finalizer method to EmbedConnection which\r\ncalls TransactionResourceImpl#cleanupOnError with an argument of\r\nStandardException.closeException(), if not done already.  \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2007-03-24T16:41:56.127+0000","updated":"2007-03-24T16:41:56.127+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12483951","id":"12483951","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"It seems like it would be nice if, instead of adding more code to\r\nEmbedConnection.close(), we could instead just have EmbedConnection.close()\r\ncall EmbedConnection.close(StandardException), and have all the\r\nEmbedConnection closing logic in one place. Right now there seems to\r\nbe logic in two EmbedConnection.close() methods, and also in the\r\nfinalize() method. Can it all be moved to the one close(exception) method\r\nand have the other two be 1-line wrappers?\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-03-25T15:32:10.755+0000","updated":"2007-03-25T15:32:10.755+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12484614","id":"12484614","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Thanks for looking at this, Bryan!\r\n\r\nUploading a modified patch DERBY-1947-2 (supercedes DERBY-1947-1)\r\nwhich addresses Bryan's comment, although I did not *quite* manage to\r\nmake it a one-liner ;)\r\n\r\nI also noticed that the isClosed() method changes the internal state\r\nvariable 'active', thwarting the logic needed to get the cleanup done,\r\nso I removed the call to setInactive() from isClosed(). I believe this\r\nis safe. [Alterately, one call do all the cleanup needed from inside\r\nisClosed() if the underlying transaction is not active.]\r\n\r\nI further simplified the finalizer by removing the test for rootConnection\r\nsince this is done inside close(StandardException) anyway.\r\n\r\nI verified the patch against the repro again, including the modified one\r\nI described for the previous patch. I did not add a new test for this issue.\r\n\r\nI ran derbyall and suites.All again with the patch against svn 521401\r\nwith successfully (modulo the often seen dblook error in derbyall),\r\nSolaris 10/x86, Sun JDK1.6.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2007-03-27T22:00:36.035+0000","updated":"2007-03-27T22:00:36.035+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12484667","id":"12484667","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Hi Dag, the new patch looks very good to me. This sort of close\r\nlogic always seems to be a bit finicky, but I think you've got it\r\nnicely packaged now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-03-28T01:15:52.479+0000","updated":"2007-03-28T01:15:52.479+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12489576","id":"12489576","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"I was getting ready to commit the patch for this issue, but then I\r\nupdated my trunk and found that the following newly\r\nintroduced/converted JUnit test makes Derby deadlock when the patch\r\n(DERBY-1947-2) is active:\r\n\r\n  ProcedureInTriggerTest\r\n\r\nIt looks like a deadlock in the VM (see also enclosed stacks of\r\ninvolved threads) caused by the patch's use of finalizer code which\r\nleads to synchronization, and I am at a loss presently for how to\r\nresolve this best.\r\n\r\nWhat seems to happen is this:\r\n \r\n* In ProcedureInTriggerTest:388, a call to Stement#execute is performed:\r\n   > s.execute(\"create trigger select_from_trig_table no cascade before \" + \r\n                               \"delete on t1 for each STATEMENT call proc_reads_sql(1)\");\r\n\r\n  This call synchronizes on the current (root) connection object.\r\n\r\n* At this time I believe there are still two nested connection objects\r\n  from previous statements (the test uses triggers and stored\r\n  procedures called from them), which are no longer referenced but for\r\n  whom the finalizer has yet to run (not yet garbage collected).\r\n\r\n* Now, the CreateTriggerConstantAction#executeConstantAction in line\r\n  275 uses the Dependency manager to send an invalidate to the trigger\r\n  table so that DML statements on this table will be recompiled.  (see\r\n  stack of thread \"main\" in attachment\r\n  ProcedureInTriggerTest-threadstacks.txt).\r\n\r\n* As a result of this, GenericPreparedStatement#prepareToInvalidate is\r\n  called which again calls\r\n  GenericLanguageConnectionContext#verifyNoOpenResultSets\r\n\r\n* verifyNoOpenResultSets contains this sequence of calls:\r\n\r\n  \t// There may be open ResultSet's that are yet to be garbage collected\r\n        // let's try and force these out rather than throw an error\r\n        System.gc();\r\n        System.runFinalization();\r\n\r\n* This last call causes deadlock. This seems to happens because the\r\n  said nested connection's finalizers are attempted executed.  With\r\n  the patch, the finalizer of EmbedConnection contains a call to\r\n  EmbedConnection#close which synchronizes on the root connection\r\n  object (already locked by the \"main\" thread as part of the execute).\r\n  The execution of the finalizer happens in a thread forked by the\r\n  call to System.runFinalization(), which hangs waiting for the\r\n  finalizer thread to complete (see Finalizer#forkSecondaryFinalizer's\r\n  call to sft.join() ca line 115 in Sun JDK 1.6). Now, the finalizers\r\n  are stuck waiting for the lock held my \"main\", so deadlock ensues.\r\n\r\n* Now, without the call to System.runFinalization(); the test runs\r\n  successfully, presumably because the two connection objects will\r\n  then be garbage collected later, after s.execute() has terminated.\r\n\r\n  Also, removing the call to System.gc() removes the deadlock, but\r\n  this breaks the test however (verifyNoOpenResultSets throws X0X95.S\r\n  - LANG_CANT_INVALIDATE_OPEN_RESULT_SET in line 1733):\r\n    \r\n     \"Operation 'CREATE TRIGGER' cannot be performed on object 'T1'\r\n      because there is an open ResultSet dependent on that object.\"\r\n\r\n  So it would seem that calling System.gc() is sufficient, but\r\n  System.runFinalization is harmful, since it will wait for\r\n  finalization to finish, which is a dangerous thing if the thread\r\n  already holds locks. *Or* one could argue that the finalizers should\r\n  never call anything that could require a lock (too strict in my\r\n  view).\r\n\r\nSo, now I am trying to understand what would be the correct approach\r\nto resolve this.\r\n\r\n- Without the call to close in the finalizer of EmbedConnection, we\r\n  have DERBY-1947, that is, ContextManager objects is referenced from\r\n  the HashSet 'allContexts' of the ContextService may leak.\r\n\r\n- With the call to close in the finalizer of EmbedConnection, we risk\r\n  deadlock as long as any Derby code calls System.runFinalization()\r\n  anywhere. Grepping, i see this happens in three places in the\r\n  engine:\r\n        \r\n  LowMemory.java:95: System.runFinalization();\r\n  GenericLanguageConnectionContext.java:1617: System.runFinalization();\r\n  GenericLanguageConnectionContext.java:1709: System.runFinalization();\r\n\r\nPossible approaches:\r\n\r\n1) Maybe we could change the HashSet 'allContexts' of the\r\n   ContextService to use weak hash map perhaps, a WeakHashSet, if there\r\n   is such a thing. That way, the ContextManager objects would be\r\n   cleaned eventually.\r\n\r\n2) Remove the explicit calls to System.runFinalization. It seems that\r\n   keeping just the System.gc() call is less risky, but may be less\r\n   efficient, so could break existing apps? The System.gc() is not\r\n   guaranteed to yield results anyway..\r\n\r\n3) Figure out a way to explicitly close the result sets in question,\r\n   so the gc calls would be redundant. I am not sure how easy this\r\n   would be; they are probably there for a good reason.\r\n\r\n4) Remove the calls and allow the execution to fail as indicated in\r\n   the comment of verifyNoOpenResultSets:\r\n\r\n   // There may be open ResultSet's that are yet to be garbage collected\r\n   // let's try and force these out rather than throw an error\r\n   System.gc();\r\n   System.runFinalization();\r\n \r\n   This could break existing apps.\r\n\r\n5) other ideas..? \r\n\r\nFinally, can this deadlock be considered a Java run-time error? If\r\nnot, what is the contract being broken by Derby app code in the above?\r\nI tried to search a bit around advisability of explicitly running\r\nrunFinalization, in the presence of held Java locks, and finalizers\r\nwhich can cause locks, but I didn't find anything conclusive...\r\n\r\nAny advise is appreciated :)\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2007-04-18T00:04:21.390+0000","updated":"2007-04-18T00:04:21.390+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12489808","id":"12489808","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Hi Dag,\r\n\r\n>1) Maybe we could change the HashSet 'allContexts' of the\r\n>   ContextService to use weak hash map perhaps, a WeakHashSet, if there\r\n>   is such a thing. That way, the ContextManager objects would be\r\n>   cleaned eventually.\r\n\r\nMaybe you could press java.util.WeakHashMap into service. Its javadoc suggests the following issues:\r\n\r\na) You would need to choose something innocuous for the values in this map. You're only interested in the keys and garbage-collectible values would need to be wrapped in WeakReferences.\r\n\r\nb) ContextService.notifyAllActiveThreads() would need to be insulated from disappearing keys. Also, for the record, it looks to me as though the Thread.interrupt() call needs to be wrapped in a privileged action block.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2007-04-18T16:19:15.557+0000","updated":"2007-04-18T16:19:15.557+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12489814","id":"12489814","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"A data point: In addition to the patch, I removed both calls to\r\nSystem.runFinalization() from GenericLanguageConnectionContext.java,\r\nbut kept the calls to System.gc().\r\n\r\nI ran suites.All end derbyall successfully with both Sun JDK1.4.2 and\r\n1.6 (sane jars), so I wonder if this may be the simplest way to resolve this. \r\n\r\nDoes anyone know if/why the calls to System.runFinalization() are\r\n(sometimes only, it would seem) necessary?\r\n\r\nThe calls to System.runFinalization() has been there since incubation\r\nas far as I can tell.\r\n\r\nIn any case, I will prepare a patch which contains this change as\r\nwell, maybe then someone can test on other VMs; I wonder whether the\r\nbehavior could differ in a significant way between VMs here.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2007-04-18T16:38:05.817+0000","updated":"2007-04-18T16:38:05.817+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12489816","id":"12489816","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Uploaded patch DERBY-1947-3, which is the same as *-2, except\r\nthat two calls to System.runFinalization have been commented out,\r\nplease see previous comment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2007-04-18T17:06:06.551+0000","updated":"2007-04-18T17:06:06.551+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12490202","id":"12490202","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"More data:\r\nUnfortunately, without the call to System.runFinalization(),\r\nProcedureInTriggerTest fails on Linux with Sun JDKs\r\nwith LANG_CANT_INVALIDATE_OPEN_RESULT_SET.\r\nKeeping the call, it deadlocks, as on Solaris.\r\n\r\nFor the IBM 1.5 VM, keeping the call, there is no deadlock,\r\nbut the error happens. As soon as the finalizer of the nested\r\nEmbedConnection objects (non-root) synchronize,\r\nthe failure happens, but at least the VM doesn't deadlock...\r\nPresumably the failure happens because the finalizers can't complete\r\nwhen gc() and runFinalization() is called, barring the\r\nresult sets from being garbage collected as well.\r\n\r\nI'll have to try another tack than removing the call to\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2007-04-19T23:51:39.295+0000","updated":"2007-04-19T23:51:39.295+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12490203","id":"12490203","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":".. to complete the sentence of the previous comment:\r\n\r\nI'll have to try another tack than removing the call to\r\nSystem.runFinalization().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2007-04-19T23:55:29.264+0000","updated":"2007-04-19T23:55:29.264+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12490311","id":"12490311","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"> Presumably the failure happens because the finalizers can't complete\r\n> when gc() and runFinalization() is called, barring the\r\n> result sets from being garbage collected as well.\r\n\r\nIt could also be that gc() just makes the garbage collection start, possibly in another thread, so that runFinalization() is called before the objects are marked as unreferenced. IIRC, gc() doesn't block whereas runFinalization() does.\r\n\r\nNote that the IBM 1.5 VM implemented a much more aggressive gc than previous versions. I remember that many tests had to be rewritten when people started running tests with that VM because ResultSets were closed earlier, etc. That probably explains why you don't see the deadlock in runFinalization() on IBM 1.5, since the objects most likely are gc'ed and finalized before you come to that point.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-04-20T10:22:58.593+0000","updated":"2007-04-20T10:22:58.593+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12490357","id":"12490357","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Thanks for looking at this Knut! \r\n\r\n> It could also be that gc() just makes the garbage collection start,\r\n> possibly in another thread, so that runFinalization() is called before\r\n> the objects are marked as unreferenced. IIRC, gc() doesn't block\r\n> whereas runFinalization() does.\r\n\r\nOn Solaris, gc() alone manages to clear up the result set objects in\r\ntime: Not sure how that works; possibly the marking of the nested\r\nconnection objects makes it possible to also mark the result set\r\nobjects which are then effectively collected in time for the test in\r\n#prepareToInvalidate() even though the connection objects can't yet be\r\nfinalized (blocked). As you say, since gc() doesn't block, there is no deadlock,\r\nand it works.\r\n\r\n> Note that the IBM 1.5 VM implemented a much more aggressive gc than\r\n> previous versions. I remember that many tests had to be rewritten when\r\n> people started running tests with that VM because ResultSets were\r\n\r\nOn Linux with SUN VM and with the IBM VM, gc() alone are not able to\r\nfree the result set objects in time, but this is could be timing\r\ndependent.\r\n\r\n> closed earlier, etc. That probably explains why you don't see the\r\n> deadlock in runFinalization() on IBM 1.5, since the objects most\r\n> likely are gc'ed and finalized before you come to that point.\r\n\r\nNo, I get the error with the IBM VM too, so the calls are\r\nnecessary. But they will not succeed in finalizing the nested\r\nconnection objects (unless they are collected earlier but result set\r\nobjects are not) but at least it doesn't deadlock.\r\n\r\nI will upload a new patch which avoids synchronization in the\r\nfinalizer of nested connection objects, which solves the deadlock\r\nproblem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2007-04-20T13:37:27.059+0000","updated":"2007-04-20T13:37:27.059+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12490362","id":"12490362","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"This version of the patch, DERBY-1947-4.* supercedes all earlier versions.\r\nIt removes the call to close() from the finalizer of EmbedConnection for nested\r\nconnection objects introduced in earlier versions of this patch as it is not strictly necessary. This solves the deadlock issue.\r\n\r\nsuites.All and derbyall + the repro run cleanly with Sun 1.4 on Solaris.\r\nI have verified the repro and ProcudureInTriggerTest against Sun 1.4 and IBM 1.5 on Linux as well.\r\n\r\nUnless I get feedback on this version I will commit it on Monday.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2007-04-20T13:52:16.419+0000","updated":"2007-04-20T13:52:16.419+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12352818/comment/12491094","id":"12491094","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Committed DERBY-1947-4.* as svn 531638 and resolving it.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2007-04-23T22:46:45.977+0000","updated":"2007-04-23T22:46:45.977+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1947/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i07667:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12363835","self":"https://issues.apache.org/jira/rest/api/latest/issue/12363835","key":"DERBY-2381","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2007-03-18 17:21:55.527","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23031","customfield_12310222":"1_*:*_1_*:*_5525901081_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_935505281","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2007-05-03T20:39:59.610+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2381/watchers","watchCount":0,"isWatching":false},"created":"2007-02-28T21:41:38.529+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12315225","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12315225","type":{"id":"10032","name":"Blocker","inward":"is blocked by","outward":"blocks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10032"},"outwardIssue":{"id":"12362740","key":"DERBY-2333","self":"https://issues.apache.org/jira/rest/api/2/issue/12362740","fields":{"summary":"Convert parameterMapping to JUnit","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/3","id":"3","description":"A task that needs to be done.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/task.png","name":"Task","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-05-14T16:31:44.885+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11690","id":"11690","name":"Network Client"}],"timeoriginalestimate":null,"description":"The test ParameterMappingTest fails due to a connection reset error during tearDown.  Commenting out the teardown actions I see that the real cause of the connection reset is an ArrayIndexOutOfBoundsException executing a callable statement.  I have not narrowed it down more than this.  Currently the test runs only for embedded. It should be reenabled for client once this bug is fixed.  Below is the stack trace:\n\n\njava.lang.ArrayIndexOutOfBoundsException\n\tat java.lang.System.arraycopy(Native Method)\n\tat org.apache.derby.client.net.Reply.shiftBuffer(Reply.java:107)\n\tat org.apache.derby.client.net.Reply.ensureSpaceInBufferForFill(Reply.java:153)\n\tat org.apache.derby.client.net.Reply.fill(Reply.java:165)\n\tat org.apache.derby.client.net.Reply.ensureALayerDataInBuffer(Reply.java(Compiled Code))\n\tat org.apache.derby.client.net.Reply.readDssHeader(Reply.java:317)\n\tat org.apache.derby.client.net.Reply.peekCodePoint(Reply.java:1008)\n\tat org.apache.derby.client.net.NetStatementReply.parseEXCSQLSTTreply(NetStatementReply.java:324)\n\tat org.apache.derby.client.net.NetStatementReply.readExecuteCall(NetStatementReply.java:105)\n\tat org.apache.derby.client.net.StatementReply.readExecuteCall(StatementReply.java:75)\n\tat org.apache.derby.client.net.NetStatement.readExecuteCall_(NetStatement.java:176)\n\tat org.apache.derby.client.am.Statement.readExecuteCall(Statement.java:1464)\n\tat org.apache.derby.client.am.PreparedStatement.flowExecute(PreparedStatement.java:2151)\n\tat org.apache.derby.client.am.PreparedStatement.executeX(PreparedStatement.java:1571)\n\tat org.apache.derby.client.am.PreparedStatement.execute(PreparedStatement.java:1556)\n\tat org.apache.derbyTesting.functionTests.tests.jdbcapi.ParameterMappingTest.testParameterMapping(ParameterMappingTest.java:487)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:85)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:58)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:60)\n\tat java.lang.reflect.Method.invoke(Method.java:391)\n\tat junit.framework.TestCase.runTest(TestCase.java:154)\n\tat junit.framework.TestCase.runBare(TestCase.java:127)\n\tat org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:76)\n\tat junit.framework.TestResult$1.protect(TestResult.java:106)\n\tat junit.framework.TestResult.runProtected(TestResult.java:124)\n\tat junit.framework.TestResult.run(TestResult.java:109)\n\tat junit.framework.TestCase.run(TestCase.java:118)\n\tat junit.framework.TestSuite.runTest(TestSuite.java:208)\n\tat junit.framework.TestSuite.run(TestSuite.java:203)\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:19)\n\tat junit.framework.TestResult.runProtected(TestResult.java:124)\n\tat junit.extensions.TestSetup.run(TestSetup.java:23)\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:19)\n\tat junit.framework.TestResult.runProtected(TestResult.java:124)\n\tat junit.extensions.TestSetup.run(TestSetup.java:23)\n\tat org.eclipse.jdt.internal.junit.runner.junit3.JUnit3TestReference.run(JUnit3TestReference.java:128)\n\tat org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:460)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:673)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:386)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:196)\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40040","summary":"ParameterMappingTest fails due to ArrayIndexOutOfBoundsException  executing a procedure","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":14,"total":14,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363835/comment/12481369","id":"12481369","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I am not having any luck getting a repro for this protocol problem outside of the test.  Below is my attempt to recreate what is happenning at the time of the error, but this passes just fine.\r\n\r\n  public static void main(String[] args) throws Exception {\r\n        \r\n        Class.forName(\"org.apache.derby.jdbc.ClientDriver\");\r\n        Connection conn =DriverManager.getConnection(\"jdbc:derby://localhost:1527/wombat;create=true;traceFile=trace.out\");\r\n        Statement s = conn.createStatement();\r\n        \r\n        try {\r\n            s.executeUpdate(\"DROP PROCEDURE PMP.TYPE_AS\");\r\n        } catch (SQLException se) {}\r\n        \r\n        String procSQL = \"CREATE PROCEDURE PMP.TYPE_AS(\" +\r\n        \"IN P1 \" +   \"SMALLINT\" +\r\n        \", INOUT P2 \" + \"SMALLINT\" +\r\n        \", OUT P3 \" + \"SMALLINT\" +\r\n                        \r\n        \") LANGUAGE JAVA PARAMETER STYLE JAVA NO SQL \" +\r\n        \" EXTERNAL NAME 'org.apache.derbyTesting.functionTests.util.ProcedureTest.pmap'\";\r\n\r\n        s.executeUpdate(procSQL);\r\n        \r\n        CallableStatement csp = conn.prepareCall(\"CALL PMP.TYPE_AS(?, ?, ?)\");\r\n        csp.registerOutParameter(2, java.sql.Types.INTEGER);\r\n        csp.registerOutParameter(3, java.sql.Types.INTEGER);\r\n        csp.setShort(1, (short) 32);\r\n        csp.setInt(2, (short) 32);\r\n        csp.execute();\r\n         csp.getInt(2);\r\n        csp.getInt(3);\r\n        csp.registerOutParameter(2, java.sql.Types.BIGINT);\r\n        csp.registerOutParameter(3, java.sql.Types.BIGINT);\r\n        csp.setShort(1, (short) 32);\r\n        csp.setInt(2, (short) 32);\r\n       // Error should occur on execution\r\n        csp.execute();\r\n        \r\n    }\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2007-03-15T23:05:58.033+0000","updated":"2007-03-15T23:05:58.033+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363835/comment/12481962","id":"12481962","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I think there is a bug somewhere around client.net.Reply.getData()\r\nand/or client.net.NetStatementReply.parseFDODTA(), but I don't know\r\nthe code well enough to say exactly what's wrong and how to fix\r\nit. Anyway, here are my observations:\r\n\r\nThere is a call to Reply.getData() when ddmScalarLen_ is -1 before the\r\ntest fails (according to the code coverage report at\r\nhttp://people.apache.org/~fuzzylogic/codecoverage/428586/, it's always\r\n-1 when getData() is called). -1 means that the DDM length is unknown\r\nbecause the DDM is streamed. getData() calls adjustLengths() which has\r\nthis line:\r\n\r\n        ddmScalarLen_ -= length;\r\n\r\nThis will give ddmScalarLen_ a negative value different from -1 (-4),\r\nwhich is an illegal state.\r\n\r\nAt a later point in the test, NetStatementReply.parseFDODTA() is\r\ncalled, and ddmScalarLen_ still has the illegal value\r\n-4. parseFDODTA() passes the value of ddmScalarLen_ to\r\nensureBLayerDataInBuffer() to ensure that there is enough data to read\r\nfrom the buffer. Since the argument is negative, no more data is\r\nfetched into the buffer.\r\n\r\nSince parseFDODTA() has called ensureBLayerDataInBuffer(), it assumes\r\nthat it has enough data and uses \"fast\" methods to read the data. The\r\nfast methods read data without calling ensureALayerDataInBuffer()\r\n(presumably because the caller has already called it). Since no more\r\ndata was read when ensureBLayerDataInBuffer() was called,\r\nparseFastSQLDTARDdata() and getFastData() suffer from an undetected\r\nbuffer underrun. The underrun causes false data to be read from the\r\nbuffer, and it makes pos_ (the position of the first available byte in\r\nthe buffer) greater than count_ (the position after the last available\r\nbyte in the buffer).\r\n\r\npos_ should never be greater than count_, and when Reply.shiftBuffer()\r\nis called later, this will make the length argument to\r\nSystem.arraycopy() negative, which is why we get an\r\nArrayIndexOutOfBoundsException.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-03-18T17:21:55.527+0000","updated":"2007-03-18T17:21:55.527+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363835/comment/12482830","id":"12482830","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Knut Anders for your insights on this problem.  I don't totally understand all you wrote but am suitably impressed and convinced you are on the right track.  I have had a really hard time trying to narrow this issue down to a smaller test case.  Do you have thoughts on how that could be done?  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2007-03-21T16:56:45.769+0000","updated":"2007-03-21T16:56:45.769+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363835/comment/12483577","id":"12483577","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I think your test case is pretty close. The only difference from the JUnit test, is that this line\r\n  csp.setInt(2, (short) 32);\r\nshould be replaced with\r\n  csp.setLong(2, 32L);\r\n\r\nAttaching a repro which reliably reproduces the ArrayIndexOutOfBoundsException in my environment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-03-23T13:06:05.864+0000","updated":"2007-03-23T13:06:05.864+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363835/comment/12483580","id":"12483580","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"When I run the repro, I get this exception on the server:\r\n\r\njava.lang.ClassCastException: java.lang.Integer\r\n        at org.apache.derby.impl.drda.DRDAConnThread.writeFdocaVal(DRDAConnThread.java:7255)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.writeFDODTA(DRDAConnThread.java:6692)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(DRDAConnThread.java:3847)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThread.java:955)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:275)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-03-23T13:08:24.046+0000","updated":"2007-03-23T13:08:24.046+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363835/comment/12483659","id":"12483659","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Knut Anders!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2007-03-23T17:14:25.992+0000","updated":"2007-03-23T17:14:25.992+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363835/comment/12492113","id":"12492113","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"The  ClassCastException occurs because the client sends the parameter type as DRDA_TYPE_NINTEGER8  (0x17),\r\nbecause the output parameter is registered as BIGINT and a long value is set with setLong.  The server then does a CallableStatement.getObject()  which is an Integer because the actual procedure has SMALLINT parameters. The server then attempts to cast it to a Long in DRDAConnThread.writeFdocaVal()  \r\n\r\ncase DRDAConstants.DRDA_TYPE_NINTEGER8:\r\n\t\t\t\t\twriter.writeLong(((Long) val).longValue());\r\n\t\t\t\t\tbreak;\r\n\r\nI am not sure if\r\na) The client should convert the parameter to  DRDA_TYPE_NINTEGER before sending it.\r\nb)  The server code should handle the conversion if the parameter type sent by the client does not match the actual type.\r\n\r\nI'd appreciate any insight on which approach is best.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2007-04-26T21:00:00.210+0000","updated":"2007-04-26T21:00:00.210+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363835/comment/12492127","id":"12492127","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Would it work to cast the value to Number instead of Integer/Long/Float/Double/BigInteger etc in writeFdocaVal()?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-04-26T22:01:18.617+0000","updated":"2007-04-26T22:01:18.617+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363835/comment/12492150","id":"12492150","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"The number cast  seems to work ok for everything but BigDecimal as there is no Number.bigDecimalValue(), but I keep thinking it is somehow wrong to be changing the type of the output parameter value, when returning it to the client. I think there might be cases where the output parameter value might get changed when being converted.  I think we need to be able to send the parameter in as one type and out as another, so that when sending output parameters, we switch on the actual type of the parameter, not on the type sent by client.  \r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2007-04-26T23:07:17.723+0000","updated":"2007-04-26T23:07:17.723+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363835/comment/12493238","id":"12493238","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Attaching a patch for this issue.  Formerly, the server would rely on the input parameter type information received from the client to determine the output parameter type.  This patch changes the server to look at the parameter metadata to determine the drda type to send.\r\nIt also enables the test ParameterMappingTest for client.\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2007-05-02T23:06:25.083+0000","updated":"2007-05-02T23:06:25.083+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363835/comment/12493239","id":"12493239","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"stat file for diff.  Also neglected to say that I ran derbyall and suites.All with the patch.   I got two failures which I also get in an unchanged client and seem unrelated to my change. Likely an environment issue.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2007-05-02T23:08:15.599+0000","updated":"2007-05-02T23:08:15.599+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363835/comment/12493430","id":"12493430","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"After syncing up with DERBY-2506 (  PreparedCallable_DRDA_v5.diff, adding some BLOB locator support.) the test case attached to this issue and ParameterMappingTest no longer pass with network server.\r\nThe new trace is below. There is no exception on the server.\r\n\r\nException in thread \"main\" java.lang.ArrayIndexOutOfBoundsException\r\n        at java.lang.System.arraycopy(Native Method)\r\n        at org.apache.derby.client.net.Reply.shiftBuffer(Reply.java:107)\r\n        at org.apache.derby.client.net.Reply.ensureSpaceInBufferForFill(Reply.java:153)\r\n        at org.apache.derby.client.net.Reply.fill(Reply.java:165)\r\n        at org.apache.derby.client.net.Reply.ensureALayerDataInBuffer(Reply.java:215)\r\n        at org.apache.derby.client.net.Reply.readDssHeader(Reply.java:317)\r\n        at org.apache.derby.client.net.Reply.peekCodePoint(Reply.java:1008)\r\n        at org.apache.derby.client.net.NetStatementReply.parseEXCSQLSTTreply(NetStatementReply.java:324)\r\n        at org.apache.derby.client.net.NetStatementReply.readExecuteCall(NetStatementReply.java:105)\r\n        at org.apache.derby.client.net.StatementReply.readExecuteCall(StatementReply.java:75)\r\n        at org.apache.derby.client.net.NetStatement.readExecuteCall_(NetStatement.java:176)\r\n        at org.apache.derby.client.am.Statement.readExecuteCall(Statement.java:1464)\r\n        at org.apache.derby.client.am.PreparedStatement.flowExecute(PreparedStatement.java:2157)\r\n        at org.apache.derby.client.am.PreparedStatement.executeX(PreparedStatement.java:1577)\r\n        at org.apache.derby.client.am.PreparedStatement.execute(PreparedStatement.java:1562)\r\n        at d2381.main(D2381.java:39)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2007-05-03T17:30:04.302+0000","updated":"2007-05-03T17:30:04.302+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363835/comment/12493493","id":"12493493","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"The problem running ParameterMappingTest was an issue with my environment.  It passes now. I will rerun tests and check in.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2007-05-03T20:01:34.252+0000","updated":"2007-05-03T20:01:34.252+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363835/comment/12493510","id":"12493510","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Committed revision 534985\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2007-05-03T20:39:59.471+0000","updated":"2007-05-03T20:39:59.471+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2381/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i077v3:"}}
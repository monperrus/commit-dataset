{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"32767","self":"https://issues.apache.org/jira/rest/api/latest/issue/32767","key":"DERBY-304","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-02-02 10:59:12.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"21885","customfield_12310222":"1_*:*_1_*:*_24543284000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_33239072315","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-03-01T04:49:27.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-304/watchers","watchCount":0,"isWatching":false},"created":"2005-05-21T03:14:43.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsuresh","name":"tsuresh","emailAddress":"suresh dot thalamati at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suresh Thalamati","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-03-20T21:53:59.313+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11412","id":"11412","name":"Store"}],"timeoriginalestimate":null,"description":"If by mistake you give he location for the db backup as the db itself , then windows created directories recursively until it crashes! \n\nRepro:\n\n\t\t\tCallableStatement cs = conn.prepareCall(\"CALL SYSCS_UTIL.SYSCS_BACKUP_DATABASE_AND_ENABLE_LOG_ARCHIVE_MODE(?, ?)\");\n\t\t\tcs.setString(1, \"c:/maildb\");\n\t\t\tcs.setInt(2, 1);\n\t\t\tcs.execute();\n\t\t\tcs.close();\n\nresult:\n\nC:\\maildb\\maildb\\maildb\\maildb\\maildb\\maildb\\maildb\\maildb\\maildb\\maildb\\maildb\\maildb\\maildb\\maildb\\..................... Until windows can not show the path!!!\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40136","summary":"If by mistake you give he location for the db backup as the db itself , then windows created directories recursively until windows crashes!","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkutty","name":"mkutty","emailAddress":"mkutty at remulak dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjula Kutty","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"With JDK 142 on Windows XP","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":4,"total":4,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/32767/comment/12364909","id":"12364909","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsuresh","name":"tsuresh","emailAddress":"suresh dot thalamati at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suresh Thalamati","active":true},"body":"I tried the repro for this bug on my laptop with Windows XP , backup failed while copying the directories., with the error:ERROR XSRS5: Error copying file (during backup) from C:\\maildb to c:\\maildb\\maildb.\r\nOS did not crash for me.. \r\n\r\nI think  it is very rare any user will make mistake  of  giving backup path same as database home or one of its subdirectories. But I agree it might be nice to throw a better error message,  but that might add some addtional restrictions or overhead.\r\n\r\nSome thought one possible way to fix this::\r\n\r\n1)  Get absolute paths for both the database home directory and the backup directory  then  find if  backup path is a subdirectory under the database directory.   Problem with this approach is :\r\n    a)   Backup would always  require   read permission for \"user.dir\"  when run under security manager. \r\n    b)   If there are symbolic links involved ,  this fix will not work. \r\n\r\n2)   Add a counter to  keep track  how many level of deep the   directories are  being created  from the backup directory while doing the copy.  If   the  directory level is deeper than the database normally has then  throw error.  This will work  if  user create backup under <dbname>/jar  or <dbname>  but  if the given backup path is under  \"log\" and \"seg0\"  then we can not identify this case becuase these directoties are not copied any more.\r\n\r\n\r\n3)   At the start of  the backup create a uniue file using a UUID under the backup directory ,  then search for that file under the database home directory. If  that file is not  found then one can be sure backup path is not  mapping to a subdirectiory  of  database directory.   Delete the new file created and then proceed with the backup.  I think this fix will work ,  but  there is overhead of searching through all the files under the  database directory for  a error case.    \r\n\r\n4) Don't  bother to fix it ,  No one is going hit this problem again  :-)\r\n\r\n\r\nAny suggestions ?\r\n\r\n\r\nThanks\r\n-suresht\r\n\r\n  \r\n\r\n\r\n\r\n  \r\n\r\n\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsuresh","name":"tsuresh","emailAddress":"suresh dot thalamati at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suresh Thalamati","active":true},"created":"2006-02-02T10:59:12.000+0000","updated":"2006-02-02T10:59:12.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/32767/comment/12364919","id":"12364919","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kartha","name":"kartha","emailAddress":"kartha02 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Kartha","active":true},"body":"The (file.getCanonicalFile()) gives you the actual path for symbolic links. I am wondering  if that could be used to compare the\r\nbackup  location and the actual database to be the same.  \r\n\r\nSomething like:\r\n\r\nf.getCanonicalFile().equals(f1.getCanonicalFile())\r\n\r\nThis will return true is'f1' is a symbolic link to 'f'. I know for sure this works on Linux.\r\n\r\n\r\n-Rajesh\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kartha","name":"kartha","emailAddress":"kartha02 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Kartha","active":true},"created":"2006-02-02T13:41:09.000+0000","updated":"2006-02-02T13:41:09.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/32767/comment/12367110","id":"12367110","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsuresh","name":"tsuresh","emailAddress":"suresh dot thalamati at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suresh Thalamati","active":true},"body":"DERBY-304:  If the given backup path is same as the database home, backup \r\nwas failing in trying to copy the backup onto itself, while copying the \r\ndirectories in the database home recursively into the backup. \r\n\r\nFix :\r\n\r\n1) Do not allow backup path to be any derby database directory. A directory is\r\n   assumed to be a derby database directory if it has service.properties file in it. \r\n\r\n2) copy files needed from the database home into the backup  one by one \r\n   instead of recursive copy from the top directory. \r\n\r\n3) while copying the directories under jar directory, copy each sub directory\r\n   separately without copying any subdirectories under them (There should not\r\n   be any unless if user has created explicitly or created backup at that location).\r\n\r\n4) Log and Seg0 directory are NOT already copied recursively, this was changed as part of\r\n   online backup work (DERBY-239).\r\n\r\n    \r\nTESTS : derbyall test suite passed on Windows XP/JDK142, except for known failures.\r\n\r\nIt would be great if some can review and commit this patch. \r\n\r\nsvn stat:\r\nM      java\\engine\\org\\apache\\derby\\impl\\sql\\execute\\JarDDL.java\r\nM      java\\engine\\org\\apache\\derby\\impl\\store\\raw\\RawStore.java\r\nM      java\\engine\\org\\apache\\derby\\iapi\\services\\io\\FileUtil.java\r\nM      java\\engine\\org\\apache\\derby\\iapi\\store\\access\\FileResource.java\r\nM      java\\engine\\org\\apache\\derby\\loc\\messages_en.properties\r\nM      java\\shared\\org\\apache\\derby\\shared\\common\\reference\\SQLState.java\r\nM      java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\store\\copyfiles.ant\r\nA      java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\store\\BackupPathTests.java\r\nA      java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\store\\BackupPathTests_app.properties\r\nA      java\\testing\\org\\apache\\derbyTesting\\functionTests\\master\\BackupPathTests.out\r\nM      java\\testing\\org\\apache\\derbyTesting\\functionTests\\suites\\storemore.runall\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsuresh","name":"tsuresh","emailAddress":"suresh dot thalamati at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Suresh Thalamati","active":true},"created":"2006-02-21T09:11:45.000+0000","updated":"2006-02-21T09:11:45.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/32767/comment/12367279","id":"12367279","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I reviewed, ran tests and committed this patch:\r\nm1_142:204>svn commit\r\n\r\nSending        java\\engine\\org\\apache\\derby\\iapi\\services\\io\\FileUtil.java\r\nSending        java\\engine\\org\\apache\\derby\\iapi\\store\\access\\FileResource.java\r\nSending        java\\engine\\org\\apache\\derby\\impl\\sql\\execute\\JarDDL.java\r\nSending        java\\engine\\org\\apache\\derby\\impl\\store\\raw\\RawStore.java\r\nSending        java\\engine\\org\\apache\\derby\\loc\\messages_en.properties\r\nSending        java\\shared\\org\\apache\\derby\\shared\\common\\reference\\SQLState.jav\r\na\r\nAdding         java\\testing\\org\\apache\\derbyTesting\\functionTests\\master\\BackupP\r\nathTests.out\r\nSending        java\\testing\\org\\apache\\derbyTesting\\functionTests\\suites\\storemo\r\nre.runall\r\nAdding         java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\store\\Ba\r\nckupPathTests.java\r\nAdding         java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\store\\Ba\r\nckupPathTests_app.properties\r\nSending        java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\store\\co\r\npyfiles.ant\r\nTransmitting file data ...........\r\nCommitted revision 379620.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2006-02-22T08:17:49.000+0000","updated":"2006-02-22T08:17:49.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-304/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i078gf:"}}
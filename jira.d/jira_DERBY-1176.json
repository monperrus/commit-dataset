{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12331518","self":"https://issues.apache.org/jira/rest/api/latest/issue/12331518","key":"DERBY-1176","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-04-19 23:00:33.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22353","customfield_12310222":"3_*:*_1_*:*_1200638000_*|*_1_*:*_1_*:*_326898000_*|*_6_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-04-21T14:07:06.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1176/watchers","watchCount":0,"isWatching":false},"created":"2006-04-03T21:48:10.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-04-21T14:07:06.000+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11407","id":"11407","name":"JDBC"}],"timeoriginalestimate":null,"description":"When upgrading a database created with Derby 10.1 to 10.2, the SPSs in\nthe SYSIBM schema are not updated. SYSIBM.METADATA was modified in\nDERBY-965, but it still has the old behaviour after the upgrade (both soft and\nhard).\n\nHow to reproduce:\n\n  1. Create a database with 10.1.\n\n    soft upgrade:\n\n  2. Start 10.2 network server.\n  3. Connect to the 10.1 database with the 10.2 client driver and\n     invoke DatabaseMetaData.supportsResultSetConcurrency(\n     ResultSet.TYPE_FORWARD_ONLY, ResultSet.CONCUR_READ_ONLY). Return\n     value: FALSE.\n\n    hard upgrade:\n\n  4. Restart 10.2 network server.\n  5. Connect to the database with \"upgrade=true\" added to the\n     URL. DatabaseMetaData.supportsResultSetConcurrency(\n     Restart.TYPE_FORWARD_ONLY, ResultSet.CONCUR_READ_ONLY) returns\n     FALSE.\n\n    observe correct behaviour:\n\n  6. Delete the database and recreate it with 10.2.\n  7. Start 10.2 network server.\n  8. Connect to the database with the client driver and invoke\n     DatabaseMetaData.supportsResultSetConcurrency(\n     Restart.TYPE_FORWARD_ONLY, ResultSet.CONCUR_READ_ONLY). Return\n     value: TRUE.\n\nProposed solution for hard upgrade: drop and recreate SPSs.\n\nProposed solution for soft upgrade: read SYSIBM.METADATA from\nmetadata_net.properties.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40735","summary":"Stored prepared statements in the SYSIBM schema are not updated on upgrade","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10102","value":"Patch Available","id":"10102"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":4,"total":4,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12331518/comment/12373595","id":"12373595","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"'derby-1176-v1.diff' makes the metadata calls that depend on\r\nSYSIBM.METADATA return the correct results after an upgrade from 10.1\r\n(soft or hard).\r\n\r\n  1. DD_Version.doFullUpgrade() now drops and recreates SPSs in all\r\n     system schemas, not SYSIBM only.\r\n\r\n  2. EmbedDatabaseMetaData already has the necessary machinery to load\r\n     queries from system tables or metadata.properties depending on\r\n     whether the engine is in soft upgrade mode or not. I extended it\r\n     so that it could read queries from metadata_net.properties as\r\n     well.\r\n\r\n  3. New method EmbedDatabaseMetaData.getClientCachedMetaData() which\r\n     executes SYSIBM.METADATA (either from system table or\r\n     metadata_net.properties) to fetch the metadata that will be\r\n     cached on the client.\r\n\r\n  4. SystemProcedures.METADATA() now invokes\r\n     EmbedDatabaseMetaData.getClientCachedMetaData() instead of\r\n     executing the METADATA SPS directly.\r\n\r\nThe patch passes derbyall and the upgrade test. I have verified\r\nmanually that the metadata calls on the client return the correct\r\nvalues in soft and hard upgrade.\r\n\r\nPlease review. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-04-07T16:36:10.000+0000","updated":"2006-04-07T16:36:10.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12331518/comment/12375145","id":"12375145","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Nice patch! I think the approach is sound; without it some metadata\r\nchanged for client SUR will be wrong on both soft and hard upgrade, so\r\nthanks for this.\r\n\r\nMinor nit-picks:\r\n\r\n- EmbedDatabaseMetaData.java\r\n\r\n  * Code readability:\r\n  \r\n  if ((removeSYSIBMonly && isSYSIBM) || !removeSYSIBMonly) {\r\n     <do something>\r\n  }\r\n\r\n  might be more readable as:\r\n\r\n  if (removeSYSIBMonly && !isSYSIBM) {\r\n       // do nothing\r\n  } else {\r\n       <do something>\r\n  }\r\n\r\n  * Some comments mention only metadata.properties which should now\r\n    also mention metadata_net.properties, e.g. on ca line 3339:\r\n\r\n    //Can't use stored prepared statements because we are in soft upgrade\r\n    //mode and hence need to get metadata sql from metadata.properties file \r\n \r\n    Similarly, the javadoc for getPreparedQuery also mentions\r\n    metadata.properties in its description, but only introduces\r\n    metadata_net.properties when explaining the parameters. There are\r\n    other similar instances.\r\n\r\n  * Specialized version (non-client) of getPreparedQuery and\r\n    getSimpleQuery have been introduced with protected visibility.\r\n    The general ones can now be made private (at least for now).\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2006-04-19T23:00:33.000+0000","updated":"2006-04-19T23:00:33.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12331518/comment/12375381","id":"12375381","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks, Dag and Øystein, for your comments! I have uploaded a new patch with the modifications you suggested. Since I had problems deciding which elegant rewrite of the if statement I should choose, I chose a hybrid and added comments to clarify.\r\n\r\nThe upgrade test still runs cleanly, and my manual test of the client/metadata issue passes too. Have started a derbyall run now, just in case. If there are no more comments, I will commit the patch tomorrow.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-04-20T22:26:07.000+0000","updated":"2006-04-20T22:26:07.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12331518/comment/12375503","id":"12375503","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Committed revision 395799.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-04-21T14:07:06.000+0000","updated":"2006-04-21T14:07:06.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1176/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i07c5j:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12497286","self":"https://issues.apache.org/jira/rest/api/latest/issue/12497286","key":"CASSANDRA-2088","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310865","id":"12310865","key":"CASSANDRA","name":"Cassandra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310865&avatarId=12034","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310865&avatarId=12034","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310865&avatarId=12034","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310865&avatarId=12034"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11961","id":"11961","description":"Apache Cassandra related projects","name":"Cassandra"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316288","id":"12316288","description":"","name":"0.7.5","archived":false,"released":true,"releaseDate":"2011-04-27"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2011-03-07 05:23:40.889","customfield_12312322":null,"customfield_12312323":null,"customfield_12310222":"10002_*:*_1_*:*_227746993_*|*_1_*:*_1_*:*_5961665160_*|*_5_*:*_1_*:*_0","customfield_12310420":"20437","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2011-04-13T21:06:46.024+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-2088/watchers","watchCount":5,"isWatching":false},"created":"2011-02-01T05:49:53.884+0000","customfield_10022":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12311124":null,"customfield_12312334":null,"customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slebresne","name":"slebresne","emailAddress":"sylvain at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slebresne&avatarId=14630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slebresne&avatarId=14630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slebresne&avatarId=14630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slebresne&avatarId=14630"},"displayName":"Sylvain Lebresne","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-04-13T21:06:46.033+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312978","id":"12312978","name":"Core"}],"timeoriginalestimate":null,"description":null,"customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12476140","id":"12476140","filename":"0001-Better-detect-failures-from-the-other-side-in-Incomi.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slebresne","name":"slebresne","emailAddress":"sylvain at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slebresne&avatarId=14630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slebresne&avatarId=14630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slebresne&avatarId=14630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slebresne&avatarId=14630"},"displayName":"Sylvain Lebresne","active":true},"created":"2011-04-12T17:45:13.675+0000","size":1499,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12476140/0001-Better-detect-failures-from-the-other-side-in-Incomi.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12475965","id":"12475965","filename":"0001-detect-streaming-failures-and-cleanup-temp-files.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amorton","name":"amorton","emailAddress":"aaron at thelastpickle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=amorton&avatarId=11346","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=amorton&avatarId=11346","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=amorton&avatarId=11346","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=amorton&avatarId=11346"},"displayName":"amorton","active":true},"created":"2011-04-11T05:50:45.392+0000","size":30882,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12475965/0001-detect-streaming-failures-and-cleanup-temp-files.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12475966","id":"12475966","filename":"0002-delete-partial-sstable-if-compaction-error.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amorton","name":"amorton","emailAddress":"aaron at thelastpickle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=amorton&avatarId=11346","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=amorton&avatarId=11346","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=amorton&avatarId=11346","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=amorton&avatarId=11346"},"displayName":"amorton","active":true},"created":"2011-04-11T05:50:45.402+0000","size":3262,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12475966/0002-delete-partial-sstable-if-compaction-error.patch"}],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"92927","summary":"Clean up after failed (repair) streaming operation","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stuhood","name":"stuhood","emailAddress":"stuhood at twitter dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stuhood&avatarId=10049","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stuhood&avatarId=10049","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stuhood&avatarId=10049","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stuhood&avatarId=10049"},"displayName":"Stu Hood","active":true},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stuhood","name":"stuhood","emailAddress":"stuhood at twitter dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stuhood&avatarId=10049","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stuhood&avatarId=10049","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stuhood&avatarId=10049","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stuhood&avatarId=10049"},"displayName":"Stu Hood","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"customfield_12311420":null,"customfield_12311421":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":11,"total":11,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497286/comment/12989053","id":"12989053","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stuhood","name":"stuhood","emailAddress":"stuhood at twitter dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stuhood&avatarId=10049","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stuhood&avatarId=10049","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stuhood&avatarId=10049","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stuhood&avatarId=10049"},"displayName":"Stu Hood","active":true},"body":"Regarding repair: http://www.mail-archive.com/user@cassandra.apache.org/msg09259.html\r\nAnd compaction: CASSANDRA-2084","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stuhood","name":"stuhood","emailAddress":"stuhood at twitter dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stuhood&avatarId=10049","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stuhood&avatarId=10049","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stuhood&avatarId=10049","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stuhood&avatarId=10049"},"displayName":"Stu Hood","active":true},"created":"2011-02-01T05:53:20.376+0000","updated":"2011-02-01T05:53:20.376+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497286/comment/13003264","id":"13003264","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amorton","name":"amorton","emailAddress":"aaron at thelastpickle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=amorton&avatarId=11346","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=amorton&avatarId=11346","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=amorton&avatarId=11346","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=amorton&avatarId=11346"},"displayName":"amorton","active":true},"body":"I'm keen to try this ticket (to learn more about compaction and repair) if it's not already been worked on. Also if it's ok for me to take a couple of days while I dig into this.\r\n\r\nFor compaction I'm looking in\r\n- CompactionManager.doCompaction where it creates a new SSTableWriter via cfs.createCompactionWriter() \r\n- CompactionManager.doCleanupCompaction() also uses an SSTableWriter\r\n\r\nAre the sorts of failures we're considering for compaction ones that come from the CompactionIterator or SSTableScanner ?\r\n\r\nFor repair I'm looking in:\r\n- IncomingStreamReader appears to clean up the temporary pending file in some error situations. Do we have any more info on the sorts of failures here? e.g. If there is an IOException sending the re-stream message, or a non checked exception it will fail to cleaup the file. \r\n- I'm looking into what happens in StreamInSession.finished() closeIfFinished()\r\n- Are we considering failures during the streaming or when processing the data after the stream has finished?\r\n\r\nAny guidance welcome. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amorton","name":"amorton","emailAddress":"aaron at thelastpickle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=amorton&avatarId=11346","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=amorton&avatarId=11346","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=amorton&avatarId=11346","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=amorton&avatarId=11346"},"displayName":"amorton","active":true},"created":"2011-03-07T05:23:40.889+0000","updated":"2011-03-07T05:23:40.889+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497286/comment/13003435","id":"13003435","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"bq. Are the sorts of failures we're considering for compaction ones that come from the CompactionIterator or SSTableScanner ?\r\n\r\nBoth. Also I suppose it's possible for the writer to error out from lack of disk space since it only checks at the beginning for space and doesn't \"reserve\" it vs flushes.\r\n\r\nbq. Are we considering failures during the streaming or when processing the data after the stream has finished?\r\n\r\nThe former is much more common (I've never seen the latter reported), so I'd start with that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2011-03-07T16:59:43.931+0000","updated":"2011-03-07T16:59:43.931+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497286/comment/13018204","id":"13018204","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amorton","name":"amorton","emailAddress":"aaron at thelastpickle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=amorton&avatarId=11346","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=amorton&avatarId=11346","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=amorton&avatarId=11346","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=amorton&avatarId=11346"},"displayName":"amorton","active":true},"body":"patch 0001 tracks failures during AES streaming, files for failed Stream sessions are cleaned up and repair is allowed to continue. Failed files are logged at the StreamSession, TreeRequest, and RepairSession level. \r\n\r\npatch 0002 handle exceptions when doing a (normal) compaction and deletes the temp SSTable. The SSTableWriter components are closed before deletion so that windows will delete correctly. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amorton","name":"amorton","emailAddress":"aaron at thelastpickle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=amorton&avatarId=11346","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=amorton&avatarId=11346","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=amorton&avatarId=11346","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=amorton&avatarId=11346"},"displayName":"amorton","active":true},"created":"2011-04-11T05:50:45.431+0000","updated":"2011-04-11T05:50:45.431+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497286/comment/13018934","id":"13018934","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slebresne","name":"slebresne","emailAddress":"sylvain at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slebresne&avatarId=14630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slebresne&avatarId=14630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slebresne&avatarId=14630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slebresne&avatarId=14630"},"displayName":"Sylvain Lebresne","active":true},"body":"I think there is a few different things here and I think we should separate them somehow.\r\n\r\nFixing the fact that streaming leave tmp files around when it fails is a 2 lines fix and I think this is simple enough that it could go to 0.7. I'm attaching a patch against 0.7. It's extracted from Aaron first patch, although rebased on 0.7 (and fix a bug).\r\n\r\nMaking repair aware that there has been some failures is actually more complicated so that should go in 0.8.1 or something (and should go to CASSANDRA-2433 or another ticket that describe the problem better). ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slebresne","name":"slebresne","emailAddress":"sylvain at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slebresne&avatarId=14630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slebresne&avatarId=14630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slebresne&avatarId=14630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slebresne&avatarId=14630"},"displayName":"Sylvain Lebresne","active":true},"created":"2011-04-12T17:45:13.702+0000","updated":"2011-04-12T17:45:13.702+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497286/comment/13018942","id":"13018942","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"bq. I'm attaching a patch against 0.7\r\n\r\nIs that 0001-Better-detect-failures-from-the-other-side-in-Incomi.patch?  I don't see the connection to .tmp files.  (Also: have you verified that the channel will actually infinite-loop returning 0?  Kind of odd behavior, although I guess it's technically within-spec.)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2011-04-12T17:51:42.606+0000","updated":"2011-04-12T17:51:42.606+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497286/comment/13018965","id":"13018965","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slebresne","name":"slebresne","emailAddress":"sylvain at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slebresne&avatarId=14630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slebresne&avatarId=14630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slebresne&avatarId=14630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slebresne&avatarId=14630"},"displayName":"Sylvain Lebresne","active":true},"body":"bq. Is that 0001-Better-detect-failures-from-the-other-side-in-Incomi.patch? I don't see the connection to .tmp files. (Also: have you verified that the channel will actually infinite-loop returning 0? Kind of odd behavior, although I guess it's technically within-spec.)\r\n\r\nYes. IncomingStreamReader does clean the tmp file when there is an expection (there's an enclosing 'try catch'). The problem is that no exception is raised if the other side of the connection dies. What will happen then is the read will infinitely read 0 bytes. So this actually avoid the infinite loop returning 0 (and so I think answered your second question, so it wasn't very clear).\r\n\r\nNote that without this patch, there is an infinite loop that will hold a socket open forever (and consume cpu, though very few probably in that case). So this is not just merely a fix of deleting the tmp files. But it does as a consequence of correctly raising an exception when should be.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slebresne","name":"slebresne","emailAddress":"sylvain at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slebresne&avatarId=14630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slebresne&avatarId=14630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slebresne&avatarId=14630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slebresne&avatarId=14630"},"displayName":"Sylvain Lebresne","active":true},"created":"2011-04-12T18:21:40.500+0000","updated":"2011-04-12T18:21:40.500+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497286/comment/13018972","id":"13018972","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"+1, and can you move some of that explanation inline as a comment?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2011-04-12T18:25:39.586+0000","updated":"2011-04-12T18:25:39.586+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497286/comment/13019005","id":"13019005","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slebresne","name":"slebresne","emailAddress":"sylvain at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slebresne&avatarId=14630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slebresne&avatarId=14630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slebresne&avatarId=14630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slebresne&avatarId=14630"},"displayName":"Sylvain Lebresne","active":true},"body":"Committed that first part. I think we should keep that open to fix the tmp files for failed compaction and move the rest to another ticket (like CASSANDRA-2433 for instance).\r\n\r\nAbout the attached patch on cleaning up failed compaction:\r\n  * We should also handle cleanup and scrub\r\n  * We should handle SSTableWriter.Builder as it is yet another place where we could miss to cleanup a tmp file on error.\r\n  * In theory a failed flush could leave a tmp file behind. If that happens having a tmp file would be the least of your problem but for completeness sake we could handle it.\r\n  * The logging when failing to close iwriter and dataFile in SSTableWriter could probably go at error (we should not be failing there, if we do something is wrong)\r\n  * That's nitpick but I'm not a huge fan of catching RuntimeException in this case as this pollute the code for something that would be a programming error (that's probably debatable though). Maybe another solution would be to have this in the final block. It means making sure closeAndDelete() is ok with the file being already closed and/or deleted and having this final block *after* the closeAndOpenReader call.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slebresne","name":"slebresne","emailAddress":"sylvain at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slebresne&avatarId=14630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slebresne&avatarId=14630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slebresne&avatarId=14630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slebresne&avatarId=14630"},"displayName":"Sylvain Lebresne","active":true},"created":"2011-04-12T19:39:50.523+0000","updated":"2011-04-12T19:39:50.523+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497286/comment/13019171","id":"13019171","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amorton","name":"amorton","emailAddress":"aaron at thelastpickle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=amorton&avatarId=11346","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=amorton&avatarId=11346","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=amorton&avatarId=11346","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=amorton&avatarId=11346"},"displayName":"amorton","active":true},"body":"Thanks will take another look at the cleanup for compaction. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amorton","name":"amorton","emailAddress":"aaron at thelastpickle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=amorton&avatarId=11346","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=amorton&avatarId=11346","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=amorton&avatarId=11346","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=amorton&avatarId=11346"},"displayName":"amorton","active":true},"created":"2011-04-13T03:08:25.557+0000","updated":"2011-04-13T03:08:25.557+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497286/comment/13019551","id":"13019551","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"Created CASSANDRA-2468 for compaction cleanup. Will close this one for streaming.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2011-04-13T21:06:38.012+0000","updated":"2011-04-13T21:06:38.012+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-2088/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0g98n:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12328363","self":"https://issues.apache.org/jira/rest/api/latest/issue/12328363","key":"DERBY-900","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-02-01 06:10:48.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22197","customfield_12310222":"1_*:*_1_*:*_9222538000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_26438288438","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-05-18T23:38:52.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-900/watchers","watchCount":0,"isWatching":false},"created":"2006-02-01T05:49:54.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"13.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12310615","id":"12310615","description":"","name":"10.1.2.1","archived":false,"released":true,"releaseDate":"2005-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-03-20T23:37:00.436+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11690","id":"11690","name":"Network Client"}],"timeoriginalestimate":null,"description":"These constructors use the Java default platform encoding to convert the bytes to a String, this typically leads to bugs on platforms with different encodings.\n\nReplace with code using fixed conversion, or alternative mechanisms. \nIf the call is required its use should be commented as to why it is required.\n\norg.apache.derby.client.am.ClobOutputStream - some existing bug?\norg.apache.derby.client.am.DateTime - see DERBY-877\norg.apache.derby.client.am.sqlca\n\nI generated this list using the Java search in eclipse for references to the constructors\nString(byte[])\nString(byte[],int,int)\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40102","summary":"Remove use of String(byte[]) and String(byte[], int, int) constructors in network client leading to non-portable behaviour","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10102","value":"Patch Available","id":"10102"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":17,"total":17,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12364714","id":"12364714","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"org.apache.derby.client.am.ClobOutputStream -  DERBY-683 is open for this","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-02-01T06:10:48.000+0000","updated":"2006-02-01T06:10:48.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12374125","id":"12374125","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"This patch (derby900.diff.p1.txt and derby900.stat.p1.txt ) is for the trunk, and  focuses on fixing the usage of default string constructors in the client that can cause encoding problems.   \r\n\r\nI searched in Eclipse for the String(byte[]) and String(byte[],int,int)  constructors and in the current codeline there is one such method in sqlca.java#bytes2String which is used in about 7 places. \r\n\r\nPlease note, there are some more encoding issues as Kathey points out in  http://issues.apache.org/jira/browse/DERBY-877#action_12364297\r\nhttp://issues.apache.org/jira/browse/DERBY-951\r\n\r\nI discussed with Kathey on IRC yesterday.\r\n-- String.getBytes() is used in a number of places (DateTime,NetConnectionReply) which will need to be fixed. \r\n-- Server always sends UTF8 encoding for the SQLCARD strings, hence the bytes2String method needs to correctly use UTF8 encoding to decode the strings.\r\n\r\nThis fix\r\n-- use UTF8 encoding in bytes2String.\r\n\r\nTests:\r\nI have used the repro for DERBY-583 (Thanks Kathey) that uses lang/ConcurrentImplicitCreateSchema.java that shows the problem. I have also added this test to run as part of the encodingTests in trunk.\r\n\r\nTo repro on windows, \r\njava -Dframework=DerbyNetClient -DderbyTesting.encoding=UTF-16 org.apache.derbyTesting.functionTests.harness.RunTest lang/ConcurrentImplicitCreateSchema.java\r\n\r\nResults: \r\nwithout this fix, the exception sqlstate is all garbled up.\r\nwith this fix, the test should pass without any diff.\r\n\r\nRan derbyall with the patch on linux/ibm142 with no new failures ( insane jars)\r\n\r\nI am continuing to look at the other encoding issues.   Please review/commit this patch if it looks good. Thanks.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2006-04-12T09:52:48.000+0000","updated":"2006-04-12T09:52:48.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12374126","id":"12374126","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"I am attaching the patch for 10.1 codeline-  ' for_10.1_derby900.diff.p1.txt' and 'for_10.1_derby900.stat.p1.txt.' \r\n\r\nThe code changes are the same as in the derby900.diff.p1.txt.  \r\nThus, the fix \r\n-- uses UTF8 encoding in bytes2String.\r\n\r\nBut for the 10.1 codeline since derbyTesting.encoding property is not there, I am attaching a standalone repro 'TestEnc.java' for testing.\r\n\r\nOUTPUT for 10.1 \r\n$ java -cp \"C:/workghm/svnclient/ks10.1/classes;.\" -Dfile.encoding=UTF-16 -Dconsole.encoding=Cp1252 TestEnc\r\nInitializing connection type: derbynetclient\r\ndriver: org.apache.derby.jdbc.ClientDriver\r\nurl: jdbc:derby://localhost:1527/wombatderbynetclient;create=true;traceFile=derbynetclient.trace\r\nObtaining the connection\r\nDatabase: Apache Derby 10.1.2.4\r\n   T E S T   P A S S E D\r\n g o t   S Q L S t a t e   4 2 Y 0 7\r\n e = S c h e m a   ' T E S T S C H E M A 1 '   d o e s   n o t   e x i s t\r\n\r\n----------------------\r\nRan derbynetclientmats with patch on linux/ibm142. Apart from the known failures, the test lang/ConcurrentImplicitCreateSchema failed with the timeout exception (Note - this test was fixed for the timeout issue on trunk). This failure is not related to this patch.\r\n\r\nCan someone please review/commit this patch.  Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2006-04-12T10:15:07.000+0000","updated":"2006-04-12T10:15:07.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12374978","id":"12374978","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"I am attaching a patch 'derby900.test.diff.txt, derby900.test.stat.txt'  that affects only tests. \r\n\r\nChanges are\r\n-- remove the ConcurrentImplicitCreateSchema from the encodingTests suite. We dont run the ConcurrentImplicitCreateSchema test on trunk(10.2) because it has a high rate of failure on different platforms.\r\n-- add a new test (TestEnc) that repros the derby-583 and the issues that are fixed as a result of DERBY-900 and DERBY-901 and DERBY-902\r\n\r\nI ran the encodingTests suite with jdk15 and tests passed OK.  \r\n\r\nCan someone please review and commit this patch. Thanks. \r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2006-04-19T01:54:24.000+0000","updated":"2006-04-19T01:54:24.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12374979","id":"12374979","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"one pending patch for review/commit - derby900.test.diff.txt.  Thanks. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2006-04-19T01:56:16.000+0000","updated":"2006-04-19T01:56:16.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12376311","id":"12376311","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"With the changes checked in for DERBY-1127, now, there are 3 places where non portable String.getBytes() is used in client which is in NetConnectionReply.parseSQLDCGRP\r\n\r\nThis patch(Derby900.p2.diff.txt)  removes use of this non portable method from the client and does some cleanup as part of removing usage of the String.getBytes() method.\r\n\r\n\r\nExplanation of changes :\r\n-- Server sends SQLSTATE in UTF8 encoding.\r\n\r\n-- see below code snippet ( taken from parseSQLDCGRP )\r\n       int sqldcCode = readFastInt(); // SQLCODE\r\n**********\r\n        String sqldcState = readFastString(5, netAgent_.targetTypdef_.getCcsidSbcEncoding()); // SQLSTATE\r\n***********\r\n        int sqldcReason = readFastInt();  // REASON_CODE\r\n        int sqldcLinen = readFastInt(); // LINE_NUMBER\r\n        int sqldcRown = (int) readFastLong(); // ROW_NUMBER\r\n\r\n        // save +20237 in the 0th entry of the rowsetSqlca's.\r\n        // this info is going to be used when a subsequent fetch prior is issued, and if already\r\n        // received a +20237 then we've gone beyond the first row and there is no need to\r\n        // flow another fetch to the server.\r\n        if (sqldcCode == 20237) {\r\n            rowsetSqlca[0] = new NetSqlca(netAgent_.netConnection_,\r\n                    sqldcCode,\r\n                    sqldcState.getBytes(),   //************\r\n                    null,\r\n                    netAgent_.targetTypdef_.getCcsidSbc());\r\n\r\n\r\nBasically the sqldcState is read using UTF8 or netAgent_.targetTypdef_.getCcsidSbcEncoding() and converted to a String and \r\nthen converted back to bytes using the bad non portable getBytes().  In NetSqlca, the sqldcState bytes and ccsid is passed in. The sqlstate bytes is set to sqldcState_ in NetSqlca and it is decoded using UTF8 in getSQLState using the method Sqlca::bytes2String.\r\n\r\nIn short, the getBytes() should take UTF-8 encoding but it seems much cleaner to do the cleanup here to avoid doing the extra conversion. currently conversion happens from bytes to string, and then to bytes and then back to string.   \r\n\r\nCleanup includes:\r\n--The ccsid in NetSqlca is never used and I have cleaned that up.\r\n--NetSqlca takes in sqlstate as bytes and then is converted to string. Instead since we have a string available already, there is no need of an extra conversion as seen in code snippet above.  I have changed the NetSqlca constructor to take in \r\nthe sqlstate as String.\r\n-- There is one place where the sqlstate is retrieved as bytes and passed to the NetSqlca constructor as such. I have overloaded the NetSqlca constructor to take in the sqlstate bytes and convert it to a string in the constructor itself.\r\n-- cleaned up Sqlca.getSQLState()\r\n\r\n-- During the cleanup one thing odd was all or most of the method signatures in this codepath have a throws DisconnectException even though some of them do not have any code that would throw this exception. In any case I have not cleaned those instances as I think it might be better to address them separately from this patch/issue.\r\n-- The NetSqlca constructor that does the conversion of the sqlstate bytes to string will throw a unsupportedencodingException that is thrown as a SqlException. This SqlException is wrapped into a DisconnectException in parseSQLCAGRP.  I followed the same approach as Reply.readFastString() that wraps the UnsupportedEncodingException into a DisconnectException. \r\n\r\nI think lots more encoding related cleanup can be done in client, but I will leave that for DERBY-951.\r\n\r\nThis is a client only change and I ran derbynetclientmats on windows/jdk142 ok. I also ran derbynetclientmats and derbynetmats on Z/OS with no new failures.  \r\nI also ran the encodingTests with sun jdk1.5 OK.\r\n\r\nCan someone please look at this change. Thanks. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2006-04-26T01:24:20.000+0000","updated":"2006-04-26T01:24:20.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12376551","id":"12376551","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I am trying to understand the type of case that would cover the code changed and trigger the encoding problem.    Do you have any idea what that case might be?\r\n\r\nKathey\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-04-27T04:06:50.000+0000","updated":"2006-04-27T04:06:50.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12376567","id":"12376567","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"I dont have a testcase available to repro for the p2 patch changes.   Let me look more to see if I can get one.  Thanks. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2006-04-27T04:49:26.000+0000","updated":"2006-04-27T04:49:26.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12376759","id":"12376759","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"The non portable String.getBytes() is used in parseSQLDCGRP as explained earlier.  This method is called by parseSQLDCROW which is called by parseSQLDIAGCI.\r\n\r\nClient flow is as follows:\r\nparseSQLDIAGCI -> parseSQLDCROW ->parseSQLDCGRP\r\n\r\n\r\nBut the server currently does not send SQLDIAGCI.  The only method that calls writeSQLDIAGCI is in writeSQLDIAGGRP (which is currently commented out code). writeSQLDIAGGRP is called by writeSQLCAXGRP.\r\n\r\nIn DRDARConnThread.writeSQLDIAGGRP we only write null data and the callto writeSQLDIAGCI is commented out. \r\n\r\nI tried to see if I could uncomment this code in writeSQLDIAGGRP  so I can get a repro, but then it seems like the other methods like writeSQLDIAGSTT also will need to be implemented correctly. The writeSQLDIAGSTT method just returns a null data for now.  \r\n\r\nIn short, the encoding changes made in parseSQLDCGRP in client is not currently being used.\r\n\r\nThe p2 changes are fairly straightforward if you dont include the cleanup changes.\r\nIn parseSQLDCGRP ,\r\nsqldcState is read, and then sent across to NetSqlca constructor using getBytes(). The encoding to be used is UTF8 since that is what the server sends.\r\n\r\nString sqldcState = readFastString(5, netAgent_.targetTypdef_.getCcsidSbcEncoding()); // SQLSTATE \r\n// note netAgent_.targetTypdef_.getCcsidSbcEncoding() is UTF8.\r\n\r\nIf you feel comfortable with just change to remove the getBytes() to use UTF8 encoding without the cleanup, then I can submit a patch with just that change. \r\n\r\nIf you have any ideas or suggestions to repro this, please let me know.  Thanks. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2006-04-27T23:40:47.000+0000","updated":"2006-04-27T23:40:47.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12376829","id":"12376829","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"I am dividing the Derby900.p2.diff.txt into two separate patches after talking to kathey.  \r\n\r\nThis patch derby900.p2_encodingChange.diff.txt  makes the encoding related change to remove the non portable String.getBytes() method. \r\n\r\n-- use correct encoding UTF8 for sqlstate in NetConnectionReply.::parseSQLDCGRP(Sqlca[] rowsetSqlca, int lastRow) \r\n\r\nNote: this code does not get exercised anywhere as explained in previous comment. Also code coverage results shows that this method is not called anywhere in our tests. \r\n\r\nsvn stat\r\nM      java\\client\\org\\apache\\derby\\client\\net\\NetConnectionReply.java\r\n\r\nderbynetclientmats ran ok on linux/ibm142. \r\n\r\nThe change itself is pretty simple.  The diff for this patch shows  more lines as changed because of the indentation change as a result of adding a try block. \r\n\r\nCan someone please look at this patch. Thanks. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2006-04-28T05:18:42.000+0000","updated":"2006-04-28T05:18:42.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12377473","id":"12377473","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"Thanks Kathey for committing my earlier p2 encoding change patch. \r\n\r\nIt was decided earlier to break up the derby900.p2.diff.txt, so I am attaching now a patch with the cleanup changes separately in derby900_p2_cleanup.diff.txt.  Changes are:\r\n\r\n--  remove unnecessary conversion from sqlstate string to bytes and  back to string , in parseSQLDCGRP(Sqlca[] rowsetSqlca, int lastRow)  in NetConnectionReply.\r\nThis has been done by adding a  constructor in NetSqlca to take in the sqlstate as string.    \r\n-- cleanup method getSqlState() in Sqlca.\r\n-- cleanup of ccsid_ in Sqlca as it is not used.\r\n\r\nPlease note, the parseSQLDCGRP method in  the diff shows more changes because of  change in indentation because of removal of the try block.\r\n\r\n-- ran derbynetclientmats on ibm142/linux OK.\r\n\r\nCan someone please look at this.  Thanks. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2006-05-03T04:11:37.000+0000","updated":"2006-05-03T04:11:37.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12378993","id":"12378993","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I applied the patch derby900_p2_cleanup.diff.txt\r\nI had to merge some files after applying and then ran derbynetclientmats.\r\nThe test derbynet/testSecMec failed with client and on rerun.\r\nI ran with \r\n\r\njava version \"1.4.2_07\"\r\nJava(TM) 2 Runtime Environment, Standard Edition (build 1.4.2_07-b05)\r\nJava HotSpot(TM) Client VM (build 1.4.2_07-b05, mixed mode)\r\n\r\nThe tail end of the test seems to be cut off.  Attached is the test output.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-05-11T06:20:30.000+0000","updated":"2006-05-11T06:20:30.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12378999","id":"12378999","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"Hi Kathey,\r\n\r\nI synced up till about  yesterday as svn is down now and applied the p2 cleanup patch and ran the testSecMec.java with sun 1.4.2_07 and it works OK on my win2000 laptop.  I ran this test a couple of times and it passes OK.  The tmp file in testsecmec.zip seems to look like as though the test exited in between - this behavior seems to me like the one seen in DERBY-1114.  The jvm bug described in DERBY-1114 is fixed in 1.5 and 1.4.2_08 atleast from the entries in the java bug database.   However, I didnt see windows platforms being mentioned anywhere in the java bug report. \r\n\r\ncan you please try running the test without the patch and see if it passes or not. and if  the test passes with antoher jvm -jdk1.5. \r\n\r\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2006-05-11T07:41:25.000+0000","updated":"2006-05-11T07:41:25.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12402417","id":"12402417","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"Thanks Kathey for committing the p2 cleanup patch on trunk..\r\n\r\nAlso adding notes here about the testSecMec failure that Kathey mentioned in the previous comment.  It seems like that was related to her machine environment and probably a manifestation of same issue mentioned in DERBY-1114.  Kathey mentioned that the test  failed without the patch on different jvms too.   \r\n---------------------------------\r\n\r\nI would like the derby900.p2_encodingChange.diff.txt to be ported to 10.1. It is a clean merge.  The merge command is\r\n\r\nsvn merge -r 398943:398944 https://svn.apache.org/repos/asf/db/derby/code/trunk/\r\n\r\nI merged and then ran derbynetclientmats on ibm142/linux ok. \r\n\r\nCan someone please commit this.  Thanks. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2006-05-16T03:43:11.000+0000","updated":"2006-05-16T03:43:11.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12412298","id":"12412298","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"body":"Committed to 10.1 branch with revision 407473.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"created":"2006-05-18T13:30:44.000+0000","updated":"2006-05-18T13:30:44.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12412299","id":"12412299","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"body":"Sunitha, please close this issue as resolved if there is no further work to be done.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"created":"2006-05-18T13:31:49.000+0000","updated":"2006-05-18T13:31:49.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12328363/comment/12482603","id":"12482603","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"Confirmed no use of these non-portable constructors in the network client code.\r\n\r\nShould remain assigned to Sunitha, but she is not present in the drop down list and it seems no way to leave the assign to field as-is.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2007-03-20T23:37:00.432+0000","updated":"2007-03-20T23:37:00.432+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-900/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0788v:"}}
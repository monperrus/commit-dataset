{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12542441","self":"https://issues.apache.org/jira/rest/api/latest/issue/12542441","key":"DERBY-5613","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12310220":"2012-02-14 14:43:14.941","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"227727","customfield_12310222":null,"customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5613/watchers","watchCount":2,"isWatching":false},"created":"2012-02-13T20:55:04.636+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":["derby_triage10_9"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317968","id":"12317968","description":"second release on the 10.8 branch","name":"10.8.2.2","archived":false,"released":true,"releaseDate":"2011-10-24"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12348180","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12348180","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12463019","key":"DERBY-4631","self":"https://issues.apache.org/jira/rest/api/2/issue/12463019","fields":{"summary":"Wrong join column returned by right outer join with NATURAL or USING and territory-based collation","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-02-23T22:15:55.902+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"New"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"A query like following does not raise an error even though countries.country is not part of the SELECT column list.\r\nSELECT country,count(country) FROM \r\nCOUNTRIES JOIN CITIES USING (COUNTRY) group by countries.country \r\n\r\nThis jira is related to DERBY-4631. As noted by Knut in DERBY-4631, SQL:2003 says that the join columns in a natural join or in a named columns join should be added to the select list by coalescing the column from the left table with the column from the right table. \r\n\r\nSection 7.7, <joined table>, syntax rules: \r\n\r\n> 1) Let TR1 be the first <table reference>, and let TR2 be the <table \r\n> reference> or <table factor> that is the second operand of the \r\n> <joined table>. Let RT1 and RT2 be the row types of TR1 and TR2, \r\n> respectively. Let TA and TB be the range variables of TR1 and TR2, \r\n> respectively. (...) \r\n\r\nand \r\n\r\n> 7) If NATURAL is specified or if a <join specification> immediately \r\n> containing a <named columns join> is specified, then: \r\n(...) \r\n> d) If there is at least one corresponding join column, then let SLCC \r\n> be a <select list> of <derived column>s of the form \r\n> \r\n> COALESCE ( TA.C, TB.C ) AS C \r\n> \r\n> for every column C that is a corresponding join column, taken in \r\n> order of their ordinal positions in RT1. \r\n\r\nDerby has it's on logic to retrieve the join column values. It always picks up join column's value from the left table when we are working with natural left outer join and it picks up the join column's value from the right table when we are working with natural right outer join. But this logic does not work for all cases for right outer join. The fix being worked for DERBY-4631 is to pick the join column's value based on following logic \r\n1)if the left table's column value is null then pick up the right table's column's value. \r\n2)If the left table's column value is non-null, then pick up that value \r\n\r\nAlthough this new logic will in essence implement what adding a COALESCE function for a join colunm might have done but it still allows following query to compile and run\r\nSELECT country,count(country) FROM \r\nCOUNTRIES JOIN CITIES USING (COUNTRY) group by countries.country \r\n\r\nI think query above succeeds because in case of an INNER JOIN or LEFT OUTER JOIN, Derby associates the join column with the left table during it's bind phase. In case of RIGHT OUTER JOIN, Derby associates the join column with right table during it's bind phase. I believe, for these reasons, a query like above will not give an error for the group by column.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"35928","summary":"Queries with group by column not included in the column list for JOIN(INNER or OUTER) with NATURAL or USING does not fail","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10101","value":"Release Note Needed","id":"10101"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10424","value":"Repro attached","id":"10424"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":6,"total":6,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542441/comment/13207526","id":"13207526","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"There are already some tests showing the incorrect behavior in GroupByTest.java","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-02-14T05:35:02.381+0000","updated":"2012-02-14T05:35:02.381+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542441/comment/13207748","id":"13207748","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"> A query like following does not raise an error even though countries.country is not part of the SELECT column list. \r\n> SELECT country,count(country) FROM  COUNTRIES JOIN CITIES USING (COUNTRY) group by countries.country\r\n\r\nI'm obviously missing your point, because the \"country\" column sure looks like it is in the select column list.\r\n\r\nIs the issue here whether \"country\" means \"countries.country\" or \"cities.country\"?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2012-02-14T14:43:14.941+0000","updated":"2012-02-14T14:43:14.941+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542441/comment/13208017","id":"13208017","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"But we haven't qualified the country column with the left table or right table. Instead it is a join column which as per SQL spec should be replaced by COALESCE, I haven't looked at the spec in detail on this, but if country in SELECT is to be replaced with COALESCE(COUNTRIES.county, CITIES.country), then should we be allowing join column country in SELECT to be bound to the COUNTRIES table? When we decide to work on this issue, we probably should look into SQL spec more about the expected behavior for such a query.\r\n\r\nIf the query above was rewritten to have group by on CITIES.country, the query would fail because that column is not in the SELECT list.\r\nSELECT country,count(country) FROM COUNTRIES JOIN CITIES USING (COUNTRY) group by CITIES.country \r\n\r\nCurrently, in Derby (based on my work on DERBY-4631), for a LEFT OUTER JOIN and INNER JOIN with USING/NATURAL, the join column in the SELECT list gets bound to the left table. For RIGHT OUTER JOIN with USING/NATURAL, the join column in the SELECT list gets bound to the right table. Based on what we find in the SQL spec, this binding logic for the join columns may or may not be correct.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-02-14T21:19:00.769+0000","updated":"2012-02-14T21:19:00.769+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542441/comment/13208512","id":"13208512","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"If it's an inner join, aren't countries.country and cities.country equivalent? Is this issue only for outer joins (left or right)?\r\n\r\nI agree that we need to obey the sql spec's description of how the query should behave.\r\n\r\nI'm not terribly familiar with USING syntax; is there a semantic difference between\r\n\r\n  SELECT country,count(country) FROM COUNTRIES JOIN CITIES USING (COUNTRY) group by country \r\n\r\nand\r\n\r\n  SELECT country,count(country) FROM COUNTRIES, cities where countries.country = cities.country group by country \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2012-02-15T14:48:22.067+0000","updated":"2012-02-15T14:48:22.067+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542441/comment/13208524","id":"13208524","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"> If it's an inner join, aren't countries.country and cities.country equivalent? Is this issue only for outer joins (left or right)? \r\n\r\nThis is an issue for inner joins too, I think, since you could have case-insensitive collation, so that countries.country is, say, 'Oman' and cities.country is 'OMAN', and countries.country=cities.country will still evaluate to true.\r\n\r\n> I'm not terribly familiar with USING syntax; is there a semantic difference between\r\n>\r\n>  SELECT country,count(country) FROM COUNTRIES JOIN CITIES USING (COUNTRY) group by country\r\n>\r\n> and\r\n>\r\n>  SELECT country,count(country) FROM COUNTRIES, cities where countries.country = cities.country group by country \r\n\r\nYes, those two queries are not equivalent. The latter of these will raise a compile-time error: Column name 'COUNTRY' is in more than one table in the FROM list.\r\n\r\nThe former is (supposed to be) equivalent to:\r\n\r\nSELECT country, count(country) from (SELECT COALESCE(countries.country, cities.country) AS country FROM countries, cities WHERE countries.country = cities.country) s GROUP BY country;","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2012-02-15T15:04:37.653+0000","updated":"2012-02-15T15:04:37.653+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542441/comment/13208527","id":"13208527","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Thanks! That's a good example, and clear. I'll go read the discussion in DERBY-4631 more carefully.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2012-02-15T15:10:58.262+0000","updated":"2012-02-15T15:10:58.262+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5613/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06ihb:"}}
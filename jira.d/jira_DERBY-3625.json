{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12394048","self":"https://issues.apache.org/jira/rest/api/latest/issue/12394048","key":"DERBY-3625","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313143","id":"12313143","description":"Head of 10.3 branch","name":"10.3.3.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313345","id":"12313345","description":"","name":"10.4.2.0","archived":false,"released":true,"releaseDate":"2008-09-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2008-05-30 00:00:15.997","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23752","customfield_12310222":"1_*:*_1_*:*_6670474818_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-07-02T03:55:51.309+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3625/watchers","watchCount":0,"isWatching":false},"created":"2008-04-15T23:01:16.491+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12320750","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320750","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12381963","key":"DERBY-3180","self":"https://issues.apache.org/jira/rest/api/2/issue/12381963","fields":{"summary":"error XSDA3 when test is executing SYSCS_INPLACE_COMPRESS_TABLE in specific situation","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12320748","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320748","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12387764","key":"DERBY-3381","self":"https://issues.apache.org/jira/rest/api/2/issue/12387764","fields":{"summary":"\"ERROR XSDA3: Limitation: Record cannot be updated or inserted due to lack of space on the page....\" in suites.All","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12319983","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12319983","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12381963","key":"DERBY-3180","self":"https://issues.apache.org/jira/rest/api/2/issue/12381963","fields":{"summary":"error XSDA3 when test is executing SYSCS_INPLACE_COMPRESS_TABLE in specific situation","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12319984","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12319984","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12387764","key":"DERBY-3381","self":"https://issues.apache.org/jira/rest/api/2/issue/12387764","fields":{"summary":"\"ERROR XSDA3: Limitation: Record cannot be updated or inserted due to lack of space on the page....\" in suites.All","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-01-13T21:43:43.672+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11412","id":"11412","name":"Store"}],"timeoriginalestimate":null,"description":"I saw this test fail once with a similar error to DERBY-3180 and DERBY-3381.\r\n\r\nUnfortunately, possibly because it's an old harness test, the db and derby.log were not saved in the 'fail' directory.\r\nAll I have is the stack trace from the output:\r\n\r\n1) concateTests(org.apache.derbyTesting.functionTests.tests.lang.LangHarnessJavaTest)java.sql.SQLException: Limitation: Record cannot be updated or inserted due to lack of space on the page. Use the parameters derby.storage.pageSize and/or derby.storage.pageReservedSpace to work around this limitation.\r\n\tat java.lang.Throwable.<init>(Throwable.java:196)\r\n\tat java.lang.Exception.<init>(Exception.java:41)\r\n\tat java.sql.SQLException.<init>(SQLException.java:40)\r\n\tat org.apache.derby.impl.jdbc.EmbedSQLException.<init>(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.Util.generateCsSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedCallableStatement.executeStatement(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(Unknown Source)\r\n\tat org.apache.derbyTesting.junit.CleanDatabaseTestSetup.compressObjects(CleanDatabaseTestSetup.java:267)\r\n\tat org.apache.derbyTesting.junit.CleanDatabaseTestSetup.cleanDatabase(CleanDatabaseTestSetup.java:166)\r\n\tat org.apache.derbyTesting.junit.CleanDatabaseTestSetup.setUp(CleanDatabaseTestSetup.java:109)\r\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:18)\r\n\tat junit.extensions.TestSetup.run(TestSetup.java:23)\r\n\tat org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\nCaused by: ERROR XSDA3: Limitation: Record cannot be updated or inserted due to lack of space on the page. Use the parameters derby.storage.pageSize and/or derby.storage.pageReservedSpace to work around this limitation.\r\n\tat java.lang.Throwable.<init>(Throwable.java:196)\r\n\tat java.lang.Exception.<init>(Exception.java:41)\r\n\tat org.apache.derby.iapi.error.StandardException.<init>(Unknown Source)\r\n\tat org.apache.derby.iapi.error.StandardException.<init>(Unknown Source)\r\n\tat org.apache.derby.iapi.error.StandardException.newException(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.data.CopyRowsOperation.writeOptionalDataToBuffer(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.data.CopyRowsOperation.<init>(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.data.LoggableActions.actionCopyRows(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.data.BasePage.copyInto(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.data.BasePage.copyAndPurge(Unknown Source)\r\n\tat org.apache.derby.impl.store.raw.data.StoredPage.moveRecordForCompressAtSlot(Unknown Source)\r\n\tat org.apache.derby.impl.store.access.heap.HeapCompressScan.fetchRowsForCompress(Unknown Source)\r\n\tat org.apache.derby.impl.store.access.heap.HeapCompressScan.fetchNextGroup(Unknown Source)\r\n\tat org.apache.derby.iapi.db.OnlineCompress.defragmentRows(Unknown Source)\r\n\tat org.apache.derby.iapi.db.OnlineCompress.compressTable(Unknown Source)\r\n\tat org.apache.derby.catalog.SystemProcedures.SYSCS_INPLACE_COMPRESS_TABLE(Unknown Source)\r\n\tat org.apache.derby.exe.ac4388a4aax0119x3203xfc8fx0000783ef2472.g0(Unknown Source)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\r\n\tat org.apache.derby.impl.services.reflect.ReflectMethod.invoke(Unknown Source)\r\n\tat org.apache.derby.impl.sql.execute.CallStatementResultSet.open(Unknown Source)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)\r\n\t... 24 more","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10369","value":"Regression Test Failure","id":"10369"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37632","summary":"XSDA3 error in concateTests in lang.LangHarnessJavaTest caused by bug in SYSCS_UTIL.SYSCS_INPLACE_COMPRESS_TABLE()","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"iseries, ibm1.5.:\r\njava version \"1.5.0\"\r\nJava(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_13-b05)\r\nClassic VM (build 1.5, build JDK-1.5, native threads, jitc_de)\r\n","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":14,"total":14,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12394048/comment/12600971","id":"12600971","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"The error comes in the compression of  the SYS.SYSDEPENDS table.\r\nThe compress occurs in CleanDatabaseTestSetup.setup() not in teardown() so the objects that just got dropped and are now being compressed are probably from the test before which is unfortunately the nist scripts (a lot of scripts).\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-05-30T00:00:15.997+0000","updated":"2008-05-30T00:00:15.997+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12394048/comment/12601189","id":"12601189","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"Is it still the case that no derby.log or database is left around to look at after the bug happens?  It would\r\nbe interesting to know if running the compress again also fails.  My guess is that it would and looking\r\nat the state of the table would make it easier to understand why.\r\n\r\nIf that is not possible then somehow dumping a lot more information may help.  I would usually put\r\nthis in a SANE bracket and just dump the info to the log - but again if we can't get the log that might not\r\nhelp.  The kind of info that would be interesting is a dump of the source page, dump of the dest page,\r\ndump of the row being moved, maybe dump of the table level properties like page size, reserved space.\r\nWhat I would mostly be looking at is the lengths involved rather than the data.  Seeing if there is possibly\r\nan off by one or off by a lot.\r\n\r\nI would probably concentrate on the StoredPage!moveRecordForCompressAtSlot() routine, catching\r\nthe \"generic\" exception being thrown from deeper down and print the info.  This routine try's 3 different\r\nways to find a page to move a row to.  In the first 2 is calls spaceForCopy() to see if there room and it\r\nshould be maintaining a latch on the page for the actual insert so unless there is a bug in latching the\r\nbug is probably in spaceForCopy().  toString in StoredPage has code to dump the page. printing just\r\nthe row size from the routine may be enough.  Just to eliminate possibilities it might be interesting\r\nto know which of the 3 cases the dest page came from - for instance if it came from the 3rd case then\r\nspaceForCopy() can't be the bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2008-05-30T16:19:36.201+0000","updated":"2008-05-30T16:19:36.201+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12394048/comment/12601196","id":"12601196","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"If this is just a math bug (and not a thread interaction timing issue), then the following kind of test should\r\nreproduce but probably takes some playing around to get the row sizes right for whatever page size you\r\npick.  \r\n\r\nHigh level:\r\ncreate a 2 page table.  On first page vary the amount of free space by 1 byte every loop through the\r\ntest.  On the second page have a single row that will be moved by compress table for each try.\r\n\r\ndetails - here's one way to loop and test all the cases of filling a page, there are probably more elegant ways, or you could play around with a test looking in toString() from page to find exactly the interesting\r\nlengths of rows:\r\npick some row size that you are going to move, let's say 100 bytes (this could also be variable for even\r\nmore exaustive test).  Each loop will drop/create the table (maybe there is a way around this).\r\npick a row something like 2 column with int key and clob data.  1st row inserted should exactly\r\nmach the TEST row.  Vary the size of the 2nd row by \r\none byte each time, if you load ascii data into the clob then stored size of row will go up 1 byte for \r\neach character.  The idea is to start with the 2nd row big enough such that insert of another TEST\r\nrow will not fit on the 1st page, and then the varying should inch you up to the interesting edge conditions\r\nof completely full page in no reserved space case and full with respect to reserved space in other case.\r\n\r\nFinally insert 3rd row that should match in length to TEST row.    and commit.  The goal at this point\r\nis to have a 2 page heap table with 2 rows on page 0 and 1 row on page 1.  \r\n\r\ndelete 1st TEST row, commit.\r\n\r\nrun inplace compress.  This should first purge the 1st row in the purge phase, and then try to move the\r\nlast row on page 1 to page 0.  \r\n\r\nupdating the space eater row will eat into reserved space which may also be an interesting test, but is different than dropping and recreating the table.  \r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2008-05-30T16:53:17.469+0000","updated":"2008-05-30T16:53:17.469+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12394048/comment/12601223","id":"12601223","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Mike for the useful information. I will work first on getting the log output.\r\n\r\nAttached is the derby.log and the database.  I tried connecting to the database with ij and compressing the table and it compressed ok.   This database is actually after that compress. Let me know if you need a db before the compress and I will try to get that.\r\n\r\nKathey\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-05-30T19:05:08.535+0000","updated":"2008-05-30T19:05:08.535+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12394048/comment/12601234","id":"12601234","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Reattaching log and database on which compress has not been run.  This came from just running a modified lang suite in which we don't run any tests after the failing test.\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-05-30T19:49:44.827+0000","updated":"2008-05-30T19:49:44.827+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12394048/comment/12601251","id":"12601251","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I printed the source and destination page and the row_size. The log is attached in derby_log_wdebug.zip  I wasn't quite sure how to get the table properties from this context.\r\n\r\nThis is the code I added:\r\n      try {\r\n                \tcopyAndPurge(dest_page, slot, 1, dest_slot);\r\n                } catch (StandardException e) {\r\n                \tif (SanityManager.DEBUG)\r\n                \t{\r\n                \t\tSanityManager.DEBUG_PRINT(\"row_size\", \"\" + row_size);\r\n                \t\tSanityManager.DEBUG_PRINT(\"dest_page\", dest_page.toString());\r\n                \t\tSanityManager.DEBUG_PRINT(\"src_page\", this.toString());\r\n                \t}                \t\r\n                \tthrow e;                \t\r\n                }\r\n\r\nPlease let me know if something else/more  would be more useful.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-05-30T21:05:18.655+0000","updated":"2008-05-30T21:05:18.655+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12394048/comment/12601261","id":"12601261","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"From the latest log I am going to guess the problem has to do with mismatch on reserved space calculation.  The row size is 91 and there are 97 bytes on page so it seems like it should fit.  But the \r\ncalculation in CopyRowsOperation is more complicated.  If you can reproduce it again and get a dump\r\nof information from that routine it would confirm.\r\n\r\nThe interesting code is in CopyRowsOperation:\r\n// page is the destination page.\r\nif (!page.spaceForCopy(num_rows, spaceNeeded))\r\n{\r\n    throw StandardException.newException(\r\n            SQLState.DATA_NO_SPACE_FOR_RECORD);\r\n}\r\n\r\ndumping out the spaceNeeded variable and the reservedSpace array would help.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2008-05-30T21:29:02.146+0000","updated":"2008-05-30T21:29:02.146+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12394048/comment/12601266","id":"12601266","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"For this page size (4k), the slot entry size is 6 bytes so from the dumped calculation it should fit exactly - so\r\nthere may be an off by one error somewhere or maybe a > where there should be >=  or something like that.\r\nit's all guesses but since it happens so infrequently seems more likely special case for exactly fitting then generic problem with accounting for reserved space - but don't know.  \r\n\r\nIt is probably worth adding dumps of the following 2 to the page header dumping in StoredPage, they\r\nare really container level info but doesn't hurt to add them to the sanity toString for the page.\r\nspareSpace \r\nminimumRecordSize  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2008-05-30T21:47:44.336+0000","updated":"2008-05-30T21:47:44.336+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12394048/comment/12601279","id":"12601279","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Here is the subset of the log with the spaceNeeded and reservedSpace.  We seem to be off by one in space needed.\r\n\r\nDEBUG spaceNeeded OUTPUT: { 92 }\r\nDEBUG reservedSpace OUTPUT: { 0 }\r\nDEBUG row_size OUTPUT: 91\r\n...\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-05-30T22:37:26.861+0000","updated":"2008-05-30T22:37:26.861+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12394048/comment/12601301","id":"12601301","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I think i understand what is going on, and the previous test description probably does not cause this\r\nbug.  Not sure what right fix is yet.\r\n\r\nI went back to the original page dumps, and think I know the problem.  Compress is using the old length\r\nto find a suitable page, but it turns out the length of the row is actually variable because the record id is\r\nchanging.  In this case the soruce page record id is 40 and the next record id on the dest page is 69.\r\n\r\nFor complete doc on record format see javadoc in StoredPage at top - search for Record & Field Format.\r\nbut short answer is that records include a record header (StoredRecordHeader) and \r\nStoredRecordHeader writes out the record id using a Compressed Int (see CompressedNumber) and\r\nthe break down for size for the compressed number is:\r\n\r\n    /**\r\n        Write a compressed integer only supporting signed values.\r\n        Formats are (with x representing value bits):\r\n        <PRE>\r\n        1 Byte - 00xxxxxx                              Represents the value <= 63 (0x3f)\r\n        2 Byte - 01xxxxxx xxxxxxxx                     Represents the value > 63 && <= 16383 (0x3fff)\r\n        4 byte - 1xxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx   Represents the value > 16383 && <= MAX_INT\r\n        </PRE>\r\n\r\n\r\n        @exception IOException value is negative or an exception was thrown by a\r\n method on out.\r\n    */","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2008-05-30T23:32:21.313+0000","updated":"2008-05-30T23:32:21.313+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12394048/comment/12601307","id":"12601307","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"One option is to only allow compress to pick pages that will handle worst case expansion, so do something \r\nlike the following in moveRecordForCompressAtSlot().\r\n\r\ndest_row_size = row_size + StoredRecordHeader.MAX_RECORD_ID_INCREASE where the new constant is 3.\r\n\r\nor do something more dynamic to get it exactly right (variable names/fields are not right)\r\ndest_row_size = row_size + StoredRecordHeader.size_of_recordid(destpage.nextid) - StoredRecordHeader.size_of_recordid(source record id).   \r\nThe StoredRecordHeader.size() has code to do this kind of stuff for the whole record header.\r\n\r\nThe copy record code existed before compress but it's usage never ran into this issue.  It was only used\r\nduring a btree split, so all records would always be going to a new page.  So in that case all the destination\r\nrecord id's had to be either the same or smaller than the source id's as we only split and move rows to \r\na new page.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2008-05-30T23:58:34.195+0000","updated":"2008-05-30T23:58:34.195+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12394048/comment/12601310","id":"12601310","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I believe there is another bug in this code, in the final try at finding a page to move the row to we try and\r\nget an empty page.  The assumption was that the copy would always work to an empty page, but for the same reason as described above the copy of the row to an empty page\r\nmay not work if the new page is actually a reclaimed page which in the past has used up record id's.  So\r\nthe same spaceForCopy check should be added to it as the above 2, and if it does not work just set\r\nthe candidate page to null and fall through.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2008-05-31T00:08:25.756+0000","updated":"2008-05-31T00:08:25.756+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12394048/comment/12601316","id":"12601316","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Just making sure I understand: the old record ID was 40, and thus fit in a\r\nsingle byte in the StoredRecordHeader, while the new record ID was 69,\r\nwhich takes *two* bytes in the StoredRecordHeader?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2008-05-31T01:06:33.156+0000","updated":"2008-05-31T01:06:33.156+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12394048/comment/12609788","id":"12609788","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"Fix has been applied to trunk, 10.4, and 10.3 codeline.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2008-07-02T03:55:51.241+0000","updated":"2008-07-02T03:55:51.241+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3625/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06szz:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12388899","self":"https://issues.apache.org/jira/rest/api/latest/issue/12388899","key":"DERBY-3428","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2008-02-22 13:37:16.563","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23639","customfield_12310222":"1_*:*_1_*:*_1528425673_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_14973","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-03-06T23:14:45.222+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3428/watchers","watchCount":0,"isWatching":false},"created":"2008-02-18T06:40:59.549+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12319287","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12319287","type":{"id":"10032","name":"Blocker","inward":"is blocked by","outward":"blocks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10032"},"inwardIssue":{"id":"12389382","key":"DERBY-3455","self":"https://issues.apache.org/jira/rest/api/2/issue/12389382","fields":{"summary":"Move replication methods from org.apache.derby.database.Database to org.apache.derby.iapi.db.Database","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12319323","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12319323","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"outwardIssue":{"id":"12387967","key":"DERBY-3394","self":"https://issues.apache.org/jira/rest/api/2/issue/12387967","fields":{"summary":"'NetworkServerControl shutdown' does not complete on master server after 'failover'.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2008-03-06T23:15:00.194+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312050","id":"12312050","name":"Replication"}],"timeoriginalestimate":null,"description":"Oystein says (as part of comments in Derby-3205)\n\nAfter executing a failover, I am told that the database is shut down, but I still able to use the connection to access the database:\n\nij version 10.4\nij> connect 'jdbc:derby:masterDB;user=oystein;password=pass';\nij> call syscs_util.syscs_freeze_database();\n0 rows inserted/updated/deleted\nij> connect 'jdbc:derby:masterDB;user=oystein;password=pass;startMaster=true;slaveHost=localhost';\nij(CONNECTION1)> call syscs_util.syscs_unfreeze_database();\n0 rows inserted/updated/deleted\nij(CONNECTION1)> connect 'jdbc:derby:masterDB;user=oystein;password=pass;failover=true';\nERROR XRE20: Failover performed successfully for database 'null', the database has been shutdown.\nij(CONNECTION1)> select * from t;\nI\n-----------\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n10\n\n11 rows selected\nij(CONNECTION1)>","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39519","summary":"Doing a replication failover should shutdown the database and the connection should no longer be available","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":14,"total":14,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12388899/comment/12570935","id":"12570935","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"Thank you for the suggestions Jorgen on the reply to the email requesting more information on the\r\nhandleException method in EmbedConnection. Following the suggested steps I found that throwing an exception with a Database severity does shutdown the database, but, only if it is not frozen :-/.\r\n\r\nDuring failover, before flushing the log records from the master to the slave, we freeze the\r\ndatabase in question to prevent any more transactions from committing, since, these would never\r\nbe conveyed to the slave. Allowing them to proceed would result in inconsistency. We do not\r\nunfreeze before throwing a database severity exception to cause a shutdown in case of a \r\nsuccessful failover. This causes a hang when we try to shutdown.\r\n\r\nThe obvious workaround was to unfreeze and then throw the exception. But this exposes a window,\r\nbetween unfreezing and throwing the exception when I suspect there is the danger of transactions\r\ncommmiting. But the exception that is thrown upon failover should alert the clients that the\r\ndanger of the previous transaction being lost exists.\r\n\r\nI am submitting a patch using the workaround above and hoping that the community can advice me\r\nmore here.\r\n\r\nDuring the course of developing this patch I observed that we should have a tearDown method on\r\nthe transmitter that the log shipper could call when it does a stopShipment. This would basically\r\nbring down the socket and the associated streams. I am *not* submitting this as part of this patch. \r\n\r\nAlso the socket needs a timeout for reads on the InputStream obtained from it but I guess there is a \r\nJIRA for that already.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-21T04:17:37.329+0000","updated":"2008-02-21T04:17:37.329+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12388899/comment/12570964","id":"12570964","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"The repro says this with the attached patch.\r\n\r\nij version 10.4\r\nij> connect 'jdbc:derby:masterDB;user=oystein;password=pass';\r\nij> call syscs_util.syscs_freeze_database();\r\n0 rows inserted/updated/deleted\r\nij> connect 'jdbc:derby:masterDB;user=oystein;password=pass;startMaster=true;slaveHost=localhost'; \r\nij(CONNECTION1)> connect 'jdbc:derby:masterDB;user=oystein;password=pass;failover=true'; \r\nERROR XRE20: Failover performed successfully for database 'masterDB', the database has been shutdown.\r\nij(CONNECTION1)> select * from t;\r\nERROR 08003: No current connection.\r\nij(CONNECTION1)>","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-21T07:11:54.583+0000","updated":"2008-02-21T07:11:54.583+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12388899/comment/12571404","id":"12571404","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"body":"Hi Narayanan,\r\n\r\nThe patch basically looks good. A few minor comments:\r\n\r\n1. MasterController: \"to shutdown the database\" written twice.\r\n2. Database: @throws tag referst to SQLException while a StandardException is thrown\r\n3. I am a little concerned that StandardException has to be introduced to the o.a.d.database.Database interface. I read the comments in that file a couple of times, and it seems that this interface is for methods that are external, like system procedures. I think o.a.d.iapi.db.Database would be more fitting since failover can only be called intarnally (hence i(nternal)api). This does not only apply to the failover method, but to all the replication methods.\r\n\r\nIt's OK with me to solve 3. in a follow-up patch since it involves code that was not touched by this patch. You mention that stream.close is not handled in this patch, so I guess a follow-up patch (or patch in another jira) is needed anyway.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"created":"2008-02-22T13:37:16.563+0000","updated":"2008-02-22T13:37:16.563+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12388899/comment/12571702","id":"12571702","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":">It's OK with me to solve 3. in a follow-up patch since it involves code\r\n>that was not touched by this patch. You mention that stream.close \r\n>is not handled in this patch, so I guess a follow-up patch (or patch\r\n>in another jira) is needed anyway.\r\n\r\nI am NOT OK with resolving this issue in a follow-up patch attached to this issue either.\r\nThis is a generic issue that has been raised in question to all the methods of the replication\r\nimplementation, why should it be resolved in a issue that is related to a specific problem\r\nof the failover implementation.\r\n\r\nI believe a separate JIRA needs to be raised indicating the problem and the fix needs\r\nto go there. If this JIRA is going to act as a stopper to committing this issue I would be\r\nOK with that.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-23T04:52:06.550+0000","updated":"2008-02-23T04:53:07.801+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12388899/comment/12571704","id":"12571704","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"Narayanan says\r\n\r\n>During the course of developing this patch I observed that we should have a tearDown method on\r\n>the transmitter that the log shipper could call when it does a stopShipment. This would basically\r\n>bring down the socket and the associated streams. I am *not* submitting this as part of this patch.\r\n\r\nJorgen says\r\n\r\n>You mention that stream.close is not handled in this patch, so I guess a follow-up patch (or patch in\r\n>another jira) is needed anyway.\r\n\r\nI submitted a patch for resolving this issue in Derby-3364. Derby-3364 was basically due to\r\nunsatisfactory cleanup upon replication failover attempts (A failover attempt can basically\r\nsucceed or fail, cleanup needs to be done either way.)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-23T05:19:32.762+0000","updated":"2008-02-23T05:19:32.762+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12388899/comment/12571881","id":"12571881","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"Derby-3455 issue moves replication methods from org.apache.derby.database.Database to org.apache.derby.iapi.db.Database. \r\n\r\nIn this issue we need to change the failover method in BasicDatabase to throw a \r\nStandardException, which is then handled by the handleException method in \r\nEmbedConnection.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-24T08:58:49.920+0000","updated":"2008-02-24T08:58:49.920+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12388899/comment/12571887","id":"12571887","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"* This patch is not for a commit *\r\n\r\nI tried integrating the Derby-3455 and the Derby-3428 patches\r\nand tried running the repro. It runs fine.\r\n\r\nDuring the course of the run I observed that if a slave is started\r\non a port that is being already used I get the following exception\r\n\r\nERROR XJ040: Failed to start database 'masterDB', see the next exception for details.\r\nERROR XRE04: Could not establish a connection to the peer of the replicated database 'masterDB' on address 'localhost:8001'.\r\n\r\nI am not sure this is the right message in this situation. I think port in use will be\r\na better exception here.I will wait till tomorrow and raise a JIRA.\r\n\r\nI also observed that startmaster on a port other than the port at which\r\nthe slave is listening does not allow subsequent attempts at the right port.\r\nI guess there is a JIRA for this already.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-24T10:06:23.122+0000","updated":"2008-02-24T10:06:23.122+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12388899/comment/12572625","id":"12572625","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"body":"Hi Narayanan,\r\n\r\nI tried the latest patch. In embedded, the patch works as expected:\r\n\r\nij> connect 'jdbc:derby:test;startMaster=true;slaveHost=localhost';\r\nij(CONNECTION1)> connect 'jdbc:derby:test;failover=true';\r\nERROR XRE20: Failover performed successfully for database 'test', the database has been shutdown.\r\nij(CONNECTION1)> show tables;\r\nERROR 08003: No current connection.\r\n\r\n\r\nbut in client/server I get:\r\n\r\nij> connect 'jdbc:derby://localhost:1527/test;startMaster=true;slaveHost=localhost';\r\nij(CONNECTION1)> connect 'jdbc:derby://localhost:1527/test;failover=true';\r\nERROR XRE20: DERBY SQL error: SQLCODE: -1, SQLSTATE: XRE20, SQLERRMC: Failover performed successfully for database 'test', the database has been shutdown.\r\nij(CONNECTION1)> show tables;\r\nERROR 08006: A network protocol error was encountered and the connection has been terminated: the requested command encountered an unarchitected and implementation-specific condition for which there was no architected message\r\n\r\nDerby.log does not contain more info than the failover successful stack trace.\r\n\r\nDo we need a new jira for this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"created":"2008-02-26T19:44:03.747+0000","updated":"2008-02-26T19:44:03.747+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12388899/comment/12572788","id":"12572788","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"Some more observations\r\n---------------------------\r\n\r\n* Attempts to access the connection after this message\r\n   results in a appropriate ERROR 08003. \r\n\r\n* The message also correctly says that the connection has been terminated.\r\n\r\n* The connection terminates as expected but the initial message needs to \r\n   be investigated.\r\n\r\nConclusions\r\n-----------\r\n\r\n* I do not think we need to investigate this issue at the present stage.\r\n\r\n* I don't see any danger in the patch retaining its present behaviour\r\n\r\n* *But post-commit a JIRA needs to be raised for this.*","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-27T04:55:50.833+0000","updated":"2008-02-27T04:55:50.833+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12388899/comment/12572852","id":"12572852","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"body":"I tried the following:\r\n\r\n---8<----\r\nterm1: start NS\r\nterm2: boot database '//localhost/test'\r\nterm3: shutdown '//localhost/test'\r\nterm2: show tables\r\n\r\nERROR 08006: A network protocol error was encountered and the connection has been terminated: the requested command encountered an unarchitected and implementation-specific condition for which there was no architected message\r\n--->8------\r\n\r\nHence, this is the message you get when you try to do something with a connection to a database that has been closed. It is not replication-specific. I'll open a new jira for this.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jorgenlo","name":"jorgenlo","emailAddress":"jorgen dot loland at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jørgen Løland","active":true},"created":"2008-02-27T10:06:13.926+0000","updated":"2008-02-27T10:06:13.926+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12388899/comment/12573149","id":"12573149","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"The attached patch removes the dependency on 3455 \r\n\r\nPls find the repro run below\r\n\r\nvn@vn-laptop:~/work/workspaces/Derby3428_v1/master$ java org.apache.derby.tools.ij\r\nij version 10.4\r\nij> connect 'jdbc:derby:masterDB;user=oystein;password=pass;create=true';\r\nij> call syscs_util.syscs_freeze_database();\r\n0 rows inserted/updated/deleted\r\nij> connect 'jdbc:derby:masterDB;user=oystein;password=pass;startMaster=true;slaveHost=localhost;slavePort=8002';\r\nij(CONNECTION1)> connect 'jdbc:derby:masterDB;user=oystein;password=pass;failover=true'; \r\nERROR XRE20: Failover performed successfully for database 'masterDB', the database has been shutdown.\r\nij(CONNECTION1)> select * from sys.systables;\r\nERROR 08003: No current connection.\r\nij(CONNECTION1)>","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-28T04:36:20.401+0000","updated":"2008-02-28T04:36:20.401+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12388899/comment/12573819","id":"12573819","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"Patch v2 committed as revision 632369.\r\nI have verified that the reported problem has been fixed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-02-29T16:34:39.497+0000","updated":"2008-02-29T16:34:39.497+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12388899/comment/12573823","id":"12573823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"Thank you for the commit Oystein","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-02-29T16:41:48.112+0000","updated":"2008-02-29T16:41:48.112+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12388899/comment/12575947","id":"12575947","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"body":"All relevant patches have been committed. Resolving issue!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narayanan","name":"narayanan","emailAddress":"v dot narayanan at sun dot com-disabled","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"V.Narayanan","active":true},"created":"2008-03-06T23:14:45.219+0000","updated":"2008-03-06T23:14:45.219+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3428/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i074nb:"}}
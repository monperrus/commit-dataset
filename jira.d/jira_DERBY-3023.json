{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12376689","self":"https://issues.apache.org/jira/rest/api/latest/issue/12376689","key":"DERBY-3023","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311972","id":"12311972","description":"","name":"10.1.3.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312251","id":"12312251","description":"Head of 10.2 branch","name":"10.2.2.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313142","id":"12313142","description":"","name":"10.3.3.0","archived":false,"released":true,"releaseDate":"2008-05-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2007-08-23 15:27:10.015","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23380","customfield_12310222":"1_*:*_1_*:*_12644414551_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-01-16T16:52:15.256+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3023/watchers","watchCount":0,"isWatching":false},"created":"2007-08-23T08:32:00.705+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"10.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12310615","id":"12310615","description":"","name":"10.1.2.1","archived":false,"released":true,"releaseDate":"2005-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12317886","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12317886","type":{"id":"12310010","name":"Incorporates","inward":"is part of","outward":"incorporates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310010"},"inwardIssue":{"id":"12354628","key":"DERBY-2034","self":"https://issues.apache.org/jira/rest/api/2/issue/12354628","fields":{"summary":"Tracking of bugs that lead to incorrect results being stored or returned to the client","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/5","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/trivial.png","name":"Trivial","id":"5"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/3","id":"3","description":"A task that needs to be done.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/task.png","name":"Task","subtask":false}}}},{"id":"12318222","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12318222","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12366604","key":"DERBY-2526","self":"https://issues.apache.org/jira/rest/api/2/issue/12366604","fields":{"summary":"Wrong results with queries that use the JOIN ... ON syntax to join with views or other non-base table expressions.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12358183","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12358183","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12608438","key":"DERBY-5933","self":"https://issues.apache.org/jira/rest/api/2/issue/12608438","fields":{"summary":"SQL sorting error","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-09-25T15:46:13.481+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"We have a complex SQL joining 11 Tables via INNER JOIN and OUTER JOIN.\nThese SQLs were tested against an z/OS DB2 Version 8.\nAfter moving to our local platform with Derby we found out the resultsets returned by the SQLs were too less.\n\nI tested our \"old style\" SQL which results in 889 rows.\nOur new style SQL expected to give similar rows but gives *0*.\n\nAfter some work we found a workaround: first place all the \"INNER JOIN\"s in the SQL and then the \"OUTER JOIN\"s.\n\n{code:title=Result of testprogram}\nDerby=10.3-b561794\nTest 10.3-b561794-old-style-sql\n889 Rows in 1703ms\nTest 10.3-b561794-new-style-sql\n0 Rows in 563ms  _(expected 924 rows instead)_\nTest 10.3-b561794-new-style-sql-only-inner\n2 Rows in 766ms _(only inner joins, no outer joins but larger result)_\nTest 10.3-b561794-new-style-sql_first-inner-joins\n924 Rows in 578ms\nTest 10.3-b561794-new-style-sql_without-condition\n924 Rows in 438ms\n{code}\n\nHere our initial used SQL:\n{code:title=SQL giving wrong result (0 rows)}\nSELECT O4Work.ESVN01.NU_BUY_CPY AS PO_BuyCompanyNo, O4Work.ESVN01.NU_ODR AS PO_Number, O4Work.ESVN01.FL_ODR_CAE AS PO_Type, O4Work.ESVN01.NU_MCS_SPY AS PO_SupplierNo, O4Work.ESVN01.NU_ST3 AS PO_StatusNo, O4Work.ESVN01.DA_SPY_COY_PRT AS PO_SCPrintDate, O4Work.ESVN01.FL_SAS AS PO_SeasFlag, CASE WHEN (SELECT COUNT(O4Work.ESVNA5.ID_PTE) FROM O4Work.ESVNA5 WHERE O4Work.ESVN02.NU_BUY_CPY = O4Work.ESVNA5.NU_BUY_CPY AND O4Work.ESVN02.NU_ODR = O4Work.ESVNA5.NU_ODR AND O4Work.ESVN02.NU_PST = O4Work.ESVNA5.NU_PST) = 0 THEN 'N' ELSE 'Y' END AS POPA_PictureID, CASE WHEN (SELECT COUNT(O4Work.ESVNG3.NU_ODR) FROM O4Work.ESVNG3 WHERE O4Work.ESVN01.NU_BUY_CPY = O4Work.ESVNG3.NU_BUY_CPY AND O4Work.ESVN01.NU_ODR = O4Work.ESVNG3.NU_ODR) = 0 THEN 'N' ELSE 'Y' END AS ON_ID, O4Work.ESVN02.NU_PST AS POP_Position_Id, O4Work.ESVN02.NU_CTT AS POP_ContractNo, O4Work.ESVN02.NU_ARO_CTT AS POP_ArosContractNo, O4Work.ESVN02.NU_ST3 AS POP_StatusNo, O4Work.ESVN02.DA_CAE AS POP_CreationDate, O4Work.ESVN02.DA_LAT_AMD AS POP_LastAmendDate, O4Work.ESVNA0.NU_SSN_IDE AS POPD_SeasonInd,  O4Work.ESVNA0.NU_STL_ID1 AS POPD_StyleId, O4Work.ESVNA0.NU_SRY_ID1 AS POPD_StoryID, O4Work.ESVNA0.NU_LC1 AS POPD_LicenseID, O4Work.ESVP00.NU_CSY AS SER_ClassNo, O4Work.ESVP00.NU_COE AS SER_CodeNo, O4Work.ESVP00.NU_SRL AS SER_SerialNo, O4Work.ESVP00.NU_PIK_MOD AS SER_PickingM, O4Work.ESVN03.NU_MT1_CPY AS POPC_MasterCpyNo, O4Work.ESVN03.QU_ODR AS POPC_OrderedQty, O4Work.ESVN03.DA_EDD AS POPC_Edd, O4Work.ESVN03.DA_LDD AS POPC_Ldd, O4Work.ESVN03.DA_PAD AS POPC_Pad, O4Work.ESVN03.DA_SAD AS POPC_Sad, O4Work.ESVN03.PR_SCP AS POPC_SupCstPrice, O4Work.ESVN03.NU_SCP_CR1 AS POPC_SupCstPrCurr, O4Work.ESVN03.NU_ST3 AS POPC_StatusNo, O4Work.ESVN03.NU_COY_FRM_ODR AS POPC_Src_PO_Number, O4Work.ESVN03.NU_COY_UTL_ODR AS POPC_Tgt_PO_Number, O4Work.ESVN03.DA_FLR_RDY AS POPC_FRM_DATE, O4Work.ESVN03.FL_CSG AS POPC_CS_FLAG, O4Work.ESVN03.NU_PAK_MOD_SPY AS POPC_PackSupplNo, O4Work.ESVN03.NU_PAK_MOD_DCR AS POPC_PackingDCNo, O4Work.ESVN03.NU_PS2_MOD AS POPC_PresMethodNo, O4Work.ESVN04.NU_RTL_CPY AS POPRC_RetailCode, O4Work.ESVN04.PR_PLN_SEL AS POPRC_SellPrice, O4Work.ESVN04.NU_PLN_SEL_PRC_CR1 AS POPRC_SellPrCurr, O4Work.ESVN08.NU_AVE AS POPRCA_AdvertNo, O4Work.ESVQ00.ID_SHP AS SHP_ShippingID, O4Work.ESVQ00.NU_SHP AS SHP_ShippingNo, O4Work.ESVNB0.NU_NTL_PDE_ID1 AS POPDC_NationalID, O4Work.ESVNB0.NU_EQP AS POPDC_EquipNumber, O4Work.ESVNE1.PE_OMU AS POPCC_OMU, CASE WHEN (SELECT COUNT(O4Work.ESVN07.NU_ODR) FROM O4Work.ESVN07 WHERE O4Work.ESVN03.NU_BUY_CPY = O4Work.ESVN07.NU_BUY_CPY AND O4Work.ESVN03.NU_MT1_CPY = O4Work.ESVN07.NU_MT1_CPY AND O4Work.ESVN03.NU_ODR = O4Work.ESVN07.NU_ODR AND O4Work.ESVN03.NU_PST = O4Work.ESVN07.NU_PST AND O4Work.ESVN07.FL_ALE_RMK = 'Y') = 0 THEN 'N' ELSE 'Y' END AS POPCU_AllocRem FROM O4Work.ESVN02 \nINNER JOIN O4Work.ESVN01 ON O4Work.ESVN02.NU_BUY_CPY = O4Work.ESVN01.NU_BUY_CPY AND O4Work.ESVN02.NU_ODR = O4Work.ESVN01.NU_ODR \nINNER JOIN O4Work.ESVNA0 ON O4Work.ESVN02.NU_BUY_CPY = O4Work.ESVNA0.NU_BUY_CPY AND O4Work.ESVN02.NU_ODR = O4Work.ESVNA0.NU_ODR AND O4Work.ESVN02.NU_PST = O4Work.ESVNA0.NU_PST \nINNER JOIN O4Work.ESVP00 ON O4Work.ESVNA0.ID_SRL = O4Work.ESVP00.ID_SRL \nLEFT OUTER JOIN O4Work.ESVNA4 ON O4Work.ESVNA0.NU_BUY_CPY = O4Work.ESVNA4.NU_BUY_CPY AND O4Work.ESVNA0.NU_ODR = O4Work.ESVNA4.NU_ODR AND O4Work.ESVNA0.NU_PST = O4Work.ESVNA4.NU_PST \nINNER JOIN O4Work.ESVN03 ON O4Work.ESVN02.NU_BUY_CPY = O4Work.ESVN03.NU_BUY_CPY AND O4Work.ESVN02.NU_ODR = O4Work.ESVN03.NU_ODR AND O4Work.ESVN02.NU_PST = O4Work.ESVN03.NU_PST \nLEFT OUTER JOIN O4Work.ESVN04 ON O4Work.ESVN03.NU_BUY_CPY = O4Work.ESVN04.NU_BUY_CPY AND O4Work.ESVN03.NU_MT1_CPY = O4Work.ESVN04.NU_MT1_CPY AND O4Work.ESVN03.NU_ODR = O4Work.ESVN04.NU_ODR AND O4Work.ESVN03.NU_PST = O4Work.ESVN04.NU_PST \nLEFT OUTER JOIN O4Work.ESVN08 ON O4Work.ESVN04.NU_BUY_CPY = O4Work.ESVN08.NU_BUY_CPY AND O4Work.ESVN04.NU_RTL_CPY = O4Work.ESVN08.NU_RTL_CPY AND O4Work.ESVN04.NU_MT1_CPY = O4Work.ESVN08.NU_MT1_CPY AND O4Work.ESVN04.NU_ODR = O4Work.ESVN08.NU_ODR AND O4Work.ESVN04.NU_PST = O4Work.ESVN08.NU_PST \nINNER JOIN O4Work.ESVQ00 ON O4Work.ESVN03.ID_SHP = O4Work.ESVQ00.ID_SHP \nINNER JOIN O4Work.ESVNB0 ON O4Work.ESVN03.NU_BUY_CPY = O4Work.ESVNB0.NU_BUY_CPY AND O4Work.ESVN03.NU_MT1_CPY = O4Work.ESVNB0.NU_MT1_CPY AND O4Work.ESVN03.NU_ODR = O4Work.ESVNB0.NU_ODR AND O4Work.ESVN03.NU_PST = O4Work.ESVNB0.NU_PST \nINNER JOIN O4Work.ESVNE1 ON O4Work.ESVN03.NU_BUY_CPY = O4Work.ESVNE1.NU_BUY_CPY AND O4Work.ESVN03.NU_MT1_CPY = O4Work.ESVNE1.NU_MT1_CPY AND O4Work.ESVN03.NU_ODR = O4Work.ESVNE1.NU_ODR AND O4Work.ESVN03.NU_PST = O4Work.ESVNE1.NU_PST \nWHERE O4Work.ESVN01.NU_BUY_CPY = 99 AND O4Work.ESVNA0.NU_CPY_GRP = 0\n{code}\nand the one with moved inner joins:\n{code:title=SQL giving correct result (924 rows)}\nSELECT O4Work.ESVN01.NU_BUY_CPY AS PO_BuyCompanyNo, O4Work.ESVN01.NU_ODR AS PO_Number, O4Work.ESVN01.FL_ODR_CAE AS PO_Type, O4Work.ESVN01.NU_MCS_SPY AS PO_SupplierNo, O4Work.ESVN01.NU_ST3 AS PO_StatusNo, O4Work.ESVN01.DA_SPY_COY_PRT AS PO_SCPrintDate, O4Work.ESVN01.FL_SAS AS PO_SeasFlag, CASE WHEN (SELECT COUNT(O4Work.ESVNA5.ID_PTE) FROM O4Work.ESVNA5 WHERE O4Work.ESVN02.NU_BUY_CPY = O4Work.ESVNA5.NU_BUY_CPY AND O4Work.ESVN02.NU_ODR = O4Work.ESVNA5.NU_ODR AND O4Work.ESVN02.NU_PST = O4Work.ESVNA5.NU_PST) = 0 THEN 'N' ELSE 'Y' END AS POPA_PictureID, CASE WHEN (SELECT COUNT(O4Work.ESVNG3.NU_ODR) FROM O4Work.ESVNG3 WHERE O4Work.ESVN01.NU_BUY_CPY = O4Work.ESVNG3.NU_BUY_CPY AND O4Work.ESVN01.NU_ODR = O4Work.ESVNG3.NU_ODR) = 0 THEN 'N' ELSE 'Y' END AS ON_ID, O4Work.ESVN02.NU_PST AS POP_Position_Id, O4Work.ESVN02.NU_CTT AS POP_ContractNo, O4Work.ESVN02.NU_ARO_CTT AS POP_ArosContractNo, O4Work.ESVN02.NU_ST3 AS POP_StatusNo, O4Work.ESVN02.DA_CAE AS POP_CreationDate, O4Work.ESVN02.DA_LAT_AMD AS POP_LastAmendDate, O4Work.ESVNA0.NU_SSN_IDE AS POPD_SeasonInd,  O4Work.ESVNA0.NU_STL_ID1 AS POPD_StyleId, O4Work.ESVNA0.NU_SRY_ID1 AS POPD_StoryID, O4Work.ESVNA0.NU_LC1 AS POPD_LicenseID, O4Work.ESVP00.NU_CSY AS SER_ClassNo, O4Work.ESVP00.NU_COE AS SER_CodeNo, O4Work.ESVP00.NU_SRL AS SER_SerialNo, O4Work.ESVP00.NU_PIK_MOD AS SER_PickingM, O4Work.ESVN03.NU_MT1_CPY AS POPC_MasterCpyNo, O4Work.ESVN03.QU_ODR AS POPC_OrderedQty, O4Work.ESVN03.DA_EDD AS POPC_Edd, O4Work.ESVN03.DA_LDD AS POPC_Ldd, O4Work.ESVN03.DA_PAD AS POPC_Pad, O4Work.ESVN03.DA_SAD AS POPC_Sad, O4Work.ESVN03.PR_SCP AS POPC_SupCstPrice, O4Work.ESVN03.NU_SCP_CR1 AS POPC_SupCstPrCurr, O4Work.ESVN03.NU_ST3 AS POPC_StatusNo, O4Work.ESVN03.NU_COY_FRM_ODR AS POPC_Src_PO_Number, O4Work.ESVN03.NU_COY_UTL_ODR AS POPC_Tgt_PO_Number, O4Work.ESVN03.DA_FLR_RDY AS POPC_FRM_DATE, O4Work.ESVN03.FL_CSG AS POPC_CS_FLAG, O4Work.ESVN03.NU_PAK_MOD_SPY AS POPC_PackSupplNo, O4Work.ESVN03.NU_PAK_MOD_DCR AS POPC_PackingDCNo, O4Work.ESVN03.NU_PS2_MOD AS POPC_PresMethodNo, O4Work.ESVN04.NU_RTL_CPY AS POPRC_RetailCode, O4Work.ESVN04.PR_PLN_SEL AS POPRC_SellPrice, O4Work.ESVN04.NU_PLN_SEL_PRC_CR1 AS POPRC_SellPrCurr, O4Work.ESVN08.NU_AVE AS POPRCA_AdvertNo, O4Work.ESVQ00.ID_SHP AS SHP_ShippingID, O4Work.ESVQ00.NU_SHP AS SHP_ShippingNo, O4Work.ESVNB0.NU_NTL_PDE_ID1 AS POPDC_NationalID, O4Work.ESVNB0.NU_EQP AS POPDC_EquipNumber, O4Work.ESVNE1.PE_OMU AS POPCC_OMU, CASE WHEN (SELECT COUNT(O4Work.ESVN07.NU_ODR) FROM O4Work.ESVN07 WHERE O4Work.ESVN03.NU_BUY_CPY = O4Work.ESVN07.NU_BUY_CPY AND O4Work.ESVN03.NU_MT1_CPY = O4Work.ESVN07.NU_MT1_CPY AND O4Work.ESVN03.NU_ODR = O4Work.ESVN07.NU_ODR AND O4Work.ESVN03.NU_PST = O4Work.ESVN07.NU_PST AND O4Work.ESVN07.FL_ALE_RMK = 'Y') = 0 THEN 'N' ELSE 'Y' END AS POPCU_AllocRem FROM O4Work.ESVN02 \nINNER JOIN O4Work.ESVN01 ON O4Work.ESVN02.NU_BUY_CPY = O4Work.ESVN01.NU_BUY_CPY AND O4Work.ESVN02.NU_ODR = O4Work.ESVN01.NU_ODR \nINNER JOIN O4Work.ESVNA0 ON O4Work.ESVN02.NU_BUY_CPY = O4Work.ESVNA0.NU_BUY_CPY AND O4Work.ESVN02.NU_ODR = O4Work.ESVNA0.NU_ODR AND O4Work.ESVN02.NU_PST = O4Work.ESVNA0.NU_PST \nINNER JOIN O4Work.ESVP00 ON O4Work.ESVNA0.ID_SRL = O4Work.ESVP00.ID_SRL \nINNER JOIN O4Work.ESVN03 ON O4Work.ESVN02.NU_BUY_CPY = O4Work.ESVN03.NU_BUY_CPY AND O4Work.ESVN02.NU_ODR = O4Work.ESVN03.NU_ODR AND O4Work.ESVN02.NU_PST = O4Work.ESVN03.NU_PST \nINNER JOIN O4Work.ESVNB0 ON O4Work.ESVN03.NU_BUY_CPY = O4Work.ESVNB0.NU_BUY_CPY AND O4Work.ESVN03.NU_MT1_CPY = O4Work.ESVNB0.NU_MT1_CPY AND O4Work.ESVN03.NU_ODR = O4Work.ESVNB0.NU_ODR AND O4Work.ESVN03.NU_PST = O4Work.ESVNB0.NU_PST \nINNER JOIN O4Work.ESVQ00 ON O4Work.ESVN03.ID_SHP = O4Work.ESVQ00.ID_SHP \nLEFT OUTER JOIN O4Work.ESVNA4 ON O4Work.ESVNA0.NU_BUY_CPY = O4Work.ESVNA4.NU_BUY_CPY AND O4Work.ESVNA0.NU_ODR = O4Work.ESVNA4.NU_ODR AND O4Work.ESVNA0.NU_PST = O4Work.ESVNA4.NU_PST \nLEFT OUTER JOIN O4Work.ESVN04 ON O4Work.ESVN03.NU_BUY_CPY = O4Work.ESVN04.NU_BUY_CPY AND O4Work.ESVN03.NU_MT1_CPY = O4Work.ESVN04.NU_MT1_CPY AND O4Work.ESVN03.NU_ODR = O4Work.ESVN04.NU_ODR AND O4Work.ESVN03.NU_PST = O4Work.ESVN04.NU_PST \nLEFT OUTER JOIN O4Work.ESVN08 ON O4Work.ESVN04.NU_BUY_CPY = O4Work.ESVN08.NU_BUY_CPY AND O4Work.ESVN04.NU_RTL_CPY = O4Work.ESVN08.NU_RTL_CPY AND O4Work.ESVN04.NU_MT1_CPY = O4Work.ESVN08.NU_MT1_CPY AND O4Work.ESVN04.NU_ODR = O4Work.ESVN08.NU_ODR AND O4Work.ESVN04.NU_PST = O4Work.ESVN08.NU_PST \nINNER JOIN O4Work.ESVNE1 ON O4Work.ESVN03.NU_BUY_CPY = O4Work.ESVNE1.NU_BUY_CPY AND O4Work.ESVN03.NU_MT1_CPY = O4Work.ESVNE1.NU_MT1_CPY AND O4Work.ESVN03.NU_ODR = O4Work.ESVNE1.NU_ODR AND O4Work.ESVN03.NU_PST = O4Work.ESVNE1.NU_PST \nWHERE O4Work.ESVN01.NU_BUY_CPY = 99 AND O4Work.ESVNA0.NU_CPY_GRP = 0\n{code}\n\nAnother curious behavior is that leaving out the condition {{O4Work.ESVNA0.NU_CPY_GRP = 0}} in the first SQL will give us the result of 924 all having O4Work.ESVNA0.NU_CPY_GRP = 0. So evaluation of the condition is buggy, too.\n\nI think there may be a dependency between this issue and these ones:\n[DERBY-1681|http://issues.apache.org/jira/browse/DERBY-1681] (Regression (wrong results): Join predicate can be ignored for left-most child in a chain of nested unions.)\n[DERBY-1633|https://issues.apache.org/jira/browse/DERBY-1633] (Regression: The fields of views are not being calculated properly since 10.1.2.4)\n\nAttached is an Eclipse project with the Test-Program (without the Derby-Libraries) and the several RUNTIMESTATISTICS.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"35384","summary":"Different result rows depending on the sequence of INNER JOIN and OUTER JOIN","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trippeltrappel","name":"trippeltrappel","emailAddress":"cordes at retail-sc dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stefan Cordes","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10101","value":"Release Note Needed","id":"10101"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trippeltrappel","name":"trippeltrappel","emailAddress":"cordes at retail-sc dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stefan Cordes","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Windows XP, Java 1.4.2","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":16,"total":16,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12522176","id":"12522176","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Am I right in understanding that this error (wrong results) is reproduceable with Derby 10.1.2.*1*?\r\n\r\nIf so, then that's useful information: DERBY-1681 and DERBY-1633 were regressions caused by changes for DERBY-805, and the first commit for DERBY-805 (there were many) went into 10.2 with svn #381859.  The first DERBY-805 changes were then ported back to the 10.1 branch with svn #396211.  But that's *after* the 10.1.2.1 release was cut--10.1.2.1 was released at svn # 330608, per:\r\n\r\n  http://db.apache.org/derby/derby_downloads.html#Archived+Official+Releases\r\n\r\nSo if this bug does actually affect 10.1.2.*1*, then we can say with some degree of certainty that this particular Jira is *not* a regression caused by DERBY-805 (nor any of the DERBY-805 follow-up work).  That's a good indication that the problem has been around for a while, which helps narrow down the searching field.  It is quite possible that the problem resides in the code that was changed for DERBY-1681 and/or DERBY-1633, but it would be good to know for sure whether or not those Jiras are actually the cause, or just different problems in the same area of code.\r\n\r\nI do not have time to try to run the repro against 10.1.2.1 right now, but if you could confirm that the problem does exist there, I do think that would be helpful...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2007-08-23T15:27:10.015+0000","updated":"2007-08-23T15:27:10.015+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12523555","id":"12523555","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trippeltrappel","name":"trippeltrappel","emailAddress":"cordes at retail-sc dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stefan Cordes","active":true},"body":"Hallo!\r\nThis bug does affect 10.1.2.1. Even 10.1.1.0 is affected.\r\n\r\nI tested with some of the Derby releases and all have the exactly the same (wrong) resultset depending on the join order:\r\nStatement10.1.1.0 - (208786)-j1.4.2_10\r\nStatement10.1.2.1 - (330608)-j1.4.2_10\r\nStatement10.1.2.2 - (349064)-j1.4.2_10\r\nStatement10.1.2.2 - (370021)-j1.4.2_10\r\nStatement10.2.2.0 - (485682)-j1.4.2_10\r\nStatement10.3.1.4 - (561794)-j1.4.2_10\r\n\r\nIn addition I mixed our Joins to all possible combinations and found out e.g.\r\nThe join order \r\nNA0-P00-NA4-N01-N03-NE1-N04-N08-NB0-Q00\tgives 924 rows,\r\nbut \r\nNA0-P00-NA4-N01-N03-NE1-N04-N08-Q00-NB0\tonly 0 rows.\r\n(Only last to tables are switched)\r\n\r\nComparing the statistics the sucessful SQL with Q00 as right join (Rows seen = 924)\r\n\r\n\tRight result set:\r\n\t\tHash Scan ResultSet for ESVQ00 at read committed isolation level using instantaneous share table locking: \r\n\t\tNumber of opens = 924\r\n\t\tHash table size = 60\r\n\t\tHash key is column number 0\r\n\t\tRows seen = 924\r\n\t\tRows filtered = 0\r\n\t\t\tconstructor time (milliseconds) = 0\r\n\t\t\topen time (milliseconds) = 0\r\n\t\t\tnext time (milliseconds) = 0\r\n\t\t\tclose time (milliseconds) = 0\r\n\t\t\tnext time in milliseconds/row = 0\r\n\r\n\t\tscan information: \r\n\t\t\tBit set of columns fetched={0, 6}\r\n\t\t\tNumber of columns fetched=2\r\n\t\t\tNumber of pages visited=3\r\n\t\t\tNumber of rows qualified=60\r\n\t\t\tNumber of rows visited=60\r\n\r\nbut on the other hand (Rows seen = 0) with NB0 as most right join:\r\n\r\n\tRight result set:\r\n\t\tHash Scan ResultSet for ESVNB0 at read committed isolation level using instantaneous share table locking: \r\n\t\tNumber of opens = 924\r\n\t\tHash table size = 0\r\n\t\tHash keys are column numbers (1,2)\r\n\t\tRows seen = 0\r\n\t\tRows filtered = 0\r\n\t\t\tconstructor time (milliseconds) = 0\r\n\t\t\topen time (milliseconds) = 0\r\n\t\t\tnext time (milliseconds) = 0\r\n\t\t\tclose time (milliseconds) = 0\r\n\r\n\t\tscan information: \r\n\t\t\tBit set of columns fetched={0, 1, 2, 3, 6, 8}\r\n\t\t\tNumber of columns fetched=6\r\n\t\t\tNumber of pages visited=8\r\n\t\t\tNumber of rows qualified=0\r\n\t\t\tNumber of rows visited=240\r\n\r\nMaybe that helps.\r\n\r\nI attach the complete results from all versions I tested as derby-02-search-joins2.zip","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trippeltrappel","name":"trippeltrappel","emailAddress":"cordes at retail-sc dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stefan Cordes","active":true},"created":"2007-08-29T12:16:00.919+0000","updated":"2007-08-29T12:16:00.919+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12536484","id":"12536484","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"I did some tracing through the execution-time result set processing for \"new-style-sql.txt\" and while I still do not understand what is going on, I *think* that part of the problem is that the two predicates for the outer-most query, i.e.:\r\n\r\n  WHERE O4Work.ESVN01.NU_BUY_CPY = 99 AND O4Work.ESVNA0.NU_CPY_GRP = 0\r\n\r\nare both being applied as \"scan qualifiers\" to the initial scans for ESVNB0 and ESVNE1, in addition to being applied to their respective target tables.  That is to say, \"NU_BUY_CPY = 99\" translates into a qualifier on the \"first column\" in ESVN01 (because NU_BUY_CPY is the first column in that table); but further up the result set tree, that same qualifier is being applied to the \"first column\" of ESVNB0 and (still later) to the \"first column\" of ESVNE1--which, if that's what is actually happening, would be wrong...\r\n\r\nSimilarly, \"NU_CPY_GRP = 0\" translates into a qualifier on the \"fourth column\" of ESVNA0 (because NU_CPY_GRP is the fourth column in that table); but later that same qualifier is being applied to the \"fourth column\" of ESVNB0 and (still later) the \"fourth column\" of ESVNE1.\r\n\r\nThe reason the query returns the correct results (924 rows) if there is only one predicate, \"ESVN01.NU_BUY_CPY = 99\", is because, as luck would have it, the first column in both ESVNB0 and ESVNE1 is *also* NU_BUY_CPY, and it, like ESVN01, has the value 99 for all rows.  So even though the predicate is (apparently) mis-applied, it doesn't affect the results because it doesn't actually filter any rows.\r\n\r\nBut the second predicate, \"ESVNA0.NU_CPY_GRP = 0\", does affect the results because the fourth column of ESVNB0 and ESVNE1 is \"NU_MT1_CPY\", and that column does not have any rows with value \"0\".  So when the predicate is mis-applied to ESVNB0, it eliminates all of ESVNB0's rows, thus causing the query to return no results.\r\n\r\nIn an attempt to validate this somewhat bizarre theory, I updated a few of the rows in ESVNB0 to have the value \"0\" for column NU_MT1_CPY:\r\n\r\n  update o4work.esvnb0 set nu_mt1_cpy = 0 where nu_mt1_cpy = 2;\r\n\r\nWhen I re-ran \"new-style-sql.txt\", the query still returned 0 rows.  Further tracing showed that we were now getting some rows back from ESVNB0, but then we were joining them with ESVNE1--and since ESVNE1 still didn't have any NU_MT1_CPY columns with value 0, we were filtering out all of ESVNE1's rows, leading to an empty result set.  So I then updated ESVNE1 in a way similar to ESVNB0, ie:\r\n\r\n  update o4work.esvne1 set nu_mt1_cpy = 0 where nu_mt1_cpy = 2;\r\n\r\nWhen I did that, \"new-style-sql.txt\" returned 906 rows.  This seems to suggest (though it's far from conclusive) that the NU_CPY_GRP qualifier is being mis-applied in the hash scans for ESVNB0 and ESNB1.\r\n\r\nA look at the query plans for \"new-style-sql_without-condition.txt\" and \"new-style-sql.txt\" seems to suggest a similar thing.  Note in particular the scan qualifiers for the hash scans on ESVNB0 and ESVNE1.  For \"new-style-sql_without-condition\", we see a single scan qualifier on the first column:\r\n\r\n scan qualifiers:\r\n Column[0][0] Id: 0\r\n Operator: =\r\n Ordered nulls: false\r\n Unknown return value: false\r\n Negate comparison result: false\r\n\r\nThis corresponds to \"NU_BUY_CPY = 99\" (verified by tracing, where the qualifier value is '99'), which is always true for all rows of ESVNB0 and ESVNE1.  But for \"new-style-sql.txt\", we see *two* scan qualifiers:\r\n\r\n scan qualifiers:\r\n Column[0][0] Id: 0\r\n Operator: =\r\n Ordered nulls: false\r\n Unknown return value: false\r\n Negate comparison result: false\r\n\r\n Column[0][1] Id: 3\r\n Operator: =\r\n Ordered nulls: false\r\n Unknown return value: false\r\n Negate comparison result: false\r\n\r\nThe second qualifier is on the fourth column and has a value of '0', which appears to be coming from the \"NU_CPY_GRP = 0\" predicate.  That qualifier is eliminating all rows from the scans (for both ESVNB0 and ESVNE1), leading to zero results.\r\n\r\nGiven this potentially erroneus theory, it appears that somehow the qualifiers for the outer-most WHERE clause are being mapped incorrectly onto ESVNB0 and ESVNE1.  Maybe this is a transitive closure computation problem, maybe it's something else entirely.  At this point I don't know, I'm just dumping what I've seen thus far...\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2007-10-21T02:42:37.008+0000","updated":"2007-10-21T02:47:38.188+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12543327","id":"12543327","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"I did some further tracing/investigation of this issue and confirmed that search transitive closure is indeed adding incorrect predicates to the predicate list.  In the case of \"new-style-sql.txt\", we end up with four additional predicates:\r\n\r\n   ESVNB0.NU_BUY_CPY = 99\r\n   ESVNE1.NU_BUY_CPY = 99\r\n   ESVNB0.NU_MT1_CPY = 0\r\n   ESVNE1.NU_MT1_CPY = 0\r\n\r\nAll of these predicates are incorrectly inferred from two predicates in the outermost WHERE clause, namely \r\n\r\n  O4Work.ESVN01.NU_BUY_CPY = 99 AND O4Work.ESVNA0.NU_CPY_GRP = 0\r\n\r\nIt turns out that the introduction of these invalid predicates stems from a problem that is almost identical to the one described in DERBY-2526.  For details please see d2526_v1.html as attached to that issue, since pretty much everything in that document applies to this issue, as well.\r\n\r\nIn fact, the fix for that issue nearly solved this one, too.  More specifically, the fix for DERBY-2526 added the following lines to the remapColumnReferencesToExpressions() method of ColumnReference.java:\r\n\r\n    /* It's not enough to just set the table number.  Depending\r\n     * on the original query specified and on whether or not\r\n     * subquery flattening has occurred, it's possible that\r\n     * the expression to which we're remapping has a different\r\n     * result column list than the one to which we were mapped\r\n     * before we got here.  In that case we also need to update\r\n     * the columnNumber to point to the correct column in \"ft\".\r\n     * That's what the following line does. See DERBY-2526 for\r\n     * details.\r\n     */\r\n    ResultColumn ftRC =\r\n        ft.getResultColumns().getResultColumn(columnName);\r\n\r\n    columnNumber = ftRC.getColumnPosition();\r\n\r\nThat code depends on the \"getColumnPosition()\" method of ResultColumn, which looks as follows:\r\n\r\n    public int getColumnPosition()\r\n    {\r\n        if (columnDescriptor!=null)\r\n            return columnDescriptor.getPosition();\r\n        else\r\n            return virtualColumnId;\r\n    }\r\n\r\nThe document d2526_v1.html mentioned two things regarding this code:\r\n\r\n  1) if \"columnDescriptor\" is null, the method will return virtualColumnId;\r\n  2) columnDescriptor will *not* be null if the ResultColumn (ftRC in this case)\r\n     points directly to a base table.  In that case the method will return the\r\n     position as stored in the column descriptor.\r\n\r\nBoth of those statements are still true.  But there's another fact about this code that DERBY-2526 did not catch:\r\n\r\n  3) columnDescriptor may be NON-null *even if* ftRC points to a virtual\r\n     column.\r\n\r\nIn the case of \"new-style-sql\" we'll end up calling the above code for both sides of any join predicates that belong to JoinNodes which are flattened (again, see the document attached to DERBY-2526 for details).  In the case where one of the flattened JoinNode's children is a left outer join (i.e. HalfOuterJoinNode) ftRC points to the HalfOuterJoinNode. If that HalfOuterJoinNode then has base tables as its children, two things will be true: a) ftRC will point to a VIRTUAL column--namely, to one of the columns in HalfOuterJoinNode's result column, and b) ftRC will have a columnDescriptor that describes the column in the underlying base table to which ftRC ultimately points. So now we have a ResultColumn ftRC which has a non-null columnDescriptor AND which points to a virtual column.\r\n\r\nIn the above code, then, when we call:\r\n\r\n    columnNumber = ftRC.getColumnPosition();\r\n\r\nwe'll see that columnDescriptor is non-null and thus columnNumber will become the column position w.r.t. the *base* table.  But that's not quite correct: ftRC points to a virtual result column list (i.e. the RCL for HalfOuterJoinNode), so columnNumber has to reflect the correct position with respect to that virtual column list.  In other words, we need to retrieve the *virtualColumnId*, not the base column position.\r\n\r\nWhen we mis-assign the columnNumber for the join predicates, we end up confusing the transitive closure code, which leads to the eventual addition of incorrect predicates to the WHERE list, and therefore we end up with missing rows.\r\n\r\nI made a slight tweak to the code added by DERBY-2526 to make sure that columnNumber is always set to the virtualColumnId when the ResultColumn in question points to a virtual column:\r\n\r\n-    columnNumber = ftRC.getColumnPosition();\r\n+    /* Use the virtual column id if the ResultColumn's expression\r\n+     * is a virtual column (DERBY-3023).\r\n+     */\r\n+    columnNumber =\r\n+        (ftRC.getExpression() instanceof VirtualColumnNode)\r\n+            ? ftRC.getVirtualColumnId()\r\n+            : ftRC.getColumnPosition();\r\n\r\nWith this one-line change, \"new-style-sql\" returns the same results as \"new-style-sql_without-condition\".  So that seems like a step in the right direction for this issue.  Also with that change I ran the repro program, DerbySearchJoins.java, and all but two of the queries now return 924 rows--another good sign.\r\n\r\nThe two queries that still do not return 924 rows are:\r\n\r\n  old-style-sql.txt (returns 889 rows)\r\n  new-style-sql-only-inner.txt (returns 2 rows)\r\n\r\nIf it's true that those queries are supposed to return 924 rows, as well (Stefan, can you confirm that?  Is that what DB2 shows, as well?), then further investigation is still needed before this issue can be resolved.  But at least we're a step closer...\r\n\r\nI'm attaching a simplified repro for the problem that I just described, along with a patch that includes the one-line change and a corresponding test case for the nightlies.  This patch is NOT for commit, though, as I have not yet run derbyall.  I did run suites.All and saw 92 failures along with 24 errors, all of which were in upgrade tests.  When I re-ran the suite without my changes to ColumnReference the same tests failed, so I'm hoping it's just an environment issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2007-11-18T01:31:21.327+0000","updated":"2007-11-18T01:31:21.327+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12543655","id":"12543655","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"I ran derbyall on Red Hat Linux with ibm15 and there were no failures.\r\n\r\nI realized that the reason the UpgradeTests were failing over the weekend was that I was disconnected and didn't have old release jars on my machine.  When I re-ran suites.All (via \"ant junit-all\") today all tests passed.\r\n\r\nSo I'm re-attaching the changes as \"d3023_v2.patch\", which is identical to \"d3023_notTested_v1.patch\"--it just has a different name because the patch has now been tested.\r\n\r\nNote that committing the patch for this issue will lead to an ASSERTion failure in the repro query \"new-style-sql\" due to DERBY-3214.  That's not a regression, it's just a case where fixing one bug exposes another bug--and in this case, I think if one is running in insane mode DERBY-3214 will not actually reveal itself; the optimizer will just pick a potentially suboptimal query plan.\r\n\r\nI'm *not* checking the \"Patch Available\" flag as I will be heading of town this evening and will be unable to handle follow-up comments until I return.  But I thought I'd post the patch and the test results now in case someone else wants to drive this to commit in the interim.\r\n\r\nAlso note: still waiting to here back from Stefan on whether \"old-style-sql\" and \"new-style-sql_only-inner\" are supposed to return 924 rows, as well.  If so, then there's more work to be done here (d3023_v2.patch would be an incremental step in that case).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2007-11-19T19:49:17.766+0000","updated":"2007-11-19T19:49:17.766+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12543880","id":"12543880","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trippeltrappel","name":"trippeltrappel","emailAddress":"cordes at retail-sc dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stefan Cordes","active":true},"body":"No, old-style-sql and new-style-sql_only-inner are *not* expected to have 924 rows.\r\n\r\n(In the old-style-sql is a \"LEFT OUTER JOIN O4Work.ESVN07\" increases duplicate rows and NU_COT_TYP = 1 decreases them.\r\nAfter removing NU_COT_TYP = 1 and adding a distinct I get 924 rows for old-style-sql )\r\n(In the new-style-sql_only-inner  only inner joins forces the less rows).\r\n\r\nI adapted the program to give more hint about what expected:\r\n\r\nTest old-style-sql\r\nok: 924 rows\r\nTest old-style-sql-without-condition\r\nok: 924 rows\r\nTest new-style-sql\r\nERROR: Expected 924 rows but were 0 rows\r\nTest new-style-sql-only-inner\r\nok: 2 rows\r\nTest new-style-sql_first-inner-joins\r\nok: 924 rows\r\nTest new-style-sql_without-condition\r\nok: 924 rows\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trippeltrappel","name":"trippeltrappel","emailAddress":"cordes at retail-sc dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stefan Cordes","active":true},"created":"2007-11-20T12:35:12.215+0000","updated":"2007-11-20T12:35:12.215+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12547947","id":"12547947","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"> I adapted the program to give more hint about what expected:\r\n\r\nThanks Stefan.  Can you attach the revised program to this issue?  Just the \".java\" file should be good enough...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2007-12-03T19:12:58.058+0000","updated":"2007-12-03T19:12:58.058+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12550449","id":"12550449","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trippeltrappel","name":"trippeltrappel","emailAddress":"cordes at retail-sc dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stefan Cordes","active":true},"body":"Here it is: DerbySearchJoins.java","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trippeltrappel","name":"trippeltrappel","emailAddress":"cordes at retail-sc dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stefan Cordes","active":true},"created":"2007-12-11T14:02:27.460+0000","updated":"2007-12-11T14:02:27.460+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12552161","id":"12552161","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Marking \"Patch Available\" as I am now available to respond to review comments/suggestions on the description of the problem and/or on the suggested d3023_v2.patch.  From what I can tell, that patch resolves the issue and causes the various queries posted by Stefan to return the correct number of rows.  Stefan, please correct me if I'm wrong...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2007-12-16T03:26:29.224+0000","updated":"2007-12-16T03:26:29.224+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12558604","id":"12558604","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trippeltrappel","name":"trippeltrappel","emailAddress":"cordes at retail-sc dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stefan Cordes","active":true},"body":"I did not test the patch but if new-style-sql  returns 924 rows it's solved for me.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trippeltrappel","name":"trippeltrappel","emailAddress":"cordes at retail-sc dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stefan Cordes","active":true},"created":"2008-01-14T14:01:14.686+0000","updated":"2008-01-14T14:01:14.686+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12559578","id":"12559578","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Having heard no objections to the patch, and based on Stefan's feedback, I committed d3023_v2.patch with svn # 612504:\r\n\r\n  URL: http://svn.apache.org/viewvc?rev=612504&view=rev\r\n\r\nMarking the issue as resolved for 10.4.  If the tinderbox tests run cleanly over the next couple of days, I will look at porting this change back to 10.3.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2008-01-16T16:52:15.012+0000","updated":"2008-01-16T16:52:15.012+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12561166","id":"12561166","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Tinderbox runs on trunk ran for several days with no apparent fallout from the changes for this issue, so I ported back to 10.3 with a simple merge command:\r\n\r\n  svn merge -r 612503:612504 https://svn.apache.org/repos/asf/db/derby/code/trunk\r\n\r\nI ran derbyall and suites.All with ibm142 and there were no new failures.  So I committed with svn # 614046:\r\n\r\n  URL: http://svn.apache.org/viewvc?rev=614046&view=rev\r\n\r\nUpdating fix-in to reflect the fact that this is now in 10.3.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2008-01-21T23:23:28.448+0000","updated":"2008-01-21T23:23:28.448+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12580134","id":"12580134","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dyret","name":"dyret","emailAddress":"Dyre dot Tjeldvoll at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dyre Tjeldvoll","active":true},"body":"This issue has fix version 10.4 and is marked with either 'Release note needed' or 'Existing application impact', but does not have a releaseNote.html attached to it. Should it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dyret","name":"dyret","emailAddress":"Dyre dot Tjeldvoll at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dyre Tjeldvoll","active":true},"created":"2008-03-18T22:13:20.797+0000","updated":"2008-03-18T22:13:20.797+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12584390","id":"12584390","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Attaching a release note for this issue.  I had to use MS Word to create the file and as a result it doesn't pass the \"ReleaseNoteReader\" tool check--i.e. it's going to have to be \"scrubbed\" in order for the release note generator to work correctly.  I apologize in advance, but I'm hoping someone else can do the scrubbing as it was not as straightforward as I had hoped it would be, and I don't really have time to figure it all out...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2008-04-02T03:31:46.485+0000","updated":"2008-04-02T03:31:46.485+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12584563","id":"12584563","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks for the release note, Army. I have attached a scrubbed version which passes the checks performed by the ReleaseNoteReader.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2008-04-02T13:20:11.676+0000","updated":"2008-04-02T13:20:11.676+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376689/comment/12584663","id":"12584663","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"> I have attached a scrubbed version which passes the checks performed by the ReleaseNoteReader.\r\n\r\nThanks Rick!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2008-04-02T16:32:30.487+0000","updated":"2008-04-02T16:32:30.487+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3023/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06f4f:"}}
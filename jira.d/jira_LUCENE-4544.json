{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12614964","self":"https://issues.apache.org/jira/rest/api/latest/issue/12614964","key":"LUCENE-4544","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310110","id":"12310110","key":"LUCENE","name":"Lucene - Core","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310110&avatarId=10061","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310110&avatarId=10061","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310110&avatarId=10061","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310110&avatarId=10061"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321140","id":"12321140","description":"Major release after 4.0","name":"4.1","archived":false,"released":true,"releaseDate":"2013-01-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321663","id":"12321663","description":"Current trunk","name":"Trunk","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-11-06 20:08:54.953","customfield_12312323":null,"customfield_12310420":"255479","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_449899899_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-11-11T19:38:13.978+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-4544/watchers","watchCount":3,"isWatching":false},"created":"2012-11-06T14:39:54.099+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321663","id":"12321663","description":"Current trunk","name":"Trunk","archived":false,"released":false}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-03-22T16:18:09.398+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12310233","id":"12310233","name":"core/other","description":"issues related to any code under core. Usage of this document is discouraged. Please create (or ask for) a proper component."}],"timeoriginalestimate":null,"description":"from dev list:\r\n\r\nÂ¨i suspect that this code is broken. Lines 331 - 343 in org.apache.lucene.index.ConcurrentMergeScheduler.merge(IndexWriter)\r\n\r\nmergeThreadCount() are currently active merges, they can be at most maxThreadCount, maxMergeCount is number of queued merges defaulted with maxThreadCount+2 and it can never be lower then maxThreadCount, which means that condition in while can never become true.\r\n\r\n      synchronized(this) {\r\n        long startStallTime = 0;\r\n        while (mergeThreadCount() >= 1+maxMergeCount) {\r\n          startStallTime = System.currentTimeMillis();\r\n          if (verbose()) {\r\n            message(\"    too many merges; stalling...\");\r\n          }\r\n          try {\r\n            wait();\r\n          } catch (InterruptedException ie) {\r\n            throw new ThreadInterruptedException(ie);\r\n          }\r\n        } \r\n\r\nWhile confusing, I think the code is actually nearly correct... but I\r\nwould love to find some simplifications of CMS's logic (it's really\r\nhairy).\r\n\r\nIt turns out mergeThreadCount() is allowed to go higher than\r\nmaxThreadCount; when this happens, Lucene pauses\r\nmergeThreadCount()-maxThreadCount of those merge threads, and resumes\r\nthem once threads finish (see updateMergeThreads).  Ie, CMS will\r\naccept up to maxMergeCount merges (and launch threads for them), but\r\nwill only allow maxThreadCount of those threads to be running at once.\r\n\r\nSo what that while loop is doing is preventing more than\r\nmaxMergeCount+1 threads from starting, and then pausing the incoming\r\nthread to slow down the rate of segment creation (since merging cannot\r\nkeep up).\r\n\r\nBut ... I think the 1+ is wrong ... it seems like it should just be\r\nmergeThreadCount() >= maxMergeCount().","customfield_10010":null,"timetracking":{},"customfield_12310120":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10121","value":"New","id":"10121"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"84335","summary":"possible bug in ConcurrentMergeScheduler.merge(IndexWriter) ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hsn","name":"hsn","emailAddress":"hsn at sendmail dot cz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hsn&avatarId=11931","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hsn&avatarId=11931","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hsn&avatarId=11931","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hsn&avatarId=11931"},"displayName":"Radim Kolar","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hsn","name":"hsn","emailAddress":"hsn at sendmail dot cz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hsn&avatarId=11931","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hsn&avatarId=11931","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hsn&avatarId=11931","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hsn&avatarId=11931"},"displayName":"Radim Kolar","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":5,"total":5,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12614964/comment/13491777","id":"13491777","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Patch.\r\n\r\nIt was somewhat tricky to fix the off-by-one, because we only want to stall the thread(s) producing segments if the number of running merges is >= maxMergeCount AND another merge wants to kick off ... I made CMS.merged sync'd, and removed the synchronous IW.mergeInit (I think deterministic segment name assignment isn't important).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2012-11-06T20:08:54.953+0000","updated":"2012-11-06T20:08:54.953+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12614964/comment/13491800","id":"13491800","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hsn","name":"hsn","emailAddress":"hsn at sendmail dot cz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hsn&avatarId=11931","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hsn&avatarId=11931","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hsn&avatarId=11931","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hsn&avatarId=11931"},"displayName":"Radim Kolar","active":true},"body":"it can not be made simple by not creating thread for every new segment merge but to use standard threadpool + queue scheme? Lot of libraries can do it easily.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hsn","name":"hsn","emailAddress":"hsn at sendmail dot cz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hsn&avatarId=11931","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hsn&avatarId=11931","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hsn&avatarId=11931","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hsn&avatarId=11931"},"displayName":"Radim Kolar","active":true},"created":"2012-11-06T20:46:14.145+0000","updated":"2012-11-06T20:46:14.145+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12614964/comment/13492446","id":"13492446","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"I think it needs more than cutting over to thread pool to clean it up :)\r\n\r\nWe've actually looked at using a thread pool (see LUCENE-2063) but it apparently wasn't straightforward ... if you can see a way that'd be nice :)\r\n\r\nBut I think we should do that under a separate issue ... leave this one focused on the off-by-one on maxMergeCount.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2012-11-07T16:00:09.450+0000","updated":"2012-11-07T16:00:09.450+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12614964/comment/13492565","id":"13492565","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Added test case ... I think it's ready.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2012-11-07T18:14:20.692+0000","updated":"2012-11-07T18:14:20.692+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12614964/comment/13610570","id":"13610570","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=commit-tag-bot","name":"commit-tag-bot","emailAddress":"root-jira-commit_tag_bot at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=commit-tag-bot&avatarId=16176","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=commit-tag-bot&avatarId=16176","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=commit-tag-bot&avatarId=16176","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=commit-tag-bot&avatarId=16176"},"displayName":"Commit Tag Bot","active":true},"body":"[branch_4x commit] Michael McCandless\r\nhttp://svn.apache.org/viewvc?view=revision&revision=1408092\r\n\r\nLUCENE-4544: fix off-by-one in max number of CMS merge threads\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=commit-tag-bot","name":"commit-tag-bot","emailAddress":"root-jira-commit_tag_bot at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=commit-tag-bot&avatarId=16176","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=commit-tag-bot&avatarId=16176","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=commit-tag-bot&avatarId=16176","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=commit-tag-bot&avatarId=16176"},"displayName":"Commit Tag Bot","active":true},"created":"2013-03-22T16:18:09.398+0000","updated":"2013-03-22T16:18:09.398+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-4544/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0es7r:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12636772","self":"https://issues.apache.org/jira/rest/api/latest/issue/12636772","key":"DERBY-6107","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324243","id":"12324243","description":"First release on the 10.11 branch","name":"10.11.1.1","archived":false,"released":true,"releaseDate":"2014-08-26"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2014-03-07 00:34:50.415","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"317264","customfield_12310222":"3_*:*_1_*:*_607235540_*|*_1_*:*_1_*:*_31371700653_*|*_5_*:*_2_*:*_492834673_*|*_4_*:*_1_*:*_613839592","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2014-03-31T11:43:08.791+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-6107/watchers","watchCount":4,"isWatching":false},"created":"2013-03-13T13:16:18.363+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321550","id":"12321550","description":"First release on the 10.10 branch","name":"10.10.1.1","archived":false,"released":true,"releaseDate":"2013-04-15"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12365609","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12365609","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12634415","key":"DERBY-6094","self":"https://issues.apache.org/jira/rest/api/2/issue/12634415","fields":{"summary":"Derby ignores DriverManager.setLoginTimeout()","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12390055","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12390055","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12721691","key":"DERBY-6619","self":"https://issues.apache.org/jira/rest/api/2/issue/12721691","fields":{"summary":"After silently swallowing SecurityExceptions, Derby can leak class loaders","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-06-19T11:22:14.199+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11413","id":"11413","name":"Test"}],"timeoriginalestimate":null,"description":"See DERBY-6094 for the details of this problem.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"317605","summary":"Investigate why setting a login timeout causes NativeAuthenticationServiceTest to fail when run in a suite","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":18,"total":18,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13923319","id":"13923319","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"I modified the lang._Suite from trunk (10.11 alpha updated to svn 1574634) to have just these 3 tests:\r\n        suite.addTest(HalfCreatedDatabaseTest.suite());\r\n        suite.addTest(NativeAuthenticationServiceTest.suite());\r\n        suite.addTest(Derby5652.suite());\r\nThen I ran (with sane classes):\r\n$ java -Dderby.tests.trace=true -Dderby.tests.login.timeout=10 junit.textui.TestRunner org.apache.derbyTesting.functionTests.tests.lang._Suite > runsmlste.out 2>&1\r\n\r\nAll passed.\r\nI will try it with the full suite (i.e. no modifications).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2014-03-07T00:34:50.415+0000","updated":"2014-03-07T00:34:50.415+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13923461","id":"13923461","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"I ran the full lang._Suite unchanged, with sane classes, and -Dderby.tests.login.timeout=10, but NativeAuthenticationServiceTest did not fail.\r\n\r\nI did see the following 2 failures:\r\n1) test_02_simpleSelects(org.apache.derbyTesting.functionTests.tests.lang.NewOptimizerOverridesTest)java.security.AccessControlException: Access denied (java.lang.RuntimePermission accessDeclaredMembers)\r\n....\r\n 2) test_03_offsetFetch(org.apache.derbyTesting.functionTests.tests.lang.NewOptimizerOverridesTest)java.security.AccessControlException: Access denied (java.lang.RuntimePermission accessDeclaredMembers)\r\n...\r\nWhich maybe means we should do something about adding this permission in the lang/resultSetReader.policy for running with classes, but seems unrelated to this issue.\r\n\r\nRick, shall I resolve this as Cannot Reproduce, or shall we leave it open until you have nothing else to do?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2014-03-07T02:49:28.853+0000","updated":"2014-03-07T02:49:28.853+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13930468","id":"13930468","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"Going ahead and marking this as cannot reproduce.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2014-03-11T15:37:59.009+0000","updated":"2014-03-11T15:37:59.009+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13937545","id":"13937545","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"This issue still reproduces in my environment. Note that some of the test cases in NativeAuthenticationServiceTest are disabled on Windows. With JDK 7u51 on Linux, I see this failure when I run lang._Suite with derby.tests.login.timeout=10:\r\n\r\n{noformat}\r\njava.sql.SQLSyntaxErrorException: Authentication cannot be performed because the credentials database 'classpath:nast' does not exist.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:95)\r\n        at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Util.java:233)\r\n        at org.apache.derby.impl.jdbc.authentication.NativeAuthenticationServiceImpl.authenticateUser(NativeAuthenticationServiceImpl.java:330)\r\n        at org.apache.derby.impl.jdbc.authentication.AuthenticationServiceBase.authenticate(AuthenticationServiceBase.java:252)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.checkUserCredentials(EmbedConnection.java:1302)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.<init>(EmbedConnection.java:426)\r\n        at org.apache.derby.jdbc.InternalDriver.getNewEmbedConnection(InternalDriver.java:628)\r\n        at org.apache.derby.jdbc.InternalDriver$LoginCallable.call(InternalDriver.java:387)\r\n        at org.apache.derby.jdbc.InternalDriver$LoginCallable.call(InternalDriver.java:363)\r\n        at java.util.concurrent.FutureTask.run(FutureTask.java:262)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\r\n        at java.lang.Thread.run(Thread.java:744)\r\nCaused by: ERROR 4251I: Authentication cannot be performed because the credentials database 'classpath:nast' does not exist.\r\n        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:290)\r\n        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:285)\r\n        at org.apache.derby.impl.jdbc.authentication.NativeAuthenticationServiceImpl.authenticateRemotely(NativeAuthenticationServiceImpl.java:438)\r\n        at org.apache.derby.impl.jdbc.authentication.NativeAuthenticationServiceImpl.authenticateUser(NativeAuthenticationServiceImpl.java:321)\r\n        ... 10 more\r\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-03-17T08:31:53.683+0000","updated":"2014-03-17T08:31:53.683+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13937980","id":"13937980","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"Thanks for that experiment, I'll take another look...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2014-03-17T16:19:15.874+0000","updated":"2014-03-17T16:19:15.874+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13940047","id":"13940047","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"On Linux, even with a jvm < 7u51, (ibm 1.7 sr6) I also got failures in NativeAuthenticationTest when run with -Dderby.tests.login.timeout=10. \r\nIf that test is the only one in the _Suite, there is no such failure.\r\nI blundered about going with the idea that there was one previous test that would mess this up, but it seems more tricky than that. Here's what I found so far:\r\n\r\n- There are no failures if the suite consists of:\r\n        suite.addTest(OrderByAndOffsetFetchInSubqueries.suite());\r\n        suite.addTest(Derby5005Test.suite());\r\n        suite.addTest(OLAPTest.suite());\r\n        suite.addTest(NativeAuthenticationServiceTest.suite());\r\n- But there are 2 failures if any of the following tests are run first:\r\n        suite.addTest(DBOAccessTest.suite());\r\n        suite.addTest(HalfCreatedDatabaseTest.suite());\r\n- And there are 4 failures if the following test is run first:\r\n        suite.addTest(AutoIncrementTest.suite());\r\n        suite.addTest(SequenceGeneratorTest.suite());\r\n\r\nNot sure if this information tells us anything useful.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2014-03-19T01:18:52.148+0000","updated":"2014-03-19T01:18:52.148+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13940428","id":"13940428","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks for running those experiments, Myrna. The tests which don't interfere with NativeAuthenticationServiceTest all have very simple decoration: just a CleanDatabaseTestSetup as the outermost decorator. But that is also true for one of the tests which does interfere (AutoIncrementTest). Of the interfering tests, AutoIncrementTest has the simplest decoration. Studying its interference with NativeAuthenticationServiceTest may be easiest. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2014-03-19T12:22:35.907+0000","updated":"2014-03-19T12:22:35.907+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13940456","id":"13940456","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Here's one theory: The credentials database seems to be made available in the context class loader of the test thread and is accessed using the classpath subsubprotocol. When login timeout is enabled, getConnection() will delegate the work to a thread from a pool. If the test runs separately, the thread pool is probably empty, and a new thread is created in order to process the getConnection() call. Presumably, this thread inherits the context class loader of the current thread, and it therefore is able to access the credentials database. However, if the thread pool is not empty when the test runs, the getConnection() call is processed in a thread created by an earlier test, which probably doesn't have the context class loader set up to access the credentials database.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-03-19T13:23:24.223+0000","updated":"2014-03-19T13:23:24.223+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13940504","id":"13940504","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"Knut, how would the login timeout affect that scenario?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2014-03-19T14:30:32.652+0000","updated":"2014-03-19T14:30:32.652+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13940550","id":"13940550","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The thread pool is only used if the login timeout is enabled. So without the login timeout, the credentials database will always be accessed in the main junit thread.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-03-19T15:05:38.501+0000","updated":"2014-03-19T15:05:38.501+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13943064","id":"13943064","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The java.util.concurrent.Executors class has a method called privilegedCallableUsingCurrentClassLoader() that might help in this case. If we wrap the task using that method before we give it to the thread pool, it will set the current class loader of the cached thread before executing the task (and reset it when the task is done). I'll give that a try.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-03-21T13:58:18.989+0000","updated":"2014-03-21T13:58:18.989+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13944923","id":"13944923","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I tried wrapping the callable in InternalDriver.timeLogin() using said helper method in Executors, like this:\r\n\r\n{code}\r\nfinal LoginCallable callable = new LoginCallable(this, url, info);\r\n\r\nFuture<EmbedConnection> task = _executorPool.submit(\r\n    AccessController.doPrivileged(new PrivilegedAction<Callable<EmbedConnection>>() {\r\n        public Callable<EmbedConnection> run() {\r\n            return Executors.privilegedCallableUsingCurrentClassLoader(callable);\r\n        }\r\n    }));\r\n{code}\r\n\r\nThat made the test pass in my environment.\r\n\r\nThis only works if derby.jar has been granted the runtime permissions getClassLoader and setContextClassLoader. Those permissions are currently listed as optional permissions. If we go for this approach, we'd either need to make them required permissions (at least required when using login timeout), or have a reasonable fallback strategy if the permissions have not been granted.\r\n\r\nOne possible fallback strategy might be to set the keep alive time for InternalDriver's thread pool to 0. That would cause every submitted task to spawn a new thread, so they would never end up executing in a thread whose context class loader was inherited from a thread that submitted an earlier task. That means you won't get the benefit of reusing threads from the thread pool if you don't have those permissions, but at least it will behave correctly.\r\n\r\nOr maybe, for simplicity, we should just set the keep alive time to 0 unconditionally, and skip the use of Executors.privilegedCallableUsingCurrentClassLoader(), so that we wouldn't have two different code paths depending on whether or not the permissions have been granted. In most cases I would suppose the getConnection() call isn't very performance critical, so it might not be worth the extra complexity to optimize it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-03-24T11:02:24.491+0000","updated":"2014-03-24T11:02:24.491+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13944982","id":"13944982","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Hi Knut,\r\n\r\nThanks for thinking so deeply about this issue and for running those experiments. I don't think I understand the problem well enough to give any advice yet. I have a couple questions:\r\n\r\n1) How would this problem occur in production? Would it only surface if you are accessing a database in a jar file on the classpath and you have enabled login timeouts and then later on you switch to using NATIVE authentication after having run without it for a while?\r\n\r\n2) I don't understand the implications of granting getClassLoader and setContextClassLoader permissions, but my sense is that those are very serious permissions. Note that Derby calls getClassLoader() in several places but, so far, the context has been sufficient to not trip a security exception.\r\n\r\n3) Also, I can't find where we list those permissons as optional permissions. Can you point me at that advice?\r\n\r\n4) I think that threads are fairly lightweight. But memory could be exhausted by a sufficiently large number of even very lightweight objects. Setting the keep alive timeout to 0 may create a new opportunity for a DDoS attack. But maybe that's red herring because the same attack might exhaust some other resource even if the keep alive timeout weren't set to 0.\r\n\r\nThanks,\r\n-Rick","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2014-03-24T12:58:28.857+0000","updated":"2014-03-24T12:58:28.857+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13945134","id":"13945134","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Hi Rick. Thanks for your comments. Here are my responses:\r\n\r\n1) One does not have to use NATIVE authentication. It is enough to access a database on the classpath with login timeouts enabled. This could result in threads not finding databases that are in their context class loader, or threads being able to access databases that are private to other threads. There could be other scenarios as well, but I'm not aware of any other functionality that depends on the context class loader of the thread that calls getConnection().\r\n\r\n2) Derby's current calls to getContextClassLoader() and setContextClassLoader() are wrapped in try/catch blocks, and SecurityExceptions are silently ignored, so one wouldn't notice if they failed. Those calls were added to fix DERBY-3745, which could cause class loader leaks because Derby's daemon threads would hold on to the context class loader of the application thread that happened to boot the engine. The SecurityExceptions are ignored for backwards compatibility so that existing applications that don't suffer from the class loader leak aren't affected.\r\n\r\n3) They are mentioned in the Developer's Guide, Running Derby under a security manager, Granting permissions to Derby, in the optional section: http://db.apache.org/derby/docs/10.10/devguide/cdevbabejgjd.html\r\n\r\n4) The total number of threads at any given time will not be greater if the keep alive timeout is set to 0. On the contrary, since idle threads are not kept around for a while in the pool, the memory footprint will typically be smaller if the keep alive timeout is 0. With timeout 0, the number of threads in the pool will be equal to the number of callers currently waiting for getConnection() to return. With the default, non-zero timeout, the number of threads in the pool will be equal to the number of callers currently waiting for getConnection() to return *plus* the number of idle threads that haven't yet timed out.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-03-24T14:09:30.788+0000","updated":"2014-03-24T14:09:30.788+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13945177","id":"13945177","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks for that extra explanation, Knut. So it sounds as though setting the keepAlive time to 0 will just cause DriverManager.getConnection() to incur the cost of starting a Thread when login timeouts are enabled. That doesn't sound like an intolerable expense for implementing login timeouts. I prefer that expense to granting the extra permissions. And I vote for less complexity: always set the keepAlive time to 0. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2014-03-24T14:47:32.229+0000","updated":"2014-03-24T14:47:32.229+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13945647","id":"13945647","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks, Rick. That's the approach I'm leaning towards too. We can always optimize later if necessary.\r\n\r\nI suspect a regression test case for this issue is likely to hit DERBY-2162/DERBY-5618, so I'll see if I can find a solution for them first.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-03-24T20:26:42.752+0000","updated":"2014-03-24T20:26:42.752+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13950752","id":"13950752","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attaching d6107-1a.diff which fixes the bug by disabling caching of threads used for timed logins. It also adds a test to DatabaseClassLoadingTest to verify the fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-03-28T14:11:30.397+0000","updated":"2014-03-28T14:11:30.397+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12636772/comment/13955113","id":"13955113","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1583304 from [~knutanders] in branch 'code/trunk'\r\n[ https://svn.apache.org/r1583304 ]\r\n\r\nDERBY-6107: Connection to classpath database fails when login timeout is set\r\n\r\nDon't cache threads used for connecting to the database when a login\r\ntimeout is set, to prevent that the connection attempt uses the wrong\r\ncontext class loader.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-03-31T11:42:32.166+0000","updated":"2014-03-31T11:42:32.166+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-6107/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1iqtb:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12327431","self":"https://issues.apache.org/jira/rest/api/latest/issue/12327431","key":"DERBY-802","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-06-23 21:50:50.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22156","customfield_12310222":"1_*:*_1_*:*_16356448000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_44319801169","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-07-18T10:01:25.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-802/watchers","watchCount":1,"isWatching":false},"created":"2006-01-10T02:33:57.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10920","id":"10920","description":"initial source drop","name":"10.0.2.0","archived":false,"released":true,"releaseDate":"2004-08-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/10991","id":"10991","description":"snapshot","name":"10.0.2.1","archived":false,"released":true,"releaseDate":"2004-12-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/10992","id":"10992","name":"10.0.2.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12310615","id":"12310615","description":"","name":"10.1.2.1","archived":false,"released":true,"releaseDate":"2005-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-12-13T09:04:46.167+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11407","id":"11407","name":"JDBC"}],"timeoriginalestimate":null,"description":"Gr√©goire Dubois on the list reported this problem.  From his mail: the reproduction is attached below. \nWhen statement type is set to ResultSet.TYPE_SCROLL_INSENSITIVE, outofmemory exception is thrown when reading large blobs. \n\nimport java.sql.*;\nimport java.io.*;\n\n/**\n*\n* @author greg\n*/\npublic class derby_filewrite_fileread {\n   \n    private static File file = new File(\"/mnt/BigDisk/Clips/BabyMamaDrama-JShin.wmv\");\n    private static File destinationFile = new File(\"/home/greg/DerbyDatabase/\"+file.getName());\n   \n    /** Creates a new instance of derby_filewrite_fileread */\n    public derby_filewrite_fileread() {       \n       \n    }\n   \n    public static void main(String args[]) {\n        try {\n            Class.forName(\"org.apache.derby.jdbc.EmbeddedDriver\").newInstance();\n            Connection connection = DriverManager.getConnection (\"jdbc:derby:/home/greg/DerbyDatabase/BigFileTestDB;create=true\", \"APP\", \"\");\n            connection.setAutoCommit(false);\n           \n            Statement statement = connection.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE, ResultSet.CONCUR_READ_ONLY);\n            ResultSet result = statement.executeQuery(\"SELECT TABLENAME FROM SYS.SYSTABLES\");\n           \n            // Create table if it doesn't already exists.\n            boolean exist=false;\n            while ( result.next() ) {\n                if (\"db_file\".equalsIgnoreCase(result.getString(1)))\n                    exist=true;\n            }\n            if ( !exist ) {\n                System.out.println(\"Create table db_file.\");\n                statement.execute(\"CREATE TABLE db_file (\"+\n                                           \"     name          VARCHAR(40),\"+\n                                           \"     file          BLOB(2G) NOT NULL)\");\n                connection.commit();\n            }\n           \n            // Read file from disk, write on DB.\n            System.out.println(\"1 - Read file from disk, write on DB.\");\n            PreparedStatement preparedStatement=connection.prepareStatement(\"INSERT INTO db_file(name,file) VALUES (?,?)\");\n            FileInputStream fileInputStream = new FileInputStream(file);\n            preparedStatement.setString(1, file.getName());\n            preparedStatement.setBinaryStream(2, fileInputStream, (int)file.length());           \n            preparedStatement.execute();\n            connection.commit();\n            System.out.println(\"2 - END OF Read file from disk, write on DB.\");\n           \n           \n            // Read file from DB, and write on disk.\n            System.out.println(\"3 - Read file from DB, and write on disk.\");\n            result = statement.executeQuery(\"SELECT file FROM db_file WHERE name='\"+file.getName()+\"'\");\n            byte[] buffer = new byte [1024];\n            result.next();\n            BufferedInputStream     inputStream=new BufferedInputStream(result.getBinaryStream(1),1024);\n            FileOutputStream outputStream = new FileOutputStream(destinationFile);\n            int readBytes = 0;\n            while (readBytes!=-1) {\n                readBytes=inputStream.read(buffer,0,buffer.length);\n                if ( readBytes != -1 )\n                    outputStream.write(buffer, 0, readBytes);\n            }     \n            inputStream.close();\n            outputStream.close();\n            System.out.println(\"4 - END OF Read file from DB, and write on disk.\");\n        }\n        catch (Exception e) {\n            e.printStackTrace(System.err);\n        }\n    }\n}\n\n\nIt returns\n1 - Read file from disk, write on DB.\n2 - END OF Read file from disk, write on DB.\n3 - Read file from DB, and write on disk.\njava.lang.OutOfMemoryError\nif the file is ~10MB or more","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39721","summary":"OutofMemory Error when reading large blob when statement type is ResultSet.TYPE_SCROLL_INSENSITIVE","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"subtasks":[{"id":"12345408","key":"DERBY-1477","self":"https://issues.apache.org/jira/rest/api/2/issue/12345408","fields":{"summary":"create JUnit tests for testing BLOB OutOfMemory problems","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png","name":"Sub-task","subtask":true}}}],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"all","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":13,"total":13,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327431/comment/12362225","id":"12362225","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"From list, Dan suggested the following workaround  Change statement type to default ResultSet.TYPE_FORWARD_ONLY  and this works ok. \r\n\r\n===================\r\n\r\nI modified the repro and tried to do a read of a 100mb blob,  did  a heap profiler run and found the following trace. \r\n         percent         live       alloc'ed  stack class\r\n rank   self  accum    bytes objs   bytes objs trace name\r\n    1 59.59% 59.59% 30653040  935 31682912 1046  2050 [B\r\n    2 32.61% 92.20% 16777232    1 33489040    9  7268 [B\r\n    3  3.12% 95.33%  1606416   49 1737552   53  6935 [B\r\n    4  0.35% 95.68%   181632  946  194688 1014  2014 org.apache.derby.impl.store.raw.data.StoredPage\r\n......\r\n I havent looked very closely here but it seems to me that some materialization is happening by looking at this trace and code.  )\r\n\r\nTRACE 7268:\r\n\torg.apache.derby.iapi.types.SQLBinary.readFromStream(SQLBinary.java:384)\r\n\torg.apache.derby.iapi.types.SQLBinary.readExternal(SQLBinary.java:301)\r\n\torg.apache.derby.iapi.types.SQLBinary.getValue(SQLBinary.java:194)\r\n\torg.apache.derby.iapi.types.SQLBinary.getClone(SQLBinary.java:498)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2006-01-10T02:40:19.000+0000","updated":"2006-01-10T02:40:19.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327431/comment/12362232","id":"12362232","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"changing priority to minor as workaround exists. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2006-01-10T03:34:20.000+0000","updated":"2006-01-10T03:34:20.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327431/comment/12417500","id":"12417500","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"body":"The problem here is caused by ScrollInsensitiveResultSet doing a clone of the rows before inserting the into the BackingStoreHashtable.  The cloning of a blob, will cause a new column to be created, which reads all the data of the blob into a byte-array in memory. So if there is a 1GB blob, all the data will be read into memory.\r\n\r\nTo fix, I intent to avoid the cloning in ScrollInsensitiveResultSet. If the row, based on estimated memory usage, can go into memory, it should be cloned in BackingStoreHashTable. If it cannot go into memory, it should be spilt to disk (in which case you do not need a clone.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"created":"2006-06-23T21:50:50.000+0000","updated":"2006-06-23T21:50:50.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327431/comment/12419535","id":"12419535","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"body":"Attached is a patch which should fix the OutOfMemory problem.\r\n\r\nIn ScrollInsensitiveResultSet.java and ProjectRestrictResultSet, the cloning has been removed.\r\nWhen the ScrollInsensitiveResultSet inserts rows to the BackingStoreHashTable, it leaves it up to the BackingStoreHashTable to do cloning. If the row is too big to go into memory, BackingStoreHashTable will put it on disk.\r\n\r\nBackingStoreHashTable had to be fixed to avoid unneccassry inmemory cloning there as well.\r\n\r\nThe changes in SQLBinary and its subclasses is to make the method estimateMemoryUsage() return a number which is at least as big as the memory the column actually will use in memory. Before this fix, the estimated memory usage for a 64MB blob was on a few bytes ~ 50 bytes.  \r\n\r\nFinally, I found that when storing a SQLBinary (SQLBlob) to a conglomerate, the ExecRow which the column is within cannot be used again when backing the row to another conglomerate (if the row goes over multiple pages, I think). This is exactly what happens in ScrollInsensitiveResultset.updateRow(..). To get around this problem, I had do reassign some of the values in the updateRow(..) method to refer to the data backed to the BackingStoreHashTable.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"created":"2006-07-06T21:44:14.000+0000","updated":"2006-07-06T21:44:14.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327431/comment/12420624","id":"12420624","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"body":"The attached diff (derby-802v2.diff) has one change compared to the first diff:\r\n* The logic for undoing the projection is moved to ProjectRestricResultSet and takes advantage of the projectMappings array already built there.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"created":"2006-07-12T21:21:38.000+0000","updated":"2006-07-12T21:21:38.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327431/comment/12420819","id":"12420819","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"body":"Withdrawing derby-802v2.diff, since it makes SURQueryMixTest.junit fail.\r\nThe first patch has been run with no failures in derbyall.\r\nI will commit tomorrow, unless I receive any review comments.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"created":"2006-07-13T15:45:51.000+0000","updated":"2006-07-13T15:45:51.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327431/comment/12420883","id":"12420883","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fernanda","name":"fernanda","emailAddress":"fernanda dot pizzorno dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fernanda Pizzorno","active":true},"body":"I am reviewing your patch (derby-802.diff), but I won't have time to finish today. Can you wait a bit longer before you commit?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fernanda","name":"fernanda","emailAddress":"fernanda dot pizzorno dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fernanda Pizzorno","active":true},"created":"2006-07-13T22:22:51.000+0000","updated":"2006-07-13T22:22:51.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327431/comment/12421121","id":"12421121","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fernanda","name":"fernanda","emailAddress":"fernanda dot pizzorno dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fernanda Pizzorno","active":true},"body":"I have looked at the patch (derby-802.diff), and I have a few comments/questions.\r\n\r\nIn ScrollInsensitiveResultSet you are building an array for mapping the positions in the original row to the positions on the projected row (origPos).\r\n\r\n+\t\t\t// Array of original position in row\r\n+\t\t\tfinal int[] origPos = new int[newRowData.length];\r\n+\t\t\t\r\n+\t\t\tfor (int i=0; i<origPos.length; i++) {\r\n+\t\t\t\torigPos[i] = -1 ; \r\n+\t\t\t}\r\n+\r\n+\t\t\t// Make the origPos, by brute-force comparison of identity:\r\n+\t\t\tfor (int i=0; i<newRowData.length; i++) {\r\n+\t\t\t\tfor (int j=0; j<rowData.length; j++) {\r\n+\t\t\t\t\tif (rowData[j]==newRowData[i]) {\r\n+\t\t\t\t\t\torigPos[i] = j;\r\n+\t\t\t\t\t\tbreak;\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n\r\n[...]\r\n\r\n+\t\t\tfor (int i=0; i<origPos.length; i++) {\r\n+\t\t\t\tif (origPos[i]>=0) {\r\n+\t\t\t\t\trowData[origPos[i]] = backedData[i];\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n\r\nProjectRestrictResultSet already contains (projectMapping) a similar array to the one you are building here (origPos), wouldn't it be better to build this array in ProjectRestrictRestultSet using \"projectMapping\" instead of using brute-force comparison of identity?\r\n\r\nSuggestion:\r\n\r\nScrollInsensitiveResultSet:\r\n+\t\t\t// Array of original position in row\r\n+\t\t\tint[] origPos = ((ProjectRestrictResultSet)source).getBaseProjectMapping();\r\n\r\n[...]\r\n\r\n+\t\t\tfor (int i=0; i<origPos.length; i++) {\r\n+\t\t\t\tif (origPos[i]>=0) {\r\n+\t\t\t\t\trowData[origPos[i] - 1] = backedData[i];\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n\r\nProjectRestrictResultSet:\r\n+    public int[] getBaseProjectMapping() {\r\n+        int[] result;\r\n+        if (source instanceof ProjectRestrictResultSet) {\r\n+            result = new int[projectMapping.length];\r\n+            ProjectRestrictResultSet prs = (ProjectRestrictResultSet) source;\r\n+            int[] sourceMap = prs.getBaseProjectMapping();\r\n+            for (int i=0; i<projectMapping.length; i++) {\r\n+                if (projectMapping[i] > 0) {\r\n+                    result[i] = sourceMap[projectMapping[i] - 1];\r\n+                }\r\n+            }            \r\n+        } else {\r\n+            result = projectMapping;\r\n+        }\r\n+        return result;\r\n+    }\r\n\r\nI have also looked into the tests added in DERBY-1477 and I found out that neither of them use projection. Since part of the changes made in DERBY-802 are for cases where you have a projection, it would be nice if you could add some tests where projections where being used.\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fernanda","name":"fernanda","emailAddress":"fernanda dot pizzorno dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fernanda Pizzorno","active":true},"created":"2006-07-14T14:22:52.000+0000","updated":"2006-07-14T14:22:52.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327431/comment/12421136","id":"12421136","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"body":"Thank you very much for the review comments. I agree that the undo-projection code can be improved, (something I tried to do in the v2 diff). Your suggested approach sounds promising, I will try it out, and add more tests to BLOBTest.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"created":"2006-07-14T15:39:26.000+0000","updated":"2006-07-14T15:39:26.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327431/comment/12421620","id":"12421620","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"body":"Attached is a patch (derby-802v3.diff and derby-802v3.stat) which uses projectmappings calculated from ProjectRestrictResultSet, and 4 new testcases with projections has been added to BLOBTest.junit","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"created":"2006-07-17T13:46:58.000+0000","updated":"2006-07-17T13:46:58.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327431/comment/12421829","id":"12421829","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fernanda","name":"fernanda","emailAddress":"fernanda dot pizzorno dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fernanda Pizzorno","active":true},"body":"All my comments have been addressed in patch (derby-802v3.diff).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fernanda","name":"fernanda","emailAddress":"fernanda dot pizzorno dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fernanda Pizzorno","active":true},"created":"2006-07-18T09:51:35.000+0000","updated":"2006-07-18T09:51:35.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327431/comment/12421830","id":"12421830","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"body":"Thanks for reviewing.\r\n\r\nCommitted revision 423034.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"created":"2006-07-18T10:01:25.000+0000","updated":"2006-07-18T10:01:25.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327431/comment/12551301","id":"12551301","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"body":"This issue has been resolved for over a year with no further movement. Closing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"created":"2007-12-13T09:04:46.163+0000","updated":"2007-12-13T09:04:46.163+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-802/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i075w7:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12609151","self":"https://issues.apache.org/jira/rest/api/latest/issue/12609151","key":"ARIES-927","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310981","id":"12310981","key":"ARIES","name":"Aries","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310981&avatarId=10065","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310981&avatarId=10065","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310981&avatarId=10065","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310981&avatarId=10065"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10520","id":"10520","description":"Apache Aries","name":"Aries"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323756","id":"12323756","name":"util-1.1.0","archived":false,"released":true,"releaseDate":"2013-01-23"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-09-26 06:23:38.071","customfield_12312323":null,"customfield_12310420":"293511","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_162117862_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-09-27T20:53:40.871+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ARIES-927/watchers","watchCount":2,"isWatching":false},"created":"2012-09-25T23:51:43.026+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-05-05T11:55:35.519+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313851","id":"12313851","name":"Util"}],"timeoriginalestimate":null,"description":"Util imports the org.osgi.service.framework package as optional. However, the InternalRecursiveBundleTracker invokes \"x instanceof CompositeBundle\" in the addingBundle() method without protection. This results in a NoClassDefFoundError, like the one below, in environments where the package is not available. One such environment is the OSGi CT, where \"private\" package imports, such as the x-internal org.osgi.service.framework package provided by Equinox, are forbidden.\r\n\r\n! Failed to start bundle org.apache.aries.blueprint-1.0.0, exception activator error org/osgi/service/framework/CompositeBundle from: org.apache.aries.util.tracker.InternalRecursiveBundleTracker:addingBundle#67\r\norg.osgi.framework.BundleException: Exception in org.apache.aries.blueprint.container.BlueprintExtender.start() of bundle org.apache.aries.blueprint.\r\n\tat org.eclipse.osgi.framework.internal.core.BundleContextImpl.startActivator(BundleContextImpl.java:734)\r\n\tat org.eclipse.osgi.framework.internal.core.BundleContextImpl.start(BundleContextImpl.java:683)\r\n\tat org.eclipse.osgi.framework.internal.core.BundleHost.startWorker(BundleHost.java:381)\r\n\tat org.eclipse.osgi.framework.internal.core.AbstractBundle.start(AbstractBundle.java:300)\r\n\tat aQute.launcher.Launcher.update(Launcher.java:287)\r\n\tat aQute.launcher.Launcher.activate(Launcher.java:212)\r\n\tat aQute.launcher.Launcher.run(Launcher.java:133)\r\n\tat aQute.launcher.Launcher.main(Launcher.java:68)\r\nCaused by: java.lang.NoClassDefFoundError: org/osgi/service/framework/CompositeBundle\r\n\tat org.apache.aries.util.tracker.InternalRecursiveBundleTracker.addingBundle(InternalRecursiveBundleTracker.java:67)\r\n\tat org.osgi.util.tracker.BundleTracker$Tracked.customizerAdding(BundleTracker.java:467)\r\n\tat org.osgi.util.tracker.BundleTracker$Tracked.customizerAdding(BundleTracker.java:1)\r\n\tat org.osgi.util.tracker.AbstractTracked.trackAdding(AbstractTracked.java:256)\r\n\tat org.osgi.util.tracker.AbstractTracked.trackInitial(AbstractTracked.java:183)\r\n\tat org.osgi.util.tracker.BundleTracker.open(BundleTracker.java:156)\r\n\tat org.apache.aries.util.tracker.RecursiveBundleTracker.open(RecursiveBundleTracker.java:95)\r\n\tat org.apache.aries.blueprint.container.BlueprintExtender$2.serviceFound(BlueprintExtender.java:104)\r\n\tat org.apache.aries.util.tracker.SingleServiceTracker.update(SingleServiceTracker.java:157)\r\n\tat org.apache.aries.util.tracker.SingleServiceTracker.findMatchingReference(SingleServiceTracker.java:115)\r\n\tat org.apache.aries.util.tracker.SingleServiceTracker.open(SingleServiceTracker.java:98)\r\n\tat org.apache.aries.blueprint.container.BlueprintExtender.start(BlueprintExtender.java:112)\r\n\tat org.eclipse.osgi.framework.internal.core.BundleContextImpl$1.run(BundleContextImpl.java:711)\r\n\tat java.security.AccessController.doPrivileged(Native Method)\r\n\tat org.eclipse.osgi.framework.internal.core.BundleContextImpl.startActivator(BundleContextImpl.java:702)\r\n\t... 7 more\r\nCaused by: java.lang.ClassNotFoundException: org.osgi.service.framework.CompositeBundle\r\n\tat org.eclipse.osgi.internal.loader.BundleLoader.findClassInternal(BundleLoader.java:501)\r\n\tat org.eclipse.osgi.internal.loader.BundleLoader.findClass(BundleLoader.java:421)\r\n\tat org.eclipse.osgi.internal.loader.BundleLoader.findClass(BundleLoader.java:412)\r\n\tat org.eclipse.osgi.internal.baseadaptor.DefaultClassLoader.loadClass(DefaultClassLoader.java:107)\r\n\tat java.lang.ClassLoader.loadClass(ClassLoader.java:247)\r\n\t... 22 more","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"168445","summary":"Imports org.osgi.service.framework package as optional but assumes it's there nevertheless.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":6,"total":6,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12609151/comment/13463375","id":"13463375","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"body":"Proposed patch. The call to \"b instanceof CompositeBundle\" is protected by a boolean variable indicating whether or not the package is supported.\r\n\r\nI can commit this myself if there are no objections.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"created":"2012-09-25T23:57:35.440+0000","updated":"2012-09-25T23:57:35.440+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12609151/comment/13463563","id":"13463563","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","emailAddress":"djencks at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true},"body":"There's already an attempt to figure out whether composite bundles are supported in the RecursiveBundleTracker:\r\n\r\n    private static boolean areMultipleFrameworksAvailable(BundleContext context) {\r\n        ServiceReference sr = context.getServiceReference(\"org.osgi.service.framework.CompositeBundleFactory\");\r\n        return sr != null;\r\n\r\n\r\nand we don't create an InternalRecursiveBundleTracker if this services isn't available.  I'm not sure I understand the context you are in, would it be better to update this test to try to load CompositeBundle like your test does?  I think if CompositeBundle is not loadable we don't want to try to create this tracker, just use one of the others.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","emailAddress":"djencks at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true},"created":"2012-09-26T06:23:38.071+0000","updated":"2012-09-26T06:23:38.071+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12609151/comment/13463769","id":"13463769","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"body":"Yes, I see what you're saying. The BlueprintExtender creates a RecursiveBundleTracker which won't create an InternalRecursiveBundleTracker if areMultipleFrameworksAvailable() returns false. However, the current check there is not sufficient because Equinox will register the org.osgi.service.framework.CompositeBundleFactory service even though the corresponding package is x-internal and resolution mode is strict. So the service is there, but the Util bundle does not have access to the org.osgi.service.framework package. Moving the additional check to RecursiveBundleTracker.areMultipleFrameworksAvailable() solves the issue just as well and is fine with me. The latest patch incorporates that idea and would replace the previous patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"created":"2012-09-26T12:51:09.254+0000","updated":"2012-09-26T12:51:09.254+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12609151/comment/13464645","id":"13464645","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"body":"I intend to release the changes in aries927-areMultipleFrameworksAvailable.patch by the end of today without objection.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"created":"2012-09-27T11:40:56.860+0000","updated":"2012-09-27T11:40:56.860+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12609151/comment/13464888","id":"13464888","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","emailAddress":"djencks at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true},"body":"I like the change in aries927-areMultipleFrameworksAvailable.patch","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","emailAddress":"djencks at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true},"created":"2012-09-27T17:26:24.985+0000","updated":"2012-09-27T17:26:24.985+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12609151/comment/13465078","id":"13465078","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"body":"Fixed in http://svn.apache.org/viewvc?view=revision&revision=1391209.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwross%40us.ibm.com","name":"jwross@us.ibm.com","emailAddress":"jwross at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Ross","active":true},"created":"2012-09-27T20:53:40.884+0000","updated":"2012-09-27T20:53:40.884+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ARIES-927/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0t70f:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12512855","self":"https://issues.apache.org/jira/rest/api/latest/issue/12512855","key":"DERBY-5312","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317968","id":"12317968","description":"second release on the 10.8 branch","name":"10.8.2.2","archived":false,"released":true,"releaseDate":"2011-10-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2011-07-07 16:27:30.835","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24767","customfield_12310222":"3_*:*_1_*:*_1028662681_*|*_1_*:*_1_*:*_183241260_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2011-07-19T14:12:09.896+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5312/watchers","watchCount":0,"isWatching":false},"created":"2011-07-05T13:33:46.385+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12341256","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12341256","type":{"id":"12310010","name":"Incorporates","inward":"is part of","outward":"incorporates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310010"},"inwardIssue":{"id":"12469090","key":"DERBY-4741","self":"https://issues.apache.org/jira/rest/api/2/issue/12469090","fields":{"summary":"Make embedded Derby work reliably in the presence of thread interrupts","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-10-25T17:09:35.018+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11412","id":"11412","name":"Store"}],"timeoriginalestimate":null,"description":"WorkerThread failed with this exception:\r\n\r\nERROR 40XD1: Container was opened in read-only mode.\r\n\tat org.apache.derby.iapi.error.StandardException.newException(StandardException.java:276)\r\n\tat org.apache.derby.impl.store.raw.data.BaseContainer.use(BaseContainer.java:562)\r\n\tat org.apache.derby.impl.store.raw.data.BaseContainerHandle.useContainer(BaseContainerHandle.java:834)\r\n\tat org.apache.derby.impl.store.raw.data.BaseDataFileFactory.openContainer(BaseDataFileFactory.java:773)\r\n\tat org.apache.derby.impl.store.raw.data.BaseDataFileFactory.openContainer(BaseDataFileFactory.java:589)\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.openContainer(Xact.java:1316)\r\n\tat org.apache.derby.impl.store.access.btree.OpenBTree.init(OpenBTree.java:382)\r\n\tat org.apache.derby.impl.store.access.btree.BTreeController.init(BTreeController.java:1225)\r\n\tat org.apache.derby.impl.store.access.btree.index.B2IController.init(B2IController.java:140)\r\n\tat org.apache.derby.impl.store.access.btree.index.B2I.open(B2I.java:824)\r\n\tat org.apache.derby.impl.store.access.RAMTransaction.openConglomerate(RAMTransaction.java:476)\r\n\tat org.apache.derby.impl.store.access.RAMTransaction.openCompiledConglomerate(RAMTransaction.java:1293)\r\n\tat org.apache.derby.impl.sql.execute.IndexChanger.openIndexCC(IndexChanger.java:507)\r\n\tat org.apache.derby.impl.sql.execute.IndexChanger.insertAndCheckDups(IndexChanger.java:438)\r\n\tat org.apache.derby.impl.sql.execute.IndexChanger.doInsert(IndexChanger.java:383)\r\n\tat org.apache.derby.impl.sql.execute.IndexChanger.insert(IndexChanger.java:590)\r\n\tat org.apache.derby.impl.sql.execute.IndexSetChanger.insert(IndexSetChanger.java:268)\r\n\tat org.apache.derby.impl.sql.execute.RowChangerImpl.insertRow(RowChangerImpl.java:453)\r\n\tat org.apache.derby.impl.sql.execute.InsertResultSet.normalInsertCore(InsertResultSet.java:999)\r\n\tat org.apache.derby.impl.sql.execute.InsertResultSet.open(InsertResultSet.java:519)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:436)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:317)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1242)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1686)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeUpdate(EmbedPreparedStatement.java:308)\r\n\tat org.apache.derbyTesting.functionTests.tests.store.InterruptResilienceTest$WorkerThread.run(InterruptResilienceTest.java:449)\r\n\r\nI was testing a patch for DERBY-4620 (estimate-sizes.diff), but I think the failure isn't related to those changes.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10369","value":"Regression Test Failure","id":"10369"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"36237","summary":"InterruptResilienceTest failed with ERROR 40XD1: Container was opened in read-only mode.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Oracle Solaris 11 Express snv_151a X86\r\njava version \"1.7.0\"\r\nJava(TM) SE Runtime Environment (build 1.7.0-b147)\r\nJava HotSpot(TM) Server VM (build 21.0-b17, mixed mode)","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":13,"total":13,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512855/comment/13059900","id":"13059900","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Uploading derby.log and stack trace from the failing test run.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-07-05T13:35:36.982+0000","updated":"2011-07-05T13:35:36.982+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512855/comment/13061417","id":"13061417","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"I was able to reproduce this in one out of 100 runs on my laptop. I think it is a side effect of something being thrown in privGetJBMSLockOnDB, cf this the code fragment ca line 1933. I'll try to instrument it.\r\n\r\ncatch (IOException ioe)\r\n{\r\n     // probably a read only db, don't do anything more\r\n     readOnly = true;","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-07-07T16:27:30.835+0000","updated":"2011-07-07T16:27:30.835+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512855/comment/13064096","id":"13064096","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"With this trace in FileContainer#canUpdate:\r\n\r\n    protected boolean canUpdate() {\r\n        if (!canUpdate) {\r\n           System.err.println(\"FileContainer#canUpdate: \" + canUpdate);\r\n        }\r\n    \r\n        return canUpdate;\r\n    }\r\n\r\nI see 3 out of 700 runs:\r\n\r\n    ..FileContainer#canUpdate: true\r\n    ..........\r\n\r\nI.e. a race: !canUpdate -> canUpdate, but how?  Btw, the value is not printed at \"false\" on either of the three hits.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-07-12T19:47:43.603+0000","updated":"2011-07-12T19:47:43.603+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512855/comment/13064123","id":"13064123","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Under reopening a container there is a small time-window inside in RAFContainer#run(OPEN_CONTAINER_ACTION):\r\n             :\r\n             canUpdate = false;\r\n             try {\r\n                 boolean b1 = !dataFactory.isReadOnly();\r\n                 boolean b2 = file.canWrite();\r\n                 // if (!dataFactory.isReadOnly() && file.canWrite())\r\n                 if (b1 && b2) {\r\n                     canUpdate = true;\r\n\r\nduring which the flag canUpdate is set to \"false\", the (normally) to \"true\" again. This code is not synchronized with the call BaseContainer#use -> FileContainer#update to check the value of \"canUpdate\".","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-07-12T20:28:38.987+0000","updated":"2011-07-12T20:30:14.265+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512855/comment/13064127","id":"13064127","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"It looks like there is little synchronization on that variable and access is shared across multiple files, as noted below.\r\nWhile very short it does seem possible for a change to happen to canUpdate after it is checked, and JIT probably can't\r\nopt it out as it is a shared variable.  Just to check for a JIT bug it may help to rewrite as something like:\r\n\r\n\r\nif (!(tmp_canUpdate = canUpdate))\r\n{\r\n        print both tmp and canUpdate\r\n}\r\n\r\nMaybe a bit more instrumentation might help.  Maybe the stack of the call.  Or at least for your test I think if you throw an\r\nassert then the new error reporting stuff will print stacks of every thread.  It may not work though as we are talking about\r\na few instructions while the stack dumps are likely 1000's or more.   Has the feel of one thread opening a shared\r\ncontainer and not properly coordinating with someone that is closing it.  Given the test, is it likely someone is incorrectly\r\nclosing the container?\r\n\r\nIs this test likely flooding the container cache?\r\n\r\nThere is at least competition on this resource between user thread and store background daemon either doing checkpoint\r\nor post commit work.  If the test has multiple threads than add that also.\r\n\r\n:\r\nBaseContainer.java:             if (forUpdate && !canUpdate())\r\nBaseContainer.java:     protected abstract boolean canUpdate();\r\nFileContainer.java:     protected boolean canUpdate;        // can I be written\r\nto?\r\nFileContainer.java:             canUpdate = false;\r\nFileContainer.java:     protected boolean canUpdate() {\r\nFileContainer.java:             return canUpdate;\r\nInputStreamContainer.java:              canUpdate = false;\r\nRAFContainer.java:             canUpdate = true;\r\nRAFContainer.java:             canUpdate = false;\r\nRAFContainer.java:                     canUpdate = true;\r\nRAFContainer.java:                 fileData = file.getRandomAccessFile(canUpdate\r\n ? \"rw\" : \"r\");\r\nRAFContainer.java:                             stub.getRandomAccessFile(canUpdat\r\ne ? \"rw\" : \"r\");","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-07-12T20:42:27.355+0000","updated":"2011-07-12T20:42:27.355+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512855/comment/13064142","id":"13064142","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Thanks, Mike. I think I understand why this is happening now.\r\nOne thread sees an interrupt and goes on to reopen the container to get the NIO channel up again.  During reopening the \"canUpdate\" state variable is briefly set to false before being set to true again. Meanwhile, another another thread is accessing the container, cf. the call stack of this issue. During that access, BaseContainer#use calls FileContainer#canUpdate and (sometimes) reads the \"false\" value in the short time window in question.\r\n\r\nUploading a patch which omits setting \"canUpdate\" during reopening of the container. It should not have changed during the brief period the channel was closed due to the interrupt, so this seems ok, cf. the Javadoc for the variable \"FileContainer#canUpdate\": it should only change when we reset the identity of the container.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-07-12T21:19:12.912+0000","updated":"2011-07-12T21:21:27.317+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512855/comment/13064193","id":"13064193","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"the patch looks fine to me, the work need not be done for a reopen.\r\n\r\nBut, isn't the real problem that there is some uncoordinated activity that should be coordinated.  Some thread is actively doing\r\nwork on the filecontainer because it thinks it is open, but the code is in the middle of reopening it.  Is there going be some\r\nother problem with the rest of the work in the reopen and the competing thread or is that handled somehow else.  I did not \r\nfollow all the work in this area so if this is meant to be handled somehow else, good.  maybe just another comment in your\r\nchange explaining why it is ok for use()  to complete while the file is being reopened would help.  I see there is a comment\r\nabout deadlock on synchonization later so that is likely an issue.\r\n\r\nIs closeContainer() access to fileData with no sync a problem?\r\n\r\nDo you think there is any similar problem with isStub as canUpdate?\r\n\r\nI don't know if it is possible but is it possible the only work that needs to be done on a reopen is:\r\nfileData = file.getRandomAccessFile(canUpdate ? \"rw\" : \"r\");\r\n    or does the closing exception lose isStub, file, and/or fileName?\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-07-12T22:15:49.488+0000","updated":"2011-07-12T22:15:49.488+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512855/comment/13064540","id":"13064540","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Thanks for looking at this Mike! I agree that closeContainer should be synchronized on the container w.r.t handling fileData, since it will be accessed by other threads during IO which are oblivious to the reopening taking place. All such use cases are synchronized on \"this\", or are related to creation and opening.  As far as I can see, closeContainer doesn't touch any other container state variables. \"isStub\" is method local (once defined and used on CREATE_CONTAINER_ACTION, once defined and used in OPEN_CONTAINER_ACTION), so that should be OK.\r\n\r\nAs for simplifying to just to just resetting fileData, I'll look into if we could do that. \"file\" is also method local.and \"fileName\" is only set in OPEN_CONTAINER_ACTION and only ever used as a string when throwing exceptions, so it should be possible to simplify reopening.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-07-13T13:28:17.918+0000","updated":"2011-07-13T13:28:17.918+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512855/comment/13065317","id":"13065317","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Uploading a patch (derby-5312-simplify-reopen-1) which simplies the\r\nreopening by essentially only a new call to\r\n\r\n    file.getRandomAccessFile(canUpdate ? \"rw\" : \"r\")\r\n\r\nas discussed. To get \"file\", I let RAFContainer4 keep the current\r\nidentity so the reopen can find file by handing back the identity when\r\nwe ned to make the call:\r\n\r\n   StorageFile file = privGetFileName( actionIdentity, false, true, true);\r\n\r\nbut removed that state variable from RAFContainer. I ran an earlier\r\nversion of this overnight (some 800 iterations of the test), without\r\nseeing this error again. Running regressions.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-07-14T15:15:33.288+0000","updated":"2011-07-14T15:15:33.288+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512855/comment/13065447","id":"13065447","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"The new patch looks good to me, now it is very clear what reopen does and seems simpler.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-07-14T18:42:46.362+0000","updated":"2011-07-14T18:42:46.362+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512855/comment/13067735","id":"13067735","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Committed derby-5312-simplify-reopen-1 as svn 1148344, resolving, but not closing: will backport to 10.8 first.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-07-19T14:11:41.413+0000","updated":"2011-07-19T14:11:41.413+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512855/comment/13071133","id":"13071133","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Back-ported to 10.8 branch as svn 1151122. Knut, feel free to close if you think the issue is adequately addressed.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-07-26T14:51:34.867+0000","updated":"2011-07-26T14:51:34.867+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512855/comment/13072255","id":"13072255","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I haven't seen the failure again after the fix went in. Closing the issue. Thanks for fixing it, Dag.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-07-28T08:42:28.394+0000","updated":"2011-07-28T08:42:28.394+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5312/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06kdz:"}}
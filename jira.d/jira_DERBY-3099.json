{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12379549","self":"https://issues.apache.org/jira/rest/api/latest/issue/12379549","key":"DERBY-3099","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312876","id":"12312876","description":"","name":"10.3.2.1","archived":false,"released":true,"releaseDate":"2007-12-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2007-10-10 15:19:11.935","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23431","customfield_12310222":"3_*:*_1_*:*_77968796_*|*_1_*:*_1_*:*_604832032_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_53271935","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2007-10-11T06:35:15.517+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3099/watchers","watchCount":0,"isWatching":false},"created":"2007-10-03T08:55:14.689+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-10-11T21:23:07.448+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11415","id":"11415","name":"Services"},{"self":"https://issues.apache.org/jira/rest/api/2/component/11412","id":"11412","name":"Store"}],"timeoriginalestimate":null,"description":"I noticed this strange behaviour when I was working on DERBY-2911. It seems like the result of test case P042 in unit/T_RawStoreFactory.unit is dependent on the actual contents of the buffer manager (which pages have been evicted, which free entries have been reused and so on). I'm not sure if this is a bug in the test or somewhere in the code, or if this is expected behaviour, but it sounds a bit suspicious.\n\nFor instance, commenting out all the test cases preceeding P042 makes P042 fail, even though P042 creates a new container so that it should not be affected by any of the previous test cases. Also, commenting out a space optimization in Clock.findFreeItem() so that freed entries are not reused except when rotateClock() is called on a full cache to find a victim, causes the test case to fail. A third way to make it fail, is to vary the scan direction when looking for a free entry to reuse in the new buffer manager (ConcurrentCache). If the scan is disabled or walks the clock from the beginning to the end, the test fails, but if the clock is scanned backwards, it passes.\n\nThe code that fails in the test, is\n\n\t\t\tc = t_util.t_openContainer(t, segment, cid, true);\n\t\t\tPage checkNextPage = t_util.t_addPage(c);\n\t\t\tif (checkNextPage.getPageNumber() == nextPageNumber)\n\t\t\t\tthrow T_Fail.testFailMsg(\n\t\t\t\t\t\"expect some pages to be freed by update rollback\");\n\nThe expected page number is 2, and the actual page number is 7.\n\nBefore this, a large row has been inserted on page 1 and overflows to page 2, 3, 4, 5 and 6. Also, page 7 has been added manually before all the updates were rolled back so that the pages from 2 up to 7 should be unallocated. Page 7 is then added and removed, and the transaction is committed. After reopening the container, the test expects the pages from 2 up to 7 to be free, and that t_addPage() should allocate page number 2.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39813","summary":"Possible bug in interaction with buffer manager causing pages not to be freed on rollback to savepoint","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":15,"total":15,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12532050","id":"12532050","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"When T_RawStoreFactory.P042() fails, a finally clause tries to unlatch an already unlatched page and hides the actual error. The failure in the finally clause is not immediately picked up by the test framework and the test therefore hangs until it times out after one hour.\r\n\r\nThe attached patch makes the cleanup code check whether the page is latched before unlatching it. This makes the test fail faster if it fails, and the real error is not hidden by the error in the cleanup code. The patch also removes an unused variable from the test case.\r\n\r\nCommitted revision 581544.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-10-03T09:49:30.349+0000","updated":"2007-10-03T09:49:30.349+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12532053","id":"12532053","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Here is a dump of the alloc page right before the call to addPage() in a successfull test run (clean trunk). Note that page 3, 4, 5 and 6 are marked as valid, in use pages. I had expected those pages to be free, since the update that overflowed to them was rolled back.\r\n\r\n*** Alloc page ***\r\nnextAllocPageNumber = -1\r\nnextAllocPageOffset = 0\r\nreserved1 = 0\r\nreserved2 = 0\r\nreserved3 = 0\r\nreserved4 = 0\r\nborrowedSpace = 80\r\nextent = -----------------------------------------------------------------------\r\n-------\r\nExtent map of from page 1 to page 10216\r\n        page 1: valid, in use page\r\n        page 2: free page\r\n        page 3: valid, in use page\r\n        page 4: valid, in use page\r\n        page 5: valid, in use page\r\n        page 6: valid, in use page\r\n        page 7: free page\r\n        From 7 to 10216 are un-allocated pages\r\n------------------------------------------------------------------------------\r\n---------------------------------------------------\r\npage id Page(0,Container(0, 1191405214574)) Overflow: false PageVersion: 28 SlotsInUse: 0 DeletedRowCount: 0 PageStatus: 1 NextId: 6 firstFreeByte: 189 freeSpace: 3899 totalSpace: 3899 spareSpace: 0 PageSize: 4096\r\n---------------------------------------------------\r\nHex dump:\r\n00000000: 0076 0000 0001 0000 0000 0000 0000 0000  .v..............\r\n00000010: 0000 0006 0000 0000 0000 0000 0000 0000  ................\r\n00000020: 0000 0000 0001 0000 0000 0000 0000 0000  ................\r\n00000030: 0000 0000 0000 0000 0000 0000 ffff ffff  ................\r\n00000040: ffff ffff 0000 0000 0000 0000 0000 0000  ................\r\n00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................\r\n00000060: 0000 0000 0000 0000 0000 0000 5000 0000  ............P...\r\n00000070: 7400 0000 0000 0010 0000 0000 1400 0000  t...............\r\n00000080: 0c00 0100 0800 0000 0000 0000 0000 0000  ................\r\n00000090: 0000 0000 0000 0000 0000 0000 0000 0000  ................\r\n000000a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................\r\n000000b0: 0000 0000 0000 0000 00dc 7f30 ca00 0000  .........?.0?...\r\n000000c0: 0000 0010 0000 0000 0000 0000 0100 0000  ................\r\n000000d0: 0000 0027 e800 0000 0030 0000 0000 0000  .........0......\r\n000000e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................\r\n.\r\n.\r\n.\r\n(the rest of the page is just zeros, except the checksum)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-10-03T10:03:46.653+0000","updated":"2007-10-03T10:03:46.653+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12532096","id":"12532096","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"To disable the scan for free entries in a buffer manager which is not full, make this change to Clock.findFreeItem():\r\n\r\n@@ -860,7 +860,7 @@\r\n \r\n \t\t// no need to sync on getting the sizes since if they are\r\n \t\t// wrong we will discover it in the loop.\r\n-\t\tif (validItemCount < holders.size()) {\r\n+\t\tif (false&&validItemCount < holders.size()) {\r\n \r\n \t\t\tsynchronized (this) {\r\n \r\n\r\nBelow is a dump of the alloc page at the same point in the test when running with the scan disabled. Major differences:\r\n\r\n  a) page 2 is not free\r\n  b) 6th byte (status byte) is zero, whereas the only valid values are 1 (valid) and 2 (invalid). However, the pageStatus flag is 1.\r\n  c) firstFreeByte, freeSpace and totalSpace are different\r\n\r\n*** Alloc page ***\r\nnextAllocPageNumber = -1\r\nnextAllocPageOffset = 0\r\nreserved1 = 0\r\nreserved2 = 0\r\nreserved3 = 0\r\nreserved4 = 0\r\nborrowedSpace = 80\r\nextent = ------------------------------------------------------------------------------\r\nExtent map of from page 1 to page 10216\r\n\tpage 1: valid, in use page\r\n\tpage 2: valid, in use page\r\n\tpage 3: valid, in use page\r\n\tpage 4: valid, in use page\r\n\tpage 5: valid, in use page\r\n\tpage 6: valid, in use page\r\n\tpage 7: free page\r\n\tFrom 7 to 10216 are un-allocated pages\r\n------------------------------------------------------------------------------\r\n---------------------------------------------------\r\npage id Page(0,Container(0, 1191416310107)) Overflow: false PageVersion: 27 SlotsInUse: 0 DeletedRowCount: 0 PageStatus: 1 NextId: 6 firstFreeByte: 109 freeSpace: 3979 totalSpace: 3979 spareSpace: 0 PageSize: 4096\r\n---------------------------------------------------\r\nHex dump:\r\n00000000: 0076 0000 0000 0000 0000 0000 0000 0000  .v..............\r\n00000010: 0000 0006 0000 0000 0000 0000 0000 0000  ................\r\n00000020: 0000 0000 0001 0000 0000 0000 0000 0000  ................\r\n00000030: 0000 0000 0000 0000 0000 0000 ffff ffff  ................\r\n00000040: ffff ffff 0000 0000 0000 0000 0000 0000  ................\r\n00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................\r\n00000060: 0000 0000 0000 0000 0000 0000 5000 0000  ............P...\r\n00000070: 7400 0000 0000 0010 0000 0000 1400 0000  t...............\r\n00000080: 0c00 0100 0800 0000 0000 0000 0000 0000  ................\r\n00000090: 0000 0000 0000 0000 0000 0000 0000 0000  ................\r\n000000a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................\r\n000000b0: 0000 0000 0000 0000 00dc 7f30 ca00 0000  .........?.0?...\r\n000000c0: 0000 0010 0000 0000 0000 0000 0100 0000  ................\r\n000000d0: 0000 0027 e800 0000 0030 0000 0000 0000  .........0......\r\n000000e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................\r\n.\r\n.\r\n.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-10-03T13:23:26.168+0000","updated":"2007-10-03T13:23:26.168+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12532101","id":"12532101","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I also tried to dump the alloc page right after the container was created, and I see the same differences in the 6th byte and in the fields firstFreeByte, freeSpace and totalSpace there as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-10-03T13:28:48.177+0000","updated":"2007-10-03T13:28:48.177+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12532106","id":"12532106","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"If I run the test with all other test cases commented out (but with a clean version of Clock), the status byte is OK (1), but all the other differences are there (page 2 is not free, and firstFreeByte/freeSpace/totalSpace are different).\r\n\r\nSo I guess the first thing we need to find out is why firstFreeByte/freeSpace/totalSpace are different already when the container is created.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-10-03T13:35:14.200+0000","updated":"2007-10-03T13:35:14.200+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12533135","id":"12533135","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"OK, so I found out why firstFreeByte/freeSpace/totalSpace were different (see DERBY-3116), but that doesn't seem to be the problem. I'll keep looking.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-10-08T14:28:06.527+0000","updated":"2007-10-08T14:28:06.527+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12533336","id":"12533336","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I think I found the problem. I extended the toString() methods in the page classes so that they printed all the fields, and then I noticed that the maxFieldSize field was different too. This field is initialized in StoredPage.initSpace() and depends on the value of slotEntrySize. initSpace() is called from StoredPage.usePageBuffer() which also initializes slotEntrySize. However, slotEntrySize is not initialized until after initSpace() has been called, so the value seen in initSpace() is old and possibly incorrect.\r\n\r\nThe attached patch delays the call to initSpace() until slotEntrySize is properly initialized. This made T_RawStoreFactory run successfully with the buffer manager changes that made it fail before.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-10-09T12:02:33.892+0000","updated":"2007-10-09T12:02:33.892+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12533667","id":"12533667","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I don't know how to make a reliable repro for this issue on a clean trunk, but the attached assert.diff adds some asserts that check if slotFieldSize and slotEntrySize are uninitialized. With these asserts, I'm not able to create a new database:\r\n\r\nij version 10.4\r\nij> connect 'jdbc:derby:db;create=true';\r\nERROR XJ041: Failed to create database 'db', see the next exception for details.\r\nERROR XBM01: Startup failed due to an exception. See next exception for details. \r\nERROR XJ001: Java exception: 'ASSERT FAILED slotFieldSize uninitialized: org.apache.derby.shared.common.sanity.AssertFailure'.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-10-10T09:09:02.313+0000","updated":"2007-10-10T09:09:02.313+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12533671","id":"12533671","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The patch d3099-1.diff combines initSpace.diff and assert.diff. I have started a full regression test suite run and will post the results as soon as it has finished.\r\n\r\nThe patch makes the following changes:\r\n  1) Makes maxFieldSize private and fixes its comment\r\n  2) Asserts that slotFieldSize/slotEntrySize have been properly initialized in initSpace()\r\n  3) Delays the call to initSpace() until slotFieldSize/slotEntrySize have been initialized","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-10-10T09:15:55.578+0000","updated":"2007-10-10T09:15:55.578+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12533732","id":"12533732","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Derbyall and suites.All ran cleanly. Please review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-10-10T12:57:04.109+0000","updated":"2007-10-10T12:57:04.109+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12533766","id":"12533766","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Patch d3099-1.diff seems like a good patch to me. My only suggestion is\r\nthat I think you could place a comment into the code around line 700,\r\nnoting that the order of operations here is important, something along\r\nthe lines of:\r\n\r\n  // Note that the slotFieldSize and slotEntrySize need to be\r\n  // calculated BEFORE initSpace() is called, because the\r\n  // maxFieldSize computation in initSpace() includes these\r\n  // values in its calculations.\r\n\r\nThe comment at line 3355 is good, too, but it is somewhat \r\ndiscontiguous from the order-critical portion of your change.\r\n\r\nWhether or not you think an extra comment would help, +1 to commit from me.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-10-10T15:19:11.935+0000","updated":"2007-10-10T15:19:11.935+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12533840","id":"12533840","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Good idea, Bryan. I'll add the comment before I commit. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-10-10T19:06:51.913+0000","updated":"2007-10-10T19:06:51.913+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12533966","id":"12533966","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Committed revision 583691.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-10-11T06:35:15.479+0000","updated":"2007-10-11T06:35:15.479+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12533970","id":"12533970","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The bug is also present on the 10.3 branch (I applied the assert.diff patch and got the expected assert failures when I tried to connect to a database). Should the fix be backported, or is it safer just to leave it as it is since there are no known user-visible consequences?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-10-11T06:46:36.505+0000","updated":"2007-10-11T06:46:36.505+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12379549/comment/12534162","id":"12534162","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Committed to 10.3 with revision 583956.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-10-11T21:22:54.514+0000","updated":"2007-10-11T21:22:54.514+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3099/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i076gn:"}}
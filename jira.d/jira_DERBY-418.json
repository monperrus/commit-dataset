{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12311840","self":"https://issues.apache.org/jira/rest/api/latest/issue/12311840","key":"DERBY-418","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-07-20 12:24:02.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"21947","customfield_12310222":"3_*:*_1_*:*_773151000_*|*_1_*:*_1_*:*_36142666000_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-09-01T11:58:43.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-418/watchers","watchCount":1,"isWatching":false},"created":"2005-07-01T05:35:06.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"7.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12316327","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12316327","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12370141","key":"DERBY-2689","self":"https://issues.apache.org/jira/rest/api/2/issue/12370141","fields":{"summary":"Deadlock with GenericPreparedStatement","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-05-05T11:06:47.777+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11412","id":"11412","name":"Store"}],"timeoriginalestimate":null,"description":"On the derby-user list,  Chris reported tihs problem with his application and also a repro for the problem.  I am logging the jira issue so it doesnt get lost in all the mail.  (http://www.mail-archive.com/derby-user@db.apache.org/msg01258.html)\n\n------from chris's post----------\nI'm running a set of ~50000 queries on one table, using inserts and updates, and i want to be able to roll them back so i turned off autocommit using setAutoCommit(false).  As the update runs, the memory used by the JVM increases continually until i get the following exception about 20% of the way through:\n\nERROR 40XT0: An internal error was identified by RawStore module.\n   at org.apache.derby.iapi.error.StandardException.newException(StandardException.java)\n   at org.apache.derby.impl.store.raw.xact.Xact.setActiveState(Xact.java)\n   at org.apache.derby.impl.store.raw.xact.Xact.openContainer(Xact.java)\n   at org.apache.derby.impl.store.access.conglomerate.OpenConglomerate.init(OpenConglomerate.java)\n   at org.apache.derby.impl.store.access.heap.Heap.open(Heap.java)\n   at org.apache.derby.impl.store.access.RAMTransaction.openConglomerate(RAMTransaction.java)\n   at org.apache.derby.impl.store.access.RAMTransaction.openConglomerate(RAMTransaction.java)\n   at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getDescriptorViaIndex(DataDictionaryImpl.java)\n   at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.locateSchemaRow(DataDictionaryImpl.java)\n   at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.getSchemaDescriptor(DataDictionaryImpl.java)\n   at org.apache.derby.impl.sql.compile.QueryTreeNode.getSchemaDescriptor(QueryTreeNode.java)\n   at org.apache.derby.impl.sql.compile.QueryTreeNode.getSchemaDescriptor(QueryTreeNode.java)\n   at org.apache.derby.impl.sql.compile.FromBaseTable.bindTableDescriptor(FromBaseTable.java)\n   at org.apache.derby.impl.sql.compile.FromBaseTable.bindNonVTITables(FromBaseTable.java)\n   at org.apache.derby.impl.sql.compile.FromList.bindTables(FromList.java)\n   at org.apache.derby.impl.sql.compile.SelectNode.bindNonVTITables(SelectNode.java)\n   at org.apache.derby.impl.sql.compile.DMLStatementNode.bindTables(DMLStatementNode.java)\n   at org.apache.derby.impl.sql.compile.DMLStatementNode.bind(DMLStatementNode.java)\n   at org.apache.derby.impl.sql.compile.ReadCursorNode.bind(ReadCursorNode.java)\n   at org.apache.derby.impl.sql.compile.CursorNode.bind(CursorNode.java)\n   at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.java)\n   at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java)\n   at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(GenericLanguageConnectionContext.java)\n   at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java)\n   at org.apache.derby.impl.jdbc.EmbedStatement.executeQuery(EmbedStatement.java)\n   at vi.hotspot.database.DataInterface._query(DataInterface.java:181)\n   at vi.hotspot.database.DataInterface.query(DataInterface.java:160)\n   at vi.hotspot.database.UpdateManager.updatePartialTable(UpdateManager.java:518)\n   at vi.hotspot.database.UpdateManager.updatePartialTables(UpdateManager.java:619)\n   at vi.hotspot.database.UpdateManager.run(UpdateManager.java:924)\n   at java.lang.Thread.run(Thread.java:534)\nvi.hotspot.exception.ServerTransactionException\n   at vi.hotspot.database.UpdateManager.updatePartialTable(UpdateManager.java:555)\n   at vi.hotspot.database.UpdateManager.updatePartialTables(UpdateManager.java:619)\n   at vi.hotspot.database.UpdateManager.run(UpdateManager.java:924)\n   at java.lang.Thread.run(Thread.java:534)\n\nDerby is running in standalone mode. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"38113","summary":"outofmemory error when running large query in autocommit=false mode","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"I can reproduce this problem on Win2k/ T42 laptop. jdk141. ","customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":37,"total":37,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12314814","id":"12314814","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"body":"This repro was given by Chris.  http://www.mail-archive.com/derby-user@db.apache.org/msg01258.html.   \r\nTo run \r\njava -Xmx64M AutoCommitTest","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=skambha","name":"skambha","emailAddress":"ksunithaghm at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunitha Kambhampati","active":true},"created":"2005-07-01T05:37:19.000+0000","updated":"2005-07-01T05:37:19.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12422407","id":"12422407","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"I was able to reproduce this issue on my Sol10 x86 jdk1.5 platform.\r\n\r\nI ran with following option,\r\n-verbosegc (java option)\r\n--Xmx16m (preferred this option to avoid large output file n reproduce the error in less time for the analysis)\r\n-Dderby.debug.true=memoryLeakTrace\r\n\r\nFollowing are the observations from the output of this command,\r\n\r\nmemoryLeakTrace:GenericLanguageContext:activations 1917 (memoryLeak is reported after activations grow > 20)\r\nmemoryLeakTrace:BasicDependencyManager:table 1966 (memoryLeak is reported after table size grow > 100)\r\nmemoryLeakTrace:BasicDependencyManager:deps 1966 (memoryLeak is reported after dependencies grow > 50)\r\nmemoryLeakTrace:LockSet: 1908 (mem leak reported after lock objects grow > 1000)\r\n\r\nI have not gotten any further on this issue and do not plan to work on this until atleast the week after next.\r\nHTH!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2006-07-20T12:24:02.000+0000","updated":"2006-07-20T12:24:02.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12427480","id":"12427480","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"I used the JHAT (jdk1.6) to dump the java heap and observed that large number of generated objects of type CursorActivation exist on the heap. The expected behavior here is to have not more than 1 Activation when the statement is being executed. Further investigation showed that these generated objects are not getting closed for only the \"select\" kind statements. \r\nThe GenericPreparedStatement fires activation.execute method and gets the result in a ResultSet object. It then checks if the singleExecution flag for activation is true and the returned resultSet is closed. If both are true then the activation is closed. For the \"select\" statements in the reproducible testcase, the returned resultSet is not closed and hence the activation is NOT closed. Thus causing the memory leak.\r\n\r\nThe code for activation.execute is dynamically generated code. I need some help to understand how this can be debugged.\r\nBefore that, I would like to understand if the returned resultSet should really be closed for \"select\" statement ?? If Yes, then when the activation is expected to be closed for such case ?? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2006-08-11T09:30:01.000+0000","updated":"2006-08-11T09:30:01.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12427844","id":"12427844","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"In the reproducible testbase, autoCommit is set to FALSE, and more important, the resultSet returned by select query is not closed. So, the generated Activation objects stay on the heap resulting in OOME.\r\n\r\nI modified the testcase to close the ResultSet in each iteration and program runs fine.\r\n\r\nUnless someone disagrees with the analysis, I think this JIRA can be closed with \"Not a bug\".","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2006-08-14T09:40:13.000+0000","updated":"2006-08-14T09:40:13.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12427891","id":"12427891","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"Thanks to Andreas and Oystein for pointing out another possibilty that when the statement objects are GC'd, the activations associated with them are not closed which could be causing the leak.\r\n\r\nI shall work further on this and have assigned this one to myself.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2006-08-14T14:10:40.000+0000","updated":"2006-08-14T14:10:40.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12427899","id":"12427899","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"I think this is the same case as described in DERBY-1142, comment towards end has a couple of possible solutions.\r\nhttp://issues.apache.org/jira/browse/DERBY-1142#action_12420461","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-08-14T14:22:12.000+0000","updated":"2006-08-14T14:22:12.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429259","id":"12429259","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"I tried modifying the finalize method of embedResultSet to close singleuseActivation and that seems to have worked for good reasons. So, when GC operations clean up resultset objects the associated activation objects will be closed, thus freeing up some more memory. But, for the reproducible case, this is not the complete solution. This change differs the leak for a long period but does not completely fix it.\r\n\r\nI tried the same fix for the repro in DERBY-1142 (without resultset.close statement) and did not see any leak there.\r\n\r\nI think, this can be a good fix for now until the extreme case is tracked down.\r\n\r\nI will run derbyall with this fix and produce a patch soon.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2006-08-20T11:15:45.000+0000","updated":"2006-08-20T11:15:45.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429264","id":"12429264","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"Closing the activation directly in the finalize method will lead to problems. The close of the activation requires obtaining synchronization which is not recommended for the finalizer thread, it can lead to deadlocks with the thread that owns the connection and its synchronization. That's why the activations are closed indirectly through the set inactive state mechanism.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-08-20T14:17:11.000+0000","updated":"2006-08-20T14:17:11.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429361","id":"12429361","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"body":"I think that the lack of synchronization when calling singleUseActivation.markUnused() may cause that other threads do not see that the field inUse has been modified in the activation. Since it is the finalizer thread which calls this, it could mean that the thread which checks the inUse flag to close the activation, will not see that it has been modified to false.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"created":"2006-08-21T08:46:38.000+0000","updated":"2006-08-21T08:46:38.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429386","id":"12429386","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"body":"The finalizer thread is as pr javadoc guaranteed to not hold any user-visible synchronization locks when finalize is invoked. If the finalizer synchronizes in the same order as the other methods, it should not introduce any dead-locks (you may get lock-waiting, but not dead-lock).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"created":"2006-08-21T10:52:35.000+0000","updated":"2006-08-21T10:52:35.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429430","id":"12429430","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"I don't think there is any guarantee about the order of finalization, therefore it is impossible to guarantee the same order of synchronization by the finalizer threads as the main code path, so obtaining synchronization within  a finlize method is subject to deadlocks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-08-21T14:54:25.000+0000","updated":"2006-08-21T14:54:25.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429438","id":"12429438","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"body":"I am not sure what you mean. \r\n\r\nCould you give an example ?\r\n\r\nI agree that it is possible to get a deadlock in the finalize() method if it obtains its locks in a different order than another user thread or another finalizer thread. If it obtains the locks in the same order, the condition for a deadlock is not there. If there are multiple objects being garbage collected, sharing mutexes, they need to set the locks in the same order - or else you may get deadlock.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"created":"2006-08-21T15:41:13.000+0000","updated":"2006-08-21T15:41:13.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429442","id":"12429442","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"The alternate way to phrase it  is:\r\n\r\nCan you guarantee no deadlocks from using synchronization in the finalize method?\r\n\r\nClosing an activation in the finalize() methods is going to hit a lot of synchronized blocks, there just seems endless potential\r\nfor deadlocks, especially when the connection may be in any state, not being used, rolling back, preparing a statement, executing a statement, being shutdown by an unrelated error, being finalized itself, etc. etc.. This is then further compilcated by the fact the the order of execution within finalization is not guaranteed, if I have a chain of objects A,B,C the order they are finalized is not guaranteed, could be BAC, could be CBA, could be by different finalize threads.\r\n\r\nSo given that, how easy is it to show the locking ordering is consistent?\r\n\r\nIf you prove there is no possible chance of deadlocks, how is this enforced going forward? Does every change to any sycnhronized block have to go through a full review of possible implications with a single finalize method in EmbededResultSet?\r\n\r\nMaybe it's just me, but getting no synchronization in a finalize() method seems to be a nice simple rule, that doesn't require a proof for on-going changes in the engine. I suggested some possible changes to fix this in DERBY-1142 and noted them above, are there any issues with those?\r\n  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-08-21T16:02:26.000+0000","updated":"2006-08-21T16:02:26.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429473","id":"12429473","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"body":"Assuming the Derby embedded JDBC driver is thread-safe, it should be safe for a result set to call its own close() method in its finalizer. If you get a dead-lock in the finalizer, it proves that it is also possible to write a multithreaded program which gets deadlocks when calling ResultSet.close, and derby then is not really MT-safe.\r\n\r\nIf this happens, I think it is better to fix the embedded driver so that it really becomes MT-safe, than avoiding synchronization in the finalizer threads.\r\n\r\nAs for the suggested change in 1142, I would note that If there is no synchronization in the finalizer, and you set a field in a object from it, there is no guarantee that other threads will see the modification of the field (unless, I think, it is volatile). However, I think Mayuresh has been working on this issue, so maybe he has tried that approach?\r\n\r\nAnother approach could be to use a WeakHashMap to store the activations in, instead of a Vector. If all objects referring to the activation have been garbage collected, the activation will be removed from the WeakHashMap.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"created":"2006-08-21T17:47:55.000+0000","updated":"2006-08-21T17:47:55.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429483","id":"12429483","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"I'd assumed that you were going to go in at a lower level than ResultSet.close(). ResultSet.close() is thread safe, but think of the consequences of calling ResultSet.close() from a finalizer.\r\n\r\n  - The finalizer thread will block until the application thread executing a JDBC method on another object in the same connection completes the call. Worst case is the application thread is executing a query that takes several hours. Now the synchronization in the finalize method has resulted in the finalize thread stalling for a few hours, not good for the VM.\r\n\r\n -  What if the garbage collector thread is running because the application thread, using the same connection, requires memory, now you have created a deadlock , the application thread is waiting on the JVM to get memory, the vm finalizer thread is waiting on the application thread to complete its JDBC method call.\r\n\r\nNot sure of the guarantee of the unsynchronized field being set. Are you saying that field will never be seen as set, or that the setting may not be seen for some time?\r\n\r\nThe activation being in the Vector is not an issue, so replacing it with a WeakHashMap doesn't help. Code needs to be executed against the activation in order to clean it up, just letting it be garbage collected is not enough.  The current scheme was set up to be simple, only a single thread active in a connection at a single time, and to avoid the jvm deadlocks that wer seen when the activations were cleaned up directly in the finalize thread (since it breaks the simple rule, only a single thread active in a connection).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-08-21T18:18:00.000+0000","updated":"2006-08-21T18:18:00.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429668","id":"12429668","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"I tried the approach suggested by Dan in DERBY-1142, and my version of change looks like as below,\r\n\r\nIn GenericLanguageConnectionContext,\r\n\r\n\tpublic void addActivation(Activation a) {\r\n\t\tacts.addElement(a);\r\n\r\n+              try {\r\n+                  if (acts.size() > 20) {\r\n+                       resetActivations(false);\r\n+                   }\r\n+              } catch(StandardException e) {\r\n+              }\r\n+\r\n\t\tif (SanityManager.DEBUG) {\r\n\r\n\t\t\tif (SanityManager.DEBUG_ON(\"memoryLeakTrace\")) {\r\n\r\n\t\t\t\tif (acts.size() > 20)\r\n\t\t\t\t\tSystem.out.println(\"memoryLeakTrace:GenericLanguageContext:activations \" + acts.size());\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\r\nI thought it will be better to use the method resetActivations as it is meant to do the desired business for us. ( let me know if there are any negative implications of using this method here)\r\n\r\nThis approach did not solve the OOME but differed it for sometime. The effect of this change is equal to the effect of having singleUseActivation.close in the finalize method of EmbedRS, as suggested earlier.\r\n\r\nFurther, and importantly, I found that there still exist some Activation objects with inUse=true. I guess there is a synchronization issue here due to which EmbedRS.finalize is not called for all the objects, thus not marking them unused. On several runs, the worst case I found is that for 100 such select queries about 10% activation objects still stay on the heap. So, as the finalize method is not executed for many objects, the activation objects are not freed. Here, it is irrelevent if they are closed directly from within the finalize method or indirectly by first just marking them unused.\r\n\r\nI ran these tests on both jdk1.6 and jdk1.5.\r\n\r\nany thoughts on behaviour of finalizer thread in this context.\r\nany inputs on synchronizing the markunused operation ??","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2006-08-22T10:43:11.000+0000","updated":"2006-08-22T10:43:11.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429674","id":"12429674","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Hi Mayuresh,\r\n\r\nI'm afraid your fix has some unwanted consequences. First of all, the OutOfMemoryError is still there. Secondly, resetActivations() will also reset activations that are still open and in use. Take for instance this code:\r\n\r\n        c.setAutoCommit(false);\r\n        c.setHoldability(ResultSet.CLOSE_CURSORS_AT_COMMIT);\r\n        Statement[] ss = new Statement[21];\r\n        ResultSet[] rss = new ResultSet[ss.length];\r\n        for (int i = 0; i < ss.length; i++) {\r\n            ss[i] = c.createStatement();\r\n            rss[i] = ss[i].executeQuery(\"values 1\");\r\n        }\r\n        rss[0].next();\r\n\r\nWithout your changes, it runs successfully. With your fix applied, rss[0].next() fails with java.sql.SQLException: ResultSet not open. Operation 'next' not permitted. Verify that autocommit is OFF.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-08-22T11:31:54.000+0000","updated":"2006-08-22T11:31:54.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429709","id":"12429709","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"Thanks Knut for pointing that out.\r\n\r\nI did not mean to provide a patch for this JIRA, but just wanted to try out a suggested approach. \r\nI have corrected this error and now the trial piece of code looks like, \r\n\r\n    public void addActivation(Activation a) {\r\n        acts.addElement(a);\r\n        try {\r\n                if (acts.size() > 20) {\r\n\t\tfor (int i = acts.size() - 1; i >= 0; i--) {\r\n\t\t\tActivation a1 = (Activation) acts.elementAt(i);\r\n\r\n\t\t\tif (!a1.isInUse())\r\n\t\t\t{\r\n\t\t\t\ta1.close();\r\n                        }\r\n\r\n                } //for\r\n                }\r\n                } catch(StandardException e) {\r\n                }\r\n\r\n\t\tif (SanityManager.DEBUG) {\r\n\r\n\t\t\tif (SanityManager.DEBUG_ON(\"memoryLeakTrace\")) {\r\n\r\n\t\t\t\tif (acts.size() > 20)\r\n\t\t\t\t\tSystem.out.println(\"memoryLeakTrace:GenericLanguageContext:activations \" + acts.size());\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\nI have tried your code snippet with this along with the repro and did not see any regressions.\r\n\r\nHowever, the OOME is still seen. As mentioned in my earlier comment, the main issue seems to be with the Finalizer thread behaviour.\r\nI guess there are 2 parts to this issue. \r\n1. Make sure the inUse field is synchronized\r\n2. Close activation objects either directly from EmbedRS.finalize method or indirectly as per the change in GenLCC.addActivation method.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2006-08-22T13:50:34.000+0000","updated":"2006-08-22T13:50:34.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429712","id":"12429712","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Did you try to declare BaseActivation.inUse as volatile?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-08-22T14:13:58.000+0000","updated":"2006-08-22T14:13:58.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429721","id":"12429721","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"Any change must not ignore exceptions thrrown during an activation.close().\r\n\r\n                } catch(StandardException e) {\r\n                } \r\n\r\n-1 on any change that includes that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-08-22T14:28:30.000+0000","updated":"2006-08-22T14:28:30.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429725","id":"12429725","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Mayuresh, with your latest changes, I don't see the memory leak any more (neither DERBY-418 nor DERBY-1142).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-08-22T14:34:19.000+0000","updated":"2006-08-22T14:34:19.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12429997","id":"12429997","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"Thanks Knut,\r\n\r\nMaking BaseActivation.inUse volatile does solve the synchronization problem between the threads.\r\nI do not see OOME with the above change along with the fix suggested in previous comments.\r\n\r\nI have attached a patch now. I shall run derbyall with this change.\r\nI would appreciate if someone can take a look at the way the exception is handled in this patch and could point out if there is something that I am missing out.\r\n\r\nThanks\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2006-08-23T13:20:10.000+0000","updated":"2006-08-23T13:20:10.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12430028","id":"12430028","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"The change ignores the exception:\r\n\r\n+                } catch(StandardException e) {\r\n+                    StandardException.plainWrapException(e);\r\n+                }\r\n\r\nThat code just creates an exception (in the call to plainWrapException)  and then throws it away.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-08-23T15:36:01.000+0000","updated":"2006-08-23T15:36:01.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12430232","id":"12430232","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"posting another version of the patch here.\r\n\r\nI have corrected the catch block and now throwing the wrapped exception. This change has introduced some method declaration changes as well. Let me know if there are any concerns with this change.\r\n\r\nAlso, the added code block now checks if the acts size is more than 20 before closing the unused activations, this will save some cost of  identifying unused activations everytime the addActivation is called.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2006-08-24T12:50:13.000+0000","updated":"2006-08-24T12:50:13.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12430420","id":"12430420","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"+                } catch(StandardException e) {\r\n+                    throw StandardException.plainWrapException(e);\r\n+                }\r\n\r\nSince e already is a StandardException, there's no need to catch it and wrap it in a StandardException.\r\n\r\nIt would also be good if there were a comment in addActivation() explaining why we're iterating over the activations vector, and a comment in BaseActivation saying that inUse is declared volatile to ensure it is visible when it has been modified by the finalizer thread.\r\n\r\nHave you considered the option where you set a volatile flag in GenericLanguageConnectionContext from BaseActivation.markUnused() so that you don't have to scan the activations vectors when there is no unused activation? It would require adding a method to the LanguageConnectionContext interface (for instance notifyUnusedActivation), but I think it is worth it since it would remove the performance penalty that some (odd) applications could experience with the current patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-08-25T07:25:23.000+0000","updated":"2006-08-25T07:25:23.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12430454","id":"12430454","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"Thanks Knut for your suggestions.\r\n\r\nIterating over Activations vector only when we know that at least one activation is marked unused will save some cycles in case of non-singleUse activations. I have included another flag as you suggested and the patch is attached.\r\n\r\nThe fix also includes detailed comments and exception correction.\r\n\r\nI have started a derbyall testrun.\r\nLet me know if you have any further comments.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2006-08-25T09:08:22.000+0000","updated":"2006-08-25T09:08:22.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12430497","id":"12430497","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Two more comments, and I'll stop complaining. :)\r\n\r\n1. No need for a try/catch when the catch block only rethrows the exception:\r\n\r\ntry {\r\n    ....\r\n} catch (StandardException e) {\r\n    throw e;\r\n}\r\n\r\n2. In the Derby code, tabs are four characters wide. Apparently, your editor displays tabs as eight characters, so the indentation doesn't match the surrounding code when viewed in an editor which shows tabs as four characters. Please update your tab settings and reindent the changes.\r\n\r\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-08-25T13:09:47.000+0000","updated":"2006-08-25T13:09:47.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12430504","id":"12430504","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"Thanks knut and apologies for missing out on indentation guidelines.\r\n\r\nI have attached another patch integrating both the comments from Knut.\r\nComments welcome. :)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2006-08-25T13:34:52.000+0000","updated":"2006-08-25T13:34:52.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12430512","id":"12430512","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"I think your loop that closes activations needs to include similar logic to htis, from cleanupOnError\r\n\r\n\t\t\t\t// it maybe the case that a reset()/close() ends up closing\r\n\t\t\t\t// one or more activation leaving our index beyond\r\n\t\t\t\t// the end of the array\r\n\t\t\t\tif (i >= acts.size())\r\n\t\t\t\t\tcontinue;\r\n\r\n\r\nAlso there is a chance that you clear the unusedActs flag when you shouldn't. Basically if more activations are marked unused during the time you are closing the others then you will clear the flag when it should be kept set. The clearing of the flag should be before you process the loop.\r\n\r\nE.g. \r\n\r\n    if ( unusedActs )\r\n     {\r\n       unusedActs  = false;\r\n       close loop\r\n      }\r\n\r\nI would also remove the check for size() > 20, I think it's of no value once you have the unusedActs flag.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-08-25T14:07:58.000+0000","updated":"2006-08-25T14:07:58.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12430517","id":"12430517","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thank you for addressing my comments, Mayuresh!\r\n\r\nI think you misunderstood what I meant with the indentation (you're not the first one to have problems with this). The files you have changed use tabs to indent the code. The people who created the files used editors with tab stops at four characters. Since your editor has tab stops at eight characters, and you use space as indentation character, you end up indenting the code twice as much as the surrounding code.\r\n\r\nFor instance, BaseActivation.java has this diff:\r\n\r\n@@ -787,6 +791,7 @@\r\n \tpublic final void markUnused()\r\n \t{\r\n \t\tinUse = false;\r\n+                lcc.notifyUnusedActivation();\r\n \t}\r\n\r\nThe line with inUse = false is indented with two tabs, which should be equivalent to eight spaces. However, the line with lcc.notifyUnusedActivation() is indented with 16 spaces, whereas it should have been on the same indentation level as the previous line. This seems to be the case for all the changed lines.\r\n\r\nSolution: Change the tab settings in your editor and reduce the indentation level of the changed code. Since the surrounding code uses tabs, it would be preferable that the changes used tabs as well, but if you choose to use spaces, one tab character should match four spaces.\r\n\r\nI'm sorry that I didn't comment on this before, but mixing of tabs and spaces with incorrect tab width is one of those issues that you don't see when you inspect the patch, only after you have applied the patch and read the source in an editor.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-08-25T14:19:35.000+0000","updated":"2006-08-25T14:19:35.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12430982","id":"12430982","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"Thanks Dan for great suggestions.\r\n\r\nI have integrated your suggestions in this latest patch. Regarding the acts.size() > 20 clause, I think it could still be beneficial. With this clause, we can prevent the overhead of iterating through the entire activation vector everytime an activation is marked unused. Since this is a clean up activity, defering the close of unused activations by some time should not cause extra overhead for every such object. let me know if there is anything I am missing here. This clause is not removed in the latest patch.\r\n\r\nI have also reindentated the changed code and it should look fine now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2006-08-28T14:16:02.000+0000","updated":"2006-08-28T14:16:02.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12431148","id":"12431148","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks Mayuresh. I think the patch looks good. If there are no more comments, I will run some tests and commit the patch tomorrow.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-08-29T06:23:29.000+0000","updated":"2006-08-29T06:23:29.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12431170","id":"12431170","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"I have run derbyall on latest trunk with v5 patch, and found 2 failures as below,\r\n\r\nderbyall/derbynetmats/derbynetmats.fail:jdbcapi/blobclob4BLOB.java\r\nderbyall/derbyall.fail:tools/derbyrunjartest.java\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2006-08-29T08:29:16.000+0000","updated":"2006-08-29T08:29:16.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12431510","id":"12431510","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Derbyall ran cleanly. However, when running the repro for DERBY-1142 (without rs.close()), I noticed that markUnused() was often called twice for the same activation. This happens because both EmbedPreparedStatement and EmbedResultSet call markUnused() in their finalizers. I think it would be a good idea to wrap the body of markUnused() with \"if (isInUse()) { ... }\" to avoid false calls to lcc.notifyUnusedActivation().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-08-30T08:37:17.000+0000","updated":"2006-08-30T08:37:17.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12431519","id":"12431519","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"Thanks Knut, for catching that!\r\n\r\nI have attached a new patch with changes suggested by Knut, derby418_v6.diff.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2006-08-30T09:51:07.000+0000","updated":"2006-08-30T09:51:07.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12432127","id":"12432127","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thank you, Mayuresh! Committed v6 into trunk (rev 439279) and 10.2 (rev 439281).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-09-01T11:58:43.000+0000","updated":"2006-09-01T11:58:43.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12311840/comment/12864271","id":"12864271","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Closing issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2010-05-05T11:06:47.737+0000","updated":"2010-05-05T11:06:47.737+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-418/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06vyv:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12440111","self":"https://issues.apache.org/jira/rest/api/latest/issue/12440111","key":"CASSANDRA-533","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310865","id":"12310865","key":"CASSANDRA","name":"Cassandra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310865&avatarId=12034","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310865&avatarId=12034","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310865&avatarId=12034","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310865&avatarId=12034"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11961","id":"11961","description":"Apache Cassandra related projects","name":"Cassandra"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313862","id":"12313862","description":"","name":"0.4","archived":false,"released":true,"releaseDate":"2009-09-27"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314040","id":"12314040","description":"","name":"0.5","archived":false,"released":true,"releaseDate":"2010-01-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-11-07 23:22:44.572","customfield_12312322":null,"customfield_12312323":null,"customfield_12310222":"1_*:*_1_*:*_3173756_*|*_5_*:*_1_*:*_0","customfield_12310420":"19741","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2009-11-07T23:22:44.616+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-533/watchers","watchCount":0,"isWatching":false},"created":"2009-11-07T22:29:50.860+0000","customfield_10022":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12311124":null,"customfield_12312334":null,"customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tim+freeman","name":"tim freeman","emailAddress":"tim dot freeman at hp dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Freeman","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-11-07T23:22:44.607+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312978","id":"12312978","name":"Core"}],"timeoriginalestimate":null,"description":"When starting Cassandra on a Windows system, I intermittently see errors like:\r\n\r\nDEBUG - Expected bloom filter size : 2560\r\nDEBUG - collecting Generation:false:4@9\r\nDEBUG - collecting Token:false:16@0\r\nINFO - Saved Token found: 25027551081353517716727338628156823602\r\nERROR - Error in ThreadPoolExecutor\r\njava.util.concurrent.ExecutionException: java.io.IOException: Failed to delete LocationInfo-8-Index.db\r\n        at java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)\r\n        at java.util.concurrent.FutureTask.get(FutureTask.java:83)\r\n        at org.apache.cassandra.concurrent.DebuggableThreadPoolExecutor.afterExecute(DebuggableThreadPoolExecutor.java:8\r\n6)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:888)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\r\n        at java.lang.Thread.run(Thread.java:619)\r\nCaused by: java.io.IOException: Failed to delete LocationInfo-8-Index.db\r\n        at org.apache.cassandra.utils.FileUtils.deleteWithConfirm(FileUtils.java:55)\r\n        at org.apache.cassandra.io.SSTableReader.delete(SSTableReader.java:269)\r\n        at org.apache.cassandra.db.ColumnFamilyStore.doFileCompaction(ColumnFamilyStore.java:1145)\r\n        at org.apache.cassandra.db.ColumnFamilyStore.doCompaction(ColumnFamilyStore.java:686)\r\n        at org.apache.cassandra.db.MinorCompactionManager$1.call(MinorCompactionManager.java:166)\r\n        at org.apache.cassandra.db.MinorCompactionManager$1.call(MinorCompactionManager.java:163)\r\n        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)\r\n        at java.util.concurrent.FutureTask.run(FutureTask.java:138)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\r\n        ... 2 more\r\nDEBUG - Starting to listen on 127.0.0.1:7001\r\nDEBUG - Binding thrift service to localhost:9160\r\n\r\nThe problem here is that the files are not closed immediately after they are read, and on Windows you can't delete an open file.  In general, failing to close a file causes more subtle problems on a Unix system.  You can run out of file descriptors if files are opened faster than the garbage collector closes them, and you can run out of disk space if the total data in the opened-but-deleted files is enough to fill the disk.\r\n\r\nI see two places to fix, SSTableReader.loadIndexFile and SSTableReader.loadBloomFilter.  Here are revised definitions for those two methods:\r\n\r\n    private void loadBloomFilter() throws IOException\r\n    {\r\n        DataInputStream stream = new DataInputStream(new FileInputStream(filterFilename()));\r\n        try {\r\n        \tbf = BloomFilter.serializer().deserialize(stream);\r\n        } finally {\r\n        \tstream.close();\r\n        }\r\n    }\r\n\r\n    private void loadIndexFile() throws IOException\r\n    {\r\n        BufferedRandomAccessFile input = new BufferedRandomAccessFile(indexFilename(), \"r\");\r\n        try {\r\n        \tindexPositions = new ArrayList<KeyPosition>();\r\n\r\n        \tint i = 0;\r\n        \tlong indexSize = input.length();\r\n        \twhile (true)\r\n        \t{\r\n        \t\tlong indexPosition = input.getFilePointer();\r\n        \t\tif (indexPosition == indexSize)\r\n        \t\t{\r\n        \t\t\tbreak;\r\n        \t\t}\r\n        \t\tString decoratedKey = input.readUTF();\r\n        \t\tinput.readLong();\r\n        \t\tif (i++ % INDEX_INTERVAL == 0)\r\n        \t\t{\r\n        \t\t\tindexPositions.add(new KeyPosition(decoratedKey, indexPosition));\r\n        \t\t}\r\n        \t}\r\n        } finally {\r\n        \tinput.close();\r\n        }\r\n    }   \r\n\r\nI have not yet tested those changes, but they look desirable even if they don't fix the symptom I'm experiencing.  I did not search the code for other places that files are opened but not closed.\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"91352","summary":"Need to close files in loadBloomFilter and loadIndexFile","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tim+freeman","name":"tim freeman","emailAddress":"tim dot freeman at hp dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Freeman","active":true},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tim+freeman","name":"tim freeman","emailAddress":"tim dot freeman at hp dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Freeman","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"customfield_12311420":null,"customfield_12311421":null,"environment":"Vista, Cassandra 0.4.1","customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":2,"total":2,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12440111/comment/12774684","id":"12774684","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tim+freeman","name":"tim freeman","emailAddress":"tim dot freeman at hp dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Freeman","active":true},"body":"The fix did get rid of the stacktrace","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tim+freeman","name":"tim freeman","emailAddress":"tim dot freeman at hp dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Freeman","active":true},"created":"2009-11-07T22:47:18.837+0000","updated":"2009-11-07T22:47:18.837+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12440111/comment/12774686","id":"12774686","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"committed to 0.4 branch; will merge to trunk","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-11-07T23:22:44.572+0000","updated":"2009-11-07T23:22:44.572+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-533/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0fzin:"}}
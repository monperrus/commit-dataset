{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12327153","self":"https://issues.apache.org/jira/rest/api/latest/issue/12327153","key":"DERBY-787","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-01-06 17:51:07.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22147","customfield_12310222":"3_*:*_1_*:*_1114758000_*|*_1_*:*_1_*:*_6886393000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_521159000_*|*_4_*:*_1_*:*_1097000","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-04-11T17:10:50.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-787/watchers","watchCount":0,"isWatching":false},"created":"2006-01-03T01:34:03.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12310615","id":"12310615","description":"","name":"10.1.2.1","archived":false,"released":true,"releaseDate":"2005-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-04-11T17:10:50.000+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"I was writing some tests for the Scrollable updatable ResultSet feature, and  found some tests failing with \n\nERROR XCL07: Cursor 'SQLCUR0' is closed. Verify that autocommit is OFF.\n\nin ResultSet.updateRow(). \n\nThe test does the following:\n1. set up a connection, and run a query which selects one tuple\n2. update the tuple using updateXXX and updateRow\n3. rollback the transaction and close the connection\n\nThen, repeat the process, however this time use a different string in the query.  This time updateRow() may fail with the error above. \n\nThe problem has been reproduced on forward only, updatable resultsets.\n\nWorkaround:\nIt does not seem to fail if I\na, set another cursorname on the statement object,\nb, use the same query string.\n\nI will attach the program to reproduce the problem. Below is the output:\n\n~:/<3>db-derby-10.1.2.1-bin/lib> java -cp /home/ak136785/devel/derbytesting/derbytest/build/classes/:derby.jar derbytest.CursorIsClosedIssue\n\n1,1,19,Tuple 1\n2,2,21,Tuple 2\nERROR XCL07: Cursor 'SQLCUR0' is closed. Verify that autocommit is OFF.\n        at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)\n        at org.apache.derby.impl.sql.execute.CurrentOfResultSet.getCursor(Unknown Source)\n        at org.apache.derby.impl.sql.execute.CurrentOfResultSet.openCore(Unknown Source)\n        at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.openCore(Unknown Source)\n        at org.apache.derby.impl.sql.execute.NormalizeResultSet.openCore(Unknown Source)\n        at org.apache.derby.impl.sql.execute.UpdateResultSet.setup(Unknown Source)\n        at org.apache.derby.impl.sql.execute.UpdateResultSet.open(Unknown Source)\n        at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)\n        at org.apache.derby.impl.jdbc.EmbedResultSet.updateRow(Unknown Source)\n        at derbytest.CursorIsClosedIssue.runTest(CursorIsClosedIssue.java:80)\n        at derbytest.CursorIsClosedIssue.main(CursorIsClosedIssue.java:103)\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40755","summary":"cursor closed as a sideeffect of closing another cursor with the same name on another connection","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10102","value":"Patch Available","id":"10102"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Java 1.4","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":5,"total":5,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327153/comment/12361952","id":"12361952","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"What is is happening here is that the updateRow operation generates\r\nidentical \"UPDATE .. WHERE CURRENT OF SQLCUR0\" statements for the two\r\nconnections.\r\n\r\nThe statement cache contains a compiled plan (from connection one),\r\nwhen connection two tries to do the updateRow, resulting in using the\r\nwrong plan (which refers to the result set of the first connection,\r\nwhich happens to be closed when connection two tries to do its\r\nupdateRow).\r\n\r\nI have checked the ISO wording about cursors, and from what I can\r\nunderstand, cursor names should be scoped locally to a connection, but\r\nI cannot find any logic in the compiler statement caching to handle\r\nthis.\r\n\r\nA partial solution might possibly be to generate cursor names which\r\nare unique per connection for the updatable cursor case, but that\r\nwould seem to be just side-stepping the issue. If the user sets the\r\ncursor name explicitly (JDBC Statement#setCursorName) to the same name\r\nin several connections, the scenario would still fail.\r\n\r\nI guess one could make the compiler *not* cache statements involving\r\ncursors (similar to what is done for statements referring temporary\r\ntables), but that would force recompilation at every execution of an\r\n{update,delete}Row, which is undesirable as well.\r\n\r\nA possibly better approach would be to have the compiler distinguish\r\nthe two similar looking statements when it compares them during the\r\ncache lookup operation, by extending the recorded information so that\r\na comparison would only match - when the statement contains a cursor -\r\nif the cached plan refers a cursor from the current connection.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2006-01-06T17:51:07.000+0000","updated":"2006-01-06T17:51:07.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327153/comment/12362001","id":"12362001","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I think Andreas (as part of derby-231 \"FOR UPDATE\" required for updatable result set to work) enhanced the information used during cache lookup to differentiate between readonly select statement against updatable select statement. Something like that might need to be done to associate a statement with cursor to the right connection.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2006-01-07T05:38:05.000+0000","updated":"2006-01-07T05:38:05.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327153/comment/12371420","id":"12371420","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"body":"I think I have found what caused this issue.\r\n\r\nThe \"UPDATE WHERE CURRENT OF SQLCUR0\" is prepared and compiled and produces an Activation (generated code) which can be reused by other connections, since the compiled code is cached.\r\n\r\nThe generated code keeps a cursor name and it will during execution look up a CursorActivation based on the cursor name. \r\nThe CursorActivation is the code for the cursor (the select statement).\r\nDuring execution, the class CurrentOfResultSet has a method called getCursor(). It finds the CursorActivation for the LanguageConnectionContext, however it has a check that the prepared statement object for the CursorActivation is the same as it was whem first compiling \"UPDATE WHERE ..\".  This will only be the case if it was the same statement string which produced the cursors.\r\n\r\nHere is some debug of the LanguageConnectionContext.lookupCursorActivation(..)\r\n1st connection:\r\n(XID = 562), (SESSIONID = 1), (DATABASE = cis), (DRDAID = null), [BaseActivation: Source: select * from t1 where a=1 FOR UPDATE, ObjectName =582f8014-010a-21d6-1c29-00000016c7a0, BaseActivation: Source: UPDATE \"APP\".\"T1\" SET \"A\"=?,\"B\"=? WHERE CURRENT OF \"SQLCUR0\", ObjectName =6839c016-010a-21d6-1c29-00000016c7a0]\r\n\r\n2nd connection:\r\n(XID = 566), (SESSIONID = 2), (DATABASE = cis), (DRDAID = null), [BaseActivation: Source: select * from t1 where a=2 FOR UPDATE, ObjectName =e03f4017-010a-21d6-1c29-00000016c7a0, BaseActivation: Source: UPDATE \"APP\".\"T1\" SET \"A\"=?,\"B\"=? WHERE CURRENT OF \"SQLCUR0\", ObjectName =6839c016-010a-21d6-1c29-00000016c7a0]\r\n\r\nAs you can see, the Connections do not share the CursorActivation code.\r\n\r\nFixing this issue could be to remove the check that the prepared statement objectname for the cursor is the same.  \r\nIf anyone knows a case were this would be incorrect, please let me know. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"created":"2006-03-22T21:24:36.000+0000","updated":"2006-03-22T21:24:36.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327153/comment/12371541","id":"12371541","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"body":"Attaching the patch for this issue. Removing the check that \"UPDATE .. WHERE CURRENT OF ..\" only can execute against the cursors which comes from the same prepared statement as it was origianlly compiled with.\r\n\r\nTesting: Removed the workaround in the SURTests which were added due to this bug. All SURTest will then use the same cursor name, and we will hit this bug if only the testing changes are applied. With the patch, everything works fine.  Also the repro program successfully runs with this patch.\r\n\r\nRan derbyall, and got two failures. In one of the tests, the network server threw a java.net.SocketException: Connection reset exception when shutting down. The other failure is a known regression. These failures are not relevant for this patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"created":"2006-03-23T18:26:12.000+0000","updated":"2006-03-23T18:26:12.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12327153/comment/12373243","id":"12373243","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bernt","name":"bernt","emailAddress":"bernt at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bernt M. Johnsen","active":true},"body":"Committed revision 391559.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bernt","name":"bernt","emailAddress":"bernt at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bernt M. Johnsen","active":true},"created":"2006-04-05T16:06:34.000+0000","updated":"2006-04-05T16:06:34.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-787/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i07c9z:"}}
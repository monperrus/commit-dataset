{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12391990","self":"https://issues.apache.org/jira/rest/api/latest/issue/12391990","key":"DERBY-3561","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313401","id":"12313401","description":"Head of 10.4 branch","name":"10.4.2.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2008-03-27 15:20:41.121","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23713","customfield_12310222":"1_*:*_1_*:*_1181528608_*|*_5_*:*_2_*:*_12530450819_*|*_4_*:*_1_*:*_89021275","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-08-27T12:45:37.154+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3561/watchers","watchCount":1,"isWatching":false},"created":"2008-03-20T19:08:56.452+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12336184","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12336184","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12491791","key":"DERBY-4925","self":"https://issues.apache.org/jira/rest/api/2/issue/12491791","fields":{"summary":"AssertionFailedError: DerbyMBeanCount:5 in ManagementMBeanTest.testStartStopManagementFromApplication()","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"New"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12326375","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12326375","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12433427","key":"DERBY-4356","self":"https://issues.apache.org/jira/rest/api/2/issue/12433427","fields":{"summary":"testStartStopManagementFromApplication(org.apache.derbyTesting.functionTests.tests.management.ManagementMBeanTest)junit.framework.AssertionFailedError: expected:<2> but was:<%>","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-01-21T17:51:48.570+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312171","id":"12312171","name":"JMX","description":"Management issues for Derby using the JMX framework"},{"self":"https://issues.apache.org/jira/rest/api/2/component/11413","id":"11413","name":"Test"}],"timeoriginalestimate":null,"description":"The following test has been failing consistently in the tinderbox runs since about build 636714, unfortunately the run right before this build  failed so\nit may be from that one. \nfirst tinderbox failure I could find:\nhttp://dbtg.thresher.com/derby/test/tinderbox_trunk16/jvm1.6/testing/testlog/SunOS-5.10_i86pc-i386/636714-org.apache.derbyTesting.functionTests.suites.All_diff.txt\nmost recent as of this report:\nhttp://dbtg.thresher.com/derby/test/tinderbox_trunk16/jvm1.6/testing/testlog/SunOS-5.10_i86pc-i386/639156-org.apache.derbyTesting.functionTests.suites.All_diff.txt\n\nThere was 1 failure:\n1) testStartStopManagementFromApplication(org.apache.derbyTesting.functionTests.tests.management.ManagementMBeanTest)junit.framework.AssertionFailedError: expected:<2> but was:<5>\n\tat org.apache.derbyTesting.functionTests.tests.management.ManagementMBeanTest.startStopManagement(ManagementMBeanTest.java:86)\n\tat org.apache.derbyTesting.functionTests.tests.management.ManagementMBeanTest.testStartStopManagementFromApplication(ManagementMBeanTest.java:56)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:101)\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:21)\n\tat junit.extensions.TestSetup.run(TestSetup.java:25)\n\tat org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:21)\n\tat junit.extensions.TestSetup.run(TestSetup.java:25)\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:21)\n\tat junit.extensions.TestSetup.run(TestSetup.java:25)\n\tat org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10369","value":"Regression Test Failure","id":"10369"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37302","summary":"testStartStopManagementFromApplication(org.apache.derbyTesting.functionTests.tests.management.ManagementMBeanTest)junit.framework.AssertionFailedError: expected:<2> but was:<5>","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":23,"total":23,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12582686","id":"12582686","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"I am only able to reproduce this failure when running suites.All, or a subset of it, before running the ManagementMBeanTest. Running the management suite by itself does not result in a failure. \r\n\r\nIt seems to me that when connecting directly to the platform MBean server in the same JVM, there is a set of MBeans from a different Derby system available, as indicated by the extra debugging output I added:\r\n\r\ninitial: org.apache.derby:type=Management\r\ninitial: org.apache.derby:system=c013800d-0118-f0c9-77c9-00004d1fe320,type=Management\r\ninitial: org.apache.derby:jar=derby.jar,system=c013800d-0118-f0c9-9143-00004d1fe320,type=Version\r\ninitial: org.apache.derby:system=c013800d-0118-f0c9-77c9-00004d1fe320,type=JDBC\r\ninitial: org.apache.derby:system=c013800d-0118-f0c9-9143-00004d1fe320,type=JDBC\r\ninitial: org.apache.derby:jar=derbynet.jar,system=c013800d-0118-f0c9-9143-00004d1fe320,type=Version\r\ninitial: org.apache.derby:jar=derby.jar,system=c013800d-0118-f0c9-77c9-00004d1fe320,type=Version\r\ninitial: org.apache.derby:system=c013800d-0118-f0c9-9143-00004d1fe320,type=NetworkServer\r\ninitial: org.apache.derby:system=c013800d-0118-f0c9-9143-00004d1fe320,type=Management\r\nDerbyMBeanCount after no-op startMgmt: 9\r\nDerbyMBeanCount after stop: 5\r\nafter stop: org.apache.derby:type=Management\r\nafter stop: org.apache.derby:jar=derby.jar,system=c013800d-0118-f0c9-77c9-00004d1fe320,type=Version\r\nafter stop: org.apache.derby:system=c013800d-0118-f0c9-77c9-00004d1fe320,type=Management\r\nafter stop: org.apache.derby:system=c013800d-0118-f0c9-77c9-00004d1fe320,type=JDBC\r\nafter stop: org.apache.derby:system=c013800d-0118-f0c9-9143-00004d1fe320,type=Management\r\ntestStartStopManagementFromApplication used 24 ms F\r\n\r\nI have reduced the number of tests needed to reproduce the failure to a suite consisting of:\r\n\r\nsuite.addTest(org.apache.derbyTesting.functionTests.tests.derbynet.NSinSameJVMTest.suite());\r\nsuite.addTest(org.apache.derbyTesting.functionTests.tests.derbynet.ServerPropertiesTest.suite());\r\nsuite.addTest(org.apache.derbyTesting.functionTests.tests.management.ManagementMBeanTest.suite());\r\n\r\nin that specific order. Looking closer at those tests might reveal something.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-03-27T15:20:41.121+0000","updated":"2008-03-27T15:20:41.121+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12583039","id":"12583039","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"Assgned this to myself since I am spending some time looking into the issue.\r\n\r\nAt first I was pussled by the fact that MBeans from two different Derby systems were available at the same time in the same JVM. As far as I know neither NSinSameJVMTest nor ServerPropertiesTest perform any class loading tricks for this to happen.\r\n\r\nMultiple trial/error runs eventually led me to the following clue, which I hope might lead to a solution:\r\n\r\nIt seems that there is only one Derby system active when the test starts, but three MBeans from an old Derby system are still present, as they have not been unregistered from the MBeanServer (I guess the MBeanServer is the same for all test runs in the same JVM). These three MBeans are: JDBC, Management and Version for derby.jar. This might be because the other mbeans (NetworkServer, Version for derbynet.jar) were successfully unregistered as part of a NetworkServerControl.shutdown() call in a previous test.\r\n\r\nThen I discovered that if I added an \"unregister\" MBeanPermission for derby.jar in the special security policy file for ServerPropertiesTest (java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/ServerPropertiesTest.policy), the test does not fail anymore (at least in my minimal test runs).\r\n\r\nI will do some more testing, but I thought I'd share my progress so far, in case anyone comes up with any better explanations.\r\nA solution seems to be to add the mentioned MBeanPermission to the special ServerPropertiesTest.policy file, but other suggestions are welcome.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-03-28T14:09:17.605+0000","updated":"2008-03-28T14:09:17.605+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12583131","id":"12583131","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"Attaching patch d3561_testPolicyFix.diff which adds the permission\r\n\r\npermission javax.management.MBeanPermission \"org.apache.derby.*#[org.apache.derby:*]\",\"unregisterMBean\"; \r\n\r\nto the test policy file used by derbynet.ServerPropertiesTest.\r\n\r\nI have run suites.All with this patch using JDK 1.5, and saw no failures whatsoever.\r\n\r\nIt would be great if someone else could try the patch in another environment and see if it gets rid of the test failure there as well. Or a committer with sufficient faith in the patch can just commit it ;)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-03-28T18:32:30.105+0000","updated":"2008-03-28T18:32:30.105+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12583154","id":"12583154","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Hi John,\r\nDo you know why the tests that need the permission don't fail when they don't have it? Shouldn't they fail when they are not able to unregister the MBeans?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-03-28T19:16:00.238+0000","updated":"2008-03-28T19:16:00.238+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12583223","id":"12583223","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"No, if I understand your question correctly, the tests that lack the permission (in ServerPropertiesTest) are not aware that there is any JMX or MBeans in play at all, so they should not fail, because they are not testing it. This issue is (as I understand it) a side-effect of DERBY-3429, that the JMX features are enabled by default when using a good enough JVM. The JMX tests themselves use a different server policy (a default one), with all the required permissions, while the ServerPropertiesTest tests use a special policy (for various reasons) that did not include these permissions.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-03-28T22:46:19.753+0000","updated":"2008-03-28T22:46:19.753+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12583225","id":"12583225","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"Let me add that I'm not entirely on top of all hows an whys wrt. the security manager and JMX, but it seems that any lack of permissions is just silently ignored by default at runtime.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-03-28T22:49:34.851+0000","updated":"2008-03-28T22:49:34.851+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12583228","id":"12583228","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Does this mean that users that use a custom policy file, but don't use \r\nJMX, need to change their policy file?\r\n\r\n\r\nKathey\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-03-28T23:05:24.329+0000","updated":"2008-03-28T23:05:24.329+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12583271","id":"12583271","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"> Does this mean that users that use a custom policy file, but don't use JMX, need to change their policy file?\r\n\r\nNo. Derby will not be able to register MBeans and that is not a problem. If registering an Mbean fails then Derby doesn't care.\r\nThis allows fine grained control of which MBeans derby will expose.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2008-03-29T04:16:05.211+0000","updated":"2008-03-29T04:16:05.211+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12583300","id":"12583300","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"I suspect that the reason those \"extra\" MBeans were registered in the first place might be that a Derby system was started while using the default security policy (or none at all), and that the policy had changed at shutdown time. I will try to make an effort to understand this a little better next week.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-03-29T09:49:26.685+0000","updated":"2008-03-29T09:49:26.685+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12584155","id":"12584155","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"I have done some more experimenting, and here is a writeup of my current \r\nunderstanding of this issue:\r\n\r\nAs previously mentioned, I have narrowed down the test suite leading to \r\nthis failure to the following (test order is significant):\r\n\r\n    - derbynet.NSinSameJVMTest.suite()\r\n    - derbynet.ServerPropertiesTest.suite()\r\n    - management.ManagementMBeanTest.suite()\r\n\r\nI have attached the minimal JUnit test suite (new java testclass) required\r\nto reproduce this failure as a diff file against trunk: \r\nDerby3561ReproSuite_notForCommit.diff (not for commit)\r\n\r\nSome points to be aware of:\r\n\r\n - Starting a Derby system in a 1.5 or 1.6 VM automatically results in\r\n   3 MBeans being registered. (If a security manager is installed,\r\n   sufficient permissions must be granted to Derby). Stopping the Derby\r\n   system means that the entire collection of Derby MBeans will be \r\n   attempted unregistered from the MBean server.\r\n\r\n - Starting the Derby Network Server in a 1.5 or 1.6 VM automatically \r\n   results in 2 extra MBeans being registered, specific to the network \r\n   server. (If a security manager is installed, sufficient permissions must\r\n   be granted to Derby). Stopping the network server unregisters these\r\n   MBeans.\r\n\r\n - Starting the network server results in starting a Derby system, if such\r\n   a system is not already running in the JVM. Stopping the network server\r\n   using the NetworkServerControl API does *not* also shut down the Derby\r\n   system (by design, I presume).\r\n\r\n - Stopping/deactivating Derby management using the ManagementMBean means\r\n   that all Derby MBeans that are registered with both the MBean server\r\n   and Derby's management service will be unregistered from the MBean \r\n   server, with the exception of any ManagementMBeans (which may be used to\r\n   re-register the other MBeans).\r\n\r\n\r\nThe sequence of events leading to the test failure is:\r\n\r\n1. NSinSameJVMTest (could also be some other test which does similar things):\r\n\r\n     - A clientServer decorator starts a new network server and thus also\r\n       a Derby system (\"system A\") using the NetworkServerControl API (same \r\n       JVM).\r\n       - Security policy used: functionTests/util/derby_tests.policy\r\n         - Includes permissions to register and unregister MBeans, etc.\r\n\r\n       ==> 5 MBeans from system A are automatically registered with the \r\n           JVM's MBean server. The test doesn't know and doesn't care.\r\n\r\n     - The network server is shut down using the same API, and the same\r\n       security policy.\r\n\r\n       ==> 2 MBeans (VersionMBean;derbynet.jar + NetworkServerMBean) from\r\n           system A are automatically unregistered. \r\n\r\n      - The remaining 3 MBeans (JDBCMBean + ManagementMBean + \r\n        VersionMBean;derby.jar) are not network server specific and will \r\n        therefore remain registered until the Derby system shuts down, or\r\n        until some manual intervention is performed.\r\n        Neither the test nor the test harness shuts down the Derby system.\r\n\r\n2. ServerPropertiesTest\r\n\r\n     - Derby system A is still running...\r\n\r\n     - is wrapped in a decorator which changes the security policy from the\r\n       default to a specific one: derbynet/ServerPropertiesTest.policy.\r\n       - No JMX permissions are included in this policy.\r\n\r\n       ==> No new MBeans are registered when the test starts its own network\r\n           servers/systems, due to lack of permissions (no exceptions are \r\n           thrown; this is by design). The test is unaware and does not care.\r\n\r\n     - ttestSetPortPriority() method starts and stops Network Servers, and\r\n       (more importantly) it shuts down the current Derby system (twice)\r\n       during the test (for some static properties to take effect). System A\r\n       has now been shut down.\r\n       - Since the test does not have permissions to unregister any MBeans,\r\n         the three MBeans from system A will remain registered with the\r\n         MBean server. The test doesn't know and doesn't care.\r\n\r\n3. ManagementMBeanTest\r\n\r\n     - testStartStopManagementFromApplication() test and method \r\n       startStopManagement(ObjectName mbean) is run twice:\r\n       - once using a direct connection to the platform MBean server in the\r\n         same JVM as the test. This fails.\r\n       - once using a JMX client connection to a \"remote\" MBean server /\r\n         network server (different JVM). This passes.\r\n\r\n     - the decorator for the failing test starts a Derby Network Server in \r\n       the same JVM, to ensure that all MBeans are automatically registered.\r\n       Let's call the Derby system being used \"system B\".\r\n       - The policy file used is functionTests/util/derby_tests.policy,\r\n         including permissions to register MBeans etc.\r\n\r\n       ==> 5 MBeans from system B are automatically registered with the \r\n           JVM's MBean server. This is what the test expects.\r\n     \r\n     - The test registers an extra MBean: An application controlled \r\n       ManagementMBean, which is used for starting and stopping Derby \r\n       management.\r\n\r\n     - The test counts the number of MBeans in the org.apache.derby domain\r\n       several times.\r\n\r\n     - After stopping management, the test expects to see exactly 2 MBeans:\r\n       The ManagementMBean controlled by the application/test, and the \r\n       ManagementMBean that was automatically registered/created by Derby.\r\n\r\n     - However, the 3 MBeans from system A still remain registered with the\r\n       MBean server, although these MBeans are not registered with the \r\n       current Derby management service (different system, different \r\n       management service).\r\n\r\n     - The test sees 3 + 2 = 5 MBeans, but expects to see 2. The test fails.\r\n\r\n\r\nUser impact:\r\n------------------\r\n\r\nIn my opinion, it is not very likely that a user will experience such a\r\nscenario, as it requires modifying (restricting) or installing a security \r\npolicy at runtime and booting and shutting down Derby systems at the right \r\n(wrong) moments.\r\n\r\nIf a user should run into this, nothing bad can happen as far as I can see.\r\nThe user may observere MBeans belonging to a non-active Derby system, even \r\nif Derby's management service is deactivated, but that is basically it. \r\n\r\nBy using JConsole and a standalone test class (attached) I see that the old \r\nMBeans are available and may be accessed, and most attributes still have the \r\nsame values, although the SystemIdentifier (ManagementMBean) is empty and \r\nManagementActive will always remain false. The startManagement operation of\r\nan old ManagementMBean does not change anything, but it does not report an\r\nerror either.\r\n\r\nYou can reproduce this outside of JUnit by using the attached class\r\nDerby3561ReproStandalone.java (see code comments).\r\n\r\n\r\nSolutions:\r\n-----------------\r\n\r\nIf we are concerned about this, an alternative solution could have been for\r\nthe Derby management service to unregister not only MBeans registered with \r\nitself, but also any other MBeans belonging to the derby domain. However, \r\nthis seems to defeat the purpose of the system identifier and DERBY-3466.\r\n\r\nBased on this, I believe adding a permission allowing the \r\nServerPropertiesTest to unregister Derby MBeans is a solution that makes \r\nsense in order to get this test to pass. Such a change is implemented by\r\nthe patch d3561_testPolicyFix.diff.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-04-01T14:34:53.651+0000","updated":"2008-04-01T14:34:53.651+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12584571","id":"12584571","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"Patch for fixing this issue by adding a permission to a test policy file is \r\nstill available for review/commit.\r\n\r\nIf some alternative solution is desired, please let me know.\r\n\r\n\r\nOne alternative would be to somehow make this specific test more robust \r\nagainst such issues (old MBeans left behind by previous tests/systems). \r\n\r\nHowever, it seems hard to make the test robust without also testing less,\r\ne.g. not caring so much about exactly what is left behind after the\r\n\"stopManagement\" operation is invoked.\r\n\r\nFor example, the set of MBeans left registered with the MBean server after\r\ninvoking \"stopManagement\" may be something like:\r\n\r\ncurrent:  org.apache.derby:type=Management\r\nold:         org.apache.derby:system=c013800d-0119-0f15-4c02-00006a7eac81,type=Management\r\nold:         org.apache.derby:jar=derby.jar,system=c013800d-0119-0f15-4c02-00006a7eac81,type=Version\r\nold:         org.apache.derby:type=OldDerbySysManagement\r\ncurrent:  org.apache.derby:system=c013800d-0119-0f15-68af-00006a7eac81,type=Management\r\nold:         org.apache.derby:system=c013800d-0119-0f15-4c02-00006a7eac81,type=JDBC\r\n\r\nThe current test expects the number of MBeans to be 2 (those above marked \r\nwith \"current\") and that these MBeans have type \"Management\".\r\n\r\nI suppose we could change the  test so that it expects n - x MBeans, where\r\nn is the number of registered MBeans at test start, and x is the number of\r\nMBeans (belonging to the current Derby system) that we expect to be \r\nunregistered when \"stopManagement\" is invoked. Currently x = 4.\r\n\r\nWe could also check that there is no MBean registered with the same system \r\nkey property as the current system, apart from the Derby-registered \r\nManagementMBean itself.\r\n\r\nNot so elegant, I guess, but probably more robust. I can try to make a \r\npatch for this if it sounds interesting to anyone. For 10.4.1, though, I think this\r\nis overkill (the policy fix should suffice). Such a solution could also be \r\ncombined with the test policy fix.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-04-02T14:02:20.506+0000","updated":"2008-04-02T14:02:20.506+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12584999","id":"12584999","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"This seems to fail pretty consistently on the 10.4 branch as well, and will produce some noise in the release candidate test results unless a fix is committed pretty soon. One suggested fix is available as a patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-04-03T07:41:25.982+0000","updated":"2008-04-03T07:41:25.982+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12585034","id":"12585034","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I don't know enough about this issue to say if it is the best way to fix it, but I checked in the patch to reduce the noise from the test.\r\n\r\nCommitted to trunk with revision 644248.\r\nCommitted to 10.4 with revision 644250.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-03T10:05:48.220+0000","updated":"2008-04-03T10:05:48.220+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12585035","id":"12585035","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vemund","name":"vemund","emailAddress":"vemund at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vemund Østgaard","active":true},"body":"Good job tracking down the root cause for this, John.\r\n\r\nI think your patch is a sensible way to get the tests to pass.\r\n\r\nOn a side note, if tests have certain preconditions to be able to behave as intended, it might be sensible to check for these at the start of the test. So, the test that has been failing could check that there are in fact 0 MBeans registered at the start of the test, and just throw an exception if there aren't, since this is obviously a precondition the way the test is written.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vemund","name":"vemund","emailAddress":"vemund at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vemund Østgaard","active":true},"created":"2008-04-03T10:15:58.867+0000","updated":"2008-04-03T10:15:58.867+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12585040","id":"12585040","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"Thanks, Knut. Further test stabilization or perhaps even product changes should be considered if this or similar issues reappear often, but I think this is sufficient for 10.4.1 at least.\r\n\r\nVemund: We could certainly consider doing something about checking that preconditions are satisfied at test start. Though if preconditions are not as expected and we throw an exception then we would still get the same noise in the test results (for a while, at least). To be able to handle varying preconditions, a bit more logic would have to be added to the test code and/or setup (and I think that is too risky to do for 10.4 at this moment).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-04-03T10:31:07.507+0000","updated":"2008-04-03T10:31:07.507+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12585050","id":"12585050","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"Marking this issue as fixed, as a fix has been committed to both trunk and 10.4 branch. I intend to close the issue after a couple of days if the failure disappears from daily test reports - further comments/suggestions are still welcome, though. \r\nShould probably create a new issue for making the ManagementMBeanTest more robust.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-04-03T11:21:04.988+0000","updated":"2008-04-03T11:21:04.988+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12585066","id":"12585066","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vemund","name":"vemund","emailAddress":"vemund at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vemund Østgaard","active":true},"body":"Yes, my thoughts on preconditions was mostly in general for all tests. It makes it a bit easier to track down issues if preconditions are verified at the start of a test. It won't remove noise, but for a test that fails maybe just once in a while and is difficult to reproduce it would give insight into whether the problem is related to something that happened before or during the test.\r\n\r\nI think it requires some thought when deciding if a test should throw an exception if something is not as expected at the start of the test, or silently adapt to the change in behavior. It is important not to mask what potentially is a bug, but at the same time you don't want unnecessary noise.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vemund","name":"vemund","emailAddress":"vemund at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vemund Østgaard","active":true},"created":"2008-04-03T11:55:34.044+0000","updated":"2008-04-03T11:55:34.044+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12625708","id":"12625708","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"Reopening to fix this issue also when running with classes directory in classpath. This issue was recently seen with such a configuration in the 10.4 branch after fixing DERBY-3836.\r\nThis issue is no longer seen when running with jars in the classpath.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-08-26T12:01:55.842+0000","updated":"2008-08-26T12:01:55.842+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12625733","id":"12625733","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"Attached patch d3561_classesFix.diff which is supposed to fix this issue also when running with classes directory instead of jars in the classpath. The fix is simply to add the same \"unregister\" permission to the \"classes\" domain in ServerPropertiesTest.policy as was added to the \"derby.jar\" domain in revision 644248.\r\n\r\nsuites.All passed cleanly in 10.4 branch (classes and jars), running against trunk now. I intend to commit to trunk and 10.4 shortly, barring any failing test runs.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-08-26T13:43:03.305+0000","updated":"2008-08-26T13:43:03.305+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12626094","id":"12626094","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"suites.All tests passed successfully with classes and jars on both trunk and 10.4 (JDK 1.5, Solaris 10 x86).\r\n\r\nCommitted d3561_classesFix.diff as revisions 689460 (trunk) and 689462 (10.4 branch).\r\nHopefully this issue is fully resolved this time.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-08-27T12:45:37.054+0000","updated":"2008-08-27T12:45:37.054+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12628253","id":"12628253","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"body":"Adjusted \"Fixed in\" version. Latest fix for classes policy did not make it into the 10.4.2.0 RC (revision 689064).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnemb","name":"johnemb","emailAddress":"johnemb at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John H. Embretsen","active":true},"created":"2008-09-04T06:04:51.108+0000","updated":"2008-09-04T06:13:12.164+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12637077","id":"12637077","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=olesolberg","name":"olesolberg","emailAddress":"Ole dot Solberg at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ole Solberg","active":true},"body":"Another variant?:  \r\ntestStartStopManagementFromApplication(org.apache.derbyTesting.functionTests.tests.management.ManagementMBeanTest)junit.framework.AssertionFailedError: expected:<4> but was:<6>\r\n\r\nhttp://dbtg.thresher.com/derby/test/10.4Branch/jvm1.6/testing/testlog/lin/701824-suitesAll_diff.txt\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=olesolberg","name":"olesolberg","emailAddress":"Ole dot Solberg at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ole Solberg","active":true},"created":"2008-10-06T11:10:13.812+0000","updated":"2008-10-06T11:10:13.812+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12391990/comment/12740759","id":"12740759","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"body":"I have just seen this issue on the 10.5 branch. Rick seems to have hit it as well as it can be seen on DERBY-4344.\r\n\r\nShould we reopen this issue?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espinha","name":"espinha","emailAddress":"tiago dot derby at espinhas dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tiago R. Espinha","active":true},"created":"2009-08-07T21:47:59.895+0000","updated":"2009-08-07T21:47:59.895+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3561/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06qyn:"}}
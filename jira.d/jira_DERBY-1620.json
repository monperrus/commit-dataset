{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12347067","self":"https://issues.apache.org/jira/rest/api/latest/issue/12347067","key":"DERBY-1620","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-08-01 16:47:02.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22603","customfield_12310222":"1_*:*_1_*:*_26725075536_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_67074332","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2007-06-06T22:31:19.536+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1620/watchers","watchCount":3,"isWatching":false},"created":"2006-08-01T14:53:24.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"11.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12318570","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12318570","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12384682","key":"DERBY-3277","self":"https://issues.apache.org/jira/rest/api/2/issue/12384682","fields":{"summary":"CREATE TABLE Test (n BIGINT);SELECT CASE WHEN n > -1 THEN n END FROM Test; FAILS","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12317008","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12317008","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12375181","key":"DERBY-2986","self":"https://issues.apache.org/jira/rest/api/2/issue/12375181","fields":{"summary":"Query involving CASE statement significantly slower in 10.3.1.4 than in 10.2.2.0","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-12-16T19:56:46.439+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"This bug appears to be related to the DERBY-7 bug (NULLIF() function).   When NULL is used during a CASE statement, Derby requires the NULL to be CAST to the appropriate type.  This does not appear to meet the SQL 2003 Standard for the Case Expression (see attached Word document).   See the attached Word document to view the Derby Community Discussion about this issue.  See the attached .TXT to view the SYSINFO and to see an example of the steps to reproduce using IJ.\n\nSteps to Reproduce:\n\nij>values case when 1=2 then 3 else NULL end;\nERROR 42X89:  Types 'INTEGER' and 'CHAR' are not type compatible.  Neither type is assignable to the other type.\n\nCurrent Workaround:\nij>values case when 1=2 then 3 else cast(NULL as INT) end;","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39628","summary":"SQL CASE statement returns ERROR 42X89 when including NULL as a return value","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Windows XP","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":25,"total":25,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12424894","id":"12424894","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"body":"These attachments are the SQL 2003 Standard for the Case Expression, the Derby Community Discussion about this issue, and the SysInfo along with an example of the Steps to Reproduce.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"created":"2006-08-01T15:11:03.000+0000","updated":"2006-08-01T15:11:03.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12424927","id":"12424927","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jta","name":"jta","emailAddress":"jta at bristowhill dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jean T. Anderson","active":true},"body":"For any who don't have Word, the start for the discussion in Derby_Community_Discussion.doc  can be viewed at these locations:\r\n\r\nASF archives:\r\nhttp://mail-archives.apache.org/mod_mbox/db-derby-user/200607.mbox/%3cD867A529C569F64BAC09C622E55B4084010E2BF8@EXCHCLUSTUSA.rpega.com%3e\r\nhttp://tinyurl.com/lceff\r\n\r\nNabble:\r\nhttp://www.nabble.com/ERROR-42X89%3A-Types-%27INTEGER%27-and-%27CHAR%27-are-not-type-compatible.-Neither-type-is-assignable-to-the-other-type.-p5527265.html\r\nhttp://tinyurl.com/oomep","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jta","name":"jta","emailAddress":"jta at bristowhill dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jean T. Anderson","active":true},"created":"2006-08-01T16:47:02.000+0000","updated":"2006-08-01T16:47:02.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12424967","id":"12424967","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"body":"It has been brought to my attention that the SQL2003_Standard_Case_Expression.doc is a violation of the ISO copyright, I suggest it be removed as soon as possible.  Instead, please refer to http://en.wikipedia.org/wiki/SQL:2003 for a link to a .zip file (sql_2003_standard.zip), and open the 5WD-02-Foundation-2003-09.pdf within.  Turn to page 197 (221 of 1332) (Chapter 6.11) to view the Case Expression standard.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"created":"2006-08-01T18:16:28.000+0000","updated":"2006-08-01T18:16:28.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12424969","id":"12424969","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"body":"Removed SQL2003_Standard_Case_Expression.doc attachment at attcher's request.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"created":"2006-08-01T18:19:33.000+0000","updated":"2006-08-01T18:19:33.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12447003","id":"12447003","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"body":"The org.apache.derby.impl.sql.compile.SQLParser parses NULL's found in SQL case expressions into UntypedNullConstantNode nodes and casts those nodes to the CHAR type.  (See SQLParser.caseExpression() on line ~13180).\r\n\r\nThe DERBY-7 bug fix took this into account to enable the NULLIF() function to work properly, but this code is only executed if NULLIF() is parsed.  (See SQLParser.valueSpecification() on line ~13111).  The SQL equivalent to NULLIF(), which is CASE V1=V2 THEN NULL ELSE V1 END, is not flagged to be given this special consideration, and therefore Derby returns the 42X89 error.  The error also afflicts the related statements CASE V1=V2 THEN NULL ELSE V3 and CASE V1=V2 THEN V3 ELSE NULL.\r\n\r\nIn the attached proposed patch of  org.apache.derby.impl.sql.compile.ConditionalNode, Derby will now look more closely at the \"then\"  and \"else\" nodes during the bindExpression() method.  If the node meets the following four conditions, then it is cast to the type of the other node.  Otherwise nothing happens, and Derby will proceed as usual.\r\n\r\n1) The \"then\" or \"else\" node is a CAST_NODE\r\n2) The CAST_NODE node operand is an UntypedNullConstantNode\r\n3) The other node (\"else\" or \"then\") has a type service\r\n4) The \"else\" and \"then\" nodes don't have the same type\r\n\r\nThese four conditions ensure only NULL's will be cast, and that they'll only be cast if the other node has a type assigned to it that is different than CHAR.\r\n\r\nWe have been testing this fix by using our product with Derby, and it appears to be doing the job.  I've also executed the derbyall test suite, and the problems which occurred do not seem to stem from this change.  The next step is a more extensive testing using all possible database types.  I'm planning on moving forward with that, but I wanted to post this patch for review and comment. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"created":"2006-11-03T16:39:41.000+0000","updated":"2006-11-03T16:39:41.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12462209","id":"12462209","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bernt","name":"bernt","emailAddress":"bernt at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bernt M. Johnsen","active":true},"body":"The diff-file contains numerous white-space changes (27 regions out of 29). They should be removed. Otherwise, the patch looks sane to me.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bernt","name":"bernt","emailAddress":"bernt at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bernt M. Johnsen","active":true},"created":"2007-01-04T13:25:19.203+0000","updated":"2007-01-04T13:25:19.203+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12462226","id":"12462226","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"body":"The ConditionalNode_diff.txt is a cleaner diff-file, I've removed the white-space changes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"created":"2007-01-04T14:57:56.810+0000","updated":"2007-01-04T14:57:56.810+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12462834","id":"12462834","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"The new version of the diff looks very good, the code reads very well and the comments are\r\nvery well-written and clear.\r\n\r\nThe only tiny little confusion I had is over sub-condition (4). In your 3-Nov comment you say:\r\n      4) The \"else\" and \"then\" nodes don't have the same type\r\nand that seems to be what the code implements. But in the code itself your comment says\r\n     4) the other node's type isn't CHAR  (avoids duplicate work)\r\nCan you explain that in just a bit more detail?\r\n\r\nAlso, would it be possible for you to include some tests? Perhaps some various examples\r\nof CASE statements with nulls in various combinations, and also some various\r\nexamples of NULLIF function calls? I see that you indicated in your 3-Nov comment that\r\nyou were working on that; let us know if you've run into any snags or roadblocks.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-01-07T16:41:23.850+0000","updated":"2007-01-07T16:41:23.850+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12463051","id":"12463051","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"body":"\r\nYes, that comment isn't very clear.  I was trying to remind the reader\r\nthat the SQLParser parses NULL's in the CASE expression into\r\nUntypedNullConstantNode's and then casts those nodes into CHAR's.  Thus\r\nthe only situation in which the case statement is returning a CHAR will\r\nthis check need to be performed.  Ultimately to avoid having the NULL\r\ncasted to a CHAR for a second time (duplicate work).  Thanks for\r\npointing it out, I will have to clarify. \r\n\r\nI was working on some test cases, but while writing them I realized that\r\npatch I provided doesn't handle nested WHEN's.  A rather severe\r\noversight.  So once solution is to recursively examine \"else\" nodes to\r\ndetermine if they are another conditional node.  I have been delaying\r\nupdating the code, however, because it's not clear to me as to why Derby\r\nis casting NULL's into CHAR's in the first place.  This question of\r\ncourse begs a more detailed look into the underlying Derby code than I\r\nhave yet undergone.  In fact, I am planning on posing it to the Derby\r\ncommunity, for I would be most interested in any feedback.\r\n \r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"created":"2007-01-08T15:03:28.524+0000","updated":"2007-01-08T15:03:28.524+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12463374","id":"12463374","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"body":"A comment in the org.apache.derby.impl.sql.compile.SQLParser.valueSpecification() indicates an assumption that the NULL's in an SQL statement will be taken care of at bind time, from this I'm deducing that it's not the parser's responsibility to ensure NULL's are cast correctly.  Perhaps it would be a more complete and efficient solution for the SQLParser to parse NULL's into a currently non-existent NULL type and modify Derby on a larger more complex scale, but I suspect this may not be an ideal solution because there currently doesn't seem to be any demand for a NULL type other than this particular bug.  With these thoughts as my motivation, I've created a new patch that will handle NULL's in nested CASE statements.  I will provide more extensive tests and their results shortly, however, in the meantime opinions on this are welcome and invited.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"created":"2007-01-09T18:57:43.415+0000","updated":"2007-01-09T18:57:43.415+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12476034","id":"12476034","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"John Peterson >  I will provide more extensive tests and their results shortly\r\n\r\nJohn, are you still planning to provide test cases for the changes you have contributed for this issue?  And is there anything else that needs to be done here or is the latest ConditionalNode.diff a complete resolution to this problem?\r\n\r\nI looked at what I think is the latest patch (ConditionalNode.diff from 01/09/2007) and it looks pretty good.  There are, however, a lot of whitespace diffs in the patch--in fact, if I'm not mistaken the last 160 lines of the patch are whitespace-only changes?  It'd be great if those could be removed.\r\n\r\nIf you are still planning to contribtue test cases and there is nothing else to do for his issue (aside from whitespace cleanup), I'd be willing to commit your changes to the Derby trunk for you.  Please post a comment if you are still interested.\r\nThank you for your time on this!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2007-02-26T23:15:15.201+0000","updated":"2007-02-26T23:15:15.201+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12480182","id":"12480182","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"body":"The latest patch (March 12, 2007) fixes the two problems my last patch still had issues with.\r\n\r\n1) NULL's inside the THEN braches of the CASE Expressions where not being cast.   Causing the exception to be thrown.\r\n  (e.g. VALUES CASE WHEN 1 = 1 THEN (CASE WHEN 1 = 1 THEN NULL ELSE 1 END) ELSE NULL END;)\r\n\r\n2) Column References were ignored.  Causing the exception to be thrown.\r\n  (e.g. SELECT Count(CASE WHEN 1 = 1 THEN aDecimalColumnName ELSE NULL END) FROM aTableName;)\r\n\r\nI have done extensive testing, and I believe this patch finally fixes this bug.  Therefore, once these changes are commited, I will close out this bug.\r\n\r\nThanks,\r\nJohn","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"created":"2007-03-12T20:28:25.004+0000","updated":"2007-03-12T20:28:25.004+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12480226","id":"12480226","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"> I have done extensive testing, and I believe this patch finally fixes this bug. \r\n\r\nThat's great to hear.  Can I ask what you mean by \"extensive testing\"?  Did you run the Derby regression suites at all?  Do you have a list of queries that you ran to verify everything is working as it should?  And if so, is it possible to add those queries to one of Derby's existing regression tests?  This allows other developers to ensure that everything will continue to work in the future.\r\n\r\nIf you do not feel like incorporating your test queries into an existing (or new) regression test, then it would be great if you could at least post the queries (ex. as an ij script) to this issue so that any other developers who may be interested can add the test cases to the regression suite.  It would, of course, be wonderful if you were willing and able to do that yourself.\r\n\r\nI as a committer am a bit hesitant to commit changes for which no new regression tests have been added.  There are exceptions, of course, but in this particular case I think it would be great to have some new test cases running every night to verify the fix.  And if you've already done \"extensive testing\", perhaps that means you have such test cases already written...?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2007-03-12T23:51:12.103+0000","updated":"2007-03-12T23:51:12.103+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12480389","id":"12480389","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"body":"\r\nI did run the entire test suite against it, and none of the problems\r\nthat occurred appeared to stem from the modification of the\r\nConditionalNode class.   My \"extensive\" testing can not be shared as\r\nthey are a set of proprietary queries not written by me against a\r\ndatabase not created by me.  You do make an excellent point, however, so\r\nI'll write up a test suite that takes advantage of the existing tests\r\nput into place by the author of the DERBY-7 fix.  I'll shoot for this\r\nweek.\r\n\r\nJohn\r\n \r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"created":"2007-03-13T13:17:09.855+0000","updated":"2007-03-13T13:17:09.855+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12480787","id":"12480787","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"body":"The results of the test indicate that problems occur when trying to cast the casted NULL into something that can not be converted from a CHAR,  (e.g.  From line 2090 of resultset.tmp:\r\n\r\n     SELECT CASE WHEN 1 = 1 THEN REALCOL ELSE NULL END from AllDataTypesTable\r\n     ERROR 42846: Cannot convert types 'CHAR' to 'REAL'. )\r\n\r\nEven though the statement is no longer issuing the 42X89 error, it's still not up to SQL Standard.  Since I am unsure of the impact of changing the SQLParser (which sets NULL's to type CHAR), I'm going to change the cast type from CHAR to REAL instead of casting the casted NULL to a REAL (causing the error).  The good news is that this will be a substantial improvement for anyone who wants to use NULL's with a type that can't be casted from a CHAR in a CASE Expression, for which there is currently no workaround.\r\nJohn\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"created":"2007-03-14T14:23:08.319+0000","updated":"2007-03-14T14:23:08.319+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12480922","id":"12480922","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"body":"The latest patch, test code, and test results.   The latest change was a simple one.  If required, the NULL is relieved of it's CHAR association and recast to a more appropriate type.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"created":"2007-03-14T20:50:38.401+0000","updated":"2007-03-14T20:50:38.401+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12481228","id":"12481228","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Thank you for your continued work on this, John.  I'm hoping to review and commit the latest patch sometime in the next couple of days.\r\n\r\nOne thing I did notice: We have been trying to move as many of the regression tests as possible into JUnit :\r\n\r\n  http://wiki.apache.org/db-derby/KillDerbyTestHarness\r\n  http://wiki.apache.org/db-derby/DerbyJUnitTesting\r\n\r\nAs part of that effort the jdbcapi/resultset.java test was recently converted (just a couple of days ago, actually), and thus that particular test file no longer exists--see DERBY-2429.  So the test patch that you have won't actually apply to the latest codeline :(\r\n\r\nMy apologies here: I should have mentioned the preference for JUnit tests when I asked earlier, and I didn't realize that the test you were changing was going to be converted this week.  Ack.\r\n\r\nSo that said, do you have any interest in porting your new test cases to JUnit based on the new JUnit tests added as part of DERBY-2429?  I understand if you find that to be a bit too annoying; if so, we at least have the resultset.java changes (thank you!) so anyone else in the community who is so inclined can make the conversion.  But I thought I'd ask just to see...\r\n\r\nThank you very much for your continued patience with this effort.  As I said, I'll try to review/convert the engine changes over the next couple of days (maybe early next week if I can't get to it before then).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2007-03-15T17:06:36.457+0000","updated":"2007-03-15T17:06:36.457+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12481289","id":"12481289","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"body":"\r\nOf course, I'll be happy to.\r\nJohn \r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"created":"2007-03-15T19:29:09.608+0000","updated":"2007-03-15T19:29:09.608+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12482262","id":"12482262","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Hi John, just a few minor comments on the most recent patch:\r\n\r\n - The following two methods do not have any javadoc; it's not that big of a\r\n   deal since it's pretty clear that what they are doing--but a line or two\r\n   of javadoc content wouldn't hurt...\r\n\r\n   * isCastNode(ValueNode)\r\n   * isCastToChar(CastNode)\r\n\r\n - There are several un-used versions of \"shouldCast()\" in this patch: the\r\n   only one that is directly called is (DataTypeDescriptor, ValueNode), and\r\n   that simply calls the version which takes two DTDs.  So I wonder if we could\r\n   just have the single version that takes two DTDs and then call that\r\n   directly, ex:\r\n\r\n   Instead of:\r\n\r\n     if (isNullNode(thenNode) && shouldCast(castType, thenNode)) {\r\n\r\n   just do:\r\n\r\n\r\n     if (isNullNode(thenNode) &&\r\n        shouldCast(castType, thenNode.getTypeServices()))\r\n     {\r\n\r\n    Then you could remove all of the other versions of the method.\r\n\r\n - The sequential \"if\" statements in the new \"findType()\" method are a tad\r\n   hard to follow.  If we remove the underlying code blocks we end up with\r\n   something like:\r\n\r\n+        if ((thenType != null) && !isCastNode(thenNode) && !isConditionalNode(thenNode))\r\n+        if (isCastNode(thenNode) && !isCastToChar((CastNode)thenNode))\r\n+        if ((elseType != null) && !isCastNode(elseNode) && !isConditionalNode(elseNode))\r\n+        if (isCastNode(elseNode) && !isCastToChar((CastNode)elseNode))\r\n+        if (isConditionalNode(thenNode))\r\n+        if (theType != null)\r\n+        if (isConditionalNode(elseNode))\r\n+        if (theType != null)\r\n\r\n   Maybe I'm just being paranoid, but when I see code like this I have to\r\n   stare for a long time to convince myself that all of the different paths\r\n   have been covered.  It's especially tough given that certain conditions (ex.\r\n   \"isCastNode(thenNode)\") show up more than once.\r\n\r\n   Of course, you added good comments to this code which were very helpful--so\r\n   thank you for that!  I don't think you need to change anything here, but since\r\n   I spent a good deal of time scratching my head and trying to convince myself\r\n   that all of this is correct, I thought I'd mention it...\r\n\r\nBut these are all minor things that can be addressed with a follow-up patch if you are so inclined.\r\n\r\nI ran derbyall and suites.All on Red Hat Linux with ibm142 and there were no failures, so I made some minor formatting changes to the patch (lines longer than 80 chars--it'd be great if these could be avoided in the future...) and committed the *engine* changes with svn #520173:\r\n\r\n  URL: http://svn.apache.org/viewvc?view=rev&rev=520173\r\n\r\nSince you have kindly agreed to work on rewriting the tests for JUnit (thank you!) I did not commit the \"resultset\" changes and am leaving the issue 'Open' for now...\r\n\r\nThank you for the contribution!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2007-03-19T23:35:50.842+0000","updated":"2007-03-19T23:35:50.842+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12482267","id":"12482267","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Oops, somehow I unassigned John Peterson from this issue (sorry!).  I tried to reassign it back to him but he doesn't show up on the available list.  John, please re-assign this issue back to you when you have the chance.  Sorry for the slip-up...not sure how that happened...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2007-03-19T23:41:00.912+0000","updated":"2007-03-19T23:41:00.912+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12482294","id":"12482294","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"body":"Reassign John Peterson to this issue. Needed to update his JIRA user profile to be a contributor to the derby-developers group.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"created":"2007-03-20T02:39:04.499+0000","updated":"2007-03-20T02:39:04.499+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12500861","id":"12500861","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"body":"Per previous comments, I've added javadoc information to the private methods isCastNode() and isCastToChar(), removed the unused shouldCast() methods, updated the recastNullNodes to use the remaining shouldCast() method, and tried to improve the comments on the if-then-else blocks determining recursive calls.  I've also created a new class org.apache.derbyTesting.functionTests.tests.lang.CaseExpressionTest.java which converts my additions to the org.apache.derbyTesting.functionTests.tests.jdbcapi.resultset.java class over to the new junit testing suite.  If these last few small changes are acceptable, then I will close out this bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"created":"2007-06-01T21:13:59.110+0000","updated":"2007-06-01T21:13:59.110+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12501730","id":"12501730","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Hi John,\r\n\r\nThank you for following through with my previous review comments, and for rewriting your test cases to run in JUnit.  That was very helpful.\r\n\r\nJust a few minor comments on the latest patch:\r\n\r\n1 - The Java class name at the top of the license header in the new JUnit test says \"NullIfTest\", when it should say \"CaseExpressionTest\".\r\n\r\n2 - There are a few unnecessary imports in CaseExpressionTest:\r\n\r\n  java.sql.Date\r\n  java.sql.PreparedStatement\r\n  java.sql.Time\r\n  java.sql.Timestamp\r\n\r\n  org.apache.derbyTesting.junit.JDBC\r\n\r\n3 - In the \"suite()\" method I think it might be good to use existing convenience methods on TestConfiguration, instead of calling \"baseSuite\" directly.  Ex:\r\n\r\n  // For embedded:\r\n\r\n  suite.addTest(\r\n      TestConfiguration.embeddedSuite(CaseExpressionTest.class));\r\n\r\n  // For client/server:\r\n\r\n  suite.addTest(\r\n      TestConfiguration.clientServerSuite(CaseExpressionTest.class));\r\n\r\n  // For both embedded *and* client/server:\r\n\r\n  suite.addTest(\r\n      TestConfiguration.defaultSuite(CaseExpressionTest.class));\r\n\r\nThat said, since the changes for Jira only effect SQL processing within the engine, it's probably good enough to just run the new JUnit test in embedded mode.\r\n\r\n4 - There are several System.out.printlns in the test.  I think that the preferred approach to JUnit testing is to avoid printing anything to System.out or System.err.  If the output is an important part of the test then is should be replaced with some kind of JUnit assertion.  But in the new CaseExpressionTest, it looks like the System.out.println statements are purely informational, in which case I think it's best to remove them altogether.  Or, if you think the output might be useful for debugging, you could move all of the System.outs into a \"debug\" method and add a flag that allows debugging information to be turned on/off (with default to \"off\").  See, for example, lang/MathTrigFunctionsTest.java.\r\n\r\n5 - I think the new test has to be added to lang/_Suite.java in order to run as part of Derby's JUnit regression suite.  This should just be a one-line addition to the \"suite()\" method of lang/_Suite.java, something like:\r\n\r\n    suite.addTest(CaseExpressionTest.suite());\r\n\r\n6 - It might be nice if you can name your next patch something other than \"ConditionalNode.diff\", in order to avoid confusion with the changes that have already been committed.  For example, something like \"derby1620_test.patch\" would, I think, be a tad more clear.\r\n\r\nThanks again for your continued work (and patience) with this Jira!  I think that if the above comments can be addressed, the patch will be ready for commit and we can finally close this issue...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2007-06-05T22:51:07.600+0000","updated":"2007-06-05T22:51:07.600+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12501953","id":"12501953","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"body":"I've changed the comment headers to indicate this class is CaseExpressionTest, removed the unnecessary imports, removed the \"System.out\" statements (which are not needed), added the test to the lang/_Suite class, and renamed this patch from \"ConditionalNode.diff\" to \"derby1620_test.patch\" for clarification.  I've also updated the suite() method by removing the client/server test, and removing the call to the local baseSuite() method which was clearly confusing.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.peterson%40pega.com","name":"john.peterson@pega.com","emailAddress":"john dot peterson at pega dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Peterson","active":true},"created":"2007-06-06T15:12:56.275+0000","updated":"2007-06-06T15:12:56.275+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12347067/comment/12502135","id":"12502135","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Thank you for the revised patch, John.  I applied it to my codeline and ran the regression tests (derbyall and suites.All) as a sanity check.  I then did some cleanup of the new CaseExpressionTest to a) keep lines under 80 characters, and b) move common code into a single testCaseExpressionQuery() method, to avoid code duplication.  I also verified that the new test fails if the fix for this issue is reverted, and passes with the fix applied.  So everything looks good.\r\n\r\nCommitted derby1620_test_v2.patch (which has the changes I mentioned above) with svn # 544974:\r\n\r\n  URL: http://svn.apache.org/viewvc?view=rev&rev=544974\r\n\r\nMarking issue as resolved in 10.3.  I'll leave it up to you close it if everything looks okay.\r\n\r\nThanks for fixing this bug!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2007-06-06T22:28:37.355+0000","updated":"2007-06-06T22:28:37.355+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1620/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i075bj:"}}
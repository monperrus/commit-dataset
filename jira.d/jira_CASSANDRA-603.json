{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12442507","self":"https://issues.apache.org/jira/rest/api/latest/issue/12442507","key":"CASSANDRA-603","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310865","id":"12310865","key":"CASSANDRA","name":"Cassandra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310865&avatarId=12034","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310865&avatarId=12034","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310865&avatarId=12034","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310865&avatarId=12034"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11961","id":"11961","description":"Apache Cassandra related projects","name":"Cassandra"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314040","id":"12314040","description":"","name":"0.5","archived":false,"released":true,"releaseDate":"2010-01-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-12-07 00:47:38.626","customfield_12312322":null,"customfield_12312323":null,"customfield_12310222":"1_*:*_1_*:*_952168323_*|*_5_*:*_2_*:*_118121_*|*_4_*:*_1_*:*_75414162","customfield_12310420":"19774","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2009-12-16T18:13:31.253+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-603/watchers","watchCount":1,"isWatching":false},"created":"2009-12-04T20:45:10.647+0000","customfield_10022":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12311124":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-12-17T22:03:03.090+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[],"timeoriginalestimate":null,"description":"We bootstrapped 5 nodes on the east coast from an existing cluster (5) on west. We waited at least 60 seconds before starting up each node so it would start bootstrapping. We started seeing these types of errors:\r\n\r\n INFO [GMFD:1] 2009-12-04 01:45:42,065 Gossiper.java (line 568) Node /X.X.X.140 has now joined.\r\nERROR [GMFD:1] 2009-12-04 01:46:14,371 DebuggableThreadPoolExecutor.java (line 127) Error in ThreadPoolExecutor\r\njava.lang.RuntimeException: pending range collision between /X.X.X.139 and /X.X.X.140\r\n        at org.apache.cassandra.locator.TokenMetadata.addPendingRange(TokenMetadata.java:242)\r\n        at org.apache.cassandra.service.StorageService.updateBootstrapRanges(StorageService.java:481)\r\n        at org.apache.cassandra.service.StorageService.onChange(StorageService.java:402)\r\n        at org.apache.cassandra.gms.Gossiper.doNotifications(Gossiper.java:692)\r\n        at org.apache.cassandra.gms.Gossiper.applyApplicationStateLocally(Gossiper.java:657)\r\n        at org.apache.cassandra.gms.Gossiper.applyStateLocally(Gossiper.java:610)\r\n        at org.apache.cassandra.gms.GossipDigestAckVerbHandler.doVerb(Gossiper.java:978)\r\n        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:38)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\r\n        at java.lang.Thread.run(Thread.java:619)\r\nERROR [GMFD:1] 2009-12-04 01:46:14,378 CassandraDaemon.java (line 71) Fatal exception in thread Thread[GMFD:1,5,main]   \r\njava.lang.RuntimeException: pending range collision between /X.X.X.139 and /X.X.X.140\r\njava.lang.RuntimeException: pending range collision between /X.X.X.139 and /X.X.X.140\r\n        at org.apache.cassandra.locator.TokenMetadata.addPendingRange(TokenMetadata.java:242)\r\n        at org.apache.cassandra.service.StorageService.updateBootstrapRanges(StorageService.java:481)\r\n        at org.apache.cassandra.service.StorageService.onChange(StorageService.java:402)\r\n        at org.apache.cassandra.gms.Gossiper.doNotifications(Gossiper.java:692)\r\n        at org.apache.cassandra.gms.Gossiper.applyApplicationStateLocally(Gossiper.java:657)\r\n        at org.apache.cassandra.gms.Gossiper.applyStateLocally(Gossiper.java:610)\r\n        at org.apache.cassandra.gms.GossipDigestAckVerbHandler.doVerb(Gossiper.java:978)\r\n        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:38)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\r\n        at java.lang.Thread.run(Thread.java:619) ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12428139","id":"12428139","filename":"603.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-16T07:44:06.037+0000","size":30887,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12428139/603.patch"}],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"91422","summary":"pending range collision between nodes","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"customfield_12311420":null,"customfield_12311421":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":15,"total":15,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12786747","id":"12786747","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"Pending range collision check is currently too trigger-happy and should be relaxed a bit. At the moment pending range collision happens if any of the node's ranges clash, although it should happen only if the primary range node is booting to clashes.\r\n\r\nHowever, if your nodes already had finished bootstrapping, then this is another issue completely. Haven't seen such case myself, but I'll have a look.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-07T00:47:38.626+0000","updated":"2009-12-07T00:47:38.626+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12786897","id":"12786897","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"Could you please check if the nodes in question (.139 and .140) had already completed bootstrap (log entry \"Bootstrap completed...\" on INFO level)?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-07T13:02:24.313+0000","updated":"2009-12-07T13:02:24.313+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12787002","id":"12787002","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"body":"No they did not. The messages started showing up a few minutes after I believe, anticompaction was still running.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"created":"2009-12-07T17:29:15.356+0000","updated":"2009-12-07T17:29:15.356+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12787449","id":"12787449","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"For now it is best to wait until one bootstrap has finished before starting another one. As mentioned pending ranges clash is relatively easy to get (happens if any of replica ranges are the same), so before this one is fixed, you might easily see this even \"without reason\".\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-08T13:16:38.378+0000","updated":"2009-12-08T13:16:38.378+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12787452","id":"12787452","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"As for the fix, there are two (at least) two options I think:\r\n\r\n(1) Add a list of pending primary ranges (or tokens) to token metadata. Currently primary and replica pending ranges are all in one list, so there is no way to check afterwards if primary ranges collide.\r\n\r\n(2) Ditch pending ranges completely and convert it to pending tokens. Problem with pending ranges is that it is static structure (determined at the time of bootstrap/leaving) and does not react to token changes during the operation. This introduces a number of difficult-to-prove-that-it-works-correctly and difficult-to-handle-correctly corner cases regarding node movement as proved by various mail and JIRA discussions recently. If we had a list of pending tokens instead, it would adapt to any changes that happen during the move operation. There are currently issues in pending range handling (not cleaned up correctly in all cases, thread/atomicy issues, leaving coordination, etc) that would mostly go away if we swiched to pending tokens instead, I think. Might be that I'm overlooking something obvious here, but to me it seems like dynamically adapting pending token list would be more suitable for this.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-08T13:28:04.805+0000","updated":"2009-12-08T13:28:04.805+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12787588","id":"12787588","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"body":"Jaakko,\r\n\r\nJust curious, for all the node movement coordination operations, would Zookeeper make any of this a bit easier to manage?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"created":"2009-12-08T17:26:16.740+0000","updated":"2009-12-08T17:26:16.740+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12788712","id":"12788712","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"It certainly is worth considering. For now I think we can do without, but with automatic load balancing coordination issues will become more complex.\r\n\r\nI'm going to have a look at this pending range issue tomorrow.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-10T13:23:17.517+0000","updated":"2009-12-10T13:23:17.517+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12789250","id":"12789250","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"Patch attached. Modifications:\r\n\r\nKeep track of booting and leaving tokens and calculate pending ranges again every time there is status change. This will keep them up to date. To ensure that pending ranges cover node's final range, following reasoning is used in calculation:\r\n\r\n(1) When in doubt, it is better to write too much to a node than too little. That is, if there are multiple nodes moving, calculate the biggest ranges a node could have. Cleaning up unneeded data afterwards is better than missing writes during movement.\r\n\r\n(2) When a node leaves, ranges for other nodes can only grow (a node might get additional ranges, but it will not lose any of its current ranges as a result of a leave). Therefore we will first remove _all_ leaving tokens for the sake of calculation and then check what ranges would go where if all nodes are to leave. This way we get the biggest possible ranges with regard current leave operations, covering all subsets of possible final range values.\r\n\r\n(3) When a node bootstraps, ranges of other nodes can only get smaller. Without doing complex calculations to see if multiple bootstraps overlap, we simply base calculations on the same token ring used before (reflecting situation after all leave operations have completed). Bootstrapping nodes will be added and removed one by one to that metadata and checked what their ranges would be. This will give us the biggest possible ranges the node could have. It might be that other bootstraps make our actual final ranges smaller, but it does not matter as we can clean up the data afterwards.\r\n\r\nBootstrap Token collision (old pending range collision) is thrown now only if bootstrap tokens are identical.\r\n\r\nCalculating pending ranges is rather heavy operation, but since it is done only once when a node changes state in the cluster, it should be manageable.\r\n\r\nThis patch would make #572 cleaner to do, since we now know which way a node is going and can update pending ranges according to any changes.\r\n\r\nEdit: this also removes nodeprobe cancelpendingranges. That would be pointless now. If there is a node/token that has not finished move operation, nodeprobe removetoken will do the trick.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-11T11:32:02.971+0000","updated":"2009-12-11T11:33:57.612+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12790419","id":"12790419","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"1, 2, and 3 are all how the existing code works in my mind (which may not be how it works in reality :).  What does the extra tracking of bootstrap tokens & leaving endpoints buy us?  As you said, pending ranges shouldn't overlap in the first place unless there is a token collision.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-14T22:32:56.732+0000","updated":"2009-12-14T22:32:56.732+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12790575","id":"12790575","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"Unfortunately it doesn't quite work that way :)\r\n\r\nFirst the case of leaving nodes:\r\n\r\nProblem with current implementation is that pending ranges is calculated only once at the time of leaving. Suppose there is a ring of nodes A, B, C, D and E with replication factor 2. Ring status is this:\r\n\r\n(primary, replica)\r\nE-A, D-E\r\nA-B, E-A\r\nB-C, A-B\r\nC-D, B-C\r\nD-E, C-D\r\n\r\nSuppose C prepares to leave. After hearing STATE_LEAVING from C, ring status will be:\r\n\r\n(primary, replica, pending)\r\nE-A, D-E\r\nA-B, E-A\r\nB-C, A-B\r\nC-D, B-C, A-B\r\nD-E, C-D, B-C\r\n\r\nNow suppose also B leaves. After receiving STATE_LEAVING, ring status with current implementation will be:\r\nE-A, D-E\r\nA-B, E-A\r\nB-C, A-B, E-A\r\nC-D, B-C, A-B\r\nD-E, C-D, B-C\r\n\r\nThis is clearly wrong, as (1) E-A is being streamed to C, even though it is leaving and (2) D is not getting this range, even if it is supposed to.\r\n\r\nIn order to do this right, we will need to know at all times what nodes are leaving and calculate ranges accordingly. An anonymous pending ranges list is not enough, as that does not tell which node is leaving and/or if the ranges are there because of bootstrap or leave operation.\r\n\r\n\r\nAs for bootstrapping and pending range collision:\r\n\r\nSuppose that there is a ring of nodes A, C and E, with replication factor 3. Node D bootstraps between C and E, so its pending ranges will be E-A, A-C and C-D. Now suppose node B bootstraps between A and C at the same time. Its pending ranges would be C-E, E-A and A-B. Now both nodes have pending range E-A in their list, which will cause pending range collision even though we're only talking about replica range, not even primary range. The same thing happens for any nodes that boot simultaneously between same two nodes. For this we cannot simply make pending ranges a multimap, since that would make us unable to notice the real problem of two nodes trying to boot using the same token. In order to do this properly, we need to know what tokens are booting at any time.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-15T05:55:59.195+0000","updated":"2009-12-15T05:55:59.195+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12790955","id":"12790955","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"Thanks for the explanation.  Committed, w/ parts of the above as comments to TokenMetadata.\r\n\r\nOne minor quibble is, I'd really prefer to avoid having this circular TM <-> ReplicationStrategy dependency cycle.  (Which is part of the reason the code was structured the way it was: RS would pass TM the info it needed to do its thing in a concurrency-safe fashion, w/o needing to reach into RS itself which makes auditing for thread-safety much harder).  So if you think of a way to refactor that, even better. :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-15T21:14:38.933+0000","updated":"2009-12-15T21:14:38.933+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12790956","id":"12790956","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"Oops, I take back the \"committed\" part -- I'm getting test failures.  I think they just need to be updated to use the new method signatures.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-15T21:15:55.668+0000","updated":"2009-12-15T21:15:55.668+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12791253","id":"12791253","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"New version:\r\n- Moved calculatePendingRanges to StorageService\r\n- fixed test errors","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-16T07:44:06.095+0000","updated":"2009-12-16T07:44:06.095+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12791500","id":"12791500","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"committed to 0.5 and trunk","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-16T18:13:31.215+0000","updated":"2009-12-16T18:13:31.215+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12442507/comment/12792157","id":"12792157","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","emailAddress":"jira at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true},"body":"Integrated in Cassandra #291 (See [http://hudson.zones.apache.org/hudson/job/Cassandra/291/])\r\n    ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","emailAddress":"jira at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true},"created":"2009-12-17T22:03:03.019+0000","updated":"2009-12-17T22:03:03.019+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-603/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0fzy7:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12495625","self":"https://issues.apache.org/jira/rest/api/latest/issue/12495625","key":"DERBY-4973","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313143","id":"12313143","description":"Head of 10.3 branch","name":"10.3.3.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313401","id":"12313401","description":"Head of 10.4 branch","name":"10.4.2.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315436","id":"12315436","description":"Head of 10.5 branch - version bump for DERBY-4835","name":"10.5.3.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315434","id":"12315434","description":"Head of 10.6 branch as of 2014-01-13","name":"10.6.2.4","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315902","id":"12315902","description":"Head of 10.7 branch as of 2010-11-29","name":"10.7.1.4","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316362","id":"12316362","description":"First release on the 10.8 branch","name":"10.8.1.2","archived":false,"released":true,"releaseDate":"2011-04-29"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2011-01-20 01:17:15.324","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24565","customfield_12310222":"1_*:*_1_*:*_949259484_*|*_6_*:*_1_*:*_33356713452_*|*_5_*:*_1_*:*_0_*|*_4_*:*_1_*:*_20886","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-02-15T23:03:41.384+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4973/watchers","watchCount":1,"isWatching":false},"created":"2011-01-14T21:37:07.600+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316362","id":"12316362","description":"First release on the 10.8 branch","name":"10.8.1.2","archived":false,"released":true,"releaseDate":"2011-04-29"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-06-17T09:19:46.324+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11412","id":"11412","name":"Store"}],"timeoriginalestimate":null,"description":"The IBM 1.6 results for Jan 13, 2011 show the following failure for IBM 1.6 on XP\r\n\r\n\r\n*** End:   TestEnc jdk1.6.0 DerbyNetClient derbynetclientmats:encodingTests 2011-01-14 00:05:38 ***\r\n********* Diff file derbyall/encryptionAll/storemats/storemats/updatelocks.diff\r\n*** Start: updatelocks jdk1.6.0 storemats:storemats 2011-01-14 00:18:37 ***\r\n19859a19860,19868\r\n> ERROR 38000: The exception 'java.lang.NullPointerException' was thrown while evaluating an expression.\r\n> ERROR XJ001: Java exception: ': java.lang.NullPointerException'.\r\n> ij> next scan_cursor;\r\n> A          |B          |C                                                                                                                               \r\n> --------------------------------------------------------------------------------------------------------------------------------------------------------\r\n> -3         |-30        |-three                                                                                                                          \r\n> ij> update a set a=3,b=30,c='three' where current of scan_cursor;\r\n> 1 row inserted/updated/deleted\r\n> ij> select * from lock_table order by tabname, type desc, mode, cnt, lockname;\r\n19861a19871\r\n> APP     |UserTran|TABLE   |1   |IX  |A           |Tablelock |GRANT|ACTIVE  \r\n19866,19876d19875\r\n< -3         |-30        |-three                                                                                                                          \r\n< ij> update a set a=3,b=30,c='three' where current of scan_cursor;\r\n< 1 row inserted/updated/deleted\r\n< ij> select * from lock_table order by tabname, type desc, mode, cnt, lockname;\r\n< USERNAME|TRANTYPE|TYPE    |CNT |MODE|TABNAME     |LOCKNAME  |STATE|STATUS  \r\n< ---------------------------------------------------------------------------\r\n< APP     |UserTran|TABLE   |1   |IX  |A           |Tablelock |GRANT|ACTIVE  \r\n< APP     |UserTran|TABLE   |1   |X   |A           |Tablelock |GRANT|ACTIVE  \r\n< ij> next scan_cursor;\r\n< A          |B          |C                                                                                                                               \r\n< --------------------------------------------------------------------------------------------------------------------------------------------------------\r\nTest Failed.\r\n*** End:   updatelocks jdk1.6.0 storemats:storemats 2011-01-14 00:19:24 ***\r\n------------------------------------------------------\r\n\r\nStack trace is:\r\nFri Jan 14 00:19:08 PST 2011 Thread[main,5,main] (XID = 2648), (SESSIONID = 1), (DATABASE = wombat), (DRDAID = null), Failed Statement is: select * from lock_table order by tabname, type desc, mode, cnt, lockname\r\n\r\nERROR 38000: The exception 'java.lang.NullPointerException' was thrown while evaluating an expression.\r\n\r\n\tat org.apache.derby.iapi.error.StandardException.newException(Unknown Source)\r\n\r\n\tat org.apache.derby.iapi.error.StandardException.unexpectedUserException(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.VTIResultSet.populateFromResultSet(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.VTIResultSet.getNextRowCore(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.HashTableResultSet.getNextRowFromRowSource(Unknown Source)\r\n\r\n\tat org.apache.derby.iapi.store.access.BackingStoreHashtable.getNextRowFromRowSource(Unknown Source)\r\n\r\n\tat org.apache.derby.iapi.store.access.BackingStoreHashtable.<init>(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.HashTableResultSet.openCore(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.openCore(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.JoinResultSet.openRight(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.JoinResultSet.openCore(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.openCore(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.SortResultSet.openCore(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.open(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.tools.ij.ij.executeImmediate(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.tools.ij.utilMain.doCatch(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.tools.ij.utilMain.go(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.tools.ij.Main.go(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.tools.ij.Main.mainCore(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.tools.ij.Main.main(Unknown Source)\r\n\r\n\tat org.apache.derby.tools.ij.main(Unknown Source)\r\n\r\nCaused by: java.lang.NullPointerException\r\n\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.getContextId(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.store.raw.xact.TransactionTableEntry.getTransactionTypeString(Unknown Source)\r\n\r\n\tat org.apache.derby.diag.TransactionTable.getString(Unknown Source)\r\n\r\n\tat org.apache.derby.iapi.types.SQLChar.setValueFromResultSet(Unknown Source)\r\n\r\n\t... 25 more\r\n\r\n============= begin nested exception, level (1) ===========\r\n\r\njava.lang.NullPointerException\r\n\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.getContextId(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.store.raw.xact.TransactionTableEntry.getTransactionTypeString(Unknown Source)\r\n\r\n\tat org.apache.derby.diag.TransactionTable.getString(Unknown Source)\r\n\r\n\tat org.apache.derby.iapi.types.SQLChar.setValueFromResultSet(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.VTIResultSet.populateFromResultSet(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.VTIResultSet.getNextRowCore(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.HashTableResultSet.getNextRowFromRowSource(Unknown Source)\r\n\r\n\tat org.apache.derby.iapi.store.access.BackingStoreHashtable.getNextRowFromRowSource(Unknown Source)\r\n\r\n\tat org.apache.derby.iapi.store.access.BackingStoreHashtable.<init>(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.HashTableResultSet.openCore(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.openCore(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.JoinResultSet.openRight(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.JoinResultSet.openCore(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.openCore(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.SortResultSet.openCore(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.open(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.tools.ij.ij.executeImmediate(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.tools.ij.utilMain.doCatch(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.tools.ij.utilMain.runScriptGuts(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.tools.ij.utilMain.go(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.tools.ij.Main.go(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.tools.ij.Main.mainCore(Unknown Source)\r\n\r\n\tat org.apache.derby.impl.tools.ij.Main.main(Unknown Source)\r\n\r\n\tat org.apache.derby.tools.ij.main(Unknown Source)\r\n\r\n============= end nested exception, level (1) ===========\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10369","value":"Regression Test Failure","id":"10369"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"36099","summary":"NullPointerException in  updatelocks.sql encryption tests on IBM 1.6","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10422","value":"High Value Fix","id":"10422"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Booting Derby version The Apache Software Foundation - Apache Derby - 10.8.0.0 alpha - (1058840): instance a816c00e-012d-839a-de59-ffff9cf6fc6d \r\non database directory C:\\jartest\\JarResults.2011-01-13\\ibm16_derbyall\\derbyall\\encryptionAll\\storemats\\storemats\\updatelocks\\wombat  with class loader sun.misc.Launcher$AppClassLoader@4bf94bf9 \r\nLoaded from file:/C:/jartest/classes/derby.jar\r\n\r\njava.vendor=IBM Corporation\r\njava.runtime.version=jvmwi3260sr9-20101124_69295\r\njava.fullversion=JRE 1.6.0 IBM J9 2.4 Windows XP x86-32 jvmwi3260sr9-20101124_69295 (JIT enabled, AOT enabled)\r\nJ9VM - 20101124_069295\r\nJIT  - r9_20101028_17488ifx2\r\nGC   - 20101027_AA\r\n","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":10,"total":10,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12495625/comment/12981941","id":"12981941","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Attaching full test results.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-01-14T22:00:55.610+0000","updated":"2011-01-14T22:00:55.610+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12495625/comment/12981943","id":"12981943","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"This is the method with the NPE:\r\n\tGet my transaction context Id\r\n\t*/\r\n\tpublic final String getContextId() \r\n\t{\r\n\t\treturn (xc == null) ? null : xc.getIdName();\r\n\t}\r\n\r\n\r\nI think this might be some sort of inlining JVM issue as it seems prepared for xc to be null.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-01-14T22:05:18.317+0000","updated":"2011-01-14T22:05:18.317+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12495625/comment/12983950","id":"12983950","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"\r\nI checked with Mike Matrigali  to double check that if it might be possible  that the xc field could be nulled out after the check but before the dereference in the line \r\nreturn (xc == null) ? null : xc.getIdName(); \r\n\r\nThe particular case of failure of a locktable query, the query is looking at the transaction context of other transactions in flux, so that might actually be possible.  I am thinking maybe the reason we see this with the new JVM might be that perhaps the compiler was changes to do two reads of the field in this case instead of one.   I am going to put in some sleeps to try to expose the issue and then ultimately per Mike's suggestion, recode the method to avoid the double read, like:\r\n\r\ntempxc = xc;\r\nreturn (tempxc == null) ? null : tempxc.getIdName();\r\n\r\nThat way we can avoid adding synchronization to this low level code for the benefit of the locktable query and ensure just one read.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-01-20T00:20:31.495+0000","updated":"2011-01-20T00:20:31.495+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12495625/comment/12983977","id":"12983977","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Perhaps we should also make xc volatile, so the reader is forced to refresh the value from memory?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-01-20T01:17:15.324+0000","updated":"2011-01-20T01:17:15.324+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12495625/comment/12984317","id":"12984317","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Dag could you elaborate on the benefit of making xc volatile?\r\n\r\n I guess one good thing is that it would be  self documenting that it might be changed by other threads, but actually in this case it would have been nice for a thread local copy to be made so it wouldn't change. Perhaps that is the difference we are seeing between SR8 and SR9 is that now it is refreshing the value from memory, whereas before it was not?  I guess though that absence of volatile means that it can cache a thread local copy, but is not a requirement that it does.\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-01-20T18:19:27.158+0000","updated":"2011-01-20T18:19:27.158+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12495625/comment/12984335","id":"12984335","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Ah, yes, I guess I misunderstood what you are trying to achieve here. I thought that the correct behaviour would be to actually *see* the change by another thread, but in a thread safe way. If you need a thread local copy, then adding volatile wouldn't help surely. But yes, if volatile is *not* used, the thread is not forced to reread from memory if the compiler knows it hasn't been changed by the current thread. Or that's how I understand it anyway[1]\r\n\r\n[1] http://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html#volatile","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-01-20T19:10:41.344+0000","updated":"2011-01-20T19:57:32.287+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12495625/comment/12984365","id":"12984365","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I think then that I won't make it volatile and will add the tempxc code to make sure it is just read once and is stable for the duration of the getContextId() call.  \r\n\r\nNote: To pop the bug more reliably, I changed the code to have a sleep between the check and the dereference:\r\npublic final String getContextId() \r\n\t{\r\n\t\t//return (xc == null) ? null : xc.getIdName();\r\n\t    if (xc == null)\r\n\t        return null;\r\n\t    else {\r\n\t        try {\r\n                Thread.currentThread().sleep(100);\r\n            } catch (InterruptedException e) {\r\n                // TODO Auto-generated catch block\r\n                e.printStackTrace();\r\n            }\r\n\t        return xc.getIdName();\r\n\t    }\r\n\t}\r\n\r\nWith this change I see the NullPointerException on SR8 as well as Sun JDK 1.6, so I think this is definitely a Derby bug and not a JVM issue as I first thought.  There may be SR9 changes so that they don't use a thread local copy where they can, but I don't think that they are required to do so, they just have that option.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-01-20T20:04:47.331+0000","updated":"2011-01-20T20:04:47.331+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12495625/comment/12984426","id":"12984426","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Here is the patch to ensure just a single read of xc in Xact.getContextId(). Running tests...\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-01-20T21:51:41.904+0000","updated":"2011-01-20T21:51:41.904+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12495625/comment/12986687","id":"12986687","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"ported this back as far as 10.3.  I am sure it exists back to 10.1, but won't bother for now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-01-25T21:18:06.777+0000","updated":"2011-01-25T21:18:06.777+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12495625/comment/13685351","id":"13685351","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"[bulk update] Close all resolved issues that haven't been updated for more than one year.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-06-17T09:19:46.321+0000","updated":"2013-06-17T09:19:46.321+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4973/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06jjb:"}}
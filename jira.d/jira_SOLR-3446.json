{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12554410","self":"https://issues.apache.org/jira/rest/api/latest/issue/12554410","key":"SOLR-3446","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310230","id":"12310230","key":"SOLR","name":"Solr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310230&avatarId=22151","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310230&avatarId=22151","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310230&avatarId=22151","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310230&avatarId=22151"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314992","id":"12314992","description":"Alpha release of 4.x series","name":"4.0-ALPHA","archived":false,"released":true,"releaseDate":"2012-07-03"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-05-25 02:25:43.182","customfield_12312323":null,"customfield_12310420":"238652","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1388863252_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-05-25T02:25:43.136+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-3446/watchers","watchCount":0,"isWatching":false},"created":"2012-05-09T00:37:59.981+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317876","id":"12317876","description":"Major release after 3.4","name":"3.5","archived":false,"released":true,"releaseDate":"2011-11-27"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-10T10:39:07.624+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[],"timeoriginalestimate":null,"description":"Solr sometimes crashes with an unhelpful stack trace.  If the PatternTokenizerFactory's \"pattern\" attribute is set to an invalid regular expression, a PatternSyntaxException is thrown and Solr fails to start. The PatternSyntaxException is not useful to users in diagnosing the error. I think it would be better to report a detailed error message. The attached patch makes this change.\r\n\r\nNote that the patch adds a small RegexUtil class with helper methods to determine whether a String is a valid regular expression and to generate error messages for invalid regular expressions. I feel that these helper methods are more readable than catching the PatternSyntaxException. Furthermore, they can be re-used if more bugs like this one are found.\r\n\r\nSteps to reproduce:\r\n\r\n# Patch in bug.patch\r\n#* Note that this sets PatternTokenizerFactory's pattern attribute to an invalid regular expression.\r\n# Run 'ant run-example' from the solr folder\r\n# See exception in console output on startup:\r\n\r\n{code}\r\nApr 3, 2012 2:07:29 PM org.apache.solr.common.SolrException log\r\nSEVERE: java.util.regex.PatternSyntaxException: Unclosed group near index 1\r\n(\r\n ^\r\n       at java.util.regex.Pattern.error(Pattern.java:1713)\r\n       at java.util.regex.Pattern.accept(Pattern.java:1571)\r\n       at java.util.regex.Pattern.group0(Pattern.java:2533)\r\n       at java.util.regex.Pattern.sequence(Pattern.java:1806)\r\n       at java.util.regex.Pattern.expr(Pattern.java:1752)\r\n       at java.util.regex.Pattern.compile(Pattern.java:1460)\r\n       at java.util.regex.Pattern.<init>(Pattern.java:1133)\r\n       at java.util.regex.Pattern.compile(Pattern.java:847)\r\n       at org.apache.solr.analysis.PatternTokenizerFactory.init(PatternTokenizerFactory.java:90)\r\n       at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:901)\r\n       at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:890)\r\n       at org.apache.solr.util.plugin.AbstractPluginLoader.load(AbstractPluginLoader.java:148)\r\n       at org.apache.solr.schema.IndexSchema.readAnalyzer(IndexSchema.java:910)\r\n       at org.apache.solr.schema.IndexSchema.access$100(IndexSchema.java:62)\r\n       at org.apache.solr.schema.IndexSchema$1.create(IndexSchema.java:450)\r\n       at org.apache.solr.schema.IndexSchema$1.create(IndexSchema.java:435)\r\n       at org.apache.solr.util.plugin.AbstractPluginLoader.load(AbstractPluginLoader.java:140)\r\n       at org.apache.solr.schema.IndexSchema.readSchema(IndexSchema.java:480)\r\n       at org.apache.solr.schema.IndexSchema.<init>(IndexSchema.java:125)\r\n       at org.apache.solr.core.CoreContainer.create(CoreContainer.java:461)\r\n       at org.apache.solr.core.CoreContainer.load(CoreContainer.java:316)\r\n       at org.apache.solr.core.CoreContainer.load(CoreContainer.java:207)\r\n       at org.apache.solr.core.CoreContainer$Initializer.initialize(CoreContainer.java:130)\r\n       at org.apache.solr.servlet.SolrDispatchFilter.init(SolrDispatchFilter.java:94)\r\n       at org.mortbay.jetty.servlet.FilterHolder.doStart(FilterHolder.java:97)\r\n       at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)\r\n       at org.mortbay.jetty.servlet.ServletHandler.initialize(ServletHandler.java:713)\r\n       at org.mortbay.jetty.servlet.Context.startContext(Context.java:140)\r\n       at org.mortbay.jetty.webapp.WebAppContext.startContext(WebAppContext.java:1282)\r\n       at org.mortbay.jetty.handler.ContextHandler.doStart(ContextHandler.java:518)\r\n       at org.mortbay.jetty.webapp.WebAppContext.doStart(WebAppContext.java:499)\r\n       at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)\r\n       at org.mortbay.jetty.handler.HandlerCollection.doStart(HandlerCollection.java:152)\r\n       at org.mortbay.jetty.handler.ContextHandlerCollection.doStart(ContextHandlerCollection.java:156)\r\n       at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)\r\n       at org.mortbay.jetty.handler.HandlerCollection.doStart(HandlerCollection.java:152)\r\n       at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)\r\n       at org.mortbay.jetty.handler.HandlerWrapper.doStart(HandlerWrapper.java:130)\r\n       at org.mortbay.jetty.Server.doStart(Server.java:224)\r\n       at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)\r\n       at org.mortbay.xml.XmlConfiguration.main(XmlConfiguration.java:985)\r\n       at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n       at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\r\n       at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\r\n       at java.lang.reflect.Method.invoke(Method.java:597)\r\n       at org.mortbay.start.Main.invokeMain(Main.java:194)\r\n       at org.mortbay.start.Main.start(Main.java:534)\r\n       at org.mortbay.start.Main.start(Main.java:441)\r\n       at org.mortbay.start.Main.main(Main.java:119)\r\n{code}\r\n\r\n4. Visit http://localhost:8983/solr/admin/ and see a similar message:\r\n\r\n{code}\r\nHTTP ERROR 500\r\n\r\nProblem accessing /solr/admin/. Reason:\r\n\r\n    Severe errors in solr configuration.\r\n\r\nCheck your log files for more detailed information on what may be wrong.\r\n\r\nIf you want solr to continue after configuration errors, change: \r\n\r\n <abortOnConfigurationError>false</abortOnConfigurationError>\r\n\r\nin solr.xml\r\n\r\n...\r\n\r\n-------------------------------------------------------------\r\njava.util.regex.PatternSyntaxException: Unclosed group near index 1\r\n(\r\n ^\r\n       at java.util.regex.Pattern.error(Pattern.java:1713)\r\n       at java.util.regex.Pattern.accept(Pattern.java:1571)\r\n       at java.util.regex.Pattern.group0(Pattern.java:2533)\r\n       at java.util.regex.Pattern.sequence(Pattern.java:1806)\r\n       at java.util.regex.Pattern.expr(Pattern.java:1752)\r\n       at java.util.regex.Pattern.compile(Pattern.java:1460)\r\n       at java.util.regex.Pattern.<init>(Pattern.java:1133)\r\n       at java.util.regex.Pattern.compile(Pattern.java:847)\r\n       at org.apache.solr.analysis.PatternTokenizerFactory.init(PatternTokenizerFactory.java:90)\r\n       at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:901)\r\n       at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:890)\r\n       at org.apache.solr.util.plugin.AbstractPluginLoader.load(AbstractPluginLoader.java:148)\r\n...\r\n{code}\r\n\r\nAfter applying the patch, the following is printed to the console:\r\n\r\n{code}\r\nSEVERE: org.apache.solr.common.SolrException: invalid \"pattern\" regular expression for PatternTokenizerFactory: Unclosed group near index 1\r\n(\r\n ^\r\n    at org.apache.solr.analysis.PatternTokenizerFactory.init(PatternTokenizerFactory.java:90)\r\n    at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:901)\r\n    at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:890)\r\n    at org.apache.solr.util.plugin.AbstractPluginLoader.load(AbstractPluginLoader.java:148)\r\n...\r\n{code}\r\n\r\nAnd the following similar message is shown when visiting http://localhost:8983/solr/admin/ :\r\n\r\n{code}\r\nHTTP ERROR 500\r\n\r\nProblem accessing /solr/admin/. Reason:\r\n\r\n    Severe errors in solr configuration.\r\n\r\nCheck your log files for more detailed information on what may be wrong.\r\n\r\nIf you want solr to continue after configuration errors, change: \r\n\r\n <abortOnConfigurationError>false</abortOnConfigurationError>\r\n\r\nin solr.xml\r\n\r\n...\r\n\r\n-------------------------------------------------------------\r\norg.apache.solr.common.SolrException: invalid \"pattern\" regular expression for PatternTokenizerFactory: Unclosed group near index 1\r\n(\r\n ^\r\n       at org.apache.solr.analysis.PatternTokenizerFactory.init(PatternTokenizerFactory.java:90)\r\n       at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:901)\r\n       at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:890)\r\n       at org.apache.solr.util.plugin.AbstractPluginLoader.load(AbstractPluginLoader.java:148)\r\n...\r\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"17804","summary":"PatternSyntaxException Crash from Unvalidated Regular Expression Usage","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espishak","name":"espishak","emailAddress":"espishak at cs dot washington dot edu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Spishak","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=espishak","name":"espishak","emailAddress":"espishak at cs dot washington dot edu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Spishak","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":1,"total":1,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12554410/comment/13282988","id":"13282988","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"body":"\r\nEric: I'm not really a fan of the \"isRegex\" and \"regexError\" utilities you proposed in your patch, because they throw away info about the details of the exception, and require redundant calls to Pattern.compile in situations where it's known that Pattern.compile is going to fail.\r\n\r\nBut the crux of your bug report is spot on -- PatternTokenizerFactory was dealing with the pattern init param poorly, and should have been following the model used in PatternReplaceCharFilterFactory and PatternReplaceFilterFactory -- however even with those, the general plugin loading mechanism wasn't doing a very good job of drawing attention to where exactly the problem was.\r\n\r\nSo i've committed a fix that:\r\n* refactors those three factories to use a common \"getPattern\" method in the base class\r\n* improves AbstractPluginLoader to include the name of the plugin that had a problem (if known)\r\n\r\nCommitted revision 1342489.\r\n\r\nthanks for opening the bug and drawing attention to this!\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"created":"2012-05-25T02:25:43.182+0000","updated":"2012-05-25T02:25:43.182+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-3446/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i03emv:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12515629","self":"https://issues.apache.org/jira/rest/api/latest/issue/12515629","key":"DERBY-5357","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2012-03-02 01:31:04.859","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24794","customfield_12310222":"3_*:*_1_*:*_1589604010_*|*_1_*:*_1_*:*_18798695699_*|*_6_*:*_1_*:*_4236645246_*|*_5_*:*_2_*:*_10909266325_*|*_4_*:*_1_*:*_61010","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-09-11T18:19:49.877+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5357/watchers","watchCount":1,"isWatching":false},"created":"2011-07-28T11:41:57.602+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":["derby_backport_reject_10_8","derby_triage10_9"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"12.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-06-17T09:27:20.935+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"When installing a jar file with the SQLJ.INSTALL_JAR procedure, it will copy the jar file to a subdirectory of the database directory. The name of the stored jar file is based on the qualified name specified by the second parameter in the procedure, and becomes something like: <DBDIR>/jar/<SCHEMA>/<JAR_NAME>.jar.<VERSION>\r\n\r\nThis naming scheme is problematic because the qualified name of the jar file is an SQL identifier and may contain any characters, also characters with special meaning to the underlying file system.\r\n\r\nOne example is this call:\r\n\r\nij> call sqlj.install_jar('/path/to/toursdb.jar', 'APP.\"../../../x/jar\"', 0);\r\n0 rows inserted/updated/deleted\r\n\r\nOn Unix-like systems, this will install the jar in a subdirectory of the database directory's parent directory, which is clearly unfortunate as the database directory should be self-contained (an assumption used when taking backup of a database using operating system commands, or when moving the database to another location).\r\n\r\nThere's probably also a possibility that INSTALL_JAR fails if the identifier contains a character that's not allowed in file names on the platform.\r\n\r\nIt would be better if the jars were stored in a file whose name is independent of the identifier used, so that any valid SQL identifier could be used to name a jar file in the database without causing problems.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10361","value":"Security","id":"10361"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"35462","summary":"SQLJ.INSTALL_JAR shouldn't use identifier as file name","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":23,"total":23,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13220579","id":"13220579","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Uploading a patch which replaces '/' or '\\' with underscore when mapping SQL identifiers (schema, jarname) to filename.  The patch introduces a new method in FileUtil: sanitizeSqlIdAsFilename\r\n\r\nFrom its Javadoc: \"Since quoted SQL identifiers may contain any character, we cannot use an SQL identifier as a file name unconditionally. Return a safe (unexploitable) file name by replacing '/' or '\\' with underscore, so one can't access a non-intended directory. <em>Note</em>: we need to replace both to make database portable from Windows to *nix or vice versa.\"\r\n\r\nI don't think we need any upgrade logic here: It seems very unlikely anybody relies on this error. If they do, e.g. a '/' on a Windows system, the workaround is simple, just rename the affected jars. \r\n\r\nNo tests yet beyond manual, running regressions.\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-02T01:31:04.859+0000","updated":"2012-03-02T01:31:04.859+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13220581","id":"13220581","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Changing urgency to normal and ticking the security flag.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-02T01:33:12.852+0000","updated":"2012-03-02T01:33:12.852+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13220974","id":"13220974","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Hi Dag,\r\n\r\nI agree that this vulnerability should be fixed. I believe that these identifiers are used by\r\n\r\n1) sqlj_install_jar\r\n\r\n2) sqlj.remove_jar\r\n\r\n3) sqlj.replace_jar\r\n\r\n4) and in the database classpaths bound to the derby.database.classpath property\r\n\r\nUnfortunately, I believe that your patch can break (2) and (3) for jar files which were stored prior to release 10.9. I don't think that the patch addresses (4).\r\n\r\nHere are some other approaches to consider:\r\n\r\nA) Raise an error if the identifier passed to sqlj.install_jar contains suspicious characters.\r\n\r\nB) Don't touch the identifier stored in SYSFILES.FILENAME. Instead, your regular transformation could be applied to FILENAME at the last possible moment when the file is actually copied, dropped, replaced, or included on the classpath. This approach would need to be used only for jar files which were installed or replaced by 10.9 or later. That, in turn, would require tagging jar files with version information. It might be possible to encode that information in SYSFILES.GENERATIONID.\r\n\r\nC) This is a variation on (B). Build the copied file name from SYSSCHEMAS.SCHEMAID and SYSFILES.FILEID rather than SYSSCHEMAS.SCHEMANAME and SYSFILES.FILENAME. Again, this could only be done for jar files installed/replaced by 10.9 and later releases and would also require some way of tagging the file with a Derby version number.\r\n\r\nThanks,\r\n-Rick\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-03-02T15:04:06.474+0000","updated":"2012-03-02T15:04:06.474+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13221034","id":"13221034","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Thanks, Rick. \"Instead, your regular transformation could be applied to FILENAME at the last possible moment when the file is actually copied, dropped, replaced, or included on the classpathInstead, your regular transformation could be applied to FILENAME at the last possible moment when the file is actually copied, dropped, replaced, or included on the classpath\" That's what I had in mind ;-) I'll research some more.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-02T16:32:52.066+0000","updated":"2012-03-02T16:32:52.066+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13221048","id":"13221048","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"ij> select * from sys.sysfiles;\r\nFILEID                              |SCHEMAID                            |FILENAME                                                                                                                        |GENERATIONID        \r\n-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n08264012-0135-d0d5-9c5b-0000070b2ff0|80000000-00d2-b38f-4cda-000a0a412c00|../../../x/jar \r\n\r\nI think my code doesn't modify the FILENAME in SYSFILE, cf the select above. Here is the contents of the jar dir in wombat:\r\n\r\n/export/home/dag/wombat/jar/APP:\r\n  total used in directory 390 available 10570418\r\n  :\r\n  -rw-r--r-- 1 dag staff 273331 2012-03-02 01:40 .._.._.._x_jar.jar.G1330648558257\r\n\r\nThis mapping would would for all the three sqlj.* stored procs I believe. I'll look some more at your case 4).\r\n\r\nA problem with my approach is, as you say, that if (and only if) '/' or '\\' were used in in a SQL id for a jar an old release, it would fail on upgrade: the jar would not be found.\r\n\r\nAnother problem is that the mapping in the patch is effectively a hash: there maybe be a chance of collision, e.g. identifiers \"a_b\" and \"a/b\" would both map to filename \"a_b\". ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-02T16:56:13.122+0000","updated":"2012-03-02T16:56:13.122+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13221138","id":"13221138","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Btw, Rick's case 4) would be covered by the patch with the change to JarUtil.mkExternalName, too. [UpdateLoader#initializeFromClasspath -> JarLoader#initialize- > BasicDatabase#getJarFile -> mkExternalName]. But the patch is obviously lacking: we need to tackle the unique mapping problem as well as the upgrade problem, since existing usages of file separators in SQL ids could have been bona fide, e.g. : \"a/b\", although unlikely as an SQL name, would have worked just fine earlier and should not break on upgrade.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-02T18:39:38.355+0000","updated":"2012-03-02T18:39:38.355+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13221268","id":"13221268","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I think we should consider upgrade problems, even if the previous usage was unlikely.  I suggest that any new naming/finding\r\nscheme be limited to hard upgraded databases, otherwise a user going back to a previous version may \"lose\" their jars.\r\n\r\nIt would be cleaner if somehow a version could be associated with the naming, but I think you still need to maintain the old naming search for old versions.  And unless you do some sort of renaming for all existing dbs on hard upgrade, you probably\r\nneed to run both naming schemes in hard upgraded dbs.\r\n\r\nCould somehow the new naming map a new jar to a different \"old naming\" file?  This could lead to removing the wrong jar.  This\r\nis sort of the hashing problem but from new to old rather than new to new.\r\n\r\nIt seems like hashing where 2 filenames can collide to a single is a problem, as rick points out.  You could eliminate part of the backward compatibility problems by making new databases use a naming scheme that could never collide with with old databases.\r\nMaybe a new directory (jar2 ?) for new jars in new databases, or maybe there is somethink that could not have been a valid\r\nSQL identifier and thus could not have been an old filename (would adding a number at the beginning of the filename work?)  \r\n\r\nIs basing the new name on the old name a good idea still, maybe\r\nthere should just be a mapping in a catalog to a guaranteed new name, like a uuid or a sequence number.  \r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-03-02T21:14:10.422+0000","updated":"2012-03-02T21:14:10.422+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13222431","id":"13222431","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Thanks, Mike and Rick! \r\nI bit the bullet. Uploading a new proof-of-concept patch which introduces a new naming scheme, with full upgrade of old jar file storage at hard upgrade time. At soft upgrade time, the old code is still used. Still haven't written tests. I have done away with the schema subdirectories altogether and base the new scheme on uuids:\r\n\r\nOld style file name:   jar/<schema>/<name>.jar.<version>\r\nNew style file name:  jar/<uuid>-<safe schema>-<safe name>.jar.<version>\r\n\r\nI included schema and name (sanitized) in the name for ease of debugging. Perhaps we might remove that if we fear users manually tampering with the stored jars..\r\n\r\nRunning regressions.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-05T16:19:30.468+0000","updated":"2012-03-05T16:19:30.468+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13222442","id":"13222442","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I see that the patch uses String.replaceAll(). That method isn't available on CDC/FP. Will that be a problem?\r\n\r\nI'd prefer that we did not include <safe schema> and <safe name> in the file name, as they're not needed and I'm not sure we can guarantee that they are really safe. We remove / and \\ from the identifiers, but do we know that there are no other characters that have a special meaning in some file system?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2012-03-05T16:44:00.509+0000","updated":"2012-03-05T16:44:00.509+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13222444","id":"13222444","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"diffstat and detailed patch comments (derby-5357-2):\r\n\r\n impl/sql/execute/JarUtil.java                    |  153 +++++++++++++++++++++--\r\n impl/sql/catalog/DataDictionaryImpl.java         |   85 ++++++++++++\r\n impl/store/raw/RawStore.java                     |   57 ++++++--\r\n iapi/sql/dictionary/DataDescriptorGenerator.java |   38 +++--\r\n iapi/services/io/FileUtil.java                   |   16 ++\r\n iapi/store/access/FileResource.java              |    5 \r\n impl/db/BasicDatabase.java                       |    3 \r\n impl/sql/catalog/DD_Version.java                 |    7 +\r\n impl/store/raw/data/RFResource.java              |    8 +\r\n\r\nM java/engine/org/apache/derby/impl/sql/execute/JarUtil.java\r\n\r\nmkExternalName now always takes uuid as argument. \r\n\r\nNew methods: \r\n   - mkExternalNameInternal: used during upgrade to be able to construct both old an new style names\r\n   - upgradeJar: upgrade one jar file to new style (>= 10.9)\r\n   - removeOldDirs: Upgrade code: Remove the old directories names with contents (pre-10.9 style).\r\n\r\nM java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java\r\n\r\nNew methods:\r\n   - getAllSysfileDescriptors: used by upgrade code: Return a list of all {@FileInfoDescriptor}s in SYSFILES scan.\r\n   - upgradeJarStorage: used by upgrade code. Called by the upgrade code to upgrade the way we store jar files in the database. We now use UUID as part of the file name and sanitize the SQL (schema, schema object) parts of the file name to avoid problems with path delimiters. Also, we henceforth use no schema subdirectories since there is no chance of name collision with the UUID.\r\n\r\nM java/engine/org/apache/derby/impl/store/raw/RawStore.java\r\n\r\nModified backup code to handle new as well as old scheme (in soft\r\nupgrade mode).\r\n\r\n\r\nM java/engine/org/apache/derby/iapi/services/io/FileUtil.java\r\n\r\nNew method:\r\n   - sanitizeSqlIdAsFilename: Since quoted SQL identifiers may contain any character, we cannot use an SQL identifier as a file name unconditionally. Return a safe (unexploitable) file name by replacing '/' or '\\' with underscore, so one can't access a non-intended directory. <em>Note</em>: we need to replace both to make database portable from Windows to *nix or vice versa.\r\n\r\n\r\nM java/engine/org/apache/derby/iapi/store/access/FileResource.java\r\nM java/engine/org/apache/derby/impl/store/raw/data/RFResource.java\r\n\r\n\r\nNew method:\r\n   - getAsFile(String name) to be able to delete old directories during upgrade.\r\n\r\n\r\nM java/engine/org/apache/derby/impl/sql/catalog/DD_Version.java\r\n\r\nAdd a line to call upgradeJarStorage when hard upgrading\r\n\r\n\r\nM java/engine/org/apache/derby/impl/db/BasicDatabase.java\r\n\r\nInterface adjustment.\r\n\r\nM java/engine/org/apache/derby/iapi/sql/dictionary/DataDescriptorGenerator.java\r\n\r\ninterface adjustment\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-05T16:45:23.816+0000","updated":"2012-03-05T16:45:23.816+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13222448","id":"13222448","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Thanks Knut, You are probably right about replaceAll. As far as other characters, I believe there are at least illegal characters in some file systems that could be seen to give issues, but so could too possible too large an identifier, although probably Derby's maximum identifier length makes our names small enough (16 + 1 + 128 + 1 + 128 + 4 (.jar) +  2 (.G) + maxDigits(long) is still quite a bit....). We could map only alphanumeric perhaps. I tend to agree with you, better remove that part of the name altogether. That removes the replaceAll issue, too.. ;-)\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-05T16:56:24.708+0000","updated":"2012-03-05T16:56:24.708+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13224936","id":"13224936","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Uploading an enlarged version of this patch with upgrade logic and upgrade tests, and updates to dblook (dblook tests failed before with the new scheme).\r\n\r\nNote: the new code in RawStore had to accommodate the weird test in BackupPathTests.jar, which somewhat worryingly backs up <db> to <db>/jar (gave a recursion problem in the new code).\r\n\r\nI still have not removed the sanitized schema and SQL object names from the file name of the jar, nor the regexp code unwanted for CDC, but will do so in a final increment.\r\n\r\nRegressions passed.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-08T02:05:09.624+0000","updated":"2012-03-08T02:16:33.584+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13227416","id":"13227416","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Uploading a hopefully complete version of the patch. This now has dropped the schema/SQL object name in the file name of the stored jar file, and also gets rid of the non-CDC compliant regexp code, Changes10_9 swings its own mini regexp matcher instead.. Regressions passed. Please review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-12T10:44:23.010+0000","updated":"2012-03-12T10:44:23.010+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13227460","id":"13227460","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"During full upgrade we remove the old jar directory before the new dictionary information is committed. Could this cause problems if the database crashes during upgrade (after removal of old jar dir and before committing the upgrade transaction)?\r\n\r\nDataDictionaryImpl.getAllSysfileDescriptors() builds a list of all the rows in SYSFILES. Could this cause memory problems during upgrade if SYSFILES is huge? Would it be safer to combine getAllSysfileDescriptors() and upgradeJarStorage() into a single method so that we don't need the intermediate list? (What you really want is lambda expressions, right? ;)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2012-03-12T12:28:32.528+0000","updated":"2012-03-12T12:28:32.528+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13228349","id":"13228349","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Thanks, Knut!\r\n\r\n> Could this cause problems if the database crashes during upgrade (after removal of old jar dir and before committing the upgrade transaction)\r\n\r\nYes, it could. I thought of leaving the old jar dirs in place, but that may be no desirable either. I see SQLJ.REMOVE_JAR holds off the physical removal till transaction commit time, maybe I can do something similar during upgrade boot.\r\n\r\n> Could this cause memory problems during upgrade if SYSFILES is huge\r\n\r\nIn theory, sure. There is precedent code using this idiom in DataDictionaryImpl, but you're right, I could easily merge the two methods to avoid the issue altogether.\r\n\r\nI also found that the upgrade test code which tests the upgraded jars with \"CALL EMC.ADDCONTACT\" won't run under CDC/JSR169 (nested connection requires DriverManager), so I'll just skip that part of the test on that platform.\r\n\r\nI'll spin a new rev.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-13T12:13:12.085+0000","updated":"2012-03-13T19:43:26.184+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13228633","id":"13228633","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Uploading derby-5357-with-tests-3 to handle the three issues mention above. Rerunning regressions.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-13T19:35:27.344+0000","updated":"2012-03-13T19:35:27.344+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13228638","id":"13228638","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"A comment on the transaction safety of the removal of the old style jar files (and directories): We now schedule the removal as post-commit work, cf. the new method {FileREsource/RFResource}#removeJarDir. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-13T19:42:39.862+0000","updated":"2012-03-13T19:42:39.862+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13229119","id":"13229119","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Regressions passed. I'll look to commit the patch by end of Friday CET unless there are further comments. Does this issue require a release note? We do change the internal storage format in a way that is visible to the user looking inside the \"jar\" directory, but then again, I don't believe that is/should be documented?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-14T10:22:10.231+0000","updated":"2012-03-14T10:22:10.231+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13229140","id":"13229140","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"With the patch, dblook doesn't work with databases that have been soft-upgraded to 10.9 if they contain jar files. dblook.log says:\r\n\r\n-- **--> DEBUG: Failed to load jar file /tmp/jartest/DBJARS/23ce809c-0136-10ee-5e54-0000037b37f8.jar.G1331723919074\r\njava.io.FileNotFoundException: db/jar/23ce809c-0136-10ee-5e54-0000037b37f8.jar.G1331723919074 (No such file or directory)\r\n\tat java.io.FileInputStream.open(Native Method)\r\n\tat java.io.FileInputStream.<init>(FileInputStream.java:120)\r\n\tat java.io.FileInputStream.<init>(FileInputStream.java:79)\r\n\tat org.apache.derby.impl.tools.dblook.DB_Jar.doJars(DB_Jar.java:98)\r\n\tat org.apache.derby.tools.dblook.go(dblook.java:533)\r\n\tat org.apache.derby.tools.dblook.<init>(dblook.java:142)\r\n\tat org.apache.derby.tools.dblook.main(dblook.java:97)\r\n\tat org.apache.derby.iapi.tools.run.main(run.java:57)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2012-03-14T11:58:30.731+0000","updated":"2012-03-14T11:58:30.731+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13230356","id":"13230356","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Thanks for spotting that, Knut. Uploading rev #4 which addresses this problem. I believe we don't have tests that stress dblook in a soft upgrade mode, so this is a hole we may want to address. I tested it manually Rerunning regressions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-15T17:48:18.097+0000","updated":"2012-03-15T17:51:21.765+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13233348","id":"13233348","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Committed patch derby-5357-with-tests-4 as svn 1302836, resolving. Not planning to backport this since it changes the database format.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-03-20T11:06:30.928+0000","updated":"2012-03-20T11:06:30.928+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13453251","id":"13453251","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Reopening to label as not appropriate for backport to 10.8\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-09-11T18:18:48.872+0000","updated":"2012-09-11T18:18:48.872+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515629/comment/13453253","id":"13453253","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Reresolving. Issue not backportable to 10.8 because of database format change","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-09-11T18:19:49.890+0000","updated":"2012-09-11T18:19:49.890+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5357/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06flr:"}}
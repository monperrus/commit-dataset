{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12606296","self":"https://issues.apache.org/jira/rest/api/latest/issue/12606296","key":"SOLR-3793","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310230","id":"12310230","key":"SOLR","name":"Solr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310230&avatarId=22151","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310230&avatarId=22151","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310230&avatarId=22151","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310230&avatarId=22151"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12322551","id":"12322551","description":"First major release from the 4.x branch: http://svn.apache.org/viewvc/lucene/dev/branches/branch_4x/","name":"4.0","archived":false,"released":true,"releaseDate":"2012-10-12"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-09-06 11:41:50.189","customfield_12312323":null,"customfield_12310420":"243197","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_55482681_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-09-06T12:36:22.727+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-3793/watchers","watchCount":5,"isWatching":false},"created":"2012-09-05T21:11:40.058+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.png","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12322455","id":"12322455","description":"Beta release after 4.0-ALPHA","name":"4.0-BETA","archived":false,"released":true,"releaseDate":"2012-08-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-10T10:33:46.362+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[],"timeoriginalestimate":null,"description":"Günter Hipler reported on the solr-user mailing list that he was seeing inconsistencies in facet counts compared to the numFound when drilling down onto those facets (using \"fq\") - in particular: when adding an \"fq\" such as `fq={!term+f%3DnavNetwork}nebis`, the resulting numFound was higher then the number of docs reported by the facet constraint for nebis in the base request.\r\n\r\nI've been able to trivially reproduce this using the example data from Solr 4.0-BETA, trunk@r1381400, and branch_4x@r1381400 (details in comment to follow)\r\n\r\nImportant things to note from Günter's email thread with his assessment of the problem...\r\n\r\nhttps://mail-archives.apache.org/mod_mbox/lucene-solr-user/201208.mbox/%3CCAM_U7jfDpNrGfmWmNtNACHCDCJw4YB-rLBBvRW_WP_jdOb_cgw@mail.gmail.com%3E\r\n\r\nbq. The behaviour is not consistent. Some of the facets provide the correct result, some not.  What I can't say for sure: The behaviour was correct (if I'm not wrong) once the whole index was newly created. After running some updates I got these results.\r\n\r\nbq. I'm going to setup a new index with the Lucene 4.0 version from March (to be more exactly: it's version 4.0-2012-03-09_11-29-20) to see what are the results even in case of frequent updates ... the version deployed in march doesn't contain the error I now come across in Beta4.0 \r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"17474","summary":"duplicate (deleted) documents included in result set when using field faceting with fq","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":8,"total":8,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606296/comment/13449140","id":"13449140","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"body":"Steps to reproduce...\r\n\r\n\r\n{panel}\r\n\r\n1) Start with a clean install of 4.0-BETA, containing a completley empty example index, and run solr...\r\n\r\n{noformat}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example$ ls -a solr/collection1/data/\r\n.  ..\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example$ java -jar start.jar \r\n2012-09-05 12:59:56.596:INFO:oejs.Server:jetty-8.1.2.v20120308\r\n...\r\n{noformat}\r\n\r\n2) In another window, index all sample documents...\r\n\r\n{noformat}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ java -jar post.jar *.xml\r\n...\r\n{noformat}\r\n\r\n3) Observe the results of a simple query faceting on \"cat\", as well as the results of filtering on one of those cat values...\r\n\r\n{noformat}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":2},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  },\r\n  \"facet_counts\":{\r\n    \"facet_queries\":{},\r\n    \"facet_fields\":{\r\n      \"cat\":[\r\n        \"electronics\",3,\r\n        \"connector\",2,\r\n        \"music\",1]},\r\n    \"facet_dates\":{},\r\n    \"facet_ranges\":{}}}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true&fq=cat:electronics'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":8},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  },\r\n  \"facet_counts\":{\r\n    \"facet_queries\":{},\r\n    \"facet_fields\":{\r\n      \"cat\":[\r\n        \"electronics\",3,\r\n        \"connector\",2,\r\n        \"music\",1]},\r\n    \"facet_dates\":{},\r\n    \"facet_ranges\":{}}}\r\n{noformat}\r\n\r\n4) Re-index some of the sample documents, forcing a new segment to be created, as well as some deletions...\r\n\r\n{noformat}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ java -jar post.jar ipod_*S\r\n...\r\n{noformat}\r\n\r\n5) observe that while the \"simple\" results are unchanged, the filtered request now includes duplicate (deleted?) documents in the result set...\r\n\r\n{noformat}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":2},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  },\r\n  \"facet_counts\":{\r\n    \"facet_queries\":{},\r\n    \"facet_fields\":{\r\n      \"cat\":[\r\n        \"electronics\",3,\r\n        \"connector\",2,\r\n        \"music\",1]},\r\n    \"facet_dates\":{},\r\n    \"facet_ranges\":{}}}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true&fq=cat:electronics'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":2},\r\n  \"response\":{\"numFound\":6,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  },\r\n  \"facet_counts\":{\r\n    \"facet_queries\":{},\r\n    \"facet_fields\":{\r\n      \"cat\":[\r\n        \"electronics\",3,\r\n        \"connector\",2,\r\n        \"music\",1]},\r\n    \"facet_dates\":{},\r\n    \"facet_ranges\":{}}}\r\n{noformat}\r\n\r\n{panel}\r\n\r\n\r\nInteresting things to note...\r\n\r\n1) stoping & restarting jetty does not make the problem go away, which initially suggested to me that the problem is not related to any sort of stale-caching of filters/docsets -- however if you stop & restart jetty, or even just issue a commit, and then re-issue the same two requests in reverse order, then no duplicates are included.  do another commit, send the requests in the (original) problematic order and the problem re-appears...\r\n\r\n{noformat}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true&fq=cat:electronics'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":6},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  },\r\n  \"facet_counts\":{\r\n    \"facet_queries\":{},\r\n    \"facet_fields\":{\r\n      \"cat\":[\r\n        \"electronics\",3,\r\n        \"connector\",2,\r\n        \"music\",1]},\r\n    \"facet_dates\":{},\r\n    \"facet_ranges\":{}}}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":2},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  },\r\n  \"facet_counts\":{\r\n    \"facet_queries\":{},\r\n    \"facet_fields\":{\r\n      \"cat\":[\r\n        \"electronics\",3,\r\n        \"connector\",2,\r\n        \"music\",1]},\r\n    \"facet_dates\":{},\r\n    \"facet_ranges\":{}}}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ java -Ddata=args -jar post.jar '<commit/>'SimplePostTool version 1.5\r\nPOSTing args to http://localhost:8983/solr/update..\r\nCOMMITting Solr index changes to http://localhost:8983/solr/update..\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":2},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  },\r\n  \"facet_counts\":{\r\n    \"facet_queries\":{},\r\n    \"facet_fields\":{\r\n      \"cat\":[\r\n        \"electronics\",3,\r\n        \"connector\",2,\r\n        \"music\",1]},\r\n    \"facet_dates\":{},\r\n    \"facet_ranges\":{}}}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true&fq=cat:electronics'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":3},\r\n  \"response\":{\"numFound\":6,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  },\r\n  \"facet_counts\":{\r\n    \"facet_queries\":{},\r\n    \"facet_fields\":{\r\n      \"cat\":[\r\n        \"electronics\",6,\r\n        \"connector\",4,\r\n        \"music\",1]},\r\n    \"facet_dates\":{},\r\n    \"facet_ranges\":{}}}\r\n{noformat}\r\n\r\n2) Optimizing seems to eliminate the problem completley, suggesting that the root cause is definitely related to multiple segments containing deletions.\r\n\r\n3) Bizarely, the problem seems to be specific to faceting: using the same steps, with the same simple queries & fq, but leaving out the facet params, the duplicate documents are not returned...\r\n\r\n{noformat}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ java -jar post.jar *.xml\r\n...\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&wt=json&indent=true'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":13},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  }}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&wt=json&indent=true&fq=cat:electronics'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":10},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  }}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ java -jar post.jar ipod_*\r\n...\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&wt=json&indent=true'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":2},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  }}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&wt=json&indent=true&fq=cat:electronics'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":3},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  }}\r\n{noformat}\r\n\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"created":"2012-09-05T21:13:26.495+0000","updated":"2012-09-05T21:13:26.495+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606296/comment/13449163","id":"13449163","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"body":"The problem seems to be specific to using UnInvertedField via facet.method=fc for faceting, but only if you have not already used facet.method=enum (no idea how using UnInvertedField during the faceting could affect the total result set)...\r\n\r\n{noformat}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ java -Ddata=args -jar post.jar '<commit/>'\r\nSimplePostTool version 1.5\r\nPOSTing args to http://localhost:8983/solr/update..\r\nCOMMITting Solr index changes to http://localhost:8983/solr/update..\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&facet.method=enum&wt=json&indent=true'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":4},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  },\r\n  \"facet_counts\":{\r\n    \"facet_queries\":{},\r\n    \"facet_fields\":{\r\n      \"cat\":[\r\n        \"electronics\",3,\r\n        \"connector\",2,\r\n        \"music\",1]},\r\n    \"facet_dates\":{},\r\n    \"facet_ranges\":{}}}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&facet.method=enum&wt=json&indent=true&fq=cat:electronics'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":3},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  },\r\n  \"facet_counts\":{\r\n    \"facet_queries\":{},\r\n    \"facet_fields\":{\r\n      \"cat\":[\r\n        \"electronics\",3,\r\n        \"connector\",2,\r\n        \"music\",1]},\r\n    \"facet_dates\":{},\r\n    \"facet_ranges\":{}}}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&facet.method=fc&wt=json&indent=true'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":3},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  },\r\n  \"facet_counts\":{\r\n    \"facet_queries\":{},\r\n    \"facet_fields\":{\r\n      \"cat\":[\r\n        \"electronics\",3,\r\n        \"connector\",2,\r\n        \"music\",1]},\r\n    \"facet_dates\":{},\r\n    \"facet_ranges\":{}}}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&facet.method=fc&wt=json&indent=true&fq=cat:electronics'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":1},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  },\r\n  \"facet_counts\":{\r\n    \"facet_queries\":{},\r\n    \"facet_fields\":{\r\n      \"cat\":[\r\n        \"electronics\",3,\r\n        \"connector\",2,\r\n        \"music\",1]},\r\n    \"facet_dates\":{},\r\n    \"facet_ranges\":{}}}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ java -Ddata=args -jar post.jar '<commit/>'SimplePostTool version 1.5\r\nPOSTing args to http://localhost:8983/solr/update..\r\nCOMMITting Solr index changes to http://localhost:8983/solr/update..\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&facet.method=fc&wt=json&indent=true'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":5},\r\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  },\r\n  \"facet_counts\":{\r\n    \"facet_queries\":{},\r\n    \"facet_fields\":{\r\n      \"cat\":[\r\n        \"electronics\",3,\r\n        \"connector\",2,\r\n        \"music\",1]},\r\n    \"facet_dates\":{},\r\n    \"facet_ranges\":{}}}\r\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&facet.method=fc&wt=json&indent=true&fq=cat:electronics'\r\n{\r\n  \"responseHeader\":{\r\n    \"status\":0,\r\n    \"QTime\":2},\r\n  \"response\":{\"numFound\":6,\"start\":0,\"docs\":[\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"IW-02\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"F8V7067-APL-KIT\"},\r\n      {\r\n        \"id\":\"MA147LL/A\"}]\r\n  },\r\n  \"facet_counts\":{\r\n    \"facet_queries\":{},\r\n    \"facet_fields\":{\r\n      \"cat\":[\r\n        \"electronics\",6,\r\n        \"connector\",4,\r\n        \"music\",1]},\r\n    \"facet_dates\":{},\r\n    \"facet_ranges\":{}}}\r\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"created":"2012-09-05T21:34:08.167+0000","updated":"2012-09-05T21:34:08.167+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606296/comment/13449170","id":"13449170","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"body":"confirmed this affects trunk & branch_4x","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hossman","name":"hossman","emailAddress":"hossman_apachejira at fucit dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hossman&avatarId=21247","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hossman&avatarId=21247","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hossman&avatarId=21247","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hossman&avatarId=21247"},"displayName":"Hoss Man","active":true},"created":"2012-09-05T21:43:46.678+0000","updated":"2012-09-05T21:43:46.678+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606296/comment/13449581","id":"13449581","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"body":"Here's a patch to fix the problem.\r\n\r\nThe issue was when UnInvertedField faceting cached big terms as filters, it failed to set/use liveDocs.  Later, an \"fq\" was used that retrieved the filter from the cache and used that filter as liveDocs, bringing deleted docs back from the dead. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"created":"2012-09-06T11:41:50.189+0000","updated":"2012-09-06T11:41:50.189+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606296/comment/13449598","id":"13449598","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"body":"Committed to trunk and 4x\r\nhttp://svn.apache.org/viewvc?rev=1381568&view=rev\r\nhttp://svn.apache.org/viewvc?rev=1381569&view=rev","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yseeley%40gmail.com","name":"yseeley@gmail.com","emailAddress":"yseeley at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yonik Seeley","active":true},"created":"2012-09-06T12:36:22.737+0000","updated":"2012-09-06T12:36:22.737+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606296/comment/13449609","id":"13449609","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=guenterh","name":"guenterh","emailAddress":"guenter dot hipler at unibas dot ch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Guenter Hipler","active":true},"body":"Thanks Yonik,\r\nI'm going to test it with the upcoming nightly build\r\nGünter","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=guenterh","name":"guenterh","emailAddress":"guenter dot hipler at unibas dot ch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Guenter Hipler","active":true},"created":"2012-09-06T12:55:31.427+0000","updated":"2012-09-06T12:55:31.427+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606296/comment/13610907","id":"13610907","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=commit-tag-bot","name":"commit-tag-bot","emailAddress":"root-jira-commit_tag_bot at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=commit-tag-bot&avatarId=16176","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=commit-tag-bot&avatarId=16176","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=commit-tag-bot&avatarId=16176","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=commit-tag-bot&avatarId=16176"},"displayName":"Commit Tag Bot","active":true},"body":"[branch_4x commit] Yonik Seeley\r\nhttp://svn.apache.org/viewvc?view=revision&revision=1381569\r\n\r\nSOLR-3793: use livedocs when caching big terms\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=commit-tag-bot","name":"commit-tag-bot","emailAddress":"root-jira-commit_tag_bot at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=commit-tag-bot&avatarId=16176","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=commit-tag-bot&avatarId=16176","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=commit-tag-bot&avatarId=16176","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=commit-tag-bot&avatarId=16176"},"displayName":"Commit Tag Bot","active":true},"created":"2013-03-22T16:43:31.171+0000","updated":"2013-03-22T16:43:31.171+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606296/comment/13654022","id":"13654022","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"body":"Closed after release.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"created":"2013-05-10T10:33:46.361+0000","updated":"2013-05-10T10:33:46.361+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-3793/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i03clj:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12422868","self":"https://issues.apache.org/jira/rest/api/latest/issue/12422868","key":"DERBY-4160","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326659","id":"12326659","description":"candidate for Second release for 10.10 branch","name":"10.10.2.0","archived":false,"released":true,"releaseDate":"2014-04-15"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324243","id":"12324243","description":"First release on the 10.11 branch","name":"10.11.1.1","archived":false,"released":true,"releaseDate":"2014-08-26"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-04-15 12:02:52.398","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24071","customfield_12310222":"3_*:*_1_*:*_1275642685_*|*_1_*:*_1_*:*_152935178422_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2014-03-05T07:57:47.380+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4160/watchers","watchCount":4,"isWatching":false},"created":"2009-04-15T11:37:26.306+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":["derby_triage10_5_2"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313345","id":"12313345","description":"","name":"10.4.2.0","archived":false,"released":true,"releaseDate":"2008-09-05"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12383197","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12383197","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12367904","key":"DERBY-2584","self":"https://issues.apache.org/jira/rest/api/2/issue/12367904","fields":{"summary":"Creating a database with JPOX SchemaTool sometimes gives ArrayIndexOutOfBoundsException when getIndexInfo() is called","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-01-21T00:23:37.411+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"The following code in DataNucleus:\r\nrs = conn.getMetaData().getIndexInfo(catalogName, schemaName, tableName, false,\r\ntrue);\r\ntriggers an Exception (http://gist.github.com/95679):\r\n\r\nCaused by: java.sql.SQLException: Column 'PARAM1' already exists.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory40.java:119)\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:70)\r\n        ... 105 more\r\nCaused by: ERROR X0Y68: Column 'PARAM1' already exists.\r\n        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:303)\r\n        at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.duplicateDescriptorException(DataDictionaryImpl.java:1678)\r\n        at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.addDescriptor(DataDictionaryImpl.java:1662)\r\n        at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.addSPSParams(DataDictionaryImpl.java:3682)\r\n        at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.updateSPS(DataDictionaryImpl.java:3830)\r\n        at org.apache.derby.iapi.sql.dictionary.SPSDescriptor.updateSYSSTATEMENTS(SPSDescriptor.java:1112)\r\n        at org.apache.derby.iapi.sql.dictionary.SPSDescriptor.getPreparedStatement(SPSDescriptor.java:736)\r\n        at org.apache.derby.iapi.sql.dictionary.SPSDescriptor.getPreparedStatement(SPSDescriptor.java:642)\r\n        at org.apache.derby.impl.sql.compile.ExecSPSNode.generate(ExecSPSNode.java:177)\r\n        at org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.java:447)\r\n        at org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:88)\r\n        at org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(GenericLanguageConnectionContext.java:794)\r\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.<init>(EmbedPreparedStatement.java:128)\r\n        ... 99 more","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"35665","summary":"getMetaData().getIndexInfo crashes with \"ERROR X0Y68: Column 'PARAM1' already exists.\"","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artem%40bizlink.ru","name":"artem@bizlink.ru","emailAddress":"artemciy at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ArtemGr","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artem%40bizlink.ru","name":"artem@bizlink.ru","emailAddress":"artemciy at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ArtemGr","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"FreeBSD java 1.6.0, 64-Bit Server VM; DataNucleus JDO","customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":18,"total":18,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/12699162","id":"12699162","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"It is triggered when we try to add rows to SYS.SYSCOLUMNS in DataDictionaryImpl.updateSPS():\r\n\r\n\t\tif(firstCompilation)\r\n\t\t{\r\n\t\t\t/*beetle:5119, reason for doing add here instead of update\r\n\t\t\t *is with NOCOMPILE option of create statement/boot time SPS,\r\n\t\t\t *SPS statement is not compiled to find out the parameter info.\r\n\t\t\t *Because of the parameter info was not inserted at SPSDescriptor \r\n\t\t\t *creation time. As this is the first time we are compiling paramter\r\n\t\t\t *infor should be inserted instead of the update.\r\n\t\t\t */\r\n\t\t\taddSPSParams(spsd, tc);\r\n\t\t}\r\n\r\nFor some reason the rows already exist, even though the meta-data statement has not been compiled before.\r\n\r\nI'm wondering if this is related to the retry logic in SPSDescriptor.getPreparedStatement(boolean):\r\n\r\n\t\t\t\t// DERBY-2584: If the first attempt to compile the query fails,\r\n\t\t\t\t// we need to reset initiallyCompilable to make sure the\r\n\t\t\t\t// prepared plan is fully stored to disk. Save the initial\r\n\t\t\t\t// value here.\r\n\t\t\t\tfinal boolean compilable = initiallyCompilable;\r\n\r\n\t\t\t\ttry\r\n\t\t\t\t{\r\n\t\t\t\t\tprepareAndRelease(lcc, null, nestedTC);\r\n\t\t\t\t\tupdateSYSSTATEMENTS(lcc, RECOMPILE, nestedTC);\r\n\t\t\t\t}\r\n\t\t\t\tcatch (StandardException se)\r\n\t\t\t\t{\r\n\t\t\t\t\tif (se.getMessageId().equals(SQLState.LOCK_TIMEOUT))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (nestedTC != null)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\tnestedTC.commit();\r\n\t\t\t\t\t\tnestedTC.destroy();\r\n\t\t\t\t\t\tnestedTC = null;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// if we couldn't do this with a nested xaction, retry with\r\n\t\t\t\t\t\t// parent-- we need to wait this time!\r\n\t\t\t\t\t\tinitiallyCompilable = compilable;\r\n\t\t\t\t\t\tprepareAndRelease(lcc, null, null);\r\n\t\t\t\t\t\tupdateSYSSTATEMENTS(lcc, RECOMPILE, null);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse throw se;\r\n\t\t\t\t}\r\n\r\nIf the lock timeout in the nested transaction happens after addSPSParams() has been called, the rows will be there when we retry the operation in the user transaction since we commit the nested transaction instead of aborting it. I think we can't abort the nested transaction because it will also abort the parent transaction, but perhaps it is possible to use savepoints to make sure that all the changes made by the nested transaction are rolled back before we retry.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-04-15T12:02:52.398+0000","updated":"2009-04-15T12:02:52.398+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/12699165","id":"12699165","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"If this is easily reproducible for you, could you try to run with -Dderby.locks.deadlockTrace=true and see if you get a lock timeout?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-04-15T12:13:33.030+0000","updated":"2009-04-15T12:13:33.030+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/12699208","id":"12699208","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artem%40bizlink.ru","name":"artem@bizlink.ru","emailAddress":"artemciy at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ArtemGr","active":true},"body":"I did run with\r\n    System.setProperty (\"derby.locks.deadlockTrace\", \"true\")\r\n\r\nwhat should I look for?\r\n\r\nHere is my log (widh deadlockTrace enabled):\r\nhttp://chicago045.server4you.de/derby.log","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artem%40bizlink.ru","name":"artem@bizlink.ru","emailAddress":"artemciy at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ArtemGr","active":true},"created":"2009-04-15T14:11:30.168+0000","updated":"2009-04-15T14:11:30.168+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/12699230","id":"12699230","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I was suspecting that we'd see a lock timeout, but I didn't find any in the log. Did you run with a fresh database or with one where you'd seen the error before? Did you set the property before the Derby driver was loaded?\r\n\r\nThis last log shows that the error happened in getImportedKeys() so the problem does not seem to be limited to getIndexInfo().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-04-15T15:01:24.217+0000","updated":"2009-04-15T15:01:24.217+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/12699236","id":"12699236","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artem%40bizlink.ru","name":"artem@bizlink.ru","emailAddress":"artemciy at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ArtemGr","active":true},"body":"> Did you run with a fresh database or with one where you'd seen the error before?\r\nFresh one.\r\nOn the first run with a fresh database DataNucleus creates the schemas. On the second run it checks them and runs into this error.\r\n> Did you set the property before the Derby driver was loaded?\r\nYes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artem%40bizlink.ru","name":"artem@bizlink.ru","emailAddress":"artemciy at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ArtemGr","active":true},"created":"2009-04-15T15:22:32.370+0000","updated":"2009-04-15T15:36:27.908+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/12726595","id":"12726595","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Triaged July 2, 2009: This does not seem to satify our definition of a crash. I don't see why a release note is needed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2009-07-02T18:11:39.233+0000","updated":"2009-07-02T18:11:39.233+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/13291648","id":"13291648","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jodeleit","name":"jodeleit","emailAddress":"pjodeleit at gmx dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Jodeleit","active":true},"body":"Got the same issue when changing the transaction isolation from READ_COMMITED to SERIALIZABLE.\r\n\r\n[EDIT]\r\nThe issue does not show up all the time (twice of three runs of our integration test suite). Seems to be a timing issue because of incorrect synchronization.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jodeleit","name":"jodeleit","emailAddress":"pjodeleit at gmx dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Jodeleit","active":true},"created":"2012-06-08T09:27:41.052+0000","updated":"2012-06-08T09:32:04.088+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/13291881","id":"13291881","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Hi Peter, thanks for the update report. you wouldn't by any change have a repro you could post or let of of the devs use? It would increase your chances for getting this fixed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2012-06-08T17:53:36.438+0000","updated":"2012-06-08T17:53:36.438+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/13292727","id":"13292727","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jodeleit","name":"jodeleit","emailAddress":"pjodeleit at gmx dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Jodeleit","active":true},"body":"Hi Dag,\r\nthere seems to be a relation to bug DERBY-2584. I checked the log files of the weekend and the exception reported there seems similar [trace below].\r\n\r\nI could give you an outline of our integration test. It should be easy to extract a dedicated test from this, but i didn't tried yet (and i don't think i'll find time for this in the near future).\r\nWhat we do is:\r\n1) create a databases\r\n2) query the database meta data\r\n[3) create some table 4) perform some CRUD operations]\r\n5) Loop to step 1 for a few times\r\n\r\nAs in DERBY-2584 if transaction isolation is READ_COMMITTED everything works as expected (bug did not show up for about 3 months with 10.8.2.2. or with 10.5.3.0 for more than two years, both with alomst daily execution of the test suite).\r\n\r\nThis is the trace I got last friday:\r\nERROR X0Y68: Column 'PARAM1' already exists.\r\n\tat org.apache.derby.iapi.error.StandardException.newException(Unknown Source)\r\n\tat org.apache.derby.impl.sql.catalog.DataDictionaryImpl.duplicateDescriptorException(Unknown Source)\r\n\tat org.apache.derby.impl.sql.catalog.DataDictionaryImpl.addDescriptor(Unknown Source)\r\n\tat org.apache.derby.impl.sql.catalog.DataDictionaryImpl.addSPSParams(Unknown Source)\r\n\tat org.apache.derby.impl.sql.catalog.DataDictionaryImpl.updateSPS(Unknown Source)\r\n\tat org.apache.derby.iapi.sql.dictionary.SPSDescriptor.updateSYSSTATEMENTS(Unknown Source)\r\n\tat org.apache.derby.iapi.sql.dictionary.SPSDescriptor.getPreparedStatement(Unknown Source)\r\n\tat org.apache.derby.iapi.sql.dictionary.SPSDescriptor.getPreparedStatement(Unknown Source)\r\n\tat org.apache.derby.impl.sql.compile.ExecSPSNode.generate(Unknown Source)\r\n\tat org.apache.derby.impl.sql.GenericStatement.prepMinion(Unknown Source)\r\n\tat org.apache.derby.impl.sql.GenericStatement.prepare(Unknown Source)\r\n\tat org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.<init>(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement20.<init>(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement30.<init>(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement40.<init>(Unknown Source)\r\n\tat org.apache.derby.jdbc.Driver40.newEmbedPreparedStatement(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.prepareMetaDataStatement(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.prepareSPS(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getPreparedQueryUsingSystemTables(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getPreparedQuery(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getPreparedQuery(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.doGetCols(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getColumns(Unknown Source)\r\n\tat de.espirit.or.impl.generic.GenericTableSynchronizer.getColumns(GenericTableSynchronizer.java:306)\r\n\tat de.espirit.or.impl.generic.GenericTableSynchronizer.updateDB(GenericTableSynchronizer.java:120)\r\n\tat de.espirit.or.impl.generic.GenericSchemaSynchronizer.updateDB(GenericSchemaSynchronizer.java:145)\r\n\tat de.espirit.or.impl.schema.SchemaImpl.updateDBTables(SchemaImpl.java:409)\r\n\tat de.espirit.or.impl.AbstractSessionHandler.syncSchemaWithDB(AbstractSessionHandler.java:934)\r\n\tat de.espirit.or.impl.AbstractSessionHandler.syncSchemaWithDB(AbstractSessionHandler.java:77)\r\n\tat de.espirit.firstspirit.content.ContentManagerImpl$TemporalSessionHandler.syncSchemaWithDB(ContentManagerImpl.java:1310)\r\n\r\nThis is the trace I got this weekend. As you can see, the call to \"DatabaseMetaData.getColumns(..)\" was successfull in this run. The only code change was an additional call to \"DatabaseMetaData.getDatabaseProductName()\" for logging.\r\njava.sql.SQLException: Java exception: '1: java.lang.ArrayIndexOutOfBoundsException'.\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.Util.javaException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.<init>(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement20.<init>(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement30.<init>(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement40.<init>(Unknown Source)\r\n\tat org.apache.derby.jdbc.Driver40.newEmbedPreparedStatement(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.prepareMetaDataStatement(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.prepareSPS(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getPreparedQueryUsingSystemTables(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getPreparedQuery(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getPreparedQuery(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.doGetCols(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getColumns(Unknown Source)\r\n\tat de.espirit.or.impl.generic.GenericTableSynchronizer.getColumns(GenericTableSynchronizer.java:313)\r\n\t... 27 more\r\nCaused by: java.sql.SQLException: Java exception: '1: java.lang.ArrayIndexOutOfBoundsException'.\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(Unknown Source)\r\n\t... 47 more\r\nCaused by: java.lang.ArrayIndexOutOfBoundsException: 1\r\n\tat org.apache.derby.impl.sql.GenericParameterValueSet.initialize(Unknown Source)\r\n\tat org.apache.derby.impl.sql.execute.BaseActivation.setupActivation(Unknown Source)\r\n\tat org.apache.derby.impl.sql.GenericActivationHolder.<init>(Unknown Source)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.getActivation(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.<init>(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement20.<init>(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement30.<init>(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement40.<init>(Unknown Source)\r\n\tat org.apache.derby.jdbc.Driver40.newEmbedPreparedStatement(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.prepareMetaDataStatement(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.prepareSPS(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getPreparedQueryUsingSystemTables(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getPreparedQuery(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getPreparedQuery(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.doGetCols(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getColumns(Unknown Source)\r\n\tat de.espirit.or.impl.generic.GenericTableSynchronizer.getColumns(GenericTableSynchronizer.java:313)\r\n\tat de.espirit.or.impl.generic.GenericTableSynchronizer.updateDB(GenericTableSynchronizer.java:121)\r\n\tat de.espirit.or.impl.generic.GenericSchemaSynchronizer.updateDB(GenericSchemaSynchronizer.java:145)\r\n\tat de.espirit.or.impl.schema.SchemaImpl.updateDBTables(SchemaImpl.java:409)\r\n\tat de.espirit.or.impl.AbstractSessionHandler.syncSchemaWithDB(AbstractSessionHandler.java:934)\r\n\tat de.espirit.or.impl.AbstractSessionHandler.syncSchemaWithDB(AbstractSessionHandler.java:77)\r\n\tat de.espirit.firstspirit.content.ContentManagerImpl$TemporalSessionHandler.syncSchemaWithDB(ContentManagerImpl.java:1310)\r\n\r\nI changed our code back to READ_COMMITTED now, perhaps I use the same workaround as in mentioned in DERBY-2584 (using READ_COMMITTED for database meta data operations and SERIALIZABLE for the rest).\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jodeleit","name":"jodeleit","emailAddress":"pjodeleit at gmx dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Jodeleit","active":true},"created":"2012-06-11T10:12:37.859+0000","updated":"2012-06-11T10:12:37.859+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/13903097","id":"13903097","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The attached program (D4160.java) reliably reproduces the bug in my environment.\r\n\r\n{noformat}\r\njava.sql.SQLException: Column 'PARAM1' already exists.\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:103)\r\n\tat org.apache.derby.impl.jdbc.Util.generateCsSQLException(Util.java:288)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:424)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:353)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2396)\r\n\tat org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:82)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.<init>(EmbedPreparedStatement.java:152)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement42.<init>(EmbedPreparedStatement42.java:41)\r\n\tat org.apache.derby.jdbc.Driver42.newEmbedPreparedStatement(Driver42.java:59)\r\n\tat org.apache.derby.impl.jdbc.EmbedConnection.prepareMetaDataStatement(EmbedConnection.java:2865)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.prepareSPS(EmbedDatabaseMetaData.java:3791)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getPreparedQueryUsingSystemTables(EmbedDatabaseMetaData.java:3623)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getPreparedQuery(EmbedDatabaseMetaData.java:3674)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getPreparedQuery(EmbedDatabaseMetaData.java:3701)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.doGetBestRowId(EmbedDatabaseMetaData.java:2160)\r\n\tat org.apache.derby.impl.jdbc.EmbedDatabaseMetaData.getBestRowIdentifier(EmbedDatabaseMetaData.java:2101)\r\n\tat D4160$1.run(D4160.java:25)\r\nCaused by: java.sql.SQLException: Column 'PARAM1' already exists.\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory.java:141)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:73)\r\n\t... 16 more\r\nCaused by: ERROR X0Y68: Column 'PARAM1' already exists.\r\n\tat org.apache.derby.iapi.error.StandardException.newException(StandardException.java:265)\r\n\tat org.apache.derby.iapi.error.StandardException.newException(StandardException.java:260)\r\n\tat org.apache.derby.impl.sql.catalog.DataDictionaryImpl.duplicateDescriptorException(DataDictionaryImpl.java:2032)\r\n\tat org.apache.derby.impl.sql.catalog.DataDictionaryImpl.addDescriptor(DataDictionaryImpl.java:2015)\r\n\tat org.apache.derby.impl.sql.catalog.DataDictionaryImpl.addSPSParams(DataDictionaryImpl.java:4363)\r\n\tat org.apache.derby.impl.sql.catalog.DataDictionaryImpl.updateSPS(DataDictionaryImpl.java:4511)\r\n\tat org.apache.derby.iapi.sql.dictionary.SPSDescriptor.updateSYSSTATEMENTS(SPSDescriptor.java:1142)\r\n\tat org.apache.derby.iapi.sql.dictionary.SPSDescriptor.getPreparedStatement(SPSDescriptor.java:764)\r\n\tat org.apache.derby.iapi.sql.dictionary.SPSDescriptor.getPreparedStatement(SPSDescriptor.java:655)\r\n\tat org.apache.derby.impl.sql.compile.ExecSPSNode.generate(ExecSPSNode.java:167)\r\n\tat org.apache.derby.impl.sql.GenericStatement.prepMinion(GenericStatement.java:546)\r\n\tat org.apache.derby.impl.sql.GenericStatement.prepare(GenericStatement.java:99)\r\n\tat org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.prepareInternalStatement(GenericLanguageConnectionContext.java:1116)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.<init>(EmbedPreparedStatement.java:134)\r\n\t... 10 more\r\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-02-17T09:35:49.928+0000","updated":"2014-02-17T09:35:49.928+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/13903280","id":"13903280","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"On 15/Apr/09 I commented:\r\n\r\n{quote}\r\nIf the lock timeout in the nested transaction happens after addSPSParams() has been called, the rows will be there when we retry the operation in the user transaction since we commit the nested transaction instead of aborting it. I think we can't abort the nested transaction because it will also abort the parent transaction, but perhaps it is possible to use savepoints to make sure that all the changes made by the nested transaction are rolled back before we retry.\r\n{quote}\r\n\r\nIn the attached repro, it looks like that's indeed what's happening. There's a lock conflict that prevents the nested transaction from completing the creation of the SPS immediately, so it is retried in the parent transaction. But the nested transaction has already added rows for some of the parameters, so the retry in the parent transaction fails because it tries to insert duplicates.\r\n\r\nAs already mentioned, aborting/rolling back the nested transaction before retrying will also cause the parent transaction to be aborted, so we cannot do that. It was suggested that we use savepoints instead. Unfortunately, savepoints are not supported in nested transactions, so that won't work either.\r\n\r\nOne possible workaround might be to drop the added rows before retrying. I'm experimenting with adding\r\n\r\n{code}\r\n        dropAllColumnDescriptors(uuid, tc);\r\n{code}\r\n\r\nto the beginning of DataDictionaryImpl.addSPSParams(). That makes the repro stop failing. I'm running the regression test suite now to see if that change breaks something.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-02-17T14:41:20.365+0000","updated":"2014-02-17T14:41:20.365+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/13904296","id":"13904296","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Actually, nested transactions *do* support savepoints. It was the more low-level internal transactions that didn't.\r\n\r\nUnfortunately, adding a savepoint at the beginning of the nested transaction and rolling back to the savepoint on error does not seem to fix the bug. That makes me wonder if the real problem here is not the lack of rollback before retrying, but rather that the other thread has compiled and stored the SPS when the current thread retries. If that's the problem (more debugging is needed to verify it), we may need logic to avoid the retry if it is the SPS has already been recompiled by someone else.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-02-18T17:39:28.809+0000","updated":"2014-02-18T17:39:28.809+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/13905475","id":"13905475","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"It looks like this is a race condition in the handling of the SYS.SYSSTATEMENTS.INITIALLY_COMPILABLE column. We have seen other race conditions in the handling of this column before, see for example DERBY-2584.\r\n\r\nThe column tells whether a stored prepared statement is compiled when it's created, or if it has to be compiled later. In practice, this means it should be true for trigger statements, and false for meta-data statements (because meta-data statements are added to the database so early in the database creation or upgrade that there is no LanguageConnectionContext available yet, and they cannot be compiled).\r\n\r\nHowever, once a meta-data statement has been compiled, the value of the column is switched from false to true. So it doesn't actually tell whether the SPS was initially compilable, but rather whether it has been compiled at least once. This is used by DataDictionaryImpl.updateSPS() to decide whether it should update the existing SPS or create it from scratch.\r\n\r\nWhat happens in the repro, is: Two threads attempt to execute the same meta-data query. They both read the SPSDescriptor from the dictionary, and they both see that INITIALLY_COMPILABLE is false because the meta-data query has not been executed before. Both of them compile the query, and both of them try to store the SPS. Because of locking in the system tables, one of them has to wait for the other to complete before it goes ahead and stores it. Since it had previously seen that INITIALLY_COMPILABLE was false, it gets confused when it finds that the SPS is already in the database, and throws the above mentioned exception \"ERROR X0Y68: Column 'PARAM1' already exists.\"\r\n\r\nI suppose we could add more logic to synchronize between the two threads to avoid the race condition. But I think the best solution would be to change the use of INITIALLY_COMPILABLE so that its value represents what its name suggests: whether or not the statement was initially compilable. Now, since this means INITIALLY_COMPILABLE won't change during the lifetime of the SPS, it also means that there won't be any race conditions when accessing it.\r\n\r\nThis change means that DataDictionaryImpl.updateSPS() can no longer tell whether or not the SPS is already stored in the database based on that column. But that information is not strictly needed. It is currently used in order to decide whether the existing SPS should be updated or a new one created. We could instead change the code to always replace the existing one (that is, delete the existing one if one exists, and create a new one). This change will actually simplify this part of the code significantly, since we get a shared code path for the first compilation of an SPS and subsequent recompilations, whereas they currently have two separate code paths. Additionally, the redefinition of INITIALLY_COMPILABLE probably fixes DERBY-2584 as well, so that we can remove the current workaround that we have for that bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-02-19T14:19:35.444+0000","updated":"2014-02-19T14:19:35.444+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/13906846","id":"13906846","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The attached patch, d4160-1a.diff, makes the following changes:\r\n\r\n* Use a savepoint to roll back the work done by the nested transaction if an error occurs. Although this wasn't what caused the problem (at least not in the repro), this sounds like the right thing to do.\r\n* Make DataDictionaryImpl.updateSPS() do exactly the same on the first compilation as it does on subsequent compilations. This way, we avoid the race condition since the threads that update the SPS don't need to know if it has been compiled before.\r\n* Remove the no longer needed workaround for DERBY-2584.\r\n* Add a test case to DatabaseMetaDataTest to verify the fix.\r\n\r\nThe patch removes more code than it adds, so I think it also reduces code complexity and makes it easier to follow the logic.\r\n\r\nAll regression tests ran cleanly with the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-02-20T10:44:33.236+0000","updated":"2014-02-20T10:44:33.236+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/13908095","id":"13908095","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1570488 from [~knutanders] in branch 'code/trunk'\r\n[ https://svn.apache.org/r1570488 ]\r\n\r\nDERBY-4160: getMetaData().getIndexInfo crashes with \"ERROR X0Y68: Column 'PARAM1' already exists.\"\r\n\r\nUse a shared code path for adding parameters to SYS.SYSCOLUMNS on the\r\nfirst compilation and subsequent compilations of a meta-data query.\r\nPreviously, the first compilation took a different code path, but that\r\ncaused problems if two threads compiled a meta-data query at the same\r\ntime, and both threads thought they were first.\r\n\r\nSet a savepoint before attempting to write a stored prepared statement\r\nto the system tables in a nested transaction, and roll back to the\r\nsavepoint if an error happens. This prevents partially stored prepared\r\nstatements from lying around in the system tables after an error.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-02-21T08:34:37.285+0000","updated":"2014-02-21T08:34:37.285+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/13908113","id":"13908113","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I think it is OK to backport this fix back to 10.5 (I'm not planning to port it that far back, though). Backporting it further is not safe in its current shape because of DERBY-1107 (fixed in 10.5). Meta-data SPSs created with the fix for this issue need to be dropped and recreated before they can be used by versions without the fix, otherwise the older version will get confused when it finds a compiled SPS whose INITIALLY_COMPILABLE column is still false. DERBY-1107 made Derby drop and recreate meta-data SPSs on all version changes, not only when upgrading across branches, so this should not be a problem on 10.5 and later.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2014-02-21T09:23:09.133+0000","updated":"2014-02-21T09:23:09.133+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/13920626","id":"13920626","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1574389 from [~knutanders] in branch 'code/branches/10.10'\r\n[ https://svn.apache.org/r1574389 ]\r\n\r\nDERBY-4160: getMetaData().getIndexInfo crashes with \"ERROR X0Y68: Column 'PARAM1' already exists.\"\r\n\r\nMerged revision 1570488 from trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-03-05T07:57:05.018+0000","updated":"2014-03-05T07:57:05.018+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12422868/comment/14284831","id":"14284831","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"bulk change to close all issues resolved but not closed and not changed since June 1, 2014.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2015-01-21T00:23:37.358+0000","updated":"2015-01-21T00:23:37.358+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4160/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06guv:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12544023","self":"https://issues.apache.org/jira/rest/api/latest/issue/12544023","key":"ARIES-832","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310981","id":"12310981","key":"ARIES","name":"Aries","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310981&avatarId=10065","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310981&avatarId=10065","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310981&avatarId=10065","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310981&avatarId=10065"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10520","id":"10520","description":"Apache Aries","name":"Aries"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2012-06-07 20:58:25.376","customfield_12312323":null,"customfield_12310420":"229261","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_12429119247_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-07-17T14:22:36.062+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ARIES-832/watchers","watchCount":4,"isWatching":false},"created":"2012-02-24T17:50:36.929+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-07-17T14:22:36.170+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313176","id":"12313176","name":"JPA","description":"RFC 143 JPA Integration"}],"timeoriginalestimate":null,"description":"I was running a test with a WAB that uses JPA, and I found that the JPA entity contained in the WAB was not being enhanced. The reason was due to the following:\r\n\r\n187  polo  WARN   [Blueprint Extender: 1] openjpa.Runtime - An error occurred while registering a ClassTransformer with org.apache.aries.jpa.container.unit.impl.PersistenceUnitInfoImpl@69b169b1. The error is logged along with this warning. Load-time class transformation will not be available.\r\njava.lang.IllegalStateException: The bundle com.ibm.osgi.jpa.warfileAdditions/1.0.0 is not started.\r\n\tat org.apache.aries.jpa.container.unit.impl.JndiDataSource.getDs(JndiDataSource.java:61)\r\n\tat org.apache.aries.jpa.container.unit.impl.DelayedLookupDataSource.getConnection(DelayedLookupDataSource.java:36)\r\n\tat org.apache.openjpa.lib.jdbc.DelegatingDataSource.getConnection(DelegatingDataSource.java:108)\r\n\tat org.apache.openjpa.lib.jdbc.DecoratingDataSource.getConnection(DecoratingDataSource.java:87)\r\n\tat org.apache.openjpa.jdbc.sql.DBDictionaryFactory.newDBDictionary(DBDictionaryFactory.java:91)\r\n\tat org.apache.openjpa.jdbc.conf.JDBCConfigurationImpl.getDBDictionaryInstance(JDBCConfigurationImpl.java:603)\r\n\tat org.apache.openjpa.jdbc.meta.MappingRepository.endConfiguration(MappingRepository.java:1510)\r\n\tat org.apache.openjpa.lib.conf.Configurations.configureInstance(Configurations.java:518)\r\n\tat org.apache.openjpa.lib.conf.Configurations.configureInstance(Configurations.java:443)\r\n\tat org.apache.openjpa.lib.conf.PluginValue.instantiate(PluginValue.java:104)\r\n\tat org.apache.openjpa.conf.MetaDataRepositoryValue.instantiate(MetaDataRepositoryValue.java:68)\r\n\tat org.apache.openjpa.lib.conf.ObjectValue.instantiate(ObjectValue.java:83)\r\n\tat org.apache.openjpa.conf.OpenJPAConfigurationImpl.newMetaDataRepositoryInstance(OpenJPAConfigurationImpl.java:963)\r\n\tat org.apache.openjpa.conf.OpenJPAConfigurationImpl.getMetaDataRepositoryInstance(OpenJPAConfigurationImpl.java:954)\r\n\tat org.apache.openjpa.persistence.PersistenceProviderImpl$ClassTransformerImpl.<init>(PersistenceProviderImpl.java:281)\r\n\tat org.apache.openjpa.persistence.PersistenceProviderImpl$ClassTransformerImpl.<init>(PersistenceProviderImpl.java:265)\r\n\tat org.apache.openjpa.persistence.PersistenceProviderImpl.createContainerEntityManagerFactory(PersistenceProviderImpl.java:168)\r\n\tat org.apache.openjpa.persistence.PersistenceProviderImpl.createContainerEntityManagerFactory(PersistenceProviderImpl.java:62)\r\n\tat org.apache.aries.jpa.container.impl.EntityManagerFactoryManager.createEntityManagerFactories(EntityManagerFactoryManager.java:329)\r\n\tat org.apache.aries.jpa.container.impl.EntityManagerFactoryManager.bundleStateChange(EntityManagerFactoryManager.java:175)\r\n\tat org.apache.aries.jpa.container.impl.PersistenceBundleManager.setupManager(PersistenceBundleManager.java:394)\r\n\tat org.apache.aries.jpa.container.impl.PersistenceBundleManager.addingBundle(PersistenceBundleManager.java:154)\r\n\tat org.osgi.util.tracker.BundleTracker$Tracked.customizerAdding(BundleTracker.java:482)\r\n\tat org.osgi.util.tracker.BundleTracker$Tracked.customizerAdding(BundleTracker.java:1)\r\n\tat org.osgi.util.tracker.AbstractTracked.trackAdding(AbstractTracked.java:262)\r\n\tat org.osgi.util.tracker.AbstractTracked.trackInitial(AbstractTracked.java:185)\r\n\tat org.osgi.util.tracker.BundleTracker.open(BundleTracker.java:163)\r\n        ...............................\r\n\r\nIt turns out that the IllegalStateException is thrown because the WAB is in the RESOLVED state when a request for the BundleContext is made against it. The javadoc says \"If this bundle is not in the STARTING, ACTIVE, or STOPPING states or this bundle is a fragment bundle, then this bundle has no valid BundleContext. This method will return null if this bundle has no valid BundleContext.\"\r\n\r\nLooking at the code in EntityManagerFactoryManager.bundleStateChange() I can see the following:\r\n\r\n  public synchronized void bundleStateChange() throws InvalidPersistenceUnitException {\r\n    \r\n    switch(bundle.getState()) {\r\n      case Bundle.RESOLVED :\r\n        //If we are Resolved as a result of having stopped\r\n        //and missed the STOPPING event we need to unregister\r\n        unregisterEntityManagerFactories();\r\n        //Create the EMF objects if necessary\r\n        createEntityManagerFactories();\r\n        break;\r\n        //Starting and active both require EMFs to be registered\r\n      case Bundle.STARTING :\r\n      case Bundle.ACTIVE :\r\n        if(tracker == null) {\r\n          tracker = new ServiceTracker(bundle.getBundleContext(), \r\n              \"org.osgi.service.jdbc.DataSourceFactory\", this);\r\n          tracker.open();\r\n        }\r\n        registerEntityManagerFactories();\r\n        break;\r\n        //Stopping means the EMFs should\r\n      case Bundle.STOPPING :\r\n        //If we're stopping we no longer need to be quiescing\r\n        quiesce = false;\r\n        if(tracker != null) {\r\n          tracker.close();\r\n          tracker = null;\r\n        }\r\n        unregisterEntityManagerFactories();\r\n        break;\r\n      case Bundle.INSTALLED :\r\n        //Destroy everything\r\n        destroyEntityManagerFactories();\r\n    }\r\n  }\r\n\r\nThis clearly shows that createEntityManagerFactories() gets driven when the WAB is in the RESOLVED state which results in the exception above. It looks like this should affect more than just WABs, but I have only hit this issue with WABs so far.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"41619","summary":"JPA load-time enhamcement fails for a WAB","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"I am using Equinox org.eclipse.osgi_3.7.2.v20120110-1415.jar with Apache Aries revision 1187719 ","customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":15,"total":15,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13215783","id":"13215783","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"body":"Potential fix?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"created":"2012-02-24T18:09:57.227+0000","updated":"2012-02-24T18:09:57.227+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13220153","id":"13220153","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"body":"Modified some failing tests","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"created":"2012-03-01T16:52:03.122+0000","updated":"2012-03-01T16:52:03.122+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13277710","id":"13277710","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"body":"New patch containing the latest changes","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"created":"2012-05-17T10:33:49.192+0000","updated":"2012-05-17T10:33:49.192+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13283374","id":"13283374","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"body":"Adding licence and javadoc","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"created":"2012-05-25T13:20:57.793+0000","updated":"2012-05-25T13:20:57.793+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13291298","id":"13291298","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cumminsh%40uk.ibm.com","name":"cumminsh@uk.ibm.com","emailAddress":"cumminsh at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Holly Cummins","active":true},"body":"I've reversed the latest commit on this until we have a fix which doesn't break the blog sample.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cumminsh%40uk.ibm.com","name":"cumminsh@uk.ibm.com","emailAddress":"cumminsh at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Holly Cummins","active":true},"created":"2012-06-07T20:58:25.376+0000","updated":"2012-06-07T20:58:25.376+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13407109","id":"13407109","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"body":"It turns out that the failure in the blog sample was due to the fact that the JPA load-time enhancement has never worked. This was not noticed due to the fact that the classes that require enhancement are enhanced at build time. This means that when the load-time enhancement failed the blog sample could just carry on without any issues.\r\n\r\nThe failure in the JPA load-time enhancement was due to the fact that it requires the org.osgi.framework.hooks.weaving.WeavingHook class to be available, which is new in OSGi 4.3. This class is not available in osgi-3.5.0.v20090520.jar as it only supports OSGi 4.2. With my changes we now explicitly check that load-time enhancement is available, otherwise we tear everything down (which is what caused the blog sample to start failing).\r\n\r\nTo fix this I have modified the blog sample to use org.eclipse.osgi-3.7.0.v20110613.jar, which supports OSGi 4.3. The setup is based on the setup used in the org.apache.aries.jpa.container.itest project.\r\n\r\nFinally, if this patch is committed, the documentation for the blog sample at, http://aries.apache.org/modules/samples/blog-sample.html will need to be updated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"created":"2012-07-05T13:51:24.398+0000","updated":"2012-07-05T13:51:24.398+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13407158","id":"13407158","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cumminsh%40uk.ibm.com","name":"cumminsh@uk.ibm.com","emailAddress":"cumminsh at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Holly Cummins","active":true},"body":"This patch moves the version of jpa-api to 1.1. We will need to re-release jpa-api at 1.1 before releasing any other JPA artefacts, which will be a good test of our semantic versioning. :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cumminsh%40uk.ibm.com","name":"cumminsh@uk.ibm.com","emailAddress":"cumminsh at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Holly Cummins","active":true},"created":"2012-07-05T14:23:34.195+0000","updated":"2012-07-06T13:42:32.806+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13407166","id":"13407166","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cumminsh%40uk.ibm.com","name":"cumminsh@uk.ibm.com","emailAddress":"cumminsh at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Holly Cummins","active":true},"body":"Brian, do you mean that load time enhancement has never worked at all, which is clearly a stop-ship, or just never worked in the blog tests?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cumminsh%40uk.ibm.com","name":"cumminsh@uk.ibm.com","emailAddress":"cumminsh at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Holly Cummins","active":true},"created":"2012-07-05T14:29:56.205+0000","updated":"2012-07-05T14:29:56.205+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13407178","id":"13407178","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"body":"I meant that it never worked in the blog sample itests :-)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"created":"2012-07-05T14:45:42.906+0000","updated":"2012-07-05T14:45:42.906+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13407279","id":"13407279","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cumminsh%40uk.ibm.com","name":"cumminsh@uk.ibm.com","emailAddress":"cumminsh at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Holly Cummins","active":true},"body":"(I *think* this patch will cause build failures unless the jpa-container dependency on jpa-api is updated to 1.0.1-SNAPSHOT ... )\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cumminsh%40uk.ibm.com","name":"cumminsh@uk.ibm.com","emailAddress":"cumminsh at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Holly Cummins","active":true},"created":"2012-07-05T17:03:55.795+0000","updated":"2012-07-05T19:27:02.537+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13410178","id":"13410178","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"body":"Hi,\r\n\r\nI'm pretty convinced that there is a big problem with the above patch. It assumes that the provider will always provide a ClassTransformer. Not all providers do weaving, and some don't return a ClassTransformer if the classes are already enhanced. Tearing down the persistence units here could break working environments. \r\n\r\nI think that the tear-down code (and the corresponding api change) should not be committed. The blog test fixes are clearly important though, and should be added without the rest of the patch. \r\n\r\nTim","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"created":"2012-07-10T09:37:50.008+0000","updated":"2012-07-10T09:37:50.008+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13410232","id":"13410232","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"body":"Hmm, it would be nice to be able to detect whether a JPA provider implements ClassTransformer. Without that, however, I fear that we are back to square one in that JPA in WABs still broken.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradine","name":"pradine","emailAddress":"pradine at uk dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian DePradine","active":true},"created":"2012-07-10T10:54:46.764+0000","updated":"2012-07-10T10:54:46.764+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13410362","id":"13410362","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"body":"From the stack trace it looks like the real problem is that OpenJPA is eagerly getting a database connection. In this case it is trying to work out which database dictionary to use. \r\n\r\nThis doesn't look like a general class transformation problem as much as it looks like a laziness problem. It may be that adding a DelyedConnection might help, but mostly it looks like we need JPA providers to avoid using the database until the first class load/persist call. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"created":"2012-07-10T14:06:47.903+0000","updated":"2012-07-10T14:06:47.903+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13411424","id":"13411424","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ejiang","name":"ejiang","emailAddress":"emijiang6 at googlemail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Emily Jiang","active":true},"body":"I reverted the 1st patch about creating EntityManagerFactories when a bundle is starting, because it has caused JPA load time enhancement disfunctioning due to the entityManagerFactory was created too late. If  creating entity manager facttories is performed when a bundle transits to the starting state, some entity classes might have been loaded. As a consequence, they will not be enhanced at load time. Brian will come up with a better approach towards this issule or considering Tim's suggestion.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ejiang","name":"ejiang","emailAddress":"emijiang6 at googlemail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Emily Jiang","active":true},"created":"2012-07-11T11:56:44.959+0000","updated":"2012-07-11T11:56:44.959+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544023/comment/13416238","id":"13416238","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ejiang","name":"ejiang","emailAddress":"emijiang6 at googlemail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Emily Jiang","active":true},"body":"Brian will come up with a different approach or make database lookup less eager instead of looking up database before the bundle is in starting state.\r\n\r\nIt is correct to create entity manager factory when a bundle is in the resolved state.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ejiang","name":"ejiang","emailAddress":"emijiang6 at googlemail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Emily Jiang","active":true},"created":"2012-07-17T14:22:36.151+0000","updated":"2012-07-17T14:22:36.151+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ARIES-832/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i07hlz:"}}
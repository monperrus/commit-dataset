{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12405638","self":"https://issues.apache.org/jira/rest/api/latest/issue/12405638","key":"DERBY-3897","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2008-10-08 19:54:25.959","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23907","customfield_12310222":"1_*:*_1_*:*_633133858_*|*_6_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-10-09T23:54:10.824+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3897/watchers","watchCount":0,"isWatching":false},"created":"2008-10-02T16:01:56.966+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"7.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12321882","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12321882","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12386518","key":"DERBY-3327","self":"https://issues.apache.org/jira/rest/api/2/issue/12386518","fields":{"summary":"SQL roles: Implement authorization stack (and SQL session context to hold it)","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}},{"id":"12375432","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12375432","type":{"id":"12310050","name":"Regression","inward":"is broken by","outward":"breaks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310050"},"outwardIssue":{"id":"12669236","key":"DERBY-6348","self":"https://issues.apache.org/jira/rest/api/2/issue/12669236","fields":{"summary":"NPE or assert failure in recursive trigger","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-09-18T12:42:36.304+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"In some contexts, beside calling stored routines containing SQL, Derby\nuses nested execution contexts, wehere we have two nested activations,\nbut no nested connections.\n\nIn such cases, currently a new SQLSessionContext is constructed, but\nnot initialized correctly.  This leads to the session variables\nCURRENT_ROLE/CURRENT_SCHEMA not being set correctly in these contexts\n(they should inherited from the parent context, cf DERBY-3327).\n\nFor method calls, this is being handled by generating a call to\nlcc.setupNestedSessionContext (see\nStaticMethodCallNode#generateSetupNestedSessionContext)\n\nIn some of these nested contexts, one or both of the session variables\nCURRENT_ROLE/CURRENT_SCHEMA can be referenced, in others\nnot. Obviously, if they can, this will lead to errors. The following\ncontexts will have this problem:\n\n- ALTER TABLE ADD COLUMN <colname> <coltype> DEFAULT CURRENT_ROLE\n  In the AlterTableConstantAction, a nested UPDATE statement is used\n  to give existing rows the new column its default value. This\n  execution context is nested, cf. AlterTableConstantAction#executeUpdate\n\n- TRIGGER body execution may reference CURRENT_ROLE/CURRENT_SCHEMA.\n  The body executes in a nested context,\n  cf. GenericTriggerExecutor#executeSPS.\n\nIn other cases, the session variables can not be referenced, so this\nnot a problem: \n\n- CHECK constraint execution when executed as part of an ALTER TABLE\n- EmbedResultSet.insertRow, .deleteRow, .updateRow\n\nThe session context should not be changed (pushed) for these nested\nexecutions, since there is no nested connection (SQL 2003, 4.37.1: \"An\nSQL-session is associated with an SQL-connection.\")\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39341","summary":"SQLSessionContext not correctly initialized in some non-method call nested contexts","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":12,"total":12,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12405638/comment/12636383","id":"12636383","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Attaching a patch to an existing text that shows the issues.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2008-10-02T16:09:42.678+0000","updated":"2008-10-02T16:09:42.678+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12405638/comment/12636392","id":"12636392","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Observation: Since none of these nested executions have the potential to\r\nmodify the session context (as far as I can understand), we could\r\npush a copy of the context (logically no push), or reuse the existing context, \r\nwhatever is easier.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2008-10-02T16:39:06.460+0000","updated":"2008-10-02T16:39:06.460+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12405638/comment/12637134","id":"12637134","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Uploading a patch that also sets up a SQL session context correctly\r\nalso for \"substatements\". Substatements are statements that are\r\nexecuted as part of the execution of a top level statement of a\r\nconnection (top level or nested). Currently the code already handles\r\nthe case of pushing session context for stored routines which can have\r\nnested connections.\r\n\r\nFor substatements, the SQL session context is set up to be the same\r\n(an alias) as the parent statement. I chose to set up the correct\r\nsession contexts also for constaints and the EmbedResultSet usages of\r\nexecute, even though it may be strictly unnecessary. It seems better\r\nto alwas have the correct session context even if it not needed\r\n(yet). It could become needed later for session state variables we\r\nhave not yet imlemented, e.g. current transaction isolation level.\r\n\r\nNew tests cases have been added, which reproduce the error if the rest\r\nof the patch is not applied. Regressions ran cleanly.\r\n\r\nDetailed patch comments:\r\n\r\nM      java/engine/org/apache/derby/iapi/sql/conn/LanguageConnectionContext.java\r\nM      java/engine/org/apache/derby/impl/sql/conn/GenericLanguageConnectionContext.java\r\n\r\n- Split getNestedSessionContext in two: \r\n  setupNestedSessionContext and setupSubStatementSessionContext\r\n- Made getTopLevelSQLSessionContext part of interface, needed by BaseActivation\r\n- Moved lookup of parent activation to inside getCurrentSQLSessionContext\r\n  (no behavior change, just simplifies usage code).\r\n- Some renaming and comment changes.\r\n\r\nM      java/engine/org/apache/derby/impl/sql/execute/GenericTriggerExecutor.java\r\n\r\n- Now calls ps.executeSubStatement instead of ps.execute\r\n\r\nM      java/engine/org/apache/derby/iapi/sql/Activation.java\r\nM      java/engine/org/apache/derby/impl/sql/execute/BaseActivation.java\r\n\r\n- renamed callActivation to parentActivation\r\n- renamed nestedSQLSessionContext to sqlSessionContextForChildren\r\n- renamed getNestedSQLSessionContext to getSQLSessionContextForChildren\r\n  for better clarity of the code (hopefully!)\r\n- split getNestedSQLSessionContext into two:\r\n  setupSQLSessionContextForChildren(bool push) and getSQLSessionContextForChildren.\r\n  setupSQLSessionContextForChildren now has logic to either push a new\r\n  session context or inherit one as the case may be.\r\n- renamed setCallactivation to setParentActivation\r\n- renamed getCallactivation to getParentActivation\r\n\r\nM      java/engine/org/apache/derby/impl/sql/execute/ConstraintConstantAction.java\r\n\r\n- Now calls ps.executeSubStatement instead of ps.execute\r\n\r\nM      java/engine/org/apache/derby/impl/sql/execute/AlterTableConstantAction.java\r\n\r\n- Now calls ps.executeSubStatement instead of ps.execute\r\n\r\nM      java/engine/org/apache/derby/iapi/sql/PreparedStatement.java\r\nM      java/engine/org/apache/derby/impl/sql/GenericPreparedStatement.java\r\n\r\n- Introduced 2 overloads of executeSubStatement, removed one existing\r\n  overload of execute which is no longer used). The\r\n  executeSubStatement contains a call to set up the substatement\r\n  session context before the actual execute.\r\n  The remaining execute method has lost an argument (did no longer vary).\r\n- Comment changes and variable renaming to reflect new reality.\r\n\r\nM      java/engine/org/apache/derby/impl/sql/GenericActivationHolder.java\r\n\r\n- pass on new and changed methods\r\n\r\nM      java/engine/org/apache/derby/impl/jdbc/EmbedResultSet.java\r\n\r\n- Now calls ps.executeSubStatement instead of ps.execute\r\n\r\nM      java/engine/org/apache/derby/impl/jdbc/EmbedStatement.java\r\n\r\n- call to ps.execute has lost an actual argument\r\n  (rollbackParentContext), see ps.execute body, always false. The true\r\n  usages are found in calls to executeSubstatement now.\r\n\r\nM      java/testing/org/apache/derbyTesting/functionTests/tests/lang/RolesConferredPrivilegesTest.java\r\n\r\nTwo new test cases.\r\n\r\nM      java/testing/org/apache/derbyTesting/functionTests/tests/lang/SQLSessionContextTest.java\r\n\r\nComment referencing the new test cases in RolesConferredPrivilegesTest.\r\n\r\nM      java/testing/org/apache/derbyTesting/junit/JDBC.java\r\n\r\nTypo fix.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2008-10-06T16:38:26.823+0000","updated":"2008-10-06T16:38:26.823+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12405638/comment/12638053","id":"12638053","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Hi, Dag. In the description for this JIRA you say that CHECK CONSTRAINTS cannot create a nested context. I just want to confirm that the following can't happen:\r\n\r\n1) a CHECK CONSTRAINT calls a user coded function\r\n\r\n2) the function invokes SQL against the current connection\r\n\r\n3) this creates a nested context","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2008-10-08T19:54:25.959+0000","updated":"2008-10-08T19:54:25.959+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12405638/comment/12638061","id":"12638061","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks for the patch, Dag. I think that there are 2 things going on in this patch: 1) some routines have been renamed in order to clarify that nested contexts can be created by situations other than CALL statements and 2) there's a fix to a context stacking bug. I had a hard time finding the code for (2) because there is so much code associated with (1). It might be nice if some header comment listed the situations which give rise to nested contexts (as you do in your patch comment). Thanks. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2008-10-08T20:19:14.091+0000","updated":"2008-10-08T20:19:14.091+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12405638/comment/12638105","id":"12638105","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Thanks for looking at this patch, Rick.\r\n\r\n> 2) the function invokes SQL against the current connection\r\n\r\nRight! I think I momentarily blindsided by the following fragment from the reference manual's \r\ndescription of the constraint clause (http://db.apache.org/derby/docs/dev/ref/rrefsqlj13590.html#rrefsqlj13590):\r\n\r\n\r\n     The search condition must always return the same value if applied to the same values. \r\n                                                                               *****************\r\n     Thus, it cannot contain any of the following: \r\n\r\n          Dynamic parameters (?)\r\n          Date/Time Functions (CURRENT_DATE, CURRENT_TIME, CURRENT_TIMESTAMP)\r\n          Subqueries\r\n          User Functions (such as USER, SESSION_USER, CURRENT_USER)\r\n        ******************\r\nBut we are talking user defined function :)\r\nAnd user defined functions could return varying values too... But with the\r\nnew DETERMINISTIC keyword, maybe we could require that? :)\r\n\r\nIn any case, the session context is set up correctly also for the check constraint; i'll see if I can add a test \r\ncase for it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2008-10-08T21:46:02.566+0000","updated":"2008-10-08T21:46:02.566+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12405638/comment/12638114","id":"12638114","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"> 2) there's a fix to a context stacking bug\r\n\r\nThe bug is that such non-call cases were not addressed at all, so they\r\nended up with a \"blank\" session context (as if the substatement\r\nexecuted on the top level of the connection, just after a fresh\r\nconnect). The new cases are those places in the code where I now call\r\nexecuteSubstatement() instead of execute(). You'll notice that\r\nexecuteSubstatement sets up a session context by calling\r\nsetupSubStatementSessionContext (which only reuses the parent\r\nactivation's session context).\r\n\r\nIn contrast, the call case is handled with the call to\r\nsetupNestedSessionContext (from generated code, cf\r\nStaticMethodCallNode). Hope this helps :)\r\n\r\nI'll have a look at the comments again.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2008-10-08T22:06:18.579+0000","updated":"2008-10-08T22:06:18.579+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12405638/comment/12638116","id":"12638116","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"The Javadoc for\r\n\r\n- LanguageConnectionContext#setupNestedSessionContext \r\n- LanguageConnectionContext#setupSubStatementSessionContext\r\n\r\ndoes describe the two cases; but only cites execution of trigger body as an example\r\nfor a substatement. Do you think I should enumerate all cases here?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2008-10-08T22:14:36.124+0000","updated":"2008-10-08T22:14:36.124+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12405638/comment/12638324","id":"12638324","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Uploading revision #2 of this patch, which adds a test case for the following case: ALTER TABLE adds a CHECK constraint that calls a  user defined function with a nested connection, to test that the substatement used by alter table to do the checking of existing rows in the table w.r.t the new check constraint, gets the correct session context, which is in turn inherited when the session context is pushed to the user defined function.\r\n\r\n(code snip):\r\n\r\nIn this case, the session context stack contains two elements referenced from the three activations thus:\r\n\r\ntop level \"ALTER TABLE\" activation          -> top level session context\r\nsubstatement (CHECK CONSTRAINT activation)  -> top level session context\r\nnested connection in getCurrentRole,\r\n           \"VALUES CURRENT_ROLE\" activation -> pushed session context\r\n\r\nRegressions ran cleanly and I verified that the new test case fails without the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2008-10-09T16:50:10.743+0000","updated":"2008-10-09T16:50:10.743+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12405638/comment/12638352","id":"12638352","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"> for a substatement. Do you think I should enumerate all cases here? \r\n\r\nIt would help me in the future I think. I'm sure the next person through this code would appreciate what you've learned about the difference between the \"nested\" and \"sub\" categories. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2008-10-09T18:11:47.469+0000","updated":"2008-10-09T18:11:47.469+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12405638/comment/12638438","id":"12638438","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Thanks, Rick!\r\nUploading revision #3, which adds more comments; no other changes.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2008-10-09T23:37:32.137+0000","updated":"2008-10-09T23:37:32.137+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12405638/comment/12638447","id":"12638447","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Reviosn #3 committed as svn 703295, closing.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2008-10-09T23:54:10.761+0000","updated":"2008-10-09T23:54:10.761+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3897/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i073jr:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12370396","self":"https://issues.apache.org/jira/rest/api/latest/issue/12370396","key":"DERBY-2713","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2007-06-01 14:19:25.047","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23197","customfield_12310222":"1_*:*_1_*:*_880053516_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_683830194","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2007-06-07T14:40:23.462+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2713/watchers","watchCount":0,"isWatching":false},"created":"2007-05-28T10:12:49.946+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-06-15T12:37:33.650+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11407","id":"11407","name":"JDBC"}],"timeoriginalestimate":null,"description":"Currently LOBStreamControl has a buffer limit of 4k if the lob is larger than this a temporary file is created. Ensure that lob data is kept in memory unless user start to update it.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39945","summary":"Ensure that a temporary file is not created for a lob obtained from resultset unless user updates it.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":4,"total":4,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370396/comment/12499524","id":"12499524","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"body":"This patch conflicts with DERBY-2646. I will redo this patch once DERBY-2646 is done.\r\n\r\nIn this patch I have modified LOBStreamControl to keep the buffer at least as big as the initial byte array. If the initial size is smaller than 4k the buffer size will be set to 4k.\r\n\r\nTo ensure the initial byte array is kept in memory and not on file its necessary to pass the initial byte array in the constructor. If the LOBStreamControl receives byte array in constructor it sets the buffer size to max of 4k and buffer size.\r\n\r\nA similar constructor is introduced for CLOBStreamControl too.\r\n\r\nFile affected\r\njava/engine/org/apache/derby/impl/jdbc/EmbedBlob.java\r\njava/engine/org/apache/derby/impl/jdbc/EmbedClob.java\r\n\r\nModified the initialization of control class to use constructor with initial data.\r\n\r\njava/engine/org/apache/derby/impl/jdbc/ClobStreamControl.java\r\njava/engine/org/apache/derby/impl/jdbc/LOBStreamControl.java\r\n\r\n\r\nAdded new constructor to accept initial data (byte array for LOBStreamControl and String for ClobStreamControl).\r\n\r\nBoth the constrictors now call newly introduced LOBStreamControl.initControl to ensure initial buffer size is set.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"created":"2007-05-28T10:23:12.481+0000","updated":"2007-05-28T10:23:12.481+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370396/comment/12500721","id":"12500721","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Hi Anurag, I looked at the patch and have a couple of questions:\r\n\r\n1) LOBStreamControl calls a protected method initControl() from its constructor to set the buffer size. Wouldn't it be better to put that code into the new constructor? That would allow bufferSize to be final.\r\n\r\n2) The new constructor for LOBStreamControl is only used by EmbedBlob(byte[],EmbedConnection). Shouldn't it also have been used by EmbedBlob(DataValueDescriptor,EmbedConnection) when dvd.getStream() returns null?\r\n\r\n3) Should EmbedClob(String,EmbedConnection) have used the new ClobStreamControl constructor?\r\n\r\n4) I was wondering, should LOBStreamControl.init() set dataBytes to null? It doesn't seem to be used after init() has been called.\r\n\r\n5) I noticed this diff:\r\n         while (sz < length) {\r\n-            int len = (int) (((length - sz) >= MAX_BUF_SIZE) ? MAX_BUF_SIZE\r\n+            int len = (int) (((length - sz) >= bufferSize) ? bufferSize\r\n                     : length - sz);\r\n\r\nWould it have been clearer if it was written as Math.min(...)?\r\n\r\n6) Typos in class javadoc for LOBStreamControl: \"suplied\" -> \"supplied\", \"indial\" -> \"initial\"\r\n\r\n7) Could you reword this comment in LOBStreamControl? It's not quite clear to me what it means.\r\n\"If the class is created with initial data, the buffer \r\n+ * size is set to the size of the byte array suplied the buffer size is set\r\n+ * to DEFAULT_MAX_BUF_SIZE is an empty LOBStreamControl is created or if the \r\n+ * initial data is smaller than DEFAULT_MAX_BUF_SIZE.\"\r\n\r\n8) Typos in javadoc for LOBStreamControl.initControl(): \"initialzes\" -> \"initializes\", \"initialze\" -> \"initialize\"","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-06-01T14:19:25.047+0000","updated":"2007-06-01T14:19:25.047+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370396/comment/12502285","id":"12502285","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"body":"1) LOBStreamControl calls a protected method initControl() from its constructor to set the buffer size. Wouldn't it be better to put that code into the new constructor? That would allow bufferSize to be final.\r\n\r\nchanged it to final. \r\n\r\n2) The new constructor for LOBStreamControl is only used by EmbedBlob(byte[],EmbedConnection). Shouldn't it also have been used by EmbedBlob(DataValueDescriptor,EmbedConnection) when dvd.getStream() returns null?\r\n\r\nchanged to use new constructor from EmbedBlob when dvd doesn't have stream.\r\n\r\n3) Should EmbedClob(String,EmbedConnection) have used the new ClobStreamControl constructor?\r\n\r\nThis constructor is now removed as part of  clob cleanup.\r\n\r\n4) I was wondering, should LOBStreamControl.init() set dataBytes to null? It doesn't seem to be used after init() has been called.\r\n\r\nadded code to set dataBytes to null in init\r\n\r\n5) I noticed this diff:\r\n         while (sz < length) {\r\n- int len = (int) (((length - sz) >= MAX_BUF_SIZE) ? MAX_BUF_SIZE\r\n+ int len = (int) (((length - sz) >= bufferSize) ? bufferSize\r\n                     : length - sz);\r\n\r\nWould it have been clearer if it was written as Math.min(...)?\r\n\r\nchanged it to use Math.min\r\n\r\n6) Typos in class javadoc for LOBStreamControl: \"suplied\" -> \"supplied\", \"indial\" -> \"initial\"\r\n\r\nfixed\r\n\r\n7) Could you reword this comment in LOBStreamControl? It's not quite clear to me what it means.\r\n\"If the class is created with initial data, the buffer\r\n+ * size is set to the size of the byte array suplied the buffer size is set\r\n+ * to DEFAULT_MAX_BUF_SIZE is an empty LOBStreamControl is created or if the\r\n+ * initial data is smaller than DEFAULT_MAX_BUF_SIZE.\"\r\n\r\nrephrased to comment.\r\n\r\n8) Typos in javadoc for LOBStreamControl.initControl(): \"initialzes\" -> \"initializes\", \"initialze\" -> \"initialize\"\r\n\r\nfixed","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"created":"2007-06-07T09:51:49.724+0000","updated":"2007-06-07T09:51:49.724+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370396/comment/12502367","id":"12502367","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks, Anurag! Committed revision 545197.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-06-07T14:40:23.454+0000","updated":"2007-06-07T14:40:23.454+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2713/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0779z:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12512977","self":"https://issues.apache.org/jira/rest/api/latest/issue/12512977","key":"ARIES-703","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310981","id":"12310981","key":"ARIES","name":"Aries","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310981&avatarId=10065","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310981&avatarId=10065","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310981&avatarId=10065","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310981&avatarId=10065"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10520","id":"10520","description":"Apache Aries","name":"Aries"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316224","id":"12316224","description":"","name":"blueprint-0.4.0","archived":true,"released":true}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-02-02 09:38:38.394","customfield_12312323":null,"customfield_12310420":"68980","customfield_12312320":null,"customfield_12310222":"3_*:*_1_*:*_1623000_*|*_1_*:*_1_*:*_18323639651_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-02-03T15:01:13.418+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ARIES-703/watchers","watchCount":1,"isWatching":false},"created":"2011-07-06T12:40:10.833+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-02-03T15:01:13.465+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313048","id":"12313048","name":"Blueprint","description":"OSGi Blueprint Services implementation"}],"timeoriginalestimate":null,"description":"When there is no ASM between the bundles and aries proxy is installed the default proxy manager is JDKProxyManager. When there is a bean in a blueprint fragment that has for example tx:transaction inside creating the transactional proxy fails with the following stacktrace:\r\n\r\n\r\n[#|2011-07-06T14:29:24.542+0200|SEVERE|glassfish3.1|org.apache.aries.blueprint.container.BlueprintContainerImpl|_ThreadID=27;_ThreadName=Thread-1;|Unable to start blueprint container for bundle biz.everit.audit.persistence.biz.everit.audit.persistence.impl\r\norg.osgi.service.blueprint.container.ComponentDefinitionException: Unable to create proxy for bean eventPersistenceImpl in bundle biz.everit.audit.persistence.biz.everit.audit.persistence.impl version 0.1.0.SNAPSHOT\r\n\tat org.apache.aries.blueprint.container.BeanRecipe.addInterceptors(BeanRecipe.java:695)\r\n\tat org.apache.aries.blueprint.container.BeanRecipe.internalCreate(BeanRecipe.java:730)\r\n\tat org.apache.aries.blueprint.di.AbstractRecipe$1.call(AbstractRecipe.java:71)\r\n\tat java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)\r\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:138)\r\n\tat org.apache.aries.blueprint.di.AbstractRecipe.create(AbstractRecipe.java:79)\r\n\tat org.apache.aries.blueprint.di.RefRecipe.internalCreate(RefRecipe.java:60)\r\n\tat org.apache.aries.blueprint.di.AbstractRecipe.create(AbstractRecipe.java:98)\r\n\tat org.apache.aries.blueprint.container.BlueprintRepository.createInstances(BlueprintRepository.java:220)\r\n\tat org.apache.aries.blueprint.container.BlueprintRepository.createInstance(BlueprintRepository.java:205)\r\n\tat org.apache.aries.blueprint.container.BlueprintRepository.create(BlueprintRepository.java:144)\r\n\tat org.apache.aries.blueprint.container.ServiceRecipe.createRecipe(ServiceRecipe.java:398)\r\n\tat org.apache.aries.blueprint.container.ServiceRecipe.createService(ServiceRecipe.java:271)\r\n\tat org.apache.aries.blueprint.container.ServiceRecipe.internalGetService(ServiceRecipe.java:243)\r\n\tat org.apache.aries.blueprint.container.ServiceRecipe.getService(ServiceRecipe.java:320)\r\n\tat org.apache.aries.blueprint.container.ServiceRecipe$TriggerServiceFactory.getService(ServiceRecipe.java:465)\r\n\tat org.apache.felix.framework.ServiceRegistrationImpl.getFactoryUnchecked(ServiceRegistrationImpl.java:310)\r\n\tat org.apache.felix.framework.ServiceRegistrationImpl.getService(ServiceRegistrationImpl.java:221)\r\n\tat org.apache.felix.framework.ServiceRegistry.getService(ServiceRegistry.java:297)\r\n\tat org.apache.felix.framework.Felix.getService(Felix.java:3014)\r\n\tat org.apache.felix.framework.BundleContextImpl.getService(BundleContextImpl.java:329)\r\n\tat org.jvnet.hk2.osgiadapter.HK2Main$HK2ServiceTrackerCustomizer.addingService(HK2Main.java:260)\r\n\tat org.osgi.util.tracker.ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:896)\r\n\tat org.osgi.util.tracker.AbstractTracked.trackAdding(AbstractTracked.java:261)\r\n\tat org.osgi.util.tracker.AbstractTracked.track(AbstractTracked.java:233)\r\n\tat org.osgi.util.tracker.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:840)\r\n\tat org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:871)\r\n\tat org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:733)\r\n\tat org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:662)\r\n\tat org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:3769)\r\n\tat org.apache.felix.framework.Felix.access$000(Felix.java:80)\r\n\tat org.apache.felix.framework.Felix$2.serviceChanged(Felix.java:722)\r\n\tat org.apache.felix.framework.ServiceRegistry.registerService(ServiceRegistry.java:107)\r\n\tat org.apache.felix.framework.Felix.registerService(Felix.java:2854)\r\n\tat org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:251)\r\n\tat org.apache.aries.blueprint.container.BlueprintContainerImpl.registerService(BlueprintContainerImpl.java:408)\r\n\tat org.apache.aries.blueprint.container.ServiceRecipe.register(ServiceRecipe.java:187)\r\n\tat org.apache.aries.blueprint.container.BlueprintContainerImpl.registerServices(BlueprintContainerImpl.java:666)\r\n\tat org.apache.aries.blueprint.container.BlueprintContainerImpl.doRun(BlueprintContainerImpl.java:334)\r\n\tat org.apache.aries.blueprint.container.BlueprintContainerImpl.run(BlueprintContainerImpl.java:230)\r\n\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)\r\n\tat java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)\r\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:138)\r\n\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:98)\r\n\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:206)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\r\n\tat java.lang.Thread.run(Thread.java:662)\r\nCaused by: org.apache.aries.proxy.UnableToProxyException: The class biz.everit.audit.persistence.impl.EventPersistenceServiceImpl is not an interface and therefore a proxy cannot be generated.\r\n\tat org.apache.aries.proxy.impl.JdkProxyManager.getInterfaces(JdkProxyManager.java:43)\r\n\tat org.apache.aries.proxy.impl.JdkProxyManager.createNewProxy(JdkProxyManager.java:36)\r\n\tat org.apache.aries.proxy.impl.AbstractProxyManager.createDelegatingInterceptingProxy(AbstractProxyManager.java:75)\r\n\tat org.apache.aries.proxy.impl.AbstractProxyManager.createInterceptingProxy(AbstractProxyManager.java:53)\r\n\tat org.apache.aries.blueprint.container.BeanRecipe.addInterceptors(BeanRecipe.java:690)\r\n\t... 47 more\r\n\r\nIt will always happen as we have the following line in BeanRecepe:\r\n\r\nintercepted = BlueprintExtender.getProxyManager().createInterceptingProxy(b, \r\n                  ProxyUtils.asList(original.getClass()), original, \r\n                  new Collaborator(interceptorLookupKey, interceptors));\r\n\r\nThat means that the interface list is the class of the bean itself that is cannot be an interface. In case of JDKProxy we should derive the interfaces that the bean implements and those interface classes should be passed. However at this level (BeanRecipe) we do not know about the proxy manager...\r\n\r\nThe example blueprint file for this:\r\n\r\n<bean id=\"eventPersistenceImpl\" class=\"biz.everit.audit.persistence.impl.EventPersistenceServiceImpl\">\r\n\t\t<tx:transaction method=\"*\" value=\"Required\" />\r\n\t\t<jpa:context property=\"em\" unitname=\"biz.everit.audit.persistence.entity\" type=\"TRANSACTION\" />\r\n</bean>","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"166202","summary":"JDKProxyManager cannot proxy blueprint beans","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=balazs.zsoldos","name":"balazs.zsoldos","emailAddress":"zs_b at freemail dot hu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Balazs Zsoldos","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=balazs.zsoldos","name":"balazs.zsoldos","emailAddress":"zs_b at freemail dot hu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Balazs Zsoldos","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Glassfish 3.1","customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":3,"total":3,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512977/comment/13198633","id":"13198633","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"body":"Moving this to the blueprint component (where the problem actually is. The proxy component is just doing what it's asked.\r\n\r\nIt might be a good idea to change the blueprint internals a little such that if the blueprint bean needs to be proxied it is always proxied with the minimal set of interfaces/hierarchy that it needs for that particular call (e.g. injecting into another bean via interface or super-class). This would prevent the \"one shot\" approach we have now where to proxy beans we have to proxy everything, even if the bean is only referred to by interface in the other beans.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"created":"2012-02-02T09:38:38.394+0000","updated":"2012-02-02T09:38:38.394+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512977/comment/13199740","id":"13199740","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"body":"It's not possible to absolutely solve this problem. If the bean is created through the blueprint API, or if it gets injected into another bean that refers to it by a class, or if it is exposed as a service using a service interface that is not a Java interface. I can however add support that means we only proxy at the last possible second when we know what type(s) are required. As long as you inject via interface this should solve your problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"created":"2012-02-03T14:38:00.742+0000","updated":"2012-02-03T14:38:00.742+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12512977/comment/13199749","id":"13199749","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"body":"The code committed under revision 1240203 should make things much better. I was even able to remove ASM from the transaction itests and they kept working (which wasn't possible before) \r\n\r\nI hope this helps!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timothyjward","name":"timothyjward","emailAddress":"timothyjward at hotmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Ward","active":true},"created":"2012-02-03T15:00:10.626+0000","updated":"2012-02-03T15:00:10.626+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ARIES-703/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0st5z:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12392355","self":"https://issues.apache.org/jira/rest/api/latest/issue/12392355","key":"DERBY-3571","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313142","id":"12313142","description":"","name":"10.3.3.0","archived":false,"released":true,"releaseDate":"2008-05-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2008-03-27 13:48:40.699","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23720","customfield_12310222":"3_*:*_1_*:*_1015757540_*|*_1_*:*_1_*:*_10012_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_1577339996","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-04-07T10:12:22.996+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3571/watchers","watchCount":0,"isWatching":false},"created":"2008-03-26T16:02:55.444+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"8.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312876","id":"12312876","description":"","name":"10.3.2.1","archived":false,"released":true,"releaseDate":"2007-12-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12319737","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12319737","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12372921","key":"DERBY-2892","self":"https://issues.apache.org/jira/rest/api/2/issue/12372921","fields":{"summary":"Closing a resultset after retrieving a large > 32665 bytes value with Network Server does not release locks","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12319756","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12319756","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12392528","key":"DERBY-3575","self":"https://issues.apache.org/jira/rest/api/2/issue/12392528","fields":{"summary":"Optimize client side LOB release mechanism by reducing the number of round-trips","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}},{"id":"12319851","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12319851","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12393294","key":"DERBY-3601","self":"https://issues.apache.org/jira/rest/api/2/issue/12393294","fields":{"summary":"Optimize LOBStateTracker for non-locator servers","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/5","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/trivial.png","name":"Trivial","id":"5"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-05-04T18:22:56.275+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11407","id":"11407","name":"JDBC"},{"self":"https://issues.apache.org/jira/rest/api/2/component/11690","id":"11690","name":"Network Client"}],"timeoriginalestimate":null,"description":"If the client creates a result set containing LOB locator columns and iterates through it without actually accessing the LOB columns, the locators are not released.\nThe amount of locators and their associated LOB objects causes the server to consume large amounts of memory and it eventually gets an OOME.\n\nThere are a few workarounds for this bug:\n a) Access and/or properly close the LOBs (i.e. Blob.free).\n    This is partly dependent on DERBY-2892.\n b) Invoke Connection.commit (or rollback) periodically, which causes all locators on the connection to be released.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39203","summary":"LOB locators are not released if the LOB columns are not accessed by the client","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":25,"total":25,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12582335","id":"12582335","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"'derby-3571-1a-client_track_lob_fix.diff' is the first attempt at a fix where the client keeps track of LOBs and closes them as appropriate.\r\nThe basic approach is:\r\n  a) When the result set position is changed, check the current row (if any) for LOB columns with open locators.\r\n  b) When the result set is closed, check the current row (if any).\r\n  c) If a Blob or Clob object is created, inform the state tracker that its locator shall not be released.\r\n  d) On connection commit/rollback, discard all client side LOB state as all locators are released by the server.\r\n\r\nCurrently there will be a callable procedure invocation (and thus a round trip) for each LOB column each time the result set position changes (i.e. rs.next or rs.relative). This is very ineffective, and for the current solution there are two optimizations that can be made:\r\n  1) Implement a new stored procedure that takes a list of locators. All locators are freed in one round trip. The complication is to decide when the procedure should be invoked, i.e. there must typically be some kind of threshold (number of locators).\r\n  2) Piggy-back locators on other requests to the server. Frees resources optimally at almost no extra cost. There are several variations, for instance doing it on the connection level or only on the resultset/cursor level (CNTQRY).\r\n\r\nSince we don't do prefetching of result set data containing LOBs, the difference between the optimizations is less pronounced, but (1) will most likely leave resources open for a longer period of time on the server.\r\n\r\nAnother thing to consider is how important it is that this feature is very effective. Why query the database for data you don't need?\r\n\r\n\r\nPlease review and comment.\r\nI'm running tests, and I have run the repro mentioned in DERBY-2892 without failure.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-03-26T16:26:26.050+0000","updated":"2008-03-26T16:26:26.050+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12582439","id":"12582439","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Clearing patch available, as the patch 1a causes errors in the tests.\r\nI still want comments on the approach taken, and I plan to fix the bug (NPE) as in patch 1b.\r\nThe problem is that the LOB state tracker is not always initialized at the time it is attempted accessed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-03-26T21:33:24.638+0000","updated":"2008-03-26T21:33:24.638+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12582649","id":"12582649","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Hi Kristian,\r\n\r\nI think the approach sounds good. Of course, having one of the\r\noptimizations you mentioned would be good, preferably option 2. I\r\nthink there are valid and meaningful use cases where a user doesn't\r\nlook at all the LOBs fetched, so it would be worthwhile to optimize\r\nit. For instance, you could have code structured like this\r\n\r\n  ResultSet rs = stmt.executeQuery(\"select int1, int2, string1, blob1 from t\");\r\n  while (rs.next()) {\r\n    ...\r\n    if (someConditionIsTrue) {\r\n        processBlob(rs.getBlob(4));\r\n    }\r\n    ...\r\n  }\r\n\r\nBut optimization can come later. First step is to fix the leak.\r\n\r\nI have read through the patch. Please see my (minor) comments below.\r\n\r\n* NetConnection:\r\n  - typo: \"layber B\" -> \"layer B\"\r\n\r\n* Cursor:\r\n  - typo: getLocatorProedures -> getLocatorProcedures\r\n\r\n* NoOpLOBStateTracker:\r\n  - class javadoc (and assert in noRelease()) indicates that the class\r\n    is only used when the server doesn't support locators. Isn't it\r\n    also used when the result doesn't contain LOBs?\r\n\r\n  - should we have a static instance of this class, so that we don't\r\n    have to allocate a new one each time a statement without LOBs is\r\n    executed? Since it doesn't do anything, there's no thread-safety\r\n    issues preventing us from sharing the same instance between all\r\n    the threads, I think.\r\n\r\n* ResultSet:\r\n\r\n  - it would be good if keepLocatorColumnAlive() and\r\n    createLOBColumnTracker() had javadoc comments\r\n\r\n+        if (this.lobState != null) {\r\n+            if (SanityManager.DEBUG) {\r\n+                SanityManager.THROWASSERT(\r\n+                        \"LOB state tracker already initialized.\");\r\n+            }\r\n+        }\r\n\r\nPerhaps the above code is clearer if it's written like this?\r\n    if (SanityManager.DEBUG) {\r\n        SanityManager.ASSERT(this.lobState == null, \"...\");\r\n    }\r\n\r\n+                if (type == Types.BLOB) {\r\n+                    tmpIndexes[lobCount] = i +1; // Convert to 1-based index.\r\n+                    tmpIsBlob[lobCount++] = true;\r\n+                } else if (type == Types.CLOB) {\r\n+                    tmpIndexes[lobCount] = i +1; // Convert to 1-based index.\r\n+                    tmpIsBlob[lobCount++] = false;\r\n+                }\r\n\r\nPerhaps the above code could be more compact, like this?\r\n    if (type == Types.BLOB || type == Types.CLOB) {\r\n        tmpIndexes[lobCount] = i + 1; // Convert to 1-based index.\r\n        tmpIsBlob[lobCount++] = (type == Types.BLOB);\r\n    }","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-03-27T13:48:40.699+0000","updated":"2008-03-27T13:48:40.699+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12582698","id":"12582698","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Thanks for the comments Knut Anders.\r\nThis is work in progress, so the next patch will have some changes.\r\n\r\nI will fix the typos, and also add more comments/JavaDoc. I renamed the method keepLocatorColumnAlive to markLOBAsAccessed, in hope that it gives more meaning...\r\nSee below regarding the rest of your comments.\r\n\r\n* NoOpLOBStateTracker\r\n  Yes, that is a good idea. It is now a singleton.\r\n  It is also correct that it will be used for result sets without LOBs.\r\n\r\n* Fixed assert.\r\n\r\n* Rewrote code block for compactness.\r\n  On a side note, this code will only be in 10.3. For 10.4 and trunk I plan to make a few changes so it is no longer required to know if it is a Blob or a Clob. This requires two changes; a small refactoring (issue not yet created) and optimization 1 mentioned in my earlier comment.\r\n\r\n\r\nI will upload a replacement patch shortly, which addresses other problems in 1a.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-03-27T15:41:24.378+0000","updated":"2008-03-27T15:41:24.378+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12582714","id":"12582714","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"'derby-3571-1b-client_track_lob_fix.diff' replaces version 1a.\r\nIt addresses the comments made by Knut Anders, and the following changes:\r\n * LOB state object properly initialized\r\n * Check if positioned on insert row before checking current row (see the closeX-method).\r\n * Changed some state maintenance in LOBStateTracker.\r\n\r\nI ran suites.All without failures (except the JMX failure), but I made some last minutes changes so I'm rerunning.\r\nI plan to get this code into 10.3, 10.4 and trunk. The optimization will be handled under a separate JIRA and will only go into 10.4 and trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-03-27T16:16:37.322+0000","updated":"2008-03-27T16:16:37.322+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12582717","id":"12582717","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"New revision of the patch ready for review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-03-27T16:17:25.388+0000","updated":"2008-03-27T16:17:25.388+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12582967","id":"12582967","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"'derby-3571-1c-client_track_lob_fix.diff' replaces an int array with a bool array in LOBStateTracker, as only two states are required.\r\nAlso contains some JavaDoc changes.\r\n\r\nTests ran cleanly.\r\nI'm considering 1c for commit.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-03-28T10:08:43.638+0000","updated":"2008-03-28T10:08:43.638+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12583635","id":"12583635","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"'derby-3571-1d-client_track_lob_fix.diff' introduces a LOBStateTracker interface and two implementations of it: SingleReleaseLOBTracker and NoOpLOBTracker. As a follow-up patch for DERBY-3575, I plan to add MultipleReleaseLOBTracker.\r\n\r\nThe trackers will use different mechanisms to release the locators. A final step, which I don't plan to implement for 10.4, is to piggy-back locators to release to the server on other requests. This approach is why I chose to add the locatorsForRelease method.\r\n\r\nTo sum of the mechanism used by the trackers:\r\n * NoOpLOBTracker: no release\r\n * SingleReleaseLOBTracker: a stored procedure call for each locator to release, invoked at every result set navigational methods and rs.close.\r\n * MultipleReleaseLOBTracker: a stored procedure call for a set of locators to release, invocation time not yet decided.\r\n\r\nI'm running tests, and if they pass I plan to commit this patch later today.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-03-31T11:03:50.196+0000","updated":"2008-03-31T11:03:50.196+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12583666","id":"12583666","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"The tests ran cleanly, but a commit for DERBY-2892 caused a minor conflict.\r\nI have updated the patch (revision 1e), and I'm running a subset of the tests to see if the two patches fare well together.\r\n\r\nI still expect to commit the patch shortly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-03-31T12:42:57.299+0000","updated":"2008-03-31T12:42:57.299+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12583812","id":"12583812","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Just a quick control question:\r\n\r\nThe plan is to have three different mechanisms for releasing LOBs in the client driver?\r\n\r\n  a) SingleReleaseLOBTracker if the server version is 10.3\r\n  b) MultipleReleaseLOBTracker if the server version is 10.4\r\n  c) some yet to be implemented piggybacking protocol if the server version is 10.5 or higher\r\n\r\nWon't this add up to a fair amount of code that, once newer versions are released, ends up being more or less dead and untested code? Or is there a way some of the mechanisms could be consolidated or perhaps phased out later?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-03-31T19:57:53.979+0000","updated":"2008-03-31T19:57:53.979+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12583882","id":"12583882","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"All elements of SingleReleaseLOBTracker.trackColumn[] are false until checkCurrentRow() is called (normally on ResultSet.next()). Doesn't this mean that the LOBs in the first row returned from the query won't be released until the transaction is completed?\r\n\r\nIn SingleReleaseLOBTracker.checkCurrentRow(), should trackColumn[i] be set to true unconditionally rather than in the else block? Whether or not column i were accessed in row n shouldn't affect whether we release the locator in row n+1, should it?\r\n\r\nNit: SingleReleaseLOBTracker.noRelease() doesn't need the sanity check variable (indexFound) if \"break\" is replaced with \"return\", and \"ASSERT\" is replaced with \"THROWASSERT\". Actually, since columns[] is a sorted int array (isn't it?), it should be possible to simplify this method further by using Arrays.binarySearch().\r\n\r\nTypo in ResultSet.createLOBColumnTracker(): \"simply\" -> \"simplify\"","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-03-31T21:28:34.539+0000","updated":"2008-03-31T21:28:34.539+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12583885","id":"12583885","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"In SingleReleaseLOBTracker,\r\nI am sure I am missing something, but looking at the patch, I don't understand how the elements of the trackColumn array are ever set to true, so that the lobs get released.  Shouldn't they be initialized to true in the constructor and reset to true in discardState()?  Then they would get set to false by noRelease() when the lob is accessed.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-03-31T21:36:33.393+0000","updated":"2008-03-31T21:36:33.393+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12583889","id":"12583889","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Should we also add !connection_.autoCommit_ as a condition for invoking checkCurrentRow() in ResultSet.closeX()? As it is now, we'll send a release command to the server right before ResultSet.close() triggers a commit, but in that case the commit would have released the locator anyway.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-03-31T21:40:05.725+0000","updated":"2008-03-31T21:40:05.725+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12583893","id":"12583893","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"You can ignore my comment. I didn't see Knut's before I posted.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-03-31T21:46:55.615+0000","updated":"2008-03-31T21:46:55.615+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12584049","id":"12584049","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Thanks for all the reviewing Knut and Kathey.\r\n\r\nThis is still rather \"unstable\" code, and I have newer versions in the pipeline. Let me comment on the simple things first.\r\n\r\na) No release of LOBs in the first row.\r\n  This is a bug introduced when I made it a requirement that checkCurrentRow should only be called on a vaild row. I'll fix this.\r\n\r\nb) Setting trackColumn to true in checkCurrentRow.\r\n  Won't it always be true with the current code? To enter the if-block it must be true, and we don't need to set it again. Otherwise we enter the else-block and set it to true. I do see the point of setting it to true unconditionally for readability though. In a newer patch (not published yet), I have renamed \"trackColumn\" to \"accessed\".\r\n\r\nc) noRelease\r\n  I'll rewrite it using Arrays and remove the check variable. Another question is whether an exception should be thrown in any case, as providing an invalid index seems like a programming error.\r\n  Further, I was thinking about using noRelease to thrown an exception if the LOB column had already been accessed, but there might be other approaches one can use to make Derby fail if a LOB column is accessed twice.\r\n\r\nd) The comment with the typo will be removed, and the code in createLOBColumTracker partly rewritten.\r\n   We now need a functioning tracker also when locators are unsupported.\r\n\r\ne) !connection_.autoCommit_ condition for calling checkCurrentRow\r\n   A good further optimization. Thanks. I think we need to think about how to handle this for statements with multiple result sets though, as that might cause the autocommit to be skipped even though the connection has autocommit set.\r\n\r\n\r\nRegarding the control question above, yes there will be multiple release mechanisms. I have thought of these names:\r\n * NoReleaseLOBTracker\r\n * SingleReleaseLOBTracker\r\n * BatchReleaseLOBTracker\r\n * A tracker using piggybacking.\r\n\r\nOriginally I introduced an interface and created different implementations for the tracker to avoid maintaining state I didn't need. Now that we plan to use the tracker to also track accesses to LOB columns, we need some common code in all of the implementations.\r\nWould it perhaps be better to have only one tracker implementation and instead implement multiple \"releasers\"?\r\nI think the tracker should be able to determine the proper release mechanism itself in the constructor.\r\n\r\nAny other ideas?\r\nIf not, I will implement a first version of the approach I have described and post a patch for review later today.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-04-01T08:13:04.401+0000","updated":"2008-04-01T08:13:04.401+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12584086","id":"12584086","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"b) You're of course right, I had missed that. No need to set it to true, except perhaps for readability. The rename sounds like a good idea.\r\n\r\nc) It's probably not necessary to throw the assert or an exception, since Arrays.binarySearch() returns a negative value if it cannot be found, and then we'll get an ArrayIndexOutOfBoundsException immediately when we update the array, so the error won't go unnoticed. By the way, is markAccessed a better name than noRelease for this method?\r\n\r\ne) Such an optimization could wait if it is too much work. Seems like the easiest way to get this information is to factor out some of the logic from Statement.resultSetCommitting().\r\n\r\nUsing a single shared tracker implementation sounds good. My concern is that we add the BatchReleaseLOBTracker only for the 10.4 release, and get some code that we need to maintain forever for backward compatibility (like the stored procedure to release a range of LOBs) although it's only needed for a single minor release. Perhaps, if the plan is to implement the piggybacking for 10.5, it would be a better long-term solution to skip the BatchReleaseLOBTracker and let 10.4 use the less efficient SingleReleaseLOBTracker?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-01T09:48:10.027+0000","updated":"2008-04-01T09:48:10.027+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12584283","id":"12584283","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"'derby-3571-2a-simple_release.diff' deprecates patch revision 1.\r\n\r\nThe patch implements only the simple release mechanism (one locator at a time). Thanks to Knut Anders for commenting on the compatibility issues.\r\nI have addressed comment (c), but chose to skip/postpone item (e), and added some simple tests. The tests are mainly for checking that the code works to some degree, it doesn't check that the code works optimally or entirely correct.\r\n\r\nI have also added a workaround in checkCurrentRow for something that is really a problem in ResultSet.\r\nI am not easily able to determine if the current row has changed on all the navigational methods, and checkCurrentRow will fail if called twice on the same row (the locators are already released). I added lastSeenLocator, and upon release time the current locator is checked with the last one seen for the column. If they are equal, checkCurrentRow returns immediately.\r\n\r\nI looked at using information in ResultSet to avoid calling the method multiple times on the same row, but couldn't find a solution quickly. If you know about one, let me know :)\r\nAs an example of how to provoke the problem, consider calling rs.absolute(X) twice or rs.moveToCurrentRow() twice.\r\n\r\nI have run derbynet, jdbc4 and jdbcapi without errors. I'm currently running suites.All and derbyall.\r\n\r\nIt is my opinion that this patch may change the premises for DERBY-2892 and possibly DERBY-3583. It would therefore be nice if we could get this patch in as soon as possible.\r\n\r\nPlease review.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-04-01T20:21:20.049+0000","updated":"2008-04-01T20:21:20.049+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12584476","id":"12584476","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I've tried out the 2a patch and it seems to work as intended. My only nits are:\r\n\r\n  - LOBStateTracker.checkCurrentRow(): couldn't Arrays.fill() be moved inside the if block?\r\n  - should discardState() and markAccessed() check the release flag?\r\n  - should ResultSet.createLOBColumnTracker() use LOBStateTracker.NO_OP_TRACKER instead of allocating a new when serverSupportsLocators() returns false?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-04-02T09:18:20.294+0000","updated":"2008-04-02T09:18:20.294+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12584485","id":"12584485","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Committed patch 2a to trunk with revision 643819. I'll wait a little before I backport to 10.4.\r\n\r\nThanks for the continued review Knut Anders.\r\nThe answer to your latest questions are either no or yes to all. It depends on whether the tracker shall be used to track LOB accesses to allow the client to throw an exception if a LOB column is accessed more than once.\r\nIf we don't want to track accesses, all your suggestions are valid.\r\n\r\nI don't think we have reached consensus on what to do. Related issues are DERBY-3583 and DERBY-2892.\r\nPeople should comment on the former if they have opinions on whether or not to allow multiple calls to the various getter methods for LOB columns (except for those returning a stream).\r\n\r\n\r\nI'm not resolving the issue, because I believe there might be some follow-up changes.\r\nAlso, can anyone confirm that the new test can be run on J2ME platforms?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-04-02T09:44:04.616+0000","updated":"2008-04-02T09:44:04.616+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12584530","id":"12584530","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"I have seen derbyall/derbylang/subquery.diff fail a few times with the patch. It happens only on Java SE 6, and when it is run as part of derbyall. So far I haven't been able to reproduce running the test individually.\r\nThe first part of the diff looks like this:\r\n< Hash Join ResultSet:\r\n1431a1431\r\n> Nested Loop Join ResultSet:\r\n1544 del\r\n< \tHash Table ResultSet (13):\r\n1544a1544\r\n> \tProject-Restrict ResultSet (13):\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-04-02T12:04:29.513+0000","updated":"2008-04-02T12:04:29.513+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12584537","id":"12584537","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomanie","name":"thomanie","emailAddress":"thomas dot nielsen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thomas Nielsen","active":true},"body":"The diffs you see IMHO look like the optimizer is choosing different solutions for the subquery flattening?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomanie","name":"thomanie","emailAddress":"thomas dot nielsen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thomas Nielsen","active":true},"created":"2008-04-02T12:20:48.731+0000","updated":"2008-04-02T12:20:48.731+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12584676","id":"12584676","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"It seems highly unlikely that this client only patch could have caused such a failure.  Did you perhaps recently change your jdk version and this is what is causing the issue.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-04-02T17:25:35.637+0000","updated":"2008-04-02T17:25:35.637+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12586313","id":"12586313","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Backported the fix (trunk revision 643819) to the 10.4 branch with revision 645438.\r\nI will file another Jira for the comments Knut Anders posted, as they should be addressed if we decide not to throw exceptions for accessing a LOB column multiple times (in the non-stream cases).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-04-07T10:12:22.977+0000","updated":"2008-04-07T10:12:22.977+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12586327","id":"12586327","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Filed DERBY-3601 for the clean up actions.\r\nI will close this issue shortly after the test results are in. Problems / bugs with the implementation should be filed as separate issues.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-04-07T10:40:59.223+0000","updated":"2008-04-07T10:40:59.223+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12392355/comment/12592427","id":"12592427","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Thanks Kathey for backporting the fix(es) to 10.3.\r\nNo problems with the changes have been identified, I'm closing the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-04-25T16:21:22.990+0000","updated":"2008-04-25T16:21:22.990+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3571/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i072p3:"}}
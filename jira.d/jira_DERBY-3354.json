{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12387321","self":"https://issues.apache.org/jira/rest/api/latest/issue/12387321","key":"DERBY-3354","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313142","id":"12313142","description":"","name":"10.3.3.0","archived":false,"released":true,"releaseDate":"2008-05-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2008-01-29 14:54:20.741","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23590","customfield_12310222":"1_*:*_1_*:*_6008378603_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_1848567764","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-04-07T08:50:04.327+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3354/watchers","watchCount":0,"isWatching":false},"created":"2008-01-28T19:50:25.724+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"7.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312876","id":"12312876","description":"","name":"10.3.2.1","archived":false,"released":true,"releaseDate":"2007-12-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-06-30T15:55:40.052+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"Retrieving from a large table with lobs gives an OutOfMemoryException, even if free() is explictly called on the lob.   I believe this is because EmbedConnection.addLobMapping is called for every lob creation but is never cleared until commit or rollback, even if the lob is freed.\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10420","value":"Regression","id":"10420"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"38841","summary":"Select from large lob table with embedded gives OutOfMemoryError","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":27,"total":27,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12563265","id":"12563265","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Atttached is a program to reproduce this issue.\r\nRun java -Xmx16M LocLeak. I got the error on the 68000 row of retreival with the free(). Sooner if I didn't call free.\r\n\r\nException in thread \"main\" java.lang.OutOfMemoryError: Java heap space\r\n        at java.util.Arrays.copyOf(Arrays.java:2882)\r\n        at java.lang.AbstractStringBuilder.expandCapacity(AbstractStringBuilder.java:100)\r\n        at java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:390)\r\n        at java.lang.StringBuilder.append(StringBuilder.java:119)\r\n        at java.lang.Object.toString(Object.java:219)\r\n        at java.lang.String.valueOf(String.java:2827)\r\n        at java.lang.StringBuffer.append(StringBuffer.java:219)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.restoreContextStack(EmbedConnection.java:1960)\r\n        at org.apache.derby.impl.jdbc.ConnectionChild.restoreContextStack(ConnectionChild.java:131)\r\n        at org.apache.derby.impl.jdbc.UTF8Reader.fillBuffer(UTF8Reader.java:567)\r\n        at org.apache.derby.impl.jdbc.UTF8Reader.read(UTF8Reader.java:245)\r\n        at org.apache.derby.impl.jdbc.ClobUpdatableReader.read(ClobUpdatableReader.java:154)\r\n        at org.apache.derby.impl.jdbc.EmbedClob.getSubString(EmbedClob.java:225)\r\n        at LocLeak.dump_db(LocLeak.java:50)\r\n        at LocLeak.main(LocLeak.java:13)\r\n\r\nNote there may be problems freeing the locators on garbage collection, because client relies upon them even after there is no embedded reference.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-01-28T19:53:25.065+0000","updated":"2008-01-28T19:53:25.065+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12563268","id":"12563268","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Marking as regression as I confirmed this does not occur with 10.2.2.0\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-01-28T19:57:15.311+0000","updated":"2008-01-28T19:57:15.311+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12563275","id":"12563275","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"This regression was caused by the following checkin:\r\nr546881 | bernt | 2007-06-13 07:06:30 -0700 (Wed, 13 Jun 2007) | 1 line\r\n\r\nDERBY-2787 make entry for clob in connection so that temporary file is removed when a connectionn is commited/rolledback. Submitted by Anurag Shekhar","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-01-28T20:26:20.459+0000","updated":"2008-01-28T20:26:20.459+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12563539","id":"12563539","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"> I believe this is because EmbedConnection.addLobMapping is called for every lob creation but is never cleared until commit or rollback, even if the lob is freed.\r\n\r\nI believe your analysis is correct. free() should remove the mapping. Unfortunately, the lob doesn't know about its locator value, but it seems like your about to change that by adding a getLocator() method in DERBY-3243.\r\n\r\nOn DERBY-3243 I wrote:\r\n> Another thing I came to think about: Would it be better to remove addLOBMapping() from the constructors in EmbedBlob/EmbedClob and instead call it lazily from getLocator()? (...) Then we'd also remove the overhead of maintaining the lob mapping in embedded mode.\r\n\r\nI think that change would fix the OOME (on embedded, but we'd probably still see it in a client/server environment).\r\n\r\nNow, it seems like DERBY-2787 added the call to addLOBMapping() intentionally to ensure that free() was called on commit/rollback and temporary files would be deleted. Moving addLOBMapping() out of the constructors would probably reintroduce the problem with temporary files not being deleted. However, the lobs only create temporary files when they are modified and the new size of the lob is greater than the buffer in LOBStreamControl, so it shouldn't be necessary to have commit/rollback call free() on all lobs to delete the temporary files. It would probably be enough if each lob added itself to a list in the connection each time a temporary file was created in LOBStreamControl.init(). (addLOBMapping() is probably OK, but it feels a bit strange to piggyback on a locator mechanism to do this cleanup when we don't actually care about the locators.)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-01-29T14:54:20.741+0000","updated":"2008-01-29T14:54:20.741+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12568123","id":"12568123","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"The attached patch makes the repro run without getting an OutOfMemory error.\r\nThis is achieved by removing the LOB object from the locator mapping.\r\n\r\nI am not setting patch available since test cases should also be added,\r\nand I have not run the regression test suites.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-02-12T14:03:32.440+0000","updated":"2008-02-12T14:05:08.922+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12568177","id":"12568177","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks for the patch.  I tried it out and it and have a few comments.\r\n\r\n1) In EmbedBlob should the call to  localConn.removeLOBMapping(locator); be in a finally block like it is in EmbedClob?\r\n\r\n2) In jdk15 we don't have free()  so would still have a leak. Do you have any suggestions for a jdk15 solution?\r\n\r\n3) I removed the call to free() from the repro and ran \r\njava LocLeak and got.\r\nRetrieving row 99000\r\nException in thread \"main\" java.sql.SQLException: Java exception: ': java.util.ConcurrentModificationException'.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:95)\r\n        at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:88)\r\n        at org.apache.derby.impl.jdbc.Util.javaException(Util.java:245)\r\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:403)\r\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:346)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:1946)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.rollback(EmbedConnection.java:1521)\r\n        at LocLeak.main(LocLeak.java:14)\r\nCaused by: java.sql.SQLException: Java exception: ': java.util.ConcurrentModificationException'.\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(SQLExceptionFactory40.java:13\r\n5)\r\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(SQLExceptionFactory40.java:70)\r\n        ... 7 more\r\nCaused by: java.util.ConcurrentModificationException\r\n        at java.util.HashMap$HashIterator.nextEntry(HashMap.java:793)\r\n        at java.util.HashMap$ValueIterator.next(HashMap.java:821)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.clearLOBMapping(EmbedConnection.java:2737)\r\n        at org.apache.derby.impl.jdbc.EmbedConnection.rollback(EmbedConnection.java:1519)\r\n        ... 1 more","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-02-12T16:06:04.586+0000","updated":"2008-02-12T16:06:04.586+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12568226","id":"12568226","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Also should the removeLobMapping calls be removed from LobStoredProcedures.BLOBRELEASELOCATOR and CLOBRELEASELOCATOR now that the release happens in free()?\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-02-12T17:17:34.389+0000","updated":"2008-02-12T17:17:34.389+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12569268","id":"12569268","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"Kathey, I agreed that more needs to be done for a final patch.  I just put together a patch with the core fix to make it possible to try out the fix.\r\n\r\nTo your issues:\r\n1) Creating a finally block in EmbedBlob seems like a good idea.  I also agree that we can remove similar code from the stored procedures.\r\n\r\n2) I will think about solution for jdk15. The problem introduced by 10.3 is that the lob mapping keeps Blob/Clob objects alive that earlier would be gc'ed when it was no longer referred by the user.  I guess another level of indirection would make it possible to use finalizers to clean up, but I am not sure that is a good idea.\r\nA work-around is to not create Blob objects in the first place, but use ResultSet#getBytes etc instead.  So the problem is limited to the case where a Blob object need to be accessible after a call to ResultSet#next, but not until commit.\r\n\r\n3) Seems like there is come concurrent access to the HashMap.  I would guess that this is because the iterator created by rollback, detects that the underlying collection has been changed.  Probably through the calls to free in the loop using the iterator.  I think this show that something needs to be reorganized a bit here.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-02-15T13:31:42.345+0000","updated":"2008-02-15T13:31:42.345+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12584108","id":"12584108","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"body":"LobMapping and locater is used by the stored procedures (on behalf of \r\nnetwork driver) to get hold of a particular lob object. LobMapping is additionally \r\nused to clear the lob object during commit/rollback and connection close. \r\n\r\nSeparating these two functionality in two different collections may solve OOM problem.\r\n\r\nWe can continue to have LobMapping only if the LOB is created through client driver (entry will \r\nbe made in LOBMapiing in getLocator)\r\n\r\nCreate methods will make an entry to a new collection holding week references of the LOBs. \r\n\r\nThis will ensure that LOB will get garbage collected if they unreferenced in Embedded \r\nmode but in case of client server mode the references will be protected from being garbage \r\ncollected unless free is called by the stored procedure. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"created":"2008-04-01T11:21:48.902+0000","updated":"2008-04-01T11:21:48.902+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12584521","id":"12584521","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"body":"In this patch I have introduced  a WeakHashMap to hold lob objects. \r\nThe WeakHashMap has lob objects as key and null as values. \r\nThe existing lobMapping is used only if a locater is requested (ie when accessed from client driver). \r\n\r\nWith this patch the attached test case (LocLeak.java) runs without getting out of memory exception (without free call from LocLeak). \r\n\r\nThis patch has changes related to Clob only and I havn;t run any test other that attached LocLeak. I will submit a complete patch shortly.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"created":"2008-04-02T11:41:13.556+0000","updated":"2008-04-02T11:41:13.556+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585005","id":"12585005","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"If I understand correctly, the idea behind using a WeakHashMap is that if this is the only reference, it should not prevent the referred object from being garbage-collected.\r\nIn other words, as long as a user thread or the network server through locators, refers to the object, it will not be garbage-collected, but if such references does not exist, the object will be garbage-collected.    This is an interesting idea.  \r\n\r\nMy question is whether it is OK that free is not called on the LOB objects that are garbage-collected this way.  Are you certain that all associated resources (e.g., temp files) will be released?  Maybe some finalizer clean-up  will also be needed?\r\n\r\nOther comments/questions:\r\n  * It seems getLocator will create a new locator on every call.  I think there should be just a single locator per object.  Otherwise, I think the clean-up will be difficult.\r\n  * free:  Willl removeLOBMapping handle correctly the cases where a locator has not been set?\r\n  * typo: Refrence\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-04-03T08:14:44.145+0000","updated":"2008-04-03T08:14:44.145+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585015","id":"12585015","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"body":"Thanks Øystein  for look at the patch.\r\n\r\nMy question is whether it is OK that free is not called on the LOB objects that are garbage-collected this way. Are you certain that all associated resources (e.g., temp files) will be released? Maybe some finalizer clean-up will also be needed?\r\n\r\nIf there is no free called (or release on internal clob) the temporary file will not be cleaned. But the temporary file \r\nsystem is cleaned every time db boots up. I was under impression that disk operations are not allowed from \r\nfinalize. Probably I was wrong. I will check and if its not restricted I will add finalizer for EmbedClob and \r\nEmbedBlob.\r\n\r\nOther comments/questions:\r\n  * It seems getLocator will create a new locator on every call. I think there should be just a single locator per object. Otherwise, I think the clean-up will be difficult.\r\n\r\nI will be checking it to check if the locator is 0 before calling addMapping. \r\n\r\n  * free: Willl removeLOBMapping handle correctly the cases where a locator has not been set?\r\nHashMap ignore remove call if key is not found in the Map So there is no problem If we call \r\nremove with invalid key.\r\n\r\n  * typo: Refrence \r\nI will fix this,","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"created":"2008-04-03T08:49:37.048+0000","updated":"2008-04-03T08:49:37.048+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585049","id":"12585049","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"I do think that it is a good idea to put disk operations in a finalizer, but it should be possible to record work that needs to be done (e.g., at transaction commit).   I do not think delaying clean-up of files until db reboot is acceptable since a server may be running for months without a reboot.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-04-03T11:17:12.550+0000","updated":"2008-04-03T11:17:12.550+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585282","id":"12585282","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"body":"Description of derby-3354_v1.diff\r\nThis patch introduces a new WeakHashMap in EmbedConnection. EmbedBlob and EmbedClob objects references are stored in this \r\nmap (objects as key and null as value). Adding entry to locater map is \r\ndiffered till the first call of getLocater. \r\nThis ensures that there is entry of LOB objects in locater map if they are invoked in embedded mode. \r\nAs the keys of WeakHashMap doesn't prevents the objects from being \r\ngarbage collected, once the lob objects are unreferenced lob objects will \r\nbe garbage collected releasing the memory.\r\n\r\nDuring commit/rollback or Connection.close, free is invoked on all the lob \r\nobjects from WeakHashMap and the map is cleared.\r\n\r\nModified files\r\njava/engine/org/apache/derby/impl/jdbc/EmbedConnection.java\r\nAdded a new attribute lobRefrences of type WeakHashMap.\r\nAdded a new method addLOBReference to make an entry in new\r\n hash map.\r\nModified clearLOBMapping to use lobRefrences to fetch and invoke free on lob objects instead of lobHashMap.\r\n\r\njava/engine/org/apache/derby/impl/jdbc/EmbedBlob.java\r\njava/engine/org/apache/derby/impl/jdbc/EmbedClob.java\r\n\r\nModified constructs to call connection.lobRefrences instead of conn.addLOBMapping.\r\nModified getLocater method to check if the locater value is non zero \r\nbefore returning and if its zero calling conn.addLOBMapping to make \r\nentry of lob objects and getting locater value. \r\nCalling removeLOBMapping in free method.\r\n\r\n\r\nCleanup of temporary file is already being taken care by the finalizer of \r\nLOBStreamControl so I haven't added any new cleanup code for \r\nfinalizer.\r\n\r\nlang and jdbcapi junit tests running clean with this patch applied. I am running rest of the test suite and will update the results of the same.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"created":"2008-04-03T20:53:27.471+0000","updated":"2008-04-03T20:53:27.471+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585299","id":"12585299","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"I haven't validated the approach, but it seems reasonable. I applied the patch and compiled Derby.\r\n\r\nSome *very minor* things you can consider changing:\r\n 1) Typos: \"refrences\" -> \"references\" (5 occurrences)\r\n 2) Use of a space between the method call / declaration and the following parenthesis is not consistent.\r\n 3) Trailing whitespace at diff lines 28, 107 and 148.\r\n 4) You could change the comment for the weak hash map to JavaDoc.\r\n\r\nNice and small change :)\r\nIs this the final patch, or are the more coming up?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2008-04-03T21:43:23.083+0000","updated":"2008-04-03T21:43:23.083+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585440","id":"12585440","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"body":"Thanks Kristian for looking at the patch. \r\nI will make the changes you have suggested and upload the patch.\r\nI am not planing for any more version of this patch (except for review changes.)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"created":"2008-04-04T07:52:21.965+0000","updated":"2008-04-04T07:52:21.965+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585449","id":"12585449","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"body":"in derby-3354_v2.diff I have fixed the issues Kristian had pointed out.\r\n\r\njunit suites runs without any failure wit this patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"created":"2008-04-04T08:58:03.577+0000","updated":"2008-04-04T08:58:03.577+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585477","id":"12585477","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"Thanks for the patch Anurag. Comments:\r\n\r\n - I guess you need to do removeLOBMapping in EmbedBlob#free too.\r\n - Any resaon to keep references for already freed objects around until end of transaction?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-04-04T10:17:47.803+0000","updated":"2008-04-04T10:17:47.803+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585483","id":"12585483","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"body":"Thanks Oystein for pointing out. I missed it, I will upload the patch after adding this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"created":"2008-04-04T10:36:53.305+0000","updated":"2008-04-04T10:36:53.305+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585491","id":"12585491","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"body":"Added localConn.removeLOBMapping in Blob.free\r\nBlobClob4BlobTest runs fine with this change. I am \r\nrunning suites.All now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"created":"2008-04-04T10:59:15.092+0000","updated":"2008-04-04T10:59:15.092+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585531","id":"12585531","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"Is the removeLOBMapping put in the right plcae?\r\nDon't you have to do it regardless of whether it is materialized or not?\r\nMaybe it should have been put in a finally block like for EmbedClob?  (Ref.  Kathey's comment on my initial patch)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-04-04T13:51:38.240+0000","updated":"2008-04-04T13:51:38.240+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585580","id":"12585580","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"body":"Putting remove mapping in else was a mistake. Sorry about that.\r\nI have moved it above other cleanup operation so that hash table is \r\ncleared irrespective of the result of other clean up.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anurag","name":"anurag","emailAddress":"anurag dot shekhar at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anurag Shekhar","active":true},"created":"2008-04-04T15:20:35.182+0000","updated":"2008-04-04T15:20:35.182+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585625","id":"12585625","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"Thanks, for the updates, Anurag\r\nPatch v4 committed at revision 644764.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-04-04T16:39:55.290+0000","updated":"2008-04-04T16:39:55.290+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585633","id":"12585633","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"It would be good if a test code be made based on the program that reproduced this error.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-04-04T16:51:01.249+0000","updated":"2008-04-04T16:51:01.249+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12585762","id":"12585762","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"body":"Fix merged to 10.4 branch at revision 644916.\r\nI am not setting this to resolve yet, since I think a test case for this should be added to the test suite.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oysteing","name":"oysteing","emailAddress":"oystein dot grovlen at sun dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Øystein Grøvlen","active":true},"created":"2008-04-04T20:58:24.436+0000","updated":"2008-04-04T20:58:24.436+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12591832","id":"12591832","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I was thinking about whether to close this issue. Is there still a regression test coming?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-04-23T22:28:01.863+0000","updated":"2008-04-23T22:28:01.863+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12387321/comment/12592862","id":"12592862","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Going ahead and closing this issue. It would be good to have a regression test though.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-04-28T18:19:32.077+0000","updated":"2008-04-28T18:19:32.077+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3354/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i070gn:"}}
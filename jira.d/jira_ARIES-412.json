{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12474379","self":"https://issues.apache.org/jira/rest/api/latest/issue/12474379","key":"ARIES-412","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310981","id":"12310981","key":"ARIES","name":"Aries","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310981&avatarId=10065","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310981&avatarId=10065","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310981&avatarId=10065","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310981&avatarId=10065"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10520","id":"10520","description":"Apache Aries","name":"Aries"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-09-17 13:17:45.121","customfield_12312323":null,"customfield_12310420":"94023","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_345116364_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2010-09-21T12:56:27.904+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ARIES-412/watchers","watchCount":1,"isWatching":false},"created":"2010-09-17T13:04:31.540+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315310","id":"12315310","description":"","name":"0.3","archived":true,"released":true,"releaseDate":"2011-02-08"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linsun","name":"linsun","emailAddress":"linsun at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lin Sun","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-09-22T15:01:14.400+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[],"timeoriginalestimate":null,"description":"I've noticed that we are now receiving FinalModifierExceptions when running the samples (Blog and AriesTrader).  It seems to me that these are the result of some changes for quiesce support for JPA.   I'm not quite sure of the reason or purpose for the changes - but the function seems to be creating proxies for services using the AsmInterceptorWrapper for items that we did not previously create Asm proxies.  Not all of these objects work well as proxies and hence these exceptions.   This can be easily seen running either the Blog or AriesTrader samples after change rev. 995797 for ARIES-383 ( https://issues.apache.org/jira/browse/ARIES-383 )\r\n\r\norg.apache.aries.blueprint.proxy.FinalModifierException\r\n\tat org.apache.aries.blueprint.proxy.ProxySubclassGenerator.scanForFinalModifiers(ProxySubclassGenerator.java:323)\r\n\tat org.apache.aries.blueprint.proxy.ProxySubclassGenerator.getProxySubclass(ProxySubclassGenerator.java:118)\r\n\tat org.apache.aries.blueprint.proxy.ProxySubclassGenerator.newProxySubclassInstance(ProxySubclassGenerator.java:155)\r\n\tat org.apache.aries.blueprint.proxy.AsmInterceptorWrapper.createSubclassProxy(AsmInterceptorWrapper.java:163)\r\n\tat org.apache.aries.blueprint.proxy.AsmInterceptorWrapper.createProxyObject(AsmInterceptorWrapper.java:85)\r\n\tat org.apache.aries.blueprint.container.ServiceRecipe$TriggerServiceFactory.getService(ServiceRecipe.java:463)\r\n\tat org.eclipse.osgi.internal.serviceregistry.ServiceUse$1.run(ServiceUse.java:120)\r\n\tat java.security.AccessController.doPrivileged(Native Method)\r\n\tat org.eclipse.osgi.internal.serviceregistry.ServiceUse.getService(ServiceUse.java:118)\r\n\tat org.eclipse.osgi.internal.serviceregistry.ServiceRegistrationImpl.getService(ServiceRegistrationImpl.java:445)\r\n\tat org.eclipse.osgi.internal.serviceregistry.ServiceRegistry.getService(ServiceRegistry.java:430)\r\n\tat org.eclipse.osgi.framework.internal.core.BundleContextImpl.getService(BundleContextImpl.java:666)\r\n\tat org.apache.aries.blueprint.namespace.NamespaceHandlerRegistryImpl.addingService(NamespaceHandlerRegistryImpl.java:90)\r\n\tat org.osgi.util.tracker.ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:896)\r\n\tat org.osgi.util.tracker.AbstractTracked.trackAdding(AbstractTracked.java:261)\r\n\tat org.osgi.util.tracker.AbstractTracked.track(AbstractTracked.java:233)\r\n\tat org.osgi.util.tracker.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:840)\r\n\tat org.eclipse.osgi.internal.serviceregistry.FilteredServiceListener.serviceChanged(FilteredServiceListener.java:124)\r\n\tat org.eclipse.osgi.framework.internal.core.BundleContextImpl.dispatchEvent(BundleContextImpl.java:930)\r\n\tat org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent(EventManager.java:220)\r\n\tat org.eclipse.osgi.framework.eventmgr.ListenerQueue.dispatchEventSynchronous(ListenerQueue.java:149)\r\n\tat org.eclipse.osgi.internal.serviceregistry.ServiceRegistry.publishServiceEventPrivileged(ServiceRegistry.java:757)\r\n\tat org.eclipse.osgi.internal.serviceregistry.ServiceRegistry.publishServiceEvent(ServiceRegistry.java:712)\r\n\tat org.eclipse.osgi.internal.serviceregistry.ServiceRegistrationImpl.register(ServiceRegistrationImpl.java:129)\r\n\tat org.eclipse.osgi.internal.serviceregistry.ServiceRegistry.registerService(ServiceRegistry.java:206)\r\n\tat org.eclipse.osgi.framework.internal.core.BundleContextImpl.registerService(BundleContextImpl.java:506)\r\n\tat org.apache.aries.blueprint.container.BlueprintContainerImpl.registerService(BlueprintContainerImpl.java:388)\r\n\tat org.apache.aries.blueprint.container.ServiceRecipe.register(ServiceRecipe.java:174)\r\n\tat org.apache.aries.blueprint.container.BlueprintContainerImpl.registerServices(BlueprintContainerImpl.java:646)\r\n\tat org.apache.aries.blueprint.container.BlueprintContainerImpl.doRun(BlueprintContainerImpl.java:314)\r\n\tat org.apache.aries.blueprint.container.BlueprintContainerImpl.run(BlueprintContainerImpl.java:213)\r\n\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)\r\n\tat java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)\r\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:138)\r\n\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:98)\r\n\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:207)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\r\n\tat java.lang.Thread.run(Thread.java:637)\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"173039","summary":"FinalModifierExceptions as a result of Quiesce changes to add proxies for services","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbohn","name":"jbohn","emailAddress":"joe dot bohn at earthlink dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Bohn","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbohn","name":"jbohn","emailAddress":"joe dot bohn at earthlink dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Bohn","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":5,"total":5,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474379/comment/12910567","id":"12910567","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahrwald","name":"mahrwald","emailAddress":"vmahrwald at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Valentin Mahrwald","active":true},"body":"The changes allow us to do reference counting on the active users of a Blueprint service, so that we can quiesce by not allowing any one to make new calls into the service but wait for the existing calls to finish before taking the blueprint down.\r\n\r\nI can think of two reasons why we might be seeing final modifiers problems:\r\n- we are trying to proxy implementation objects like DataSource classes instead of the exposed service interfaces\r\n- we are trying to proxy objects that are already proxied (for example to support transaction interceptors) and are not reusing the existing proxy.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahrwald","name":"mahrwald","emailAddress":"vmahrwald at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Valentin Mahrwald","active":true},"created":"2010-09-17T13:17:45.121+0000","updated":"2010-09-17T13:17:45.121+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474379/comment/12910578","id":"12910578","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbohn","name":"jbohn","emailAddress":"joe dot bohn at earthlink dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Bohn","active":true},"body":"Thanks for the comments.   You are correct - we are seeing this for several objects that seem to fit your description:\r\n\r\n[Blueprint Extender: 2] DEBUG org.apache.aries.blueprint.proxy.AsmInterceptorWrapper - Method entry: createProxyObject, args [org.eclipse.osgi.internal.baseadaptor.DefaultClassLoader@79ca209e, ServiceMetadata[id='.component-1', activation=2, dependsOn=null, exportedComponent=BeanMetadata[id='null', initialization=0, dependsOn=null, className='org.apache.aries.transaction.parsing.TxElementHandler', initMethodName='null', destroyMethodName='null', arguments=null, properties=[BeanProperty[name='txMetaDataHelper', value=RefMetadata[componentId='txenhancer']], BeanProperty[name='transactionInterceptor', value=RefMetadata[componentId='txinterceptor']]], factoryMethodName='null', factoryComponent=null, scope='null', runtimeClass=null, fieldInjection=false], interfaces=[org.apache.aries.blueprint.NamespaceHandler], autoExportMode=1, serviceProperties=[MapEntry[key=ValueMetadata[stringValue='osgi.service.blueprint.namespace', type='null'], value=CollectionMetadata[collectionClass=interface java.util.List, valueType='null', values=[ValueMetadata[stringValue='http://aries.apache.org/xmlns/transactions/v1.0.0', type='null'], ValueMetadata[stringValue='http://aries.apache.org/xmlns/transactions/v1.1.0', type='null']]]]], ranking=0, registrationListeners=null], [org.apache.aries.blueprint.container.QuiesceInterceptor@4ab83be0], org.apache.aries.transaction.parsing.TxElementHandler@2bf8f8c8, [class org.apache.aries.transaction.parsing.TxElementHandler]]\r\n[Blueprint Extender: 2] DEBUG org.apache.aries.blueprint.proxy.AsmInterceptorWrapper - Single class to proxy: org.apache.aries.transaction.parsing.TxElementHandler\r\n[Blueprint Extender: 2] DEBUG org.apache.aries.blueprint.proxy.AsmInterceptorWrapper - Method entry: isProxyClass, args [class org.apache.aries.transaction.parsing.TxElementHandler]\r\n[Blueprint Extender: 2] DEBUG org.apache.aries.blueprint.proxy.AsmInterceptorWrapper - Caught exception\r\norg.apache.aries.blueprint.proxy.FinalModifierException\r\n\r\n... the NameSpace Handler for Declarative Transactions\r\n\r\nAND\r\n\r\n[Blueprint Extender: 2] DEBUG org.apache.aries.blueprint.proxy.ProxySubclassGenerator - Method entry: scanForFinalModifiers, args [class org.apache.derby.jdbc.EmbeddedXADataSource]\r\n[Blueprint Extender: 2] DEBUG org.apache.aries.blueprint.proxy.AsmInterceptorWrapper - Caught exception\r\norg.apache.aries.blueprint.proxy.FinalModifierException\r\n\r\n... a Datasource\r\n\r\nI've also seen this when I attempt to register the Interceptor as a Service and doing various other actions.  \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbohn","name":"jbohn","emailAddress":"joe dot bohn at earthlink dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Bohn","active":true},"created":"2010-09-17T13:43:55.419+0000","updated":"2010-09-17T13:43:55.419+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474379/comment/12912945","id":"12912945","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hramlee","name":"hramlee","emailAddress":"hramlee at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hannah Ramlee","active":true},"body":"I've attached a fix which should get rid of the FinalModifierExceptions. The fix makes sure we are just proxying the interfaces, so no longer hit these exceptions. \r\n\r\nThe fix should also alleviate the intermittent blueprint quiesce failures people might be seeing. I managed to reproduce these failures a couple of times, but since applying this change, I have not seen them fail at all. However, it still seems to be something to do with different environments - so if other people still see failures, please shout!\r\n\r\nThe patch also fixes the benign use-package exceptions that people might have seen when debugging failed blueprint quiesce tests. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hramlee","name":"hramlee","emailAddress":"hramlee at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hannah Ramlee","active":true},"created":"2010-09-21T12:03:07.094+0000","updated":"2010-09-21T12:03:07.094+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474379/comment/12912946","id":"12912946","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linsun","name":"linsun","emailAddress":"linsun at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lin Sun","active":true},"body":"Patch looks good to me, thanks Hannah.  Will try to commit it soon.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linsun","name":"linsun","emailAddress":"linsun at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lin Sun","active":true},"created":"2010-09-21T12:37:04.875+0000","updated":"2010-09-21T12:37:04.875+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474379/comment/12912954","id":"12912954","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linsun","name":"linsun","emailAddress":"linsun at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lin Sun","active":true},"body":"Patch committed with format change only.  thanks Hannah.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linsun","name":"linsun","emailAddress":"linsun at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lin Sun","active":true},"created":"2010-09-21T12:56:27.839+0000","updated":"2010-09-21T12:56:27.839+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ARIES-412/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0tzdb:"}}
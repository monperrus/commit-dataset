{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12343788","self":"https://issues.apache.org/jira/rest/api/latest/issue/12343788","key":"DERBY-1364","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":null,"customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22462","customfield_12310222":"3_*:*_1_*:*_841772000_*|*_1_*:*_1_*:*_1908982000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_609240000","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-07-03T13:13:39.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1364/watchers","watchCount":0,"isWatching":false},"created":"2006-06-01T17:07:45.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12310615","id":"12310615","description":"","name":"10.1.2.1","archived":false,"released":true,"releaseDate":"2005-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-07-10T14:27:39.000+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11407","id":"11407","name":"JDBC"},{"self":"https://issues.apache.org/jira/rest/api/2/component/11690","id":"11690","name":"Network Client"}],"timeoriginalestimate":null,"description":"When executing a stored procedure with executeQuery() and the proc\ndoesn't return exactly one result set, the query should fail and the\nstatement should be rolled back. Embedded does this correctly.\n\nThe client driver, however, does not roll back the statement, so the\neffects of statements executed on nested connections in the stored\nprocedure are still visible. The reason for this is that the network\nserver executes the statement with execute() instead of\nexecuteQuery(), so that it succeeds on the server. The client then\ncounts the number of result sets, and raises an exception if it is not\none, but it does not roll back the effects of the stored procedure.\nverified that.)\n\nThe same problem exists for executeUpdate(). JCC also has these\nproblems.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40590","summary":"Client driver does not roll back the effects of a stored procedure when incorrectly invoked by executeQuery()/executeUpdate()","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":5,"total":5,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12343788/comment/12414209","id":"12414209","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"The simple solution would be to trap the exception on the client and\r\nroll back. The problem with this is that it would roll back the entire\r\ntransaction, not only the failing statement as the embedded driver\r\ndoes.\r\n\r\nI see these three ways to fix it:\r\n\r\n  1) Accept that the entire transaction is rolled back. Since the\r\n     exception indicates that something is wrong with the application\r\n     (should not use executeQuery()/executeUpdate()) or with the\r\n     stored procedure (should return the correct number of result\r\n     sets), I don't think it does very much harm. The application will\r\n     probably not try to commit the transaction anyway.\r\n\r\n  2) Let the client set a savepoint before executing the query, and\r\n     roll back to the savepoint if an incorrect number of results is\r\n     returned. This has the downside of adding complexity to the code\r\n     and extra round trips between the client and the server.\r\n\r\n  3) Make the network server execute the query with executeQuery() or\r\n     executeUpdate() instead of execute() in these cases. This way,\r\n     the error will happen at the server and the embedded driver will\r\n     ensure that the statement is rolled back correctly. DRDA has no\r\n     direct support for this, but I think we could use a SET statement\r\n     (something like what was done in DERBY-506).\r\n\r\nDoes anyone have opinions on these alternatives? Or other suggestions?\r\nThanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-06-01T17:10:44.000+0000","updated":"2006-06-01T17:10:44.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12343788/comment/12414572","id":"12414572","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"My previous analysis of the problem wasn't entirely correct. Here's a\r\nnew attempt (hopefully correct this time):\r\n\r\nCommit/rollback behaviour when using executeQuery() to call a stored\r\nprocedure:\r\n\r\nAuto-commit enabled, no ResultSet returned from the stored procedure:\r\n\r\n  * Embedded: The statements executed from the stored procedure are\r\n    always rolled back.\r\n\r\n  * Client: The statements executed from the stored procedure are\r\n    always committed.\r\n\r\nAuto-commit enabled, more than one Result Set returned:\r\n\r\n  * Embedded: The statements executed from the stored procedure are\r\n    always rolled back.\r\n\r\n  * Client: If Connection.rollback() is called before the statement or\r\n    connection is closed, the statements executed from the stored\r\n    procedure are rolled back. If the statement or connection is\r\n    closed, or Connection.commit() is called, the statements executed\r\n    from the stored procedure are committed. If the connection dies\r\n    before any of commit(), rollback() or close() have been called,\r\n    the statements in the stored procedure are rolled back.\r\n\r\nAuto-commit disabled, no ResultSet or more than one ResultSet returned\r\nfrom the stored procedure:\r\n\r\n  * Embedded and client: If commit() is called, the entire transaction\r\n    is committed, including statements executed from the stored\r\n    procedure in the failing call to executeQuery(). If rollback() is\r\n    called, the entire transaction is rolled back.\r\n\r\nWhen using executeUpdate() to call a stored procedure which returns\r\none or more ResultSets, the embedded driver does not raise an\r\nexception. The client driver does that, and it has the same\r\ncommit/rollback behaviour as executeQuery() when the stored procedure\r\nreturns more than one ResultSet.\r\n\r\n\r\n\r\nSince the behaviour is the same for embedded and client when\r\nauto-commit is disabled, none of the complex solutions described in my\r\nprevious comment are needed. We only need to make sure the transaction\r\nis rolled back when auto-commit is enabled.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-06-03T19:33:50.000+0000","updated":"2006-06-03T19:33:50.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12343788/comment/12417598","id":"12417598","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Attached a patch (derby-1364-v1.diff) which attempts to fix this\r\nissue. Description of the patch:\r\n\r\n1. Checking of the number of result sets returned was moved from\r\n   executeUpdate/executeQuery to a point in flowExecute where the\r\n   transaction has not been auto-committed (otherwise, the transaction\r\n   would already be committed when the exception was raised).\r\n\r\n2. If the number of result sets does not match the execute type and\r\n   auto-commit is enabled, the transaction is rolled back (otherwise,\r\n   the transaction would be committed when the Statement was closed or\r\n   re-executed).\r\n\r\n3. All execute* methods in CallableStatement were removed since they\r\n   have become identical to the methods in PreparedStatement. (Or\r\n   almost identical. The methods in CallableStatement did not call\r\n   checkStatementValidity() on errors, but that's probably a bug.)\r\n\r\n4. SQL state for error message in executeQuery() was changed to match\r\n   embedded (XJ201/XJ205 -> X0Y78). Updated English and Portuguese\r\n   messages to use the new SQL state (no other translations existed\r\n   for XJ201 and XJ205).\r\n\r\n5. Added more rollback tests to jdbcapi/ProcedureTest.junit and\r\n   enabled all test cases for DerbyNetClient.\r\n\r\nI have run derbyall with no failures except runtimeinfo.java which\r\nfails all the time. The patch is ready for review. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-06-24T17:01:00.000+0000","updated":"2006-06-24T17:01:00.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12343788/comment/12418650","id":"12418650","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I plan to commit the patch early next week. Please let me know if you have any comments or need more time to review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-06-30T20:57:17.000+0000","updated":"2006-06-30T20:57:17.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12343788/comment/12418904","id":"12418904","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Committed revision 418692.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-07-03T13:13:39.000+0000","updated":"2006-07-03T13:13:39.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1364/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i07b9b:"}}
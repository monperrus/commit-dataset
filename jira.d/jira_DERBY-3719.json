{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12398022","self":"https://issues.apache.org/jira/rest/api/latest/issue/12398022","key":"DERBY-3719","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314116","id":"12314116","description":"10.5.2 Release July 30 2009 (794445) Now deprecated","name":"10.5.2.0","archived":false,"released":true,"releaseDate":"2009-07-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313727","id":"12313727","description":"Feature release","name":"10.6.1.0","archived":false,"released":true,"releaseDate":"2010-05-18"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-04-06 17:22:13.24","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23808","customfield_12310222":"1_*:*_1_*:*_31386795445_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2009-06-09T13:25:56.520+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3719/watchers","watchCount":0,"isWatching":false},"created":"2008-06-11T06:52:41.075+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313345","id":"12313345","description":"","name":"10.4.2.0","archived":false,"released":true,"releaseDate":"2008-09-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12324826","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12324826","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12425533","key":"DERBY-4231","self":"https://issues.apache.org/jira/rest/api/2/issue/12425533","fields":{"summary":"testReplication_Local_StateTest_part1: Unexpected SQL state. expected:<XRE[20]> but was:<XRE[07]>","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12320576","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12320576","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12397515","key":"DERBY-3709","self":"https://issues.apache.org/jira/rest/api/2/issue/12397515","fields":{"summary":"Exception printed by replication test: Could not perform operation because the database is not in replication master mode.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12324823","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12324823","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12394296","key":"DERBY-3632","self":"https://issues.apache.org/jira/rest/api/2/issue/12394296","fields":{"summary":"Replication tests must ensure stable replication state has been reached before attempting further connection or new replication commands.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/3","id":"3","description":"A task that needs to be done.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/task.png","name":"Task","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-07-16T21:24:27.231+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312050","id":"12312050","name":"Replication"}],"timeoriginalestimate":null,"description":"With the patch for DERBY-3709, derby-3709_p1-v2.diff.txt,  I was able to provoke this error twice in 30 test runs on this platform (On another platform I saw none in 100 test runs.)\r\n\r\nI will upload the full test run log dir.\r\n\r\n\"Summary\":\r\n\r\n1) testReplication_Local_StateTest_part2(org.apache.derbyTesting.functionTests.tests.replicationTests.ReplicationRun_Local_StateTest_part2)junit.framework.ComparisonFailure: Unexpected SQL state. expected:<XRE[20]> but was:<XRE[07]>\r\n\r\n\r\n\r\nMaster derby.log:\r\n-----------------------------------------\r\n----  BEGIN REPLICATION ERROR MESSAGE (6/10/08 4:08 PM) ----\r\nException occurred during log shipping.\r\norg.apache.derby.impl.store.replication.buffer.LogBufferFullException\r\n\tat org.apache.derby.impl.store.replication.buffer.ReplicationLogBuffer.switchDirtyBuffer(ReplicationLogBuffer.java:357)\r\n\tat org.apache.derby.impl.store.replication.buffer.ReplicationLogBuffer.appendLog(ReplicationLogBuffer.java:146)\r\n\tat org.apache.derby.impl.store.replication.master.MasterController.appendLog(MasterController.java:428)\r\n\tat org.apache.derby.impl.store.raw.log.LogAccessFile.writeToLog(LogAccessFile.java:787)\r\n\tat org.apache.derby.impl.store.raw.log.LogAccessFile.flushDirtyBuffers(LogAccessFile.java:534)\r\n\tat org.apache.derby.impl.store.raw.log.LogAccessFile.flushLogAccessFile(LogAccessFile.java:574)\r\n\tat org.apache.derby.impl.store.raw.log.LogAccessFile.writeLogRecord(LogAccessFile.java:332)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.appendLogRecord(LogToFile.java:3759)\r\n\tat org.apache.derby.impl.store.raw.log.FileLogger.logAndDo(FileLogger.java:370)\r\n\tat org.apache.derby.impl.store.raw.xact.Xact.logAndDo(Xact.java:1193)\r\n\tat org.apache.derby.impl.store.raw.data.LoggableActions.doAction(LoggableActions.java:221)\r\n\tat org.apache.derby.impl.store.raw.data.LoggableActions.actionUpdate(LoggableActions.java:85)\r\n\tat org.apache.derby.impl.store.raw.data.StoredPage.doUpdateAtSlot(StoredPage.java:8463)\r\n\tat org.apache.derby.impl.store.raw.data.StoredPage.updateOverflowDetails(StoredPage.java:8336)\r\n\tat org.apache.derby.impl.store.raw.data.StoredPage.updateOverflowDetails(StoredPage.java:8319)\r\n\tat org.apache.derby.impl.store.raw.data.BasePage.insertAllowOverflow(BasePage.java:808)\r\n\tat org.apache.derby.impl.store.raw.data.BasePage.insert(BasePage.java:653)\r\n\tat org.apache.derby.impl.store.access.heap.HeapController.doInsert(HeapController.java:307)\r\n\tat org.apache.derby.impl.store.access.heap.HeapController.insert(HeapController.java:575)\r\n\tat org.apache.derby.impl.sql.execute.RowChangerImpl.insertRow(RowChangerImpl.java:457)\r\n\tat org.apache.derby.impl.sql.execute.InsertResultSet.normalInsertCore(InsertResultSet.java:1011)\r\n\tat org.apache.derby.impl.sql.execute.InsertResultSet.open(InsertResultSet.java:487)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:384)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1235)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1652)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(EmbedPreparedStatement.java:1307)\r\n\tat org.apache.derby.impl.drda.DRDAStatement.execute(DRDAStatement.java:672)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(DRDAConnThread.java:4197)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(DRDAConnThread.java:4001)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThread.java:991)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:278)\r\n\r\n--------------------  END REPLICATION ERROR MESSAGE ---------------------\r\n\r\n\r\nSlave derby.log:\r\n-------------------------------------------------------------------------------------------\r\n2008-06-10 14:05:56.408 GMT Thread[DRDAConnThread_3,5,main] (DATABASE = /export/home/tmp/os136789/testingInMyDerbySandbox/12/db_slave/wombat), (DRDAID = {2}), Replication slave mode started successfully for database '/export/home/tmp/os136789/testingInMyDerbySandbox/12/db_slave/wombat'. Connection refused because the database is in replication slave mode. \r\nReplication slave role was stopped for database '/export/home/tmp/os136789/testingInMyDerbySandbox/12/db_slave/wombat'.\r\n\r\n------------  BEGIN SHUTDOWN ERROR STACK -------------\r\n\r\nERROR XSLA7: Cannot redo operation null in the log.\r\n\tat org.apache.derby.iapi.error.StandardException.newException(StandardException.java:296)\r\n\tat org.apache.derby.impl.store.raw.log.FileLogger.redo(FileLogger.java:1525)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.recover(LogToFile.java:920)\r\n\tat org.apache.derby.impl.store.raw.RawStore.boot(RawStore.java:334)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.boot(BaseMonitor.java:1999)\r\n\tat org.apache.derby.impl.services.monitor.TopService.bootModule(TopService.java:291)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.startModule(BaseMonitor.java:553)\r\n\tat org.apache.derby.iapi.services.monitor.Monitor.bootServiceModule(Monitor.java:427)\r\n\tat org.apache.derby.impl.store.access.RAMAccessManager.boot(RAMAccessManager.java:1019)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.boot(BaseMonitor.java:1999)\r\n\tat org.apache.derby.impl.services.monitor.TopService.bootModule(TopService.java:291)\r\n\tat org.apache.derby.impl.services.monitor.BaseMonitor.startModule(BaseMonitor.java:553)\r\n\tat org.apache.derby.iapi.services.monitor.Monitor.bootServiceModule(Monitor.java:427)\r\n\tat org.apache.derby.impl.db.BasicDatabase.bootStore(BasicDatabase.java:780)\r\n\tat org.apache.derby.impl.db.BasicDatabase.boot(BasicDatabase.java:196)\r\n\tat org.apache.derby.impl.db.SlaveDatabase.bootBasicDatabase(SlaveDatabase.java:424)\r\n\tat org.apache.derby.impl.db.SlaveDatabase.access$000(SlaveDatabase.java:70)\r\n\tat org.apache.derby.impl.db.SlaveDatabase$SlaveDatabaseBootThread.run(SlaveDatabase.java:311)\r\n\tat java.lang.Thread.run(Thread.java:619)\r\nCaused by: ERROR 08006: Database '{0}' shutdown.\r\n\tat org.apache.derby.iapi.error.StandardException.newException(StandardException.java:276)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.stopReplicationSlaveRole(LogToFile.java:5142)\r\n\tat org.apache.derby.impl.store.replication.slave.SlaveController.stopSlave(SlaveController.java:266)\r\n\tat org.apache.derby.impl.store.replication.slave.SlaveController.access$500(SlaveController.java:64)\r\n\tat org.apache.derby.impl.store.replication.slave.SlaveController$SlaveLogReceiverThread.run(SlaveController.java:531)\r\n============= begin nested exception, level (1) ===========\r\nERROR 08006: Database '{0}' shutdown.\r\n\tat org.apache.derby.iapi.error.StandardException.newException(StandardException.java:276)\r\n\tat org.apache.derby.impl.store.raw.log.LogToFile.stopReplicationSlaveRole(LogToFile.java:5142)\r\n\tat org.apache.derby.impl.store.replication.slave.SlaveController.stopSlave(SlaveController.java:266)\r\n\tat org.apache.derby.impl.store.replication.slave.SlaveController.access$500(SlaveController.java:64)\r\n\tat org.apache.derby.impl.store.replication.slave.SlaveController$SlaveLogReceiverThread.run(SlaveController.java:531)\r\n============= end nested exception, level (1) ===========\r\n\r\n\r\n------------  END SHUTDOWN ERROR STACK -------------\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"38369","summary":"'...replication.buffer.LogBufferFullException' causes failover to fail w/ 'XRE07, SQLERRMC: Could not perform operation because the database is not in replication master mode.'","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=olesolberg","name":"olesolberg","emailAddress":"Ole dot Solberg at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ole Solberg","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=olesolberg","name":"olesolberg","emailAddress":"Ole dot Solberg at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ole Solberg","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"HW: 2 X i86pc i386 (AMD Opteron(tm) Processor 252): 2593 MHz, unknown cache. 3968 Megabytes Total Memory.\r\nOS: Solaris 10 5/08 s10x_u5wos_10 X86 64bits - SunOS 5.10 Generic_127128-11\r\nJVM: Sun Microsystems Inc.\r\n    java version \"1.6.0_06\"\r\n    Java(TM) SE Runtime Environment (build 1.6.0_06-b02)\r\n    Java HotSpot(TM) Client VM (build 10.0-b22, mixed mode)\r\n","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":7,"total":7,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12398022/comment/12604140","id":"12604140","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=olesolberg","name":"olesolberg","emailAddress":"Ole dot Solberg at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ole Solberg","active":true},"body":"Full test run log.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=olesolberg","name":"olesolberg","emailAddress":"Ole dot Solberg at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ole Solberg","active":true},"created":"2008-06-11T06:55:12.751+0000","updated":"2008-06-11T06:55:12.751+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12398022/comment/12696185","id":"12696185","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I saw a similar issue in 10.4.2.0 -> 10.5.1.0 hard upgrade testing, which I am assuming is another manifestation of this bug.\r\n1) testReplication_Local_StateTest_part1(org.apache.derbyTesting.functionTests.tests.replicationTests.ReplicationRun_Local_StateTest_part1)junit.framework.ComparisonFailure: Unexpected SQL state. expected:<...20> but was:<...07>\r\n\tat org.apache.derbyTesting.junit.BaseJDBCTestCase.assertSQLState(BaseJDBCTestCase.java:760)\r\n\tat org.apache.derbyTesting.junit.BaseJDBCTestCase.assertSQLState(BaseJDBCTestCase.java:809)\r\n\tat org.apache.derbyTesting.functionTests.tests.replicationTests.ReplicationRun.failOver_direct(ReplicationRun.java:1381)\r\n\tat org.apache.derbyTesting.functionTests.tests.replicationTests.ReplicationRun.failOver(ReplicationRun.java:1302)\r\n\tat org.apache.derbyTesting.functionTests.tests.replicationTests.ReplicationRun_Local_StateTest_part1.testReplication_Local_StateTest_part1(ReplicationRun_Local_StateTest_part1.java:160)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:45)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:37)\r\n\tat org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:105)\r\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:19)\r\n\tat junit.extensions.TestSetup.run(TestSetup.java:23)\r\nCaused by: java.sql.SQLException: DERBY SQL error: SQLCODE: -1, SQLSTATE: XRE07, SQLERRMC: Could not perform operation because the database is not in replication master mode.\r\n\tat org.apache.derby.client.am.SQLExceptionFactory40.getSQLException(Unknown Source)\r\n\tat org.apache.derby.client.am.SqlException.getSQLException(Unknown Source)\r\n\tat org.apache.derby.jdbc.ClientDriver.connect(Unknown Source)\r\n\tat java.sql.DriverManager.getConnection(DriverManager.java:316)\r\n\tat java.sql.DriverManager.getConnection(DriverManager.java:273)\r\n\tat org.apache.derbyTesting.functionTests.tests.replicationTests.ReplicationRun.failOver_direct(ReplicationRun.java:1368)\r\n\t... 28 more\r\nCaused by: org.apache.derby.client.am.SqlException: DERBY SQL error: SQLCODE: -1, SQLSTATE: XRE07, SQLERRMC: Could not perform operation because the database is not in replication master mode.\r\n\tat org.apache.derby.client.am.Connection.completeSqlca(Unknown Source)\r\n\tat org.apache.derby.client.net.NetConnectionReply.parseRdbAccessFailed(Unknown Source)\r\n\tat org.apache.derby.client.net.NetConnectionReply.parseAccessRdbError(Unknown Source)\r\n\tat org.apache.derby.client.net.NetConnectionReply.parseACCRDBreply(Unknown Source)\r\n\tat org.apache.derby.client.net.NetConnectionReply.readAccessDatabase(Unknown Source)\r\n\tat org.apache.derby.client.net.NetConnection.readSecurityCheckAndAccessRdb(Unknown Source)\r\n\tat org.apache.derby.client.net.NetConnection.flowSecurityCheckAndAccessRdb(Unknown Source)\r\n\tat org.apache.derby.client.net.NetConnection.flowUSRIDONLconnect(Unknown Source)\r\n\tat org.apache.derby.client.net.NetConnection.flowConnect(Unknown Source)\r\n\tat org.apache.derby.client.net.NetConnection.<init>(Unknown Source)\r\n\tat org.apache.derby.client.net.NetConnection40.<init>(Unknown Source)\r\n\tat org.apache.derby.client.net.ClientJDBCObjectFactoryImpl40.newNetConnection(Unknown Source)\r\n\t... 32 more\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2009-04-06T17:22:13.240+0000","updated":"2009-04-06T17:22:13.240+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12398022/comment/12710013","id":"12710013","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"This log from master's log file shows what happens. The output is\r\nproduced by the patch attached (traceLogShipping):\r\n\r\n@1242410514203 Sending done\r\n@1242410514205 >= FI_HIGH\r\n@1242410514206 >= FI_HIGH\r\n@1242410514204 Sending\r\n@1242410514208 >= FI_HIGH\r\n@1242410514211 >= FI_HIGH\r\n@1242410514216 log buffer full, try to force flush\r\n@1242410514216 forceflush\r\n@1242410514265 Sending done\r\n@1242410514266 log buffer full, force failed\r\n----  BEGIN REPLICATION ERROR MESSAGE (15.05.09 20:01) ----\r\n@1242410514267 Sending\r\n@1242410514286 Sending done\r\n@1242410514286 Sending\r\nException occurred during log shipping.\r\norg.apache.derby.impl.store.replication.buffer.LogBufferFullException\r\n\tat org.apache.derby.impl.store.replication.buffer.ReplicationLogBuffer.switchDirtyBuffer(ReplicationLogBuffer.java:357)\r\n\r\nThe asynchronous log shipper basically does this loops:\r\n\r\n       while (true) {\r\n            ship a log chunk\r\n            \r\n            if ! <things are busy>\r\n                wait(shippingInterval)\r\n            fi\r\n      }\r\n\r\nFrom derby.log, we see that the sending of a chunk starts a instant\r\n4204, and sending is complete at 4265.\r\n\r\nIn the meantime, the user thread is busy writing log using\r\nReplicationLogBuffer.appendLog. Now, the buffer is getting full as\r\nseen in the \"instant 4208: >= FI_HIGH\" (ReplicationLogBuffer calls\r\nswitchDirtyBuffer which will return a free buffer if there is one,\r\nthen it calls MasterController.workToDo to make sure the shipping\r\nthread knows). \r\n\r\nNotice the send is still waiting to complete.  Now, another log write\r\nhappens, and again, we see this indication that we are close to having\r\n0 free buffers (instant 4211: >= FI_HIGH). This is the second time workToDo is\r\ncalled. In both cases, AsynchronousLogShipper.workToDo does a notify\r\nto try to wake up the thread on the assumption is may be sleeping in\r\nthe \"wait(shippingInterval)\" seen above. But in reality, the shipping\r\nthread is still waiting for the currently active thread to finish its\r\nsending, so this has no effect.\r\n\r\nNow, have a look at MasterController.appendLog (which calls\r\nReplicationLogBuffer.appendLog). Notice that is it gets a\r\nLogBufferFullException it will try to force the log shipper to flush,\r\nand then retry the append on the assumption that at least one free\r\nbuffer has been returned to the pool.  Now, have a look at the code of\r\nASL.forceFlush (called at instant 4216). What this code does is to try\r\nto wake up the sleeping shipper thread with the call to\r\nnotify(). Sadly, the shipping thread is still not finished with its\r\nwrite (it takes 4265-4204= 61 ms), so the forceflush just returns and\r\nallows MasterController.appendLog to fail for the second time. And\r\nthis time the LogBufferFullException is the kiss of death (4266 log\r\nbuffer full, force failed).\r\n\r\nNotice how the shipping thread still thinks all is hunky dory, it\r\nstarts a new ship at instant 4267, but, alas it is now too late, since\r\nthe master thread has given up, and started to tear down.\r\n\r\nSo, in conclusion, the logic to force log shipping before we attempt a\r\nretry of the log append is flawed.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2009-05-15T23:12:10.150+0000","updated":"2009-05-15T23:12:10.150+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12398022/comment/12710130","id":"12710130","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Uploading patch derby-3719-1. This moves the actual log send to inside\r\nthe forceFlushSemaphore monitor. The effect of this in the failure\r\nscenario, (that is, if the user thread called forceFlush after a send\r\nhas been initiated), is to hold back the user thread doing forceFlush\r\ntill the log shipper thread has finished its send. That way, when the\r\nforceFlush will not return until at least (*) ONE sending operation\r\nhas been initiated and completed, ensuring that at least one buffer\r\nhas been returned to the free pool. This in turn leads the 2nd attempt\r\n(after receiving a LogBufferFullException) to be able to append the\r\nlog in MasterController.appendLog.\r\n\r\n(*) the log shipper thread could possibly race past the user thread\r\nand send more than once, but that would not be harmful because the\r\nsending thread would ultimately call notify again, allowing the user\r\nthread to continue and find free buffers.\r\n\r\nThis trace fragment from db_master/derby.log (with patch of trace patch applied) of the master\r\nin a tight spot (when running ReplicationRun_Local_StateTest_part1), shows \r\nhow the sequence of events change with the patch:\r\n\r\n@1242436667589 Sending\r\n@1242436667590 Sending done\r\n@1242436667590 ship sleep 100\r\n@1242436667667 >= FI_HIGH\r\n@1242436667668 Sending\r\n@1242436667668 >= FI_HIGH\r\n@1242436667670 >= FI_HIGH\r\n@1242436667673 >= FI_HIGH\r\n@1242436667676 >= FI_HIGH\r\n@1242436667679 log buffer full, try to force flush\r\n@1242436667679 forceflush\r\n@1242436667695 Sending done\r\n@1242436667696 Sending\r\n@1242436667696 Sending done\r\n@1242436667696 Sending\r\n\r\nSending takes somewhat long here, (7695 ms - 7668 ms = 27ms) and the\r\nuser thread finds few free buffers left, and then finally none and\r\ngoes on to force a flush. But with the patch, the call to forceflush\r\nat instant 7679 must wait till the shiper thread's send is done; at\r\ninstant 7695. Since the shipper thread has held the monitor since\r\nbefore the instant it released a free buffer (implying a the user\r\nthread can not have been able to grab it yet!), by the time the user\r\nthread gets the monitor on forceFlushSemaphore, the sender is done,\r\nand a free buffer is guaranteed to have been returned to the pool.\r\n\r\nI have run ReplicationRun_Local_StateTest_part1 now for 24 hours\r\nwithout seeing a problem with it (ca 350 runs). Running full\r\nregressions now.\r\n\r\nReady for review.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2009-05-16T18:36:44.640+0000","updated":"2009-05-16T18:36:44.640+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12398022/comment/12717667","id":"12717667","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Committed patch derby-3719-1 as svn 782991. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2009-06-09T13:10:06.108+0000","updated":"2009-06-09T13:10:06.108+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12398022/comment/12717671","id":"12717671","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Backported this fix to 10.5 branch; committed as svn 782997.\r\nResolving.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2009-06-09T13:25:22.517+0000","updated":"2009-06-09T13:25:22.517+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12398022/comment/12727200","id":"12727200","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=olesolberg","name":"olesolberg","emailAddress":"Ole dot Solberg at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ole Solberg","active":true},"body":"Not seen since commit, so closing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=olesolberg","name":"olesolberg","emailAddress":"Ole dot Solberg at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ole Solberg","active":true},"created":"2009-07-04T07:42:59.270+0000","updated":"2009-07-04T07:42:59.270+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-3719/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06xjr:"}}
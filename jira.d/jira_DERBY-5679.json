{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12548730","self":"https://issues.apache.org/jira/rest/api/latest/issue/12548730","key":"DERBY-5679","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323475","id":"12323475","description":"Head of 10.8 branch starting 2014-01-13","name":"10.8.3.3","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2012-03-29 22:02:12.489","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"233827","customfield_12310222":"1_*:*_1_*:*_3109008556_*|*_6_*:*_2_*:*_1146091023_*|*_5_*:*_2_*:*_35067003383_*|*_4_*:*_2_*:*_203129","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2013-06-27T23:13:18.312+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5679/watchers","watchCount":2,"isWatching":false},"created":"2012-03-29T20:21:32.240+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315343","id":"12315343","description":"Derby 10.6.2.1 Release","name":"10.6.2.1","archived":false,"released":true,"releaseDate":"2010-10-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12317968","id":"12317968","description":"second release on the 10.8 branch","name":"10.8.2.2","archived":false,"released":true,"releaseDate":"2011-10-24"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-06-27T23:13:18.329+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11412","id":"11412","name":"Store"}],"timeoriginalestimate":null,"description":"Rolling back a transaction can leave a table in an inconsistent state if the table has been previously altered through the addition of new columns. It appears that if newly added columns have not been changed from their default value, then when a transaction which sets new values for these columns is rolled back the new columns are not restored to their previous values.\r\n\r\nAttached is an ij script with fairly minimal steps to reproduce the problem on Derby 10.6.2.0 and 10.8.2.2 (Win7 x64, Sun 32-bit JRE 1.6.0.26). Expected and observed output also attached.\r\n\r\nWould appreciate any suggestions as to a workaround for this issue. Running SYSCS_UTIL.SYSCS_COMPRESS_TABLE on the table after adding the columns seems to avoid the problem but may be just masking the issue.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10364","value":"Data corruption","id":"10364"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10367","value":"Deviation from standard","id":"10367"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10421","value":"Seen in production","id":"10421"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10366","value":"Wrong query result","id":"10366"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"35757","summary":"Rolling back a transaction leads to an inconsistent state","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=b.mason%40adinstruments.com","name":"b.mason@adinstruments.com","emailAddress":"b dot mason at adinstruments dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Mason","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10422","value":"High Value Fix","id":"10422"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10424","value":"Repro attached","id":"10424"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10427","value":"Workaround attached","id":"10427"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=b.mason%40adinstruments.com","name":"b.mason@adinstruments.com","emailAddress":"b dot mason at adinstruments dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Mason","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":">sysinfo\r\n------------------ Java Information ------------------\r\nJava Version:    1.6.0_26\r\nJava Vendor:     Sun Microsystems Inc.\r\nJava home:       C:\\Program Files (x86)\\Java\\jre6\r\nJava classpath:  .;C:\\Program Files (x86)\\Java\\jre7\\lib\\ext\\QTJava.zip;C:\\Users\\BMASON\\Sandbox\\libs\\db-derby-10.8.2.2-bin\\bin\\../lib/derby.jar;C:\\Users\\BMASON\\Sandbox\\libs\\db-derby-10.8.2.2-bin\\bin\\../lib/derbynet.jar;C:\\Users\\BMASON\\Sandbox\\libs\\db-derby-10.8.2.2-bin\\bin\\../lib/derbyclient.jar;C:\\Users\\BMASON\\Sandbox\\libs\\db-derby-10.8.2.2-bin\\bin\\../lib/derbytools.jar\r\nOS name:         Windows 7\r\nOS architecture: x86\r\nOS version:      6.1\r\nJava user name:  bmason\r\nJava user home:  C:\\Users\\BMASON\r\nJava user dir:   C:\\Users\\BMASON\\Sandbox\\libs\\db-derby-10.8.2.2-bin\\bin\r\njava.specification.name: Java Platform API Specification\r\njava.specification.version: 1.6\r\njava.runtime.version: 1.6.0_26-b03\r\n--------- Derby Information --------\r\nJRE - JDBC: Java SE 6 - JDBC 4.0\r\n[C:\\Users\\BMASON\\Sandbox\\libs\\db-derby-10.8.2.2-bin\\lib\\derby.jar] 10.8.2.2 - (1181258)\r\n[C:\\Users\\BMASON\\Sandbox\\libs\\db-derby-10.8.2.2-bin\\lib\\derbytools.jar] 10.8.2.2 - (1181258)\r\n[C:\\Users\\BMASON\\Sandbox\\libs\\db-derby-10.8.2.2-bin\\lib\\derbynet.jar] 10.8.2.2 - (1181258)\r\n[C:\\Users\\BMASON\\Sandbox\\libs\\db-derby-10.8.2.2-bin\\lib\\derbyclient.jar] 10.8.2.2 - (1181258)\r\n------------------------------------------------------\r\n----------------- Locale Information -----------------\r\nCurrent Locale :  [English/New Zealand [en_NZ]]\r\nFound support for locale: [cs]\r\n         version: 10.8.2.2 - (1181258)\r\nFound support for locale: [de_DE]\r\n         version: 10.8.2.2 - (1181258)\r\nFound support for locale: [es]\r\n         version: 10.8.2.2 - (1181258)\r\nFound support for locale: [fr]\r\n         version: 10.8.2.2 - (1181258)\r\nFound support for locale: [hu]\r\n         version: 10.8.2.2 - (1181258)\r\nFound support for locale: [it]\r\n         version: 10.8.2.2 - (1181258)\r\nFound support for locale: [ja_JP]\r\n         version: 10.8.2.2 - (1181258)\r\nFound support for locale: [ko_KR]\r\n         version: 10.8.2.2 - (1181258)\r\nFound support for locale: [pl]\r\n         version: 10.8.2.2 - (1181258)\r\nFound support for locale: [pt_BR]\r\n         version: 10.8.2.2 - (1181258)\r\nFound support for locale: [ru]\r\n         version: 10.8.2.2 - (1181258)\r\nFound support for locale: [zh_CN]\r\n         version: 10.8.2.2 - (1181258)\r\nFound support for locale: [zh_TW]\r\n         version: 10.8.2.2 - (1181258)\r\n------------------------------------------------------\r\n","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":15,"total":15,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13241597","id":"13241597","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=b.mason%40adinstruments.com","name":"b.mason@adinstruments.com","emailAddress":"b dot mason at adinstruments dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Mason","active":true},"body":"ij script to reproduce the issue and expected output.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=b.mason%40adinstruments.com","name":"b.mason@adinstruments.com","emailAddress":"b dot mason at adinstruments dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Mason","active":true},"created":"2012-03-29T20:23:12.694+0000","updated":"2012-03-29T20:23:12.694+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13241844","id":"13241844","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"until  the bug is fixed won't know for sure, but I would expect running SYSCS_UTIL.SYSCS_COMPRESS_TABLE after the alters and committing to be safest workaround, and would not expect that it is leaving a masked issue.\r\n\r\nwhen you alter a table and add a column nullable column without a default value I think we don't actually change the rows in the table, but instead count on logic where if you\r\nsee a row with less columns than expected at the physical layer, we translate those missing columns into nulls.  And I expect the bug\r\nto have something to do with this logic either when you update the last column with missing columns in the middle, or some problem \r\nduring undo with same logic.\r\n\r\nWhen you do the compress, as knut said, the system underneath creates a whole new table and inserts new rows into it.  I would expect that\r\nthese new rows are all \"full\" and thus don't go through the tricky code.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-03-29T22:02:12.489+0000","updated":"2012-03-29T22:02:12.489+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13259792","id":"13259792","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-5679-01-aa-alterTableTouchAllRows.diff. This patch fixes the bug for new ALTER TABLEs.\r\n\r\nThere is short-circuiting logic in the language layer as well as the store. If the ALTER TABLE ADD COLUMN statement specifies a non-null default, then at execution time we cook up an update statement to stuff that default into the new column in all rows. We don't do this if the default is null. This patch removes that short-circuiting and makes us touch all of the rows if the default is null.\r\n\r\nThis won't fix the bug if the ALTER TABLE statement happened before upgrading to the release which contains this fix. To fix the bug in that case, we need to fix the storage layer. If we fix the bug in the storage layer, then we probably don't need this change to the language layer.\r\n\r\nI'm happy to take a look at the storage layer. I will start poking around. Would appreciate any pointers about where I should be looking, though.\r\n\r\nI'm posting this patch in case the store fix turns out to be too tricky.\r\n\r\nTouches the following files:\r\n\r\n------------\r\n\r\nM       java/engine/org/apache/derby/impl/sql/execute/AlterTableConstantAction.java\r\n\r\nThe fix.\r\n\r\n------------\r\n\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/lang/AlterTableTest.java\r\n\r\nRegression test case.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-23T18:11:36.243+0000","updated":"2012-04-23T18:11:36.243+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13259873","id":"13259873","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"This line in StoredPage.storeRecordForUpdate() looks suspicious:\r\n\r\n            if (StoredFieldHeader.isNonexistent(newFieldStatus) && (fieldId < oldEndFieldExclusive)) {\r\n\r\nI think there may need to be a corresponding block of code which writes a null marker when:\r\n\r\n            if (StoredFieldHeader.isNonexistent(newFieldStatus) && (fieldId >= oldEndFieldExclusive))\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-23T19:38:20.227+0000","updated":"2012-04-23T19:38:20.227+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13260083","id":"13260083","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"The design intent of the code was to not require all rows to be updated when a null default column was added.   Doing so will create a huge performance degredation for the operation for tables with lots of rows.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-04-23T23:42:23.212+0000","updated":"2012-04-23T23:42:23.212+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13260090","id":"13260090","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"the storeRecordForUpdate code is about the most complicated code in store (at least for me as I didn't write it), so would not surprise me there is a bug with this case of mismatched number of columns in page and recover log record processing).  This is the only time where rows will be be missing columns at the end in actual usage - though store is supposed to support it.  \r\n\r\nMy assumption is that the problem is either the log record written out is bad, or the recovery process on the log record is bad.  Can you tell\r\nfrom debugging which so far?  I assume if stuff does not get backed out that the data looks good, but it would be good to verify.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-04-23T23:50:40.006+0000","updated":"2012-04-23T23:50:40.006+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13260472","id":"13260472","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":">My assumption is that the problem is either the log record written out is bad, or the recovery process on the log record is bad. Can you tell\r\nfrom debugging which so far?\r\n\r\nI think that the suspect code is being called in the former case. But I could be pursuing a red herring--as you say, this code is intricate. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-24T12:36:17.583+0000","updated":"2012-04-24T12:36:17.583+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13260739","id":"13260739","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-5679-01-ab-storedPageChange.diff. This second approach changes update code in StoredPage. I am not an expert in this area and am not confident that this is the correct fix. The patch, however, does satisfy three useful conditions:\r\n\r\n1) It makes the repro run correctly.\r\n\r\n2) It doesn't break any of our existing regression tests.\r\n\r\n3) It is small.\r\n\r\nLet me explain what I did.\r\n\r\nI started out being suspicious of the first update in the repro, the one whose comment suggested that it was making a crucial change which set up the bug:\r\n\r\n--This update is important.\r\nUPDATE TABLE1 SET STR2 = 'before2';\r\n\r\nI noticed that the value for one of the other columns became correct after the rollback if the \"important\" update was followed by another update which explicitly set the other new column to null:\r\n\r\n-- this fixes the problem\r\nupdate TABLE1 set str1 = null;\r\n\r\nThis suggested that the bug could at least be patched over by forcing the other new columns to be null during the \"important\" update.\r\n\r\nTracing through the code, I noticed that during the \"important\" update, the untouched columns took an unusual trajectory through the StoredPage.logRow() pinball machine. There they fell into this code block at line 3970. The block appears to have puzzled other people:\r\n\r\n                        // this is an update that is increasing the number of \r\n                        // columns but not providing any value, strange ...\r\n\r\n                        spaceAvailable = \r\n                            logColumn(\r\n                                null, 0, out, spaceAvailable, \r\n                                columnFlag, overflowThreshold);\r\n\r\nI fixed this case by inventing a new column flag to tell StoredPage.logColumn() that it should write a null column, rather than a nonexistent one.\r\n\r\nWould appreciate your thoughts about this approach.\r\n\r\n\r\nTouches the following files:\r\n\r\n------------\r\n\r\nM       java/engine/org/apache/derby/impl/store/raw/data/StoredPage.java\r\n\r\nThe fix.\r\n\r\n------------\r\n\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/lang/AlterTableTest.java\r\n\r\nRegression test case.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-24T17:41:49.587+0000","updated":"2012-04-24T17:41:49.587+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13261946","id":"13261946","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"\r\nI think the approach of getting update to log nulls in this case is a good one.  Store is going to be broken if non-existent columns are \r\nanywhere other than at the end of the row.  Changing non-existent columns to null valued columns at update time seems like a good\r\napproach.\r\n\r\nIs the code you are changing happening because the user update is updating column N with a value,  column N-1 and N were\r\nadded because of add column and neither has ever had a real value.  And this trip through log column is dealing with column N-1.\r\n\r\nI think it might be cleaner if you just add another if/then/else just for COLUMN_NULL at line 6306, rather than code the case of a real\r\ncolumn and a nonexistent column in same case.  I think sColumn is null for your case in this and found it confusing, seems like\r\nthe code works by accident not referencing the null pointer, so someone later could easily use it thinking it was valid.\r\n\r\nThe code for COLUMN_NULL is much simpler as it just knows it is creating a NULL value out of the ether.  \r\n\r\nnits:\r\no could you make the code be 80 column \r\no I think a different name might be better, maybe COLUMN_CREATENULL.  I kept seeing the COLUMN_NULL name and thinking it\r\n   was an existing null column, which is a different code path.\r\no could you add comments to logColumn to say what the new option is doing.\r\no a good case to add but does not need to hold up your checkin would be both regular row and long row case.  Something like\r\n    add 100 columns, update 50th column, check you can retrieve all 100, abort check you can retrieve all as expected.  Another row\r\n    do 50th update and then 99th update....   The long row case comes when you make all this work happen on second page vs\r\n    first, so for 2k pages something like following:\r\n    create table with real columns to fill most of a page.  with just ddl you can add columns of char(250) that will guarantee 250 bytes\r\n    for any insert, or you can use clob/blob and make sure you add almost pagesize bytes.  Then use alter to add columns.   interesting\r\n    cases would be some nonexistent columns on first page and then an update of one that will end up on second page or more.  \r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-04-25T18:55:04.345+0000","updated":"2012-04-25T18:55:04.345+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13262562","id":"13262562","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks for the comments, Mike.\r\n\r\n> Is the code you are changing happening because the user update is updating column N with a value, column N-1 and N were added because of add column and neither has ever had a real value. And this trip through log column is dealing with column N-1.\r\n\r\nRight, that's the case.\r\n\r\nI'll update the current patch as you suggested. I'll add the additional test case in a follow-on patch. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-26T12:34:24.044+0000","updated":"2012-04-26T12:34:24.044+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13262644","id":"13262644","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-5679-01-ac-storedPageChange.diff. This version makes the changes which Mike suggested. Tests ran cleanly for me. Committed at subversion revision 1330877.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-26T14:40:21.801+0000","updated":"2012-04-26T14:40:21.801+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13263760","id":"13263760","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-5679-02-aa-moreTests.diff. This adds the extra test cases suggested by Mike. Committed at subversion revision 1331484.\r\n\r\nTouches the following file:\r\n\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/lang/AlterTableTest.java\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-27T16:04:58.751+0000","updated":"2012-04-27T16:04:58.751+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13266655","id":"13266655","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Ported 1330877 and 1331484 from trunk to 10.8 branch at subversion revision 1333087.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-05-02T15:56:12.736+0000","updated":"2012-05-02T15:56:12.736+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13268663","id":"13268663","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Patch has been backported to 10.8. Resolving.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-05-04T19:58:20.778+0000","updated":"2012-05-04T19:58:20.778+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12548730/comment/13695152","id":"13695152","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"marking fixed in 10.8.  it was already backported:\r\nr1333087 | rhillegas | 2012-05-02 08:55:32 -0700 (Wed, 02 May 2012) | 1 line\r\n\r\nDERBY-5679: Ported 1330877 and 1331484 from trunk to 10.8 branch.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2013-06-27T23:13:12.973+0000","updated":"2013-06-27T23:13:12.973+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5679/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06hfb:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12478510","self":"https://issues.apache.org/jira/rest/api/latest/issue/12478510","key":"CASSANDRA-1670","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310865","id":"12310865","key":"CASSANDRA","name":"Cassandra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310865&avatarId=12034","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310865&avatarId=12034","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310865&avatarId=12034","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310865&avatarId=12034"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11961","id":"11961","description":"Apache Cassandra related projects","name":"Cassandra"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315486","id":"12315486","description":"","name":"0.7.0 rc 1","archived":false,"released":true,"releaseDate":"2010-11-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2010-10-29 21:38:33.699","customfield_12312322":null,"customfield_12312323":null,"customfield_12310222":"10002_*:*_1_*:*_162808485_*|*_1_*:*_1_*:*_408682455_*|*_5_*:*_1_*:*_0","customfield_12310420":"20250","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2010-11-03T13:12:55.095+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-1670/watchers","watchCount":2,"isWatching":false},"created":"2010-10-27T22:28:04.155+0000","customfield_10022":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12311124":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-11-03T13:12:55.058+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312978","id":"12312978","name":"Core"}],"timeoriginalestimate":null,"description":"two node cluster (node0, node1).  node0 is listed as the only seed on both nodes.  Listen addresses explicitly set to an IP on both nodes. No initial token, no autobootstrap (but see below).  Bring up the ring.  Everything is fine on both nodes.\r\n\r\ndecom node1.  verify decom completed correctly by reading the logs on both nodes.  rm all data/logs on node1.  bring node1 up again.\r\n\r\nOne of two things happen:\r\n\r\n* node0 thinks it is in a ring by itself, node1 thinks both nodes are in the ring.\r\n* both node0 and node1 think they are in rings by themselves\r\n\r\nIf you restart node0 after decom, it appears to work normally.\r\n\r\nSimilar issues seem to present if you kill node1 (either when autobootstrapping before it completes or after it is in the ring) and removetoken.\r\n\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12458550","id":"12458550","filename":"1670-0.6.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"created":"2010-11-01T15:59:11.254+0000","size":1646,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12458550/1670-0.6.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12458552","id":"12458552","filename":"ASF.LICENSE.NOT.GRANTED--v1-0001-code-that-tidied-Gossiper.justRemovedEndpoints_-was-no.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"created":"2010-11-01T16:28:58.134+0000","size":2102,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12458552/ASF.LICENSE.NOT.GRANTED--v1-0001-code-that-tidied-Gossiper.justRemovedEndpoints_-was-no.txt"}],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"92510","summary":"cannot move a node","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mdennis","name":"mdennis","emailAddress":"mdennis at riptano dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthew F. Dennis","active":true},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mdennis","name":"mdennis","emailAddress":"mdennis at riptano dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthew F. Dennis","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"customfield_12311420":null,"customfield_12311421":null,"environment":"RAX","customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":13,"total":13,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478510/comment/12926469","id":"12926469","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbulman","name":"mbulman","emailAddress":"mike at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mbulman&avatarId=17737","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mbulman&avatarId=17737","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mbulman&avatarId=17737","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mbulman&avatarId=17737"},"displayName":"Mike Bulman","active":true},"body":"Because move is decommission+bootstrap, the same behavior occurs when moving node1 as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbulman","name":"mbulman","emailAddress":"mike at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mbulman&avatarId=17737","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mbulman&avatarId=17737","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mbulman&avatarId=17737","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mbulman&avatarId=17737"},"displayName":"Mike Bulman","active":true},"created":"2010-10-29T21:38:33.699+0000","updated":"2010-10-29T21:38:33.699+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478510/comment/12927017","id":"12927017","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"body":"Looks like this bug goes all the way back to 0.6.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"created":"2010-11-01T15:54:54.686+0000","updated":"2010-11-01T15:54:54.686+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478510/comment/12927021","id":"12927021","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"body":"The code that removes endpoints from Gossiper.justRemovedEndpoints after RING_DELAY was only getting called if the endpoint had a state attached to it.  Since state is removed for decommissioned nodes, the code was never getting called. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"created":"2010-11-01T15:59:11.362+0000","updated":"2010-11-01T15:59:11.362+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478510/comment/12927025","id":"12927025","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"how does moving the removal out of the for loop fix the state-attached-to-it problem?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2010-11-01T16:06:34.542+0000","updated":"2010-11-01T16:06:34.542+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478510/comment/12927034","id":"12927034","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"body":"When a node is decommissioned, it gets added to justRemovedEndpoints_, but removed from endpointStateMap_.  The old code will only remove a node from justRemovedEndpoints_ if it currently exists in endpointStateMap_.  If the node stays in justRemovedEndpoints_ (which it will currently), it can never be recognized as part of the ring because of the check in Gossiper.handleNewJoin().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"created":"2010-11-01T16:38:56.638+0000","updated":"2010-11-01T16:38:56.638+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478510/comment/12927198","id":"12927198","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbulman","name":"mbulman","emailAddress":"mike at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mbulman&avatarId=17737","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mbulman&avatarId=17737","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mbulman&avatarId=17737","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mbulman&avatarId=17737"},"displayName":"Mike Bulman","active":true},"body":"Running from nodetool as well as ripcord decommission code (direct call to StorageService) gets:\r\n\r\nException in thread \"main\" java.lang.AssertionError\r\n        at org.apache.cassandra.service.StorageService.getLocalToken(StorageService.java:1128)\r\n        at org.apache.cassandra.service.StorageService.startLeaving(StorageService.java:1527)\r\n        at org.apache.cassandra.service.StorageService.decommission(StorageService.java:1546)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\r\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n        at java.lang.reflect.Method.invoke(Method.java:616)\r\n        at com.sun.jmx.mbeanserver.StandardMBeanIntrospector.invokeM2(StandardMBeanIntrospector.java:111)\r\n        at com.sun.jmx.mbeanserver.StandardMBeanIntrospector.invokeM2(StandardMBeanIntrospector.java:45)\r\n        at com.sun.jmx.mbeanserver.MBeanIntrospector.invokeM(MBeanIntrospector.java:226)\r\n        at com.sun.jmx.mbeanserver.PerInterface.invoke(PerInterface.java:138)\r\n        at com.sun.jmx.mbeanserver.MBeanSupport.invoke(MBeanSupport.java:251)\r\n        at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.invoke(DefaultMBeanServerInterceptor.java:857)\r\n        at com.sun.jmx.mbeanserver.JmxMBeanServer.invoke(JmxMBeanServer.java:795)\r\n        at javax.management.remote.rmi.RMIConnectionImpl.doOperation(RMIConnectionImpl.java:1450)\r\n        at javax.management.remote.rmi.RMIConnectionImpl.access$200(RMIConnectionImpl.java:90)\r\n        at javax.management.remote.rmi.RMIConnectionImpl$PrivilegedOperation.run(RMIConnectionImpl.java:1285)\r\n        at javax.management.remote.rmi.RMIConnectionImpl.doPrivilegedOperation(RMIConnectionImpl.java:1383)\r\n        at javax.management.remote.rmi.RMIConnectionImpl.invoke(RMIConnectionImpl.java:807)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\r\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n        at java.lang.reflect.Method.invoke(Method.java:616)\r\n        at sun.rmi.server.UnicastServerRef.dispatch(UnicastServerRef.java:322)\r\n        at sun.rmi.transport.Transport$1.run(Transport.java:177)\r\n        at java.security.AccessController.doPrivileged(Native Method)\r\n        at sun.rmi.transport.Transport.serviceCall(Transport.java:173)\r\n        at sun.rmi.transport.tcp.TCPTransport.handleMessages(TCPTransport.java:553)\r\n        at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run0(TCPTransport.java:808)\r\n        at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run(TCPTransport.java:667)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\r\n        at java.lang.Thread.run(Thread.java:636)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbulman","name":"mbulman","emailAddress":"mike at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mbulman&avatarId=17737","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mbulman&avatarId=17737","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mbulman&avatarId=17737","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mbulman&avatarId=17737"},"displayName":"Mike Bulman","active":true},"created":"2010-11-01T22:47:50.981+0000","updated":"2010-11-01T22:47:50.981+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478510/comment/12927422","id":"12927422","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"body":"Mike, can you provide a more complete log?  That trace is unrelated to the patch and likely indicates a different problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"created":"2010-11-02T14:11:27.282+0000","updated":"2010-11-02T14:11:27.282+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478510/comment/12927463","id":"12927463","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbulman","name":"mbulman","emailAddress":"mike at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mbulman&avatarId=17737","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mbulman&avatarId=17737","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mbulman&avatarId=17737","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mbulman&avatarId=17737"},"displayName":"Mike Bulman","active":true},"body":"That's all I get.  The only other thing I can add is that the node being decommissioned logs \"DECOMMISSIONING\" when level is set to DEBUG, and that the exception comes back almost immediately.  fwiw, I'm running this on r1029870 of the .7 branch","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbulman","name":"mbulman","emailAddress":"mike at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mbulman&avatarId=17737","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mbulman&avatarId=17737","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mbulman&avatarId=17737","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mbulman&avatarId=17737"},"displayName":"Mike Bulman","active":true},"created":"2010-11-02T15:24:35.489+0000","updated":"2010-11-02T15:24:35.489+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478510/comment/12927471","id":"12927471","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"body":"There should be more. What I'm looking for is some indication that the node is not in the middle of a bootstrap operation, which would trigger this exception.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"created":"2010-11-02T15:34:32.149+0000","updated":"2010-11-02T15:34:32.149+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478510/comment/12927484","id":"12927484","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbulman","name":"mbulman","emailAddress":"mike at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mbulman&avatarId=17737","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mbulman&avatarId=17737","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mbulman&avatarId=17737","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mbulman&avatarId=17737"},"displayName":"Mike Bulman","active":true},"body":"INFO 15:48:22,176 Joining: getting load information                                                                                                                                                                        \r\n INFO 15:48:22,177 Sleeping 90000 ms to wait for load information...\r\nDEBUG 15:48:23,053 GC for ParNew: 12 ms, 15822112 reclaimed leaving 15102720 used; max is 1268449280                                                                                                                        \r\nDEBUG 15:48:23,166 attempting to connect to /184.106.231.n0\r\n INFO 15:48:23,553 Node /184.106.231.n0 is now part of the cluster                                                                                                                                                         \r\nDEBUG 15:48:23,554 Resetting pool for /184.106.231.n0\r\nDEBUG 15:48:23,559 Node /184.106.231.n0 state normal, token 104110673354167092736227093944218730763                                                                                                                        \r\nDEBUG 15:48:23,559 New node /184.106.231.n0 at token 104110673354167092736227093944218730763\r\nDEBUG 15:48:23,559 clearing cached endpoints                                                                                                                                                                                \r\nDEBUG 15:48:24,167 attempting to connect to /184.106.231.n0\r\nDEBUG 15:48:24,169 Disseminating load info ...                                                                                                                                                                              \r\n INFO 15:48:24,554 InetAddress /184.106.231.n0 is now UP\r\n INFO 15:48:24,554 Started hinted handoff for endpoint /184.106.231.n0                                                                                                                                                  \r\n INFO 15:48:24,557 Finished hinted handoff of 0 rows to endpoint /184.106.231.n0\r\nDEBUG 15:49:24,169 Disseminating load info ...                                                                                                                                                                              \r\nDEBUG 15:49:39,106 GC for ParNew: 16 ms, 16111512 reclaimed leaving 85537648 used; max is 1268449280\r\nDEBUG 15:49:52,177 ... got load info                                                                                              \r\n INFO 15:49:52,177 Joining: getting bootstrap token\r\nDEBUG 15:49:52,183 attempting to connect to /184.106.231.n0                                                                                                                                                                \r\nDEBUG 15:49:52,191 Processing response on a callback from 270@/184.106.231.n0\r\n INFO 15:49:52,192 New token will be 19040081623932476870383442086276677899 to assume load from /184.106.231.n0                                                                                                             \r\nDEBUG 15:49:52,193 clearing cached endpoints\r\nDEBUG 15:49:52,194 Will try to load mx4j now, if it's in the classpath                                                                                                                                                      \r\n INFO 15:49:52,194 Will not load MX4J, mx4j-tools.jar is not in the classpath\r\n INFO 15:49:52,220 Binding thrift service to /0.0.0.0:9160                                                                                                                                                                  \r\n INFO 15:49:52,222 Using TFramedTransport with a max frame size of 15728640 bytes.\r\n INFO 15:49:52,226 Listening for thrift clients...                                                                                                                                                                          \r\nDEBUG 15:50:24,170 Disseminating load info ...\r\nDEBUG 15:50:52,247 DECOMMISSIONING                                                                                                                                                                                          \r\nDEBUG 15:51:24,170 Disseminating load info ...\r\nDEBUG 15:52:24,171 Disseminating load info ...                                                                                                                                                                              \r\n\r\n\r\nFrom n0:\r\n\r\nroot@ripcord:/usr/src/cassandra/branches/cassandra-0.7# bin/nodetool -h 184.106.231.n0  ring                                                                                                                           \r\nAddress         Status State   Load            Token\r\n                                       104110673354167092736227093944218730763                                                                                                                                             \r\n184.106.228.n1 Up     Normal  5.3 KB          19040081623932476870383442086276677899\r\n184.106.231.n0 Up     Normal  10.27 KB        104110673354167092736227093944218730763                                                                                                                                     \r\n\r\nroot@ripcord:/usr/src/cassandra/branches/cassandra-0.7# bin/nodetool -h 184.106.228.n1 decommission \r\n     <TRACE FROM MY PREVIOUS COMMENT>\r\n\r\nroot@ripcord:/usr/src/cassandra/branches/cassandra-0.7# bin/nodetool -h 184.106.231.n0 ring\r\nAddress         Status State   Load            Token                                       \r\n                                       104110673354167092736227093944218730763    \r\n184.106.228.n1 Up     Normal  5.3 KB          19040081623932476870383442086276677899      \r\n184.106.231.n0 Up     Normal  10.27 KB        104110673354167092736227093944218730763     \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbulman","name":"mbulman","emailAddress":"mike at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mbulman&avatarId=17737","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mbulman&avatarId=17737","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mbulman&avatarId=17737","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mbulman&avatarId=17737"},"displayName":"Mike Bulman","active":true},"created":"2010-11-02T16:34:53.999+0000","updated":"2010-11-02T16:34:53.999+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478510/comment/12927652","id":"12927652","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbulman","name":"mbulman","emailAddress":"mike at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mbulman&avatarId=17737","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mbulman&avatarId=17737","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mbulman&avatarId=17737","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mbulman&avatarId=17737"},"displayName":"Mike Bulman","active":true},"body":"Ok got it working properly.  Patch fixes the issue described.\r\n\r\nAs a node, that patch doesn't work in 0.7 branch because justRemovedEndPoints_ (.6) is now justRemovedEndpoints (.7).  Not sure how you guys handle that, but the change is simple enough.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbulman","name":"mbulman","emailAddress":"mike at datastax dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mbulman&avatarId=17737","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mbulman&avatarId=17737","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mbulman&avatarId=17737","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mbulman&avatarId=17737"},"displayName":"Mike Bulman","active":true},"created":"2010-11-02T22:25:28.911+0000","updated":"2010-11-02T22:25:28.911+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478510/comment/12927661","id":"12927661","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"bq. The old code will only remove a node from justRemovedEndpoints_ if it currently exists in endpointStateMap_\r\n\r\nIsn't it \"remove from jRE if _any_ [other] node exists in eSM?\"  Which means this is only a bug in 2-node clusters?\r\n\r\n+1 if so, just trying to understand.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2010-11-02T22:58:21.591+0000","updated":"2010-11-02T22:58:21.591+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12478510/comment/12927840","id":"12927840","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"body":"bq. sn't it \"remove from jRE if any [other] node exists in eSM?\" Which means this is only a bug in 2-node clusters?\r\nYes. good observation.  I'll only bother committing this to 0.7/trunk then.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gdusbabek","name":"gdusbabek","emailAddress":"gdusbabek at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gdusbabek&avatarId=10070","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gdusbabek&avatarId=10070","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gdusbabek&avatarId=10070","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gdusbabek&avatarId=10070"},"displayName":"Gary Dusbabek","active":true},"created":"2010-11-03T13:07:03.022+0000","updated":"2010-11-03T13:07:03.022+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-1670/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0g6nz:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12343799","self":"https://issues.apache.org/jira/rest/api/latest/issue/12343799","key":"DERBY-1365","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-06-07 04:49:30.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22463","customfield_12310222":"1_*:*_1_*:*_515547000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_91000","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-06-07T22:22:56.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1365/watchers","watchCount":0,"isWatching":false},"created":"2006-06-01T23:10:29.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-06-29T14:33:33.269+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[],"timeoriginalestimate":null,"description":"While looking at the optimization code in Derby for some other work I'm doing, I've noticed a couple of small pieces of code that could potentially lead to failures for some queries.  Thus far I have been unable to come up with any examples to demonstrate these problems with the current codeline (hence the term \"potential\" problems) because the relevant lines of code are hard to exercise--they require large, complex databases and/or some tricky timing scenarios that I have thus far been unable to produce in the context of the test harness.  And in fact, a look at the code coverage results for the pieces of code shows that neither is actually exercised by the current derbyall suite--which I believe is more indicative of how hard it is to exercise the code in question than it is of incomplete/lacking tests.\r\n\r\nAll of that said, analysis of the relevant code does indeed seem to indicate that some (minor) changes are in order.  In particular, consider the following two potential problems.\r\n\r\n1) Potential logic error when determining the best join order for a subquery that has more than one FROM table.\r\n\r\nThis particular issue is very timing-sensitive.  It will only occur if there is an outer query which has a subquery and the optimization phase of the subquery \"times out\" in the middle of costing a join order.  The relevant point in the code can be found in OptimizerImpl.java, around line 420:\r\n\r\n    if (permuteState != JUMPING)\r\n    {\r\n        // By setting firstLookOrder to our target join order\r\n        // and then setting our permuteState to JUMPING, we'll\r\n        // jump to the target join order and get the cost.  That\r\n        // cost will then be saved as bestCost, allowing us to\r\n        // proceed with normal timeout logic.\r\n        for (int i = 0; i < numOptimizables; i++)\r\n            firstLookOrder[i] = bestJoinOrder[i];\r\n        permuteState = JUMPING;\r\n\r\n        // If we were in the middle of a join order when this\r\n        // happened, then reset the join order before jumping.\r\n        if (joinPosition > 0)\r\n            rewindJoinOrder();\r\n    }\r\n\r\nThe problem occurs at the last part of this \"if\" block, with the call to rewind the join order.  The rewindJoinOrder() method will \"pull\" each optimizable that has an assigned position in the current join order and, for each one, decrement joinPosition--until all optimizables have been pulled and joinPosition has a value of \"0\".  So far so good.\r\n\r\nThe trick is that, unlike the other calls to rewindJoinOrder() in OptimizerImpl, this particular call occurs *before* the joinPosition variable is incremented (it's incremented every time a call to find the \"next permutation\" is made, until all optimizables (FROM tables) have been assigned a position in the join order).  What this means is that, with the code as it currently stands, the call to rewindJoinOrder() will put joinPosition at 0, but shortly thereafter joinPosition will be incremented to \"1\".  The subsequent search for a \"next permutation\" will then try to place an optimizable at position 1 in the join order--but since there would be no optimizable at position 0 (we would have inadvertently skipped over it because of the increment after rewinding), the logic for finding/setting the next optimizable in the join order would break down.  So I think this needs to be addressed--and it should be as simple as setting joinPosition to -1 after the aforementioned call to rewindJoinOrder().  This -1 value is what joinPosition is set to before each round of optimization, so there is a precedent and, I believe, that is the right thing to do.  Once that's done all of the existing logic will work as normal.\r\n\r\n2) Potential NullPointerException if optimizer comes up with unreasonably high cost estimates (esp. Double.POSITIVE_INFINITY) and then, at execution time, Derby tries to do a hash join based on such an estimate with a ResultSet that has no rows.\r\n\r\nIn this case, the code in question is in the constructor logic for BackingStoreHashtable.java.  In cases where the backing hash table receives an unreasonably high cost estimate (a \"red flag\" estimate as noted in the comments), it's possible that, for cases where the row_source field of the object is null or has no rows (which indicates an empty result set), the hash_table field will end up being null when we reach the end of the constructor.  But if we create a BackingStoreHashtable with a null hash_table, then any calls to the BackingStoreHashtable's methods that expect a valid (non-null) hash_table could fail with an NPE.  Thus there should be some additional logic to ensure that, upon completion of the constructor code, hash_table has been initialized to some appropriate non-null value--namely, an empy hash table if there are no rows to process.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10362","value":"Performance","id":"10362"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39086","summary":"Address potential problems with optimizer logic in some rarely-exercised code.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":4,"total":4,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12343799/comment/12414252","id":"12414252","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Attaching a patch (d1365_v1.patch) for the two problems described in this issue.  The changes are pretty minor and are, I believe, suitably described by the description of the problems above and by the comments in the patch.\r\n\r\nIn addition to fixing the two issues described, the patch also resolves another potential problem: there are several places in OptimizerImpl.getNextPermutation() where calls to rewindJoinOrder() are made.  These calls typically indicate that the optimizer has decided to abandon or \"short circuit\" a join order before calculating the full cost.  For some of these calls--esp. the ones that can occur in the middle of the join order (as opposed to those which will only occur on a complete join order)--the \"rewind\" operation needs to make sure to reload the best plans for the optimizables that are pulled as part of the \"rewind\" process.  Otherwise Derby could end up generating a plan for an optimizable even though that plan was part of a join order that was \"abandoned\" (i.e. rewound in the middle), which is logically incorrect and could lead to sub-optimal performance.  I've included changes for this issue as part of d1365_v1.patch.\r\n\r\nI ran derbyall on Red Hat Linux with d1365_v1.patch applied and saw no new failures.  I would appreciate reviews/comments/commit if anyone has the time...\r\n\r\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-06-01T23:16:55.000+0000","updated":"2006-06-01T23:16:55.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12343799/comment/12415035","id":"12415035","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Marking fix-in as 10.2 *and* 10.1.3, which is where I'm hoping to see this patch checked in.  But so far it hasn't been committed to either...anyone out there have time for a review/commit?  I'd appreciate it...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-06-07T03:28:34.000+0000","updated":"2006-06-07T03:28:34.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12343799/comment/12415056","id":"12415056","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"body":"Submitted this patch to trunk and 10.1 branches. Thanks Army.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bandaram","name":"bandaram","emailAddress":"bandaram at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Satheesh Bandaram","active":true},"created":"2006-06-07T04:49:30.000+0000","updated":"2006-06-07T04:49:30.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12343799/comment/12415153","id":"12415153","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Patch checked into 10.1 with svn # 412218 and into trunk with svn # 412222.  I have verified by inspection that the change is in both codelines and that there were no new failures in the nightly tests.  So I'm resolving and closing this issue.\r\n\r\nThanks for committing, Satheesh.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-06-07T22:22:55.000+0000","updated":"2006-06-07T22:22:55.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1365/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i071z3:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12348172","self":"https://issues.apache.org/jira/rest/api/latest/issue/12348172","key":"DERBY-1716","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-09-20 23:15:34.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22660","customfield_12310222":"3_*:*_1_*:*_1513952000_*|*_1_*:*_1_*:*_3098602000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_37077780937","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-10-10T05:42:10.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1716/watchers","watchCount":0,"isWatching":false},"created":"2006-08-17T20:26:16.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12313124","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12313124","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12312336","key":"DERBY-464","self":"https://issues.apache.org/jira/rest/api/2/issue/12312336","fields":{"summary":"Enhance Derby by adding grant/revoke support. Grant/Revoke provide finner level of privileges than currently provided by Derby that is especially useful in network configurations.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-12-13T09:05:10.936+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"Revoking table select privilege from a user  will time out if that user still have an open cursor on that table.\nHence, a database owner will not be able to revoke select privilege from any user(s) if they still have a cursor \nopen.  i.e.:  \n\nij version 10.2\nij> connect 'jdbc:derby:cs1;create=true' user 'user1' as user1;\nWARNING 01J14: SQL authorization is being used without first enabling authentication.\nij> connect 'jdbc:derby:cs1' user 'user3' as user3;\nWARNING 01J14: SQL authorization is being used without first enabling authentication.\nij(USER3)> set connection user1;\nij(USER1)> create table t1001 (c varchar(1));\n0 rows inserted/updated/deleted\nij(USER1)> insert into t1001 values 'a', 'b', 'c';\n3 rows inserted/updated/deleted\nij(USER1)> grant select on t1001 to user3;\n0 rows inserted/updated/deleted\nij(USER1)> set connection user3;\nij(USER3)> autocommit off;\nij(USER3)> GET CURSOR crs1 AS 'select * from user1.t1001';\nij(USER3)> next crs1;\nC   \n----\na   \nij(USER3)> set connection user1;\nij(USER1)> -- revoke select privilege while user3 still have an open cursor\nrevoke select on t1001 from user3;\nERROR 40XL1: A lock could not be obtained within the time requested\nij(USER1)> select * from syscs_diag.lock_table;\nXID            |TYPE |MODE|TABLENAME                                                                                                                       |LOCKNAME            |STATE|TABLETYPE|LOCK&|INDEXNAME                                                                                                                       \n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n130            |TABLE|IS  |SYSTABLEPERMS                                                                                                                   |Tablelock           |GRANT|S        |4    |NULL                                                                                                                            \n130            |ROW  |S   |SYSTABLEPERMS                                                                                                                   |(1,7)               |GRANT|S        |2    |NULL                                                                                                                            \n130            |TABLE|IS  |T1001                                                                                                                           |Tablelock           |GRANT|T        |1    |NULL                                                                                                                            \n\n3 rows selected\nij(USER1)> set connection user3;\nij(USER3)> next crs1;\nC   \n----\nb   \nij(USER3)> next crs1;\nC   \n----\nc   \nij(USER3)> close crs1;\nij(USER3)> \n\nIs there a reason why Derby still keep shared locks on SYS.SYSTABLEPERMS during fetch?\n\n\nsysinfo:\n\n------------------ Java Information ------------------\nJava Version:    1.4.2_12\nJava Vendor:     Sun Microsystems Inc.\nJava home:       C:\\Program Files\\Java\\j2re1.4.2_12\nJava classpath:  derby.jar;derbytools.jar\nOS name:         Windows XP\nOS architecture: x86\nOS version:      5.1\nJava user name:  Yip\nJava user home:  C:\\Documents and Settings\\Yip\nJava user dir:   C:\\work3\\derby\\tests\\derby-10.2.1.0\\lib\njava.specification.name: Java Platform API Specification\njava.specification.version: 1.4\n--------- Derby Information --------\nJRE - JDBC: J2SE 1.4.2 - JDBC 3.0\n[C:\\work3\\derby\\tests\\derby-10.2.1.0\\lib\\derby.jar] 10.2.1.0 beta - (430903)\n[C:\\work3\\derby\\tests\\derby-10.2.1.0\\lib\\derbytools.jar] 10.2.1.0 beta - (430903)\n------------------------------------------------------\n----------------- Locale Information -----------------\nCurrent Locale :  [English/United States [en_US]]\nFound support for locale: [de_DE]\n         version: 10.2.1.0 - (430903)\nFound support for locale: [es]\n         version: 10.2.1.0 - (430903)\nFound support for locale: [fr]\n         version: 10.2.1.0 - (430903)\nFound support for locale: [it]\n         version: 10.2.1.0 - (430903)\nFound support for locale: [ja_JP]\n         version: 10.2.1.0 - (430903)\nFound support for locale: [ko_KR]\n         version: 10.2.1.0 - (430903)\nFound support for locale: [pt_BR]\n         version: 10.2.1.0 - (430903)\nFound support for locale: [zh_CN]\n         version: 10.2.1.0 - (430903)\nFound support for locale: [zh_TW]\n         version: 10.2.1.0 - (430903)\n------------------------------------------------------\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39656","summary":"Revoking select privilege from a user times out when that user still have a cursor open.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10102","value":"Patch Available","id":"10102"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Sun JDK 1.4.2","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":17,"total":17,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12436281","id":"12436281","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"body":"The shared lock on SYS.SYSTABLEPERMS is actually obtained by the activation itself during \r\nexecution time (at the start of fillResultSet() of the activation class) since the grantee's privileges\r\nare not in the permission cache yet.  Thus, the shared locks will last till end of the transaction.\r\nThis is done once and those privileges that were loaded from the data dictionary(DD) will be stored \r\nin the permission cache for use later so that the system does not need to load those info again\r\nfrom the DD.  Perhaps these privilege info can be loaded at compilation time instead as an improvement, \r\nso that at execution time, privilege related metadata  can be retrieved from the permission cache instead \r\nof from the DD.\r\n\r\n\r\nprotected ResultSet fillResultSet() throws StandardException\r\n{\r\n    ((Activation) this).getLanguageConnectionContext().getAuthorizer().authorize( (Activation) this, 1 );\r\n    return getResultSetFactory().getScrollInsensitiveResultSet(  <snip> );\r\n}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"created":"2006-09-20T17:19:18.000+0000","updated":"2006-09-20T17:19:18.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12436295","id":"12436295","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"body":"Note that since the statement may be cached by the system and reuse by other users of different \r\nconnections, the suggested scheme of loading privilege(s) at compilation time may not eliminate the \r\nDD access in all cases if the system were to load the privilege info based on the auth id that compiles \r\nthe statement. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"created":"2006-09-20T18:28:41.000+0000","updated":"2006-09-20T18:28:41.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12436391","id":"12436391","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Yip, are you saying that we use the *user's* transaction to read table and column\r\npermissions information from the data dictionary? I would have expected us\r\nto use some sort of internal \"system\" transaction for this kind of catalog fetch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-09-20T23:15:34.000+0000","updated":"2006-09-20T23:15:34.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12436405","id":"12436405","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"body":"Bryan, at compilation time, Derby uses an internal system nested transaction.  After compilation is completed, this nested system \r\ntransaction is committed; therefore, the shared locks for system tables are released.  However, at execution time of this jira case, \r\nthe activation class is querying the data dictionary for permission since those descriptors are not in the permission cache, therefore, \r\nthe shared locks are obtained for those system tables using the user transaction.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"created":"2006-09-21T00:06:19.000+0000","updated":"2006-09-21T00:06:19.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12436416","id":"12436416","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"body":"I debugged into the code abit today, I don't think the system is fetching the  permission descriptor(s) \r\nfrom the system catalog at compilation time for the stated problem of this jira.  During bind phase,\r\nthe system just collects various permission(s) that are required to execute the select statement.  It is \r\nat the execution time of the statement that the descriptors are fetched from the data dictionary.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"created":"2006-09-21T01:29:29.000+0000","updated":"2006-09-21T01:29:29.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12437041","id":"12437041","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"body":"Attaching initial patch derby1716-trunk-diff01a.txt for DERBY-1716.  The patch fixes the stated problem of this jira where it now loads the auth id's permission descriptors into the permission cache at compilation time instead, so that at execution time, the system does not have to go through the system table(s) again and hold the shared locks till the end of user transaction.   derbyall passes.  Appreciate if someone can review the patch.  Thanks. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"created":"2006-09-23T02:15:16.000+0000","updated":"2006-09-23T02:15:16.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12437107","id":"12437107","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Hi Yip, thanks for the patch!\r\n\r\nI read through the code and it looks good. Thanks for the clear comments in the \r\naddToPermissionsCache method and for the good tests.\r\n\r\nI noticed as part of studying DERBY-1847 that DataDictionaryImpl.clearCaches()\r\ndoes not clear the DataDictionary permissions cache. This seems wrong to me,\r\nand although it probably isn't *directly* related to this JIRA issue, I still wanted to\r\nbring it up since you've been studying this code, and get your opinion.\r\n\r\nRegarding your patch, I noticed you called it an \"initial patch\". Do you feel that this\r\npatch is ready for commit? Or do you think that there is additional work to do?\r\n\r\nAre other reviewers looking at this patch?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-09-23T15:14:47.000+0000","updated":"2006-09-23T15:14:47.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12437108","id":"12437108","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Addendum to previous comment: the patch applies cleanly for me, and I\r\nverified that, without the code change, the test case demonstrates the\r\nbug, and with the code change, the test case passes. I am +1 to commit,\r\nand I propose to commit this change if Yip feels that it is ready for commit.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-09-23T15:22:25.000+0000","updated":"2006-09-23T15:22:25.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12437239","id":"12437239","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"body":"Hi Bryan, thanks for taking the time for reviewing the patch.  For the clearCaches() part, it looks like the\r\npermission cache handling are somewhat different from other caches.  For instance, when a table gets\r\ndropped, its permission descriptor gets removed from the cache in its constant action(DROP TABLE) via\r\nDataDictionary's dropAllTableAndColPermDescriptors().  So they do get removed from the permission\r\ncache.  \r\n\r\nI am trying another different approach so please do not commit the current patch just yet.  I will post my findings\r\nsoon.  Thanks. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"created":"2006-09-24T18:00:40.000+0000","updated":"2006-09-24T18:00:40.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12437258","id":"12437258","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"unchecking patch available, contributer has asked for this patch to not be applied yet.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2006-09-24T22:07:47.000+0000","updated":"2006-09-24T22:07:47.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12437940","id":"12437940","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"body":"Attaching patch derby1716-trunk-diff02.txt for DERBY-1716.\r\n\r\nAfter further analysis, I think the previous patch does not address all cases.  \r\nIn particular, unlike other descriptors, when privilege(s) get revoked from user, \r\nthe statement is not subject to recompilation, so then we are back to square one \r\nsince the previous patch attempts to bring in the permission descriptor(s) into \r\nthe permission cache at compilation time to avoid reading from system tables at \r\nexecution time.  \r\n\r\nI believe the proper proposal fix is to use internal nested read-only transaction \r\nwhen the system is reading permission descriptors from the system tables.  At a \r\nhigh level, a statement undergoes the following typical steps for it to get executed \r\nby the system:  \r\n\r\n1.  Statement Compilation Phase\r\n a) Parse the statement \r\n b) Bind the statement and collects required permissions for it to be executed.\r\n c) Optimize the statement\r\n d) Generate the activation for the statement\r\n \r\n\r\n2.  Statement Execution Phase\r\n a) Check if the authoration id has the required privileges to execute the statement.\r\n b) Execute the statement\r\n\r\n\r\nThe problem lies in permissions checking step at statement execution phase.  Before a statement can be executed in SQL authorization mode, the authorization id's privileges needs to be check against the permission cache or if the privileges are not available in the cache, the system needs to read this metadata information from the system tables.  But the system is using *user transaction* to do this, so the shared locks that got acquired by the user transaction may not get released immediately; therefore, leading to lock timeout when the grantor attempts to revoke the user's privilege.  To resolve this issue, the system now will start an internal read-only nested transaction(same lock space as the parent transaction) to read permission related info from the system tables and release the shared locks \r\nas soon as the permissions check is completed before statement execution.  This tackles the root of the stated problem.  derbyall passes.  Appreciate if someone can review the code changes.  Thanks.\r\n\r\nOther interesting observations while going through the code:  \r\n\r\n(1) In the current implementation, privileges collection actually ends at the time where the constant action is created and not at bind time.  e.g.:  DROP TABLE has schema permission collected at that time.\r\n\r\n(2) Permissions cache handling are different from other data dictionary caches.  The other caches gets *ALL* cleared out either at startReading() or startWriting() time in Data Dictionary depending  on the current cache mode.  However, only the \"affected\" cached items in the permissions cache are removed and this logic is handled by the statements themselves and not the data dictionary.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"created":"2006-09-26T20:44:04.000+0000","updated":"2006-09-26T20:44:04.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12440533","id":"12440533","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"could you regenerate this patch, I am getting failures in applying the test portions of the patch - \r\ngrantRevokeDDL.sql has been a hot file.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2006-10-06T17:07:22.000+0000","updated":"2006-10-06T17:07:22.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12440555","id":"12440555","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"body":"Previous patch got stale, attaching derby1716-trunk-diff03.txt.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"created":"2006-10-06T17:45:32.000+0000","updated":"2006-10-06T17:45:32.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12440681","id":"12440681","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"Committed this patch to the trunk.\r\n\r\nm3_ibm142:20>svn commit\r\n\r\nSending        java\\engine\\org\\apache\\derby\\impl\\sql\\conn\\GenericAuthorizer.java\r\n\r\nSending        java\\testing\\org\\apache\\derbyTesting\\functionTests\\master\\grantRevokeDDL.out\r\nSending        java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\lang\\grantRevokeDDL.sql\r\nSending        java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\lang\\grantRevokeDDL_app.properties\r\nTransmitting file data ....\r\nCommitted revision 453935.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2006-10-07T15:34:15.000+0000","updated":"2006-10-07T15:34:15.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12454063","id":"12454063","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Ported to 10.2 branch at subversion revision 480148.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2006-11-28T18:20:13.000+0000","updated":"2006-11-28T18:20:13.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12457926","id":"12457926","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"updated the 10.2 j9_foundation canon with revision 486380.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2006-12-12T22:46:51.000+0000","updated":"2006-12-12T22:46:51.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12348172/comment/12551404","id":"12551404","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"body":"This issue has been resolved for over a year with no further movement. Closing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"created":"2007-12-13T09:05:10.935+0000","updated":"2007-12-13T09:05:10.935+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1716/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i075hr:"}}
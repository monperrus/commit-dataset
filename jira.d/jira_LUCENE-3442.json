{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12523770","self":"https://issues.apache.org/jira/rest/api/latest/issue/12523770","key":"LUCENE-3442","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310110","id":"12310110","key":"LUCENE","name":"Lucene - Core","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310110&avatarId=10061","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310110&avatarId=10061","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310110&avatarId=10061","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310110&avatarId=10061"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317877","id":"12317877","description":"Major release after 3.4","name":"3.5","archived":false,"released":true,"releaseDate":"2011-11-27"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-09-20 18:53:11.954","customfield_12312323":null,"customfield_12310420":"2681","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1813254_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2011-09-20T19:16:25.011+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-3442/watchers","watchCount":1,"isWatching":false},"created":"2011-09-20T18:46:11.773+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314822","id":"12314822","description":"Major release after 3.x","name":"3.1","archived":false,"released":true,"releaseDate":"2011-03-31"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316070","id":"12316070","description":"Major release after 3.1","name":"3.2","archived":false,"released":true,"releaseDate":"2011-06-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316470","id":"12316470","description":"Major release after 3.2","name":"3.3","archived":false,"released":true,"releaseDate":"2011-07-01"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316675","id":"12316675","description":"Major release after 3.3","name":"3.4","archived":false,"released":true,"releaseDate":"2011-09-14"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-11-27T12:29:25.819+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12310235","id":"12310235","name":"core/search","description":"issues with search code"}],"timeoriginalestimate":null,"description":"If you try to get the iterator for the DocIdSet returned by a QueryWrapperFilter which wraps a TermQuery you get null instead of an iterator that returns the same documents as the search on the TermQuery.\r\n\r\nCode demonstrating the issue:\r\n\r\n{code:java}\r\nimport java.io.IOException;\r\nimport org.apache.lucene.analysis.WhitespaceAnalyzer;\r\nimport org.apache.lucene.document.Document;\r\nimport org.apache.lucene.document.Field;\r\nimport org.apache.lucene.document.Field.Index;\r\nimport org.apache.lucene.document.Field.Store;\r\nimport org.apache.lucene.index.IndexReader;\r\nimport org.apache.lucene.index.IndexWriter;\r\nimport org.apache.lucene.index.IndexWriterConfig;\r\nimport org.apache.lucene.index.Term;\r\nimport org.apache.lucene.store.RAMDirectory;\r\nimport org.apache.lucene.util.Version;\r\nimport org.apache.lucene.search.DocIdSet;\r\nimport org.apache.lucene.search.DocIdSetIterator;\r\nimport org.apache.lucene.search.Filter;\r\nimport org.apache.lucene.search.IndexSearcher;\r\nimport org.apache.lucene.search.QueryWrapperFilter;\r\nimport org.apache.lucene.search.TermQuery;\r\nimport org.apache.lucene.search.TopDocs;\r\n\r\npublic class TestQueryWrapperFilterIterator {\r\n   public static void main(String[] args) {\r\n\t\ttry {\r\n\t\t\tIndexWriterConfig iwconfig = new IndexWriterConfig(Version.LUCENE_34, new WhitespaceAnalyzer(Version.LUCENE_34));\r\n\t\t\tiwconfig.setOpenMode(IndexWriterConfig.OpenMode.CREATE);\r\n\t\t\tRAMDirectory dir = new RAMDirectory();\r\n\t\t\r\n\t\t\tIndexWriter writer = new IndexWriter(dir, iwconfig);\r\n\t\t\tDocument d = new Document();\r\n\t\t\td.add(new Field(\"id\", \"1001\", Store.YES, Index.NOT_ANALYZED));\r\n\t\t\td.add(new Field(\"text\", \"headline one group one\", Store.YES, Index.ANALYZED));\r\n\t\t\td.add(new Field(\"group\", \"grp1\", Store.YES, Index.NOT_ANALYZED));\r\n\t\t    writer.addDocument(d);\r\n\t\t\twriter.commit();\r\n\t\t\twriter.close();\r\n\t\t\t\r\n\t\t\tIndexReader rdr = IndexReader.open(dir);\r\n\t\t\tIndexSearcher searcher = new IndexSearcher(rdr);\r\n\t\t\t\r\n\t\t\tTermQuery tq = new TermQuery(new Term(\"text\", \"headline\"));\r\n\t\t\t\r\n\t\t\tTopDocs results = searcher.search(tq, 5);\r\n\t\t\tSystem.out.println(\"Number of search results: \" + results.totalHits);\r\n\t\t\t\r\n\t\t\tFilter f = new QueryWrapperFilter(tq);\r\n\t\t\t\r\n\t\t\tDocIdSet dis = f.getDocIdSet(rdr);\r\n\t\t\t\r\n\t\t\tDocIdSetIterator it = dis.iterator();\r\n\t\t\tif (it != null) {\r\n\t\t\t\tint docId = it.nextDoc();\r\n\t\t\t\twhile (docId != DocIdSetIterator.NO_MORE_DOCS) {\r\n\t\t\t\t\tDocument doc = rdr.document(docId);\r\n\t\t\t\t\tSystem.out.println(\"Iterator doc: \" + doc.get(\"id\"));\r\n\t\t\t\t\tdocId = it.nextDoc();\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tSystem.out.println(\"Iterator was null: \");\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tsearcher.close();\r\n\t\t\trdr.close();\r\n\t\t} catch (IOException ioe) {\r\n\t\t\tioe.printStackTrace();\r\n\t\t}\r\n\r\n\t}\r\n}\r\n{code}","customfield_10010":null,"timetracking":{},"customfield_12310120":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10121","value":"New","id":"10121"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"24572","summary":"QueryWrapperFilter gets null DocIdSetIterator when wrapping TermQuery","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aberdeen61","name":"aberdeen61","emailAddress":"dcliman at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dan Climan","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aberdeen61","name":"aberdeen61","emailAddress":"dcliman at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dan Climan","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"java 1.6.0_27","customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":5,"total":5,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12523770/comment/13108929","id":"13108929","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"body":"The issue lies in the fact that an optimization in TermQuery prevents it's Weight.scorer() method to behave correctly when no atomic reader is passed in. This is no longer supported in Lucene trunk, but in 3.x the weight should still be able to work on composite readers. The sample code provided does this exactly: It calls QWF.getDocIdSet on a non-atomic IndexReader. QWF calls TermWeight.scorer() and this one returns null, because the composite reader is not in its DF cache.\r\n\r\nThe fix is easy: Don't early exit in scorer() if the reader passed in is not atomic.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"created":"2011-09-20T18:53:11.954+0000","updated":"2011-09-20T18:53:11.954+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12523770/comment/13108934","id":"13108934","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"body":"Patch that fixes the issue. It also contains the testcase provided by Dan C.\r\n\r\nWill commit soon.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"created":"2011-09-20T18:57:17.259+0000","updated":"2011-09-20T18:57:17.259+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12523770/comment/13108936","id":"13108936","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"body":"The issue is caused by LUCENE-2829, committed January and exists since Lucene 3.1.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"created":"2011-09-20T19:03:01.714+0000","updated":"2011-09-20T19:03:01.714+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12523770/comment/13108942","id":"13108942","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"body":"Committed 3.x branch revision: 1173311","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"created":"2011-09-20T19:16:25.020+0000","updated":"2011-09-20T19:16:25.020+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12523770/comment/13157753","id":"13157753","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"body":"Bulk close after release of 3.5","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thetaphi","name":"thetaphi","emailAddress":"uwe at thetaphi dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thetaphi&avatarId=18956","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thetaphi&avatarId=18956","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thetaphi&avatarId=18956","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thetaphi&avatarId=18956"},"displayName":"Uwe Schindler","active":true},"created":"2011-11-27T12:29:25.784+0000","updated":"2011-11-27T12:29:25.784+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-3442/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i04kev:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12443423","self":"https://issues.apache.org/jira/rest/api/latest/issue/12443423","key":"CASSANDRA-634","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310865","id":"12310865","key":"CASSANDRA","name":"Cassandra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310865&avatarId=12034","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310865&avatarId=12034","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310865&avatarId=12034","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310865&avatarId=12034"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11961","id":"11961","description":"Apache Cassandra related projects","name":"Cassandra"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314040","id":"12314040","description":"","name":"0.5","archived":false,"released":true,"releaseDate":"2010-01-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-12-16 14:34:29.417","customfield_12312322":null,"customfield_12312323":null,"customfield_12310222":"10002_*:*_1_*:*_183357717_*|*_1_*:*_1_*:*_254621283_*|*_5_*:*_2_*:*_234753518_*|*_4_*:*_1_*:*_26157703","customfield_12310420":"19791","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2009-12-23T19:44:13.895+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-634/watchers","watchCount":2,"isWatching":false},"created":"2009-12-15T17:36:03.674+0000","customfield_10022":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12311124":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-12-23T19:44:13.892+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[],"timeoriginalestimate":null,"description":"Updated to the latest codebase from cassandra-0.5 branch. All nodes booted up fine and then I start noticing this error:\r\n\r\nERROR [HINTED-HANDOFF-POOL:1] 2009-12-14 22:05:34,191 CassandraDaemon.java (line 71) Fatal exception in thread Thread[HINTED-HANDOFF-POOL:1,5,main]\r\njava.lang.RuntimeException: java.lang.NullPointerException\r\n        at org.apache.cassandra.db.HintedHandOffManager$1.run(HintedHandOffManager.java:253)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\r\n        at java.lang.Thread.run(Thread.java:619)\r\nCaused by: java.lang.NullPointerException\r\n        at org.apache.cassandra.gms.FailureDetector.isAlive(FailureDetector.java:146)\r\n        at org.apache.cassandra.db.HintedHandOffManager.sendMessage(HintedHandOffManager.java:106)\r\n        at org.apache.cassandra.db.HintedHandOffManager.deliverAllHints(HintedHandOffManager.java:177)\r\n        at org.apache.cassandra.db.HintedHandOffManager.access$000(HintedHandOffManager.java:75)\r\n        at org.apache.cassandra.db.HintedHandOffManager$1.run(HintedHandOffManager.java:249)\r\n        ... 3 more","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12428285","id":"12428285","filename":"634-1st-part-gossip-about-all-nodes.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-17T12:00:31.247+0000","size":3982,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12428285/634-1st-part-gossip-about-all-nodes.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12428637","id":"12428637","filename":"634-discard-obsolete.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-21T16:47:56.730+0000","size":3203,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12428637/634-discard-obsolete.patch"}],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"91453","summary":"Hinted Handoff Exception","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"customfield_12311420":null,"customfield_12311421":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":17,"total":17,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12790838","id":"12790838","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"body":"I'm wondering if this might be due to the fact that one of the node's in the cluster is currently down. This might offer a clue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"created":"2009-12-15T17:37:11.189+0000","updated":"2009-12-15T17:37:11.189+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12791382","id":"12791382","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"Very strange one.\r\n\r\nLine 146 in FailureDetector is this:\r\n\r\nEndPointState epState = Gossiper.instance().getEndPointStateForEndPoint(ep);\r\n\r\nAccording to the stacktrace it does not even reach getEndPointStateForEndPoint, and even if it did, ep comes from InetAddress.getByAddress, so it cannot be null. Also, if the culprit was Gossiper constructor, that should also show in the trace.\r\n\r\nThis would mean that Gossiper.instance() returns null, but I don't know how that can happen. \"volatile\" in gossiper_ is actually not needed, but I don't know if having it there could cause such thing. \"volatile\" was added here pretty recently, so it just might be one possible explanation why this came up now.\r\n\r\nBTW what version of java you're using?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-16T14:34:29.417+0000","updated":"2009-12-16T14:34:29.417+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12791385","id":"12791385","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"No, 146 in the 0.5 branch is the next line:\r\n\r\n        return epState.isAlive();\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-16T14:42:14.230+0000","updated":"2009-12-16T14:42:14.230+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12791392","id":"12791392","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"Oops, sorry. I need a bigger font :-(\r\n\r\n(but still \"volatile\" is not needed there :-)\r\n\r\nOK, could it be like this: There are nodes A and B in the cluster, with replication factor 2. Node B goes down and node C is introduced as a new node after this. Now A knows there are A, B and C in the cluster, but C only knows about A. Suppose at this time client sends a write request to A, which falls into A's range (and replica to B's range). B is offline, so instead a hinted write will go to C. Problem is, C will try to deliver this hint later to B, but its Gossiper has never heard of B, so endpointstate will be null.\r\n\r\nIf this is the cause, then a simple fix\r\n\r\nif (epState == null)\r\n    return false;\r\n\r\nbefore line 146 should do the trick.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-16T15:03:49.617+0000","updated":"2009-12-16T15:03:49.617+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12791394","id":"12791394","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"Are you sure we don't gossip state for down nodes to new cluster members?  If we don't, the token ranges will be wrong, which is a bigger problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-16T15:07:34.584+0000","updated":"2009-12-16T15:07:34.584+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12791400","id":"12791400","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"Gossip SYN only includes digests for live endpoints. \r\n\r\nYou're right, this would indeed cause wrong ranges on new nodes that have not seen the dead node when it was still alive. Write would still go to the right node, but it would lack HINT flag.\r\n\r\nSimply gossiping state about all nodes (dead or alive) would solve this problem, but have to have another look tomorrow morning if it would cause any side effects with failuredetector on the new node (might momentarily consider the dead node to be alive, although this would probably not be a problem at all).\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-16T15:24:16.546+0000","updated":"2009-12-16T15:24:16.546+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12791893","id":"12791893","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"The way node's alive/dead status gets determined currently is as follows:\r\n\r\n1st time there is gossip about certain node:\r\n- add new node to endpoint state and mark it alive (onAlive will be called)\r\n- call onJoin\r\n\r\n2nd and subsequent gossip about this node\r\n- notify failuredetector whenever there is gossip about this endpoint -> failuredetector starts to monitor this node and set node's status dead if needed (it will not set it to alive)\r\n- node is marked alive whenever there is gossip about it\r\n\r\nThe important things here are: (1) node is assumed to be alive when 1st info about it arrives and (2) failuredetector does not know anything about the node before 2nd gossip. That means we cannot simply start gossiping info about dead nodes, as their status would remain \"alive\" forever (that is, until the dead node comes online and activates failure detector)\r\n\r\nProposed fix (patch attached):\r\n\r\n1st time gossip:\r\n- add new node to endpoint state, but set its status as dead\r\n- call onJoin (token metadata will be updated)\r\n\r\n2nd and subsequent gossips:\r\n- Unchanged. This 2nd gossip will trigger markAlive (and call onAlive) and activate failuredetector -> normal situation\r\n\r\nIn short: assume node to be dead unless otherwise proven by subsequent gossip. If the node is alive, it will be marked so within seconds. If it is dead, we have knowledge about its existence, but we consider it (correctly) to be dead.\r\n\r\nThere is a possibility of false \"alive\" interpretation, though: Cluster has nodes A, B and C. Suppose C has just gossiped to B and dies. At this time C's status in A is different (older) than in B. Now suppose at this instant node D enters the cluster and first gossips with A. In this case D will get the old gossip and only later the new one. This second newer gossip will cause C to be marked alive even though it is already dead. However, since second gossip will also activate failure detector, C will be correctly marked as dead in a few seconds, so this is probably OK (and anyway a very rare occurence).\r\n\r\nTwo open issues:\r\n- Now that we're gossiping about dead nodes as well, gossip digest continues to grow without boundary when nodes come and go. This information will never disappear as it will be propagated to new nodes no matter how old and obsolete it is. To counter this, we need some mechanism to (1) either remove dead node from endpointstateinfo or (2) at some point stop to gossip about it, or both.\r\n\r\nFor (1): when we get removetoken command, it is probably safe to remove the endpoint immediately (STATE_LEFT is broadcasted by different endpoint, so info about token removal will remain in the gossiper). Another thing we could do is to keep track of nodes that have left. If nothing is heard about it for some time, we could assume that it is gone for good and remove it from gossiper after giving its STATE_LEFT enough time to spread.\r\n\r\nFor (2): We could gossip info only about nodes in either liveEndpoints or unreachableEndpoints (as opposed to endPointStateMap). Nodes are removed from unreachableEndpoints after three days of silence, so this would discard old information from the gossiper. Side effect would of course be that a node that is down more than three days but comes back later, might miss some of its data (new nodes that booted after the three day period would know nothing about this node).\r\n\r\n(Attached patch should work as such, but does not take into account these last two issues)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-17T12:00:31.291+0000","updated":"2009-12-17T12:00:31.291+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12792520","id":"12792520","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"committed to 0.5 and trunk.\r\n\r\nCreated CASSANDRA-644 for the gossip membership problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-18T16:19:44.587+0000","updated":"2009-12-18T16:19:44.587+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12792972","id":"12792972","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"body":"Does this patch address the NullException? I tried latest from branch 05 and am still seeing this exception.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"created":"2009-12-20T08:23:11.669+0000","updated":"2009-12-20T08:23:11.669+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12793134","id":"12793134","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"It was supposed to solve it, but obviously it did not fully do so.\r\n\r\nProblem in your case might be because hinted handoff data is persistent and gossiper data is not. Suppose there are nodes A and B. Suppose B goes down and A stores hinted data for it. Later A is restarted -> A still has hinted data for B, but after restart its gossiper knows nothing about B. It does not help even if we gossip about dead nodes, as nobody has ever heard of B. If B is gone forever, A can never get rid of hinted data.\r\n\r\nDon't know what would be the best thing to do here. removetoken command could make efforts to redirect hints to new destination in case a hinted target is removed. However, if the endpoint has been lost from gossip/tokenmetadata, then there is nothing it can do as it does not know who the endpoint was. Another option would be to add manual command to redirect hinted data.\r\n\r\nOther options?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-21T09:53:51.387+0000","updated":"2009-12-21T09:53:51.387+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12793244","id":"12793244","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"IMO we should just drop the HH data with a warning (in case ops does intend to bring the dead node back).  In almost all cases, if a node is down that long it is going to be replaced entirely, and the replacement will bootstrap and not need the old HH data.\r\n\r\nSince you should repair after bringing a dead node online anyway (b/c there is a window before the FD is aware that we should start doing HH), HH is just an optimization and this is OK.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-21T16:06:43.467+0000","updated":"2009-12-21T16:06:43.467+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12793259","id":"12793259","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"discard hints for nodes that are no longer part of the gossip network","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-21T16:47:56.787+0000","updated":"2009-12-21T16:47:56.787+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12793444","id":"12793444","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"If dropping HH data is OK, then this patch looks good to me.\r\n\r\nOne small thing: After a node starts, it will take some time before it knows about all cluster nodes. During this time if there is a request to deliver hints (not possible?), HH data will be discarded just because the node does not know about the other endpoint yet.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-22T00:49:48.431+0000","updated":"2009-12-22T00:49:48.431+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12793470","id":"12793470","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"hint delivery is attempted when a node is signaled to be up, or every 1h (starting after a 1h delay), so this seems OK.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-22T02:25:57.526+0000","updated":"2009-12-22T02:25:57.526+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12793939","id":"12793939","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"body":"can you rebase this on 05? i am fixing it manually, strange it complained you just added a comment to INTERVAL_IN_MS.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"created":"2009-12-23T05:55:28.476+0000","updated":"2009-12-23T05:55:28.476+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12794177","id":"12794177","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"body":"+1 no more exceptions and I am seeing HH being disregarded for the node we removed now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lenn0x","name":"lenn0x","emailAddress":"cg at chrisgoffinet dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Goffinet","active":true},"created":"2009-12-23T19:25:09.294+0000","updated":"2009-12-23T19:25:09.294+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12443423/comment/12794188","id":"12794188","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"committed to 0.5 and trunk","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-23T19:44:13.871+0000","updated":"2009-12-23T19:44:13.871+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-634/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0g053:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12651953","self":"https://issues.apache.org/jira/rest/api/latest/issue/12651953","key":"LUCENE-5048","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310110","id":"12310110","key":"LUCENE","name":"Lucene - Core","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310110&avatarId=10061","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310110&avatarId=10061","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310110&avatarId=10061","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310110&avatarId=10061"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324323","id":"12324323","description":"Major release after 4.3","name":"4.4","archived":false,"released":true,"releaseDate":"2013-07-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321663","id":"12321663","description":"Current trunk","name":"Trunk","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2013-06-09 21:32:42.764","customfield_12312323":null,"customfield_12310420":"332277","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_77355061_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2013-06-10T18:54:10.002+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-5048/watchers","watchCount":3,"isWatching":false},"created":"2013-06-09T21:24:54.969+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323899","id":"12323899","description":"Major release after 4.1","name":"4.2","archived":false,"released":true,"releaseDate":"2013-03-11"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324143","id":"12324143","description":"Major release after 4.2","name":"4.3","archived":false,"released":true,"releaseDate":"2013-05-05"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-07-23T18:37:09.025+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12314601","id":"12314601","name":"modules/facet","description":"Faceted Indexing & Search module"}],"timeoriginalestimate":null,"description":"I have a Server/Client software that I have created which has a server process that accepts connections from clients that transmit data about local connection information. This data is than buffered and a ThreadPoolExecutor runs to take the data and put it into a lucene index as well as a facet index. This works perfect for the lucene index, but the facet index randomly generates a NegativeArraySizeException. I cannot find any reason why the exception would be caused because lines with the same type of data do not throw it, then all of a sudden the exception is thrown, typically 4 of them in a row. I talked with mikemccand on IRC and he requested I submit this issue.\r\n\r\nAfter some discussion, he seems to think it's because some of the values I am using are rather large.\r\n\r\nHere is the exception...\r\njava.lang.NegativeArraySizeException\r\n        at java.lang.AbstractStringBuilder.<init>(AbstractStringBuilder.java:64)\r\n        at java.lang.StringBuilder.<init>(StringBuilder.java:97)\r\n        at org.apache.lucene.facet.taxonomy.writercache.cl2o.CharBlockArray.subSequence(CharBlockArray.java:164)\r\n        at org.apache.lucene.facet.taxonomy.writercache.cl2o.CategoryPathUtils.hashCodeOfSerialized(CategoryPathUtils.java:50)\r\n        at org.apache.lucene.facet.taxonomy.writercache.cl2o.CompactLabelToOrdinal.stringHashCode(CompactLabelToOrdinal.java:294)\r\n        at org.apache.lucene.facet.taxonomy.writercache.cl2o.CompactLabelToOrdinal.grow(CompactLabelToOrdinal.java:184)\r\n        at org.apache.lucene.facet.taxonomy.writercache.cl2o.CompactLabelToOrdinal.addLabel(CompactLabelToOrdinal.java:116)\r\n        at org.apache.lucene.facet.taxonomy.writercache.cl2o.Cl2oTaxonomyWriterCache.put(Cl2oTaxonomyWriterCache.java:84)\r\n        at org.apache.lucene.facet.taxonomy.directory.DirectoryTaxonomyWriter.addToCache(DirectoryTaxonomyWriter.java:592)\r\n        at org.apache.lucene.facet.taxonomy.directory.DirectoryTaxonomyWriter.addCategoryDocument(DirectoryTaxonomyWriter.java:551)\r\n        at org.apache.lucene.facet.taxonomy.directory.DirectoryTaxonomyWriter.internalAddCategory(DirectoryTaxonomyWriter.java:501)\r\n        at org.apache.lucene.facet.taxonomy.directory.DirectoryTaxonomyWriter.internalAddCategory(DirectoryTaxonomyWriter.java:494)\r\n        at org.apache.lucene.facet.taxonomy.directory.DirectoryTaxonomyWriter.addCategory(DirectoryTaxonomyWriter.java:468)\r\n        at org.apache.lucene.facet.index.FacetFields.addFields(FacetFields.java:175)\r\n        at net.domain.NetstatIndexer.IndexJob.run(IndexJob.java:73)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\r\n        at java.lang.Thread.run(Thread.java:722)\r\n\r\nHere is an example data entry which appears when the exception occurs...\r\nLocation: nj\r\nLocalIP: 10.1.200.187\r\nRemoteIP: 41.161.197.166\r\nLocalPorts: [443]\r\nConnections: 1\r\nTimes: [120]\r\nTimestamp: 2013-06-09T12:51:00.000-07:00\r\nStates: [\"Established\"]\r\n\r\nAnd here is the the code stripped down to provide an example of how I am handling the facet/doc code.\r\n \r\ndoc.add(new TextField(\"Location\", ehost[0], Field.Store.YES));\r\ncats.add(new CategoryPath(\"Location\", doc.get(\"Location\")));\r\ndoc.add(new TextField(\"LocalIP\", (String) stat.get(\"LocalIP\"), Field.Store.YES));\r\ncats.add(new CategoryPath(\"LocalIP\", doc.get(\"LocalIP\")));\r\ndoc.add(new TextField(\"RemoteIP\", (String) stat.get(\"RemoteIP\"), Field.Store.YES));\r\ncats.add(new CategoryPath(\"RemoteIP\", doc.get(\"RemoteIP\")));\r\ndoc.add(new TextField(\"LocalPorts\", StringUtils.join(stat.get(\"LocalPorts\"), \",\"), Field.Store.YES));\r\ncats.add(new CategoryPath(\"LocalPorts\", doc.get(\"LocalPorts\")));\r\ndoc.add(new TextField(\"RemotePorts\", StringUtils.join(stat.get(\"RemotePorts\"), \",\"), Field.Store.YES));\r\ncats.add(new CategoryPath(\"RemotePorts\", doc.get(\"RemotePorts\")));\r\ndoc.add(new LongField(\"Connections\", (Long) stat.get(\"Connections\"), Field.Store.YES));\r\ncats.add(new CategoryPath(\"Connections\", doc.get(\"Connections\")));\r\ndoc.add(new TextField(\"Times\", StringUtils.join(stat.get(\"Times\"), \",\"), Field.Store.YES));\r\ncats.add(new CategoryPath(\"Times\", doc.get(\"Times\")));\r\ndoc.add(new TextField(\"Timestamp\", (String) stat.get(\"Timestamp\"), Field.Store.YES));\r\ncats.add(new CategoryPath(\"Timestamp\", doc.get(\"Timestamp\")));\r\ndoc.add(new TextField(\"States\", StringUtils.join(stat.get(\"States\"), \",\"), Field.Store.YES));\r\ncats.add(new CategoryPath(\"States\", doc.get(\"States\")));\r\nSystem.out.println(\"Location: \"+doc.get(\"Location\")+\" LocalIP: \"+doc.get(\"LocalIP\")+\" RemoteIP: \"+doc.get(\"RemoteIP\")+\" LocalPorts: \"+doc.get(\"LocalPorts\")+\" Connections: \"+doc.get(\"Connections\")+\" Times: \"+doc.get(\"Times\")+\" Timestamp: \"+doc.get(\"Timestamp\")+\" States: \"+doc.get(\"States\"));\r\nif (cats.size()!=0) {\r\n        FacetFields ff = new FacetFields(Main.twriter);\r\n        ff.addFields(doc, cats); // <-- Exception occurs here randomly\r\n}","customfield_10010":null,"timetracking":{},"customfield_12310120":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10121","value":"New","id":"10121"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10120","value":"Patch Available","id":"10120"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"332606","summary":"NegativeArraySizeException caused by  ff.addFields","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=colton","name":"colton","emailAddress":"cjamieson at dosarrest dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Colton Jamieson","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=colton","name":"colton","emailAddress":"cjamieson at dosarrest dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Colton Jamieson","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Not sure if this is applicable, but it's Gentoo Linux with java 1.7 on a dual intel xeon lga2011 with supermicro server motherboard and 256GB of ram","customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":15,"total":15,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13679172","id":"13679172","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Here's a test showing the issue.\r\n\r\nWhat makes it tricky is it's not until CompactLabelToOrdinal goes to rehash that the previously successfully indexed too-large value causes the exception, even though the current doc being indexed is fine.\r\n\r\nThe problem is the casts to (short) in CategoryPathUtils, e.g.:\r\n\r\n{noformat}\r\n    int length = (short) charBlockArray.charAt(offset++);\r\n{noformat}\r\n\r\nI think those should be cast to (int) instead?  (Test passes if I fix all 3).  Does anyone know why they are using (short) now?\r\n\r\nBut, separately, indexing such immense (> 32 KB) facet labels really doesn't make much sense?  Ie, most likely it's an accident in the app ... I think somewhere \"higher up\" we should catch this and throw IllegalArgumentException.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2013-06-09T21:32:42.764+0000","updated":"2013-06-09T21:32:42.764+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13679193","id":"13679193","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=colton","name":"colton","emailAddress":"cjamieson at dosarrest dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Colton Jamieson","active":true},"body":"I modified my code so that it declared the categorypaths separately instead of as a string joined together, which makes sense to do anyway...\r\n\r\nJSONArray states = (JSONArray) stat.get(\"States\");\r\nfor (Object state : states) {\r\n\tcats.add(new CategoryPath(\"States\", (String) state));\r\n}\r\n\r\nSince doing this I have not see the issue, so it does appear Michael was correct, this was caused by having categorypaths with values to large. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=colton","name":"colton","emailAddress":"cjamieson at dosarrest dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Colton Jamieson","active":true},"created":"2013-06-09T22:05:45.635+0000","updated":"2013-06-09T22:05:45.635+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13679362","id":"13679362","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"body":"Good catch. The test doesn't always reproduce though, it repro with this seed: {{-Dtests.seed=5229F4C07527089D}}.\r\nI modified it to fail on even less categories, just had to initialize a Cl2oTaxoWriterCache with smaller initial capacity.\r\n\r\nAnyway, the problem is the cast to short. In Java, short (and int) are signed. So what happens is:\r\n* The test generates a random unicode string of length 32767, but its length() is 65534 which is 0xFFFE.\r\n* Cast that to short, you get -2.\r\n* Cast it to char, you get 0xFFFE (since char is the only primitive that's unsigned)\r\n* And of course casting to int is unnecessary.\r\n\r\nThe code serializes the length of each component in a char[], as a char. During serialization, it casts to char, since it appends it to a char[]. During deserialization, it wrongly casts to short (should cast to char, which you then get a warning on unnecessary cast). I guess this never showed up since nobody yet tried to index components of length 16K+ :).\r\n\r\nSo to fix this we indeed need to remove the cast to short. But also, there's a bigger bug here -- since the length is assumed to be less than 65536, if you index a very large category twice (or a substring of it), I think there will be an issue. So I added to test adding same category again, after re-hash, and voila, it was added again, with a different ordinal. Therefore I added a check in CategoryPath which prevents the creation of CPs with very large components (> 65535 chars). I'll post a modified patch soon.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"created":"2013-06-10T07:25:57.481+0000","updated":"2013-06-10T07:25:57.481+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13679363","id":"13679363","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"body":"Patch addresses the issues mentioned in the previous comment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"created":"2013-06-10T07:29:09.753+0000","updated":"2013-06-10T07:29:09.753+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13679429","id":"13679429","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"Thanks Shai!\r\n\r\nMaybe we should set the limit to match indexer's limit (slightly less than 32 KB I think)?  Both limits are insanely large .... I wonder if they should be much smaller e.g. 256 bytes.\r\n\r\nSecond, can you fix testHugeLabel to actually index exactly the max length label?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2013-06-10T11:01:43.574+0000","updated":"2013-06-10T11:01:43.574+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13679488","id":"13679488","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"body":"Thanks Mike. Patch indexes the facets, but has a troubling nocommit. If you run the test with -Dtests.seed=919CD019C8A94C60, it fails to DD on the term. I print the $facet terms and it's not there!\r\n\r\nI played with the length of the term (exhaustive binary search :)) and figured that if it's set to 10,920 (something) it passes but 10,921 (something) it fails. Tracked it down to TermsHashPerField which silently (!?) drops long terms (exceeding 32766 bytes).\r\n\r\nThe problem is, I don't know what limit is safe to use. Following the code, seems that 32766/4? The test passes with different seeds and different lengths... But that's not documented anywhere (not the limit, nor the silent dropping of terms), at least no documentation that I found.\r\n\r\nNow, notice how I wrote 10921 (something) above -- that's another trick _TestUtil.randomRealistic plays on me. Sometimes if you ask it to generate a 100 'length' string, the result String.length() says 100 and sometimes 200 :). I'll repro that and discuss separately.\r\n\r\nSo what's the best course of action? Expose the DWPT.MAX_TERM_LENGTH_UTF8 and then limit a CP component to X/4? But that doesn't solve the other problem, that a DD-term can still be silently dropped. So seems like we should limit a CP total encoded length (w/ the separator) to MAX/4? \r\n\r\nUnlike document content terms, I think it's bad if we silently drop DD terms. I prefer that we fail fast on that. We can do that in DrillDownStream - if the termAttribute.length is > MAX/4, refused to add that category?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"created":"2013-06-10T13:19:36.733+0000","updated":"2013-06-10T13:19:36.733+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13679497","id":"13679497","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"bq. We can do that in DrillDownStream - if the termAttribute.length is > MAX/4, refused to add that category?\r\n\r\n+1","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2013-06-10T13:33:36.287+0000","updated":"2013-06-10T13:33:36.287+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13679519","id":"13679519","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"body":"I added CP.MAX_CATEGORY_PATH_LENGTH = (BYTE_BLOCK_SIZE - 2) / 4 - so now you cannot create such a long CP at all (ctors verify that).\r\n\r\nI also added _TestUtil.randomSimpleString(r,min,max) and modified the test to use it instead of randomRealistic -- since we limit by characters, not codepoints, using randomRealisticUnicodeString sometimes failed on too large components, which is not what the test checks.\r\n\r\nI think now it's ready!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"created":"2013-06-10T14:08:09.487+0000","updated":"2013-06-10T14:08:09.487+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13679627","id":"13679627","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"body":"+1\r\n\r\nOne minor thing: you no longer have to check for \\u001f: randomSimpleString never returns that char.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikemccand","name":"mikemccand","emailAddress":"lucene at mikemccandless dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael McCandless","active":true},"created":"2013-06-10T17:03:18.370+0000","updated":"2013-06-10T17:03:18.370+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13679747","id":"13679747","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"body":"I agree. Technically it's even wrong to use that char specifically - if at all we should use the constant from FacetIndexingParams. But I'll remove.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"created":"2013-06-10T18:33:47.968+0000","updated":"2013-06-10T18:33:47.968+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13679758","id":"13679758","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=commit-tag-bot","name":"commit-tag-bot","emailAddress":"root-jira-commit_tag_bot at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=commit-tag-bot&avatarId=16176","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=commit-tag-bot&avatarId=16176","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=commit-tag-bot&avatarId=16176","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=commit-tag-bot&avatarId=16176"},"displayName":"Commit Tag Bot","active":true},"body":"[trunk commit] shaie\r\nhttp://svn.apache.org/viewvc?view=revision&revision=1491562\r\n\r\nLUCENE-5048: limit CategoryPath total length","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=commit-tag-bot","name":"commit-tag-bot","emailAddress":"root-jira-commit_tag_bot at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=commit-tag-bot&avatarId=16176","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=commit-tag-bot&avatarId=16176","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=commit-tag-bot&avatarId=16176","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=commit-tag-bot&avatarId=16176"},"displayName":"Commit Tag Bot","active":true},"created":"2013-06-10T18:41:16.837+0000","updated":"2013-06-10T18:41:16.837+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13679771","id":"13679771","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"body":"Committed to trunk and 4x. Thanks Colton for reporting!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"created":"2013-06-10T18:54:10.020+0000","updated":"2013-06-10T18:54:10.020+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13694540","id":"13694540","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=robau","name":"robau","emailAddress":"rob at audenaerde dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Audenaerde","active":true},"body":"Wow. Thanks :) I happened to trigger this bug yesterday, and found it very hard to reproduce.  (I do have a testset which triggers this bug in about 4 seconds; if it has value I'll attach it to this issue). ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=robau","name":"robau","emailAddress":"rob at audenaerde dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Audenaerde","active":true},"created":"2013-06-27T07:15:03.689+0000","updated":"2013-06-27T07:15:03.689+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13694541","id":"13694541","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"body":"Thanks Rob. The bug is already fixed (will be released in 4.4) and I was able to create a very short testcase (which adds only few categories) to reproduce it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shaie","name":"shaie","emailAddress":"serera at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shai Erera","active":true},"created":"2013-06-27T07:19:23.180+0000","updated":"2013-06-27T07:19:23.180+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651953/comment/13716763","id":"13716763","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"body":"Bulk close resolved 4.4 issues","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"created":"2013-07-23T18:37:09.022+0000","updated":"2013-07-23T18:37:09.022+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LUCENE-5048/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1lblb:"}}
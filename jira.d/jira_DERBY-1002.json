{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12329124","self":"https://issues.apache.org/jira/rest/api/latest/issue/12329124","key":"DERBY-1002","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-06-13 13:12:20.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22254","customfield_12310222":"1_*:*_1_*:*_10006657000_*|*_6_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-06-13T21:42:31.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1002/watchers","watchCount":0,"isWatching":false},"created":"2006-02-18T02:04:54.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"7.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-06-13T21:42:31.000+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11410","id":"11410","name":"Network Server"}],"timeoriginalestimate":null,"description":"Network server re-uses DRDAStatement and DRDAResultSet objects when client sends a request with same section number. When re-using DRDAStatement, it's close() method is called which inturn calls close() method of DRDAResultSet. For re-use to work properly, we have to ensure the states of these objects are reset. This is not a bug but it is an area for possible improvements like:\n\n* The reset of all states are not in the close() methods. The states get re-initialized at different places in the code. Fo example, in case of DRDAResultSet, they get initialized in some other DRDAStatement methods - like addResultSet, setRsDefaultOptions, setOPNQRYOptions, setQueryOptions etc. It will be good to have all resets in one method.\n* The method name \"close\" is confusing since it is also called when objects get re-used. For clarity, it may be good to have a method named reset(). And then have the close method call reset.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40644","summary":"Check that DRDAStatement and DRDAResultSet states are reset when they are re-used","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":14,"total":14,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329124/comment/12367537","id":"12367537","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"I had checked and thought the reset/re-initialization of DRDAStatement and DRDAResultSet states is happening correctly in the network server code. Hence I had marked this issue to be an improvement. I found I was wrong. Sorry about that.\r\n\r\nThings I had not understood correctly:\r\n\r\n1) DRDAStatement.rsClose() has this check: if (currentDrdaRs.getResultSet() == null) return;\r\nI had thought the condition will evaluate to true only when DRDAResultSet is constructed or after DRDAResultSet.close() has been called. So the DRDAResultSet would have been already reset whenever this condition is true. This is not correct.\r\n\r\n2) Fields like DRDAResultSet.qryclsimp get set only in OPNQRY path. However, writeQRYDTA method used for OPNQRY and EXCSQLSTT are same. Hence, in EXCSQLSTT path, it is possible for the query to use a left-over qryclsimp. Because of 1) above, if hasdata value is also not reset and is false, server will close a query wrongly (even when the query should not be closed implicitly and actually has more data). One possible error case is - A client  which expects a QRYDTA as reply to CNTQRY may get a QRYNOPRM from the server.\r\n\r\nIn short, this part of network server code is not correct and is causing bugs which are easy to repro with my patch for DERBY-210 but also occur with the current trunk. This issue blocks DERBY-210.\r\n\r\nI have a repro for a bug against the trunk which I will upload shortly with some more context.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-02-24T02:13:22.000+0000","updated":"2006-02-24T02:13:22.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329124/comment/12367564","id":"12367564","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Attaching  a repro 'derby1002.java' which shows how queries can get closed on the server unexpectedly which leads to protocol exception. To run the repro:\r\n\r\n1. Start network server on port 2222.\r\n2. Run the command: java derby1002\r\n3. Output should be:\r\n\r\n******************************************\r\ntestImplicitClose\r\n******************************************\r\nFAILED (no exception thrown)\r\n\r\n******************************************\r\njira491Test\r\n******************************************\r\nJIRA-491 FAILURE:\r\nClient sends CNTQRY and expects QRYDTA. Server sends QRYNOPRM because the query has been implicitly\r\nclosed\r\nCaught Exception:\r\njava.sql.SQLException: Execution failed due to a distribution protocol error that caused deallocatio\r\nn of the conversation.  The identified cursor is not open.\r\n        at org.apache.derby.client.am.SqlException.getSQLException(SqlException.java:285)\r\n        at org.apache.derby.client.am.ResultSet.next(ResultSet.java:269)\r\n        at derby1002.jira491Test(derby1002.java:123)\r\n        at derby1002.main(derby1002.java:26)\r\nCaused by: org.apache.derby.client.am.DisconnectException: Execution failed due to a distribution pr\r\notocol error that caused deallocation of the conversation.  The identified cursor is not open.\r\n        at org.apache.derby.client.net.NetResultSetReply.parseQRYNOPRM(NetResultSetReply.java:331)\r\n        at org.apache.derby.client.net.NetResultSetReply.parseFetchError(NetResultSetReply.java:226)\r\n\r\n        at org.apache.derby.client.net.NetResultSetReply.parseCNTQRYreply(NetResultSetReply.java:177\r\n)\r\n        at org.apache.derby.client.net.NetResultSetReply.readFetch(NetResultSetReply.java:38)\r\n        at org.apache.derby.client.net.ResultSetReply.readFetch(ResultSetReply.java:40)\r\n        at org.apache.derby.client.net.NetResultSet.readFetch_(NetResultSet.java:181)\r\n        at org.apache.derby.client.am.ResultSet.flowFetch(ResultSet.java:4034)\r\n        at org.apache.derby.client.net.NetCursor.completeSplitRow(NetCursor.java:1057)\r\n        at org.apache.derby.client.net.NetCursor.skipFdocaBytes(NetCursor.java:537)\r\n        at org.apache.derby.client.net.NetCursor.calculateColumnOffsetsForRow_(NetCursor.java:251)\r\n        at org.apache.derby.client.am.Cursor.stepNext(Cursor.java:172)\r\n        at org.apache.derby.client.am.Cursor.next(Cursor.java:185)\r\n        at org.apache.derby.client.am.ResultSet.nextX(ResultSet.java:293)\r\n        at org.apache.derby.client.am.ResultSet.next(ResultSet.java:260)\r\n        ... 2 more\r\n\r\nI have taken parts of tests for jira 821 and jira 491 from lang/procedure.java to create the repro.\r\n\r\n--------------------------------------------------------\r\nContext:\r\n--------------------------------------------------------\r\nAfter Kathey suggested to separate out finalizer changes in DERBY-210, I updated my workpace and I was running derbynetclientmats suite in a loop with my patches. I was seeing a new intermittent failure in lang/procedure.java, which was not there last week. The failure was related to implicit closing of result sets and hence seeing it this week. Here are the two failures I see on repeated runs of this test with my patches. Sometimes I get either one of these failures or none: \r\n\r\n1) Failure in testImplicitClose(). This tests to see that the resultsets opened by EXCSQLSTT do not get implicitly closed. However, implicit close happens because stmt.hasdata() is evaluating to false at the end of writeQRYDTA. And the result set's qryclsimp value is also left over from a previous OPNQRY.\r\n\r\n942 del\r\n< testImplicitClose(): PASSED\r\n942 add\r\n> testImplicitClose(): FAILED (no exception thrown)\r\nTest Failed.\r\n\r\n2) In this failure also, implicit close happens because stmt.hasdata() is evaluating to false at the end of writeQRYDTA\r\n\r\n*** Start: procedure jdk1.5.0_02 DerbyNetClient 2006-02-21 23:36:42 ***\r\n940 del\r\n< JIRA-491 Successful.\r\n941 del\r\n< JIRA-492 successful -- no hang!\r\n942 del\r\n< testImplicitClose(): PASSED\r\n942 add\r\n> JIRA-491 FAILURE: Caught Exception:\r\n> java.sql.SQLException: Execution failed due to a distribution protocol error that caused deallocation of the conversation.  The identified cursor is not open.\r\n> Caused by: org.apache.derby.client.am.DisconnectException: Execution failed due to a distribution protocol error that caused deallocation of the conversation.  The identified cursor is not open.\r\n> \t... 3 more\r\n> JIRA-492: FAILURE in data setup:\r\n> java.sql.SQLException: Invalid operation: statement closed\r\n> Caused by: org.apache.derby.client.am.SqlException: Invalid operation: statement closed\r\n> \t... 3 more\r\n> JIRA-492: FAILURE in procedure creation:\r\n> java.sql.SQLException: Invalid operation: statement closed\r\n> Caused by: org.apache.derby.client.am.SqlException: Invalid operation: statement closed\r\n> \t... 3 more\r\n> ERROR (no SQLState): invalid operation: connection closed\r\n> java.sql.SQLException: invalid operation: connection closed\r\n> Caused by: org.apache.derby.client.am.SqlException: invalid operation: connection closed\r\n> \t... 3 more\r\nTest Failed.\r\n\r\nOn looking at these, I found there could still be problems in the network server code where DRDAStatement and DRDAResultSet get re-used. Also, it seemed to me these failures are not related to my patch and should happen without my patch. I was able to create a repro using parts of the procedure test and creating/closing statements at right time to provoke this bug without my patch. \r\n\r\n--------------------------------------------------------\r\nDetails of what repro does:\r\n--------------------------------------------------------\r\n1) Run a select statement so that OPNQRY will be sent to server and qryclsimp will be set to CodePoint.QRYCLSIMP_YES\r\n2) Close the above statement so that network server will re-use its DRDAStatement for the next statement.\r\n3) Create a callabale statement and execute a procedure and get all data so that hasdata for the DRDAResultSet will be false.\r\n4) Close the above statement so that network server will re-use its DRDAStatement for the next statement.\r\n5a) Run testImplicitClose() from procedure test. This test checks that result sets do not get implicitly closed when using EXCSQLSTT. But this will fail since the DRDAResultSet has wrong states and the 'writeQRYDTA' method used by OPNQRYRM and EXCSQLSTT commands is the same.\r\n5b) Run the test for jira 491. The QRYDTA will be split and hence hasdata must be true at the time of sending first QRYDTA. However, hasdata evaluates to false and hence server closes the result set. Client sends CNTQRY to get the next QRYDTA. Since server has closed the query, it sends back QRYNOPRM which causes a protocol exception.\r\n\r\n--------------------------------------------------------\r\nSummary:\r\n--------------------------------------------------------\r\nNetwork server code should be changed and reviewed thoroughly to see that the re-use of objects happens correctly. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-02-24T04:01:38.000+0000","updated":"2006-02-24T04:01:38.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329124/comment/12367753","id":"12367753","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Attaching a draft patch 'derby1002-patch1-draft1.diff'. This patch is only for review.\r\n\r\nSummary of patch: \r\n* Adds reset() methods to DRDAStatement and DRDAResultSet objects. The purpose of reset method is to reset  the states of all variables so that the objects can be re-used and will not have left-over states. \r\n\r\n* In case of DRDAStatement, the following variables are not reset:\r\n+     * 1. database - This variable gets initialized in the constructor and by\r\n+     * call to setDatabase.\r\n+     * 2. members which get initialized in setPkgnamcsn (pkgnamcsn, pkgcnstkn, \r\n+     * pkgid, pkgsn, isolationLevel, cursorName). pkgnamcsn is the key used to \r\n+     * find if the DRDAStatement can be re-used. Hence its value will not change \r\n+     * when the object is re-used.\r\n\r\n* close() methods are changed to only close and dereference objects. \r\n\r\n* DRDAStatement.rsClose() method is not used in close() or reset(). This method has some checks which were causing the method to return without resetting currentDrdaRs. Now, close() calls currentDrdaRs.close() and reset() calls currentDrdaRs.reset().\r\n\r\n* In Database.newDrdaStatement, close() method is called followed by reset() when the server finds the statement can be re-used.\r\n\r\nInitially, I was thinking reset should also call close methods for the jdbc objects instead of just resetting them to null so that the jdbc objects get cleaned up properly if just reset() is called. Any comments on how it is done now? I was also thinking about calling reset at places where DRDAStatement.initialize is currently called to re-use default statements. On looking more into the code, I find default statements are different in the way they get initialized and used. e.g: stmt variable used in default statement is created only once in Database.makeConnection. I have to see the usage of default statements to see what exactly it means to re-initialize them. \r\n\r\nThere are some TODO items identified in discussion with Knut and Kathey in the following mail thread: \r\nhttp://www.nabble.com/-DRDA-Question-about-DRDAStatement.initialize%28%29-method-t1177861.html\r\n\r\nTODOs:\r\n* Add the repro to test suite.\r\n* pkgcnstkn, pkgid, pkgsn variables can be removed from DRDAStatement since these are derived from pkgnamcsn object.\r\n* Look into what is required by initialize() of default statement. Currently, initialize just calls setTypDefValues().\r\n\r\nI ran my repro with this patch. derbyall is not complete. I will update with results of test run later. Please take a look at this patch. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-02-25T10:40:24.000+0000","updated":"2006-02-25T10:40:24.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329124/comment/12367841","id":"12367841","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Attaching 'derby1002-patch1-v1.diff'. No changes from the draft patch. Ran derbyall with the patch (3 failures also seen in nightlies). I have also run derbynetclientmats 10 times in a loop with my patch for derby-210 since the problem was found there. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-02-27T02:41:12.000+0000","updated":"2006-02-27T02:41:12.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329124/comment/12367843","id":"12367843","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Attaching a patch for the test 'derby1002-patch2-v1.diff'. This patch adds the test in the repro to lang/procedure.java. This patch has to be committed only after patch1 is reviewed and committed. \r\n\r\nThe addtion to the test is a method which creates and uses statements in such a way as to provoke re-use of statements and result sets on network server. Before pacth1, re-use happens incorrectly and this causes the server to close queries wrongly. Without patch1, lang/procedure.java fails with DerbyNetClient framework. With patch1, lang/procedure.java passes with all three frameworks. Tests run with Sun JDK1.4.2 on Windows XP. \r\n\r\nPlease look at patch1 and patch2. \r\n\r\nNOTE: Patch2 can be committed only after patch1 has been reviewed and committed","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-02-27T02:58:20.000+0000","updated":"2006-02-27T02:58:20.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329124/comment/12368008","id":"12368008","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Attaching 'derby1002-patch2-v2.diff' for Bryans' comments in the following derby-dev mail:\r\nhttp://www.nabble.com/Re%3A-jira-Updated%3A-%28DERBY-1002%29-Check-that-DRDAStatement-and-DRDAResultSet-states-are-reset-when-they-are-re-used-p3135530.html\r\n\r\nThis patch modifies only one file: lang/procedure.java. With this patch, I have re-run lang/procedure.java. \r\n\r\nPlease take a look at following two patches - patch 1 contains code changes and patch 2 contains tests. These have to be committed together.\r\n\r\n------------------------------------------\r\n1. derby1002-patch1-v1\r\n------------------------------------------\r\n* Adds reset() methods to DRDAStatement and DRDAResultSet objects. The purpose of reset method is to reset the states of all variables so that the objects can be re-used and will not have left-over states.\r\n\r\n* In case of DRDAStatement, the following variables are not reset:\r\n+ * 1. database - This variable gets initialized in the constructor and by\r\n+ * call to setDatabase.\r\n+ * 2. members which get initialized in setPkgnamcsn (pkgnamcsn, pkgcnstkn,\r\n+ * pkgid, pkgsn, isolationLevel, cursorName). pkgnamcsn is the key used to\r\n+ * find if the DRDAStatement can be re-used. Hence its value will not change\r\n+ * when the object is re-used.\r\n\r\n* close() methods are changed to only close and dereference objects.\r\n\r\n* DRDAStatement.rsClose() method is not used in close() or reset(). This method has some checks which were causing the method to return without resetting currentDrdaRs. Now, close() calls currentDrdaRs.close() and reset() calls currentDrdaRs.reset().\r\n\r\n* In Database.newDrdaStatement, close() method is called followed by reset() when the server finds the statement can be re-used. \r\n\r\n------------------------------------------\r\n2. derby1002-patch2-v2\r\n------------------------------------------\r\nModifies test lang/procedure.java. Adds a method 'setupStatementReuse' which creates and uses statements in such a way as to provoke re-use of statements and result sets on network server. This method is called from tests for jira-491 and 'testImplicitClose'.\r\n\r\n------------------------------------------------------------------------------------\r\nRemaining TODOs for DERBY-1002\r\n------------------------------------------------------------------------------------\r\n* pkgcnstkn, pkgid, pkgsn variables can be removed from DRDAStatement since these are derived from pkgnamcsn object.\r\n* Look into what is required by initialize() of default statement. Currently, initialize just calls setTypDefValues(). Once the purpose of this method is confirmed, we may need to modify the comments at places it is currently called.\r\n\r\nNOTE: patch 1 contains code changes and patch 2 contains tests. These have to be committed together.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-02-28T03:44:32.000+0000","updated":"2006-02-28T03:44:32.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329124/comment/12370255","id":"12370255","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"There are two minor todo items for this issue. I am not working on them currently, hence unassigning myself.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-03-14T06:13:49.000+0000","updated":"2006-03-14T06:13:49.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329124/comment/12415173","id":"12415173","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Unchecking patch available check box as the patches submitted so far for this issue were committed. Also, this issue no longer blocks DERBY-210. I do not see a way how I can \"unlink\" these issues in JIRA.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-06-08T00:09:04.000+0000","updated":"2006-06-08T00:09:04.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329124/comment/12415175","id":"12415175","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Just after posting this, I found I can delete links by using \"Manage Links\". I have removed the links.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-06-08T00:20:33.000+0000","updated":"2006-06-08T00:20:33.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329124/comment/12415898","id":"12415898","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Patch 1 and 2 have been committed to trunk as well as 10.1 branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-06-13T02:14:09.000+0000","updated":"2006-06-13T02:14:09.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329124/comment/12415957","id":"12415957","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"body":"This has been partially fixed in 10.1.3. I'm thinking the right thing to do is mark it affects 10.1.3, then move the FixIn for the issue out to 10.1.4 and make a note of the partial fix in the release notes. Unless anyone has any objections, that's the course I'll take when putting together the release notes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"created":"2006-06-13T13:12:20.000+0000","updated":"2006-06-13T13:12:20.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329124/comment/12416012","id":"12416012","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Deepa said:\r\n| Patch 1 and 2 have been committed to trunk as well as 10.1 branch.\r\nAndrew said:\r\n| This has been partially fixed in 10.1.3. \r\n\r\nWhat hasn't gone to 10.1.x?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-06-13T20:07:32.000+0000","updated":"2006-06-13T20:07:32.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329124/comment/12416016","id":"12416016","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"The actual issue reported in this JIRA is fixed. There were some code cleanup TODOs as noted in previous comment:\r\n\r\n* pkgcnstkn, pkgid, pkgsn variables can be removed from DRDAStatement since these are derived from pkgnamcsn object.\r\n* Look into what is required by initialize() of default statement. Currently, initialize just calls setTypDefValues(). Once the purpose of this method is confirmed, we may need to modify the comments at places it is currently called.\r\n\r\nI had not resolved this issue in trunk or 10.1 because of these TODO items. To avoid confusion, I will mark this issue fixed and open a minor issue for code cleanup.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-06-13T20:45:08.000+0000","updated":"2006-06-13T20:45:08.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329124/comment/12416022","id":"12416022","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Resolved by svn revisions 381937 in trunk (10.2) and 408612 in 10.1 branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-06-13T21:42:31.000+0000","updated":"2006-06-13T21:42:31.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1002/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i07blb:"}}
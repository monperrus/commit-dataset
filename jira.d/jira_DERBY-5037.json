{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12498544","self":"https://issues.apache.org/jira/rest/api/latest/issue/12498544","key":"DERBY-5037","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316362","id":"12316362","description":"First release on the 10.8 branch","name":"10.8.1.2","archived":false,"released":true,"releaseDate":"2011-04-29"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2011-02-14 18:27:53.565","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24609","customfield_12310222":"1_*:*_1_*:*_1310674670_*|*_6_*:*_1_*:*_33839415264_*|*_5_*:*_2_*:*_14642276995_*|*_4_*:*_1_*:*_678875","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-09-12T23:20:04.601+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5037/watchers","watchCount":0,"isWatching":false},"created":"2011-02-14T15:55:58.806+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":["derby_backport_reject_10_5"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316362","id":"12316362","description":"First release on the 10.8 branch","name":"10.8.1.2","archived":false,"released":true,"releaseDate":"2011-04-29"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12337906","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12337906","type":{"id":"12310010","name":"Incorporates","inward":"is part of","outward":"incorporates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310010"},"inwardIssue":{"id":"12492660","key":"DERBY-4939","self":"https://issues.apache.org/jira/rest/api/2/issue/12492660","fields":{"summary":"Enable istat daemon and tests","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/subtask_alternate.png","name":"Sub-task","subtask":true}}}},{"id":"12337480","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12337480","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12498403","key":"DERBY-5026","self":"https://issues.apache.org/jira/rest/api/2/issue/12498403","fields":{"summary":"testStatsCreatedOnGrowthThenDeleteDb failing with ibm15 on trunk. The revision on trunk is 1069665 ","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12337481","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12337481","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12498427","key":"DERBY-5030","self":"https://issues.apache.org/jira/rest/api/2/issue/12498427","fields":{"summary":" \"index-stat-thread\" java.lang.NullPointerException at store.access.btree.ControlRow.getControlRowForPage in suites.All ","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12337482","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12337482","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12498432","key":"DERBY-5031","self":"https://issues.apache.org/jira/rest/api/2/issue/12498432","fields":{"summary":"Exception in thread \"index-stat-thread\" java.lang.NullPointerException while calling ControlRow.getControlRowForPage(Unknown Source)","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-06-14T17:31:13.331+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11413","id":"11413","name":"Test"}],"timeoriginalestimate":null,"description":"I see the following assertion failure on the console when running AutomaticIndexStatisticsTest standalone against debug jars. This may be related to DERBY-5026, DERBY-5030, and DERBY-5031. The test itself completes successfully:\r\n\r\n...Exception in thread \"index-stat-thread\" org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED No page at pagenumber: 1; ContainerHandle = BaseContainerHandle:(Container(0, 1153))\r\n\tat org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:162)\r\n\tat org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:147)\r\n\tat org.apache.derby.impl.store.access.btree.ControlRow.get(ControlRow.java:838)\r\n\tat org.apache.derby.impl.store.access.btree.ControlRow.get(ControlRow.java:820)\r\n\tat org.apache.derby.impl.store.access.btree.BTreeScan.reposition(BTreeScan.java:850)\r\n\tat org.apache.derby.impl.store.access.btree.BTreeForwardScan.fetchRows(BTreeForwardScan.java:109)\r\n\tat org.apache.derby.impl.store.access.btree.BTreeScan.fetchNextGroup(BTreeScan.java:1596)\r\n\tat org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl$KeyComparator.fetchRows(IndexStatisticsDaemonImpl.java:1103)\r\n\tat org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.updateIndexStatsMinion(IndexStatisticsDaemonImpl.java:453)\r\n\tat org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.generateStatistics(IndexStatisticsDaemonImpl.java:324)\r\n\tat org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.run(IndexStatisticsDaemonImpl.java:710)\r\n\tat java.lang.Thread.run(Thread.java:637)\r\n---------------\r\nStack traces for all live threads:\r\nThread name=derby.rawStoreDaemon id=13 priority=5 state=TIMED_WAITING isdaemon=true\r\n\tjava.lang.Object.wait(Native Method)\r\n\torg.apache.derby.impl.services.daemon.BasicDaemon.rest(BasicDaemon.java:576)\r\n\torg.apache.derby.impl.services.daemon.BasicDaemon.run(BasicDaemon.java:390)\r\n\tjava.lang.Thread.run(Thread.java:637)\r\n\r\nThread name=Finalizer id=3 priority=8 state=WAITING isdaemon=true\r\n\tjava.lang.Object.wait(Native Method)\r\n\tjava.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:118)\r\n\tjava.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:134)\r\n\tjava.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:159)\r\n\r\nThread name=Reference Handler id=2 priority=10 state=WAITING isdaemon=true\r\n\tjava.lang.Object.wait(Native Method)\r\n\tjava.lang.Object.wait(Object.java:485)\r\n\tjava.lang.ref.Reference$ReferenceHandler.run(Reference.java:116)\r\n\r\nThread name=main id=1 priority=5 state=RUNNABLE isdaemon=false\r\n\tjava.security.AccessController.doPrivileged(Native Method)\r\n\torg.apache.derby.impl.store.raw.data.BaseDataFileFactory.releaseJBMSLockOnDB(BaseDataFileFactory.java:2040)\r\n\torg.apache.derby.impl.store.raw.data.BaseDataFileFactory.stop(BaseDataFileFactory.java:519)\r\n\torg.apache.derby.impl.services.monitor.TopService.stop(TopService.java:442)\r\n\torg.apache.derby.impl.services.monitor.TopService.shutdown(TopService.java:393)\r\n\torg.apache.derby.impl.services.monitor.BaseMonitor.shutdown(BaseMonitor.java:229)\r\n\torg.apache.derby.impl.db.DatabaseContextImpl.cleanupOnError(DatabaseContextImpl.java:62)\r\n\torg.apache.derby.iapi.services.context.ContextManager.cleanupOnError(ContextManager.java:343)\r\n\torg.apache.derby.impl.jdbc.TransactionResourceImpl.cleanupOnError(TransactionResourceImpl.java:433)\r\n\torg.apache.derby.impl.jdbc.EmbedConnection.<init>(EmbedConnection.java:633)\r\n\torg.apache.derby.impl.jdbc.EmbedConnection30.<init>(EmbedConnection30.java:73)\r\n\torg.apache.derby.impl.jdbc.EmbedConnection40.<init>(EmbedConnection40.java:56)\r\n\torg.apache.derby.jdbc.Driver40.getNewEmbedConnection(Driver40.java:70)\r\n\torg.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:248)\r\n\torg.apache.derby.jdbc.EmbeddedDataSource.getConnection(EmbeddedDataSource.java:480)\r\n\torg.apache.derby.jdbc.EmbeddedDataSource.getConnection(EmbeddedDataSource.java:424)\r\n\torg.apache.derbyTesting.junit.JDBCDataSource.shutdownDatabase(JDBCDataSource.java:266)\r\n\torg.apache.derbyTesting.functionTests.tests.store.AutomaticIndexStatisticsTest.testShutdownWhileScanningThenDelete(AutomaticIndexStatisticsTest.java:180)\r\n\tsun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tsun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\r\n\tsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\r\n\tjava.lang.reflect.Method.invoke(Method.java:597)\r\n\tjunit.framework.TestCase.runTest(TestCase.java:164)\r\n\tjunit.framework.TestCase.runBare(TestCase.java:130)\r\n\torg.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:112)\r\n\tjunit.framework.TestResult$1.protect(TestResult.java:106)\r\n\tjunit.framework.TestResult.runProtected(TestResult.java:124)\r\n\tjunit.framework.TestResult.run(TestResult.java:109)\r\n\tjunit.framework.TestCase.run(TestCase.java:120)\r\n\tjunit.framework.TestSuite.runTest(TestSuite.java:230)\r\n\tjunit.framework.TestSuite.run(TestSuite.java:225)\r\n\tjunit.extensions.TestDecorator.basicRun(TestDecorator.java:24)\r\n\tjunit.extensions.TestSetup$1.protect(TestSetup.java:21)\r\n\tjunit.framework.TestResult.runProtected(TestResult.java:124)\r\n\tjunit.extensions.TestSetup.run(TestSetup.java:25)\r\n\torg.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\n\tjunit.extensions.TestDecorator.basicRun(TestDecorator.java:24)\r\n\tjunit.extensions.TestSetup$1.protect(TestSetup.java:21)\r\n\tjunit.framework.TestResult.runProtected(TestResult.java:124)\r\n\tjunit.extensions.TestSetup.run(TestSetup.java:25)\r\n\tjunit.textui.TestRunner.doRun(TestRunner.java:121)\r\n\tjunit.textui.TestRunner.start(TestRunner.java:185)\r\n\tjunit.textui.TestRunner.main(TestRunner.java:143)\r\n\r\nThread name=index-stat-thread id=18 priority=5 state=RUNNABLE isdaemon=true\r\n\tjava.lang.Thread.dumpThreads(Native Method)\r\n\tjava.lang.Thread.getAllStackTraces(Thread.java:1511)\r\n\torg.apache.derby.shared.common.sanity.ThreadDump.getStackDumpString(ThreadDump.java:34)\r\n\tsun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tsun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\r\n\tsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\r\n\tjava.lang.reflect.Method.invoke(Method.java:597)\r\n\torg.apache.derby.shared.common.sanity.AssertFailure$1.run(AssertFailure.java:165)\r\n\tjava.security.AccessController.doPrivileged(Native Method)\r\n\torg.apache.derby.shared.common.sanity.AssertFailure.dumpThreads(AssertFailure.java:159)\r\n\torg.apache.derby.shared.common.sanity.AssertFailure.<init>(AssertFailure.java:72)\r\n\torg.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:162)\r\n\torg.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:147)\r\n\torg.apache.derby.impl.store.access.btree.ControlRow.get(ControlRow.java:838)\r\n\torg.apache.derby.impl.store.access.btree.ControlRow.get(ControlRow.java:820)\r\n\torg.apache.derby.impl.store.access.btree.BTreeScan.reposition(BTreeScan.java:850)\r\n\torg.apache.derby.impl.store.access.btree.BTreeForwardScan.fetchRows(BTreeForwardScan.java:109)\r\n\torg.apache.derby.impl.store.access.btree.BTreeScan.fetchNextGroup(BTreeScan.java:1596)\r\n\torg.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl$KeyComparator.fetchRows(IndexStatisticsDaemonImpl.java:1103)\r\n\torg.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.updateIndexStatsMinion(IndexStatisticsDaemonImpl.java:453)\r\n\torg.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.generateStatistics(IndexStatisticsDaemonImpl.java:324)\r\n\torg.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.run(IndexStatisticsDaemonImpl.java:710)\r\n\tjava.lang.Thread.run(Thread.java:637)\r\n\r\nThread name=Signal Dispatcher id=5 priority=9 state=RUNNABLE isdaemon=true\r\n\r\nThread name=Timer-0 id=9 priority=5 state=WAITING isdaemon=true\r\n\tjava.lang.Object.wait(Native Method)\r\n\tjava.lang.Object.wait(Object.java:485)\r\n\tjava.util.TimerThread.mainLoop(Timer.java:483)\r\n\tjava.util.TimerThread.run(Timer.java:462)\r\n\r\n\r\n---------------\r\n\r\n....\r\nTime: 153.799\r\n\r\nOK (7 tests)","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"35447","summary":"Assertion failure from index-stat-thread when running AutomaticIndexStatisticsTest","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":21,"total":21,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12994363","id":"12994363","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"I have commented out all of the test cases in AutomaticIndexStatisticsTest except for testShutdownWhileScanningThenDelete(). The assertion still occurs with that test case left in.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-02-14T16:56:04.311+0000","updated":"2011-02-14T16:56:04.311+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12994408","id":"12994408","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"Looking at the stack traces this looks like a problem with the istat thread running while another thread is shutting down the database.  Looking at the stacks\r\nprinted the test is at line 180:\r\nJDBCDataSource.shutdownDatabase(ds);\r\n\r\nMeanwhile the background thread is likely just trying to process the queue for the next bit of work.  Derby monitor support for coordinated shutdown is a known issue, but I think at least for a very \"ordered\" shutdown where there is a request to shutdown we should be able to shutdown the known background thread\r\nin this case.  I think it is a bigger problem if the whole system is shutting down due to some error found at the lowest level.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-02-14T18:27:53.565+0000","updated":"2011-02-14T18:27:53.565+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12994409","id":"12994409","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"ps. kudo's to lily's work to get all the threads dumped on sanity error, made it very easy to see what was happening in this case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-02-14T18:29:22.332+0000","updated":"2011-02-14T18:29:22.332+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12994479","id":"12994479","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks to Mike for spotting that and to Lily for the instrumentation. Note that DataDictionary.stop() is supposed to shut down the the istat thread gracefully.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-02-14T20:42:57.556+0000","updated":"2011-02-14T20:42:57.556+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12994745","id":"12994745","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks to Erlend, who fixed DERBY-3618, you mean... ;)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-02-15T10:35:41.496+0000","updated":"2011-02-15T10:35:41.496+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12994845","id":"12994845","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-5037-01-aa-checkForShutdown.diff. This is a first attempt to fix this bug. I would like to hear your opinions.\r\n\r\nThe approach taken here is to assume that exceptions raised during database shutdown are meaningless and can be thrown away. That is, the istat thread now tries to ignore exceptions which are raised during database shutdown.\r\n\r\nThere is then the tricky bit of figuring out whether the database is being shutdown. I have found that it is not sufficient to check whether the istat thread itself has been marked for shutdown. Sometimes I see daemonStopped set to true (meaning that the DataDictionary has marked the thread for shutdown) and sometimes daemonStopped is still false when Store raises an exception.\r\n\r\nAs a backup, I am also checking the status of Database.isActive(). I am not sure this is the best global sign that the database is being shutdown. Please let me know if you think there is a better global flag. I have a hunch that TopService.inShutdown is a better global flag but I do not see how to get to it.\r\n\r\n\r\nTouches the following file:\r\n\r\nM      java/engine/org/apache/derby/impl/services/daemon/IndexStatisticsDaemonImpl.java\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-02-15T15:44:14.780+0000","updated":"2011-02-15T16:28:09.164+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12994869","id":"12994869","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Rick said: \"The approach taken here is to assume that exceptions raised during database shutdown are meaningless and can be thrown away.\"\r\n\r\nI  can recall cases where errors in shutdown were important to diagnosing user problems, so would prefer we not introduce a blanket assumption like that.  If possible,  I think it would be good for the shutdown process to do an orderly shutdown of the istat daemon if  is running before shutdown.\r\n\r\nPardon if this this an ignorant approach. I am not familiar with the istat implementation, but just know that general error suppression  can be problematic.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-02-15T16:36:06.798+0000","updated":"2011-02-15T16:36:06.798+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12994880","id":"12994880","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"It sounds reasonable to me that the istat daemon simply ignores any exceptions if the database is being shut down under its feet. However, I think the patch also ignores exceptions when statistics are updated explicitly (e.g., by using ALTER TABLE or SYSCS_UPDATE_STATISTICS) because of the changes in runExplicitly(). We should probably continue raising exceptions if these explicit calls fail during shutdown.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-02-15T17:04:17.727+0000","updated":"2011-02-15T17:05:23.753+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12994905","id":"12994905","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I have not looked at patch yet.\r\n\r\nIn keeping with trying to have as much zero admin as possible I am ok with the istat deamon handling it's own errors and not making those errors affect the rest of the server.  It's job is to work in background and OPTIONALLY complete units of work.  Because the\r\nwork it does is optional, it is in a unique situation for error handling and should take advantage of it - basically it can catch everything\r\nclean up its resources move on.  If it gets an error\r\ndoing a piece of work it should catch it and try to figure out what to do.  Maybe it throws it away, maybe it retries it.   Deciding to throw away the unit of work when it detects that a shutdown is in progress is reasonable to me.   As I understand the\r\ncurrent design it is well suited to throwing away the unit of work, because it has a way to pick it up again the next time a query is run.   I think a good design would be that it's errors do not affect user threads in any way.  Once it throws away a unit of work and see's that\r\nshutdown is in progress it should just shutdown.\r\n\r\nFor some sorts of database shutdown this \"bottom-up\" shutdown may be the only way it will work.   For example when store gets\r\na serious problem while logging, it raises a database shutdown level error and for safety basically nulls out the ability to do i/o to \r\nthe log or the database.  This results in the kind of errors that the istat daemon is seeing.\r\n\r\nFor an orderly shutdown on the database, should the system wait for istat daemon to complete it's current unit of work?  If so it \r\nseems like it should be possible to make the system wait for istat daemon to shutdown, but I am not sure how easy that would be.\r\n\r\nThere may be some value to logging information about failures in the background istat thread to derby.log, but i don't think by default\r\nit should be enabled.  I guess the worst case is if there is some bug causing the istat daemon to always fail it's unit of work.  I know there\r\nis already some toggle for istat logging, so maybe it's error logging could be tied to this somehow. \r\n\r\nThis is a similar methodology done for background processing done in store using the monitor provided background daemon thread.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-02-15T18:04:10.502+0000","updated":"2011-02-15T18:04:10.502+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12994946","id":"12994946","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks to Kathey, Knut, and Mike for the quick feedback. Tests passed cleanly on the first rev of the patch. Attaching derby-5037-01-ab-checkForShutdown.diff. This second rev addresses Knut's concern that the user is entitled to an error if database shutdown aborts an ALTER TABLE statement or an explicit attempt to recompute statistics.\r\n\r\nConcerning Kathey's comment: As I read the code, the orderly shutdown of the istat thread will happen regardless of whether the shutdown-induced exception is thrown away. I think that the system will wait for the DataDictionary to shutdown and DataDictionary shutdown will, in turn, wait for the istat stop() logic to finish. \r\n\r\nConcerning Mike's comments: I don't think that there is much value in trying to coax istat into finishing the current unit of work if the rest of the system is shutting down. The worst that can happen is that the current unit of work will be rolled back. For this particular problem, I think that's what the exiting Store has already done and there is no point in trying to ask Store to do anything else. Rolling back the current unit of work is pretty much equivalent to what will happen to the other queued up units of work during orderly shutdown: they will simply be thrown away. I recommend against prolonging or complicating the shutdown.\r\n\r\nThere might be some value in adding trace logic around the exception-swallowing but I'm not sure how to filter the signal out of the noise here.\r\n\r\nThanks,\r\n-Rick\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-02-15T19:29:44.465+0000","updated":"2011-02-15T19:29:44.465+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12994995","id":"12994995","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Tests passed cleanly for me on derby-5037-01-ab-checkForShutdown.diff except for some variation of the istat-related instability in updatelocksJDBC30 tracked by DERBY-5038 and DERBY-5039:\r\n\r\n********* Diff file derbyall/encryptionAll/storemats/storemats/updatelocksJDBC30.diff\r\n*** Start: updatelocksJDBC30 jdk1.5.0_22 storemats:storemats 2011-02-15 11:10:10 ***\r\n2504,2513d2503\r\n< APP     |UserTran|TABLE   |1   |IX  |A           |Tablelock |GRANT|ACTIVE  \r\n< ij> next scan_cursor;\r\n< A          |B          |C                                                                                                                               \r\n< --------------------------------------------------------------------------------------------------------------------------------------------------------\r\n< 3          |-30        |-three                                                                                                                          \r\n< ij> update a set b=30,c='three' where current of scan_cursor;\r\n< 1 row inserted/updated/deleted\r\n< ij> select * from lock_table order by tabname, type desc, mode, cnt, lockname;\r\n< USERNAME|TRANTYPE|TYPE    |CNT |MODE|TABNAME     |LOCKNAME  |STATE|STATUS  \r\n< ---------------------------------------------------------------------------\r\n2514a2505,2514\r\n> ij> next scan_cursor;\r\n> A          |B          |C                                                                                                                               \r\n> --------------------------------------------------------------------------------------------------------------------------------------------------------\r\n> 3          |-30        |-three                                                                                                                          \r\n> ij> update a set b=30,c='three' where current of scan_cursor;\r\n> 1 row inserted/updated/deleted\r\n> ij> select * from lock_table order by tabname, type desc, mode, cnt, lockname;\r\n> USERNAME|TRANTYPE|TYPE    |CNT |MODE|TABNAME     |LOCKNAME  |STATE|STATUS  \r\n> ---------------------------------------------------------------------------\r\n> APP     |UserTran|TABLE   |3   |IX  |A           |Tablelock |GRANT|ACTIVE  \r\n2524 del\r\n< APP     |UserTran|TABLE   |2   |IX  |A           |Tablelock |GRANT|ACTIVE  \r\n2524a2524\r\n> APP     |UserTran|TABLE   |3   |IX  |A           |Tablelock |GRANT|ACTIVE  \r\n2531 del\r\n< APP     |UserTran|TABLE   |2   |IX  |A           |Tablelock |GRANT|ACTIVE  \r\n2531a2531\r\n> APP     |UserTran|TABLE   |3   |IX  |A           |Tablelock |GRANT|ACTIVE  \r\nTest Failed.\r\n*** End:   updatelocksJDBC30 jdk1.5.0_22 storemats:storemats 2011-02-15 11:10:24 ***\r\n------------------------------------------------------\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-02-15T20:43:39.658+0000","updated":"2011-02-15T20:43:39.658+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12995001","id":"12995001","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for making the changes, Rick. I'm fine with that patch.\r\n\r\nOne small nit is that the comments in tryToGatherStats() seem to imply that StandardException can only be raised by non-debug jars and RuntimeException only by debug jars. I'm not sure that's necessarily correct. For example, in DERBY-5030 a NullPointerException is raised in this code when running with non-debug jars. I suppose the opposite could happen as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-02-15T20:56:30.480+0000","updated":"2011-02-15T20:56:30.480+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12995011","id":"12995011","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Attaching patch 2a.\r\n\r\nProviding my input as a patch I wrote when investigating this issue. I have not taken daemonStopped into consideration, as I don't know how it relates to db.isActive(). If the order in which they are set varies, the variable has to be considered too.\r\n\r\nNote also the debug code in the catch-block for RuntimeException, which should cause another RuntimeException to be thrown if DERBY-5030 is hit.\r\n\r\nI think Mike's comments/observations above agree pretty much with my thinking when writing the code. Seems there are several error-handling issues to iron out though...\r\nA few specific comments:\r\n o I decided to not make Derby wait for the background thread to finish on shutdown, as it might potentially be scanning a very large table.\r\n o Logging is rather verbose now during testing, but I agree it should be less verbose (or maybe turned off completely) when released.\r\n o I'm logging a lot of exceptions to aid testing/debugging. These should also go away, or be enabled by a property if the user wishes to do so.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-02-15T21:22:30.420+0000","updated":"2011-02-15T21:22:30.420+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12995069","id":"12995069","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Are the 376 failures on Win Vista 64 since istat was enabled the same thing as this issue?\r\nhttp://dbtg.foundry.sun.com/derby/test/Daily/jvm1.7/testing/testlog/vista-64/1069888-suitesAll_diff.txt\r\nMostly it complains that wombat already exists, but has happened consistently since revision 1069888.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-02-16T00:05:12.469+0000","updated":"2011-02-16T00:05:12.469+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12995151","id":"12995151","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lilywei","name":"lilywei","emailAddress":"lilywei at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lily Wei","active":true},"body":"Apply derby-5037-2a-alternative_patch.diff. On Windows 7, AutomaticIndexStatisticsTest failed on testShutdownWhileScanningThenDelete(line 181) on assertDirectoryDeleted(constructDbPath(db));\r\nThis is the stacktrace:\r\n[Error/failure logged at Tue Feb 15 19:54:25 PST 2011]\r\njunit.framework.AssertionFailedError: Failed to delete 3 files (root=c:\\derby2\\t\r\nrunk\\testtmp\\system\\singleUse\\copyShutdown: c:\\derby2\\trunk\\testtmp\\system\\singl\r\neUse\\copyShutdown\\seg0\\c481.dat (isDir=false, canRead=true, canWrite=true, size=\r\n22351872), c:\\derby2\\trunk\\testtmp\\system\\singleUse\\copyShutdown\\seg0 (isDir=tru\r\ne, canRead=true, canWrite=true, size=12288), c:\\derby2\\trunk\\testtmp\\system\\sing\r\nleUse\\copyShutdown (isDir=true, canRead=true, canWrite=true, size=4096)\r\n        at junit.framework.Assert.fail(Assert.java:47)\r\n        at org.apache.derbyTesting.junit.BaseJDBCTestCase.assertDirectoryDeleted\r\n(BaseJDBCTestCase.java:1496)\r\n        at org.apache.derbyTesting.functionTests.tests.store.AutomaticIndexStati\r\nsticsTest.testShutdownWhileScanningThenDelete(AutomaticIndexStatisticsTest.java:\r\n181)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.\r\njava:39)\r\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAcces\r\nsorImpl.java:25)\r\n        at java.lang.reflect.Method.invoke(Method.java:597)\r\n        at junit.framework.TestCase.runTest(TestCase.java:154)\r\n        at junit.framework.TestCase.runBare(TestCase.java:127)\r\n        at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:\r\n112)\r\n        Without study too much of the code, , should we put more sleep between \"JDBCDataSource.shutdownDatabase(ds); and assertDirectoryDeleted(constructDbPath(db));\"?\r\n\r\n        Will try derby-5037-01-ab-checkForShutdown.diff patch next?  Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lilywei","name":"lilywei","emailAddress":"lilywei at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lily Wei","active":true},"created":"2011-02-16T04:16:36.225+0000","updated":"2011-02-16T04:16:36.225+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12995258","id":"12995258","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"I've seen the delete error before too. If it is always c481.dat it would maybe be helpful to find out which conglomerate/table this is.\r\nI've also seen intermittent delete errors in other tests before the istat code was committed, so that may be a separate issue.\r\n\r\nLily, did you run the tests with a sane or an insane build?\r\nThe 2a patch will only help with sane builds, with insane builds you will still get DERBY-5030.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-02-16T11:32:43.044+0000","updated":"2011-02-16T11:32:43.044+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12995386","id":"12995386","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks for the continued analysis, everyone. Attaching derby-5037-01-ac-checkForShutdown.diff. This patch removes a comment line, hopefully addressing Knut's concerns about muddy wording. Committed at subversion revision 1071310.\r\n\r\nI have committed this patch in the interests of cleaning up the noise in the regression tests. Let's see if this does address DERBY-5030 also.\r\n\r\nNo doubt, additional work can be done in the area of error logging and exception swallowing. If people want to recommend other approaches, I recommend filing new JIRAs to track those efforts.\r\n\r\nThanks,\r\n-Rick\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-02-16T16:59:13.619+0000","updated":"2011-02-16T16:59:13.619+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12995452","id":"12995452","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lilywei","name":"lilywei","emailAddress":"lilywei at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lily Wei","active":true},"body":"Thanks, Kristian and Rick. With with svn 1071319. I did not see DERBY-5030 (no delete problem from AutomaticIndexStatisticsTest). I still see it on the insane build for Windows 7.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lilywei","name":"lilywei","emailAddress":"lilywei at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lily Wei","active":true},"created":"2011-02-16T18:53:51.581+0000","updated":"2011-02-16T18:53:51.581+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/12996599","id":"12996599","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lilywei","name":"lilywei","emailAddress":"lilywei at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lily Wei","active":true},"body":"Thanks Rick for point out generateStatistics() no longer calls updateIndexStatsMinion() directly. This is delete problem stack trace I am seeing on Windows 7 (insane build)\r\n[Error/failure logged at Fri Feb 18 11:09:46 PST 2011]\r\njunit.framework.AssertionFailedError: Failed to delete 3 files (root=c:\\derby2\\t\r\nrunk\\testtmp\\system\\singleUse\\copyShutdown: c:\\derby2\\trunk\\testtmp\\system\\singl\r\neUse\\copyShutdown\\seg0\\c481.dat (isDir=false, canRead=true, canWrite=true, size=\r\n22351872), c:\\derby2\\trunk\\testtmp\\system\\singleUse\\copyShutdown\\seg0 (isDir=tru\r\ne, canRead=true, canWrite=true, size=12288), c:\\derby2\\trunk\\testtmp\\system\\sing\r\nleUse\\copyShutdown (isDir=true, canRead=true, canWrite=true, size=4096)\r\n        at junit.framework.Assert.fail(Assert.java:47)\r\n        at org.apache.derbyTesting.junit.BaseJDBCTestCase.assertDirectoryDeleted\r\n(BaseJDBCTestCase.java:1496)\r\n        at org.apache.derbyTesting.functionTests.tests.store.AutomaticIndexStati\r\nsticsTest.testShutdownWhileScanningThenDelete(AutomaticIndexStatisticsTest.java:\r\n188)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.\r\njava:39)\r\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAcces\r\nsorImpl.java:25)\r\n        at java.lang.reflect.Method.invoke(Method.java:597)\r\n        at junit.framework.TestCase.runTest(TestCase.java:154)\r\n        at junit.framework.TestCase.runBare(TestCase.java:127)\r\n        at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:\r\n112)\r\n        at junit.framework.TestResult$1.protect(TestResult.java:106)\r\n        at junit.framework.TestResult.runProtected(TestResult.java:124)\r\n        at junit.framework.TestResult.run(TestResult.java:109)\r\n        at junit.framework.TestCase.run(TestCase.java:118)\r\n        at junit.framework.TestSuite.runTest(TestSuite.java:208)\r\n        at junit.framework.TestSuite.run(TestSuite.java:203)\r\n        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\nI think it is like what Kristian said earlier, it is relate to unable to delete singleUse/copyShutdown/seg0/c481.dat. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lilywei","name":"lilywei","emailAddress":"lilywei at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lily Wei","active":true},"created":"2011-02-18T21:28:28.654+0000","updated":"2011-02-18T21:28:28.654+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/13001078","id":"13001078","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"The patch appears to have fixed this problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-01T20:00:33.469+0000","updated":"2011-03-01T20:00:33.469+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12498544/comment/13086847","id":"13086847","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Closing issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-08-18T07:18:30.422+0000","updated":"2011-08-18T07:18:30.422+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5037/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06fif:"}}
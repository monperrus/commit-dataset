{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12694886","self":"https://issues.apache.org/jira/rest/api/latest/issue/12694886","key":"SOLR-5721","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310230","id":"12310230","key":"SOLR","name":"Solr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310230&avatarId=22151","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310230&avatarId=22151","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310230&avatarId=22151","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310230&avatarId=22151"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12325573","id":"12325573","description":"Major release after 4.6","name":"4.7","archived":false,"released":true,"releaseDate":"2014-02-26"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321664","id":"12321664","description":"Current trunk","name":"Trunk","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-02-13 05:53:50.891","customfield_12312323":null,"customfield_12310420":"373394","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_142358341_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2014-02-14T15:40:28.791+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-5721/watchers","watchCount":5,"isWatching":false},"created":"2014-02-13T00:07:50.483+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12325762","id":"12325762","description":"Bugfix release after 4.6","name":"4.6.1","archived":false,"released":true,"releaseDate":"2014-01-28"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=markrmiller%40gmail.com","name":"markrmiller@gmail.com","emailAddress":"markrmiller at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=markrmiller%40gmail.com&avatarId=17267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=markrmiller%40gmail.com&avatarId=17267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=markrmiller%40gmail.com&avatarId=17267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=markrmiller%40gmail.com&avatarId=17267"},"displayName":"Mark Miller","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-03-16T13:04:08.245+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313841","id":"12313841","name":"SolrCloud"}],"timeoriginalestimate":null,"description":"Here are the sequence of events:\r\n- we disconnect\r\n- The disconnect timer beings to run (so no longer scheduled), but doesn't  set likelyExpired yet\r\n- We connect, and set likelyExpired = false\r\n- The disconnect thread runs and sets likelyExpired to true, and it is never set back to false (note that we cancel the disconnect thread but that only cancels scheduled tasks but not running tasks).\r\n\r\nThis is pretty difficult to reproduce without doing more work in the disconnect thread.  It's easy to reproduce by adding sleeps in various places -- I have a test that I'll attach that does that.\r\n\r\nThe most straightforward way to solve this would be to grab the synchronization lock on ConnectionManager in the disconnect thread, ensure we aren't actually connected, and only then setting likelyExpired to true.  In code:\r\n{code}\r\nsynchronized (ConnectionManager.this) {\r\n  if (!connected) likelyExpired = true;\r\n}\r\n{code}\r\n\r\nbut this is all pretty subtle and error prone.  It's easier to just get rid of the disconnect thread and record the last time we disconnected.  Then, when we check likelyExpired, we just do a quick calculation to see if we are likelyExpired.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"373694","summary":"ConnectionManager can become stuck in likeExpired","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gchanan","name":"gchanan","emailAddress":"gchanan at cloudera dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gregory Chanan","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gchanan","name":"gchanan","emailAddress":"gchanan at cloudera dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gregory Chanan","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":9,"total":9,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694886/comment/13899814","id":"13899814","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gchanan","name":"gchanan","emailAddress":"gchanan at cloudera dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gregory Chanan","active":true},"body":"Here's a rough demonstration of a failure with strategic pauses inserted.  I don't think we'd want such a test, but I couldn't reproduce the bug with a nicer test.  What I did in the nicer test is:\r\n- disconnect\r\n- try to reconnect around the time the disconnect thread would run (with some random error)\r\n\r\nif I inserted something small in the disconnect thread, like a System.err, the nicer test would reproduce the issue.  I can attach that if people are interested.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gchanan","name":"gchanan","emailAddress":"gchanan at cloudera dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gregory Chanan","active":true},"created":"2014-02-13T00:11:35.453+0000","updated":"2014-02-13T00:11:35.453+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694886/comment/13899862","id":"13899862","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gchanan","name":"gchanan","emailAddress":"gchanan at cloudera dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gregory Chanan","active":true},"body":"Here's a patch that gets rid of the disconnect thread and a test around it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gchanan","name":"gchanan","emailAddress":"gchanan at cloudera dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gregory Chanan","active":true},"created":"2014-02-13T00:56:53.023+0000","updated":"2014-02-13T00:56:53.023+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694886/comment/13900037","id":"13900037","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=markrmiller%40gmail.com","name":"markrmiller@gmail.com","emailAddress":"markrmiller at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=markrmiller%40gmail.com&avatarId=17267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=markrmiller%40gmail.com&avatarId=17267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=markrmiller%40gmail.com&avatarId=17267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=markrmiller%40gmail.com&avatarId=17267"},"displayName":"Mark Miller","active":true},"body":"Nice! Good call.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=markrmiller%40gmail.com","name":"markrmiller@gmail.com","emailAddress":"markrmiller at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=markrmiller%40gmail.com&avatarId=17267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=markrmiller%40gmail.com&avatarId=17267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=markrmiller%40gmail.com&avatarId=17267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=markrmiller%40gmail.com&avatarId=17267"},"displayName":"Mark Miller","active":true},"created":"2014-02-13T05:53:50.891+0000","updated":"2014-02-13T05:53:50.891+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694886/comment/13901557","id":"13901557","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1568337 from [~markrmiller@gmail.com] in branch 'dev/trunk'\r\n[ https://svn.apache.org/r1568337 ]\r\n\r\nSOLR-5721: ConnectionManager can become stuck in likeExpired.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-02-14T15:36:02.026+0000","updated":"2014-02-14T15:36:02.026+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694886/comment/13901566","id":"13901566","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1568338 from [~markrmiller@gmail.com] in branch 'dev/branches/branch_4x'\r\n[ https://svn.apache.org/r1568338 ]\r\n\r\nSOLR-5721: ConnectionManager can become stuck in likeExpired.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-02-14T15:40:07.449+0000","updated":"2014-02-14T15:40:07.449+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694886/comment/13901568","id":"13901568","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=markrmiller%40gmail.com","name":"markrmiller@gmail.com","emailAddress":"markrmiller at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=markrmiller%40gmail.com&avatarId=17267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=markrmiller%40gmail.com&avatarId=17267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=markrmiller%40gmail.com&avatarId=17267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=markrmiller%40gmail.com&avatarId=17267"},"displayName":"Mark Miller","active":true},"body":"Thanks Greg!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=markrmiller%40gmail.com","name":"markrmiller@gmail.com","emailAddress":"markrmiller at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=markrmiller%40gmail.com&avatarId=17267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=markrmiller%40gmail.com&avatarId=17267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=markrmiller%40gmail.com&avatarId=17267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=markrmiller%40gmail.com&avatarId=17267"},"displayName":"Mark Miller","active":true},"created":"2014-02-14T15:40:28.819+0000","updated":"2014-02-14T15:40:28.819+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694886/comment/13902718","id":"13902718","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyetitmoves","name":"andyetitmoves","emailAddress":"raiyengar at bloomberg dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyetitmoves&avatarId=18534","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyetitmoves&avatarId=18534","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyetitmoves&avatarId=18534","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyetitmoves&avatarId=18534"},"displayName":"Ramkumar Aiyengar","active":true},"body":"Wouldn't using System.currentTimeMillis for timr deltas lead to errors due to NTP sync or DST? It's not guaranteed to be monotonic. See\r\n\r\nhttp://stackoverflow.com/questions/2978598/will-sytem-currenttimemillis-always-return-a-value-previous-calls\r\n\r\nSystem.nanoTime seems to provide a better alternative, at least when the OS supports a monotonic clock.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyetitmoves","name":"andyetitmoves","emailAddress":"raiyengar at bloomberg dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyetitmoves&avatarId=18534","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyetitmoves&avatarId=18534","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyetitmoves&avatarId=18534","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyetitmoves&avatarId=18534"},"displayName":"Ramkumar Aiyengar","active":true},"created":"2014-02-16T13:59:02.222+0000","updated":"2014-02-16T13:59:02.222+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694886/comment/13902747","id":"13902747","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=markrmiller%40gmail.com","name":"markrmiller@gmail.com","emailAddress":"markrmiller at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=markrmiller%40gmail.com&avatarId=17267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=markrmiller%40gmail.com&avatarId=17267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=markrmiller%40gmail.com&avatarId=17267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=markrmiller%40gmail.com&avatarId=17267"},"displayName":"Mark Miller","active":true},"body":"Yeah, sounds like a good improvement.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=markrmiller%40gmail.com","name":"markrmiller@gmail.com","emailAddress":"markrmiller at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=markrmiller%40gmail.com&avatarId=17267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=markrmiller%40gmail.com&avatarId=17267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=markrmiller%40gmail.com&avatarId=17267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=markrmiller%40gmail.com&avatarId=17267"},"displayName":"Mark Miller","active":true},"created":"2014-02-16T16:28:52.770+0000","updated":"2014-02-16T16:28:52.770+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694886/comment/13902766","id":"13902766","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=markrmiller%40gmail.com","name":"markrmiller@gmail.com","emailAddress":"markrmiller at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=markrmiller%40gmail.com&avatarId=17267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=markrmiller%40gmail.com&avatarId=17267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=markrmiller%40gmail.com&avatarId=17267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=markrmiller%40gmail.com&avatarId=17267"},"displayName":"Mark Miller","active":true},"body":"I filed SOLR-5734 as this kind of spans the system.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=markrmiller%40gmail.com","name":"markrmiller@gmail.com","emailAddress":"markrmiller at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=markrmiller%40gmail.com&avatarId=17267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=markrmiller%40gmail.com&avatarId=17267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=markrmiller%40gmail.com&avatarId=17267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=markrmiller%40gmail.com&avatarId=17267"},"displayName":"Mark Miller","active":true},"created":"2014-02-16T18:01:07.122+0000","updated":"2014-02-16T18:01:07.122+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-5721/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1scif:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12427319","self":"https://issues.apache.org/jira/rest/api/latest/issue/12427319","key":"CASSANDRA-220","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310865","id":"12310865","key":"CASSANDRA","name":"Cassandra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310865&avatarId=12034","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310865&avatarId=12034","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310865&avatarId=12034","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310865&avatarId=12034"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11961","id":"11961","description":"Apache Cassandra related projects","name":"Cassandra"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313862","id":"12313862","description":"","name":"0.4","archived":false,"released":true,"releaseDate":"2009-09-27"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-06-08 15:02:15.5","customfield_12312322":null,"customfield_12312323":null,"customfield_12310222":"10002_*:*_2_*:*_933226186_*|*_1_*:*_1_*:*_38731929_*|*_5_*:*_2_*:*_373239344_*|*_4_*:*_1_*:*_6186","customfield_12310420":"19599","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2009-06-23T17:57:15.154+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-220/watchers","watchCount":1,"isWatching":false},"created":"2009-06-08T04:17:11.509+0000","customfield_10022":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12311124":null,"customfield_12312334":null,"customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-08-12T01:11:42.729+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312978","id":"12312978","name":"Core"}],"timeoriginalestimate":null,"description":"In our test cluster, I observed that on some nodes, TCP writes get accumulated in TcpConnection.pendingWrites. However, the selector never gets a ready to write event. As a result, all writes get stuck. This is because write(message) and doPendingWrites() are not fully synchronized.  This following situation can happen:\r\n\r\n1. write(message) adds stuff to pendingWrites.\r\n2. a ready to write event happens; in doPendingWrites() buffered requests are written to socket\r\n3. another write request happens, in write(message), the test for pendingWrites.isEmpty() is false\r\n4. doPendingWrites() finishes writing all buffered request to socket\r\n5. in write(message), the new request is added to pendingWrites\r\n\r\nNow, ready to write events will never happen again and all write requests get stuck in pendingWrites.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12410136","id":"12410136","filename":"220-2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-06-08T15:02:15.453+0000","size":7361,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12410136/220-2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12410523","id":"12410523","filename":"220-3.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"created":"2009-06-12T23:16:23.730+0000","size":998,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12410523/220-3.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12411547","id":"12411547","filename":"220-4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"created":"2009-06-23T16:29:12.994+0000","size":4507,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12411547/220-4.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12411554","id":"12411554","filename":"220-5.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"created":"2009-06-23T17:48:46.208+0000","size":6424,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12411554/220-5.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12410103","id":"12410103","filename":"issue220.patchv1","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"created":"2009-06-08T04:22:35.090+0000","size":2099,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12410103/issue220.patchv1"}],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"91042","summary":"TCP writes get stuck","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"customfield_12311420":null,"customfield_12311421":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":11,"total":11,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12427319/comment/12717139","id":"12717139","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"body":"Attache a patch to trunk by expanding the synchronization scope in TcpConnection.doPendingWrites().\r\n\r\nWe need to patch to 0.3 branch too.\r\n\r\nAlso, we need to revisit the code in TcpConnection. Under heavy writes, is it better to keep accumulating writes until we run out of memory, or to put a cap on the write buffer and simply block and possibly timeout the writer.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"created":"2009-06-08T04:22:35.132+0000","updated":"2009-06-08T04:22:35.132+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12427319/comment/12717280","id":"12717280","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"Committed to 0.3.  Will merge to trunk.\r\n\r\nHere is another patch to clean up TcpConnection a little.  Look okay?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-06-08T15:02:15.500+0000","updated":"2009-06-08T15:02:15.500+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12427319/comment/12717292","id":"12717292","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"body":"The new patch looks fine to me.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"created":"2009-06-08T15:22:25.930+0000","updated":"2009-06-08T15:22:25.930+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12427319/comment/12717300","id":"12717300","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"committed","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-06-08T15:36:12.489+0000","updated":"2009-06-08T15:36:12.489+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12427319/comment/12719018","id":"12719018","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"body":"Haven't beaten this one to death yet. There is another potential synchronization problem with respect to TcpConnection.connect. The following could happen:\r\n\r\n1. Thread 1: TcpConnection.write(message) checks the channel and finds it not connected yet.\r\n2. Thread 2: Sockect is connected and triggers TcpConnection.connect; pendingWrites is tested to be empty and \"interested in write\" bit is not set\r\n3. Thread 1: adds message to pendingWrites\r\n\r\nNow, pendingWrites is not empty and the \"read for write\" event is never going to happen since we didn't register an interest for it. All subsequent writes get stuck afterward.\r\n\r\nAttach a patch in 220-3. It synchronizes in TcpConnection.connect too. Should patch 0.3 branch too.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"created":"2009-06-12T23:16:23.779+0000","updated":"2009-06-12T23:16:23.779+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12427319/comment/12719048","id":"12719048","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"I know nio is sexier, but maybe it would be better to rip it out and just go with thread-per-socket.\r\n\r\nhttp://java.dzone.com/articles/avoid-nio-get-better-throughpu (read the linked slides)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-06-13T00:32:36.633+0000","updated":"2009-06-13T00:32:36.633+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12427319/comment/12720818","id":"12720818","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"on -3, my only suggestion is, maybe we should just synchronize the whole method for simplicity since it is only going to be called once.\r\n\r\nwhat do you think?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-06-17T18:33:01.326+0000","updated":"2009-06-17T18:33:01.326+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12427319/comment/12723165","id":"12723165","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"body":"It took me a while to dig this out. Under heavy load and large column values, we still saw lockups in tcp connection. Here is the problem. The following code that sets the interest ops seems innocent, but it's the source of the problem. The reason is that this operation is not atomic. Another thread could sneak in between the reading of the ops and the setting of it. As a result, some wrong bits could be set.\r\n   key_.interestOps(key_.interestOps() | SelectionKey.OP_READ)\r\n\r\nThis is a sequence that demonstrates how we can lose the OP_READ bit forever and thus jam the read channel:\r\n1. Thread 1: we want to write a message and in write(Message) we are about to turn on OP_WRITE because the message can't be written in one shot.\r\n2. Thread 2: a read comes in and in read(SelectionKey), we turn off OP_READ and submit the read request to ReadWorkItem in Thread 3.\r\n3. Thread 1: read interestOps and see OP_READ as off.\r\n4. Thread 3: finished processing the read request and turn OP_READ on\r\n5. Thread 1: resumes and turn on OP_WRITE. However, by doing that, we also turned off OP_READ. The read channel is thus blocked forever after this.\r\n\r\nPatch-4 makes changing interestOps atomic by synchronizing on the selection key.\r\n\r\nPatch-4 also includes the earlier fix for the synchronization problem in connect. I left the fix as it is instead of making connect() a synchronized method. This way, it makes clear which part of the code in connect really requires synchronization.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"created":"2009-06-23T16:29:13.059+0000","updated":"2009-06-23T16:29:13.059+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12427319/comment/12723177","id":"12723177","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"looks good.\r\n\r\ncan you patch the other uses of interestOps in UDPConnection and HttpConnection too?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-06-23T16:42:40.534+0000","updated":"2009-06-23T16:42:40.534+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12427319/comment/12723209","id":"12723209","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"body":"Attach patch-5 that fixes similar problems in HttpConnection and UdpConnection.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","emailAddress":"junrao at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true},"created":"2009-06-23T17:48:46.237+0000","updated":"2009-06-23T17:48:46.237+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12427319/comment/12723220","id":"12723220","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"committed to 0.3 branch and merged to trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-06-23T17:57:15.092+0000","updated":"2009-06-23T17:57:15.092+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-220/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0fxlr:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12329302","self":"https://issues.apache.org/jira/rest/api/latest/issue/12329302","key":"DERBY-1025","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-03-09 11:18:03.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22270","customfield_12310222":"1_*:*_1_*:*_4878483000_*|*_6_*:*_2_*:*_29261188624_*|*_5_*:*_2_*:*_453898159_*|*_4_*:*_2_*:*_3369697822","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2007-05-07T20:08:48.446+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1025/watchers","watchCount":0,"isWatching":false},"created":"2006-02-22T10:47:59.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"8.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-05-08T00:49:38.149+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11690","id":"11690","name":"Network Client"}],"timeoriginalestimate":null,"description":"Embedded XAResource.start() implementation commits the active local transaction on the Connection associated with the XAResource if the connection is auto-commit mode.\n\nClient incorrectly throws an XAException with the XAER_RMFAIL error code (see DERBY-1024)\n\nXATest contains a work-around for client (calling commit) with a comment with this bug number.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40051","summary":"[xa] client XAResource.start() does not commit an active local transaction when auto commit is true","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":17,"total":17,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12369590","id":"12369590","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"\r\nSo on XAResource.start() we need to flowcommit if\r\n1) We are in autocommit mode. \r\n        conn_.autocommit_ == true\r\n2) We are in a an active local Transaction.\r\n   conn_getXAState() == XA_T0_NOT_ASSOCIATED\r\n   conn_.inUnitOfWork_ == true\r\n\r\nFor my first shot at fixing this bug I added the folling code to \r\nNetXAResource.start()\r\n\t// DERBY-1025 \r\n        // autocommit the local transaction before starting the global transaction\r\n        // if autocommit is set\r\n        if (conn_.autoCommit_  && conn_.inActiveLocalTransaction())\r\n        {\r\n\t\tconn_.flowAutoCommit();\r\n        }\r\n   \t\r\n   \r\nWhere in NetXAConnection we have\r\npublic boolean inActiveLocalTransaction() {\r\n\t\treturn (isInUnitOfWork_() && \r\n    \t\t\t(getXAState() == XA_T0_NOT_ASSOCIATED));   \r\n\t\t\r\n\t}\r\n\r\nAnd in Connection.java\r\n\t/**\r\n\t * @return Returns the inUnitOfWork_.\r\n\t */\r\n\tpublic boolean isInUnitOfWork_() {\r\n\t\treturn inUnitOfWork_;\r\n\t}\r\n\r\n\r\nWith my change, putting this code in I found some very strange behaviour in this case in XATest\r\n1)  I got a commit on start when no local transaction was active after  a suspend\r\n2)  I seemed to lose a totally different suspended transaction in the process.\r\n\r\nSee comments for behaviour:\r\n    private static void interleavingTransactions(XADataSource xads) {\r\n        System.out.println(\"interleavingTransactions\");\r\n        try {\r\n            XAConnection xac = xads.getXAConnection(\"sku\", \"testxa\");\r\n            XAResource xar = xac.getXAResource();\r\n\r\n            Xid xid1 = XATestUtil.getXid(1, 93, 18);\r\n            Xid xid2 = XATestUtil.getXid(2, 45, 77);\r\n\r\n            xar.start(xid1, XAResource.TMNOFLAGS);\r\n\r\n            Connection conn = xac.getConnection();\r\n\r\n            Statement s = conn.createStatement();\r\n            s.executeUpdate(\"insert into APP.foo values (1)\");\r\n            xar.end(xid1, XAResource.TMSUSPEND);\r\n            // commit occurred here because inUnitOfWork_ was true\r\n            // when it should be false.\r\n            xar.start(xid2, XAResource.TMNOFLAGS);\r\n            s.executeUpdate(\"insert into APP.foo values (2)\");\r\n            xar.end(xid2, XAResource.TMSUSPEND);\r\n            \r\n            xar.start(xid1, XAResource.TMRESUME);\r\n            s.executeUpdate(\"insert into APP.foo values (3)\");\r\n            // XAER_NOTA on suspend  of xid1.\r\n            // very strange because the resume worked ok.\r\n            // where did it go?\r\n            xar.end(xid1, XAResource.TMSUSPEND);\r\n\r\n\r\nI am trying to understand:\r\n\r\n1)  When and how inUnitOfWork_ is set and its relation to XA\r\n2)  Why the autocommit after the suspension of xid2 caused xid1 to go away after it resumed just fine.\r\n\r\nAll very strange.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-03-09T11:18:03.000+0000","updated":"2006-03-09T11:18:03.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12372170","id":"12372170","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"I wonder if the problem you are seeing may be due to this code in DRDAStatement:\r\n\r\n\t/**\r\n\t * Get prepared statement\r\n\t *\r\n\t * @return prepared statement\r\n\t */\r\n\tprotected PreparedStatement getPreparedStatement() throws SQLException\r\n\t{\r\n\t\tif (ps instanceof BrokeredPreparedStatement)\r\n\t\t\treturn (PreparedStatement)(\r\n\t\t\t\t\t\t   ((BrokeredPreparedStatement) ps).getStatement());\r\n\t\telse\r\n\t\t\treturn ps;\r\n\t}\r\n\r\n\r\nThis code, for some unknown reason due to lack of comments, is getting the underlying embedded statement\r\nfrom a BrokeredPreparedStatement.  This should not be allowed, the BrokeredStatement wrappers are there to\r\nhide the embedded statement object as it can change under the covers of the wrapper.\r\n\r\nIt could be that the network server is getting the prepared statement and then hanging on too long and performing\r\nactions on the wrong object. Though it seems unlikely that auto-commit on a connection would go through the\r\nprepared statement.\r\n\r\nI wonder why this code needs the inner statement","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-03-29T09:06:03.000+0000","updated":"2006-03-29T09:06:03.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12374400","id":"12374400","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"I was looking at this and understanding the differences between embedded and client code. I see the client does not have code to commit in auto-commit mode. I was trying to test my changes when I found that this problem no longer reproduces with the latest trunk. \r\n\r\nWhat I tried was - run jdbcapi/XATest.java in client framewrok by commenting out the following workaround in the test:\r\n            // DERBY-1025 Client only bug\r\n            /*if (TestUtil.isDerbyNetClientFramework()) {\r\n                System.out.println(\"DERBY-1025 Call conn.commit to avoid exception with client\");\r\n                conn.commit();\r\n            }\r\n            */\r\n\r\nI do not get any exceptions. I ran this about 10 times and the test passes without the explicit \"commit\" workaround. Can someone please confirm this is right way to repro this issue? If anyone knows any other repros, please let me know.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-04-14T02:22:23.000+0000","updated":"2006-04-14T02:22:23.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12374403","id":"12374403","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"There's a chance that changes to the code preceeding that masked the issue, or maybe the pre-fetching changed behaviour by fetching\r\nrows and causing a commit..\r\n\r\nI added this code just before the code you commented out and saw the issue again:\r\n\r\n            rs.close(); \r\n             // ensure a transaction is active to test DERBY-1025\r\n            rs = sdh.executeQuery(\"SELECT * FROM APP.FOO\");","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-04-14T02:38:44.000+0000","updated":"2006-04-14T02:38:44.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12374404","id":"12374404","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"There is a case disabled for DERBY-1025 in jdbcapi/checkDataSource.java  as well.  \r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-04-14T02:53:38.000+0000","updated":"2006-04-14T02:53:38.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12374439","id":"12374439","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Attaching a draft patch 'derby-1025-draft1.diff' which is only for review and not for commit. This fixes the repros in the tests XATest.java and checkDataSource.java.\r\n\r\nI have a question about the expected exceptions in the test checkDataSource.java. The exceptions thrown by the client are different from what is thrown by the embedded driver. Specifically, I want to make sure this is the expected exception in the following case:\r\n\r\n---------------------------------------------------------------------------------------------------------------------------------------------------\r\n\t\tconn4.setAutoCommit(false);\r\n\r\n\t\trs4 = s4.executeQuery(\"select i from autocommitxastart\");\r\n\t\trs4.next(); System.out.println(\"acxs \" + rs4.getInt(1));\r\n\t\trs4.next(); System.out.println(\"acxs \" + rs4.getInt(1));\r\n\r\n\t\ttry {\r\n\t\t\txac4.getXAResource().start(xid4a, XAResource.TMNOFLAGS);\r\n\t\t} catch (XAException xae) {\r\n\t\t\tshowXAException(\"autocommitxastart expected \", xae);\r\n\t\t}\r\n---------------------------------------------------------------------------------------------------------------------------------------------------\r\nException:\r\nautocommitxastart expected  : XAException - XAER_DUPID : Error executing a XAResource.start(), Server returned XAER_DUPID\r\n---------------------------------------------------------------------------------------------------------------------------------------------------\r\n\r\nWith the draft patch, I have only run jdbcapi/checkDataSource.java and jdbcapi/XATest.java in client framework. I will be running derbynetclientmats shortly. Also, for testing purposes, I have removed the test jdbcapi/checkDataSource.java from DerbyNetClient.exclude.\r\n\r\nI would appreciate if someone can go through this patch quickly and let me know if the changes are okay. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-04-14T06:38:21.000+0000","updated":"2006-04-14T06:38:21.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12374440","id":"12374440","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"The change in NetXAResource looks ok. The XAER_DUPID (duplicate xid) exception looks wrong though. The error code should match embedded.\r\nMake sure the rs4 result set has not closed and thus committed the transaction, maybe fetch less rows or no at all?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2006-04-14T06:45:38.000+0000","updated":"2006-04-14T06:45:38.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12374444","id":"12374444","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"I looked into this a bit more and found that embedded and client are actually returning the same XA error code (XAER_DUPID). I printed out the error code in the test to verify this. The test just calls getMessage() on the XAException and prints it out. In case of embedded, I think the message is null. Whereas, in case of client, I see that the method NetXAResource.xaRetValErrorAccumSQL creates a message as follows: \r\n---------------------------------------------------------------------------------------------------------------------------------------------------\r\nif (rc != XAResource.XA_OK) { // error was detected\r\n            // create an SqlException to report this error within\r\n            String xaRetValStr = \"Error executing a \" +\r\n                    getXAFuncStr(callInfo.xaFunction_) + \", \" +\r\n                    \"Server returned \" + getXAExceptionText(rc);\r\n\r\n---------------------------------------------------------------------------------------------------------------------------------------------------\r\n\r\nThis accounts for the difference in embedded and client messages. \r\n\r\nHowever, it is not clear to me what the purpose of this test is. If it is meant to check for XAER_DUPID, it does not seem to fit into the remaining tests.  I need to look into this some more. \r\n---------------------------------------------------------------------------------------------------------------------------------------------------\r\n               try {\r\n\t\t\txac4.getXAResource().start(xid4a, XAResource.TMNOFLAGS);\r\n\t\t} catch (XAException xae) {\r\n\t\t\tshowXAException(\"autocommitxastart expected \", xae);\r\n\t\t}\r\n\r\n---------------------------------------------------------------------------------------------------------------------------------------------------","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-04-14T07:56:17.000+0000","updated":"2006-04-14T07:56:17.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12374524","id":"12374524","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Thanks Dan and Kathey for replying to my questions. I am attaching a patch 'derby-1025-patch1-v1.diff' which makes client's XAResource.start() to commit a local transaction when auto commit is true. \r\n\r\n------------------------------------------------\r\nSummary:\r\n------------------------------------------------\r\n* Modifies NetXAResource.start to check if the connection is in autocommit mode and flow an auto commit.\r\n* Uncomments the tests for this issue in jdbcapi/XATest.java and jdbcapi/checkDataSource.java\r\n\r\n------------------------------------------------\r\nTest:\r\n------------------------------------------------\r\nWith this patch, I ran derbynetclientmats using Sun JDK1.4.2 on Windows XP. I also ran checkDataSource test in client framework by temporarily removing it from the exclude file. \r\n\r\n------------------------------------------------\r\nQuestions:\r\n------------------------------------------------\r\n* When working on this issue, I saw this piece of code in client's Connection.flowCommit method:\r\n        // Per JDBC specification (see javadoc for Connection.commit()):\r\n        //   \"This method should be used only when auto-commit mode has been disabled.\"\r\n        // However, some applications do this anyway, it is harmless, so\r\n        // if they ask to commit, we could go ahead and flow a commit.\r\n        // But note that rollback() is less harmless, rollback() shouldn't be used in auto-commit mode.\r\n        // This behavior is subject to further review.\r\n\r\n        //   if (!this.inUnitOfWork)\r\n        //     return;\r\n        // We won't try to be \"too smart\", if the user requests a commit, we'll flow a commit,\r\n        // regardless of whether or not we're in a unit of work or in auto-commit mode.\r\n        //\r\n\r\nI saw that Kathey's trial patch was trying to check if we are in unit of work before calling flowAutoCommit. On looking at the flowAutoCommit method, I saw that this logic was planned to be in the commit method itself but currently it is commented out mentioning \"further review\". Should I open a JIRA issue for this so that we can pursue this later?\r\n\r\n* I think the test for derby-1025 in checkDataSource.java is wrongly testing XAER_DUPID because the second transaction uses the same xid. I think we want to test that we cannot start a global transaction when the resource manager is doing some work outside. I have changed the test to use a different xid. And now the test gives me XAER_OUTSIDE,which I think is what we want to test. If I'm wrong here, please let me know. I'll submit a separate patch for this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-04-14T21:23:33.000+0000","updated":"2006-04-14T21:23:33.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12374540","id":"12374540","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I checked the patch into the trunk:\r\nDate: Fri Apr 14 09:30:00 2006\r\nNew Revision: 394134\r\n\r\nURL: http://svn.apache.org/viewcvs?rev=394134&view=rev\r\n\r\nThis change looks good to me but when I ran jdbcapi/checkDataSource.java  and jdbcapi/checkDataSource30.java and  with client I got these (expected I think) diffs.  I updated the masters and checked in.\r\nPlease check that the output difference is expected.\r\n\r\nAttempt to shutdown framework: DerbyNetClient\r\n58 del\r\n< expected java.sql.SQLException: Invalid operation: result set closed\r\n58a58\r\n> expected java.sql.SQLException: 'ResultSet' already closed.\r\n460 del\r\n< autocommitxastart expected Invalid operation: result set closed\r\n460a460\r\n> autocommitxastart expected 'ResultSet' already closed.\r\nTest Failed.\r\n*** End:   checkDataSource jdk1.4.2_07 DerbyNetClient 2006-04-14 09:04:19 ***\r\n*** Start: checkDataSource30 jdk1.4.2_07 DerbyNetClient 2006-04-14 09:17:14 ***\r\nInitialize for framework: DerbyNetClient\r\njava -Dderby.system.home=D:\\testout\\DerbyNetClient\\checkDataSource30 -Djava.security.manager -Djava.security.policy=D:\\testout\\derby_tests.policy -DderbyTesting.codeclasses=file:/D:/p4/marsden_patch/c\r\nlasses/ -DderbyTesting.codedir=D:\\p4\\marsden_patch\\classes -DderbyTesting.serverhost=localhost -DderbyTesting.clienthost=localhost -DderbyTesting.codejar=file://unused/ org.apache.derby.drda.NetworkSe\r\nrverControl start\r\nAttempt to shutdown framework: DerbyNetClient\r\n70 del\r\n< expected java.sql.SQLException: Invalid operation: result set closed\r\n70a70\r\n> expected java.sql.SQLException: 'ResultSet' already closed.\r\n551a552,559\r\n> conn4 autcommit true\r\n> acxs 1\r\n> acxs 2\r\n> autocommitxastart expected 'ResultSet' already closed.\r\n> acxs 1\r\n> acxs 2\r\n> autocommitxastart expected  : XAException - XAER_DUPID : Error executing a XAResource.start(), Server returned XAER_DUPID\r\n> acxs 3\r\n578 del\r\n< Expected SQLException Invalid operation: result set closed\r\n578a586\r\n> Expected SQLException 'ResultSet' already closed.\r\n590 del\r\n< Expected SQLException Invalid operation: result set closed\r\n591 del\r\n< Expected SQLException Invalid operation: result set closed\r\n591a598,599\r\n> Expected SQLException 'ResultSet' already closed.\r\n> Expected SQLException 'ResultSet' already closed.\r\nTest Failed.\r\n*** End:   checkDataSource30 jdk1.4.2_07 DerbyNetClient 2006-04-14 09:18:29 ***\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-04-14T23:32:22.000+0000","updated":"2006-04-14T23:32:22.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12374556","id":"12374556","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Thanks Kathey for updating the master files. The diffs in the master file are expected. This is because the error messages were changed by commit for DERBY-842, svn revision# 393967. I had my workspace synched up to a older revision when I created the patch.\r\n\r\nI am attaching 'derby-1025-patch2-v1.diff' which changes checkDataSource test to test that starting a global transcation when a local transaction is active will give an exception. The XA error code is also printed out to verify that we get the expected exception. This patch will resolve this issue fully.\r\n\r\nWith this patch, I have run checkDataSource checkDataSource30 tests with embedded and client frameworks. Please take a look at this patch.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-04-15T01:41:56.000+0000","updated":"2006-04-15T01:41:56.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12374581","id":"12374581","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Attaching 'derby-1025-10.1.diff' for 10.1 branch. A direct merge does not work because the test checkDataSource is not enabled for client in 10.1. \r\n\r\nI ran derbynetclientmats using Sun JDK 1.4.2 on Windows XP. I also ran the test jdbcapi/XATest on client and embedded frameworks. Please look at this patch.\r\n\r\nNOTE: \r\nThere are two pending patches attached to this issue:\r\n* derby-1025-10.1.diff for 10.1 branch\r\n* derby-1025-patch2-v1.diff for trunk (changes to the test checkDataSource.java)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-04-15T06:33:53.000+0000","updated":"2006-04-15T06:33:53.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12375139","id":"12375139","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"body":"Patches committed as revision# 394134,394949 in trunk; revision# 394230 in 10.1 branch\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deepa","name":"deepa","emailAddress":"dremesh at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Deepa Remesh","active":true},"created":"2006-04-19T21:56:02.000+0000","updated":"2006-04-19T21:56:02.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12485331","id":"12485331","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"I believe this was incorrectly closed.\r\nAlthough I don't see the XAID_DUP error, so there was improvement, it seems to me the transaction is still active.\r\n\r\ncheckDataSource has I think a mistake in it that gave the impression this was fixed:\r\n\r\n    try {\r\n         rs4.next(); System.out.println(\"acxs \" + rs.getInt(1))\r\n    } catch (SQLException sqle) {\r\n         System.out.println(\"autocommitxastart expected \" + sqle.getMessage());\r\n    }\r\n\r\nWe're doing rs4.next(), but then attempt to get a value out of rs, rather than rs4. rs has been closed way before this point, so not surprisingly, this gives an sqlexception.\r\n\r\nWhen I change rs.getInt(1) to rs4.getInt(1), things work unchanged for embedded. However, with DerbyNetClient, we get different behavior; we happily get a value returned (3). \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2007-03-29T20:07:18.487+0000","updated":"2007-03-29T20:07:18.487+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12494117","id":"12494117","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Looking at the test, I think to test whether the cursor is closed we needed to create the statement with CLOSE_CURSRS_AT_COMMIT.  Making that change, client seems to work as expected.  We get SQLState XCL16, but embedded is getting 08003 - No current connection, which I think is wrong. The connection should still be valid. It is only the resultset that is closed. I will open another issue for that and submit the test change.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2007-05-07T19:53:07.442+0000","updated":"2007-05-07T19:53:07.442+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12494119","id":"12494119","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Fixed the test case to create the statement CLOSE_CURSORS_AT_COMMIT.  Filed DERBY-2620 for an issue with embedded losing the connection in this case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2007-05-07T20:08:48.434+0000","updated":"2007-05-07T20:08:48.434+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329302/comment/12494167","id":"12494167","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"In jdbcapi.DataSourceTest there is a piece of code with this comment related to this bug:\r\n\r\n        // DERBY-1025.\r\n        // With Embedded, this will give error: 08003 - No current connection\r\n        // But with NetworkServer / DerbyNetClient, the transaction does not\r\n        // appear to be closed, and we actually get a value.\r\n\r\n\r\nThe comment related to the network server does not seem valid any more.\r\nAssuming the test passes since the path through the code that would result in getting a value back would result in fail() being called.\r\nShould the comment be cleaned up to reflect reality or am I missing something?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2007-05-08T00:49:38.031+0000","updated":"2007-05-08T00:49:38.031+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1025/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i077xj:"}}
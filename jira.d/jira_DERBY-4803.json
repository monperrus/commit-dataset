{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12474315","self":"https://issues.apache.org/jira/rest/api/latest/issue/12474315","key":"DERBY-4803","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315564","id":"12315564","description":"First release on the 10.7 branch.","name":"10.7.1.1","archived":false,"released":true,"releaseDate":"2010-12-14"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2010-09-16 20:12:33.239","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24473","customfield_12310222":"1_*:*_1_*:*_492193281_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2010-09-22T12:42:31.137+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4803/watchers","watchCount":2,"isWatching":false},"created":"2010-09-16T19:59:17.856+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313727","id":"12313727","description":"Feature release","name":"10.6.1.0","archived":false,"released":true,"releaseDate":"2010-05-18"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12334004","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12334004","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12445329","key":"DERBY-4513","self":"https://issues.apache.org/jira/rest/api/2/issue/12445329","fields":{"summary":"Forbid NEXT VALUE FOR clause in certain contexts","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-06-17T09:19:48.477+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"Using sequence in SELECT works fine whereas the same SELECT query used in INSERT/SELECT results in \"The statement references the following sequence more than once\" error. This happens even though the SELECT in question returns exactly 1 row of data.\r\n\r\nThe Reference Manual states 1. \" NEXT VALUE FOR expression may occur in the following places: SELECT statement: As part of the expression defining a returned column in a SELECT list\" and 2. \" NEXT VALUE expression may not appear in any of these situations: CASE expression, WHERE clause, \r\nORDER BY clause, Aggregate expression, ROW_NUMBER function, DISTINCT select list\".\r\nNowhere a restriction on INSERT/SELECT is mentioned. Additionally, other databases (i.e. Oracle) support use of sequences in INSERT/SELECT.\r\n\r\nTherefore, I consider it a bug.\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37826","summary":"Sequences do not work in INSERT/SELECT","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dkroot","name":"dkroot","emailAddress":"dkroot2 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"DK","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10424","value":"Repro attached","id":"10424"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dkroot","name":"dkroot","emailAddress":"dkroot2 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"DK","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Mac OS X, Derby Network Server 10.6.1.0","customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":5,"total":5,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474315/comment/12910295","id":"12910295","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"The following script shows this behavior:\r\n\r\nconnect 'jdbc:derby:memory:db;create=true';\r\n\r\ncreate sequence sequence1;\r\n\r\ncreate table t1( a int );\r\ncreate table t2( a int, b int );\r\n\r\ninsert into t1( a ) values ( 1 );\r\n\r\ninsert into t2\r\nselect next value for sequence1, a from t1;\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-09-16T20:12:33.239+0000","updated":"2010-09-16T20:12:33.239+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474315/comment/12913173","id":"12913173","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-4803-01-aa-simpleInsertSelect.diff. This fixes the bug for a simple insert/select case. The pre-existing test cases in SequenceTest pass cleanly. I will run the full regression test suite.\r\n\r\nThe problem is that the NextSequenceNode is needlessly re-bound for INSERT...SELECT statements. On the second attempt to bind the statement, we discover that the sequence has already been seen and this triggers the overly conservative check for illegal conditions discussed in DERBY-4513. The fix is to short-circuit the second, needless binding of the NextSequenceNode.\r\n\r\nDK, could you post the INSERT statement which disclosed this bug? I would like to verify whether this patch fixes your problem or whether I have merely fixed a related test case. Thanks.\r\n\r\nTouches the following files:\r\n\r\n------\r\n\r\nM      java/engine/org/apache/derby/impl/sql/compile/NextSequenceNode.java\r\n\r\nShort-circuit redundant bindings of NEXT VALUE FOR clauses.\r\n\r\n------\r\n\r\n\r\nM      java/testing/org/apache/derbyTesting/functionTests/tests/lang/SequenceTest.java\r\n\r\nTest-case for this bug.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-09-21T18:58:01.054+0000","updated":"2010-09-21T18:58:01.054+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474315/comment/12913332","id":"12913332","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dkroot","name":"dkroot","emailAddress":"dkroot2 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"DK","active":true},"body":"Rick,\r\n\r\nthat was quick!\r\n\r\nSee attached test case. It fails in 10.6.1.0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dkroot","name":"dkroot","emailAddress":"dkroot2 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"DK","active":true},"created":"2010-09-22T00:54:25.717+0000","updated":"2010-09-22T00:54:25.717+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474315/comment/12913521","id":"12913521","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Tests passed cleanly for me. Committed derby-4803-01-aa-simpleInsertSelect.diff at subversion revision 999908.\r\n\r\nHi DK,\r\n\r\nYour script now passes. I had to edit your script because it was trying to insert integers into varchar columns. Those problems must have been masked by this bug. Here is the modified script which now runs:\r\n\r\nconnect 'jdbc:derby:memory:db;create=true';\r\n\r\nCREATE SEQUENCE CART_TXN_ID_SEQ START WITH 1;\r\nCREATE TABLE TABLE_1\r\n(\r\n  DOCNO VARCHAR(60) NOT NULL\r\n, OTHER_DOCNO VARCHAR(60)\r\n, CAN VARCHAR(7) NOT NULL\r\n, ICD VARCHAR(6)\r\n, FY VARCHAR(4)\r\n, SGL_DEBIT_AMT DECIMAL(12, 2)\r\n, FACTS_TP_CODE VARCHAR(10)\r\n, AUTHORITY_DOCNO VARCHAR(60)\r\n, ACTION_CODE VARCHAR(20)\r\n, CART_TXN_ID INT\r\n, CART_ID VARCHAR(50)\r\n, LAST_UPDATED_BY_USER_ID VARCHAR(20)\r\n, CREATED_DATE TIMESTAMP\r\n, CONSTRAINT TABLE_1 PRIMARY KEY\r\n  (\r\n    CART_TXN_ID\r\n  )\r\n);\r\n\r\nCREATE TABLE TABLE_2\r\n(\r\n  PROJECT_BUDGET CHAR(1)\r\n, ACS_CAN CHAR(7)\r\n, DIRECT_REIMB_FLAG CHAR(1)\r\n, INSTITUTE CHAR(25)\r\n, PROJECT_NBR CHAR(6)\r\n, CURRENT_IND CHAR(1)\r\n);\r\n\r\ninsert into TABLE_2(project_budget, acs_can, direct_reimb_flag, institute, project_nbr, current_ind)\r\nvalues('P', '1234567', 'R', 'XYZ', '123456', 'C');\r\n\r\nINSERT INTO\r\n  TABLE_1 (\r\n  cart_id,\r\n  can,\r\n  docno,\r\n  fy,\r\n  icd,\r\n  other_docno,\r\n  facts_tp_code,\r\n  authority_docno,\r\n  SGL_DEBIT_AMT,\r\n  action_code,\r\n  cart_txn_id,\r\n  last_updated_by_user_id,\r\n  created_date\r\n) SELECT\r\n  'Abc',\r\n  '1234567',\r\n  'Y21',\r\n  '2010',\r\n  TRIM(acs.institute),\r\n  'Y3123456',\r\n  '123',\r\n  'Y3123456',\r\n  100,\r\n  'Action',\r\n  NEXT VALUE FOR CART_TXN_ID_SEQ,\r\n  'Qwerty',\r\n  CURRENT_TIMESTAMP\r\nFROM\r\n  table_2 acs\r\nWHERE\r\n  acs.acs_can = '1234567';\r\n\r\nselect * from table_1;\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2010-09-22T12:42:05.254+0000","updated":"2010-09-22T12:42:05.254+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474315/comment/13685363","id":"13685363","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"[bulk update] Close all resolved issues that haven't been updated for more than one year.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-06-17T09:19:48.474+0000","updated":"2013-06-17T09:19:48.474+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4803/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06u73:"}}
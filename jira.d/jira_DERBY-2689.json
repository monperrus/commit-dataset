{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12370141","self":"https://issues.apache.org/jira/rest/api/latest/issue/12370141","key":"DERBY-2689","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313111","id":"12313111","description":"","name":"10.4.1.3","archived":false,"released":true,"releaseDate":"2008-04-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2007-05-31 20:56:24.435","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23182","customfield_12310222":"1_*:*_1_*:*_3535009814_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2007-07-04T11:08:20.150+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2689/watchers","watchCount":1,"isWatching":false},"created":"2007-05-24T13:11:30.336+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.png","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12316327","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12316327","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12311840","key":"DERBY-418","self":"https://issues.apache.org/jira/rest/api/2/issue/12311840","fields":{"summary":"outofmemory error when running large query in autocommit=false mode","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-01-21T17:50:14.107+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11407","id":"11407","name":"JDBC"}],"timeoriginalestimate":null,"description":"We encountered two times a deadlock inside of derby. It seems that we can't workaround it. The involved two threads are attached, it looks like a classical deadlock:\n\n\"Thread-22\" daemon prio=6 tid=0x0cdaa400 nid=0x1c0 waiting for monitor entry [0x1317f000..0x1317fd4c]\n   java.lang.Thread.State: BLOCKED (on object monitor)\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.finish(Unknown Source)\n\t- waiting to lock <0x052f4d70> (a org.apache.derby.impl.sql.GenericPreparedStatement)\n\tat org.apache.derby.impl.sql.execute.BaseActivation.close(Unknown Source)\n\tat org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.addActivation(Unknown Source)\n\tat org.apache.derby.impl.sql.execute.BaseActivation.initFromContext(Unknown Source)\n\tat org.apache.derby.impl.services.reflect.LoadedGeneratedClass.newInstance(Unknown Source)\n\tat org.apache.derby.impl.services.reflect.ReflectGeneratedClass.newInstance(Unknown Source)\n\tat org.apache.derby.impl.sql.GenericActivationHolder.<init>(Unknown Source)\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.getActivation(Unknown Source)\n\t- locked <0x05306f88> (a org.apache.derby.impl.sql.GenericPreparedStatement)\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.<init>(Unknown Source)\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement20.<init>(Unknown Source)\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement30.<init>(Unknown Source)\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement40.<init>(Unknown Source)\n\tat org.apache.derby.jdbc.Driver40.newEmbedPreparedStatement(Unknown Source)\n\tat org.apache.derby.impl.jdbc.EmbedConnection.prepareStatement(Unknown Source)\n\t- locked <0x047beb00> (a org.apache.derby.impl.jdbc.EmbedConnection40)\n\tat org.apache.derby.impl.jdbc.EmbedConnection.prepareStatement(Unknown Source)\n        [custom methods]\n\n\"ThreadPoolThread-SyncScheduler-3-1\" prio=2 tid=0x0e620400 nid=0xfec waiting for monitor entry [0x10a7e000..0x10a7fa14]\n   java.lang.Thread.State: BLOCKED (on object monitor)\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.finish(Unknown Source)\n\t- waiting to lock <0x05306f88> (a org.apache.derby.impl.sql.GenericPreparedStatement)\n\tat org.apache.derby.impl.sql.execute.BaseActivation.close(Unknown Source)\n\tat org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.addActivation(Unknown Source)\n\tat org.apache.derby.impl.sql.execute.BaseActivation.initFromContext(Unknown Source)\n\tat org.apache.derby.impl.services.reflect.LoadedGeneratedClass.newInstance(Unknown Source)\n\tat org.apache.derby.impl.services.reflect.ReflectGeneratedClass.newInstance(Unknown Source)\n\tat org.apache.derby.impl.sql.GenericActivationHolder.<init>(Unknown Source)\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.getActivation(Unknown Source)\n\t- locked <0x052f4d70> (a org.apache.derby.impl.sql.GenericPreparedStatement)\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.<init>(Unknown Source)\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement20.<init>(Unknown Source)\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement30.<init>(Unknown Source)\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement40.<init>(Unknown Source)\n\tat org.apache.derby.jdbc.Driver40.newEmbedPreparedStatement(Unknown Source)\n\tat org.apache.derby.impl.jdbc.EmbedConnection.prepareStatement(Unknown Source)\n\t- locked <0x04225178> (a org.apache.derby.impl.jdbc.EmbedConnection40)\n\tat org.apache.derby.impl.jdbc.EmbedConnection.prepareStatement(Unknown Source)\n        [custom methods]","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37440","summary":"Deadlock with GenericPreparedStatement","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mewert","name":"mewert","emailAddress":"ewert at neofonie dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marc Ewert","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mewert","name":"mewert","emailAddress":"ewert at neofonie dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marc Ewert","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Windows","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":27,"total":27,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12500486","id":"12500486","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"I assume the affects version was meant to be 10.2.2.0. Since it is unassigned then fixin should be unknown.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2007-05-31T20:56:24.435+0000","updated":"2007-05-31T20:56:24.435+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12501707","id":"12501707","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jn","name":"jn","emailAddress":"jim dot newsham at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Newsham","active":true},"body":"We are experiencing deadlock at the same location.  This is with Derby 10.2.2.0.  The following output comes from jconsole (what a cool tool).  Two threads called Connection.getPreparedStatement(String) simultaneously, each from a different Connection instance.  I doubt the actual sql matters, but here were the strings:  \"select id from node where fk_parent_id = ? and name = ?\", \"select id from band where fk_node_id = ? and name = ? and type = ?\".\r\n\r\n Name: Thread-8\r\n State: BLOCKED on org.apache.derby.impl.sql.GenericPreparedStatement@18f5630 owned by: Thread-20\r\n Total blocked: 48  Total waited: 122\r\n \r\n Stack trace: \r\n org.apache.derby.impl.sql.GenericPreparedStatement.finish(Unknown Source)\r\n org.apache.derby.impl.sql.execute.BaseActivation.close(Unknown Source)\r\n org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.addActivation(Unknown Source)\r\n org.apache.derby.impl.sql.execute.BaseActivation.initFromContext(Unknown Source)\r\n org.apache.derby.impl.services.reflect.LoadedGeneratedClass.newInstance(Unknown Source)\r\n org.apache.derby.impl.services.reflect.ReflectGeneratedClass.newInstance(Unknown Source)\r\n org.apache.derby.impl.sql.GenericActivationHolder.<init>(Unknown Source)\r\n org.apache.derby.impl.sql.GenericPreparedStatement.getActivation(Unknown Source)\r\n    - locked org.apache.derby.impl.sql.GenericPreparedStatement@16570ed\r\n org.apache.derby.impl.jdbc.EmbedPreparedStatement.<init>(Unknown Source)\r\n org.apache.derby.impl.jdbc.EmbedPreparedStatement20.<init>(Unknown Source)\r\n org.apache.derby.impl.jdbc.EmbedPreparedStatement30.<init>(Unknown Source)\r\n org.apache.derby.impl.jdbc.EmbedPreparedStatement40.<init>(Unknown Source)\r\n org.apache.derby.jdbc.Driver40.newEmbedPreparedStatement(Unknown Source)\r\n org.apache.derby.impl.jdbc.EmbedConnection.prepareStatement(Unknown Source)\r\n    - locked org.apache.derby.impl.jdbc.EmbedConnection40@1b0d41\r\n org.apache.derby.impl.jdbc.EmbedConnection.prepareStatement(Unknown Source)\r\n[trace of custom code removed]\r\n\r\n-----------------------------\r\n\r\nName: Thread-20\r\nState: BLOCKED on org.apache.derby.impl.sql.GenericPreparedStatement@16570ed owned by: Thread-8\r\nTotal blocked: 5  Total waited: 112\r\n\r\nStack trace: \r\norg.apache.derby.impl.sql.GenericPreparedStatement.finish(Unknown Source)\r\norg.apache.derby.impl.sql.execute.BaseActivation.close(Unknown Source)\r\norg.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.addActivation(Unknown Source)\r\norg.apache.derby.impl.sql.execute.BaseActivation.initFromContext(Unknown Source)\r\norg.apache.derby.impl.services.reflect.LoadedGeneratedClass.newInstance(Unknown Source)\r\norg.apache.derby.impl.services.reflect.ReflectGeneratedClass.newInstance(Unknown Source)\r\norg.apache.derby.impl.sql.GenericActivationHolder.<init>(Unknown Source)\r\norg.apache.derby.impl.sql.GenericPreparedStatement.getActivation(Unknown Source)\r\n   - locked org.apache.derby.impl.sql.GenericPreparedStatement@18f5630\r\norg.apache.derby.impl.jdbc.EmbedPreparedStatement.<init>(Unknown Source)\r\norg.apache.derby.impl.jdbc.EmbedPreparedStatement20.<init>(Unknown Source)\r\norg.apache.derby.impl.jdbc.EmbedPreparedStatement30.<init>(Unknown Source)\r\norg.apache.derby.impl.jdbc.EmbedPreparedStatement40.<init>(Unknown Source)\r\norg.apache.derby.jdbc.Driver40.newEmbedPreparedStatement(Unknown Source)\r\norg.apache.derby.impl.jdbc.EmbedConnection.prepareStatement(Unknown Source)\r\n   - locked org.apache.derby.impl.jdbc.EmbedConnection40@2f599d\r\norg.apache.derby.impl.jdbc.EmbedConnection.prepareStatement(Unknown Source)\r\n[trace of custom code removed]\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jn","name":"jn","emailAddress":"jim dot newsham at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Newsham","active":true},"created":"2007-06-05T21:50:12.231+0000","updated":"2007-06-05T21:50:12.231+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12501734","id":"12501734","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"I see that the code in GenericLanguageConnectionContext.addActivation which calls BaseActivation.close was added as part of the DERBY-418 changes. Studying DERBY-418 might lead to some insight about why there is a deadlock here and what conditions are triggering it.\r\n\r\nIn particular, since the DERBY-418 code is attempting to have Derby automatically clean up resources which have accumulated, I wonder if a workaround for this problem could be to change the application to be more aggressive about cleaning up resources. For example, check the application to ensure that ResultSets, Statements, and other JDBC resources are being tracked and closed when they are done?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-06-05T23:02:02.231+0000","updated":"2007-06-05T23:02:02.231+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12501766","id":"12501766","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"body":"The interesting thing in Jim's stack trace, if I am reading this right,  is that thread-20 seems to be calling finish on a prepared statement (GPS@16570ed) which thread-8 is initializing and vice versa. Why do we think this GenericPreparedStatements can be finished off before its seen the light of day?\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"created":"2007-06-06T01:46:41.670+0000","updated":"2007-06-06T01:46:41.670+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12501770","id":"12501770","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jn","name":"jn","emailAddress":"jim dot newsham at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Newsham","active":true},"body":"The attached test case deadlocks pretty quickly for me.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jn","name":"jn","emailAddress":"jim dot newsham at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Newsham","active":true},"created":"2007-06-06T02:23:40.336+0000","updated":"2007-06-06T02:23:40.336+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12501777","id":"12501777","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Thanks Jim for the repro! \r\n\r\nThe test program reproduces a deadlock for me with the current head of trunk.\r\n\r\nA note for others: the test program requires JDK 1.5.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-06-06T02:42:51.112+0000","updated":"2007-06-06T02:42:51.112+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12501786","id":"12501786","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Hi Manish, that is a great point.  I think that calling finish() on a PreparedStatement\r\ndoesn't mean that the entire statement is finished off, just that this particular\r\nactivation is finished off. The activations seem to maintain an \"inUseCount\"\r\nreference count on the statement, and calling finish() for a particular activation\r\njust decrements the reference count, and only reclaims the entire statement if\r\nthe inUseCount has gone to 0.\r\n\r\nIn the case I looked at in the debugger, however, the inUseCount is nowhere close\r\nto 0; it is in fact 60. So the statement is not finished, just this particular activation.\r\n\r\nIt seems that closing an activation requires that we synchronize on the statement\r\nin order to decrement the inUseCount, so this means that as part of initializing\r\na new activation for one statement, we may decide to close an activation for\r\nsome other statement, and since there is no inherent ordering to these reclaimable\r\nactivations, we have the situation that one thread which is trying to initialize an\r\nactivation for statement A is trying to close an activation for statement B, while another\r\nthread which is trying to initialize an activation for statement B is trying to close\r\nan activation for statement A.\r\n\r\nI agree with the assessment that this is a classical deadlock due to a lack of\r\nlock ordering for the synchronization on the various statement objects.\r\n\r\nI can see several possibilities:\r\n - don't try to reclaim activations from inside of addActivation (that is, revert that\r\n   part of the DERBY-418 change). This would of course re-introduce that memory leak.\r\n - Move the code which reclaims activations to some other location, where it is\r\n   safer to call, because we aren't calling it while holding any statements locked.\r\n - Change the code which reclaims activations so that it only closes those\r\n   activations which are for the statement that we already have locked, and not\r\n   for any other statements. This might render this code much less effective.\r\n - Introduce some sort of ordering of statement objects, and only reclaim\r\n   activations for statements which have a higher ordering than ourselves. Since\r\n   the statement locks would then be ordered, the code would not deadlock.\r\n\r\nI'm sure there are a number of other ways to look at this, I just wanted to add my thoughts.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-06-06T04:09:17.381+0000","updated":"2007-06-06T04:09:17.381+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12501963","id":"12501963","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I think there is a workaround for this issue. If the application always closes all of its result sets and statements before they are garbage collected, the offending code in GenericLanguageConnectionContext.addActivation() shouldn't be executed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-06-06T15:39:23.966+0000","updated":"2007-06-06T15:39:23.966+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12501967","id":"12501967","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I think all the possibilities mentioned by Bryan would work. I think (1) and (3) should be avoided, as they will reintroduce DERBY-418. (4) should also work, but it sounds like a complex and/or expensive solution to the problem.\r\n\r\nIf we go for (3) I would suggest moving the check to the end of GenericPreparedStatement.getActivation() and only make the first part of that method synchronized. We could for instance add a closeUnusedActivations() method to the LanguageConnectionContext interface and call it from getActivation(). This would only lock one statement at a time and solve the deadlock problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-06-06T16:06:09.818+0000","updated":"2007-06-06T16:06:09.818+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12501978","id":"12501978","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"upping the priority to critical.  This deadlock in many applications is equivalent or maybe even worse than a crash.  At least with crash locks and other held resources are released and user can try to log in again - here they are stuck.  While there may be a workaround by insuring all statements are closed, the reality is that many users programs have this problem and a deadlock in the field is going to be hard to diagnose and tie to an unclosed statement.  \r\n\r\nAlso working applications may see a regression doing a soft upgrade from 10.0 or  10.1 to 10.2 and releases subsequent to 10.2.   The apps may not  be affected by the memory leak  fixed by DERBY-418 but  be noticably affected by java level synchonization deadlocks that never resollve themselves.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2007-06-06T16:43:21.800+0000","updated":"2007-06-06T16:43:21.800+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12502920","id":"12502920","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"body":"Since nobody has claimed this as yet and its critical, I can take a look. Hopefully I'll have an update early next week. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"created":"2007-06-08T20:26:41.574+0000","updated":"2007-06-08T20:26:41.574+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12503705","id":"12503705","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"body":"Thought I'd update the bug with what I'm trying right now--I think option 2 outlined in Brian's earlier comment is the cleanest in this case. I have moved the cleanup activation code to the constructor for EmbedConnection after the call to getActivation around line ~140 or so.\r\n\r\n\t\t\ttry {\r\n\t\t\t    preparedStatement = lcc.prepareInternalStatement\r\n\t\t\t\t(lcc.getDefaultSchema(), sql, resultSetConcurrency==JDBC20Translation.CONCUR_READ_ONLY, forMetaData);\r\n\t\t\t    \r\n\t\t\t    addWarning(preparedStatement.getCompileTimeWarnings());\r\n\r\n\t\t\t    activation = preparedStatement.getActivation(lcc, resultSetType == JDBC20Translation.TYPE_SCROLL_INSENSITIVE);\r\n\r\n\t\t\t\t// DERBY-2689. Close unused activations here when I'm not inside a monitor.\r\n\t\t\t\tlcc.closeUnusedActivations();\r\n\r\nI've been running the test case for both this bug and DERBY-418 to make sure that we have no deadlocks and no memory leaks.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"created":"2007-06-12T02:28:36.989+0000","updated":"2007-06-12T02:28:36.989+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12507970","id":"12507970","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"body":"I have moved the logic that closes unused activations. Earlier this was done when a activation was initialized and added to a lcc.\r\n\r\nat org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.addActivation(Unknown Source)\r\nat org.apache.derby.impl.sql.execute.BaseActivation.initFromContext(Unknown Source)\r\nat org.apache.derby.impl.services.reflect.LoadedGeneratedClass.newInstance(Unknown Source)\r\nat org.apache.derby.impl.services.reflect.ReflectGeneratedClass.newInstance(Unknown Source)\r\nat org.apache.derby.impl.sql.GenericActivationHolder.<init>(Unknown Source) \r\n\r\nNow it is done by the caller (outside a synchronized block) whenever a statement is prepared or executed in GenericPreparedStatement:getActivation.\r\n\r\nFor testing, I ran the reproduction attached with this bug. Without the bugfix it would deadlock within a few minutes. I let it run all morning and all the threads were making progress before I stopped the threads around noon. I also ran the reproduction with DERBY-418. Without the cleanup code being invoked, the test would run out of memory after about 230K iterations (with 20m heap size). With the bugfix I let it run to about 1m iterations before stopping the process. Also derbylang.\r\n\r\nThe patch was made against trunk. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"created":"2007-06-25T19:57:44.736+0000","updated":"2007-06-25T19:57:44.736+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12508180","id":"12508180","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Hi Manish,\r\n\r\nThank you for working on this issue. I looked at the patch and I have a couple of questions/comments:\r\n\r\n1) Since GenericLanguageConnectionContext.acts now is an unsynchronized ArrayList and not a Vector, is it safe to access/modify it outside the synchronized block?\r\n\r\n2) I noticed that you moved \"unusedActs = false;\" below the loop. I believe that the assignment was placed above the loop deliberately (see Dan's comment 25/Aug/06 on DERBY-418).\r\n\r\n3) There are some lines >80 characters.\r\n\r\n4) Most of the changes in GenericLanguageConnectionContext are pure whitespace changes (adding or removal of trailing blanks). Also, some extra garbage has ended up in the comments, like \"// size exceeds 20.SelectNod3\" and \"(...) true *if*z *all* (...)\"\r\n\r\n5) *Tiny* nit: In GenericPreparedStatement.getActivation(), ac is initialized to null. Since this initial value is not intended to be used, I think it is better to leave the variable uninitialized. The compiler will complain if one tries to use an uninitialized variable, so by setting it to null we actually remove some compile-time error checking.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-06-26T13:57:14.258+0000","updated":"2007-06-26T13:57:14.258+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12508340","id":"12508340","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"body":"Thanks for looking at the patch. \r\n\r\nAs far as 2 goes-- if we set \"unusedActs\" to false at the beginning of the loop and while trying to close all activations, get an exception won't we end up with the case where unusedActs = false, yet there are unused activations which the loop did not get to?\r\n\r\nFor 1, there seems to be no synchronization at all in this class. It is my understanding that a LangugageConnectionContext is scoped within a connection and only one thread may be using a lcc at a given time. Is that correct? The only case seems to be the finalize method of ResultSet which can end up marking \"unsedActs\".\r\n\r\nOn the same note, I'm not sure I understand why we have to do the following:\r\n\r\nfor (int i = acts.size() - 1; i >= 0; i--) {\r\n\r\n\t\t\t// it maybe the case that a reset() ends up closing\r\n\t\t\t// one or more activation leaving our index beyond\r\n\t\t\t// the end of the array\r\n\t\t\tif (i >= acts.size())\r\n\t\t\t\tcontinue;\r\n\r\nCan the acts arraylist  bemodified by multiple threads? Also why don't all other routines employ this extra check? Look for example at lookupCursorActivation, checkIfAnyActivationHasHoldCursor, verifyAllHeldResultSetsAreClosed among others.\r\n\r\nAlso, yes there seem to be some wierd characters which have crept up in the comments. I'll take them out of the next patch.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"created":"2007-06-26T21:38:15.631+0000","updated":"2007-06-26T21:38:15.631+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12508349","id":"12508349","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"> For 1, there seems to be no synchronization at all in this class.\r\n\r\nYes, you're absolutely right. For some reason I kept thinking that it was shared between threads, but lcc is not.\r\n\r\n> As far as 2 goes-- if we set \"unusedActs\" to false at the beginning of the loop and while trying to close all activations, get an exception won't we end up with the case where unusedActs = false, yet there are unused activations which the loop did not get to?\r\n\r\nI think you are right. We risk ending up with an incorrect value no matter where we put the assignment. Since it's really just a hint as to when it could be worthwhile to do the cleanup, I don't think it really matters. If we are leaking activations, the cleanup code will be triggered sooner or later, but there might be more than 20 activations (which is a low number anyway).\r\n\r\n> On the same note, I'm not sure I understand why we have to do the following:\r\n>\r\n> for (int i = acts.size() - 1; i >= 0; i--) {\r\n>\r\n> // it maybe the case that a reset() ends up closing\r\n> // one or more activation leaving our index beyond\r\n> // the end of the array\r\n> if (i >= acts.size())\r\n> continue;\r\n\r\nBaseActivation.close(), which is called further down in the method, calls lcc.removeActivation() which removes only one activation and should therefore not cause any problems. I assume that the reset() method mentioned in the comment is BaseActivation.reset(), but I can't see that it will close any activations, so I believe you are right on this too. Perhaps the comment refers to some old code?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-06-26T22:11:51.340+0000","updated":"2007-06-26T22:11:51.340+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12508388","id":"12508388","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"body":"re: walking the acts list, Dan in DERBY-418, suggested that we recheck if the index is within bounds. http://issues.apache.org/jira/browse/DERBY-418#action_12430512. I can't seem to see why this would be necessary-- Dan, am I missing something? If this is the case, then all the routines that walk acts can be cleaned up, I think.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"created":"2007-06-27T03:04:21.176+0000","updated":"2007-06-27T03:04:21.176+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12508469","id":"12508469","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"If we decide to do the cleanup, I think it should be done in a separate patch (and perhaps a separate JIRA). Since the fix for this issue is likely to go into 10.3, it would be best if we kept the fix as small as possible to reduce the risk of introducing regressions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-06-27T07:58:37.841+0000","updated":"2007-06-27T07:58:37.841+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12508610","id":"12508610","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"body":"agreed-- let me get another patch and then we can think about cleanup.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"created":"2007-06-27T18:18:23.023+0000","updated":"2007-06-27T18:18:23.023+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12508615","id":"12508615","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":">> On the same note, I'm not sure I understand why we have to do the following:\r\n>>\r\n>> for (int i = acts.size() - 1; i >= 0; i--) {\r\n>>\r\n>> // it maybe the case that a reset() ends up closing\r\n>> // one or more activation leaving our index beyond\r\n>> // the end of the array\r\n>> if (i >= acts.size())\r\n>> continue;\r\n> \r\n> BaseActivation.close(), which is called further down in the method, calls lcc.removeActivation() which removes only one activation and should therefore not cause any problems.\r\n\r\nI'm not sure that is correct, that a close on an activation only closes one other activation. Activations can have a relationship to each other, the main case is  a positioned update/delete on a cursor. Closing the cursor may close the positioned statement. Maybe the code has changed such that isn't true, but I wanted to throw it out there as an example. The current code is safe for that situation, so if it is to be changed then that assumption (one close) must be well documented in the code.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2007-06-27T18:26:56.455+0000","updated":"2007-06-27T18:26:56.455+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12509479","id":"12509479","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"body":"Revised patch. I cleaned up some of the spurious characters in the comments, moved setting of unusedActs=false to the top of the loop and reduced some whitespace diffs.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"created":"2007-07-02T03:24:41.297+0000","updated":"2007-07-02T03:24:41.297+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12509496","id":"12509496","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"In addition to setting unusedActs=false on the top of the loop, the patch also sets it on the top of the method. Doesn't this make closeUnusedActivations() a no-op? (Since the body of the method is wrapped in an \"if (unusedActs && ...)\".)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-07-02T06:45:32.798+0000","updated":"2007-07-02T06:45:32.798+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12509745","id":"12509745","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"body":"fyi-- I attached another patch.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"created":"2007-07-03T04:29:55.301+0000","updated":"2007-07-03T04:29:55.301+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12509752","id":"12509752","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks! Seems like you forgot to grant licence to the ASF. Could you please reattach it with grant licence checked.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-07-03T05:57:05.236+0000","updated":"2007-07-03T05:57:05.236+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12509955","id":"12509955","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"body":"another one with license granted. I've already signed an ICLA-- do I still need to do this on a per-attachment basis?!\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkhettry","name":"mkhettry","emailAddress":"manish_khettry at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manish Khettry","active":true},"created":"2007-07-03T17:45:27.560+0000","updated":"2007-07-03T17:45:27.560+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12510102","id":"12510102","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks! Committed revision 553101. I will also merge the changes into the 10.3 branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-07-04T07:36:21.696+0000","updated":"2007-07-04T07:36:21.696+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370141/comment/12510144","id":"12510144","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Committed to 10.3 with revision 553171.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2007-07-04T11:08:20.117+0000","updated":"2007-07-04T11:08:20.117+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2689/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06rtb:"}}
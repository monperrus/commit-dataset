{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12694046","self":"https://issues.apache.org/jira/rest/api/latest/issue/12694046","key":"SOLR-5709","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310230","id":"12310230","key":"SOLR","name":"Solr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310230&avatarId=22151","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310230&avatarId=22151","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310230&avatarId=22151","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310230&avatarId=22151"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10150","id":"10150","description":"Lucene-related projects","name":"Lucene"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12325573","id":"12325573","description":"Major release after 4.6","name":"4.7","archived":false,"released":true,"releaseDate":"2014-02-26"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321664","id":"12321664","description":"Current trunk","name":"Trunk","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-02-10 21:08:04.465","customfield_12312323":null,"customfield_12310420":"372555","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_248357803_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2014-02-10T21:13:14.616+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-5709/watchers","watchCount":2,"isWatching":false},"created":"2014-02-08T00:13:56.847+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324128","id":"12324128","description":"Major release after 4.2","name":"4.3","archived":false,"released":true,"releaseDate":"2013-05-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324324","id":"12324324","description":"Major release after 4.3","name":"4.4","archived":false,"released":true,"releaseDate":"2013-07-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324743","id":"12324743","description":"Major release after 4.4","name":"4.5","archived":false,"released":true,"releaseDate":"2013-10-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12325000","id":"12325000","description":"Major release after 4.5","name":"4.6","archived":false,"released":true,"releaseDate":"2013-11-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321664","id":"12321664","description":"Current trunk","name":"Trunk","archived":false,"released":false}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-03-16T13:03:59.592+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312014","id":"12312014","name":"highlighter","description":"Subsystem that finds matching hits and highlights doc snippets"}],"timeoriginalestimate":null,"description":"In a sharded (non-SolrCloud) deployment, if you index a document with the same unique key value into more than one shard, and then try to highlight grouped docs with more than one doc per group, where the grouped docs contain at least one duplicate doc pair, you get an AIOOBE.\r\n\r\nHere's the stack trace I got from such a situation, with 1 doc indexed into each shard in a 2-shard index, with {{group.limit=2}}:\r\n\r\n{noformat}\r\nERROR null:java.lang.ArrayIndexOutOfBoundsException: 1\r\n\t\tat org.apache.solr.handler.component.HighlightComponent.finishStage(HighlightComponent.java:185)\r\n\t\tat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:328)\r\n\t\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)\r\n\t\tat org.apache.solr.core.SolrCore.execute(SolrCore.java:1916)\r\n\t\tat org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:758)\r\n\t\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:412)\r\n\t\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:202)\r\n\t\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)\r\n\t\tat org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:136)\r\n\t\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)\r\n\t\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:455)\r\n\t\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:229)\r\n\t\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)\r\n\t\tat org.eclipse.jetty.server.handler.GzipHandler.handle(GzipHandler.java:301)\r\n\t\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1077)\r\n\t\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:384)\r\n\t\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)\r\n\t\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1009)\r\n\t\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)\r\n\t\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)\r\n\t\tat org.eclipse.jetty.server.Server.handle(Server.java:368)\r\n\t\tat org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)\r\n\t\tat org.eclipse.jetty.server.AbstractHttpConnection.headerComplete(AbstractHttpConnection.java:942)\r\n\t\tat org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete(AbstractHttpConnection.java:1004)\r\n\t\tat org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:640)\r\n\t\tat org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)\r\n\t\tat org.eclipse.jetty.server.AsyncHttpConnection.handle(AsyncHttpConnection.java:82)\r\n\t\tat org.eclipse.jetty.io.nio.SelectChannelEndPoint.handle(SelectChannelEndPoint.java:628)\r\n\t\tat org.eclipse.jetty.io.nio.SelectChannelEndPoint$1.run(SelectChannelEndPoint.java:52)\r\n\t\tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)\r\n\t\tat org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)\r\n\t\tat java.lang.Thread.run(Thread.java:724)\r\n{noformat}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"372859","summary":"Highlighting grouped duplicate docs from different shards with group.limit > 1 throws ArrayIndexOutOfBoundsException","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":13,"total":13,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694046/comment/13895304","id":"13895304","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"body":"Simple patch fixing the issue, with tests that fail before the fix and succeed afterward.\r\n\r\nHere's what's wrong with the current implementation:\r\n\r\n# In {{TopGroupsShardResponseProcessor.process()}}, when grouped {{ShardDoc}}-s are put into the response's {{resultIds}} unique-key => {{ShardDoc}} map, each {{ShardDoc}}'s {{positionInResponse}} is set assuming that there will be no duplicate unique-key values.  So when a duplicate is added, the {{resultIds}} cardinality doesn't change, but the 1-up {{positionInResponse}} does, and so is thereafter no longer valid.  As a result, when the highlighting component attempts to use {{ShardDoc}}-s' {{positionInResponse}} to index into an array with the same cardinality as {{resultIds}}, an AIOOBE is thrown.\r\n# When duplicate docs replace previous docs in the {{resultIds}} map, the lowest-sorted duplicate is kept, rather than the highest-sorted.\r\n\r\nThe patch fixes both these problems.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"created":"2014-02-08T00:30:41.531+0000","updated":"2014-02-08T00:30:41.531+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694046/comment/13895928","id":"13895928","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"body":"I'll commit tomorrow if there are no objections.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"created":"2014-02-09T17:13:59.404+0000","updated":"2014-02-09T17:13:59.404+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694046/comment/13897007","id":"13897007","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1566743 from [~steve_rowe] in branch 'dev/trunk'\r\n[ https://svn.apache.org/r1566743 ]\r\n\r\nSOLR-5709: Highlighting grouped duplicate docs from different shards with group.limit > 1 throws ArrayIndexOutOfBoundsException","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-02-10T21:08:04.465+0000","updated":"2014-02-10T21:08:04.465+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694046/comment/13897014","id":"13897014","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1566746 from [~steve_rowe] in branch 'dev/branches/branch_4x'\r\n[ https://svn.apache.org/r1566746 ]\r\n\r\nSOLR-5709: Highlighting grouped duplicate docs from different shards with group.limit > 1 throws ArrayIndexOutOfBoundsException (merged trunk r1566743)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-02-10T21:12:47.011+0000","updated":"2014-02-10T21:12:47.011+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694046/comment/13897015","id":"13897015","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"body":"Committed to branch_4x and trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"created":"2014-02-10T21:13:14.640+0000","updated":"2014-02-10T21:13:14.640+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694046/comment/13897359","id":"13897359","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1566914 from [~steve_rowe] in branch 'dev/trunk'\r\n[ https://svn.apache.org/r1566914 ]\r\n\r\nSOLR-5709: add missing license","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-02-11T00:46:13.203+0000","updated":"2014-02-11T00:46:13.203+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694046/comment/13897362","id":"13897362","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"body":"Commit 1566918 from [~steve_rowe] in branch 'dev/branches/branch_4x'\r\n[ https://svn.apache.org/r1566918 ]\r\n\r\nSOLR-5709: add missing license (merged trunk r1566914)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","emailAddress":"no-reply at urd dot zones dot apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true},"created":"2014-02-11T00:47:29.621+0000","updated":"2014-02-11T00:47:29.621+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694046/comment/13903444","id":"13903444","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rtulloh","name":"rtulloh","emailAddress":"rtulloh at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Tulloh","active":true},"body":"With this patch, you don't get AIOOB, but hit count and documents returned do not match.\r\n\r\nI wrote a script to test this. I have 10 documents on one shard. I then duplicated 6 of the documents on another shard. Hit count reports 16, but actual documents returned is 10. I think the values should agree.\r\n\r\nMon Feb 17 12:50:02 2014 numDocs 16 query cost 1.1669998168945312\r\nMon Feb 17 12:50:02 2014 numDocs 0 query cost 0.1399998664855957\r\nDone counted 10\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rtulloh","name":"rtulloh","emailAddress":"rtulloh at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Tulloh","active":true},"created":"2014-02-17T18:53:05.820+0000","updated":"2014-02-17T18:53:05.820+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694046/comment/13903626","id":"13903626","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"body":"Hi Rob,\r\n\r\nbq. With this patch, you don't get AIOOB, but hit count and documents returned do not match.\r\n\r\nTo which hit count are you referring?  \r\n\r\nThe grouped document count reflects all matching documents, including duplicated docs.  Since the returned grouped docs include duplicates, this seems correct to me: the reported count matches the set cardinality.\r\n\r\nWhen highlighting and grouping, I don't see a hit count for the highlighted docs -- I'm guessing it's the highlighted docs that you're referring to when you say \"actual documents returned\".\r\n\r\nCan you attach a response illustrating what you're talking about?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"created":"2014-02-18T00:23:22.791+0000","updated":"2014-02-18T00:23:22.791+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694046/comment/13903755","id":"13903755","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rtulloh","name":"rtulloh","emailAddress":"rtulloh at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Tulloh","active":true},"body":"Thank you for the question. Let me try and explain with an example.\r\n\r\nWe use field collapsing to return all the documents associated with a single ID. We parse the results and apply highlighting for end users to see how their search terms were matched in the returned text. In the case of the test I am running, there are 10 unique IDs to be found. The fact that 6 documents are duplicated should not impact the unique number of groups returned. In fact, that is proven because we count 10 results when we iterate the results. What I would also expect is that the hit count (ngroups) would reflect this. Here is a query result to demonstrate the issue.  Note that the group field is group.field=storageid\r\n\r\n{noformat}\r\n[root@aggregator-1 solr]# wget -O- -q 'http://localhost:8983/solr/select?params={hl.requireFieldMatch=true&group.ngroups=true&group.limit=1000&isPartial=0&hl.simple.pre=<b>&hl.fl=*&wt=xml&hl=true&rows=1&EmsQueryId=INTERNAL&f.mailsubject2.qf=mailsubject&shards=archive-8.ems.labmanager.net:8983/solr,archive-6.ems.labmanager.net:8983/solr&start=0&q=customerid:352&f.body2.qf=body&group.field=storageid&hl.simple.post=</b>&group=true&qt=/search-any&EmsQueryTs=1392658773339}'\r\n{noformat}\r\n\r\nAnd the output. Note the value of matches and ngroups in the output.\r\n\r\n{noformat}\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<response>\r\n<lst name=\"responseHeader\"><int name=\"status\">0</int><int name=\"QTime\">39</int><lst name=\"params\"><str name=\"group.ngroups\">true</str><str name=\"group.limit\">1000</str><str name=\"isPartial\">0</str><str name=\"hl.simple.pre\">&lt;b&gt;</str><str name=\"params\">{hl.requireFieldMatch=true</str><str name=\"hl.fl\">*</str><str name=\"wt\">xml</str><str name=\"hl\">true</str><str name=\"rows\">1</str><str name=\"EmsQueryId\">INTERNAL</str><str name=\"f.mailsubject2.qf\">mailsubject</str><str name=\"shards\">archive-8.ems.labmanager.net:8983/solr,archive-6.ems.labmanager.net:8983/solr</str><str name=\"start\">0</str><str name=\"q\">customerid:352</str><str name=\"f.body2.qf\">body</str><str name=\"group.field\">storageid</str><str name=\"hl.simple.post\">&lt;/b&gt;</str><str name=\"group\">true</str><str name=\"qt\">/search-any</str><str name=\"EmsQueryTs\">1392658773339}</str></lst></lst><lst name=\"grouped\"><lst name=\"storageid\"><int name=\"matches\">16</int><int name=\"ngroups\">16</int><arr name=\"groups\"><lst><long name=\"groupValue\">43937</long><result name=\"doclist\" numFound=\"1\" start=\"0\" maxScore=\"7.0955024\"><doc><str name=\"contentid\">43937</str><int name=\"senderid\">12759</int><arr name=\"recipientids\"><int>12741</int></arr><long name=\"storageid\">43937</long><date name=\"receiveddate\">2000-12-12T11:07:00Z</date><str name=\"mailfrom\">donna.martens@enron.com</str><str name=\"envsender\">donna.martens@enron.com</str><str name=\"mailto\">sharon.solon@enron.com </str><int name=\"partitionid\">1</int><str name=\"indexlevel\">0</str><str name=\"mailcc\">david.roensch@enron.com rich.jolly@enron.com maria.pavlou@enron.com dorothy.mccoppin@enron.com kevin.hyatt@enron.com mary.darveaux@enron.com lorraine.lindberg@enron.com steven.harris@enron.com drew.fossum@enron.com earl.chanley@enron.com ronald.matthews@enron.com arnold.eisenstein@enron.com jerry.martin@enron.com patrick.brennan@enron.com dave.waymire@enron.com keith.petersen@enron.com </str><int name=\"importance\">1</int><date name=\"emaildate\">2000-12-12T11:07:00Z</date><int name=\"customerid\">352</int><int name=\"igen1\">0</int><int name=\"totalsize\">3780</int><bool name=\"isattachment\">false</bool><str name=\"mime\">text/plain</str><int name=\"clusterlocationid\">102</int><int name=\"islandid\">101</int><int name=\"size\">2240</int><str name=\"language\">en</str><str name=\"mailsubject_en\">Re: Gallup Expansion</str><str name=\"mailsubject2_en\">Re: Gallup Expansion</str><long name=\"_version_\">1460308152307154944</long><date name=\"processingtime\">2014-02-17T17:32:58.887Z</date></doc></result></lst></arr></lst></lst><lst name=\"highlighting\"><lst name=\"43937\"/></lst>\r\n</response>\r\n{noformat}\r\n\r\nThere are exactly 10 unique results associated with that field. I can understand matches being 16 (the number of documents matching the query), but I would expect ngroups to be 10 for the number of unique groups being returned. Our code reads ngroups and returns this as the hit count for the query so that we report to the caller the number of unique hits observed.\r\n\r\nI hope I have made it clear. Please let me know if I can answer any more questions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rtulloh","name":"rtulloh","emailAddress":"rtulloh at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Tulloh","active":true},"created":"2014-02-18T03:55:07.077+0000","updated":"2014-02-18T03:55:07.077+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694046/comment/13903776","id":"13903776","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rtulloh","name":"rtulloh","emailAddress":"rtulloh at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Tulloh","active":true},"body":"Here is an example where we get the result we expect (no duplicates involved):\r\n\r\nIn this case 3 documents map to the same storageid parent. Notice that in this result, matches is 3 (number of documents) and ngroups is 1 (the number of unique results):\r\n\r\n{noformat}\r\n<lst name=\"responseHeader\"><int name=\"status\">0</int><int name=\"QTime\">194</int><lst name=\"params\"><str name=\"group.ngroups\">true</str><str name=\"group.limit\">1000</str><str name=\"isPartial\">0</str><str name=\"hl.simple.pre\">&lt;b&gt;</str><str name=\"params\">{hl.requireFieldMatch=true</str><str name=\"hl.fl\">*</str><str name=\"wt\">xml</str><str name=\"hl\">true</str><str name=\"rows\">1</str><str name=\"EmsQueryId\">INTERNAL</str><str name=\"f.mailsubject2.qf\">mailsubject</str><str name=\"shards\">archive-8.ems.labmanager.net:8983/solr,archive-6.ems.labmanager.net:8983/solr</str><str name=\"start\">0</str><str name=\"q\">customerid:352</str><str name=\"f.body2.qf\">body</str><str name=\"group.field\">storageid</str><str name=\"hl.simple.post\">&lt;/b&gt;</str><str name=\"group\">true</str><str name=\"qt\">/search-any</str><str name=\"fq\">{!lucene}storageid:{44414 TO 44415]</str><str name=\"EmsQueryTs\">1392658773339}</str></lst></lst><lst name=\"grouped\"><lst name=\"storageid\"><int name=\"matches\">3</int><int name=\"ngroups\">1</int><arr name=\"groups\"><lst><long name=\"groupValue\">44415</long><result name=\"doclist\" numFound=\"3\" start=\"0\" maxScore=\"2.8401346\">\r\n{noformat}\r\n\r\nWhat puzzles me is why the result with duplicates doesn't group the same way. Clearly, this result shows it does work without duplicates involved. Is there an explanation for why this is the case?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rtulloh","name":"rtulloh","emailAddress":"rtulloh at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Tulloh","active":true},"created":"2014-02-18T04:40:19.626+0000","updated":"2014-02-18T04:40:19.626+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694046/comment/13904063","id":"13904063","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"body":"Rob,\r\n\r\nI see what you mean: ngroups should be the same as the number of groups.  This problem still happens when I don't request highlighting, so it appears to be a problem with grouping only.\r\n\r\nThis may be related to a known issue - from the {{group.ngroups}} description on [http://wiki.apache.org/solr/FieldCollapsing]:\r\n\r\n{quote}\r\nWARNING: If this parameter is set to true on a sharded environment, all the documents that belong to the same group have to be located in the same shard, otherwise the count will be incorrect. If you are using SolrCloud, consider using \"custom hashing\"\r\n{quote}\r\n\r\nI'll do some more testing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_rowe","name":"steve_rowe","emailAddress":"sarowe at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Rowe","active":true},"created":"2014-02-18T14:05:23.258+0000","updated":"2014-02-18T14:05:23.258+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694046/comment/13904280","id":"13904280","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rtulloh","name":"rtulloh","emailAddress":"rtulloh at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Tulloh","active":true},"body":"Thanks for reminding to look back at the documentation. I agree that the duplicates are likely the cause of the unexpected counts because the duplicates live on different shards. The field collapsing wiki does document this limitation.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rtulloh","name":"rtulloh","emailAddress":"rtulloh at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Tulloh","active":true},"created":"2014-02-18T17:25:18.192+0000","updated":"2014-02-18T17:25:18.192+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/SOLR-5709/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1s7dz:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12445530","self":"https://issues.apache.org/jira/rest/api/latest/issue/12445530","key":"MAHOUT-247","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310751","id":"12310751","key":"MAHOUT","name":"Mahout","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310751&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310751&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310751&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310751&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13060","id":"13060","description":"Apache Mahout","name":"Mahout"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314281","id":"12314281","description":"","name":"0.3","archived":false,"released":true,"releaseDate":"2010-03-17"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-01-14 17:30:55.867","customfield_12312323":null,"customfield_12310420":"9818","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_26580541_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2010-01-15T00:40:21.848+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAHOUT-247/watchers","watchCount":0,"isWatching":false},"created":"2010-01-14T17:17:21.307+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12312330":null,"customfield_12311120":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313278","id":"12313278","description":"","name":"0.2","archived":false,"released":true,"releaseDate":"2009-11-18"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-05-21T03:23:51.814+0000","customfield_12312335":null,"customfield_12312336":null,"customfield_12311720":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312503","id":"12312503","name":"Collaborative Filtering","description":"Taste and any other CF stuff"}],"timeoriginalestimate":null,"description":"\t\t\tUserSimilarity userSimilarity = new TanimotoCoefficientSimilarity(getBooleanPrefDataModel());\r\n\t\t\tUserNeighborhood neighborhood = new NearestNUserNeighborhood(3, userSimilarity, getBooleanPrefDataModel());\r\n\t\t\tRecommender recommender = new GenericBooleanPrefUserBasedRecommender(getBooleanPrefDataModel(), neighborhood, userSimilarity);\r\n                        recommender.recommend(userwithnopreferencesdata, 10);\r\n\r\ncode properly throws NoSuchUserException however one of the connections is hang on LongPrimitiveIterator backed by org.apache.mahout.cf.taste.impl.model.jdbc.AbstractJDBCDataModel$ResultSetIDIterator as Exception is thrown before TopItems.getTopUsers finishes the while loop \r\n\r\npublic static long[] getTopUsers(int howMany,\r\n                                   LongPrimitiveIterator allUserIDs,\r\n                                   Rescorer<Long> rescorer,\r\n                                   Estimator<Long> estimator) throws TasteException {\r\n    Queue<SimilarUser> topUsers = new PriorityQueue<SimilarUser>(howMany + 1, Collections.reverseOrder());\r\n    boolean full = false;\r\n    double lowestTopValue = Double.NEGATIVE_INFINITY;\r\n//HERE IS THE ITERATOR\r\n    while (allUserIDs.hasNext()) {\r\n      long userID = allUserIDs.next();\r\n      if (rescorer != null && rescorer.isFiltered(userID)) {\r\n        continue;\r\n      }\r\n\r\n//EXCEPTION THROWN HERE CAUSES THE CONNECTION LEAK\r\n      double similarity = estimator.estimate(userID);\r\n      double rescoredSimilarity = rescorer == null ? similarity : rescorer.rescore(userID, similarity);\r\n      if (!Double.isNaN(rescoredSimilarity) && (!full || rescoredSimilarity > lowestTopValue)) {\r\n        topUsers.add(new SimilarUser(userID, similarity));\r\n        if (full) {\r\n          topUsers.poll();\r\n        } else if (topUsers.size() > howMany) {\r\n          full = true;\r\n          topUsers.poll();\r\n        }\r\n        lowestTopValue = topUsers.peek().getSimilarity();\r\n      }\r\n    }\r\n    if (topUsers.isEmpty()) {\r\n      return NO_IDS;\r\n    }\r\n    List<SimilarUser> sorted = new ArrayList<SimilarUser>(topUsers.size());\r\n    sorted.addAll(topUsers);\r\n    Collections.sort(sorted);\r\n    long[] result = new long[sorted.size()];\r\n    int i = 0;\r\n    for (SimilarUser similarUser : sorted) {\r\n      result[i++] = similarUser.getUserID();\r\n    }\r\n    return result;\r\n  }\r\n\r\n============================================================================================================\r\nI currently fixed it in our application by checking first to see if user has preferences for the given dataset (user might exists and have preferences for a different dataset).\r\n\r\nHowever this edge case does not cause issues in some other recommenders as long as we handle the NoSuchUserException.\r\n\r\nEasy solution is to use AbstractJDBCDataModel$ResultSetIDIterator always with try/catch/finally and release the connection.\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"23171","summary":"GenericUserBasedRecommender.recommend causes connection leak when called for user with no preferences","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tolga_oral%40us.ibm.com","name":"tolga_oral@us.ibm.com","emailAddress":"tolga_oral at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tolga Oral","active":true},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tolga_oral%40us.ibm.com","name":"tolga_oral@us.ibm.com","emailAddress":"tolga_oral at us dot ibm dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tolga Oral","active":true},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Reproducable on Win32 and Ubuntu","customfield_12311020":null,"duedate":"2010-01-21","customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":3,"total":3,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445530/comment/12800262","id":"12800262","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"body":"Good one. I will review this and come up with a proper fix. The iterator needs to be 'closed' in cases like this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"created":"2010-01-14T17:30:55.867+0000","updated":"2010-01-14T17:30:55.867+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445530/comment/12800466","id":"12800466","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"body":"This is actually very messy to really fix -- LongPrimitiveIterator is used in a lot of places, and to make sure it's \"drained\" in all exception cases would make quite a mess of the code.\r\n\r\nI did add a finalize() method to the implementations which are based on a JDBC connection, to close the connection. This doesn't really fix anything but at least may get the connection closed via finalization somewhat faster.\r\n\r\nWhile I think it's hard to actually guarantee closing the connection immediately on all exception paths, it's relatively easy to apply fixes that would avoid the cases that would actually probably cause problems, such as the code you cite above.\r\n\r\nI think my best bet at a fix here is to apply your change and related changes in key parts of the code and leave it at that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"created":"2010-01-15T00:36:00.705+0000","updated":"2010-01-15T00:36:00.705+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445530/comment/12800467","id":"12800467","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"body":"Tentatively resolving this after applying a fix to the most obvious case where this issue could come up. It's not truly fixed in all cases, though at the moment, I think this is all that is practical to attempt. I'm open to more suggestions about how to address this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srowen","name":"srowen","emailAddress":"srowen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=srowen&avatarId=10104","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=srowen&avatarId=10104","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=srowen&avatarId=10104","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=srowen&avatarId=10104"},"displayName":"Sean Owen","active":true},"created":"2010-01-15T00:40:21.823+0000","updated":"2010-01-15T00:40:21.823+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAHOUT-247/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i04brj:"}}
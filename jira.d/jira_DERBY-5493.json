{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12530574","self":"https://issues.apache.org/jira/rest/api/latest/issue/12530574","key":"DERBY-5493","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2012-03-27 16:12:28.605","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"216312","customfield_12310222":"1_*:*_1_*:*_14267930633_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-04-20T17:15:55.045+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5493/watchers","watchCount":1,"isWatching":false},"created":"2011-11-07T13:57:04.615+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":["derby_backport_reject_10_8","derby_triage10_9"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"7.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313727","id":"12313727","description":"Feature release","name":"10.6.1.0","archived":false,"released":true,"releaseDate":"2010-05-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315343","id":"12315343","description":"Derby 10.6.2.1 Release","name":"10.6.2.1","archived":false,"released":true,"releaseDate":"2010-10-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315564","id":"12315564","description":"First release on the 10.7 branch.","name":"10.7.1.1","archived":false,"released":true,"releaseDate":"2010-12-14"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316362","id":"12316362","description":"First release on the 10.8 branch","name":"10.8.1.2","archived":false,"released":true,"releaseDate":"2011-04-29"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12317968","id":"12317968","description":"second release on the 10.8 branch","name":"10.8.2.2","archived":false,"released":true,"releaseDate":"2011-10-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12345341","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12345341","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12530579","key":"DERBY-5495","self":"https://issues.apache.org/jira/rest/api/2/issue/12530579","fields":{"summary":"Master issue to track fixes to sequence generators","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12350515","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12350515","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12440016","key":"DERBY-4437","self":"https://issues.apache.org/jira/rest/api/2/issue/12440016","fields":{"summary":"Concurrent inserts into table with identity column perform poorly","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}},{"id":"12350729","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12350729","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12551640","key":"DERBY-5697","self":"https://issues.apache.org/jira/rest/api/2/issue/12551640","fields":{"summary":"Doc changes to account for correctness fixes for sequences","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-06-14T17:19:49.835+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"The following script shows the same value being returned from a sequence generator by two successive NEXT VALUE FOR calls. Thanks to Knut for finding this:\r\n\r\nconnect 'jdbc:derby:memory:db;create=true';\r\n\r\ncreate table t (x int);\r\ncreate sequence s;\r\nautocommit off;\r\nselect count(*) from sys.syssequences with rs;\r\nvalues next value for s;\r\ndrop table t;\r\nrollback;\r\n\r\n-- same value as previous call\r\nvalues next value for s; \r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10367","value":"Deviation from standard","id":"10367"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10366","value":"Wrong query result","id":"10366"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"35454","summary":"Same value returned by successive calls to a sequence generator.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10102","value":"Patch Available","id":"10102"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10101","value":"Release Note Needed","id":"10101"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":26,"total":26,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13239522","id":"13239522","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-5493-01-aa-correctnessPlusPeekerPlusTest.diff. This patch modifies how we allocate new sequence values, in order to fix the known correctness problems with sequence generation. Regression tests pass cleanly for me, but this patch is not ready for commit. It needs additional tests to verify correctness, upgrade, and new user-visible features.\r\n\r\nMike and I discussed the correctness problems on DERBY-5443. Two proposals were put forward, each of which had its own messy issues:\r\n\r\n1) Use an invisible conglomerate and dedicated transaction to allocate new sequence ranges. This is the approach taken by this patch.\r\n\r\n2) Restrict the isolation level used to read from SYSSEQUENCES.\r\n\r\nIn that discussion, two problems with approach (1) were identified:\r\n\r\ni) It creates a new file (the invisible conglomerate). I think that the space occupied by this new file is very small compared to the size of an empty Derby database and well within the growth we have tolerated for Derby feature releases over the last 7 years.\r\n\r\nii) Orphaned tuples can pile up in the invisible conglomerate after successful DROP SEQUENCE and unsuccessful CREATE SEQUENCE statements. I addressed this problem by garbage-collecting the orphans at database boot time.\r\n\r\nIn addition to fixing the known correctness problem, this patch introduces the following user-visible changes:\r\n\r\nA) A new system function has been added: syscs_peek_at_sequence(). This function gives the application the instantaneous current value of the sequence. In previous releases, users tried to get this information by querying SYSSEQUENCES.CURRENTVALUE. But that didn't work because that column holds the end of the pre-allocation range and not the actual next value in the sequence.\r\n\r\nB) SYSCONGLOMERATES.TABLEID is now nullable.\r\n\r\nC) A new SYSGHOST conglomerate is listed in SYSCONGLOMERATES. The SYSGHOST conglomerate does not belong to any corresponding table. Although users can't see it, this is the shape of a SYSGHOST tuple:\r\n\r\n  ( keycol varchar( 32672 ), payload Formatable )\r\n\r\n\r\nIn addition, this patch introduces a testing/diagnostic feature which we should not document:\r\n\r\nD) A new GhostTable VTI has been added. This lets you view the contents of SYSGHOST. The VTI does all of its work in the transaction controller that is dedicated to managing SYSGHOST. Here's how you invoke it:\r\n\r\n    select * from new org.apache.derby.diag.GhostTable() vti;\r\n\r\nBehind the scenes, this patch introduces some other new objects:\r\n\r\nE) GhostController, a synchronized object for reading/writing SYSGHOST tuples.\r\n\r\nF) A new Formatable to hold the end of a pre-allocation range: SequenceState.\r\n\r\nG) A new sequence updater for use on databases at level 10.9 or higher: SyssequenceUpdater_10_9.\r\n\r\nMost of the complexity of the patch is in the implementation of GhostController. Extra support code was added to DataDictionaryImpl and SyssequenceUpdater_10_9, but I tried to isolate most of the trickiness in GhostControllerImpl.\r\n\r\nThis patch will require some changes to the Reference Manual:\r\n\r\nDOC-1) Add a section describing the new syscs_peek_at_sequence() function.\r\n\r\nDOC-2) Modify the section on SYSCONGLOMERATES to state that TABLEID is nullable.\r\n\r\nDOC-3) Modify the section on SYSSEQUENCES to state that users should not bother querying the CURRENTVALUE column. Instead, they should use syscs_peek_at_sequence() to peek at the instantaneous current value of a sequence generator.\r\n\r\nThis patch will require a release note explaining that users should use syscs_peek_at_sequence() rather than SYSSEQUENCES.CURRENTVALUE.\r\n\r\n\r\n\r\nTouches the following files:\r\n\r\n--------------\r\n\r\nM       java/engine/org/apache/derby/iapi/services/io/RegisteredFormatIds.java\r\nM       java/engine/org/apache/derby/iapi/services/io/StoredFormatIds.java\r\nA       java/engine/org/apache/derby/iapi/sql/dictionary/SequenceState.java\r\n\r\nNew Formatable to hold the end of pre-allocation ranges.\r\n\r\n--------------\r\n\r\nM       java/engine/org/apache/derby/iapi/sql/dictionary/DataDescriptorGenerator.java\r\nA       java/engine/org/apache/derby/iapi/sql/dictionary/GhostDescriptor.java\r\n\r\nNew tuple describing a row in SYSGHOST.\r\n\r\n--------------\r\n\r\nM       java/engine/org/apache/derby/iapi/sql/dictionary/CatalogRowFactory.java\r\nM       java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java\r\nM       java/engine/org/apache/derby/impl/sql/catalog/SYSCONGLOMERATESRowFactory.java\r\nM       java/engine/org/apache/derby/impl/sql/catalog/DD_Version.java\r\n\r\nSupport for creating SYSGHOST and deleting orphans.\r\n\r\n--------------\r\n\r\nM       java/engine/org/apache/derby/iapi/sql/dictionary/DataDictionary.java\r\nM       java/storeless/org/apache/derby/impl/storeless/EmptyDictionary.java\r\nA       java/engine/org/apache/derby/iapi/sql/dictionary/GhostController.java\r\nA       java/engine/org/apache/derby/impl/sql/catalog/GhostControllerImpl.java\r\n\r\nLogic to manage SYSGHOST.\r\n\r\n--------------\r\n\r\nM       java/engine/org/apache/derby/catalog/SystemProcedures.java\r\n\r\nLogic for new syscs_peek_at_sequence() procedure.\r\n\r\n--------------\r\n\r\nA       java/engine/org/apache/derby/diag/GhostTable.java\r\nM       tools/jar/extraDBMSclasses.properties\r\n\r\nNew diagnostic VTI for viewing SYSGHOST.\r\n\r\n--------------\r\n\r\nM       java/engine/org/apache/derby/impl/sql/catalog/SequenceUpdater.java\r\n\r\nNew sequence updater for use on databases at level 10.9 and higher.\r\n\r\n--------------\r\n\r\nM       java/engine/org/apache/derby/impl/sql/execute/CreateSequenceConstantAction.java\r\n\r\nAdd a corresponding SYSGHOST tuple when creating a sequence. If the create action is rolled back, then the SYSGHOST tuple will be garbage-collected the next time the database boots.\r\n\r\n--------------\r\n\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/lang/SequenceGeneratorTest.java\r\n\r\nSlight change to use GhostTable rather than SYSSEQUENCES.CURRENTVALUE in order to view the end of pre-allocation ranges.\r\n\r\n--------------\r\n\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/lang/RolesTest.java\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/lang/SystemCatalogTest.java\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/lang/GrantRevokeDDLTest.java\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/jdbc4/TestDbMetaData.java\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/upgradeTests/Changes10_2.java\r\nM       java/testing/org/apache/derbyTesting/functionTests/master/ij7.out\r\n\r\nTest changes to account for the metadata changes.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-03-27T14:44:30.767+0000","updated":"2012-03-27T14:44:30.767+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13239591","id":"13239591","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"i will spend some time commenting more in full, but wanted to post a quick response.  I do not think the extra complexity being proposed\r\nin the patch is warranted, I may be missing the benefits of the implemented patch.  In the end I think we are adding hidden conglomerates, extra boot time work, more database activity to handle\r\none case where user queries the system catalogs directly causing problems for that transaction.   I don't know why users are doing this.  I see\r\nthat this patch includes some new derby specific interfaces, that maybe will stop users from doing that.  For all other cases I believe there\r\nare much easier changes that don't require such complex changes.   \r\n\r\nMy problems with that solution:\r\no yet another system catalog, now we would have 2 for sequences\r\no A hidden system catalog is going to present even more problems for users if there is a problem with it.  How do run maintenance on it\r\n   if necessary.  How do you tell if there is a problem with it?\r\no I can't tell from the patch description, but previous description of this approach seemed to be funneling all sequence work to a single \r\n   thread/transaction.  This is the wrong architectural direction for derby, we should always be looking to spread this work across many threads,\r\n   as does current implementation where work is done in the user thread.\r\no brand new boot time work.  I would rather not add sql layer garbage collection to the architecture.\r\n  I know there are existing applications that boot quite often, and any additional work at boot time will cause\r\n   the performance issues.  \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-03-27T16:12:28.605+0000","updated":"2012-03-27T16:12:28.605+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13239613","id":"13239613","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks for the quick analysis, Mike. Some responses follow:\r\n\r\n>o yet another system catalog, now we would have 2 for sequences\r\n\r\nMore files are bad, I understand. But this would be similar to adding another index on syssequences, which is well within the bounds of what we do during a feature release.\r\n\r\n> o A hidden system catalog is going to present even more problems for users if there is a problem with it.  How do run maintenance on it if necessary.  How do you tell if there is a problem with it?\r\n\r\nAnother valid question. I see it as being similar to the property conglomerate. How do we do maintenance on the property conglomerate? With SYSGHOST there is a diagnostic VTI for inspecting it and looking for problems, so I think we are in a better situation than we are with the property conglomerate.\r\n\r\n>o I can't tell from the patch description, but previous description of this approach seemed to be funneling all sequence work to a single  thread/transaction.  This is the wrong architectural direction for derby, we should always be looking to spread this work across many threads, as does current implementation where work is done in the user thread.\r\n\r\nIt's true that everything happens in a single transaction controller. However, a thread switch does not happen. Instead, a context manager is pushed and popped around the use of the shared transaction controller. It's also true that calls to the GhostController are synchronized, which will single-thread access to SYSGHOST. We could introduce a separate transaction controller per sequence and synchronize on those sequence-specific transaction controllers. The additional single-threading introduced by the current patch funnels all pre-allocation requests for all sequences through the same chokepoint. This might be an issue for an application which has small pre-allocation ranges and many sequences. I don't know how typical that usage will be or whether it is worth the extra complexity of more transaction controllers.\r\n\r\n>o brand new boot time work.  I would rather not add sql layer garbage collection to the architecture. I know there are existing applications that boot quite often, and any additional work at boot time will cause the performance issues.  \r\n\r\nI doubt that this extra boot cost will be measurable. However, we could add an initial tuple to SYSGHOST which would flag whether there was any boot-time work to do. This would reduce the extra boot cost to one page read.\r\n\r\nThanks,\r\n-Rick\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-03-27T16:42:08.975+0000","updated":"2012-03-27T16:42:08.975+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13241269","id":"13241269","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-5493-01-ab-plusMoreTests.diff. This rev of the patch adds tests for correctness, user-visible features, and garbage collection. Regression tests passed cleanly for me.\r\n\r\nMy plan going forward is to address Mike's concerns:\r\n\r\n1) I will add a header tuple to SYSGHOST so that the boot-time expense of garbage collection is reduced to one page read in most situations.\r\n\r\n2) I will test the concurrency of this solution. If the single transaction controller turns out to be a bottleneck, then I will try adding a transaction controller per sequence.\r\n\r\n\r\n\r\nTouches the following additional files:\r\n\r\n----------\r\n\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/upgradeTests/Changes10_9.java\r\n\r\nVarious upgrade tests.\r\n\r\n----------\r\n\r\nA       java/testing/org/apache/derbyTesting/functionTests/tests/lang/t_5494.sh\r\n\r\nThis is a standalone test for the related correctness bug, DERBY-5494. I didn't wire this test into the JUnit test runs because the test case requires that you crash the VM.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-03-29T14:33:40.616+0000","updated":"2012-03-29T14:33:40.616+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13241580","id":"13241580","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"Rick Hillegas (Commented) (JIRA) wrote:\r\n>     [ https://issues.apache.org/jira/browse/DERBY-5493?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel&focusedCommentId=13239613#comment-13239613 ]\r\n> Rick Hillegas commented on DERBY-5493:\r\n> --------------------------------------\r\n>\r\n> Thanks for the quick analysis, Mike. Some responses follow:\r\n>> o yet another system catalog, now we would have 2 for sequences\r\n>\r\n> More files are bad, I understand. But this would be similar to adding another index on syssequences, which is well within the bounds of what we do during a feature release.\r\n>\r\nWe do continue to keep adding to problem here.  This is yet another catalog that is added to db, and everyone has to pay for it even if they\r\ndon't use the sequence feature.  I know \"1\" more does not sound like a problem, but I don't think it is the right direction for derby.\r\n\r\nI know that there are applications out there that use 1000's of databases.  We have definitely gotten complaints from users in the past just for having 1 background thread per database.  Every resource we add\r\non a per database level can get multiplied in some applications, and it\r\nis sad to add these overheads when the application is not even using the\r\nfeature.  I have the same problem with the new authorization work.  I understand that the system has current problems in this area (roles), but we should not keep digging bigger holes.\r\n>> o A hidden system catalog is going to present even more problems for users if there is a problem with it.  How do run maintenance on it if necessary.  How do you tell if there is a problem with it?\r\n>\r\n> Another valid question. I see it as being similar to the property conglomerate. How do we do maintenance on the property conglomerate? With SYSGHOST there is a diagnostic VTI for inspecting it and looking for problems, so I think we are in a better situation than we are with the property conglomerate.\r\n>\r\nAnd property conglomerate is a current problem, lets not add to it.  At least with property conglomerate the expectation is very low utilization and there are just not that many properties for the database.  I think the utilization of this new catalog is unbounded, with size relative to\r\nnumber of sequences, and maybe number of auto generated keys.\r\n>> o I can't tell from the patch description, but previous description of this approach seemed to be funneling all sequence work to a single  thread/transaction.  This is the wrong architectural direction for derby, we should always be looking to spread this work across many threads, as does current implementation where work is done in the user thread.\r\n>\r\n> It's true that everything happens in a single transaction controller. However, a thread switch does not happen. Instead, a context manager is pushed and popped around the use of the shared transaction controller. It's also true that calls to the GhostController are synchronized, which will single-thread access to SYSGHOST. We could introduce a separate transaction controller per sequence and synchronize on those sequence-specific transaction controllers. The additional single-threading introduced by the current patch funnels all pre-allocation requests for all sequences through the same chokepoint. This might be an issue for an application which has small pre-allocation ranges and many sequences. I don't know how typical that usage will be or whether it is worth the extra complexity of more transaction controllers.\r\nok, sounds like the thread issue is not a problem.  If we go with this solution, i would like to understand why a shared single transaction is needed.  Seems like we should just create a new context as we need it.\r\n>\r\n>> o brand new boot time work.  I would rather not add sql layer garbage collection to the architecture. I know there are existing applications that boot quite often, and any additional work at boot time will cause the performance issues.  \r\n>\r\n> I doubt that this extra boot cost will be measurable. However, we could add an initial tuple to SYSGHOST which would flag whether there was any boot-time work to do. This would reduce the extra boot cost to one page read.\r\n>\r\nI would rather see no boot time work, sounds like more complication for not enough benefit.\r\n\r\nI think sequences are new enough that we could implement the following as a fix:\r\no do all sequence work, including creating them in a nested transaction  as we did before or in this new context that you have created.\r\n  wait on all locks in this nested transaction and throw an error if we\r\n  timeout - don't escalate.  The error should not be a generic lock timeout error, it should include warnings that sequence generation can fail if users do direct system catalog selects.\r\n\r\nI think this would fix the correctness issue, and solve the \"normal\" lock contention issue on sequence generation across threads.  It would\r\nmean sequence creation is autocommitted, which if I understand it is more in keeping with the standard, and would avoid the problem of user\r\nthread holding locks on system catalogs as part of creating sequences.\r\n\r\nI think the new interface you have as part of your patch would make it even less likely that users would interfere with sequences by doing\r\ndirect system catalog selects. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-03-29T19:56:19.562+0000","updated":"2012-03-29T19:56:19.562+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13242571","id":"13242571","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"Long term I believe the goal should be to design a solution for sequences that can also be used for generated keys.  I agree with kathey\r\nthat we should look at a phased approach with sequence implementation first and identity column in a subsequent release.  So am going\r\nto talk about that here, though the jira issue is about sequences.\r\n\r\nI think a simple solution that does the following would address both correctness and performance issues:\r\no all \"next\" operations, including ddl to create them always happen in a nested transaction and they should at worst get 1 lock on 1 row\r\n   in a system catalog.  I am leaning now that that catalog can not be SYSCOLUMNS as this catalog is just to intertwined with other\r\n   ddl operations.  I am hoping that it can be SYSSEQUENCES.\r\no these operations should be scalable as possible and be designed to allow good performance for large number of thread across large\r\n   number of processors  across a large number of sequences and generated keys.\r\n\r\nAbove I described what I hope works for sequences, basically just move all current sequence operations into nested transaction - need to\r\nverify a create sequence only adds a single row to a sequence catalog.  Doing all work for sequences in a nested transaction I think \r\neliminates the whole garbage collection issue.  Never escalate, throw errors on lock timeouts/deadlocks.  By not escalating we eliminate\r\nthe correctness problems with escalating.\r\n\r\ngenerated keys are not as easy as we can't just move all create tables into nested transactions.  My proposal here is that create\r\ntable does not do anything with SYSSEQUENCES, it delays the addition of a row to sequence catalog until first insert.  Again all\r\noperation next operations are done same as above proposal for sequences. \r\nnote: I think drop table is one exception where we will get lock on sequence row in user transaction, but that seems ok as no\r\none should be doing anything on table once we have the table exclusive lock on drop table.  and also note drop table needs to\r\nhandle the sequence row existing or not, both are valid.  \r\nnote2: i think a serialized isolation level is needed to handle on demand creation of the sequences row, to handle two threads trying\r\n          to create the row.\r\n\r\nI hope current sequence catalog can either support this now, or can with an upgrade.  If we feel we need another catalog I would rather\r\nsee it designed as a replacement for the sequence catalog(s).  At least then new databases only have what is needed, or maybe we\r\ncan even get rid of old catalog on hard upgrade.\r\n\r\nThis proposal is not addressing feature of the ghost catalog that prevents users from getting locks on the catalogs by scanning\r\nthem directly.  I am ok with throwing errors on lock timeouts and calling out the likely cause.  Long term it would be better to somehow turn all system catalogs into \"ghosts\" with respect at least to unintended lock interactions from user direct access. maybe we could change\r\nsystem to not get locks on system catalogs direct scans by users. Maybe we should beef up the documentation on not supporting\r\ndirect access to system catalogs and call out locking issues.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-03-30T17:31:10.581+0000","updated":"2012-03-30T17:31:10.581+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13242606","id":"13242606","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks for continuing the discussion, Mike. I think we may be converging on a simpler solution. I need to think some more about this but I agree that a phased approach is probably safest. I also agree that a common approach which handles both sequences and identity columns is desirable. Some quick responses:\r\n\r\nHere's a modification of your proposal:\r\n\r\n1) We eliminate the ghost catalog.\r\n\r\n2) But we dedicate a special transaction controller per sequence. All operations (except ddl) on a SYSSEQUENCES tuple happen in the transaction controller which is dedicated to that row. We could also experiment with a single sequence-controlling transaction if people think that the cost of multiple transaction controllers is too high.\r\n\r\n3) We will tell users to stop trying to query SYSSEQUENCES and to, instead, use the new syscs_peek_at_sequence() function. That function will do its work in the transaction controller which is dedicated to the  corresponding SYSSEQUENCES tuple.\r\n\r\n4) The NEXT VALUE FOR invocation will, if necessary, pre-allocate a new range in the SYSSEQUENCE row by using the row's dedicated transaction controller. Access to this transaction controller will be single-threaded so syscs_peek_at_sequence() and NEXT VALUE FOR should not block each other. Attempts to pre-allocate a range should always succeed unless DDL is happening on the sequence or the user is directly querying the row--we will tell users they shouldn't do that but should instead use syscs_peek_at_sequence().\r\n\r\nI don't understand your proposal about how to tackle identity columns. You may be suggesting that we create a sequence (backed by a row in SYSSEQUENCES) for every identity column. I think that is a good approach and it aligns us with the behavior of the SQL Standard, which says that an identity column should behave as though it is implemented with an internal sequence.\r\n\r\nThanks,\r\n-Rick","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-03-30T18:00:20.643+0000","updated":"2012-03-30T18:00:20.643+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13251081","id":"13251081","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-5493-01-ad-simplerApproach.diff. This patch is not ready for commit. I want to run some throughput tests with it first. The patch implements the approach which we seem to have converged on:\r\n\r\n1) Retains the syscs_peek_at_sequence() function so that users can get the instantaneous value of a sequence without having to query SYSSEQUENCES. I changed the signature of this function. Instead of a single uuid argument, the function now takes a schema and sequence name pair. The idea here is to not tempt users into driving this function with a select from SYSSEQUENCES in order to get the uuid.\r\n\r\n2) Instead of using an invisible conglomerate, pre-allocation happens in the SYSSEQUENCES row (as in 10.8).\r\n\r\n3) Pre-allocation is done by a transaction which is dedicated to the sequence. The transaction expects to do its work immediately, without waiting for a lock, and then to autocommit that work. If the transaction can't get a lock immediately, it raises a TOO MUCH CONTENTION exception. We seem to agree that TOO MUCH CONTENTION can only arise if sequence DDL is in flight or if the application scans SYSSEQUENCES against our advice.\r\n\r\nI tried a slightly different approach at first. In that approach, pre-allocation happened in a sub-transaction of the session's execution transaction. That approach fixed this bug (DERBY-5493) but did not fix DERBY-5494. By using a separate, dedicated transaction, I am able to fix DERBY-5494 as well.\r\n\r\nTouches the following files:\r\n\r\n--------------\r\n\r\nM       java/storeless/org/apache/derby/impl/storeless/EmptyDictionary.java\r\nM       java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java\r\nM       java/engine/org/apache/derby/iapi/sql/dictionary/DataDictionary.java\r\nM       java/engine/org/apache/derby/catalog/SystemProcedures.java\r\n\r\nSupport for the new syscs_peek_at_sequence() function.\r\n\r\n--------------\r\n\r\nM       java/engine/org/apache/derby/loc/messages.xml\r\nM       java/shared/org/apache/derby/shared/common/reference/SQLState.java\r\n\r\nI changed the wording of the TOO MUCH CONTENTION exception so that it points the user at the likely cause of the problem: an open scan of SYSSEQUENCES. I changed this exception to Transaction severity so that the language layer does not get confused during cleanup.\r\n\r\n--------------\r\n\r\nM       java/engine/org/apache/derby/impl/sql/catalog/SequenceUpdater.java\r\n\r\nRe-plumbed the SequenceUpdater as described above.\r\n\r\n--------------\r\n\r\nM       java/engine/org/apache/derby/impl/sql/catalog/SequenceGenerator.java\r\n\r\nAdjusted the wording of some comments.\r\n\r\n--------------\r\n\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/lang/GeneratedColumnsHelper.java\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/lang/SequenceGeneratorTest.java\r\nA       java/testing/org/apache/derbyTesting/functionTests/tests/lang/t_5494.sh\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/upgradeTests/Changes10_9.java\r\n\r\nTests for the new system function and to verify the fixes to the correctness problems.\r\n\r\n--------------\r\n\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/upgradeTests/Changes10_2.java\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/lang/RolesTest.java\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/lang/GrantRevokeDDLTest.java\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/jdbc4/TestDbMetaData.java\r\nM       java/testing/org/apache/derbyTesting/functionTests/master/ij7.out\r\n\r\nTests which had to change to account for the new system function.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-10T21:35:21.301+0000","updated":"2012-04-10T21:35:21.301+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13251176","id":"13251176","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I will review these changes more carefully in next few days, this comment is just based on your comment describing the changes. Did you \r\nunderstand why this approach fixes DERBY-5494 vs the subtransaction  approach?  In the normal sub transaction case I was thinking\r\nthat it should wait on locks and return too much contention on a lock timeout, to take care of a expected very short lock waits\r\nif 2 threads are trying to update the sequence at same time, but maybe the 1 transaction per sequence makes this impossible to happen.  \r\n\r\nWhat is the expected behavior of creating a sequence, with respect to autocommit and locking?  Is the create done in the nested transaction\r\nand autocommitted?\r\n\r\nA comment I meant to make before, is that DERBY-5495 requires crash testing, and now there is a framework to do that in junit tests - \r\nsee store/OCRecoveryTest.java, basically there is a routine to fork out a process to run a java test procedure and then you just exit which\r\nwill run through the \"unclean\" shutdown and next test connects running through whatever recovery will do on that unclean shutdown.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-04-10T23:31:46.351+0000","updated":"2012-04-10T23:31:46.351+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13251537","id":"13251537","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks for your comments and your offer to review this patch, Mike. Some comments inline...\r\n\r\n\r\n...\r\n\r\n>Did you understand why this approach fixes DERBY-5494 vs the subtransaction approach?\r\n\r\nI don't understand why the subtransaction approach fails. I have attached a revised repro to DERBY-5494. That shows the behavior in the current trunk without this patch. The sequence generator durably commits a change to SYSSEQUENCES, which can be seen by another thread. The system-crash reverses this supposedly durable change. The same behavior can be seen in 10.8.2.2 (except that the size of the pre-allocation range is shorter so the second thread sees a slightly different value before the crash).\r\n\r\nI decided to try a dedicated transaction because I knew, from the ghost conglomerate experiment, that that approach fixed DERBY-5494.\r\n\r\nThe only variable that I can see is the use of a subtransaction vs the use of an ordinary transaction. You are the expert in the implementation and use of subtransactions. Do you have any theories about what is going on?\r\n\r\n>In the normal sub transaction case I was thinking that it should wait on locks and return too much contention on a lock timeout, to take care of a expected very short lock waits if 2 threads are trying to update the sequence at same time, but maybe the 1 transaction per sequence makes this impossible to happen. \r\n\r\nThe 1 transaction per sequence should make this impossible for the cases which I thought we wanted to support. Waiting for the lock would support the following additional use-cases, but I thought that we agreed they were not worth supporting:\r\n\r\na) Dropping a sequence and then rolling back that transaction.\r\n\r\nb) Scans of SYSSEQUENCES by the application.\r\n\r\n>What is the expected behavior of creating a sequence, with respect to autocommit and locking? Is the create done in the nested tr nsaction and autocommitted?\r\n\r\nNothing has changed in the CREATE SEQUENCE logic. That work happens in an ordinary user transaction, just as it did in 10.8. At the end of this comment, I attach a script which shows that if you create a sequence and a table but don't commit that work, then another thread will timeout trying to use those objects.\r\n\r\nThis is the behavior which I thought we agreed: DDL happens in ordinary user transactions. It is just the NEXT VALUE FOR which happens in an unusual transaction. Note that SYSCS_PEEK_AT_SEQUENCE doesn't actually do any transactional work, it just looks at an in-memory value via a synchronized method.\r\n\r\n>A comment I meant to make before, is that DERBY-5495 requires crash testing, and now there is a framework to do that in junit tests - see store/OCRecoveryTest.java, basically there is a routine to fork out a process to run a java test procedure and then you just exit which will run through the \"unclean\" shutdown and next test connects running through whatever recovery will do on that unclean shutdown.\r\n\r\nGreat! I will look into making a proper JUnit test out of java/testing/org/apache/derbyTesting/functionTests/tests/lang/t_5494.sh.\r\n\r\nThanks,\r\n-Rick\r\n\r\n------------------\r\n\r\nHere is the script which demonstrates the behavior of uncommitted ddl:\r\n\r\nconnect 'jdbc:derby:memory:db;create=true' as dbo;\r\n\r\ncall syscs_util.syscs_set_database_property( 'derby.locks.waitTimeout', '2' );\r\n\r\nautocommit off;\r\n\r\ncreate sequence foo;\r\ncreate table t( a int );\r\n\r\nconnect 'jdbc:derby:memory:db' as otheruser;\r\n\r\n-- times out waiting for the other thread's ddl to commit\r\nvalues next value for foo;\r\nselect * from t;\r\n\r\nset connection dbo;\r\n\r\ncommit;\r\n\r\nset connection otheruser;\r\n\r\n-- succeeds\r\nvalues next value for foo;\r\nselect * from t;","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-11T13:28:44.434+0000","updated":"2012-04-11T13:28:44.434+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13252607","id":"13252607","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-5493-01-ae-simplerApproachWithCrashJUnitTest.diff. This is identical to the previous patch except that it adds a JUnit test case to verify the fix to DERBY-5494, using assertLaunchedJUnitTestMethod as Mike suggested. This test case could be added to the fix for DERBY-5494 which Mike is working on.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-12T17:14:41.167+0000","updated":"2012-04-12T17:14:41.167+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13252612","id":"13252612","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"The test case was added to SequenceGeneratorTest. It is called test_13_5494(). I have run it successfully on the following platforms:\r\n\r\no Java 6 on Mac OS X\r\n\r\no Java 6 on XP\r\n\r\no PhoneME emulator on an Ubuntu guest operating system on Mac OS X.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-12T17:18:43.848+0000","updated":"2012-04-12T17:18:43.848+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13252625","id":"13252625","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"rick, should I move forward and fix DERBY-5494 separate from the patch in this issue?  I have been spending time looking at it rather than reviewing this change? I think i can code rest of that fix today and if tests pass tonight be ready to checkin tommorow.\r\n\r\n I think both my proposed fix and your patch (by using a user level transaction) are both causing the log to be flushed to avoid the crash problem.  For sequences I assume this is necessary and we will have to pay the perfomance cost.  I don't think there is anyway to solve the crash problem without forcing the log at commit time of the system catalog update.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-04-12T17:28:11.686+0000","updated":"2012-04-12T17:28:11.686+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13252659","id":"13252659","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Hi Mike,\r\n\r\nYes, I think that your fix for DERBY-5494 should be pursued independently of the patch in this issue. I believe that your fix will make nested transactions behave in a way which is less surprising. Am I right that your fix will address the correctness problem with identity columns? If so, that is an extra reason to pursue your fix independently, since this issue does not touch the identity logic. Thanks. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-12T17:53:47.961+0000","updated":"2012-04-12T17:53:47.961+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13252725","id":"13252725","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"I have run a quick concurrency test against the patch, using the test introduced on derby-4565:\r\n\r\njava org.apache.derbyTesting.perf.clients.Runner \\\r\n    -driver org.apache.derby.jdbc.EmbeddedDriver \\\r\n    -init \\\r\n    -load seq_gen \\\r\n    -load_opts debugging=0,numberOfGenerators=1,tablesPerGenerator=0,insertsPerTransaction=100 \\\r\n    -gen b2b \\\r\n    -threads 10 \\\r\n\r\nOn my dual-core Mac I'm getting slightly better numbers (average of 291 tx/seconds) than I recorded for this test case on derby-4565. I don't think the improvement is due to this patch, it is more likely due to the fact that I have a faster machine this time around. However, it encourages me to think that the patch has not harmed the concurrency of sequence generators. I'm looking for a beefier machine with more processors now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-12T18:50:25.625+0000","updated":"2012-04-12T18:50:25.625+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13252741","id":"13252741","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"ok, i will move forward on DERBY-5494.  I will not be changing behavior of identity columns.  I think we should look at that as a separate issue, and see if standard is open to interpretation for identity columns. If at all possible I would like to keep the performance optimization currently used with identity columns.  I will add comments in the code to make it obvious what is going on, rather than hidden in store as it is now.   With identity columns I believe the problem is much less vs sequences, at least in normal application expectations.  It seems reasonable to me for applications to not \"remember\" an identity column value until the inserting transaction commits, or to just use it in same transaction that inserted and produced the value making its use transactional .  I think the current behaviour never results in duplicate identity column values being produced for use in a row.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-04-12T19:01:56.447+0000","updated":"2012-04-12T19:01:56.447+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13252747","id":"13252747","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"i don't know anything about mac, do you happen to know if writes are properly sync'd on the machine you are using?  It is pretty obvious if you run a simple  derby program that does a commit per very small insert single threaded.  A properly synced machine will quickly become I/O bound somewhere around \r\n30-100 i/o's per second on regular ide or scsi hardware. maybe just posting results of 1 thread vs 10 threads would be enough in your test, i don't know much about the other configurations.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-04-12T19:07:38.099+0000","updated":"2012-04-12T19:07:38.099+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13252750","id":"13252750","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"I don't think that there is any wiggle room in the Standard, but I also think that the correctness problem with identity columns is not one that most users are going to care about. As you say, users are most likely going to be interested in never seeing duplicates in primary key columns. The only edge case I can think of is an application which was coded before we introduced sequences and which created a table with one column, an identity column, used to simulate a unique id generator for the whole application. That edge case would be concerned about the correctness problem with identity columns. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-12T19:11:13.853+0000","updated":"2012-04-12T19:11:13.853+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13253404","id":"13253404","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks for that warning about the write-cache on Mac OSX, Mike. I believe that the write-cache is enabled by default, so that would account for the high transaction rate.\r\n\r\nI have run a similar experiment on a beefier machine (32 processor, Solaris). The transaction rate is in the range which you would expect for a disabled write-cache. This experiment ran 32 threads:\r\n\r\njava org.apache.derbyTesting.perf.clients.Runner \\\r\n    -driver org.apache.derby.jdbc.EmbeddedDriver \\\r\n    -init \\\r\n    -load seq_gen \\\r\n    -load_opts debugging=0,numberOfGenerators=1,tablesPerGenerator=0,insertsPerTransaction=100 \\\r\n    -gen b2b \\\r\n    -threads 32 \\\r\n\r\nI ran the experiment 3 times against the current trunk and then 3 times against the patch (averaging the results). With the old sequence management (what's currently in the trunk), I got 49 tx/sec.. With the patch, I got 75 tx/sec..\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-13T14:21:27.039+0000","updated":"2012-04-13T14:21:27.039+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13253913","id":"13253913","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"meant to take ownership of DERBY-5494, not this one.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-04-14T00:49:03.043+0000","updated":"2012-04-14T00:49:03.043+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13255786","id":"13255786","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-5493-01-af-usersubtran.diff. This patch fixes the concurrency problems with the previous patch which were disclosed by the experiments described on DERBY-5471.\r\n\r\nThe fix is to go back to updating SYSSEQUENCES in a subtransaction of the user's execution transaction. This means that this patch does not fix DERBY-5494. So I won't commit this patch until Mike commits his work on DERBY-5494. At that point, I will adjust the patch to account for the fact that Mike is going to include the regression test case for that issue which was introduced by the earlier rev of this patch.\r\n\r\nWith this version of the patch the tx/sec results are slightly better than the comparable experiments on 10.8.2.2 and trunk:\r\n\r\no 10 threads with preallocation=20: 99 vs 92 on trunk\r\n\r\no 10 threads with preallocation=5: 78 vs 75 on 10.8.2.2\r\n\r\no 1 thread with preallocation=20: 45 vs 44 on trunk\r\n\r\no 1 thread with preallocation=5: 36 vs 35 on 10.8.2.2\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-17T18:11:30.156+0000","updated":"2012-04-17T18:11:30.156+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13255821","id":"13255821","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I committed a fix for DERBY-5494.  I was going to try to do some more performance tests, but turns out my windowsXP laptop has write cache enabled, and I can't seem to get it turned off as the control box is greyed out.  I am going to find another machine\r\nbut figured since all tests pass, it would be better to get code in trunk so you can work off it, and we can see full effect of both\r\nchanges.   I expect the 5494 change to have a \r\nnegative affect on performance of sequences.  The worst case will be 1 thread, preallocation=0 (or 1 I don't know which gives you no preallocation).  I would assume less and less affect the larger the preallocation, or more users.\r\n\r\nI would not be surprised if the throughput goes back to same problem you were seeing with user transaction vs nested transaction, now that the nested user transaction will wait on the commit like the user transaction.  If all threads need to wait for the preallocation unit of work step, and we now have added a synchonous I/O to that process, then would expect throughput to drop.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-04-17T18:47:34.520+0000","updated":"2012-04-17T18:53:48.624+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13256480","id":"13256480","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-5493-01-ag-mergedWith5494.diff. This is the patch after syncing with the trunk and merging with Mike's fix to DERBY-5494.\r\n\r\nAt this point the tests run cleanly. However, as Mike suspected, concurrency has returned to the situation with the 01-ae patch, what was reported on DERBY-5471.\r\n\r\nIn a follow-on patch, I think I will boost the pre-allocation size to 100 unless someone objects.\r\n\r\nCommitted at subversion revision 1327471.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-18T12:24:54.104+0000","updated":"2012-04-18T12:24:54.104+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13256962","id":"13256962","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching derby-5493-02-aa-boostPreallocationTo100.diff. This boosts the preallocation size to 100 in order to get slightly better concurrency than we saw in 10.8. Tests passed cleanly for me. Committed at subversion revision 1327682.\r\n\r\n\r\nTouches the following files:\r\n\r\n--------------\r\n\r\nM       java/engine/org/apache/derby/impl/sql/catalog/SequenceRange.java\r\n\r\nThe actual change.\r\n\r\n--------------\r\n\r\nM       java/testing/org/apache/derbyTesting/functionTests/tests/lang/SequenceGeneratorTest.java\r\n\r\nBoosting the preallocation size caused a combinatorial explosion in the number of cases stressed in the boundary test for sequences. I pared that test back to a manageble set of cases.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-18T21:07:15.121+0000","updated":"2012-04-18T21:07:15.121+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13257724","id":"13257724","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Attaching the first rev of a release note for this issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-19T19:39:05.904+0000","updated":"2012-04-19T19:39:05.904+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530574/comment/13258383","id":"13258383","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"I believe the work on this issue is done.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2012-04-20T17:15:55.151+0000","updated":"2012-04-20T17:15:55.151+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5493/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06fjz:"}}
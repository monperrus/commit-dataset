{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"29521","self":"https://issues.apache.org/jira/rest/api/latest/issue/29521","key":"DERBY-125","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2005-11-04 09:50:28.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"21782","customfield_12310222":"1_*:*_1_*:*_32080368000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_2_*:*_10215624000_*|*_4_*:*_1_*:*_40448000","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-04-29T08:31:45.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-125/watchers","watchCount":0,"isWatching":false},"created":"2005-01-19T03:51:30.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-05-24T03:58:50.000+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11410","id":"11410","name":"Network Server"}],"timeoriginalestimate":null,"description":"BACKGROUND:\n\nDRDA protocol, which is the protocol used by Derby Network Server, dictates that all DSS objects \"with data greater than 32,763 bytes\" should be broken down into multiple \"continuation\" DSSes.\n\nPROBLEM:\n\nWhen Network Server receives a \"prepareStatement\" call that has a very large number of parameters, it can end up sending a reply DSS that is greater than 32K long to the client; doing so breaks DRDA protocol.\n\nREPRODUCTION:\n\nNote that this reproduction does NOT cause a protocol exception against the JCC driver--without further investigation, it would appear JCC doesn't mind that the DSS is too long.  However, other DRDA clients (such as the DB2 ODBC client) will see that the data is too long and will fail because of it.\n\nTo reproduce, one can create a simple table and then prepare a statement such as:\n\nSELECT id FROM t1 WHERE id in ( ?, ?, [ ... lots and lots of param markers ... ], ?)\n\nNote that JCC uses deferred prepare by default; when connecting, one must append the \"deferPrepares=false\" attribute to the end of the URL in order to reproduce the problem (that or just try to execute the statement, since preparation will be done at execution time).  When doing the prepare, I added a line in the \"flush\" method of org.apache.derby.impl.drda.DDMWriter.java to see how large the reply DSS was, and for cases where the number of parameter markers was high, the number of bytes in the single DSS would surpass 32K, and thus break protocol.\n\nNOTES:\n\nNetwork Server correctly uses continuation DSSes for LOBs and for result set data (data returned as the result of a query) that is greater than 32K.  The problem appears to be in \"other\" cases, such as for the prepareStatement call described above.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"40684","summary":"Network Server can send DSS greater than 32K to client, which breaks DRDA protocol.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":16,"total":16,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12356731","id":"12356731","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Army posted some really excellent information related to this issue on the following Wiki page.\r\n\r\nhttp://wiki.apache.org/db-derby/DssProtocolErrors\r\n\r\nThanks Army!\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2005-11-04T09:50:28.000+0000","updated":"2005-11-04T09:50:28.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12360330","id":"12360330","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"The attached 'repro.java' can be used to reproduce this bug. \r\n\r\nAs Army notes, there is no exception or other \"hard\" evidence of the problem. What I did was to run the attached program against a NetworkServer instance which had server-side tracing turned on (derby.drda.traceAll=true, derby.drda.traceDirectory=serverTraces), and also have client-side tracing turned on (;traceDirectory=clientTraces in my connection URL).\r\n\r\nThen, bring up both the server side traces and the client side traces in a pair of editor sessions side-by-side, and hunt down until you see the PRPSQLST message being sent from the client to the server. In the server-side trace, you can then see that the server responds with a SQLDARD which is far larger than 32K. The attached program prepares a statement with 2001 parameter markers and receives a SQLDARD message which is 118,300+ bytes long, so it appears that each parameter marker needs about 58 bytes in the SQLDARD, and it would only take about 500 parameter markers or so to blow the 32K limit.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2005-12-14T03:43:41.000+0000","updated":"2005-12-14T03:43:41.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12360746","id":"12360746","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Attached is a proposed change to address bugs 125, 170, 491, and 492, together with a detailed document discussing the thinking behind the changes and explaining how they work. Please review this at your convenience and let me know what you think.\r\n\r\nThe current patch does not contain any new tests, and I believe that is mandatory prior to submitting these fixes, so the current patch is not ready to be submitted. I will be working on adding new tests, but since review of these changes will require some thought, I thought it would be valuable to put the change proposal and the accompanying description out there now, while I continue to work on more testing in the meantime.\r\n\r\nthanks,\r\n\r\nbryan\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2005-12-19T04:28:22.000+0000","updated":"2005-12-19T04:28:22.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12360830","id":"12360830","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"First diff included an accidental, unrelated change. Removed, and replaced with svn_2.diff.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2005-12-20T00:35:18.000+0000","updated":"2005-12-20T00:35:18.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12361344","id":"12361344","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Replaced \"changes.html\" with \"changes2.html\", which includes more details and two additional bug fixes of significance.\r\n\r\nReplaced \"svn-2.diff\" with \"svn-dec_28_2005.diff\", which includes all the bug fixes that I propose for this patch, together with several new regression tests and associated output files. The regression tests are in lang/procedure.java and in derbynet/prepStmt.java, and there is also a change to util/ProcedureTest.java to support the new lang/procedure.java tests.\r\n\r\nI think these changes are now fully ready for review. Please let me know your comments as I am very interested to hear what you think.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2005-12-29T09:52:30.000+0000","updated":"2005-12-29T09:52:30.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12362549","id":"12362549","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"I am withdrawing this patch. It is unnecessarily large and complex, as it bundles multiple bug-fixes into one patch. I will submit a revised patch later which just addresses the changes to DDMWriter.finalizeDSSLength(). I will submit separate patches for bugs 170, 491, and 492. The patches for 491 and 492 will be dependent on the patch for this bug (125).\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-01-13T01:41:01.000+0000","updated":"2006-01-13T01:41:01.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12362578","id":"12362578","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Attached is a focused patch which addresses *only* the problems in DDMWriter.finalizeDSSLength(). The patch includes a test, and updates to the master output files. Note, unfortunately, that this test works even *without* the changes to DDMWriter.java. The reason for this is explained in the changes.html file. I would like to write a better test, but don't know how to. Reviewers, please look at this patch and see if you can suggest a better way to write the test. Even if we can't write a better test, I think we should still review and consider this patch, because it fixes an important bug (and it is a pre-requisite for the fixes to DERBY-491 and DERBY-492, which also have tests, so it will get additional testing there.)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-01-13T09:47:54.000+0000","updated":"2006-01-13T09:47:54.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12362858","id":"12362858","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dyret","name":"dyret","emailAddress":"Dyre dot Tjeldvoll at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dyre Tjeldvoll","active":true},"body":"Hi Bryan, I finally had a chance to look through your proposal (I have not yet looked at the actual patch), as I promised to do back in December. I think you have provided an exceptionally thorough description of the problem that was enjoyable to read. With regard to your questions; I think you have very high standards for your work, maybe too high :) Personally, I don't see any problems with filling the \"bytes[]\" array with junk to provoke an error, at least not in debug builds. And I would also let the client rely on the continuation header, and just refuse to read more bytes if the size was zero (or perhaps even throw an exception if the continuation bit is set, and the size is zero). If such protocol validation will break existing code I think one could print a warning in debug mode to make the test fail. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dyret","name":"dyret","emailAddress":"Dyre dot Tjeldvoll at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dyre Tjeldvoll","active":true},"created":"2006-01-17T01:49:07.000+0000","updated":"2006-01-17T01:49:07.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12362895","id":"12362895","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Hi Bryan\r\n\r\nThank you so much again for your excellent  documentation.  I am learning quite a bit and appreciate your very high standards for your work #:)  I think once the series  of continuation fixes is committed we should update the DssProtocolErrors page that Army wrote to point to your documents.  I don't know if they should move to the documents to Wiki   or if it is ok to just keep them here and point to the bugs.\r\n\r\n\r\nMy only comment on the code change are:\r\n1) Can you submit a new patch after updating your client for the DERBY-170 commit.\r\n2) Can you add some brief comments to the code containing\r\n    - a reference to DERBY-125 and the changes.html here\r\n    - just a couple brief comments in the code as to why we have to add 1 to startOfCopyData and the continuation flag hnadling changes that you made.  \r\n\r\nWith regard to your questions and notes\r\n\r\nOn the reading of DDMWriter traces\r\nI tend to find the client tracing more helpful than the server-side tracing , and shows the JDBC calls  to provide better context.  That said, probably the problems you note exist on the client side too, so it might be good to file enhancements while you are thinking about it.\r\n\r\nOn prefilling the buffer with a known value to try to flush out corruption in the sent data:\r\nI think this is not a bad idea if (SanityManager.DEBUG), but not a high priority. \r\n\r\nWhy don't bad DSS continuation headers cause more symptoms?\r\nYou mentioned that this might be because the Derby  client is very liberal in assuming that the block length is 32767 if the continuation bit is set.  I think that it would be worthwhile for the client to be changed to not make this assumption when talking to 10.2 or higher servers.  It would help prevent regressions in this area that might be very difficult to reproduce.  \r\n\r\nShould there be a limit to DDMWriter auto-expansion?\r\nOne poorly formed idea is to eliminate the expansion all together by istead of expanding have a pool of buffers available to all the DDMWriters.  If  a DDMWriter needs to write more,  it picks up a new buffer and returns it to the pool when no longer needed.  It seems like there should be a way to eliminate the shifting all together as well or at least shift sooner after the overrun happens to avoid shifting large amounts of data.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-01-17T07:57:52.000+0000","updated":"2006-01-17T07:57:52.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12363032","id":"12363032","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"\r\nI spent some time looking at the existing test case for this issue and at Bryan's excellent description of the problem.  I played around with both and was able to come up with a repro for the problem that actually causes a failure on JCC.\r\n\r\nThis isn't by any means a polished repro--the test would need to be cleaned up before it could be added to the nightlies.  But I thought I'd post what I found and see what the reactions are.\r\n\r\nThe repro is called offByOne.java (it's part of offByOne.jar).\r\n\r\nThe theory behind this test is based on a quote from Bryan's email in the following thread:\r\n\r\nhttp://article.gmane.org/gmane.comp.apache.db.derby.devel/11865\r\n\r\nThe quote was:\r\n\r\n<begin_quote>\r\n\r\nNote that the only \"random\" or \"nondeterministic\" part of this damage is that\r\nthe very last byte in the large DDM object gets replaced by an unknown byte\r\nfrom the unused section of the 'bytes' array. If the bytes array was just\r\nexpanded in order to accomodate this object, then the unused section of the\r\narray will contain zeros, but if the bytes array was previously used for a\r\nlarger amount of data, then those unused bytes contain unknown values. \r\n\r\n<end_quote>\r\n\r\nSo what I've done with this test is remove the \"random\" part.\r\n\r\nBasically, I take the repro that is already part of the existing patch and I run it twice.  The first iteration, I make both the table name and the column name extra long, so that the server-side buffer has more data in it.  The second iteration, I use simpler names for the table and column, which take up less space in the server buffer.  Then, per Bryan's quote, \"if the bytes array was previously used for a larger amount of data, then those unused bytes contain unknown values\".  But since we intentionally put the \"larger amount of data\" into the buffer during the first iteration, we know what those \"unknown\" values are going to be.  Then, by twiddling the size of the table/column names, we can 'shift' the data until we reach a point where the off-by-one error manifests itself: namely, we end up incorrectly leaving old data in the current server buffer.\r\n\r\nI've also attached the traces for Derby Client and JCC with and without the patch for DERBY-125.  Without the patch, search the trace file for the lines beginning with \"8160\".  There will be two such lines: one from the first \"iteration\" of the repro, and one from the second.  With Derby Client, the first occurence looks like this:\r\n\r\n8160   000000000401F100  0000000000000000 \r\n\r\nand the second one looks like this:\r\n\r\n8160   000000000001                       \r\n\r\nIf I'm understanding correctly, the \"01\" in the second line is INCORRECT--it should be \"00\".  But because of the off-by-one error, the \"01\" is left over from the first iteration, which is a manifestation of the problem described for DERBY-125.  A similar phenomenon can be seen from the JCC traces:\r\n\r\nFirst occurence:\r\n\r\n8160   000000000401F100  0000000000000000  \r\n\r\nSecond occurence:\r\n\r\n8160   000000000001002C  D052000300262205 \r\n\r\nFor JCC, the second occurrence has additional data in it--it looks like an OPNQRYRM is chained to the data?  This might be a result of the 'defer' behavior, I'm not sure.\r\n\r\nFor whatever reason, this error goes \"unseen\" by the Derby Client; but for JCC, the result is an error in the repro, namely:\r\n\r\nException in thread \"main\" com.ibm.db2.jcc.c.DisconnectException: Execution failed due to a distribution protocol error that caused deallocation of the conversation.  A DRDA Data Stream Syntax Error was detected.  Reason: 0x3\r\n        at com.ibm.db2.jcc.a.bb.l(bb.java:1206)\r\n        at com.ibm.db2.jcc.a.bb.c(bb.java:363)\r\n        at com.ibm.db2.jcc.a.bb.v(bb.java:1439)\r\n        at com.ibm.db2.jcc.a.eb.c(eb.java:56)\r\n        at com.ibm.db2.jcc.a.r.c(r.java:42)\r\n        at com.ibm.db2.jcc.a.tb.h(tb.java:169)\r\n        at com.ibm.db2.jcc.c.zc.p(zc.java:1223)\r\n        at com.ibm.db2.jcc.c.ad.d(ad.java:2246)\r\n        at com.ibm.db2.jcc.c.ad.U(ad.java:489)\r\n        at com.ibm.db2.jcc.c.ad.executeQuery(ad.java:472)\r\n\r\nSo while this isn't ideal, at least we'd have a test for JCC that didn't rely on any other fixes (esp. DERBY-492) and that would indicate a regression.  That said, though, things to consider would be:\r\n\r\n1) why does this error occur in JCC but not in the client?  Is it related to deferred prepares, or something else?  Can/should the client be recognizing this error and doing something about it?\r\n\r\n2) Is there some way to modify this repro so that the client fails, too?\r\n\r\nAll of that said, I have to admit the repro is a bit fragile and hack-ish.  In order to get this to work, the second iteration has to have a table name that is exactly 99 characters long and a column name that is 97 characters.  There are other lengths that will cause the problem, as well--but just randomly using two lengths probably won't work.  So yes, it's ugly.\r\n\r\nNonetheless, at least we have a test case that fails without the DERBY-125 patch and passes with it, which was the big goal.  If after reading this comment anyone feels like this is too hacky/unreliable, then so be it--I won't be offended :)\r\n\r\nI don't really have time to continue looking at this, but I'm hoping someone out there can follow up on this and turn it into something useful.  My apologies for not taking this further, but I have a lot going on right now...\r\n\r\nTo run the repro:\r\n\r\n> java offByOne\r\n\r\n  --> Runs with Derby Client\r\n\r\n> java offByOne jcc\r\n\r\n  --> Runs with JCC\r\n\r\nHope this is helpful...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-01-18T06:40:26.000+0000","updated":"2006-01-18T06:40:26.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12363581","id":"12363581","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Attached is the latest patch proposal, updated to the latest trunk,with all conflicts resolved and derbyall passing. There are two changes in this patch proposal relative to the previous one:\r\n - I've changed the regression test to use the new test devised by Army. I've verified that the test fails before the patch to DDMWriter, and succeeds after it. Although I agree that the test is a bit delicate, it is much better to have a test which clearly demonstrates the problem.\r\n - I've improved the comments in finalizeDssLength() a bit to explain my changes a bit better, and also included a pointer to this bug report for those future historians who desire to study the bug in more detail.\r\n\r\nKathey, Dyre, Army: thank you very much for your feedback on the previous proposals and on the questions I raised. My preference is to treat your suggestions independently, and to open separate JIRA entries to track resolving these questions in the future:\r\n - Improving DDMWriter traces to make them easier to read in the presence of continuations and chaining\r\n - Modifying the client to process the length portion of DSS Continuation Headers, compatibly with previous releases\r\n - Under SanityManager control, pre-filling the DDMWriter buffer with special non-zero data to reveal memory corruption problems more readily\r\n - Investigating performance issues in large object handling with respect to both memory usage and number of data copies\r\n\r\nThanks again to everybody who has helped me with the investigations into this bug.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-01-23T02:23:47.000+0000","updated":"2006-01-23T02:23:47.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12363718","id":"12363718","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"\r\nChecked in this patch. Thanks Bryan!\r\n\r\nDate: Mon Jan 23 09:34:23 2006\r\nNew Revision: 371603\r\n\r\nURL: http://svn.apache.org/viewcvs?rev=371603&view=rev\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-01-24T04:14:43.000+0000","updated":"2006-01-24T04:14:43.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12363910","id":"12363910","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Fixed in the trunk with commit of revision 371603","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-01-25T11:04:17.000+0000","updated":"2006-01-25T11:04:17.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12376945","id":"12376945","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Reopened to merge this fix to the 10.1 branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-04-28T21:17:37.000+0000","updated":"2006-04-28T21:17:37.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12377052","id":"12377052","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"The merge from main was straightforward, and the testing was successful, once I re-read Army's notes and remembered the details of how this regression test works. Specifically, I had forgotten that this regression test only shows a concrete symptom in the JCC configuration, not in the DerbyNetClient configuration.\r\n\r\nCommitted the change to the 10.1 branch as revision 398058:\r\nsvn.apache.org/viewcvs?rev=398058&view=rev","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-04-29T08:31:45.000+0000","updated":"2006-04-29T08:31:45.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/29521/comment/12412993","id":"12412993","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Issue has been fixed, tested, and ported back to 10.1, so I'm now marking it as closed.  Thanks Bryan!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-05-24T03:58:50.000+0000","updated":"2006-05-24T03:58:50.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-125/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i07bu7:"}}
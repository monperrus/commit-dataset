{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12500787","self":"https://issues.apache.org/jira/rest/api/latest/issue/12500787","key":"DERBY-5108","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317968","id":"12317968","description":"second release on the 10.8 branch","name":"10.8.2.2","archived":false,"released":true,"releaseDate":"2011-10-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2011-03-08 18:12:12.97","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24654","customfield_12310222":"3_*:*_1_*:*_1034107683_*|*_1_*:*_1_*:*_7500600930_*|*_6_*:*_2_*:*_6335101293_*|*_5_*:*_1_*:*_1125805895_*|*_4_*:*_1_*:*_99585","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2011-09-09T21:01:30.180+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5108/watchers","watchCount":0,"isWatching":false},"created":"2011-03-08T17:46:14.808+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.png","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316362","id":"12316362","description":"First release on the 10.8 branch","name":"10.8.1.2","archived":false,"released":true,"releaseDate":"2011-04-29"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12337937","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12337937","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12480847","key":"DERBY-4915","self":"https://issues.apache.org/jira/rest/api/2/issue/12480847","fields":{"summary":"test failure in OSReadOnlyTest in assertDirectoryDeleted","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12337977","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12337977","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12498403","key":"DERBY-5026","self":"https://issues.apache.org/jira/rest/api/2/issue/12498403","fields":{"summary":"testStatsCreatedOnGrowthThenDeleteDb failing with ibm15 on trunk. The revision on trunk is 1069665 ","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12337995","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12337995","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12501060","key":"DERBY-5123","self":"https://issues.apache.org/jira/rest/api/2/issue/12501060","fields":{"summary":"address a select number of intermittent test issues - goal is to get all nightly tests at trunk running clean for at least 2 weeks","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/3","id":"3","description":"A task that needs to be done.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/task.png","name":"Task","subtask":false}}}},{"id":"12338065","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12338065","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12501351","key":"DERBY-5131","self":"https://issues.apache.org/jira/rest/api/2/issue/12501351","fields":{"summary":"Disable the istat daemon by default for 10.8.1","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/3","id":"3","description":"A task that needs to be done.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/task.png","name":"Task","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-10-25T17:09:39.487+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11415","id":"11415","name":"Services"}],"timeoriginalestimate":null,"description":"The test AutomaticIndexStatisticsTest.testShutdownWhileScanningThenDelete fails intermittently on Windows platforms because the test is unable to delete a database directory.\r\nEven after several retries and sleeps (the formula should be (attempt -1) * 2000, resulting in a total sleep time of 12 seconds), the conglomerate system\\singleUse\\copyShutdown\\seg0\\c481.dat cannot be deleted.\r\n\r\nFor instance from http://dbtg.foundry.sun.com/derby/test/Daily/jvm1.6/testing/testlog/w2003/1078855-suitesAll_diff.txt :\r\n(truncated paths)\r\ntestShutdownWhileScanningThenDelete <assertDirectoryDeleted> attempt 1 left 3 files/dirs behind: 0=system\\singleUse\\copyShutdown\\seg0\\c481.dat 1=system\\singleUse\\copyShutdown\\seg0 2=system\\singleUse\\copyShutdown\r\n<assertDirectoryDeleted> attempt 2 left 3 files/dirs behind: 0=system\\singleUse\\copyShutdown\\seg0\\c481.dat 1=system\\singleUse\\copyShutdown\\seg0 2=system\\singleUse\\copyShutdown\r\n<assertDirectoryDeleted> attempt 3 left 3 files/dirs behind: 0=system\\singleUse\\copyShutdown\\seg0\\c481.dat 1=system\\singleUse\\copyShutdown\\seg0 2=system\\singleUse\\copyShutdown\r\n<assertDirectoryDeleted> attempt 4 left 3 files/dirs behind: 0=system\\singleUse\\copyShutdown\\seg0\\c481.dat 1=system\\singleUse\\copyShutdown\\seg0 2=system\\singleUse\\copyShutdown\r\nused 205814 ms F.\r\n\r\nMaybe the database isn't shut down, or some specific timing of events causes a file to be reopened when it shouldn't have been (i.e. after the database shutdown has been initiated).","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10420","value":"Regression","id":"10420"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10369","value":"Regression Test Failure","id":"10369"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"36225","summary":"Intermittent failure in AutomaticIndexStatisticsTest.testShutdownWhileScanningThenDelete on Windows","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Windows platforms.","customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":45,"total":45,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13004107","id":"13004107","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I saw this on weme 6.2  10.8.0.1 alpha - (1079089) 3/7/2011\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-03-08T18:12:12.970+0000","updated":"2011-03-08T18:12:38.682+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13004116","id":"13004116","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"I saw this with ibm 1.6 - 10.8.0.1 alpha (1078654), on windows XP.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2011-03-08T18:28:37.991+0000","updated":"2011-03-08T18:28:37.991+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13004683","id":"13004683","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"more detail on the 3/7 weme occurrence:\r\nhttp://people.apache.org/~myrnavl/derby_test_results/main/windows/testlog/weme6.2/1079089-suites.All_diff.txt\r\nThere was 1 failure:\r\n1) testShutdownWhileScanningThenDelete(org.apache.derbyTesting.functionTests.tests.store.AutomaticIndexStatisticsTest)junit.framework.AssertionFailedError: Failed to delete 3 files (root=C:\\jartest\\JarResults.2011-03-07\\weme6.2_suites.All\\system\\singleUse\\copyShutdown: C:\\jartest\\JarResults.2011-03-07\\weme6.2_suites.All\\system\\singleUse\\copyShutdown\\seg0\\c481.dat (isDir=false, canRead=true, canWrite=true, size=22351872), C:\\jartest\\JarResults.2011-03-07\\weme6.2_suites.All\\system\\singleUse\\copyShutdown\\seg0 (isDir=true, canRead=true, canWrite=true, size=0), C:\\jartest\\JarResults.2011-03-07\\weme6.2_suites.All\\system\\singleUse\\copyShutdown (isDir=true, canRead=true, canWrite=true, size=0)\r\n\tat org.apache.derbyTesting.junit.BaseJDBCTestCase.assertDirectoryDeleted(BaseJDBCTestCase.java:1526)\r\n\tat org.apache.derbyTesting.functionTests.tests.store.AutomaticIndexStatisticsTest.testShutdownWhileScanningThenDelete(AutomaticIndexStatisticsTest.java:188)\r\n\tat java.lang.reflect.AccessibleObject.invokeV(AccessibleObject.java:195)\r\n\tat org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:112)\r\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:19)\r\n\tat junit.extensions.TestSetup.run(TestSetup.java:23)\r\n\tat org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:19)\r\n\tat junit.extensions.TestSetup.run(TestSetup.java:23)\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-09T17:57:35.698+0000","updated":"2011-03-09T17:57:35.698+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13004812","id":"13004812","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"This issue seems to be reproducible in my environment.  3 out of 3 times so far just running the AutomaticIndexStatisticsTest alone - I will try more later.  As a test I bumped up the retry to 100 and went to lunch and came back to the test still stuck trying to delete the same file.  So it seems likely a bug in the code rather than not enough wait time in the test.  I am going to attach a java core I took while it was looping.  I see a derby.rawStoreDaemon but have not debugged enough to know if this is expected or not in this case.  I don't know if the harness when running just this test case might still create the default db and leave it up while then creating and starting a separate one for the single use database case that this test uses.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-09T21:47:12.954+0000","updated":"2011-03-09T21:47:12.954+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13004815","id":"13004815","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"snapshot of system looping while trying to delete last file in the seg0 directory.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-09T21:49:12.551+0000","updated":"2011-03-09T21:49:12.551+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13005396","id":"13005396","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I am actively working on this one.  Right now I am concentrating on SANE, classes, windows failure of just this one fixture.  For me on my laptop this fails every time.\r\nUnless anyone protests I am going to check in a change that disables just this one fixture while I am working on it.  I have verified that the file that is the problem is the\r\ndata file that istat is scanning when the shutdown happens.  It stuck around for over an hour so I am going to assume the resource is stuck open at least until the thread\r\nthat started the server goes away and in worst case until the jvm comes down.  I \r\n\r\nI am marking this a regression, because a user previous to 10.8 that shuts down when his threads are doing nothing won't see this.  But in 10.8 istat might be running\r\nand he will run into it.  I could see this leading to problems with subsquent ddl which has to do deletes or renames of the associated table.\r\n\r\nMy current guess is that DERBY-5037 fixed the symptom but shutdown is still failing and leaving a real resource problem.  I still need to do some more debugging to \r\nverify what is going on.  In my case I am consistently getting the ASSERT.  But I believe we see the issue in nightly runs against SANE=false so it is not specific to stuff\r\nwe do in ASSERT logic.  I am hoping that fixing the SANE path will apply to the SANE=false path also.  \r\n\r\nLogically it seems like what should happen on \"clean\" shutdown is first user threads should be shutdown, then istat, and finally store.  I wonder if in 10.8 we can take advantage of the interrupt work to quickly and safely shutdown the user and istat threads?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-10T23:24:41.981+0000","updated":"2011-03-10T23:24:41.981+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13005402","id":"13005402","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"+1 to making this a blocker.  I have seen cases in the past where I have instructed users to wait for a bit after shutdown before deleting the database to avoid deletion errors.    If that won't work reliably no matter how long they wait it would be extremely problematic.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2011-03-10T23:39:23.461+0000","updated":"2011-03-10T23:39:23.461+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13005562","id":"13005562","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Thanks for looking into this, Mike.\r\nIf you enable istat logging and tracing, you should be able to see which exception/error is raised when the istat daemon is shut down (i.e. is it always being raised in the same place?)\r\n\r\nKathey, even though I agree this could be extremely problematic, there are some points to consider:\r\n o the istat daemon must be doing work as the database is shut down\r\n o the bug is timing dependent (it doesn't fail every time on the regression test machines, nor on my Windows Vista quad core)\r\n o the user must try to delete the database files\r\n o affects Windows platforms only\r\n\r\nWith the points above, this issue is still not a blocker for me, especially since the feature can be disabled. I still think this issue is the most important istat bug to fix, so it would be great if it made it into 10.8.\r\n\r\nIt is unclear to me at this point what happens resource-wise if you just skip the delete-step, reboot the database and repeat the sequence (without killing the JVM).\r\nOne thing that will definitely make it a blocker is if the database can't be booted and/or be written into after the bug occurs (again, without killing the JVM, as would typically by the case in appserver environments).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-03-11T09:12:29.099+0000","updated":"2011-03-11T09:12:29.099+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13005663","id":"13005663","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Changing the urgency to Blocker. That makes this issue a showstopper for 10.8.1. If I understand Mike's analysis, we could see problems with DDL on the table in the following scenario:\r\n\r\no Running on Windows\r\no The application shuts down the database but the application continues to do other work.\r\no The application then reboots the database for more work.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-11T14:55:34.629+0000","updated":"2011-03-11T14:55:34.629+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13005680","id":"13005680","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lilywei","name":"lilywei","emailAddress":"lilywei at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lily Wei","active":true},"body":"+1 to making this a blocker for this application shuts down the database then delete the database is problematic on Windows.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lilywei","name":"lilywei","emailAddress":"lilywei at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lily Wei","active":true},"created":"2011-03-11T15:36:41.002+0000","updated":"2011-03-11T15:36:41.002+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13005876","id":"13005876","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"It looks like one of the last things that happens in the istat thread prior to store peforming it's shutdown and closing all of it's open files is that \r\nit recovers an open from an interrupt.  I'll include the stacks below that show this.  What should we do if the istat thread get's an interrupt.  I am leaning\r\ntoward it should check for interrupts at critical places and then give up on the work it is doing.  Maybe there is a place it could check whether it should be\r\nshutting down that needs to be checked more often?  \r\n\r\nThe store shutdown code only closes files that are not currently \"kept\" (store's term for a file that is open by a store client), so not surprising that file is\r\nnot closed if it is executing while the istat thread is busy reading from the file).  Here is the stack of the store closing it's open files:\r\n    at org.apache.derby.impl.store.raw.data.RAFContainer.closeContainer(RAFContainer.java:216)^M\r\n    at org.apache.derby.impl.store.raw.data.RAFContainer4.closeContainer(RAFContainer4.java:227)^M\r\n    at org.apache.derby.impl.store.raw.data.FileContainer.clearIdentity(FileContainer.java:476)^M\r\n    at org.apache.derby.impl.services.cache.ConcurrentCache.removeEntry(ConcurrentCache.java:167)^M\r\n    at org.apache.derby.impl.services.cache.ConcurrentCache.ageOut(ConcurrentCache.java:583)^M\r\n    at org.apache.derby.impl.services.cache.ConcurrentCache.shutdown(ConcurrentCache.java:598)^M\r\n    at org.apache.derby.impl.store.raw.data.BaseDataFileFactory.stop(BaseDataFileFactory.java:519)^M\r\n    at org.apache.derby.impl.services.monitor.TopService.stop(TopService.java:443)^M\r\n    at org.apache.derby.impl.services.monitor.TopService.shutdown(TopService.java:394)^M\r\n    at org.apache.derby.impl.services.monitor.BaseMonitor.shutdown(BaseMonitor.java:229)^M\r\n\r\nHere is some debug showing the stacks where the istat daemon is recovering from an interrupt: on the file of interest c481.dat - conglom/container  id  1153\r\nThu Mar 10 16:22:59 PST 2011 Thread[index-stat-thread,5,main] {istat,trace@637806084} worker thread started (xid=24016) [q/p/s=1/0/1,err:k/u/c=0/0/0,rej:f/d/\r\n/0/0]^M\r\nThu Mar 10 16:22:59 PST 2011 Thread[index-stat-thread,5,main] {istat,trace@637806084}     processing \"APP\".\"BIG_TABLE\" ^M\r\nDEBUG IndexStatisticsDaemonImpl OUTPUT: opened conglomerateNumber[1] = 1153^M\r\nDEBUG RAFContainer OUTPUT: about to close file C:\\derby\\s1\\systest\\out\\junit\\system\\singleUse\\copyShutdown\\seg0\\c481.dat^M\r\nException trace: ^M\r\njava.lang.Throwable^M\r\n    at org.apache.derby.impl.store.raw.data.RAFContainer.closeContainer(RAFContainer.java:216)^M\r\n    at org.apache.derby.impl.store.raw.data.RAFContainer4.closeContainer(RAFContainer4.java:227)^M\r\n    at org.apache.derby.impl.store.raw.data.RAFContainer4.recoverContainerAfterInterrupt(RAFContainer4.java:860)^M\r\n    at org.apache.derby.impl.store.raw.data.RAFContainer4.readPage(RAFContainer4.java:368)^M\r\n    at org.apache.derby.impl.store.raw.data.RAFContainer4.readPage(RAFContainer4.java:246)^M\r\n    at org.apache.derby.impl.store.raw.data.CachedPage.readPage(CachedPage.java:673)^M\r\n    at org.apache.derby.impl.store.raw.data.CachedPage.setIdentity(CachedPage.java:193)^M\r\n    at org.apache.derby.impl.services.cache.ConcurrentCache.find(ConcurrentCache.java:295)^M\r\n    at org.apache.derby.impl.store.raw.data.FileContainer.getUserPage(FileContainer.java:2530)^M\r\n    at org.apache.derby.impl.store.raw.data.FileContainer.getPage(FileContainer.java:2580)^M\r\n    at org.apache.derby.impl.store.raw.data.BaseContainerHandle.getPage(BaseContainerHandle.java:319)^M\r\n    at org.apache.derby.impl.store.access.btree.ControlRow.get(ControlRow.java:833)^M\r\n    at org.apache.derby.impl.store.access.btree.ControlRow.get(ControlRow.java:820)^M\r\n    at org.apache.derby.impl.store.access.btree.ControlRow.getRightSibling(ControlRow.java:531)^M\r\n    at org.apache.derby.impl.store.access.btree.BTreeScan.positionAtNextPage(BTreeScan.java:493)^M\r\n    at org.apache.derby.impl.store.access.btree.BTreeForwardScan.fetchRows(BTreeForwardScan.java:464)^M\r\n    at org.apache.derby.impl.store.access.btree.BTreeScan.fetchNextGroup(BTreeScan.java:1681)^M\r\n    at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl$KeyComparator.fetchRows(IndexStatisticsDaemonImpl.java:1174)^M\r\n    at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.updateIndexStatsMinion(IndexStatisticsDaemonImpl.java:470)^M\r\n    at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.generateStatistics(IndexStatisticsDaemonImpl.java:327)^M\r\n    at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.processingLoop(IndexStatisticsDaemonImpl.java:777)^M\r\n    at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.run(IndexStatisticsDaemonImpl.java:687)^M\r\n    at java.lang.Thread.run(Thread.java:736)^M\r\nDEBUG RAFContainer OUTPUT: closed file C:\\derby\\s1\\systest\\out\\junit\\system\\singleUse\\copyShutdown\\seg0\\c481.dat^M\r\nDEBUG RAFContainer OUTPUT: opening file: C:\\derby\\s1\\systest\\out\\junit\\system\\singleUse\\copyShutdown\\seg0\\c481.dat^M\r\nException trace: ^M\r\njava.lang.Throwable^M\r\n    at org.apache.derby.impl.store.raw.data.RAFContainer.run(RAFContainer.java:1587)^M\r\n    at java.security.AccessController.doPrivileged(AccessController.java:251)^M\r\n    at org.apache.derby.impl.store.raw.data.RAFContainer.openContainerMinion(RAFContainer.java:939)^M\r\n    at org.apache.derby.impl.store.raw.data.RAFContainer.reopenContainer(RAFContainer.java:914)^M\r\n    at org.apache.derby.impl.store.raw.data.RAFContainer4.recoverContainerAfterInterrupt(RAFContainer4.java:861)^M\r\n    at org.apache.derby.impl.store.raw.data.RAFContainer4.readPage(RAFContainer4.java:368)^M\r\n    at org.apache.derby.impl.store.raw.data.RAFContainer4.readPage(RAFContainer4.java:246)^M\r\n    at org.apache.derby.impl.store.raw.data.CachedPage.readPage(CachedPage.java:673)^M\r\n    at org.apache.derby.impl.store.raw.data.CachedPage.setIdentity(CachedPage.java:193)^M\r\n    at org.apache.derby.impl.services.cache.ConcurrentCache.find(ConcurrentCache.java:295)^M\r\n    at org.apache.derby.impl.store.raw.data.FileContainer.getUserPage(FileContainer.java:2530)^M\r\n    at org.apache.derby.impl.store.raw.data.FileContainer.getPage(FileContainer.java:2580)^M\r\n    at org.apache.derby.impl.store.raw.data.BaseContainerHandle.getPage(BaseContainerHandle.java:319)^M\r\n    at org.apache.derby.impl.store.access.btree.ControlRow.get(ControlRow.java:833)^M\r\n    at org.apache.derby.impl.store.access.btree.ControlRow.get(ControlRow.java:820)^M\r\n    at org.apache.derby.impl.store.access.btree.ControlRow.getRightSibling(ControlRow.java:531)^M\r\n    at org.apache.derby.impl.store.access.btree.BTreeScan.positionAtNextPage(BTreeScan.java:493)^M\r\n    at org.apache.derby.impl.store.access.btree.BTreeForwardScan.fetchRows(BTreeForwardScan.java:464)^M\r\n    at org.apache.derby.impl.store.access.btree.BTreeScan.fetchNextGroup(BTreeScan.java:1681)^M\r\n    at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl$KeyComparator.fetchRows(IndexStatisticsDaemonImpl.java:1174)^M\r\n    at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.updateIndexStatsMinion(IndexStatisticsDaemonImpl.java:470)^M\r\n    at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.generateStatistics(IndexStatisticsDaemonImpl.java:327)^M\r\n    at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.processingLoop(IndexStatisticsDaemonImpl.java:777)^M\r\n    at org.apache.derby.impl.services.daemon.IndexStatisticsDaemonImpl.run(IndexStatisticsDaemonImpl.java:687)^M\r\n    at java.lang.Thread.run(Thread.java:736)^M\r\n----------------------------------------------------------------^M\r\n----------------------------------------------------------------^M\r\nThu Mar 10 16:22:59 PST 2011:\r\nShutting down instance 35924132-012e-a249-3f92-ffffe527380d on database directory C:\\derby\\s1\\systest\\out\\junit\\system\\singleUse\\copyShutdown with class loade\r\nsun.misc.Launcher$AppClassLoader@49be49be ^M\r\nshutting down:\r\nisCorrupt = false\r\npageCache = org.apache.derby.impl.services.cache.ConcurrentCache@1c2a1c2a\r\ncontainerCache = org.apache.derby.impl.services.cache.ConcurrentCache@20fa20fa^M","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-11T22:22:23.967+0000","updated":"2011-03-11T22:22:23.967+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13005899","id":"13005899","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"The more I look at this issue I think the problem is that the istat daemon should shutdown and not return until it has completed this \r\nshutdown when indexRefresher.stop(); is called from the DataDictionary's stop call().  For a clean shutdown of the system the store\r\nneeds all it's clients shutdown first and then it can cleanly shutdown, and force the database files and transaction logs insuring \r\na clean shutdown with no recovery work necessary on the next boot.\r\n\r\nBy leaving the istat daemon running we can run into a number of errors that I don't think can be solved.  We might fix a specific one shown\r\nup by this test but the system is just not designed to handle clean shutdown while stuff is still running without first waiting for the running\r\nstuff to stop somehow.\r\n\r\nKristian noted in DERBY-5037:\r\n> I think Mike's comments/observations above agree pretty much with my thinking when writing the code. Seems there are several error-handling issues to iron out though...\r\n>A few specific comments:\r\n>o I decided to not make Derby wait for the background thread to finish on shutdown, as it might potentially be scanning a very large table.\r\n>o Logging is rather verbose now during testing, but I agree it should be less verbose (or maybe turned off completely) when released.\r\n>o I'm logging a lot of exceptions to aid testing/debugging. These should also go away, or be enabled by a property if the user wishes to do so. \r\n\r\nI now think that it was wrong to not wait for the background thread.  This would match the behavior of the rawStoreDaemon thread which is \"owned\"\r\nby the raw store module - the module stops the daemon and the daemon waits around for work to stop/complete before returning from the stop, and\r\nthen the raw store continues with it's data and transaction file cleanup prior to stopping.   I agree it would be a nice optimization to somehow stop the background thread in\r\nthe middle of a big scan, and it seems like with the better interrupt support this should be much easier than was the case before 10.8.   I would like\r\nsome feedback before proceding from those more knowledgeable about the istat work.\r\n\r\nI do think that the work rick did for DERBY-5037 is still valuable as it will handle much better the non-clean shutdowns that Derby can experience.  ButFor\r\na non-clean shutdown we might have to just live with a file left open until the thread or jvm exits.   But for a requested orderly shutdown of the system I \r\nthink we should go with the top down shutdown supported by the architecture rather than try to fix errors encountered when top level modules are still\r\nrunning while lower level modules are trying to shut down.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-11T23:36:56.095+0000","updated":"2011-03-12T00:14:00.742+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13006010","id":"13006010","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Engine shutdown interrupts all threads that are active inside Derby code. I'm wondering if that's the interrupt the istat thread is experiencing. DERBY-4920 was similar, only then it was a checkpoint that was interrupted by the engine shutdown and reopened the channel. I don't know if we want to handle interrupts differently for the istat daemon than we do for other threads. I'd rather see that the reopening logic in store knew that it shouldn't attempt to reopen channels if the engine is about to shut down. I thought it already had some logic to take care of that, but I'm not sure.\r\n\r\nWaiting for the istat thread before completing shutdown sounds OK. I think the reason why it doesn't do that now, was a concern that it may take a very long time if it's processing a large index. But shutdown also performs a checkpoint, which may take a long time if the page cache is big. And if the istat thread is also interrupted by the engine shutdown, it should stop rather quickly (if we only can make it stop reopening the channel).\r\n\r\nI'm wondering, though, if this problem is istat-specific, or if we would see the same problem if we called SYSCS_UPDATE_STATISTICS on a large index just before shutting down the database?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-03-12T09:14:58.785+0000","updated":"2011-03-12T09:14:58.785+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13006212","id":"13006212","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I invoked an engine shutdown while a call to SYSCS_UTIL.SYSCS_UPDATE_STATISTICS was in progress, and then I observed that the process still had an open file handle to the index file after the shutdown had completed. I had disabled istat when I ran this experiment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-03-13T15:50:02.102+0000","updated":"2011-03-13T15:50:02.102+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13006437","id":"13006437","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I don't think we need to use interrupts to shut down the istat thread more quickly. IndexStatisticsDaemonImpl.stop() sets a flag daemonDisabled that we can check every now and then while scanning the indexes. Currently, the flag is checked right before the scan starts, but I was thinking we could check that flag for example each time we've fetched a new chunk of rows from store. The attached patch does just that, and also makes stop() wait for the istat thread to complete if there is an active thread.\r\n\r\nDoes that help on the machine where you'll able to reproduce the problem, Mike?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-03-14T14:48:03.604+0000","updated":"2011-03-14T14:48:03.604+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13006478","id":"13006478","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lilywei","name":"lilywei","emailAddress":"lilywei at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lily Wei","active":true},"body":"Thanks Knut for the patch. I applied to my windows 7 machine. I used to able to reproduce the delete problem quickly. After running AutomaticIndexStatisticsTest 5 times, the delete problem did not show up. With waitOnShutdown.diff patch, checking the daemonDisabled flag each time we fetch a new chuck of rows from store and making stop() wait for istat thread to complete if there is an active thread definitely help. Does this approach fulfill the top down shutdown supported by the architecture?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lilywei","name":"lilywei","emailAddress":"lilywei at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lily Wei","active":true},"created":"2011-03-14T15:57:57.319+0000","updated":"2011-03-14T15:57:57.319+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13006492","id":"13006492","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for testing the patch, Lily!\r\n\r\n> Does this approach fulfill the top down shutdown supported by the architecture?\r\n\r\nYes, I think so. The istat service is shut down from the data dictionary, which is top-down. That was done before as well, but the actual worker thread would be left running until it finished by itself. With the patch, stop() won't complete until the worker thread is done, so when the higher levels proceed in the shutdown code, we know that the istat thread won't be causing any bad interactions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-03-14T16:27:46.677+0000","updated":"2011-03-14T16:28:11.426+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13006542","id":"13006542","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"thanks for the work knut.  Your patch looks good to me so far, I am running my single test now.\r\n\r\nEven though update statistics in a user thread exhibits the same symptom I would argue that it is much more serious in a default on istat release.  \r\nA user shutting down\r\nwhile actively running can work around the issue.  But the background process is not in their control (other than disabling it entirely).  So doing more\r\nwork to behave nicely during shutdown in istat important in my opinion.  We should probably log a separate JIRA for your update statistics test case.  I\r\nassume other work by user threads probably has a similar problem.  It would be good to know if this is a regression caused by the improved interrupt\r\nhandling.\r\n\r\nYou bring up some interesting thoughts on interrupts and shutdown.  I think we should start a thread and discuss that separately from this JIRA, deciding first\r\n what is the right thing to do then how to do it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-14T18:08:21.760+0000","updated":"2011-03-14T18:08:21.760+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13006567","id":"13006567","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"In my environment just got 4 for 4 errors without the patch and 4 for 4 sucesses with the patch.  I will submit a fix once I can get a clean full test run, probably late night pacific time.\r\n\r\n4 out of 4 worked and 5th failed.  So fix is better but something still going on, will continue working ...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-14T18:46:48.606+0000","updated":"2011-03-14T18:58:37.778+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13006602","id":"13006602","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Reducing the urgency of this issue. Now that istat is not turned on by default for 10.8.1, this issue is not a blocker for the release.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2011-03-14T19:57:41.147+0000","updated":"2011-03-14T19:57:41.147+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13006891","id":"13006891","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"There may be other issues than the istat daemon coming into play here. I see that RawStore.stop() doesn't wait for the checkpoint to complete if there already is a checkpoint in progress, so there may be similar problems in that code. A related problem with checkpoints reopening containers during shutdown was fixed in DERBY-4920.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-03-15T12:25:05.037+0000","updated":"2011-03-15T12:25:05.037+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13006941","id":"13006941","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I added some println statements to TopService.shutdown() to see in which order the modules were taken down. I found that BaseDataFileFactoryJ4 was stopped before DataDictionaryImpl (which also stops the istat daemon). BaseDataFileFactoryJ4 shuts down the page cache and the container cache, so ideally no I/O should happen after that point. Since we don't stop the istat thread until after the caches have been shut down, that may explain why we still see that files are being reopened. I think it's the container cache that closes the files.\r\n\r\nBaseMonitor sends an interrupt to all active threads before invoking TopService.shutdown(), so maybe what's happening is something like this:\r\n\r\n1) BaseMonitor interrupts the threads and goes on shutting down the modules.\r\n\r\n2) The istat thread notices the interrupt inside the store code and tries reopening the container that was closed by the interrupt. But before it has completed that task, ...\r\n\r\n3) The data file factory is shut down, and all data files are closed when the container cache shuts down.\r\n\r\n4) The istat thread finishes the reopening of the index file.\r\n\r\n5) DataDictionaryImpl stops the istat thread, but too late.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-03-15T14:35:40.294+0000","updated":"2011-03-15T14:35:40.294+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13006983","id":"13006983","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I am not actively working on this any more.  I think it should be left open until after istat is re-enabled or the istat tests are changed to run even if istat is disabled by default.   Then should be closed if we go a reasonable amount of time without seeing it in nightly's or reported by anyone.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-15T16:00:36.387+0000","updated":"2011-03-15T16:00:36.387+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13007247","id":"13007247","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"> if we go a reasonable amount of time without seeing it in nightly's or reported by anyone\r\n\r\nDidn't you say you still saw the problem in one out of five runs with the fix?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-03-15T22:45:11.741+0000","updated":"2011-03-15T22:45:11.741+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13007279","id":"13007279","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"yesterday I tried exactly 5 runs using the exact submitted patch and it failed once.  I then modified the patch, mostly adding comments and slightly different break structure.  I then ran it exactly 40 times and it did not reproduce.  I then ran full set of tests in a codeline with istat still enabled as default and they all passed and checked it in - but had to update my codeline to do the submit.  I have not run it since.  It is a little harder to run since istat does not run by default - which was why I was looking for a checked in solution to running the tests no matter what the default happened to be.  I just have not gotten around to hacking a codeline or test run to do it since.  I wish the disabling had waited and happened solely in the branch if necessary, so that we could be getting testing on istat in the trunk now.  \r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-15T23:33:06.664+0000","updated":"2011-03-15T23:33:06.664+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13007504","id":"13007504","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks, Mike. Sounds like it fixed most cases then. I still suspect the shutdown order is problematic, so I'd like to keep the bug open at least until we've investigated and found out if it actually is a problem.\r\n\r\nAs to running AutomaticIndexStatisticsTest on head of trunk when istat is disabled, I found that I could do that by adding -Dderby.storage.indexStats.auto=true to the java command when invoking the test runner. I would think that it should also work on suites.All.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-03-16T15:10:50.244+0000","updated":"2011-03-16T15:10:50.244+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13008044","id":"13008044","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Attaching a small fix to handle the case of the thread stopping the daemon being interrupted while doing the IndexStatisticsDaemonImpl#join introduced in this issue: note the interrupt and retry the join. I think this is more in keeping with what we do elsewhere now.\r\n\r\nRunning regressions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-03-17T18:04:14.254+0000","updated":"2011-03-17T18:04:14.254+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13010082","id":"13010082","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Regression ran ok with my patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-03-23T11:57:25.995+0000","updated":"2011-03-23T11:57:25.995+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13010701","id":"13010701","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for the followup patch, Dag. I think it makes sense to change the interrupt handling to match what we do in the rest of the engine.\r\n\r\nI applied the patch and added a call to Thread.interrupt() to make join() always throw an exception. I verified that it saved the interrupt status and continued waiting until the thread had completed. However, when I checked the interrupt flag after DriverManager.getConnection(\"...;shutdown=true\") had completed, the interrupt flag was not set in the thread. Perhaps the shutdown code doesn't have the mechanism in place to restore the interrupt flag?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2011-03-24T15:18:43.752+0000","updated":"2011-03-24T15:18:43.752+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13010745","id":"13010745","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Committed patch as svn 1085027.\r\n\r\nThanks for looking at this, Knut. I thought it should restore the flag, I'll investigate it.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-03-24T16:22:53.565+0000","updated":"2011-03-24T16:22:53.565+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13010815","id":"13010815","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"During shutdown there is a corner case where the lcc (which contains the interrupt status) is deleted before we reach the place where the flag is attempted restored. I'll file a separate issue for this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-03-24T18:23:15.843+0000","updated":"2011-03-24T18:23:15.843+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13012238","id":"13012238","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I tried out the latest in trunk as of 3/26/2011 and ran the AutomaticIndexStatisticsTest suite 64 times and got 61 good runs and 3 failures all in the shutdown fixture as follows:\r\nThere was 1 failure:\r\n1) testShutdownWhileScanningThenDelete(org.apache.derbyTesting.functionTests.tes\r\nts.store.AutomaticIndexStatisticsTest)junit.framework.AssertionFailedError: Fail\r\ned to delete 3 files (root=C:\\derby\\s2\\newout\\system\\singleUse\\copyShutdown: C:\\\r\nderby\\s2\\newout\\system\\singleUse\\copyShutdown\\seg0\\c481.dat (isDir=false, canRea\r\nd=true, canWrite=true, size=22351872), C:\\derby\\s2\\newout\\system\\singleUse\\copyS\r\nhutdown\\seg0 (isDir=true, canRead=true, canWrite=true, size=0), C:\\derby\\s2\\newo\r\nut\\system\\singleUse\\copyShutdown (isDir=true, canRead=true, canWrite=true, size=\r\n0)\r\n    at org.apache.derbyTesting.junit.BaseJDBCTestCase.assertDirectoryDeleted(Bas\r\neJDBCTestCase.java:1526)\r\n    at org.apache.derbyTesting.functionTests.tests.store.AutomaticIndexStatistic\r\nsTest.testShutdownWhileScanningThenDelete(AutomaticIndexStatisticsTest.java:188)\r\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java\r\n:60)\r\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorI\r\nmpl.java:37)\r\n    at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:112)\r\n    at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\n    at junit.extensions.TestSetup$1.protect(TestSetup.java:19)\r\n    at junit.extensions.TestSetup.run(TestSetup.java:23)\r\n    at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\n    at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\n    at junit.extensions.TestSetup$1.protect(TestSetup.java:19)\r\n    at junit.extensions.TestSetup.run(TestSetup.java:23)\r\n\r\nThere didn't seem to be anything interesting in derby.log.  I think we should enable the \"extra\" logging by default in\r\nthis test while there is still and issue. I would be happy to run in my environment and reproduce if there is any \r\nadditional logging that we think will track down the issue (even if it something we don't want checked into the\r\nactual codeline).  Tonight I will at least run the test with the extra logging enabled from the command line.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2011-03-28T21:37:16.644+0000","updated":"2011-03-28T21:37:16.644+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13039375","id":"13039375","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Another occurrence seen on May 8th 2011: http://people.apache.org/~myrnavl/derby_test_results/main/windows/testSummary-1100426.html","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-05-25T22:13:25.320+0000","updated":"2011-05-25T22:13:25.320+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13043343","id":"13043343","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Attaching patch 1a, which will make Derby shut down the istat daemon before throwing the shutdown exception.\r\nI also tweaked the log entry to tell if the scan was aborted.\r\n\r\nI have tested the patch on a Windows machine and I have run the regression tests, but I had problems reproducing the error on my machine. Nonetheless, I never saw the error with the patch applied.\r\nIf someone wants to test the patch on Windows before I commit, please let me know and I'll hold back.\r\n\r\nPatch ready for review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-06-03T13:15:53.259+0000","updated":"2011-06-03T13:15:53.259+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13043895","id":"13043895","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Thanks, Kristian. \r\n\r\nI see that you put the call to disableIndexStatsRefresher at one point in  EmbedConnection's constructor correspoding to a requested shutdown. Database shutdown is also initiated from other locations, e.g from TransactionResourceImpl#handleException and others (many to do with replication handling). Is there no need to similarly stop the stat daemon when the db is shut down from these other locations?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-06-03T17:33:38.466+0000","updated":"2011-06-03T17:33:38.466+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13045346","id":"13045346","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Hi Dag,\r\n\r\nThere is a need to stop the istat daemon in other cases too to guarantee that this issue will never happen. There are several criteria that must occur for the issue to happen, and a few more to be able to observe it. Nevertheless, I think the takeaway is that Derby will leak file handles. How/if this affects normal Derby operation is unclear to me, and a JVM restart will clean this up.\r\n\r\nAttaching patch 2a.\r\nTo make the fix broader, I moved the logic to stop the daemon to DatabaseContextImpl.cleanupOnError.\r\nDo you reckon this is sufficient, or are you aware of other location that will bypass that code?\r\n\r\nThe regression tests ran without failures with patch 2a, but I have not yet tested this on Windows (I'll try to start a test loop later today when I can access a Windows machine).\r\n\r\nPatch ready for review. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-06-07T09:58:12.256+0000","updated":"2011-06-07T09:58:12.256+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13045408","id":"13045408","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"I think the move should cover it. +1\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-06-07T12:59:43.707+0000","updated":"2011-06-07T12:59:43.707+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13045411","id":"13045411","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"I was just wondering about the code ca line 339-342 in TransactionResourceImpl.. could that bypass it,? Note that\r\nthis is part of the old interrupt machinery to close down threads when shutting down the engine. But presumably by then you have already shut down the thread. Depends what happens first, the shutdown of the statistics  thread or the call to notifyAllActiveThreads, but I see in DataBaseContextImpl#cleanupOnError you have inserted the logic *before* the call to notifyAllActiveThreads so you should be golden.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-06-07T13:17:26.119+0000","updated":"2011-06-07T13:17:26.119+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13045860","id":"13045860","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Thanks for looking at the patch, Dag.\r\n\r\nI think your reasoning is sound.\r\nDo you happen to know if other exceptions than StandardExceptions can be passed in to cleanupOnError? What happens with InterruptedExceptions?\r\nI assume the normal case is that all exceptions are either StandardException or other exceptions wrapped in a StandardException such that we can ask for the severity. In any case, if another kind of exception is passed into DatabaseContextImpl.cleanupOnError the code to shut down the istat daemon won't be run.\r\n\r\nThe test case testShutdownWhileScanningThenDelete ran 236 times without a failure on a Windows machine with the patch applied (I then aborted the loop).\r\n\r\nCommitted patch 1b to trunk with revision 1133304.\r\nI'll monitor the automated tests (Windows platforms) to see if the issue shows itself again with this fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-06-08T09:29:08.510+0000","updated":"2011-06-08T09:29:08.510+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13045871","id":"13045871","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Attaching patch 3a, which adjusts a log message if a scan is aborted.\r\n\r\nCommitted to trunk with revision 1133317.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-06-08T09:51:24.055+0000","updated":"2011-06-08T09:51:24.055+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13046878","id":"13046878","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"Re cleanUpOnError: I believe the Throwable can be an SQLException, but essentially anything. The InterruptedExceptions\r\nare handled, I think, before we get this far, although I think I saw a couple of unhandled wait's the other day which is on my list of things to check. \r\n\r\nBut there could be other unhandled Exceptions and Errors as well, cf. the call to DCI#cleanUpOnError from ContextManager#cleanupOnError.called from TRI#handleException called from EmbedConnection#handleException which is called from many API methods in catch-all (Throwable) constructs.\r\n\r\nEmbedConnection#handleException is also called from ConnectionChild#handleException which is used from ResultSet API methods etc...\r\n\r\nNote the call to wrap \"other\" exceptions in the call TRI#warpInSQLException towards the end of TRI#handleException.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2011-06-09T22:40:27.422+0000","updated":"2011-06-09T22:40:27.422+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13049747","id":"13049747","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Thanks, Dag.\r\n\r\nAlthough there seems to be situations where the code shutting down the istat daemon as part of the cleanup is bypassed, I plan to leave the fix as it is for now.\r\nAs far as I understand, non-StandardException exceptions are supposed to be wrapped (although I haven't verified if this happens before or during/after the cleanup), and unless the exception brings down the database/system there the daemon isn't supposed to be shut down. I think it should be fairly easy to change this at a later time if we find the current fix inadequate.\r\n\r\nI haven't seen any more occurrences of the bug so far, but I'll continue to monitor the test results for a while longer before closing. I'd also like to see if the error shows up in the 10.8 branch testing.\r\n\r\nWill backport to 10.8 later.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-06-15T12:31:23.414+0000","updated":"2011-06-15T12:31:23.414+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13056491","id":"13056491","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Merged missing fixes (2a and 3a) to 10.8 with revision 1140583.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-06-28T13:14:33.253+0000","updated":"2011-06-28T13:14:33.253+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13056492","id":"13056492","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Closing issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2011-06-28T13:14:49.308+0000","updated":"2011-06-28T13:14:49.308+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500787/comment/13101560","id":"13101560","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"changing issue to change component for 10.8.2 release notes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2011-09-09T20:59:50.607+0000","updated":"2011-09-09T20:59:50.607+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5108/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06kbb:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12441958","self":"https://issues.apache.org/jira/rest/api/latest/issue/12441958","key":"DERBY-4455","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314182","id":"12314182","description":"Old head of 10.5 branch","name":"10.5.3.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313727","id":"12313727","description":"Feature release","name":"10.6.1.0","archived":false,"released":true,"releaseDate":"2010-05-18"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-11-30 16:19:20.938","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"24267","customfield_12310222":"1_*:*_1_*:*_4900611695_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2010-01-26T07:10:41.414+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4455/watchers","watchCount":1,"isWatching":false},"created":"2009-11-30T13:53:49.719+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314117","id":"12314117","description":"Next release after 10.5.2.0 release candidate #1","name":"10.5.3.0","archived":false,"released":true,"releaseDate":"2009-08-21"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12328969","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12328969","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"outwardIssue":{"id":"12445630","key":"DERBY-4515","self":"https://issues.apache.org/jira/rest/api/2/issue/12445630","fields":{"summary":"Document and clarify the use of DataValueDescriptor.setValue(InputStream,int)","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.png","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-06-02T17:13:48.370+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11410","id":"11410","name":"Network Server"}],"timeoriginalestimate":null,"description":"Possibly related to #4332?\r\n\r\nWe have encountered an error when using Prepared Statements and CLOBs.  I have read:\r\n\r\nhttp://db.apache.org/derby/papers/JDBCImplementation.html#setAsciiStream%2CsetBinaryStream%2CsetCharacterStream\r\n\r\nBut it does not seem applicable, as we are not re-using a stream.\r\n\r\nThe environment is this:\r\n\r\n1. Java 6\r\n2. Derby 10.5.3.0\r\n3. Bitronix JTA 1.3.3\r\n\r\nWe're actually using Hibernate, but I eliminated it from the equation (and the problem persists).\r\n\r\nA summary of the failure flow is this:\r\n\r\n1. Start a transaction\r\n2. Obtain a connection from a pool of connections (for this test, the pool size is pinned at 1)\r\n3. Prepare a statement that inserts a CLOB.\r\n4. Set the parameters\r\n5. Add the prepared statement to a batch (but we only batch 1 -- this is to emulate what hibernate is doing as closely as possible).\r\n6. Execute the batch.\r\n\r\nEverything up to this point works.\r\n\r\n7. Repeat steps 1-6.  But this time, the connection will be reused from the pool, and the statement will be gotten from a prepared statement cache (maintained by bitronix).  I.e. the prepared statement is re-used.\r\n8. Observe the following failure:\r\n\r\norg.apache.derby.client.am.BatchUpdateException: Non-atomic batch failure.  The batch was submitted, but at least one exception occurred on an individual member of the batch. Use getNextException() to retrieve the exceptions for specific batched elements.\r\n\tat org.apache.derby.client.am.Agent.endBatchedReadChain(Unknown Source)\r\n\tat org.apache.derby.client.am.PreparedStatement.executeBatchRequestX(Unknown Source)\r\n\tat org.apache.derby.client.am.PreparedStatement.executeBatchX(Unknown Source)\r\n\tat org.apache.derby.client.am.PreparedStatement.executeBatch(Unknown Source)\r\n\tat bitronix.tm.resource.jdbc.JdbcPreparedStatementHandle.executeBatch(JdbcPreparedStatementHandle.java:248)\r\n\tat org.dancernetworks.TestFailure.doInsert(TestFailure.java:134)\r\n\tat org.dancernetworks.TestFailure.doPrepared(TestFailure.java:110)\r\n\tat org.dancernetworks.TestFailure.main(TestFailure.java:55)\r\nNov 30, 2009 10:29:31 PM bitronix.tm.BitronixTransactionManager shutdown\r\nINFO: shutting down Bitronix Transaction Manager\r\nAn IOException was thrown when reading a 'java.sql.String' from an InputStream.\r\njava.sql.SQLException: An IOException was thrown when reading a 'java.sql.String' from an InputStream.\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.Util.seeNextException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedResultSet.noStateChangeException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.EmbedPreparedStatement.transferParameters(Unknown Source)\r\n\tat org.apache.derby.jdbc.XAStatementControl.getRealPreparedStatement(Unknown Source)\r\n\tat org.apache.derby.iapi.jdbc.BrokeredPreparedStatement.getPreparedStatement(Unknown Source)\r\n\tat org.apache.derby.iapi.jdbc.BrokeredPreparedStatement.getStatement(Unknown Source)\r\n\tat org.apache.derby.iapi.jdbc.BrokeredStatement.close(Unknown Source)\r\n\tat org.apache.derby.impl.drda.DRDAStatement.close(Unknown Source)\r\n\tat org.apache.derby.impl.drda.Database.close(Unknown Source)\r\n\tat org.apache.derby.impl.drda.Session.close(Unknown Source)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.closeSession(Unknown Source)\r\n\tat org.apache.derby.impl.drda.DRDAConnThread.run(Unknown Source)\r\nCaused by: java.sql.SQLException: An IOException was thrown when reading a 'java.sql.String' from an InputStream.\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(Unknown Source)\r\n\t... 15 more\r\nCaused by: java.sql.SQLException: Java exception: 'Stream has already been read and end-of-file reached and cannot be re-used.: java.io.EOFException'.\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.wrapArgsForTransportAcrossDRDA(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.Util.javaException(Unknown Source)\r\n\tat org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)\r\n\t... 12 more\r\nCaused by: java.io.EOFException: Stream has already been read and end-of-file reached and cannot be re-used.\r\n\tat org.apache.derby.iapi.types.ReaderToUTF8Stream.read(Unknown Source)\r\n\tat java.io.DataInputStream.readUnsignedShort(DataInputStream.java:320)\r\n\tat org.apache.derby.iapi.types.SQLChar.readExternal(Unknown Source)\r\n\tat org.apache.derby.iapi.types.SQLChar.getString(Unknown Source)\r\n\tat org.apache.derby.iapi.types.SQLChar.setFrom(Unknown Source)\r\n\tat org.apache.derby.iapi.types.DataType.setValue(Unknown Source)\r\n\tat org.apache.derby.impl.sql.GenericParameterValueSet.transferDataValues(Unknown Source)\r\n\tat org.apache.derby.impl.sql.execute.BaseActivation.setParameters(Unknown Source)\r\n\tat org.apache.derby.impl.sql.GenericActivationHolder.setParameters(Unknown Source)\r\n\t... 10 more\r\n\r\nAttached is an archived Eclipse project of a self-contained reproduction.  It includes everything needed to run, including the Bitronix 1.3.3 jar.\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10365","value":"Crash","id":"10365"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10420","value":"Regression","id":"10420"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"38047","summary":"Prepared statement failure with CLOB: Stream has already been read and end-of-file reached and cannot be re-used.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Mac OS X 10.6.2, Java 6, Bitronix JTA","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":22,"total":22,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12783663","id":"12783663","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Zipped eclipse java project with failure reproduction.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2009-11-30T14:01:06.379+0000","updated":"2009-11-30T14:01:06.379+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12783725","id":"12783725","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Patch 1a is one way of fixing the problem.\r\nYou still can't reuse streams, but this should address the issue you're seeing in the repro.\r\nI haven't verified if this happens only in XA environments, or if some kind of reuse / pooling is enough to trigger the bug.\r\n\r\nI've started the regression test suite, I'll post the results tomorrow.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2009-11-30T16:19:20.938+0000","updated":"2009-11-30T16:19:20.938+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12783727","id":"12783727","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Patch available for testing / review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2009-11-30T16:22:13.577+0000","updated":"2009-11-30T16:22:13.577+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12783854","id":"12783854","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Kristian, could you add some details about what's causing the bug? I didn't quite get that by reading the comments and the patch.\r\n\r\nThe server-side stack trace appears to happen when the session is being closed. Do we really need to read the parameter values in order to close the statement?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-11-30T21:46:10.138+0000","updated":"2009-11-30T21:46:10.138+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12783993","id":"12783993","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Kristian, the patch works for me.  I don't particularly care about re-using streams.  Because we just found this issue when we enabled the PreparedStatement cache, I'll let it run for a day or two to see if any other issues are uncovered.\r\n\r\nThanks.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2009-12-01T01:37:27.545+0000","updated":"2009-12-01T01:37:27.545+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12784159","id":"12784159","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Uploading a revised patch 1b, with some changed comments and some trivial changes to the code. It should be functionally equal to patch 1a.\r\n\r\nKnut> The server-side stack trace appears to happen when the session is being closed.\r\n\r\nYes, it appears to, but I don't think it is any more. Printing a stack trace at GenericParameterValueSet.transferDataValue gives me:\r\n        at org.apache.derby.impl.sql.GenericParameterValueSet.transferDataValues(GenericParameterValueSet.java:249)\r\n        at org.apache.derby.impl.sql.execute.BaseActivation.setParameters(BaseActivation.java:1300)\r\n        at org.apache.derby.impl.sql.GenericActivationHolder.setParameters(GenericActivationHolder.java:246)\r\n        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.transferParameters(EmbedPreparedStatement.java:1662)\r\n        at org.apache.derby.jdbc.XAStatementControl.getRealPreparedStatement(XAStatementControl.java:169)\r\n        at org.apache.derby.iapi.jdbc.BrokeredPreparedStatement.getPreparedStatement(BrokeredPreparedStatement.java:531)\r\n        at org.apache.derby.iapi.jdbc.BrokeredPreparedStatement.setInt(BrokeredPreparedStatement.java:160)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.readAndSetParams(DRDAConnThread.java:4578)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.parseSQLDTA_work(DRDAConnThread.java:4507)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.parseSQLDTA(DRDAConnThread.java:4379)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(DRDAConnThread.java:4254)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(DRDAConnThread.java:4084)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThread.java:1003)\r\n        at org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:290)\r\n\r\nFurther investigation points to DERBY-4310, DERBY-4155 and DERBY-4334, where a commit for the former two changed the code closing a statement. The stack trace you refer to must be from an earlier release. As a side note, I'm not seeing the exception printed to derby.log, even with derby.error.stream.logSeverityLevel=0.\r\nMy understanding of XA isn't as good as it should have been, but running the repro with the embedded driver (using EmbeddedXADataSource) doesn't trigger the bug. My question then is whether the \"connection switching\" behavior (see XAStatementControl.getRealPreparedStatement) seen with the client driver is a necessity or if the implementation is suboptimal.\r\nOut of curiosity I also enabled the Derby client side JDBC statement cache for XA (requires some code changes) and disabled the one in Bitronix. I observed the same behavior, including the bug.\r\n\r\nAs for the issue addressed by the patch, what happens is that Derby detects that the application connection has changed when it is about to execute the prepared statement. It then has to create a new prepared statement on the current connection. After preparing a new statement, it transfers the arguments that were set on the old statement to the new one. This was done in a way that would materialize values represented as a stream. In this specific case, the stream had already been drained and an EOFException was thrown when trying to read it again.\r\n\r\nI believe the same bug can be triggered by using only the embedded driver, but it requires a different repro (switching between global and local XA transactions or something?).\r\n\r\nFinally, the regression test run with patch 1a was clean.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2009-12-01T10:34:51.993+0000","updated":"2009-12-01T10:34:51.993+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12784180","id":"12784180","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Kristian, if I could, I'd like to ask a few questions about your comments.  You said, \" what happens is that Derby detects that the application connection has changed when it is about to execute the prepared statement\", what exactly changed from Derby's perspective?  Then you said, \"After preparing a new statement, it transfers the arguments that were set on the old statement to the new one\"  Does this involve a \"real\" preparation of a statement?  And therefore does this behavior defeat the purpose of a PreparedStatement cache (either external or internal)?\r\n\r\nWith respect to the first question, is the \"change\" in the application connection that is detected by Derby a result of XA management?  Given that the statement cache is per-connection, and that the connection is re-used (in this case), why does Derby require a \"re-prepare\" and copy of arguments?\r\n\r\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2009-12-01T11:17:55.743+0000","updated":"2009-12-01T11:17:55.743+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12784214","id":"12784214","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Hi Brett,\r\n\r\nAnswering your questions requires some more investigation, and I don't have the cycles right now. I'll try to get back to them later.\r\n\r\nI can give some information right away though.\r\nBrett> ... [a] Does this involve a \"real\" preparation of a statement? [b] And therefore does this behavior defeat the purpose of a PreparedStatement cache (either external or internal)? \r\na) In a way it does on the server side, yes. However, the server has a statement cache of its own, across connections.\r\nb) Depends on what you mean. It helps a lot when using the client driver, because you don't have to go across the network as much. My experience comes from using a ClientConnectionPoolDataSource with the internal cache. I don't know how the internal cache compares to an external cache in terms of performance.\r\n   On the server side, you still benefit from the cache (on the client side), because the \"connection change\" I mentioned doesn't happen for every operation (I'll need to investigate to figure out what causes this perceived change of state). If the server has to re-prepare the statement all the time, it will put unnecessary strain on the server side statement cache - and it may become a bottleneck. I don't remember having seen this as a problem earlier, but then I haven't been running benchmarks in an XA environment. We now also have session state piggy-backing (schema name and isolation level), which was required to implement the client side JDBC prepared statement cache.\r\n\r\nBrett> ... Given that the statement cache is per-connection, and that the connection is re-used (in this case), why does Derby require a \"re-prepare\" and copy of arguments?\r\nI can't answer this properly, but my theory is that the embedded connection on the server side changes. Again, I'll have to confirm this, and figure out why it happens if the theory is correct. There might be an XA specific reason for this, some kind of mismatch between the client and embedded connection, or perhaps due to a side-effect of some internal mechanism.\r\n\r\n\r\nTwo questions for you:\r\n 1) Have you explicitly turned on connection validation using VALUES 1, or is this something Bitronix does by default?\r\n 2) Are you having performance issues with your application?\r\n\r\nAnd thanks for providing the runnable repro and for taking the patch for a spin.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2009-12-01T13:02:07.223+0000","updated":"2009-12-01T13:02:07.223+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12784221","id":"12784221","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Q1) Have you explicitly turned on connection validation using VALUES 1, or is this something Bitronix does by default? \r\nI set the test query in the config, but I think it was recommended by bitronix (or some other connection pool doc).\r\n\r\nQ2) Are you having performance issues with your application? \r\nNot particularly, just trying to optimize things a bit.  SQL was showing up high during some profiling sessions.  But the SQL can't particularly be optimized -- it's just straight inserts.  Now batched.  In the past, my experience with MySQL and SQL Server was that re-using prepared statements made a huge difference -- like 10-20x in some cases.  I actually wrote the prepared statement cache in the jTDS (open source SQL Server) driver as a result of work at that job (probably 5 years ago now).\r\n\r\nNo worries on runnable repro, I know it can cut the diagnostic time significantly.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2009-12-01T13:16:53.935+0000","updated":"2009-12-01T13:16:53.935+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12790725","id":"12790725","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"I consider this bug fixed by the provided patch.  Therefore you are free to close the issue.\r\n\r\nHowever, if there is indeed *unnecessary* server-side \"re-preparation\" of the statements (see org.apache.derby.impl.jdbc.EmbedPreparedStatement.transferParameters in the stack trace) in the case of XA connections, I would like a separate issue to be opened.  Other than that efficiency concern, the actual defect appears to be fixed by the patch and I have not encountered this exception since applying the patch.\r\n\r\nI would like to see this fix integrated into the next release because I prefer not to run non-released versions of jars.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2009-12-15T12:38:53.834+0000","updated":"2009-12-15T12:38:53.834+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12790739","id":"12790739","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"One comment to the patch:\r\n\r\n+                    // NOTE: The length is ignored (use a non-sense value, it\r\n+                    //       hopefully fails if required in the future).\r\n+                    pvstarget.getParameterForSet(i).setValue(is, -3);\r\n\r\nThe length is only ignored by SQLChar.setValue() (and, by inheritance, SQLClob). SQLBinary.setValue() uses the length argument, as far as I can see. It may be more robust to create a new setValue() method with no length argument and with well-defined behaviour.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-12-15T13:28:48.550+0000","updated":"2009-12-15T13:28:48.550+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12790759","id":"12790759","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Knut Anders> ... It may be more robust to create a new setValue() method with no length argument and with well-defined behaviour. \r\n\r\nI agree adding another value would be more robust.\r\nLooking at the existing code, it seems -1 is already used to indicate that the length is unknown. I found a total of 7 uses of the existing method, so it isn't heavily used.\r\nWould it make sense to improve the documentation of the existing method (in DataValueDescriptor) and verifying the current use, instead of adding yet another method?\r\n\r\nAfter agreeing on this issue, I plan to commit the patch to trunk and backport it to the 10.5 branch. I might also merge it with 10.4 if it merges cleanly.\r\nI think it is an incremental improvement, and it would be nice to follow up on the XA behavior later.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2009-12-15T14:36:18.030+0000","updated":"2009-12-15T14:36:18.030+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12790786","id":"12790786","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Sounds reasonable, although I don't quite understand how the length argument is used. Could this somehow make the length parameter passed to one of the top-level JDBC streaming methods getting lost?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2009-12-15T16:03:59.345+0000","updated":"2009-12-15T16:03:59.345+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12800701","id":"12800701","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"I logged DERBY-4515 to clarify the usage of the length argument (a patch is awaiting review).\r\nRegarding your concern about the top-level JDBC length parameter(s) getting lost, I think setValue(InputStream,int) is a way we can pass the information on. This is currently done for binary types, but not for the character types. In the latter case, there is another mechanism (CharacterStreamDescriptor) used to achieve the same effect - at least for Clobs where it may really matter.\r\n\r\nAfter DERBY-4515 has been resolved, a small change has to be made to the patch attached this issue. I will then commit it and backport it to 10.5.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2010-01-15T13:49:36.809+0000","updated":"2010-01-15T13:49:36.809+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12803350","id":"12803350","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"Attached patch 1c, adjusted to use the newly introduced constant DataValueDescriptor.UNKNOWN_LOGICAL_LENGTH when calling DVD.setStream.\r\n\r\nCommitted 1c to trunk with revision 901760 and back-ported to the 10.5 branch with revision 901761.\r\nI will mark this issue as resolved when the automated tests pass.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2010-01-21T16:29:57.897+0000","updated":"2010-01-21T16:29:57.897+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12804921","id":"12804921","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"No problems reported by the nightly test runs.\r\nResolving issue.\r\n\r\nBrett, feel free to close this issue if you think it has been addressed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2010-01-26T07:10:41.330+0000","updated":"2010-01-26T07:10:41.330+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12805341","id":"12805341","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"body":"Closed, fixed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brettw","name":"brettw","emailAddress":"brett dot wooldridge at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Wooldridge","active":true},"created":"2010-01-27T03:35:45.891+0000","updated":"2010-01-27T03:35:45.891+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12872311","id":"12872311","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Was this issue a regression?  I am working with a user that is seeing something similar after upgrading to 10.5 from 10.3, but they don't have this fix yet.  I am hoping giving them the patch will fix their problem as it sounds so similar,  but don't actually see this marked as a regression from 10.3\r\n \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2010-05-27T18:10:41.839+0000","updated":"2010-05-27T18:10:41.839+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12872324","id":"12872324","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"I don't know if this issue was a regression.\r\n\r\nI don't have the cycles right now, but finding out should be simple enough (fingers crossed...):\r\n - download and unpack the repro\r\n - replace the Derby jars with older versions\r\n(- delete existing database?)\r\n - run the repro\r\n\r\nThe details are a bit murky for me, but I think running the repro is pretty simple.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2010-05-27T18:54:48.338+0000","updated":"2010-05-27T18:54:48.338+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12872345","id":"12872345","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Kristian for responding so quickly.  I will check it out and mark the box accordingly.  just wanted to check and see anyone knew off hand.\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2010-05-27T19:59:00.997+0000","updated":"2010-05-27T19:59:00.997+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12874150","id":"12874150","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I wanted to report that this was indeed the fix needed for the user that reported a regression from 10.3.  Thanks Kristian and Brett!\r\n\r\nI am trying to make a stand-alone reproduction/regression test to check in but am having some trouble popping the bug with 10.5.3.0 - (802917), before the fix. Attached is my ReproAttemptDerby4455.java.  \r\n\r\nI'll keep working on it. It would be good to have a regression test for this issue.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2010-06-01T18:52:46.644+0000","updated":"2010-06-01T18:52:46.644+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441958/comment/12874671","id":"12874671","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Marking as a regression as it was reported on upgrade to 10.5 from 10.3 with the same application.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2010-06-02T17:13:48.334+0000","updated":"2010-06-02T17:13:48.334+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-4455/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06vk7:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12544834","self":"https://issues.apache.org/jira/rest/api/latest/issue/12544834","key":"DERBY-5638","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323456","id":"12323456","description":"Third release on the 10.8 branch","name":"10.8.3.0","archived":false,"released":true,"releaseDate":"2012-11-16"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2012-03-08 17:15:39.345","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"230020","customfield_12310222":"1_*:*_1_*:*_13741171274_*|*_5_*:*_2_*:*_3023013425_*|*_4_*:*_1_*:*_183388415","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2012-09-13T23:22:43.487+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5638/watchers","watchCount":4,"isWatching":false},"created":"2012-03-01T19:43:10.386+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":["derby_backport_reject_10_7","derby_triage10_9"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"9.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316344","id":"12316344","description":"First release on the 10.9 branch","name":"10.9.1.0","archived":false,"released":true,"releaseDate":"2012-06-25"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12357612","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12357612","type":{"id":"12310040","name":"Required","inward":"is required by","outward":"requires","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310040"},"inwardIssue":{"id":"12607119","key":"DERBY-5923","self":"https://issues.apache.org/jira/rest/api/2/issue/12607119","fields":{"summary":"10.8 Backport issue (Fall 2012)","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/3","id":"3","description":"A task that needs to be done.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/task.png","name":"Task","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-11-15T08:15:15.841+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11413","id":"11413","name":"Test"}],"timeoriginalestimate":null,"description":"I've seen the following failure when running the largedata suite:\r\n\r\n(emb)largedata.Derby5624Test.testDERBY_5624 used 518403 ms .\r\n(emb)largedata.LobLimitsTest.test_01_Blob used 2422 ms .\r\n(emb)largedata.LobLimitsTest.test_02_BlobNegative used 31 ms .\r\n(emb)largedata.LobLimitsTest.test_03_Clob1 used 2375 ms .\r\n(emb)largedata.LobLimitsTest.test_04_Clob2 used 3234 ms .\r\n(emb)largedata.LobLimitsTest.test_05_ClobNegative used 516 ms .\r\n(net)largedata.LobLimitsTest.test_01_Blob used 5360 ms .\r\n(net)largedata.LobLimitsTest.test_02_BlobNegative used 32 ms .\r\n(net)largedata.LobLimitsTest.test_03_Clob1 used 2078 ms .\r\n(net)largedata.LobLimitsTest.test_04_Clob2 used 2390 ms .\r\n(net)largedata.LobLimitsTest.test_05_ClobNegative used 938 ms .\r\n(emb)largedata.LobLimitsTest.test_01_Blob used 9188238 ms .\r\n(emb)largedata.LobLimitsTest.test_02_BlobNegative used 109 ms .\r\n(emb)largedata.LobLimitsTest.test_03_Clob1 used 8116714 ms .\r\n(emb)largedata.LobLimitsTest.test_04_Clob2 used 2164002 ms .\r\n(emb)largedata.LobLimitsTest.test_05_ClobNegative used 685745 ms E\r\nTime: 22,320.138\r\nThere was 1 error:\r\n1) LobLimitsTestjava.sql.SQLException: Table/View 'BLOBTBL' already exists in Schema 'APP'.\r\n\tat org.apache.derby.client.am.SQLExceptionFactory40.getSQLException(Unknown Source)\r\n\tat org.apache.derby.client.am.SqlException.getSQLException(Unknown Source)\r\n\tat org.apache.derby.client.am.Statement.execute(Unknown Source)\r\n\tat org.apache.derbyTesting.functionTests.tests.largedata.LobLimitsTest.setupTables(LobLimitsTest.java:107)\r\n\tat org.apache.derbyTesting.functionTests.tests.largedata.LobLimitsTest$1.decorateSQL(LobLimitsTest.java:141)\r\n\tat org.apache.derbyTesting.junit.CleanDatabaseTestSetup.setUp(CleanDatabaseTestSetup.java:112)\r\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:20)\r\n\tat junit.extensions.TestSetup.run(TestSetup.java:25)\r\n\tat org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)\r\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:21)\r\n\tat junit.extensions.TestSetup.run(TestSetup.java:25)\r\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)\r\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:21)\r\n\tat junit.extensions.TestSetup.run(TestSetup.java:25)\r\n\tat org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\n\tat junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)\r\n\tat junit.extensions.TestSetup$1.protect(TestSetup.java:21)\r\n\tat junit.extensions.TestSetup.run(TestSetup.java:25)\r\nCaused by: org.apache.derby.client.am.SqlException: Table/View 'BLOBTBL' already exists in Schema 'APP'.\r\n\tat org.apache.derby.client.am.Statement.completeSqlca(Unknown Source)\r\n\tat org.apache.derby.client.am.Statement.completeExecuteImmediate(Unknown Source)\r\n\tat org.apache.derby.client.net.NetStatementReply.parseEXCSQLIMMreply(Unknown Source)\r\n\tat org.apache.derby.client.net.NetStatementReply.readExecuteImmediate(Unknown Source)\r\n\tat org.apache.derby.client.net.StatementReply.readExecuteImmediate(Unknown Source)\r\n\tat org.apache.derby.client.net.NetStatement.readExecuteImmediate_(Unknown Source)\r\n\tat org.apache.derby.client.am.Statement.readExecuteImmediate(Unknown Source)\r\n\tat org.apache.derby.client.am.Statement.flowExecute(Unknown Source)\r\n\tat org.apache.derby.client.am.Statement.executeX(Unknown Source)\r\n\t... 26 more\r\n\r\nUnfortunately, when this happens, there seems to be no 'fail' directory created. The derby.log in the system directory looks very innocent (just some start up and shutting down of the database), and the serverConsoleOutput.log only has the typical 'failed to find db 'wombat' messages'.\r\n\r\nNote, when this happens, the suite exits, so that instead of the expected 20 (or 21 on windows, see DERBY-5624 for reason for skipping on Linux default installs with 1024 max open files) we only get 15 (or 16) tests run - if the test doesn't fail it goes on to run the last 5 fixtures again for network server.\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10369","value":"Regression Test Failure","id":"10369"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"35432","summary":"intermittent test failure in test_05_ClobNegative when running full largedata._Suite; LobLimitsTestjava.sql.SQLException: Table/View 'BLOBTBL' already exists in Schema 'APP'.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"ibm 1.6 sr9 fp1, Seen on Windows XP/VMWare, and Linux (CentOS)/VMWare","customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":33,"total":33,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13222623","id":"13222623","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"Some additional info.\r\n\r\nI first started running this _Suite every night that there were changes (plus every Friday regardless of changes) with trunk and ibm 1.6 in September of 2011.\r\nIt ran into a failure - ERROR 25502 - (An SQL data change is not permitted for a read-only connection, user, or database) a disk space issue on December 7, 2011, and after that (extending to Dec 8, 2011) the disk ran full. I cleaned that up, and tests ran fine again until 2/21/2012, when the tests failed because of an issue with the Derby5624Test. After that, I first saw this error (Table/View BLOBTBL already exists) on 2/22/2012. It seemed at the time this was possibly related, but that does not make sense - the only change was adding of a new test, and this test was afterwards getting skipped on linux.\r\nTo confirm, I have run the suite on an exact matching machine with 10.8 (and ibm1.6) and there have been no failures.\r\nI also ran the suite on a much slower 1 CPU machine with windows XP, and trunk, and there, I have seen the test fail 4 out of 5 times (before old test results have clogged up my disk).\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2012-03-05T21:33:44.677+0000","updated":"2012-03-05T21:33:44.677+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13222624","id":"13222624","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"The test passed again on the linux/vmware machine where I saw this failure originally on 2/27, 2/28, 2/29, 3/1, 3/2 but failed again on 3/3 (and we got a disk full on 3/4)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2012-03-05T21:35:54.261+0000","updated":"2012-03-05T21:35:54.261+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13225316","id":"13225316","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I have been running large data suite on my Windows 7 laptop with IBM jdk 1.6 on trunk to see if I can reproduce the problem. The test failed for me one out of 5 runs so far. I am attaching derby.log from the failed time and from one of the successful runs. The failed derby.log is attached as derbyFailed and passed derby.log is attached as derbyPass.log. I will look through the 2 to see if anything jumps out in terms of what is the reason behind intermittent failures.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-08T17:15:39.345+0000","updated":"2012-03-08T17:15:39.345+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13225466","id":"13225466","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"Have you changed the test at all in these runs to get more information?  If so can you check those changes in?\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-03-08T20:27:27.920+0000","updated":"2012-03-08T20:27:27.920+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13225470","id":"13225470","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"it looks like in the failed run you are getting lock timeouts during:\r\nCleanDatabaseTestSetup.tearDown\r\n\r\nThis is causing the drop's to fail, but I don't know why these errors are not getting reported in the suite error log - this seems like a bug either\r\nin the tests or the test utilities.    Should make sure this test\r\nis using the same mechanism being used in suites.all to retry on failed drops, i think that stuff mostly retries if deletes fail I don't know if it \r\ndoes anything on timeouts.\r\n\r\nI would also suggest updating the test to set the higher lock diagnostics so that we can see more of what is going on in the timeout.  I might\r\nexpect a very short timeout to conflict with the background tasks, but not normal timeout.  But maybe the data set is so huge with the blobs\r\nthat there is so much work to be done that it does not allow the drop to happen.  Should figure out what timeout is being used for the drop.  An interesting enhancement to the lock timeout message would be to add the default timeout being used.  \r\n\r\nIf the test sets timeout anywhere should make sure it is getting set back before the cleanup.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-03-08T20:35:18.889+0000","updated":"2012-03-08T20:35:18.889+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13225597","id":"13225597","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Mike asked \"Have you changed the test at all in these runs to get more information? If so can you check those changes in? \" \r\nNo, I haven't changed anything in the test to get more information. I just fired the tests using \r\n$ time java  -Dderby.tests.trace=true junit.textui.TestRunner org.apache.derbyTesting.functionTests.tests.largedata._Suite > runall.out 2>&1\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-08T22:14:35.965+0000","updated":"2012-03-08T22:14:35.965+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13225626","id":"13225626","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"The derby.log for the passed and failed runs will show that they both have lock time outs while trying to drop the tables to get the database ready in a clean state again. The failed version has more lock time outs than the passing version. \r\n\r\nIt appears that CleanDatabaseTestSetup tries 5 times to drop database objects. For both passed and failed versions, all those 5 attempts fail with lock time outs. Then for some reason, in both failed and passed version, it appears that we try to drop the objects in network server mode(this is what I see in derby.log for both runs. I haven't looked for where it actually happens in the junit code). Both passing and failing derby.log show lock time out for drop table through network server mode. But after this failure, the passing derby.log continues to finish the large data suite with no problem. But with fail version, we get 2 more lock timeouts for trying to drop the table in network server mode. after those lock time outs, we get table already exists error in case of failing derby.log\r\n\r\nSome background info on largedata._Suite\r\nlargedata._Suite runs following suits\r\nDerby5624Test(only f windows platform)\r\nLobLimitsLiteTest\r\nLobLimitsTest\r\nLobLimitsClientTest\r\n\r\nThe intermittent problem we are seeing happens while running LobLimitsTest suite. LobLimitsTest has 5 test fixtures which get run in specific order(order is ensured through TestConfiguration.orderedSuite). The intermittent problem is in the last of those 5 fixtures, namely test_05_ClobNegative. As the name indicates, this test does a bunch of negative tests but it does not do a rollback or commit at the end. test_02_BlobNegative() is the 2nd of the 5 test fixtures run by LobLimitsTest and it does negative testing too but at the end, in the catch block for the expected exception, it does a commit. \r\n\r\nI think we may be seeing lock time outs because the transaction started by test_05_ClobNegative was never committed/rolled back and hence the locks were never released. I am going to make just one line change in my codeline to LobLimitsTest and add rollback() to the end of test_05_ClobNegative. I will run largedata test on my machine with that change to see how it goes. I will attach that one line change patch for reference to this jira.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-08T22:45:55.544+0000","updated":"2012-03-08T22:45:55.544+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13226174","id":"13226174","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"With the addition of rollback in LobLimitsTest.test_05_ClobNegative fixture, I ran the large data suite twice and it passed both those times. There were still lock time out exceptions in derby.log but only 3 in both those runs compared to 6 that I saw in the earlier successful run(without the rollback change). I will go ahead and commit the rollback change into trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-09T16:17:56.419+0000","updated":"2012-03-09T16:17:56.419+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13226228","id":"13226228","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"could you post the derby.log containing the lock timeouts that remain.  I assume that we only know all the lock timeouts on the last suite, as we lose the derby.log from previous one.\r\n\r\nDoes it make sense to anyone that the test is not reporting the lock timeouts as errors on the run.  I am pretty sure that the database cleanup\r\ncode reports junit errors when it retries but can't remove files.  Was expecting the same on lock timeouts, unless it eventually succeeds on\r\nthe retries.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-03-09T17:32:47.432+0000","updated":"2012-03-09T17:32:47.432+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13226267","id":"13226267","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"The change is probably a good one, but I am not following how it will fix the problem being reported.  I am assuming the lexical order of the\r\ntests being run is:\r\n    public void test_01_Blob() throws Exception {\r\n    public void test_02_BlobNegative() throws SQLException {\r\n    public void test_03_Clob1() throws Exception {\r\n    public void test_04_Clob2() throws Exception {\r\n    public void test_05_ClobNegative() throws Exception {\r\n\r\nAnd to me it looks like the intermittent error happens while setting up to run test_05_ClobNegative.  But your fix seems to be to change\r\nlogic at the end of test_05_ClobNegative.\r\n\r\nHave you looked at each of the tests to determine if each should have a commit/abort in all exit paths of the test?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-03-09T18:00:28.252+0000","updated":"2012-03-09T18:00:28.252+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13226293","id":"13226293","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Mike commented \"could you post the derby.log containing the lock timeouts that remain. I assume that we only know all the lock timeouts on the last suite, as we lose the derby.log from previous one. \"\r\n\r\nI just attached the log as derbyWithRollbackInTest_05.log","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-09T18:29:26.143+0000","updated":"2012-03-09T18:29:26.143+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13226391","id":"13226391","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Mike commented \"And to me it looks like the intermittent error happens while setting up to run test_05_ClobNegative. But your fix seems to be to change logic at the end of test_05_ClobNegative. \"\r\n\r\nMy understanding of CleanDatabaseTestSetup is that it runs the steup at the beginning of the suite run and it runs the teardown at the end of the suite after the last test has run. And these same steps repeat for every suite. I have put couple printlns in CleanDatabaseTestSetup to see this sequence while running large data suite. To see these printlns, we need to pass derby.tests.trace=true as shown below\r\n$ time java -Dderby.tests.debug=true -Dderby.tests.trace=true junit.textui.TestRunner org.apache.derbyTesting.functionTests.tests.largedata._Suite > runall.out 2>&1\r\nThe use of Dderby.tests.trace=true puts all the println to the console(which I have redirected to runall.out in my case)\r\n\r\nThe tests have not finished running(I will attach runall.out with what I have so far. It is very verbose because all the existing printlns will now get printed because of trace flag. You can search for \"DEBUG: cleanDatabase\" in that file to see when setup and teardown gets called). I can see that debug println for setup happens before the suite is run. Then after the suite is finished, teardown is run before the new suite is started. And so on and so forth. \r\neg of such a sequence (largedata.Derby5624Test.testDERBY_5624  is the first suite and it has just one fixture. largedata.LobLimitsTest.test_01_Blob is start of a new suite.)\r\n\r\nDEBUG: cleanDatabase start in setup\r\nDEBUG: cleanDatabase end in setup\r\n.\r\n(emb)largedata.Derby5624Test.testDERBY_5624 used 299858 ms DEBUG: cleanDatabase start in teardown\r\nDEBUG: cleanDatabase end in teardown\r\nDEBUG: cleanDatabase start in setup\r\nDEBUG: cleanDatabase end in setup\r\nDEBUG: BIGGEST_LOB_SZ=1048576 BIG_LOB_SZ=102400\r\n.\r\n(emb)largedata.LobLimitsTest.test_01_Blob DEBUG: ========================================\r\n\r\n\r\nAn interesting eg of the setup and teardown can be seen when the last test in embedded suite has run and when the next suite is getting run in network server(largedata.LobLimitsTest.test_05_ClobNegative is the last test in the previous suite. largedata.LobLimitsTest.test_01_Blob is the first fixture for next suite which is a network server suite)\r\n(emb)largedata.LobLimitsTest.test_05_ClobNegative DEBUG: at the beginning of test_05_ClobNegative\r\nDEBUG: ========================================\r\nDEBUG: START ClobTest #7insert Clob of size = 102400\r\nDEBUG: Got reader for file extinout/charLobLimits.txt java.io.FileReader@38203820\r\nDEBUG: Closed reader for file extinout/charLobLimits.txt java.io.FileReader@38203820\r\nDEBUG: ========================================\r\nDEBUG: START ClobTest #7insert Clob of size = 102400\r\nDEBUG: Got reader for file extinout/charLobLimits.txt java.io.FileReader@46034603\r\nDEBUG: Closed reader for file extinout/charLobLimits.txt java.io.FileReader@46034603\r\nDEBUG: Got FileWriter for extinout/charLobLimits.txt java.io.FileWriter@34243424\r\nDEBUG: writer java.io.FileWriter@34243424 for file extinout/charLobLimits.txt closed\r\nDEBUG: ========================================\r\nDEBUG: START ClobTest #9.1 insert Clob of size = 102401\r\nDEBUG: Got reader for file extinout/charLobLimits.txt java.io.FileReader@5e015e01\r\nDEBUG: Closed reader for file extinout/charLobLimits.txt java.io.FileReader@5e015e01\r\nDEBUG: ========================================\r\nDEBUG: START ClobTest #9.2  - SELECT CLOB of size = 102400\r\nDEBUG: Matched rows selected with clob of size(102400) =0\r\nDEBUG: Select Clob (102400) rows= 0 = 7\r\nDEBUG: ========================================\r\nDEBUG: ========================================\r\nDEBUG: START ClobTest #10 insert Clob of size = 102401\r\nDEBUG: Got reader for file extinout/charLobLimits.txt java.io.FileReader@35f135f1\r\nDEBUG: Closed reader for file extinout/charLobLimits.txt java.io.FileReader@35f135f1\r\nDEBUG: ========================================\r\nDEBUG: START ClobTest #11 insert Clob of size = 102401\r\nDEBUG: Got reader for file extinout/charLobLimits.txt java.io.FileReader@77f277f2\r\nDEBUG: Closed reader for file extinout/charLobLimits.txt java.io.FileReader@77f277f2\r\nDEBUG: Rows deleted =2\r\nDEBUG: ========================================\r\nDEBUG: START ClobTest #12.1  -insertClob of size = 102400\r\nDEBUG: ========================================\r\nDEBUG: START ClobTest #12.2 - SELECT CLOB of size = 102400\r\nDEBUG: Select Clob (102400) rows= 0 = 1\r\nDEBUG: Matched rows selected with clob of size(102400) =0\r\nDEBUG: ========================================\r\nDEBUG: Rows deleted =2\r\nDEBUG: ========================================\r\nDEBUG: START ClobTest #13 (setClob with 4Gb clobinsertClob of size = 4294967296\r\nDEBUG: at the end of test_05_ClobNegative\r\nused 506 ms DEBUG: cleanDatabase start in teardown\r\nDEBUG: cleanDatabase end in teardown\r\nDEBUG: Starting network server:\r\nDEBUG: cleanDatabase start in setup\r\nDEBUG: cleanDatabase end in setup\r\nDEBUG: BIGGEST_LOB_SZ=1048576 BIG_LOB_SZ=102400\r\n.\r\n(net)largedata.LobLimitsTest.test_01_Blob DEBUG: ========================================\r\n\r\nSo based on the above information, I believe that the intermittent error happens after the last test  test_05_ClobNegative in the embedded suite has finished running and while in the teardown code, it keeps running into lock time out exceptions(the drop objects is tried 5 times and we see 5 lock timeouts). Then the network server is started, it goes through the setup method. The setup method in CleanDatabaseTestSetup looks as follows\r\n    protected void setUp() throws Exception {\r\n        if (jdbcClient != null )\r\n        { // We have network client (useNetworkClient) on a given host and port.\r\n            TestConfiguration current = TestConfiguration.getCurrent();\r\n            TestConfiguration modified = new TestConfiguration(current, \r\n                    jdbcClient,\r\n                    hostName, \r\n                    portNo);\r\n            TestConfiguration.setCurrent(modified);\r\n        }\r\n        Connection conn = getConnection();\r\n        conn.setAutoCommit(false);\r\n        \r\n        // compress as well to allow the fixtures wrapped in\r\n        // this decorator to start with a clean database.\r\n      \tprintln(\"cleanDatabase start in setup\");\r\n        CleanDatabaseTestSetup.cleanDatabase(conn, true);  \r\n      \tprintln(\"cleanDatabase end in setup\");\r\n        \r\n        Statement s = conn.createStatement();\r\n        decorateSQL(s);\r\n\r\n        s.close();\r\n        conn.commit();\r\n        conn.close();\r\n    }\r\n\r\nsetup() first does the drop of objects again and then goes through the decorateSQL to create test obects again. This is where in failed intermittent failures, I believe we start seeing more lock time outs for drop table but with network server driver(because the new suite is network server suite). And subsequent try to create the table fails because we were never able to drop the tables successfully because of lock timeouts.\r\n\r\nSorry for this being such a long comment. Please ask me questions if this is not clear. I will post svn diff for simple printlns I put for tracking when setup and teardowns are getting called. I will also put the runall.out for what has finished so far with these extra printlns.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-09T20:09:31.800+0000","updated":"2012-03-09T20:09:31.800+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13226410","id":"13226410","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I have attached the code changes to have some debugging into DERBY5638_patch2_diff.txt. I have also attached runallWithPrintlnTrace.out which is the output of the following large data run with debugging changes\r\n$ time java -Dderby.tests.debug=true -Dderby.tests.trace=true junit.textui.TestRunner org.apache.derbyTesting.functionTests.tests.largedata._Suite > runall.out 2>&1\r\n\r\nThe large data suite is not finished yet and hence runallWithPrintlnTrace.out is not the complete run but it has debugging info to get an idea of when setup and teardown get run.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-09T20:20:00.182+0000","updated":"2012-03-09T20:20:00.182+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13226413","id":"13226413","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I am attaching what a successful run of large data run will look like when the output of the suite has been directed to a file as shown below\r\ntime java  -Dderby.tests.trace=true junit.textui.TestRunner org.apache.derbyTesting.functionTests.tests.largedata._Suite > runall.out 2>&1\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-09T20:23:00.154+0000","updated":"2012-03-09T20:23:00.154+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13226439","id":"13226439","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"thanks mamta for the explanation.  So for the original problem report from myrna we have:\r\n(emb)largedata.Derby5624Test.testDERBY_5624 used 518403 ms .\r\n(emb)largedata.LobLimitsTest.test_01_Blob used 2422 ms .\r\n(emb)largedata.LobLimitsTest.test_02_BlobNegative used 31 ms .\r\n(emb)largedata.LobLimitsTest.test_03_Clob1 used 2375 ms .\r\n(emb)largedata.LobLimitsTest.test_04_Clob2 used 3234 ms .\r\n(emb)largedata.LobLimitsTest.test_05_ClobNegative used 516 ms .\r\n(net)largedata.LobLimitsTest.test_01_Blob used 5360 ms .\r\n(net)largedata.LobLimitsTest.test_02_BlobNegative used 32 ms .\r\n(net)largedata.LobLimitsTest.test_03_Clob1 used 2078 ms .\r\n(net)largedata.LobLimitsTest.test_04_Clob2 used 2390 ms .\r\n(net)largedata.LobLimitsTest.test_05_ClobNegative used 938 ms .\r\n(emb)largedata.LobLimitsTest.test_01_Blob used 9188238 ms .\r\n(emb)largedata.LobLimitsTest.test_02_BlobNegative used 109 ms .\r\n(emb)largedata.LobLimitsTest.test_03_Clob1 used 8116714 ms .\r\n(emb)largedata.LobLimitsTest.test_04_Clob2 used 2164002 ms .\r\n(emb)largedata.LobLimitsTest.test_05_ClobNegative used 685745 ms E \r\n\r\nThe failure is in a setup and has network server in its stack so does seem like next unlist test is failing and causing none of them to be run\r\nand to not report that they are failing.\r\n\r\n\r\nok, i think your opinion is that it is actually the next test failing that is not listed (net) largedata.LoblimitsTest.  I still don't understand why the problem is intermittent and why the first (net)largedata test run does not fail because the previous (emb) largedata.LobLimitsTest.test_05_ClobNegative didn't have an abort. I thought in this output a . meant success and and E or F meant failure in the listed test - i guess errors in the teardown/setup are not handled well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2012-03-09T20:49:38.454+0000","updated":"2012-03-09T20:49:38.454+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13226473","id":"13226473","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"large data test just finished with tracing on. It ran into the intermittent problem again(out of about 10 runs or so, I have gotten into intermittent failure twice). I am attaching the runall.out from this failed run with the tracing on. The attached file is named CompleteRunallWithPrintlnTrace.out","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-09T21:18:05.168+0000","updated":"2012-03-09T21:18:05.168+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13226502","id":"13226502","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Just to be little more specific, I believe it is not the first test in the next suite that is failing, rather it is the setup that, the suite is supposed to do before firing any tests in the suite, is failing. So, (net)largedata.LobLimitsTest.test_01_Blob is not failing because nothing in that test fixture has started running. It is the setup (which attempts to drop the database objects and then create objects) is failing. \r\n\r\nOne thing I am not sure about in case of intermittent failures, why do we get only three lock timeouts with rying to drop objects through network server rather than 5 with embedded. CleanDatabaseTestSetup.removeObjects() has a loop to try to drop objects 5 times. If there is no error on any of those attempts, then we simply quit from that loop, otherwise we throw the exception.\r\n\r\nI will put little more debugging code and fire the test again to see what is happening inside CleanDatabaseTestSetup.removeObjects() when we are going through different iterations etc. Will report more on what I find.\r\n\r\nMike, I agree with you that I don't yet understand either why the problem is intermittent and why do we simply stop when we get table can't be dropped. Maybe we have coded the system such that if the setup for a suite fails, then don't bother running any fixture in that suite.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-09T21:38:28.997+0000","updated":"2012-03-09T21:38:28.997+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13226588","id":"13226588","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I am attaching derby.log(named as derbyallFailWithPrintlnTrace.log) from today's failure with tracing on in the test code. The corresponding console output for it was attached earlier as CompleteRunallWithPrintlnTrace.out","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-09T23:28:55.633+0000","updated":"2012-03-09T23:28:55.633+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13228473","id":"13228473","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"I debugged more to see why we get 5 lock timeouts with embedded driver and then 3 locks with netwrok server before running into intermittent failure. My initial thought was that we will get 5 lock time outs both with embedded and network server before we give up trying to drop the tables.\r\n\r\nHere is the general flow chart from dropping tables point of view when the suite is using CleanDatabaseTestSetup. \r\n\r\nAt the end of the last test fixture in the suite, CleanDatabaseTestSetup.tearDown gets called which does following(focusing on drop table related code, ignoring the code related to dropping aliases, views etc)\r\nCleanDatabaseTestSetup.tearDown->\r\nCleanDatabaseTestSetup.cleanDatabase->\r\nCleanDatabaseTestSetup.removeObjects->\r\n\tJDBC.dropSchema->\r\n\t....\r\n\t// Tables\r\n\trs = dmd.getTables((String) null, schema, (String) null,\r\n                GET_TABLES_TABLE);\r\n\t\t\r\n\tdropUsingDMD(s, rs, schema, \"TABLE_NAME\", \"TABLE\");\r\n\t\t....\r\n\t// At this point there may be tables left due to\r\n        \t// foreign key constraints leading to a dependency loop.\r\n\t// Drop any constraints that remain and then drop the tables.\r\n\t// If there are no tables then this should be a quick no-op.\r\n\t.....\r\n\t// Tables (again)\r\n        \trs = dmd.getTables((String) null, schema, (String) null,\r\n                \tGET_TABLES_TABLE);        \r\n\tdropUsingDMD(s, rs, schema, \"TABLE_NAME\", \"TABLE\");\r\n\r\nThe code in dropUsingDMD is as follows\r\nFirst try to drop the objects in a batch rather than individually.If there is any BatchUpdateException while dropping the objects as a batch, drop the remaining objects inidividually in a for loop. If the for loop gets\r\nan exception but some of the objects before the exception got dropped successfully, then go back into the for loop and try to drop remaining objects again. This continues until either\r\na)All objects are dropped and we can return\r\nb)no objects can be dropped because of exception\r\n\r\nAfter this CleanDatabaseTestSetup.tearDown is finished(with or without success), the control goes to the CleanDatabaseTestSetup.setUp for the next suite. Among other things, CleanDatabaseTestSetup.setUp does following 2 main steps \r\n1)call CleanDatabaseTestSetup.cleanDatabase (drop any objects in the db)\r\n2)call decorateSQL(create new objects in the db)\r\n\r\nNow, let's go through this code in our intermittent failure case. The last test from the embedded suite LobLimitsTest finishes with no errors and we go to CleanDatabaseTestSetup.tearDown(). This eventually leads to JDBC.dropUsingDMD as shown above. \r\n\r\nIn JDBC.dropUsingDMD(), we first try to drop all the tables as a batch rather than individual drops. Here, we get the first lock timeout. Since we failed here, next we go in a loop to drop the tables individually. Here we manage to drop \"APP\".\"CLOBTBL2\" but get lock time out(2nd one) for trying to drop \"APP\".\"CLOBTBL\". But since the loop was able to drop at least one table, we go back into the loop to try to drop remaining tables. But that results into 3rd lock timeout for \"APP\".\"CLOBTBL\".  After these tries, the control goes back to JDBC.dropSchema where we try to drop the tables yet again after dropping any constraints which may be preventing the table drops(in our case, I don't believe we have any constraints in the db). This 2nd attempt at dropping the table takes us back to JDBC.dropUsingDMD.Again we try to drop all the tables as batch but get the 4th lock timeout for \"APP\".\"CLOBTBL\". Next, we try to drop the tables inidividually in a loop, but the drop of \"APP\".\"CLOBTBL\" fails with 5th lock timeout. And since we were not able to drop any table in the loop, we exit out of the loop and eventually exit out of CleanDatabaseTestSetup.tearDown without reporting all this as a failure even though we were not able to clean the database of it's objects.\r\n\r\nNext, before the beginning of the next suite(which in our case happens to be network server suite), we go through the CleanDatabaseTestSetup.setUp code. As explained earlier, one of the things that CleanDatabaseTestSetup.setUp does is to call CleanDatabaseTestSetup.cleanDatabase. Which again goes through the drop table logic as explained above. It will attempt to drop the existing tables \r\nin batch but that runs into 1st lock timeout for \"APP\".\"CLOBTBL\". Next, it tries to drop the table individually, and it runs into 2nd lock timeout. Then the control goes back to CleanDatabaseTestSetup.removeObjects which calls drop table again after it drops the constraints. This time around, the batch exception runs into 3rd lock timeout exception. With my understanding of\r\nthe code, we should have run into 4th lock timeout trying to drop the table individually but for some reason, I don't see that 4th lock time out with DRDA driver in derby.log. In any case, we once again exit \r\nCleanDatabaseTestSetup.cleanDatabase without successfully getting rid of all the tables and next step in CleanDatabaseTestSetup.setUp is the call to decorateSQL().decorateSQL fails when it tries to create tables but they already exist in the database becaue CleanDatabaseTestSetup.cleanDatabase was not able to get rid of them and that is why we get the exception Table/View 'BLOBTBL' already exists in Schema 'APP'.\r\n\r\nI am not sure why this locking issue is only intermittent but atleast we understand what is happening during the suite runs.\r\n\r\nNot sure if it is correct for CleanDatabaseTestSetup.cleanDatabase to run into exceptions while doing the cleanup but ignore those exceptions. I ran into a very old jira DERBY-2220(Uncommitted transactions executed throught XAResource will held locks after the application terminates (or crashes during the transaction).) where there was a brief conversation about how may be CleanDatabaseTestSetup.cleanDatabase should drop the database if it is not able to drop the objects inside the database. Here is part of Dan Debrunner's comment on that issue\r\n******************\r\nI also think that you've found an issue in the clean database decorator and as \r\nsuch it would be good to fix it centrally there, rather than in a single test. \r\nfor example, if the clean database decorator failed to cleanup the database, \r\nit could report the failure and then blow away the database.\r\n******************\r\n\r\nWe can do atleast one of the two things for this particular jira at this point (or may be even both)\r\n1)Have CleanDatabaseTestSetup.cleanDatabase report that it is having trouble deleting the objects and hence it will drop the database and create the objects mentioned in decorateSQL. This will get rid of intermittent failures in large data suite but it will not explain why do we intermittently run into lock timeouts\r\n2)Debug why we are running into intermittently lock timeouts with large data suite. I am running the tests with derby.locks.deadlockTrace=true to see if it will give us more information about the locks.\r\n\r\nPlease let me know if there are any other options we could be pursuing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-13T16:02:08.184+0000","updated":"2012-03-13T16:02:08.184+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13228534","id":"13228534","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"One of the tests run as part of large data suite is Derby5624Test which has following in protected static Test baseSuite(String name)\r\n        return new CleanDatabaseTestSetup(\r\n                DatabasePropertyTestSetup.setLockTimeouts(suite, 2, 4)) \r\n        {\r\n\r\nMike said the test really doesn't need that lock timeout setting and may be it is interferring with the locks timeouts that we see later on in subsequent suites in large data suite. I will remove that lock timeout setting from Derby5624Test and run the test on my machine to make sure it runs. If it does, then I will go ahead and commit that change to see if the intermittent problems disappear.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-13T17:40:33.586+0000","updated":"2012-03-13T17:40:33.586+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13229245","id":"13229245","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Based on the fact that all the test fixtures fnish with no problems and it is the teardiwn/setup that is running into locking issues, I will work on the suite not relying on CleanDatabaseTestSetup. Instead, use a decorator which will drop the database and recreate it with the tables needed to run the suite. Currently, the sql to create the tables is in decorateSQL() as required by CleanDatabaseTestSetup\r\n        Test suite = new CleanDatabaseTestSetup(\r\n                TestConfiguration.orderedSuite(LobLimitsTest.class)) {\r\n            protected void decorateSQL(Statement s)\r\n                           throws SQLException {\r\n                setupTables(s, biggestSize, bigSize);\r\n            }\r\n        };\r\n\r\nI am wondering if I have to use DropDatabaseSetup to accomplish dropping the database and then putting the setupTables in some special method so the tables get created at the beginning of the next suite. If anyone has any experience in this area, please let me know. Thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-14T15:02:53.254+0000","updated":"2012-03-14T15:02:53.254+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13229538","id":"13229538","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Hi Mamta,\r\n\r\n\r\nIf the goal is to drop the database, I think the best thing is to use the singleUseDatabaseDecorator in TestConfiguration\r\n\r\nHowever, I think it might be better to understand why the fixtures in the test are holding locks and fix that.  Probably just putting a commit at the end of each fixture will take care of that.    For example, I see in test_01_Blob() that  it has autocommit off the last thing it does is:\r\n\r\n      commit();\r\n\r\n        deleteTable(\"BLOBTBL\", 3);\r\n\r\nbut the deleteTable would not get committed and would hold locks.  An additional commit() should clear that up.\r\n\r\n\r\n\r\n\r\n\r\n\r\nI have only read your last comment so forgive me if this has been covered as an option.\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-03-14T19:29:09.822+0000","updated":"2012-03-14T19:29:09.822+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13229576","id":"13229576","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Hi Myrna, thanks so much for taking the time to respond. \r\n\r\nI recall looking through the code for missing incomplete transactions and deleteTable was one of the methods I checked and I found that it has a commit of it's own as shown below\r\n    private void deleteTable(String table,\r\n            int expectedRows) throws SQLException {\r\n        int count = createStatement().executeUpdate(\r\n                \"DELETE FROM \" + JDBC.escape(table));\r\n        commit();\r\n        verifyTest(count, expectedRows, \"Rows deleted =\");\r\n    }\r\n\r\nAs for singleUseDatabaseDecorator, I have been playing with it this morning. I ran the test with that fixture but I am running into test table creation/drop off problems because setup and teardown methods get called for every test fixture. But this test has test fixtures which rely on data changes from previous fixtures(the suite has been coded to run the test fixtures in specific order through  TestConfiguration.orderedSuite(LobLimitsTest.class)) and hence we do not want tables to be dropped and recreated through setup and teardown around every test fixture, I am looking at tweaking the setup code to not always create the tables. Will post once I have the changes working or if I have further questions.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-14T20:17:14.234+0000","updated":"2012-03-14T20:17:14.234+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13229992","id":"13229992","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"If there's an index on the table whose rows are deleted, there will be post-commit work scheduled that could hold locks when tearDown() is executed. If that's what's causing the timeouts, you might try one of these approaches:\r\n\r\n1) Wait for post-commit to finish after having deleted the rows. This can be done by calling T_Access.waitForPostCommitToFinish() in a stored procedure after deleteTable(). See ReleaseCompileLocksTest for an example.\r\n\r\n2) Use TRUNCATE TABLE instead of DELETE in the deleteTable() method. In addition to being faster on large tables, it also avoids post-commit work and shouldn't cause any concurrent locking to happen during tearDown().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2012-03-15T08:54:44.079+0000","updated":"2012-03-15T08:54:44.079+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13230335","id":"13230335","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Hi Knut, I appreciate you taking the time to look at this. \r\n\r\nI have another alternative approach(which requires just one line change to large data suite network server run) to fix the problem with intermittent lock time out issues possibly because of background threads trying to finish post-commit changes related to large objects. \r\n\r\nThe issue has been that the CleanDatabaseTestSetup , after the last test fixture of embedded suite is done, tries to drop the tables but runs into lock timeout errors and hence it never finishes dropping the tables. None of these errors get reported anywhere by CleanDatabaseTestSetup and we simply move on to the next suite which in our case is network server running the large data tests. As part of CleanDatabaseTestSetup decorator for network server, we try to drop the existing objects in the database again before creating the new objects required by the new suite and the drop tables again run into lock timeouts. \r\n\r\nWhat I am suggesting as a solution is to have the network server suite use a brand new database to do it's testing via singleUseDatabaseDecorator and that way it will not run into locks held on the database used by the embedded run of large data tests. The change is fairly easy(just one line change) in LobLimitsClientTest.suite(). The changed LobLimitsClientTest,suite looks as follows\r\n    public static Test suite() {\r\n        return TestConfiguration.singleUseDatabaseDecorator(\r\n             TestConfiguration.clientServerDecorator(LobLimitsTest.suite()));\r\n    }\r\nThe original LobLimitsClientTest,suite() in svn looks as follows\r\n     public static Test suite() {\r\n        return TestConfiguration.clientServerDecorator(LobLimitsTest.suite());\r\n     }\r\n }\r\n\r\n\r\nI ran the large data suite twice on my machine with this change and I don't see the lock timeout from network server in the log file anymore. I will go ahead and commit this change.\r\n\r\nAdditionally, I will create a new jira for CleanDatabaseTestSetup about not reporting failures while trying to clean the database by dropping the objects., Either, it should report those errors in fail directory or somewhere else so we can diagnose more easily if the subsequent suite fails because of left over database objects from the previous suite. Or it can try to drop the objects as it does but if it can't drop them successfully, then it should drop the database and create a brand new database which is clean for the next suite to use. One of the things that CleanDatabaseTestSetup can do is what Knut suggested. Do TRUNCATE TABLE if it is having trouble dropping the tables and then try to drop the tables again or wait for post-commit to finish by calling T_Access.waitForPostCommitToFinish() before dropping objects from the database.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-15T17:25:11.744+0000","updated":"2012-03-15T17:25:11.744+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13233931","id":"13233931","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"The large data test ran into out of disk space problem in one out of the 2 runs since the checkin on the March 15th. After clearing up the space by deleting few old runs, the test ran fine the 2nd time.\r\n\r\nIt will be good idea to reduce the size of the wombat database after every large data suite has finished thus successful runs will not occupy too much disk space. I went with Knut's recommendation to add truncate table as part of the cleanup in deleteTable() method. I kept the delete from table code too because delete follows a different code path than truncate and it will be good for us to test both code paths in case of large data testing. The deleteTable() method looks as follows in my codeline\r\n    private void deleteTable(String table,\r\n            int expectedRows) throws SQLException {\r\n    \tStatement s = createStatement();\r\n        //Keep the delete call to exercise delete of long blobs and clobs.\r\n    \t// This is a separate code path through Derby compared to truncate\r\n    \t// table code path.\r\n        int count = s.executeUpdate(\r\n                \"DELETE FROM \" + JDBC.escape(table));\r\n        //Adding truncate call which will give back the disk space being \r\n        // used by the table at commit time rather than wait for test \r\n        // infrastructure to drop the table.\r\n        s.executeUpdate(\"TRUNCATE TABLE \" + JDBC.escape(table));\r\n        commit();\r\n        verifyTest(count, expectedRows, \"Rows deleted =\");\r\n    }\r\n\r\nWhat I found with this change is that the wombat/log directory is much larger than it was without the truncate table call.\r\n\r\nlog directory looks as follows with the svn codeline(ie without the truncate table call)\r\n$ ls -l log\r\ntotal 3702\r\n----------+ 1 mamta mkgroup      48 Mar 14 16:56 log.ctrl\r\n----------+ 1 mamta mkgroup 2738408 Mar 14 16:56 log440.dat\r\n----------+ 1 mamta mkgroup 1048576 Mar 14 19:00 log441.dat\r\n----------+ 1 mamta mkgroup      48 Mar 14 16:56 logmirror.ctrl\r\n\r\nlog directory with large data suite run with truncate table call as shown in the deleteTable method looks as follows\r\n$ ls -l log\r\ntotal 312254\r\n----------+ 1 mamta mkgroup       48 Mar 19 17:02 log.ctrl\r\n----------+ 1 mamta mkgroup 26765701 Mar 19 17:00 log416.dat\r\n----------+ 1 mamta mkgroup 33559814 Mar 19 17:00 log417.dat\r\n----------+ 1 mamta mkgroup 33560037 Mar 19 17:01 log418.dat\r\n----------+ 1 mamta mkgroup 33791143 Mar 19 17:01 log419.dat\r\n----------+ 1 mamta mkgroup 31539171 Mar 19 17:01 log420.dat\r\n----------+ 1 mamta mkgroup  6268114 Mar 19 17:01 log421.dat\r\n----------+ 1 mamta mkgroup  3071813 Mar 19 17:01 log422.dat\r\n----------+ 1 mamta mkgroup 31544805 Mar 19 17:01 log423.dat\r\n----------+ 1 mamta mkgroup 33529672 Mar 19 17:01 log424.dat\r\n----------+ 1 mamta mkgroup 33503893 Mar 19 17:01 log425.dat\r\n----------+ 1 mamta mkgroup 33768332 Mar 19 17:02 log426.dat\r\n----------+ 1 mamta mkgroup 17774482 Mar 19 17:02 log427.dat\r\n----------+ 1 mamta mkgroup  1048576 Mar 19 18:47 log428.dat\r\n----------+ 1 mamta mkgroup       48 Mar 19 17:02 logmirror.ctrl\r\n\r\nI talked to Mike about the change in number of files in log directory and he mentioned that if we actually look at the number in the log file names(for eg for428.dat), we will see that Derby didn't have to write as much to the log when we use truncate table which is a good sign. As can be seen above, with truncate table, the last log files name is log428.dat whereas log file name with trunk codeline run is log441.dat  \r\n\r\nThe reason we see large number of log files with truncate table is that probably a checkpoint was not issued. Checkpoints are issued periodically and among other things, it;s frequency also depends on how many log files have been written so far.\r\n\r\nI tried connecting to the wombat directory with large number of log files through ij and after getting out of ij, I saw that there were only 3 log files left in log directory as shown below\r\n$ ls -l\r\ntotal 1026\r\n----------+ 1 mamta mkgroup      48 Mar 20 10:20 log.ctrl\r\n----------+ 1 mamta mkgroup 1048576 Mar 20 10:20 log428.dat\r\n----------+ 1 mamta mkgroup      48 Mar 20 10:20 logmirror.ctrl\r\n\r\nThe reason for reduction in number of log files is as part of booting up wombat through ij, we applied all the left over log files to the database and hence as part of recovery, the log files were deleted since they are not needed any more.\r\n\r\nBased on this experiment, in addition to having truncate table in deleteTable() method, I plan on adding a test fixture to LobLimitsTest class and that test fixture will just shutodwn the databases. As part of the shutdown, the logs will get applied and hence at the end of the suite, the size of the wombat database will be much smaller and there won't be left over huge log files left behind after a successful run.\r\n\r\nOnce I have the tests running successfully with this change and verify that log directory is indeed much smaller, i will post a patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-20T23:15:48.382+0000","updated":"2012-03-20T23:15:48.382+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13235248","id":"13235248","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"The changes committed so far for this jira will be ok for backport if we decide to do that at some point.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-03-22T00:23:42.542+0000","updated":"2012-03-22T00:23:42.542+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13430606","id":"13430606","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"body":"Changes were committed for this jira in March.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mamtas","name":"mamtas","emailAddress":"msatoor at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mamta A. Satoor","active":true},"created":"2012-08-07T20:42:41.555+0000","updated":"2012-08-07T20:42:41.555+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13453372","id":"13453372","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Reopen for backport. Assign yourself temporarily to backport and reassign to Mamta before resolving","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2012-09-11T20:26:15.068+0000","updated":"2012-09-11T20:26:15.068+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13454887","id":"13454887","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"assigning to me for the backport.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2012-09-13T13:32:33.685+0000","updated":"2012-09-13T13:32:33.685+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13455400","id":"13455400","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"backported to 10.8 with revision 1384589 (http://svn.apache.org/viewvc?view=revision&revision=1384589) from trunk. largedata._Suite ran fine on windows 7 with ibm 1.6.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2012-09-13T22:56:37.487+0000","updated":"2012-09-13T22:56:37.487+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13455427","id":"13455427","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"I'm marking this as backport_reject_10_7 because the test was not in junit format with 10.7, so this failure would not occur.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2012-09-13T23:22:08.795+0000","updated":"2012-09-13T23:22:08.795+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12544834/comment/13823440","id":"13823440","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"[bulk update: close all resolved issues that haven't had any activity the last year]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2013-11-15T08:15:15.838+0000","updated":"2013-11-15T08:15:15.838+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-5638/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06ff3:"}}
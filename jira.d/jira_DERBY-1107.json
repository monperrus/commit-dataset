{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12330229","self":"https://issues.apache.org/jira/rest/api/latest/issue/12330229","key":"DERBY-1107","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313771","id":"12313771","description":"build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09","name":"10.5.1.1","archived":false,"released":true,"releaseDate":"2009-04-28"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-03-25 16:04:56.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22308","customfield_12310222":"1_*:*_1_*:*_84018675551_*|*_6_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2008-11-10T17:20:00.551+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1107/watchers","watchCount":0,"isWatching":false},"created":"2006-03-14T06:48:45.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10920","id":"10920","description":"initial source drop","name":"10.0.2.0","archived":false,"released":true,"releaseDate":"2004-08-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/10991","id":"10991","description":"snapshot","name":"10.0.2.1","archived":false,"released":true,"releaseDate":"2004-12-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12310615","id":"12310615","description":"","name":"10.1.2.1","archived":false,"released":true,"releaseDate":"2005-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12311953","id":"12311953","description":"","name":"10.1.3.1","archived":false,"released":true,"releaseDate":"2006-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12317096","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12317096","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12375774","key":"DERBY-3000","self":"https://issues.apache.org/jira/rest/api/2/issue/12375774","fields":{"summary":"getTables() call with 10.3 causes java.sql.SQLException: The parameter position '8' is out of range.  The number of parameters for this prepared  statement is '7'.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}},{"id":"12322193","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12322193","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"inwardIssue":{"id":"12407595","key":"DERBY-3933","self":"https://issues.apache.org/jira/rest/api/2/issue/12407595","fields":{"summary":"Reference Manual: document new SYSCS_UTIL.SYSCS_UPDATE_METADATA_QUERIES() system procedure","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/improvement.png","name":"Improvement","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-02T02:29:17.508+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11407","id":"11407","name":"JDBC"}],"timeoriginalestimate":null,"description":"The JDBC DatabaseMetaData queries are stored as stored prepared statements in the database.   If a bug is fixed for any of the metadata calls it can require that these queries be changed.  Currently  existing databases will not get updated properly if a bug is fixed.  Ideally the metadata queries should match the derby version that is running.  That way we avoid situations where the query is not compatible with the Derby version running.\n\nTo confirm I :\n1) created a database with 10.1.1.0\n2) Made a  metadata change in my 10.1.2.4 client.\n3) Connected to the 10.1.1.0 database with 10.1.2.4 and saw that there was no change to the stored prepared statements in SYS.SYSSTATEMENTS\n\nI also confirmed that  a  database created with 10.1.2.4 does not get changed when reverting to 10.1.1.0.\n\n\nBelow this line is some history and reference that might be helful to someone fixing this issue:\n------------------------------------------------------------------------------------------------------------------------------------------------\nIn discussing DERBY-970, the subject of  the metadata stored prepared statements \ncame up.\nThe general questions are:\n\n    1) Why do we  use  stored prepared statements for metadata queries?    \n    2) What issues might there be related to upgrade/downgrade  with the \nmetadata stored prepared statements?\n    3) How do we  address potential upgrade/downgrade issues?\n        \n\n\nGENERAL HISTORY:\n- Cloudscape 5.x had stored prepared statements, a way to store precompiled \nstatements in the database.  This is no longer exposed externally.\n- Metadata stored prepared statements were a performance optimization  that \npredated the statement cache.\n- In the past, this performance optimization has been of particular  importance \nto gui database browsers that execute all the metadata methods on connection to \nthe database.  This would still probably be an issue with embedded even with the \nstatement cache.\n-  All stored prepared statements get recompiled on the first connection to the \ndatabase if the version changes.\n\n\nUPGRADE HISTORY\n- In Cloudscape 5.1,  the metadata stored prepared statements have traditionally \nbeen a source of trouble for even minor version changes as queries change or \nthey refer to methods/stored procedures  that may or may not exist in the target \nversion and cannot recompile or execute.  \n-  The solution to the problem in  Cloudscape v5.1.60  was to automatically \nalways call DD_Version.dropJDBCMetadataSPSes() whenever the version changed up \nor down in upgradeIfNeeded().\n- The workaround before this change to do this automatically was to call this \nmethod manually:\n|    CALL Factory.getDatabaseOfConnection().\n        dropAllJDBCMetaDataSPSes()|\n\nHOW DERBY WORKS TODAY:\n\n-  In Derby we now only call  dropJDBCMetadataSPSes() on fullUpgrade and it has \nbeen this way since contribution.\n-  I think the problems of upgrade/downgrade for metadata stored prepared \nstatements may exist in Derby.\n-   I don't know a workaround to drop the metadata stored prepared statements if \nwe need to deliver a bug fix or how the ugprade/downgrade is handled currently.\n- I seem to recall some special handling in Derby for soft upgrade for optimizer directives, but don't know the details.\n\nRECENT DISCUSSIONS:\nIn discussing DERBY-970, the subject of  the metadata stored prepared statements \ncame up.\nThe general questions are:\n\n    1) Why do we  use  stored prepared statements for metadata queries?    \n    2) What issues might there be related to upgrade/downgrade  with the \nmetadata stored prepared statements?\n    3) How do we  address potential upgrade/downgrade issues?\n        \n\nMY QUESTIONS\nAnyone know when/why  the dropJDBCMetadataSPSes()  on all version changes was \nremoved between Cloudcape 5.1.60 and  contribution? \nHow do we deliver bug fixes for metadata queries or handle changes in the \nmetadata  queries in Derby?\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"38783","summary":"For existing databases JDBC metadata queries do not get updated properly  between maintenance versions.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10422","value":"High Value Fix","id":"10422"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":24,"total":24,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12371835","id":"12371835","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I have had a look at the code, and I'm not sure there is a problem\r\nwith SPSs and upgrade.\r\n\r\nIn hard/full upgrade, dropJDBCMetadataSPSes() is called, hence the\r\nSPSs are dropped and regenerated.\r\n\r\nIn soft upgrade mode, SPSs aren't used. Instead,\r\nEmbedDatabaseMetaData.getPreparedQuery() will read the query directly\r\nfrom metadata.properties.\r\n\r\nWhen you did the upgrade/downgrade test, did you confirm that the\r\nmetadata calls returned incorrect/old results, or did you only look at\r\nthe contents of SYS.SYSSTATEMENTS?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-03-25T16:04:56.000+0000","updated":"2006-03-25T16:04:56.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12372034","id":"12372034","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"This issue is not related to upgrade but to maintenance version (3 and 4th digit )  changes.\r\nIf a bug is fixed in the metadata on a new maintenence version the bug fix is not picked up if you change to a newer version.  e.g. 10.1.2.1  to 10.1.2.4.   Nor does it go back to the old query version when you go back to 10.1.2.1.\r\n\r\nI tend to think handleMinorRevisionChange needs to drop the JDBC SPS's in addition to clearing the SPS plans in this case, but am not totally sure.\r\n\r\nAt the time I tested I just checked the SPS's but I think that a metadata call would not act like soft upgrade for this case.\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-03-28T07:10:20.000+0000","updated":"2006-03-28T07:10:20.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12372265","id":"12372265","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"I tried running a test like the one Kathey did, and I can verify that\r\nthe queries returned the old results even after the upgrade. Adding\r\ncode for dropping and regenerating the SPSs in\r\nhandleMinorRevisionChange() made it work.\r\n\r\nSince handleMinorRevisionChange() is called on all types of version\r\nchanges, I suggest that we move the code for dropping/regenerating\r\nSPSs from doFullUpgrade() to handleMinorRevisionChange(). The attached\r\npatch (derby-1107-proposal1.diff) shows this change. I have not tested\r\nthe patch very much, it is only meant as a starting point for a\r\ndiscussion on how to solve the problem.\r\n\r\nI can't see that dropping the SPSs between maintenance releases should\r\ncause any problems.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-03-29T23:56:31.000+0000","updated":"2006-03-29T23:56:31.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12372342","id":"12372342","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Knut for looking at this.  I have always known there were issues with this but never understood them well enough to dive in myself and think I could fix it so bear with me while I ask some questions about your fix and also the preexisting code.\r\n\r\nBEFORE YOUR CHANGE.\r\n\r\n1) There is one statement in the SYSIBM schema,  METADATA but it does not get created here.  There is a method in DataDictionaryImple createSystemSps that creates both but that is not called here.  It does seem to get created when a database is created via a call  DataDictionaryImpl.createSystemSps.   Should it be created and what is  the impact of not creating it?\r\n\r\nAFTER  YOUR CHANGE\r\n\r\n2)  I think even if this goes into 10.1 right away,  the bug still exists when reverting to versions earlier than the fix. This means that we would have to be careful to make sure any changes to the metadata queries worked with the old version. For example we could not  add a new function  call to the metadata queries that get loaded with 10.1, because then reverting to the old version would fail because the java class would not be  there.    Maybe that is not so bad, because it is only changes on 10.1 itself we would have to watch out for.  For 10.2 and higher it would get loaded from metadata.properties on soft upgrade.  Is that correct?\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n \r\n\r\n1)  It seems to me that  assuming your fix went into 10.1 right away,  we still have and will always have an issue with the metadata statements getting updated properly when you go back to a 10.1 version prior to the fix for DERBY-1107.\r\nThis would mean that  none of the existing statements could have new stored procedure calls added.  This is because those stored procedures could not be used when you go back to a previous versions.  Is that correct? \r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nBear with me while I \r\n\r\nThen the only issue we have is one that cannot be solved.  \r\nThat problem is that metadata queries will not get dropped when reverting to 10.1 releases before \r\n\r\nThe issue that we will always have to be careful of is that  the metadata queries that get accessed with the metadata queries that get loaded  with 10.1 will not be able to reference any new stored procedures, because.  Addition of \r\n\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-03-30T09:04:26.000+0000","updated":"2006-03-30T09:04:26.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12372346","id":"12372346","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Sorry there was some cruft that printed with my previous comment.\r\nCan't delete anymore. Comment should have been just the first part:\r\n\r\nThanks Knut for looking at this. I have always known there were issues with this but never understood them well enough to dive in myself and think I could fix it so bear with me while I ask some questions about your fix and also the preexisting code.\r\n\r\nBEFORE YOUR CHANGE.\r\n\r\n1) There is one statement in the SYSIBM schema, METADATA but it does not get created here. There is a method in DataDictionaryImple createSystemSps that creates both but that is not called here. It does seem to get created when a database is created via a call DataDictionaryImpl.createSystemSps. Should it be created and what is the impact of not creating it?\r\n\r\nAFTER YOUR CHANGE\r\n\r\n2) I think even if this goes into 10.1 right away, the bug still exists when reverting to versions earlier than the fix. This means that we would have to be careful to make sure any changes to the metadata queries worked with the old version. For example we could not add a new function call to the metadata queries that get loaded with 10.1, because then reverting to the old version would fail because the java class would not be there. Maybe that is not so bad, because it is only changes on 10.1 itself we would have to watch out for. For 10.2 and higher it would get loaded from metadata.properties on soft upgrade. Is that correct?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2006-03-30T09:30:09.000+0000","updated":"2006-03-30T09:30:09.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12372427","id":"12372427","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Kathey wrote:\r\n\r\n> BEFORE YOUR CHANGE.\r\n>\r\n> 1) There is one statement in the SYSIBM schema, METADATA but it does\r\n>    not get created here. There is a method in DataDictionaryImple\r\n>    createSystemSps that creates both but that is not called here. It\r\n>    does seem to get created when a database is created via a call\r\n>    DataDictionaryImpl.createSystemSps. Should it be created and what\r\n>    is the impact of not creating it?\r\n\r\nThis is interesting! Only statements in the SYS schema are dropped and\r\nregenerated. To check what happens on upgrade, I created a database\r\nwith 10.1.2.1 and looked at the values returned by \"execute statement\r\nSYSIBM.METADATA\" in 10.2 with soft and hard upgrade. The values were\r\n*not* the same as when I created the database with 10.2. The changes\r\nare probably caused by DERBY-965 which modified the METADATA\r\nstatement.\r\n\r\nI think we should drop the SPSs in both SYSIBM and SYS when performing\r\na hard upgrade and use createSystemSps() to regenerate them. This\r\nwould however not solve the soft upgrade case for SYSIBM.METADATA. We\r\nneed to make SystemProcedures.METADATA() read metadata_net.properties\r\nwhen running in soft upgrade mode.\r\n\r\n> AFTER YOUR CHANGE\r\n>\r\n> 2) I think even if this goes into 10.1 right away, the bug still\r\n>    exists when reverting to versions earlier than the fix. This\r\n>    means that we would have to be careful to make sure any changes\r\n>    to the metadata queries worked with the old version. For example\r\n>    we could not add a new function call to the metadata queries that\r\n>    get loaded with 10.1, because then reverting to the old version\r\n>    would fail because the java class would not be there. Maybe that\r\n>    is not so bad, because it is only changes on 10.1 itself we would\r\n>    have to watch out for. For 10.2 and higher it would get loaded\r\n>    from metadata.properties on soft upgrade. Is that correct?\r\n\r\nAll of what you said above is correct.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2006-03-30T21:20:54.000+0000","updated":"2006-03-30T21:20:54.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12372616","id":"12372616","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"> I think we should drop the SPSs in both SYSIBM and SYS when performing\r\n> a hard upgrade and use createSystemSps() to regenerate them. This\r\n> would however not solve the soft upgrade case for SYSIBM.METADATA. We\r\n> need to make SystemProcedures.METADATA() read metadata_net.properties\r\n> when running in soft upgrade mode. \r\n\r\nGood find!. This would need to get fixed for SUR metadata changes to\r\nwork correctly under both soft and hard upgrade when running with the\r\nclient! (it would not be a regression though, due to DERBY-965).\r\nI think your suggestion makes good sense.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2006-03-31T10:50:13.000+0000","updated":"2006-03-31T10:50:13.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12372617","id":"12372617","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"body":"> I think we should drop the SPSs in both SYSIBM and SYS when performing\r\n> a hard upgrade and use createSystemSps() to regenerate them. This\r\n> would however not solve the soft upgrade case for SYSIBM.METADATA. We\r\n> need to make SystemProcedures.METADATA() read metadata_net.properties\r\n> when running in soft upgrade mode. \r\n\r\nGood find!. This would need to get fixed for SUR metadata changes to\r\nwork correctly under both soft and hard upgrade when running with the\r\nclient! (it would not be a regression though, due to DERBY-965).\r\nI think your suggestion makes good sense.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagw","name":"dagw","emailAddress":"dag dot wanvik at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagw&avatarId=16789","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagw&avatarId=16789","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagw&avatarId=16789","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagw&avatarId=16789"},"displayName":"Dag H. Wanvik","active":true},"created":"2006-03-31T10:50:16.000+0000","updated":"2006-03-31T10:50:16.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12542860","id":"12542860","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I wonder if the best way to resolve this is to introduce a new stored procedure that can drop all the metadata SPS;s similar to the old Cloudscape procedure\r\nhttp://publibfi.boulder.ibm.com/epubs/html/cloud51/javadoc/com/ibm/db2j/database/Database.html#dropAllJDBCMetaDataSPSes()\r\n\r\nThis could be run, if someone needed an update to a metadata statement on upgrade.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2007-11-15T19:40:08.658+0000","updated":"2007-11-15T19:40:08.658+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12642006","id":"12642006","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I think I will approach this by creating a stored procedure \r\nSYSCS_UTIL.SYSCS_UPDATE_METADATA_QUERIES()\r\n\r\nI think trying to do something automatic is going to be problematic because if we automatically update the metadata queries on upgrade, they may not be valid if the user downgrades their version.  Please let me know if you have any concerns.  \r\n\r\nSilly question...\r\n\r\nIs it ok/possible to add a system stored procedure in a maintenance branch or would this change have to be limited to the trunk.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-10-22T23:36:20.288+0000","updated":"2008-10-22T23:36:20.288+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12642432","id":"12642432","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"> Is it ok/possible to add a system stored procedure in a maintenance branch or would this change have to be limited to the trunk.\r\n\r\nPossible: Not sure. I thought the system stored procedures were only created when the database was created or when the database was upgraded (new minor version). So I think you would need (a) a way to create the procedure when no database upgrade has taken place, and (b) a way to tell the upgrade code to only create this procedure if it hasn't already been created. Those mechanisms haven't been needed before since the set of system procedures was uniquely identified by the major.minor version.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-10-24T10:39:45.216+0000","updated":"2008-10-24T10:39:45.216+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12642974","id":"12642974","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Attached is a patch to add the SYSCS_UTIL.SYSCS_UPDATE_METADATA_QUERIES()\r\n\r\nsystem stored procedure.  I am running tests now.   I manually tested the change by backing out the change for DERBY-876 and creating a database and then calling the stored procedure once the correct metadata.properties was restored.\r\n\r\nThe patch doesn't include regression tests. I am not quite sure how to automate regression tests for this.  Any advice is welcome.\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-10-27T17:45:38.969+0000","updated":"2008-10-27T17:45:38.969+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12643039","id":"12643039","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"There were a couple of tests that needed to be updated because of the extra system procedure.  Those are included in the new patch derby-1107_diff2.txt\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-10-27T20:15:58.116+0000","updated":"2008-10-27T20:15:58.116+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12644161","id":"12644161","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"body":"I had a look at the patch and it all seems reasonable to me.\r\n\r\nToo bad we can't do something automatic. Maybe it's something to keep in mind for a possible version 11...(then we're talking migration rather than upgrade, and we could make the change to always drop & recreate).\r\n\r\nI do think the new procedure needs to be documented in such a way that customers doing upgrades can find it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=myrna","name":"myrna","emailAddress":"m dot v dot lunteren at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Myrna van Lunteren","active":true},"created":"2008-10-30T23:30:24.231+0000","updated":"2008-10-30T23:30:24.231+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12644303","id":"12644303","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chaase3","name":"chaase3","emailAddress":"camilla dot haase at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kim Haase","active":true},"body":"I created DERBY-3933 to add documentation for this procedure to the Reference Manual.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chaase3","name":"chaase3","emailAddress":"camilla dot haase at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kim Haase","active":true},"created":"2008-10-31T14:18:20.242+0000","updated":"2008-10-31T14:18:20.242+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12644312","id":"12644312","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Could the procedure be tested by checking the columns LASTCOMPILED and VALID in SYS.SYSSTATEMENTS? VALID is true when the statement has been compiled and no recompilation is needed, and false otherwise. LASTCOMPILED should contain a time stamp telling the last time the statement was compiled. So after the procedure has been called, all meta-data statements should have VALID=false and LASTCOMPILED=NULL.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-10-31T14:54:55.416+0000","updated":"2008-10-31T14:54:55.416+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12644789","id":"12644789","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"I attempted to add the test described by Knut Anders to DatabaseMetaDataTest and found failures in the upgrade tests because the procedure didn't exist in old versions.  When I disabled the test for versions less than 10.5 and I got assertion failures checking the SYSSTATEMENTS columns, which I don't fully understand. But all of this got me thinking.  Firstly I think that users shouldn't be able to update metadata queries if the database version less than 10.5 because there will be no procedure available to restore the metadata queries if they go back.  Secondly I think maybe we can automate this after all.  If we make the logic:\r\n\r\nIf the database version >=10.5 update the metadata queries on any version change (up or down).\r\n\r\nBut I want to make sure that this will really work. For some reason I can't remember I thought it might not in the past. Maybe something related to soft upgrade handling of metadata queries?  Does anyone have thoughts on this?\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-11-03T19:25:57.244+0000","updated":"2008-11-03T19:25:57.244+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12645323","id":"12645323","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Attached is an alternate automatic fix for this issue.  We will drop and recreate the SPSes with any version change up or down, as long as the database version is  >= 10.5.  This  should prevent any problems going back after soft upgrade and keep the spses in sync with the version moving forward without the need for a new stored procedure.\r\n\r\nThe only impact I can imagine is that it may take slightly longer to boot the database on version change.  Upgrade tests passed. Running all tests now.\r\n\r\n\r\nThanks\r\n\r\nKathey\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-11-05T21:12:47.369+0000","updated":"2008-11-05T21:12:47.369+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12645507","id":"12645507","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"tests passed patch derby-1107_noproc_diff.txt.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-11-06T16:45:31.877+0000","updated":"2008-11-06T16:45:31.877+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12645807","id":"12645807","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"It sounds safe to me too, as long as we only do this for 10.5 and higher. I don't think the time to boot on version change is a big issue, and the code will be more robust if we recreate the SPSs on version change.\r\n\r\nWith this patch, will they be recreated on every version change, or only when one of the first three digits in the version number changes? That is, will they get recreated when we move from 10.5.1.0 to 10.5.1.1? I'm getting a bit confused by the naming in DD_Version, since it seems to use major/minor version in a different way than we normally do.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-11-07T16:17:22.940+0000","updated":"2008-11-07T16:17:22.940+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12645814","id":"12645814","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"It will get changed on any version change.  I tested by bumping to 10.5.0.1 and the SPSes got recreated.  The minor version as referenced in DD_Version takes into account all digits.  I'll go ahead and check this in later today.\r\n\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-11-07T16:37:34.903+0000","updated":"2008-11-07T16:37:34.903+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12645869","id":"12645869","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"body":"Thanks for verifying. And +1 to commit.\r\n\r\nThis still leaves the problem if we make a change that requires recompilation and don't bump the version on the branch. You mentioned one solution is to use the svn revision number when we compare the versions. If we had a way to detect that recompilation was needed, it would probably be simpler just to bump the revision when needed. Could we use the upgrade tests to detect it? Currently, the upgrade tests don't test upgrades from previous releases on the same branch, but I don't think there's anything preventing us from changing that. And the upgrade tests should run all meta-data queries, so that should be sufficient to detect these problems, right?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knutanders","name":"knutanders","emailAddress":"knut dot hatlen at oracle dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Knut Anders Hatlen","active":true},"created":"2008-11-07T20:07:37.759+0000","updated":"2008-11-07T20:07:37.759+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12646302","id":"12646302","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Resolving this issue as the fix is checked into trunk. Note: This fix *should not*  be backported as the metadata update can only happen for versions 10.5 and higher.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-11-10T17:20:00.495+0000","updated":"2008-11-10T17:20:00.495+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12330229/comment/12646308","id":"12646308","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"body":"Thanks Knut for looking at the patch.  Perhaps you are right that just manually bumping the version when needed is the best solution.  As for the upgrade tests,  I will open a Jira to add upgrade tests for third and fourth digit upgrades and put it on my TODO  list to add that in when we have our first maintenance release on the 10.5 branch.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kmarsden","name":"kmarsden","emailAddress":"kmarsdenderby at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kathey Marsden","active":true},"created":"2008-11-10T17:33:49.839+0000","updated":"2008-11-10T17:33:49.839+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1107/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0703r:"}}
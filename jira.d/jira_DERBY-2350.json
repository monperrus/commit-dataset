{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12363055","self":"https://issues.apache.org/jira/rest/api/latest/issue/12363055","key":"DERBY-2350","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2007-06-28 23:44:33.67","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23012","customfield_12310222":"1_*:*_1_*:*_14256423431_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2007-07-31T23:00:14.497+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2350/watchers","watchCount":0,"isWatching":false},"created":"2007-02-16T22:53:11.066+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-01-21T17:49:46.484+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"A  trigger like, where V, V1 and V2 are columns of type XML will thrown an exception when fired.\n\nCREATE TRIGGER AIS AFTER INSERT ON T_MAIN \n                REFERENCING NEW_TABLE AS N\n                FOR EACH STATEMENT  \n                INSERT INTO T_ACTION_STATEMENT(A, V1, ID, V2) \n                SELECT 'I', V, ID, V FROM N\n\nERROR 38000: The exception 'java.sql.SQLException: An attempt was made to get a data value of type 'java.lang.Object' from a data value of type 'XML'.' was thrown while evaluating an expression.\n\nMost likely because triggers are implementing using VTIs and hence JDBC ResultSets and XML is not supported through JDBC yet.\n\nTriggerTest shows this issue, see the comment with the bug number to reproduce.\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37491","summary":"Use of XML values in the action statement of a trigger throw exceptions.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":9,"total":9,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363055/comment/12508961","id":"12508961","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"What would be the right approach to fixing this one?  Seems like the options are:\r\n1) implement full XML support in JDBC \r\n     o is this even possible for jdk1.4 and jdk1.5 - is there XML support there?\r\n2) change trigger implementation to not use jdbc\r\n     o if we take this route, does anyone have an idea the extent of the changes necessary?   Would such a change be appropriate\r\n         as a bug fix to an existing release or would it be a feature to new release?\r\n\r\nLong term is one choice better architecturally?  Does option 2 allow us to better optimize the performance?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2007-06-28T23:44:33.670+0000","updated":"2007-06-28T23:44:33.670+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363055/comment/12508981","id":"12508981","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"Some trigger background here:\r\n\r\nhttp://wiki.apache.org/db-derby/TriggerImplementation\r\n\r\nI believe 2) is the best approach. The before & after rows are currently forced as JDBC objects which means a performance hit for most datatypes.\r\nThere's no reason to use JDBC, it's a hang over from Cloudscape 4.x when a non-standard mechanism was provided to access the before & after rows. But now Derby uses standard SQL to access the before & after rows, thus there is no requirement to convert the row into a JDBC form, keeping the rows as Derby rows (Row & DataValueDescriptor's) would make more sense. This approach would also avoid any jdk specific issues since the SQLXML datatype was only introduced in JDBC 4.\r\n\r\nNot sure of the effort involved, I'll try to think about it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2007-06-29T01:49:55.558+0000","updated":"2007-06-29T01:49:55.558+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363055/comment/12512309","id":"12512309","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I took a look at this issue.  I agree with the suggestion on the mentioned wiki that a good longterm solution in this area which would also fix this bug is to change the underlying trigger implementation to not be dependent on jdbc to get the old and new values for the\r\ntrigger actions.  My initial take is that such a change would be most appropriate for a new \r\nrelease not a bug fix in an existing release.  It would be nice to get XML working in triggers in 10.2 and 10.3 in the meantime, even if the solution is not the best.\r\n\r\nThe base problem for the bug seems to be that by default we use the jdbc getObject() call in the generated call to the old and new values.  From comments in \r\nCreateTriggerNode.java we generate \"internal\" sql of the following form for all the\r\ndatatypes:\r\n/*\r\n** Generate something like this:\r\n**\r\n**      cast (org.apache.derby.iapi.db.Factory::\r\n**          getTriggerExecutionContext().getNewRow().\r\n**              getObject(<colPosition>) AS DECIMAL(6,2))\r\n**\r\n** Column position is used to avoid the wrong column being\r\n** selected problem (DERBY-1258) caused by the case insensitive\r\n** JDBC rules for fetching a column by name.\r\n**\r\n** The cast back to the SQL Domain may seem redundant\r\n** but we need it to make the column reference appear\r\n** EXACTLY like a regular column reference, so we need\r\n** the object in the SQL Domain and we need to have the\r\n** type information.  Thus a user should be able to do\r\n** something like\r\n**\r\n**      CREATE TRIGGER ... INSERT INTO T length(Column), ...\r\n*/\r\n\r\n\r\nThe problem is that the jdbc being called does not support getObject on an XML object\r\nand thus throws the exception.\r\n\r\nI spent some time, and will post an example patch, looking at generating different code\r\nfor XML.  What I was looking at was generating the following in the case of XML rather\r\nthan the above:\r\n\r\n          XMLPARSE(DOCUMENT\r\n             CAST (org.apache.derby.iapi.db.Factory::\r\n                  getTriggerExecutionContext().getNewRow().\r\n                     getString(<colPosition>) AS CLOB)\r\n                       PRESERVE WHITESPACE)\r\n\r\nThe patch I will post has this change and when I run the junit TriggerTest test it gets past the getObject() error but then gets the following which I have not yet figured out.  I believe\r\nthe parsing done by the XMLPARSE generated for the old/new reference is working, so\r\nnot quite sure where this error is coming from.  \r\n\r\n...E\r\nTime: 84.552\r\nThere was 1 error:\r\n1) testTypesInActionStatement(org.apache.derbyTesting.functionTests.tests.lang.T\r\nriggerTest)java.sql.SQLException: Values assigned to XML columns must be well-fo\r\nrmed DOCUMENT nodes.\r\n    at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExcepti\r\nonFactory.java:45)\r\n    at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Util.java:202)\r\n    at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Tra\r\nnsactionResourceImpl.java:391)\r\n    at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Transa\r\nctionResourceImpl.java:346)\r\n    at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnectio\r\nn.java:1572)\r\n    at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChil\r\nd.java:81)\r\n    at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement\r\n.java:1293)\r\n    at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedP\r\nreparedStatement.java:1652)\r\n    at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeUpdate(EmbedPrep\r\naredStatement.java:299)\r\n    at org.apache.derbyTesting.functionTests.tests.lang.TriggerTest.actionTypesI\r\nnsertTest(TriggerTest.java:580)\r\n    at org.apache.derbyTesting.functionTests.tests.lang.TriggerTest.actionTypeTe\r\nst(TriggerTest.java:445)\r\n    at org.apache.derbyTesting.functionTests.tests.lang.TriggerTest.testTypesInA\r\nctionStatement(TriggerTest.java:427)\r\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java\r\n:64)\r\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorI\r\nmpl.java:43)\r\n    at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:95)\r\n    at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\r\n    at junit.extensions.TestSetup$1.protect(TestSetup.java:19)\r\n    at junit.extensions.TestSetup.run(TestSetup.java:23)\r\n    at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\r\nCaused by: ERROR 2200L: Values assigned to XML columns must be well-formed DOCUM\r\nENT nodes.\r\n    at org.apache.derby.iapi.error.StandardException.newException(StandardExcept\r\nion.java:280)\r\n    at org.apache.derby.iapi.types.XML.normalize(XML.java:386)\r\n    at org.apache.derby.iapi.types.DataTypeDescriptor.normalize(DataTypeDescript\r\nor.java:505)\r\n    at org.apache.derby.impl.sql.execute.NormalizeResultSet.normalizeRow(Normali\r\nzeResultSet.java:330)\r\n    at org.apache.derby.impl.sql.execute.NormalizeResultSet.getNextRowCore(Norma\r\nlizeResultSet.java:189)\r\n    at org.apache.derby.impl.sql.execute.DMLWriteResultSet.getNextRowCore(DMLWri\r\nteResultSet.java:125)\r\n    at org.apache.derby.impl.sql.execute.InsertResultSet.open(InsertResultSet.ja\r\nva:496)\r\n    at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPrepare\r\ndStatement.java:370)\r\n    at org.apache.derby.impl.sql.execute.GenericTriggerExecutor.executeSPS(Gener\r\nicTriggerExecutor.java:173)\r\n    at org.apache.derby.impl.sql.execute.StatementTriggerExecutor.fireTrigger(St\r\natementTriggerExecutor.java:80)\r\n    at org.apache.derby.impl.sql.execute.TriggerEventActivator.notifyEvent(Trigg\r\nerEventActivator.java:278)\r\n    at org.apache.derby.impl.sql.execute.InsertResultSet.normalInsertCore(Insert\r\nResultSet.java:1163)\r\n    at org.apache.derby.impl.sql.execute.InsertResultSet.open(InsertResultSet.ja\r\nva:497)\r\n    at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPrepare\r\ndStatement.java:370)\r\n    at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement\r\n.java:1203)\r\n    ... 26 more\r\n\r\nFAILURES!!!\r\nTests run: 3,  Failures: 0,  Errors: 1\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2007-07-12T23:39:59.199+0000","updated":"2007-07-12T23:39:59.199+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363055/comment/12512310","id":"12512310","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"This patch is not ready for commit, it shows some intial work I did to try for \r\na tempory solution.  It gets a different error than before, not sure why.  I don't currently plan on doing more on this one, if anyone is interested feel free to pick it up or fix it some other way.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2007-07-12T23:44:05.369+0000","updated":"2007-07-12T23:44:05.369+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363055/comment/12512639","id":"12512639","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Attaching d2350_v2.patch, which is Mike's original patch plus some changes in iapi/types/XML.java to solve the error that he mentioned in his previous comment.\r\n\r\nThe problem is actually in the \"setValueFromResultSet()\" method of XML.java.  That method is called from VTIResultSet and is used to \"load\" results from into the target XML column.  But that method does not set the 'xType\" field, which means it defaults to -1.  Then later, when we try to normalize the XML value in preparation for insertion into the XML column, we throw an error because an xType of \"-1\" indicates that the XML value is not a well-formed DOCUMENT.\r\n\r\nThe easiest fix would be to add a single line to XML.setValueFromResult() that sets \"xType\" to XML_DOC_ANY.  However, I do not know if we can safely assume that the string value in the received ResultSet is well-formed XML.  My inclination is to believe that we canNOT make such an assumption, though I can't currently think of any examples to prove it.   To be cautious we need some admittedly ugly code to check the well-formedness of the string value in question.  (Since the result set object is java.sql.ResultSet , and since \"getObject()\" won't work, we have to jump through some hoops to figure out if the desired column is in fact an XML value).\r\n\r\nThe attached patch makes changes to set \"xType\" based on whether or not the string value in question is well-formed XML.  This is rather undesirable, though, because this change in combination with Mike's change in CreateTriggerNode means that we are now parsing each XML value *TWO* additional times--once as part of the rewrite contributed by Mike, and again when we get to setValueFromResultSet().  That seems like it could lead to pretty bad performance very easily...\r\n\r\nThat said, though, I'm not sure what the alternatives are outside of the trigger re-write mentioned by Dan and Mike in preceding comments.  So I'm posting this far-less-than-ideal solution in case people think it's worth committing.  I ran lang/TriggerTest.java and suites.XMLSuite on Windows using ibm142 and saw no failures.  I haven't run any other tests...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2007-07-13T22:20:12.688+0000","updated":"2007-07-13T22:20:12.688+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363055/comment/12512721","id":"12512721","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"What about \"sniffing\" the first few bytes of the string? To be a valid document,\r\nit should either start with <?xml , possibly preceded by a bytemark, or < and a tag.\r\n\r\nNot a perfect test by any means, but vastly less expensive than cranking up the XML parser.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-07-14T15:47:34.721+0000","updated":"2007-07-14T15:47:34.721+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363055/comment/12512810","id":"12512810","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"body":"The issue might be that the patch only addresses (I think) row level triggers, but the test uses statement level and row level triggers.\r\nThat would lead to the error seen, as only a statement trigger will end up calling the setValueFromResultSet method.\r\n\r\nBryan wrote:\r\n> What about \"sniffing\" the first few bytes of the string? To be a valid document,\r\n> it should either start with <?xml , possibly preceded by a bytemark, or < and a tag.\r\n\r\n> Not a perfect test by any means, but vastly less expensive than cranking up the XML parser.\r\n\r\nI might be missing something here, but how does this help? Are you saying that would be the only test?\r\nAs you point out it's not sufficient, so we would need to use the parser anyway. It seems it would only help kick out\r\ninvalid values earlier, which is not really a case we want to optimize for.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djd","name":"djd","emailAddress":"djd at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel John Debrunner","active":true},"created":"2007-07-15T17:28:03.412+0000","updated":"2007-07-15T17:28:03.412+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363055/comment/12516515","id":"12516515","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"Thanks for posting the patch got my original changes to work, I have some time to work on this now.  I think it is better to get this fix in, even if xml trigger is not optimal.  It does not work at all without it.  I am going to run some tests and see if I can get this into trunk and 10.3.  I will also create a follow on JIRA issue to log possible performance improvements in the future.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2007-07-30T20:39:45.004+0000","updated":"2007-07-30T20:39:45.004+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12363055/comment/12516818","id":"12516818","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"fixed in trunk and 10.3 branch.\r\n\r\nFix XML in triggers by changing code generation to generate different code\r\nin the case of XML of the form when referencing old and new column values.:\r\nXMLPARSE(DOCUMENT\r\nCAST (org.apache.derby.iapi.db.Factory::\r\ngetTriggerExecutionContext().getNewRow().\r\ngetString(<colPosition>) AS CLOB)\r\nPRESERVE WHITESPACE)\r\n\r\nAlso change XML.setValueFromResult() to validate the character stream and\r\nset the xType as appropriate after parsing the stream.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2007-07-31T23:00:08.697+0000","updated":"2007-07-31T23:00:08.697+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2350/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06s4n:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12441433","self":"https://issues.apache.org/jira/rest/api/latest/issue/12441433","key":"CASSANDRA-572","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310865","id":"12310865","key":"CASSANDRA","name":"Cassandra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310865&avatarId=12034","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310865&avatarId=12034","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310865&avatarId=12034","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310865&avatarId=12034"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11961","id":"11961","description":"Apache Cassandra related projects","name":"Cassandra"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314040","id":"12314040","description":"","name":"0.5","archived":false,"released":true,"releaseDate":"2010-01-24"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2009-11-23 16:19:42.946","customfield_12312322":null,"customfield_12312323":null,"customfield_12310222":"10002_*:*_1_*:*_2447733024_*|*_1_*:*_1_*:*_177624_*|*_5_*:*_1_*:*_0","customfield_12310420":"19759","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2009-12-21T17:19:19.358+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-572/watchers","watchCount":0,"isWatching":false},"created":"2009-11-23T09:20:48.710+0000","customfield_10022":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12311124":null,"customfield_12312334":null,"customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-12-21T17:19:19.356+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312978","id":"12312978","name":"Core"}],"timeoriginalestimate":null,"description":"(1) If a node has been moving in the ring, further bootstraps by other nodes will cause errors as they are handling STATE_LEAVING gossip without having such member in token metadata.\r\n\r\n(2) When a node bootstraps, it handles all ep states in the order they happen to arrive. If the first one to arrive has moved in the past (that is, it has STATE_LEAVING in its ep state), getNaturalEndpoint will throw ArrayIndexOutOfBounds exception as sortedTokens.size() == 0.\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12428610","id":"12428610","filename":"572-01-fix-index-out-of-bounds.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-21T09:31:06.460+0000","size":2699,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12428610/572-01-fix-index-out-of-bounds.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12428611","id":"12428611","filename":"572-02-use-one-move-state.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-21T09:31:06.505+0000","size":24859,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12428611/572-02-use-one-move-state.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12428612","id":"12428612","filename":"572-03-unit-tests.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-21T09:31:06.508+0000","size":29639,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12428612/572-03-unit-tests.patch"}],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"91391","summary":"handle old gossip properly","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"customfield_12311420":null,"customfield_12311421":null,"environment":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":18,"total":18,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12781339","id":"12781339","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"(1) Modified StorageMetadata.onChange to handle STATE_LEAVING and STATE_LEFT only if isMember is true\r\n\r\n(2) We might fix this by simply making sure we're calling getNaturalEndpoints for members only, but imho it is better to fix at the source.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-11-23T09:23:31.263+0000","updated":"2009-11-23T09:23:31.263+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12781448","id":"12781448","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"See CASSANDRA-559 for more discussion.\r\n\r\nJaakko, can you check on the mailing list to see if anyone actually needs this, before we commit to making our lives (a little bit) harder for 0.5 -> 0.5.1.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-11-23T16:19:42.946+0000","updated":"2009-11-23T16:19:42.946+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12781449","id":"12781449","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"Sorry, I was thrown off by the title, assuming old==0.4.  But that is actually not what this is about.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-11-23T16:20:31.002+0000","updated":"2009-11-23T16:20:31.002+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12781464","id":"12781464","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"This feels like we're solving the wrong problem.  A bootstrapping node should not be added to the list of nodes clients can connect to (however you want to manage that) until after it is done bootstrapping.  I'd rather add\r\n\r\nif (StorageService.instance().isBootstrapMode())\r\n    throw new UnavailableException()\r\n\r\nto the appropriate StorageProxy methods.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-11-23T16:35:56.785+0000","updated":"2009-11-23T16:35:56.785+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12781719","id":"12781719","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"I probably described the problem a bit vaguely, another try:\r\n\r\nSuppose all nodes in the cluster are running normally and none of them have moved. Their EP state includes STATE_BOOTSTRAPPING (if they were bootstrapped to the ring) and STATE_NORMAL in this order. Suppose there is nodeA, which gets loadbalanced. It goes through leaving, left and bootstrapping back to normal. After this its EP state includes (in this order!) LEAVING, LEFT, BOOTSTRAPPING, NORMAL. The important thing is that EP state can have only one of each state, and they will be handled by other nodes in the order added originally. This is fine for nodes that already were in the ring, as they have seen the _old_ NORMAL state. However, if we ever want to bootstrap another node to the ring, it will cause errors, as they will start to handle states from LEAVING. They have no knowledge of this node's state before they handle NORMAL, so we must handle LEAVING and LEFT properly. That is, we must do nothing if we do not have knowledge of the node.\r\n\r\nSo this is not related to the new node serving requests, only to handle state gossip from other nodes properly. My term old gossip was obviously badly chosen, perhaps old state information would be more appropriate.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-11-24T00:50:27.808+0000","updated":"2009-11-24T00:50:27.808+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12783825","id":"12783825","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"(Waiting on this while I mull over the rack aware bootstrap mailing list thread, since this is irrelevant if we have a problem there and need to add a \"coordinator\" node to fix it.)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-11-30T20:06:01.008+0000","updated":"2009-11-30T20:06:01.008+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12784704","id":"12784704","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"I don't think this is related to move coordination, but a separate issue. This will happen for every new node that enters the cluster (bootstrapping or not) after a node has already moved. Problem is, handling STATE_LEAVING and STATE_LEFT will cause errors for a node that is not in token metadata, and a node will not end up being there before STATE_NORMAL has been seen for it. Since states are handled in the order they were added, STATE_LEAVING and STATE_LEFT will be handled before BOOTSTRAPPING and NORMAL. LEAVING and LEFT in this case have no meaning as they refer to the old already-gone token, but since application state can only grow, these states will remain part of gossip and new nodes must handle them properly.\r\n\r\nEdit: This can wait, as there is no point to add now. Let's check the situation after gossiping analysis is done","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-02T08:26:32.782+0000","updated":"2009-12-02T08:39:27.826+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12784943","id":"12784943","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"ok, I understand now.  for some reason I had a really hard time wrapping my head around this.\r\n\r\ntrying to make sure we ignore old applicationstate correctly in all cases seems like fixing the symptom instead of the real cause.\r\n\r\nwouldn't it be simpler to have a single STATE aplicationstate object whose value would be a json (or whatever) tuple of [NORMAL|LEAVING|LEFT|BOOTSTRAPPING],ARG+?  that way only the most recent one would be present in the gossiper.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-02T18:23:00.267+0000","updated":"2009-12-02T18:23:00.267+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12785155","id":"12785155","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"Funny thing, I was just thinking about the same thing during breakfast. Have to eat more often :)\r\n\r\nThe problem with this is that handling state changes will become somewhat more complex as we must be prepared to handle transitions between any two states in any order. Current gossip model leaves a trace of what the node has node, and even in the face of network partitions we can \"play back\" the transitions when they eventually arrive. That is, if a node moves, we will still see LEAVING, LEFT, BOOTSTRAPPING and NORMAL and construct token metadata according to that. If we only have one value to represent node's current state, we might go from, say NORMAL to NORMAL, or even LEFT to LEAVING without seeing any of the intermediate steps. Of course this can be done, but needs extra care. Don't know how much, though. Might very well be that in the end this would be better than the current way.\r\n\r\nBut even this would not remove the need to handle old application state correctly. If a node enters the ring when another node is just LEAVING or LEFT, that state will be the first one to be seen, and it must be ignored since there is nothing that can be done if NORMAL has not been seen. I think the real cause is there in any case, so we can't avoid fixing the symptoms that arrive with it.\r\n\r\nI'll try this out now that I'm working on the gossiping part anyway so we'll have some more insight on what it would look like.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-03T02:45:39.361+0000","updated":"2009-12-03T02:45:39.361+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12785227","id":"12785227","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"OK, here's a patch that uses same state name (NODE_STATE) to gossip all movement information. Format is (BOOTSTRAPPING|NORMAL|LEAVING|LEFT)|token.\r\n\r\nThe main things caused by this modification to the state machine were:\r\n(1) When a node is bootstrapping, we should clear pending ranges for this endpoint, as well as remove it from token metadata. These checks are not strictly necessary (I think), but are there to help transition from LEAVING -> BOOTSTRAPPING in case we missed LEFT due to network partition.\r\n(2) For handleStateLeaving and handleStateLeft remove pending ranges for this endpoint before doing anything else. If we missed NORMAL, there might be obsolete pending ranges from BOOTSTRAP. Distant possibility, but possibility nonetheless.\r\n\r\nFollowing additional check is not directly related to gossip format change and could happen even using the current model. This is a very unlikely event, but in a large (say, 200+ nodes) multi-DC cluster with lots of node movement, this could very well happen even with relatively short DC-to-DC network outage:\r\n(1) Added a check to handleStateLeaving and handleStateLeft for the case that a node has made NORMAL -> LEAVING -> LEFT -> BOOTSTRAP -> NORMAL -> LEAVING [->LEFT] movement cycle without us seeing the intermediate stages. In this case we have information for the old token and now the node is leaving _new_ token. We cannot simply assert this, as it is possible this happens.\r\n\r\nNow of course this already touches the subject what conditions we must take care of and what should be left to operators to handle. Some of them (like removing all references to the endpoint before continuing to handle bootstrapping) are questionable and might relax safety precautions, but if we do not do that, a modest 30s network outage might cause us not to see STATE_LEFT and we'd end up having strange pending ranges.\r\n\r\nI don't expect this patch to be included as it is, but let's see what people think of this gossip change and then discuss what checks should be made :)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-03T08:40:35.219+0000","updated":"2009-12-03T08:40:35.219+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12787093","id":"12787093","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"The fundamental question is, is it ever dangerous to overwrite intermediate states, such that a node who has been down or partitioned does something broken when it gets the latest [partial] information?\r\n\r\n> if we do not do that, a modest 30s network outage might cause us not to see STATE_LEFT\r\n\r\nTrying to figure out what you're referring to here...  We can't miss a STATE_LEFT from a node that is leaving permanently since that will remain its last state and will be gossiped forever.  And if we miss a STATE_LEFT from a node that is moving, a down node that comes back up later will get the new token location and \"snap\" it to the right spot immediately.\r\n\r\nI assume that as usual I am slow on the uptake here. :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-07T20:34:17.249+0000","updated":"2009-12-07T20:37:46.176+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12788469","id":"12788469","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"From the small experiment (patch) it would seem that it is not too dangerous, just needs a bit of extra care. From #617 it would seem that reducing total amount of data in the gossiper would be beneficial, so current move gossip model needs some attention. There are basically two options:\r\n\r\n(1) use one state for all moves, and use tuple/triple in application state string to identify what the node is doing (as suggested by jbellis earlier)\r\n(2) return to the \"old\" gossip model: one state to broadcast the token and separate small states to express what the token means. The reason for moving out of this model was to make all needed information part of one gossip message and not rely on them arriving at the same time. With small addition to StorageService, we might keep arriving token \"somewhere\" and only add it to token metadata when the actual mode gossip arrives. This would take care of the race condition and would also reduce the amount of data to be gossiped to bare minimum.\r\n\r\n> I assume that as usual I am slow on the uptake here. :) \r\n\r\nI think the problem is in my ability to clearly express an idea :)\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-10T03:22:05.489+0000","updated":"2009-12-10T03:23:03.369+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12788484","id":"12788484","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"I think I would prefer option (1), since from experience I can attest that trying to write a 100% correct \"state machine\" for (2) is quite difficult.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-10T04:01:18.604+0000","updated":"2009-12-10T04:01:18.604+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12788717","id":"12788717","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"Run into one tricky issue with STATE_LEAVING. I'll check that tomorrow with #603 as they are connected.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-10T13:28:38.259+0000","updated":"2009-12-10T13:28:38.259+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12792523","id":"12792523","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"What was the tricky issue?  With CASSANDRA-603 and CASSANDRA-639 committed, this needs rebasing at least.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-18T16:30:23.594+0000","updated":"2009-12-18T16:30:23.594+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12792714","id":"12792714","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"Sorry about the delay. I did this part again yesterday (somewhat different now after #603), but had insufficient time to test it properly. The patch would seem OK, so as soon as I have tested it a bit more, I'll submit it.\r\n\r\nThe problem earlier was how to handle state jump to 'leaving'. Now that pending ranges is calculated every time and we know what direction a node was going last time, this is not a problem anymore. You can expect a patch soon.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-19T00:13:44.133+0000","updated":"2009-12-19T00:13:44.133+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12793126","id":"12793126","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"body":"01:\r\nFix ArrayIndex exception in case the first gossip a new node sees is leaving or left.\r\n\r\n02:\r\nUse one state for all movement related gossip\r\nFix also some bugs related to pending ranges on the leaving node itself\r\n\r\n03:\r\nA bunch of unit tests for node movement","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","emailAddress":"rosvopaallikko at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true},"created":"2009-12-21T09:31:06.512+0000","updated":"2009-12-21T09:31:06.512+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12441433/comment/12793268","id":"12793268","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"body":"committed to 0.5 and trunk (only change was turning isLeaving writeLock calls to readLock)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbellis","name":"jbellis","emailAddress":"jbellis at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jbellis&avatarId=18380","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jbellis&avatarId=18380","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jbellis&avatarId=18380","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jbellis&avatarId=18380"},"displayName":"Jonathan Ellis","active":true},"created":"2009-12-21T17:19:19.334+0000","updated":"2009-12-21T17:19:19.334+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/CASSANDRA-572/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0fzrb:"}}
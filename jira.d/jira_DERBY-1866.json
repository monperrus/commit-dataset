{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12350272","self":"https://issues.apache.org/jira/rest/api/latest/issue/12350272","key":"DERBY-1866","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313478","id":"12313478","description":"Head of 10.1 branch. Maintenance version bump for sps update ","name":"10.1.3.3","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-09-21 15:40:57.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22761","customfield_12310222":"1_*:*_1_*:*_1114928000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_1469552000","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-10-02T16:08:20.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1866/watchers","watchCount":0,"isWatching":false},"created":"2006-09-19T18:26:12.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311972","id":"12311972","description":"","name":"10.1.3.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313478","id":"12313478","description":"Head of 10.1 branch. Maintenance version bump for sps update ","name":"10.1.3.3","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[{"id":"12313440","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12313440","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12348858","key":"DERBY-1777","self":"https://issues.apache.org/jira/rest/api/2/issue/12348858","fields":{"summary":"Regression: query works in 10.1.2.1 but fails with NullPointerException in 10.2.1.1","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-07-05T17:32:45.623+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"Derby-1777 gives a database and a small program called \"ViewerInit\" that prepares a bunch of large queries involving nested subqueries, unions, and join predicates.  The actual bug described in DERBY-1777 is an NPE, and that's what the patch for DERBY-1777 addresses.\n\nHowever, once the NPEs are fixed, some of the queries in that same program now fail with ASSERT failures when running in SANE mode; this Jira issue is for addressing those assert failures.\n\nWhile this does constitute a regression, I don't know yet what the root cause of the problem is, so I hesitate to make it a 10.2 blocker--hence urgency is \"Normal\".  I'm still investigating the queries to try to track down where the problem is, but all I've been able to deduce so far is that a) the assertion occurs for a scoped predicate and thus the pushing of join predicates into UNIONs is somehow involved, and b) in INSANE mode the query compiles without problem and appears (based on some early and very incomplete testing) to execute without problem.  But more investigation is required to determine if the execution/results are actually correct, and to understand more about why the assertion is being thrown.\n\nI'm marking the fixin as 10.2.2.0 for now since I don't enough to make this a blocker for 10.2.1.  Hopefully more info will be forthcoming...","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10420","value":"Regression","id":"10420"}],"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37981","summary":"Assert failure in sane mode for queries that used to work in 10.1.2.1","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10052","value":"Normal","id":"10052"},"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":21,"total":21,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12435965","id":"12435965","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Attaching a derby.log file that contains the ASSERT failure.  Note that the query in this case is slightly modified from one of the queries in DERBY-1777 (the queries in DERBY-1777 tend to take a very long time to compile; I shortened the query a bit and was still able to see the error).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-09-19T18:35:02.000+0000","updated":"2006-09-19T18:35:02.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12436420","id":"12436420","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Quick update on where things are with this issue:\r\n\r\n  1. I was (finally) able to come up with a quick and easy repro to \r\n    demonstrate the ASSERT failure in SANE mode.  I'm attaching \r\n    a script, repro.sql, that can be run to show the failure.  The repro \r\n    script also contains another query that is very similar to the first, \r\n    but the second query appears to hang or otherwise run for a very, \r\n    very long time, even though it should execute in about a second\r\n     or so.\r\n\r\n  2. With the repro attached to this issue, attempts to run in INSANE mode will\r\n     result in an IndexOutOfBounds error--so this issue does not just \"go away\"\r\n     in insane mode; it is a legitimate regression.\r\n\r\n  3. Now the interesting thing: both of the repro queries SUCCEED as expected against\r\n     the 10.1 codeline.  This means that the failures are not part of the initial\r\n     optimizer work (DERBY-805) that went into 10.1, nor are they inherently caused\r\n     by any of the recent optimizer changes that have been ported back to 10.1\r\n     (namely, DERBY-1365, DERBY-1633, DERBY-1681, DERBY-1777, DERBY-1315).\r\n\r\n     The repro script passes against the 10.1.3 jars and against a fully-synced\r\n     10.1 codeline.  But it fails against the first 10.2 beta candidate and\r\n     all subsequent candidates; it also fails against the current 10.2 codeline\r\n     and the 10.3 trunk.\r\n\r\n     So my natural deduction was that some other optimizer-related change has\r\n     been checked into 10.2 and 10.3 that is not in 10.1, and that's the cause\r\n     of the failure.  But after I applied all such changes (that I could think\r\n     of) to the 10.1 codeline, the repro scripts still pass in 10.1 and fail\r\n     in 10.2/10.3.  The patches I ported to 10.1 (locally) were DERBY-1357,\r\n     DERBY-781, and DERBY-634.  As far as I could tell based on a quick glance\r\n     at the 10.2 release notes, no other optimizer changes were made after the\r\n     10.1.3 release.  I also did a diff of the latest 10.1 trunk with the\r\n     latest 10.3 trunk bewteen the files that have been involved in the\r\n     recent optimizer work, and I couldn't see any diffs that might suggest\r\n     why the repro queries pass for 10.1 but fail for everything else.\r\n\r\nI'm still investigating the bizarre behavior for #3.  If anyone offhand can think of any changes that are in 10.2/10.3 but not in 10.1 that might be responsible for these failures, I'd certainly appreciate the help.  Right now I'm planning to 1) go back through the release notes for 10.2 more carefully to see if I've missed anything, and 2) make sure all of the patches applied cleanly when I ported them (locally) to 10.1; maybe something went wrong somewhere...?\r\n\r\nIn any event, to run the repro, do the following:\r\n\r\n> java -Dderby.optimizer.noTimeout=true org.apache.derby.tools.ij\r\nij> connect 'jdbc:derby:tstdb;create=true';\r\nij> run 'repro.sql';\r\n\r\nAgainst 10.2 and 10.3 you should see an ASSERT failure for the first query; if you comment out the first query, you should see an apparent hang for the second query.  But against 10.1, both queries run successfully and quickly (less than a second).\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-09-21T02:12:59.000+0000","updated":"2006-09-21T02:12:59.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12436522","id":"12436522","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Okay, forget about #3 above:\r\n\r\nAfter a night's sleep it occurred to me why the repro \"passes\" in 10.1 but not in 10.2 or 10.3.  The reason is that the repro relies on behavior dictated by optimizer overrides (DERBY-PROPERTIES), but such overrides are not recognized in 10.1 and thus they are treated as SQL comments and are ignored.\r\n\r\nI haven't tried it yet, but I imagine that if I ported the optimizer overrides patch to 10.1, the repro would fail there; similarly, if I remove the optimizer overrides from the repro queries, they will probably pass in 10.2 and 10.3.\r\n\r\nSo short story: we do have a legitimate regression, and now that we have a repro, I'm working to find the problem...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-09-21T12:56:50.000+0000","updated":"2006-09-21T12:56:50.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12436559","id":"12436559","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks for looking into this, Army. I have a couple comments:\r\n\r\n1) What happens if you run the repro against an insane (e.g., production-ready) 10.2?\r\n\r\n2) I'm confused about whether this is a regression. It sound as though, if you could force the query plan in 10.1 (as you can in 10.2), then the bug would surface in 10.1 as well. From your description, this seems like a pre-existing bug which we are now able to script and (eventually) fix because of optimizer overrides.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2006-09-21T15:40:57.000+0000","updated":"2006-09-21T15:40:57.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12436569","id":"12436569","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"> 1) What happens if you run the repro against an insane (e.g., production-ready) 10.2? \r\n\r\nThe result is an IndexOutOfBoundsException at execution time:\r\n\r\nERROR 38000: The exception 'java.lang.ArrayIndexOutOfBoundsException: -1' was thrown while evaluating an expression.\r\n\r\n> 2) I'm confused about whether this is a regression.\r\n\r\nGood question, sorry for not being clear here.  This is a regression in the same way that DERBY-1633, DERBY-1781, etc. are regressions: namely, queries used to work correctly at one point in 10.2, but then as a result of optimizer changes (esp. DERBY-805) they no longer work.  As it turns out, DERBY-805 was also ported back to 10.1.2.4 and thus the regressions also occur in the recent 10.1 codeline/release.  That's why the changes for DERBY-1633, DERBY-1681, DERBY-1777, and DERBY-1315 have all been ported back to 10.1.\r\n\r\nSo if you define \"regression\" as \"worked in the latest 10.1 release but fails in 10.2\", then neither this nor any of the other issues were technically \"regressions\" for 10.2--because they all demonstrate bugs that exist in 10.1.3 and 10.2 alike.  But the truth is that the queries *did* work in 10.1 and they *did* work in 10.2 before the DERBY-805 changes went in, and now they don't work in either.\r\n\r\n> then the bug would surface in 10.1 as well. From your description, this seems like a \r\n> pre-existing bug which we are now able to script and (eventually) fix because of\r\n> optimizer overrides.\r\n\r\nYes, \"pre-existing\" in 10.1 because the code that caused the regression was (unfortunately) ported back to 10.1, as well...\r\n\r\nI can't seem to put it in the right words, but hopefully that makes more sense...?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-09-21T16:02:52.000+0000","updated":"2006-09-21T16:02:52.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12436572","id":"12436572","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks for the quick response, Army. Does this bug appear in the current 10.1.3 release?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2006-09-21T16:12:20.000+0000","updated":"2006-09-21T16:12:20.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12436581","id":"12436581","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"> Does this bug appear in the current 10.1.3 release?\r\n\r\nSince 10.1.3 doesn't have support for optimizer overrides, I can't run the repro against it to see.  I also can't run the original query from DERBY-1777 because the other regressions (esp. DERBY-1633) haven't been fixed in the 10.1.3 release and thus will cause the query to fail before ever reaching the condition for this issue.\r\n\r\nBut even though I can't demonstrate it easily, I'm pretty sure the answer is \"Yes\".  I tried to run the repro script with a set of 10.2 jars that was built before any of the DERBY-805-related changes went in (but after optimizer overrides were added) and the queries pass.  So the queries used to work in 10.2 and now they don't--and I'd be very (pleasantly) surprised if the optimizer changes for DERBY-805 weren't somehow responsible.  Given that, the 805 changes were ported to 10.1 so I imagine the issue exists in the 10.1.3 release, as well (it's just hidden behind the other regressions that have since been resolved).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-09-21T16:52:36.000+0000","updated":"2006-09-21T16:52:36.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12436630","id":"12436630","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Thanks, Army. As I understand it, this bug exists in the 10.1.3 release. It seems that, as far as this bug is concerned, 10.2 is no worse than 10.1.3. For that reason, I would not be inclined to hold up the 10.2 release for this bug fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2006-09-21T20:20:31.000+0000","updated":"2006-09-21T20:20:31.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12436637","id":"12436637","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"> As I understand it, this bug exists in the 10.1.3 release. It seems that, as far as this bug is\r\n> concerned, 10.2 is no worse than 10.1.3. For that reason, I would not be inclined to hold up\r\n> the 10.2 release for this bug fix.\r\n\r\nTwo things:\r\n\r\n  1. Are we going to mention the known issues (esp. regressions) that exist with the 10.2 release (aside from intentional behavioral changes) somewhere in the release notes?  I looked at the html file attached to DERBY-1860 and didn't see any (the \"issues\" section just holds release notes for intentional behavior changes and/or fixes).  Are we just leaving it up to the users to navigate Jira to find outstanding issues like DERBY-1866?\r\n\r\n  2. Just as a note, this reasoning for not holding up the release also applies to DERBY-1777, DERBY-1633, and DERBY-1681, since all of those fail with 10.1.3 release, as well.  (Oh, and *DERBY-1854*, for that matter!)  Am I to understand that if any of those was still unresolved, we'd go ahead with the release nonetheless?  I'm not disagreeing with the decision, just curious if the \"it's no worse than <previous release>\" rule is specific to this particular Jira or if it applies on a more general scale?\r\n\r\nThanks for following through with this discussion and making a final decision!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-09-21T20:43:33.000+0000","updated":"2006-09-21T20:43:33.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12437266","id":"12437266","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Attaching a first patch for this issue, d1866_v1.patch.  In short, the problem was that, when pushing predicates to subqueries beneath UNIONs, the predicates were always being pushed to the *first* table in the subquery's FROM list, regardless of whether or not that was actually the correct table.  Thus it was possible to push a predicate down to a base table to which it didn't apply, thereby leading to an assertion failure in sane mode and an index out of bounds exception in insane mode.\r\n\r\nFor details on how this occurred and what the fix is, please refer to the code comments in the patch.  The d1866_v1 patch does the following:\r\n\r\n  1. Adds logic to ensure scoped predicates are only pushed\r\n     to the appropriate base tables.\r\n\r\n  2. Adds one line to OptimizerImpl to solve the hang that\r\n     was occuring for the second query shown in repro.sql.\r\n     The problem there was just that one variable was not\r\n     being properly reset when beginning a new round of\r\n     optimization.\r\n\r\n  3. Adds some test cases to verify the changes for #1 and\r\n     #2.\r\n\r\nNote that the patch is mostly just explanatory comments for existing and new logic, plus the test cases.\r\n\r\nI ran derbyall on Red Hat Linux with ibm142 using sane jars and there were no new failures.  I also ran the full ViewerInit program attached to DERBY-1777 and the program ran to completion without error.  (Note that the queries took a very, very long time to compile, though (longest one took almost 40 minutes).  Unfortunate though that is, I think that's a separate and more general issue with Derby optimization of subqueries--one to be addressed further down the road...)\r\n\r\nI would appreciate any reviews of this patch--even if it's just a quick read of the code comments to see if they make sense.  Every little bit helps, and as I'm sure everyone knows by now, optimizer changes are especially worthy of multiple reviews by as many people as possible...\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-09-24T23:32:37.000+0000","updated":"2006-09-24T23:32:37.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12437916","id":"12437916","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I ran  a success full set of tests against this patch against windows XP and ibm 1.4.2. jvm.  I reviewed the changes and the extensive comments seemed to match up with what the code was doing.  Looked like good tests were being added for the problem.  I am no optimizer expert so I suggest at least one more reviewer before we consider moving this patch from the trunk to 10.2 codeline.  Am committing this to the trunk to get it more testing.\r\n\r\nIf possible it would be good if anyone dependent on this change can test out the fix in the trunk and verify it works for\r\nthem.\r\n\r\nI committed this to the trunk:\r\nm1_ibm142:5>svn commit\r\n\r\nSending        java\\engine\\org\\apache\\derby\\impl\\sql\\compile\\OptimizerImpl.java\r\nSending        java\\testing\\org\\apache\\derbyTesting\\functionTests\\master\\predicatePushdown.out\r\nSending        java\\testing\\org\\apache\\derbyTesting\\functionTests\\tests\\lang\\predicatePushdown.sql\r\nTransmitting file data ...\r\nCommitted revision 450155.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2006-09-26T19:19:52.000+0000","updated":"2006-09-26T19:19:52.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12438001","id":"12438001","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Hi Army, I read through your code and tests; thanks for the clear and detailed comments!\r\n\r\nI noticed that the crucial bit of the change had to do with a comparison of table numbers;\r\nI'm not real familiar with how table numbers work, so I thought I'd ask a pretty naive question:\r\n\r\n   at this point in the processing, have constructs like views and synonyms already been\r\n   transformed and replaced by their underlying \"real\" tables?\r\n\r\nAlso, and related:\r\n\r\n  If the optimizer is choosing to access an index for a table, rather than accessing the\r\n  table itself, does the table number change depending on whether it is an index or\r\n  a base table which is being processed by the ProjectRestrictNode?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2006-09-27T02:34:12.000+0000","updated":"2006-09-27T02:34:12.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12438165","id":"12438165","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Hi Bryan, thanks for looking at the patch and for being willing to ask some good questions.  Below are my (perhaps slightly lengthy) responses.  If this doesn't address your questions or leaves you with new questions, please don't hesitate to ask again...\r\n\r\nThanks,\r\nArmy\r\n\r\n----\r\n\r\nQ1: At this point in the processing, have constructs like views\r\n   and synonyms already been transformed and replaced by their\r\n   underlying \"real\" tables? \r\n\r\nYes.  Transformations and table resolution occur during the \"binding\" and \"preprocessing\" stages of query compilation--and both of those stages occur before optimization begins.  So at this point a view will be represented by a ProjectRestrictNode whose child is a SelectNode, and a synonym will be represented by whatever FromTable it (the synonym) is actually referring to.\r\n\r\nTable numbers are also assigned during binding/preprocessing, so by the time we get to the code in d1866_v1.patch, all FromTables (aka  \"Optimizables\") in the entire query will have an assigned table number (if required--in some cases it's not necessary and thus will be -1).  Additionally any column reference which points to one of those FromTables will have the table number for that FromTable stored locally (namely, in ColumnReference.tableNumber).\r\n\r\nNote that when a ColumnReference is \"remapped\" to point to a different FromTable, its local information--including tableNumber--is updated accordingly.  Note also that a \"FromTable\" is not restricted to base tables--anything that can be specified in the FROM list of a SELECT query will be represented by some instance of FromTable, whether it be a subquery, a base table, a union node, etc.  Every FromTable has its own \"table number\", with the exception of ProjectRestrictNodes.  For a PRN, if the PRN's child is itself a FromTable (as opposed to, say, a SelectNode) then the PRN's table number will be -1 and any attempts to \"get\" the PRN's table number will return the table number of the PRN's child.  If the PRN's child is not a FromTable, then the PRN will have it's own table number.\r\n\r\nQ2: If the optimizer is choosing to access an index for a table, rather\r\n  than accessing the table itself, does the table number change depending\r\n  on whether it is an index or a base table which is being processed\r\n  by the ProjectRestrictNode?\r\n\r\nGreat question.  Short answer is \"no\" :)\r\n\r\nThe thing to note here is that \"table number\" is strictly a language-created, compilation time value to allow binding, preprocessing, optimization, and code generation to distinguish between the various FromTables in the original query.  A table number is not stored on disk and it is independent of the access path decisions (including whether or not an index is used) made by the optimizer.  Furthermore, there is no link between a given table number and the actual on-disk table that it points to.  Table number 0 could be for T1 in one query, T2 in another query, and T100 in a third query.\r\n\r\nAs a simple (but admittedly meaningless) example, take the following query:\r\n\r\n  select t1.i, x1.j from t1, t1 x1 where t1.i = x1.j;\r\n\r\nAt bind time Derby will assign every item in the FROM list a table number.  So in this case, \"T1\" gets table number 0 and \"T1 X1\" gets table number 1.  The fact that both FromTables are really pointing to the same base table doesn't matter.  For the duration of compilation/optimization, they are represented by two different instances of FromTable and are considered two different \"tables\", each having its own table number.  (For the record, in this particular example the different FromTables will in fact point to the same underlying tableDescriptor field).\r\n\r\nGiven that, the predicate \"t1.i = x1.j\" will have a left ColumnReference pointing to a FromBaseTable representing T1 with table number \"0\" and a right ColumnReference pointing to a different FromBaseTable representing X1 (i.e. T1 again) with table number \"1\".\r\n\r\nIf the optimizer then decides to use an index for T1, the table number doesn't change--the optimizer just decides that for \"the FromBaseTable whose table number is 0 we will use an index\".  In fact, once assigned, the table number for a specific FromTable remains the same for the duration of the compilation of the statement.\r\n\r\nThat was a round-about way of getting to the answer, but hopefully that's more helpful than confusing...\r\n\r\nAs I said, if you still have questions/confusion, please do ask again.  It's always good to answer questions like these, as it makes me re-check what I think I \"know\" and forces me to verify my replies by looking at the code again...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-09-27T16:46:03.000+0000","updated":"2006-09-27T16:46:03.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12438200","id":"12438200","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"body":"Hi Army, I read through the patch and the changes seem reasonable to me.  \r\n\r\nYou mentioned that:\r\n\r\n\"all FromTables (aka \"Optimizables\") in the entire query will have an assigned table number (if required--in some cases it's not necessary and thus will be -1).\"  \r\n\r\nCan you elaborate on this?  In what circumstances where the table number will be -1?  \r\n\r\ntNum = ((FromTable)curTable).getTableNumber();\r\n...\r\nif (tNum >= 0)\r\n    curTableNums.set(tNum);","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"created":"2006-09-27T19:24:25.000+0000","updated":"2006-09-27T19:24:25.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12438214","id":"12438214","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Thanks for the review, Yip!\r\n\r\n> Can you elaborate on this? In what circumstances where the table number will be -1? \r\n\r\nI think the answer to this question was buried in my earlier reply, namely:\r\n\r\n\"For a ProjectRestrictNode, if the PRN's child is itself a FromTable (as opposed to, say, a SelectNode) then the PRN's table number can be -1 and any attempts to \"get\" the PRN's table number will return the table number of the PRN's child. If the PRN's child is not a FromTable, then the PRN will have it's own table number. \"\r\n\r\nThat said, I think the check for \"tNum >= 0\" in this patch is probably unnecessary, since in the case just mentioned the call to \"getTableNumber()\" on a PRN will translate into a call to \"getTableNumber()\" on the child, which should then return a non-negative number.  I don't think it hurts to have the check in there, but since it's not expected to be -1, perhaps I can post a follow-up patch to remove the check and add an ASSERT to make sure that tNum is in fact positive...?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-09-27T20:37:58.000+0000","updated":"2006-09-27T20:37:58.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12438215","id":"12438215","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"body":"Right.  You mentioned one case where this can be -1 on your earlier reply, but I was wondering if there are any other cases where table number can be -1 since you mentioned there are some cases.  I think the extra check for tNum >= 0 is fine as is.   ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"created":"2006-09-27T20:44:44.000+0000","updated":"2006-09-27T20:44:44.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12438527","id":"12438527","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"> You mentioned one case where this can be -1 on your earlier reply,\r\n> but I was wondering if there are any other cases where table number\r\n> can be -1 since you mentioned there are some cases.\r\n\r\nSorry for misunderstanding your question.  When I wrote \"some\" cases I intended that to mean that there are \"some\" cases where a ProjectRestrictNode (PRN)'s tableNumber can be -1 (namely, if it's child is an Optimizable).  Since that's the only time I've ever seen a negative table number when tracing through code, I've been assuming that's the only case when it can happen.\r\n\r\nBut inspired by your question, I decided to do a search through the codeline to see if there are any other situations when a table number can be -1 during optimization.  (Note: the emphasis here is on optimization, since that's the area of code at issue with this Jira).\r\n\r\nThe only other case I found was for NormalizeResultSetNode, which is created for InsertNode and UpdateNode.  But NormalizeResultSetNodes are generated on top of a ResultSetNode to be optimized--they are not themselves optimized, which means that we wouldn't ever get to the code in d1866_v1.patch with a \"curTable\" that is a NormalizeResultSetNode.  So even though a NormalizeRSN can have a negative table number, that doesn't affect the proposed changes.\r\n\r\nThus based on my understanding, the only time a FromTable's table number can be -1 during optimization is if it is in fact a ProjectRestrictNode with a non-FromTable subquery as its child.\r\n\r\nAs a minor sort of sanity check for these results, I put a System.out in OptimizerImpl to print a message if we ever saw an Optimizable that had a negative table number but that was not a PRN, and then I ran derbylang.  The message was never printed.  This doesn't \"prove\" anything in particular, but it does lend evidence to the results of my code search...\r\n\r\n---\r\n\r\nDetails on my search:\r\n\r\nBelow are the classes I found that extend FromTable.  I looked to see 1) where the various classes were instantiated, and 2) where their table numbers were set (if at all).  The breakdown based on my searching is as follows:\r\n\r\nFromTables whose table numbers are always set during binding (and thus will not be -1 when it comes time to optimize):\r\n\r\n CurrentOfNode\r\n FromBaseTable\r\n FromSubquery\r\n FromVTI\r\n RowResultSetNode\r\n TableOperatorNode\r\n ->JoinNode (via inheritance from TableOp)\r\n --->HalfOuterJoinNode (inheritance from TableOp)\r\n ->SetOperatorNode (inheritance from TableOp)\r\n --->IntersectOrExceptNode (inheritance from TableOp)\r\n --->UnionNode (inheritance from TableOp)\r\n\r\nFromTables that are only instantiated AFTER optimization has completed, and thus even though their table numbers can be -1, that won't affect optimization.\r\n\r\n IndexToBaseRowNode\r\n SingleChildResultSetNode\r\n ->DistinctNode\r\n ->GroupByNode\r\n ->HashTableNode\r\n ->MaterializeResultSetNode\r\n ->OrderByNode\r\n ->ScrollInsensitiveResultSetNode\r\n\r\nFromTables that can be instantiated during preprocessing but that may not have their table numbers set (these are the ones of interest to the current discussion):\r\n\r\n ProjectRestrictNode:\r\n\r\n  If created during preprocessing, table number will only be set in\r\n  FromSubquery.extractSubquery(); in all other cases it will remain -1.\r\n\r\n NormalizeResultSetNode:\r\n\r\n  Instantiated during bind phase for InsertNode and UpdateNode\r\n  but table number is not set.  So it will be -1.  However,\r\n  a NormalizeresultSetNode never appears in an optimizer's\r\n  optimizableList, and thus such a node will never actually\r\n  be optimized.\r\n\r\n----\r\n\r\nHopefully that's more in line with what you were asking?\r\n\r\nThanks again for the review and great questions...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-09-28T19:02:56.000+0000","updated":"2006-09-28T19:02:56.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12438534","id":"12438534","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"body":"Yes, that is what I was looking for.  Thanks for the extensive analysis and explanation on the table number logic in the optimizer, Army.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yipng","name":"yipng","emailAddress":"yipng168 at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yip Ng","active":true},"created":"2006-09-28T19:34:16.000+0000","updated":"2006-09-28T19:34:16.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12439174","id":"12439174","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"body":"Looks like this one made it into 10.2.1.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rhillegas","name":"rhillegas","emailAddress":"rhillegas at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rick Hillegas","active":true},"created":"2006-10-02T14:37:12.000+0000","updated":"2006-10-02T14:37:12.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12439190","id":"12439190","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I backported this fix to both the 10.2 and 10.1 branches.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2006-10-02T15:29:45.000+0000","updated":"2006-10-02T15:29:45.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12350272/comment/12443563","id":"12443563","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"body":"Fix is in 10.3, 10.2, and 10.1, and I haven't heard any follow-up feedback, so marking is as closed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=army","name":"army","emailAddress":"qozinx at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A B","active":true},"created":"2006-10-19T16:20:52.000+0000","updated":"2006-10-19T16:20:52.000+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1866/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06v5j:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12367248","self":"https://issues.apache.org/jira/rest/api/latest/issue/12367248","key":"DERBY-2549","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312251","id":"12312251","description":"Head of 10.2 branch","name":"10.2.2.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312590","id":"12312590","description":"","name":"10.3.1.4","archived":false,"released":true,"releaseDate":"2007-08-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2007-04-18 14:48:09.23","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"23095","customfield_12310222":"3_*:*_1_*:*_663765368_*|*_1_*:*_1_*:*_2494663249_*|*_5_*:*_1_*:*_0","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2007-05-22T20:47:08.109+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2549/watchers","watchCount":0,"isWatching":false},"created":"2007-04-16T07:26:39.492+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"12.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312027","id":"12312027","description":"","name":"10.2.2.0","archived":false,"released":true,"releaseDate":"2006-12-19"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-01-21T17:50:03.397+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11412","id":"11412","name":"Store"}],"timeoriginalestimate":null,"description":"I am doing this in my code:\n\nCALL SYSCS_UTIL.SYSCS_INPLACE_COMPRESS_TABLE('SPONTS','\" + \"journal\".toUpperCase(Locale.US) + \"',1,1,1)\")\n\n(\"journal\" is actually a String-variable, but I replaced it here for easier understanding)\n\nSometime - not always - I am getting this exception:\n\njava.sql.SQLException: The exception 'java.lang.ArrayIndexOutOfBoundsException: 100' was thrown while evaluating an expression. SQLSTATE: XJ001:\nJava exception: '100: java.lang.ArrayIndexOutOfBoundsException'.\n        at org.apache.derby.client.am.SQLExceptionFactory.getSQLException(Unknown Source)\n        at org.apache.derby.client.am.SqlException.getSQLException(Unknown Source)\n        at org.apache.derby.client.am.Statement.execute(Unknown Source)\n[...]\nCaused by: org.apache.derby.client.am.SqlException: The exception 'java.lang.ArrayIndexOutOfBoundsException: 100' was thrown while evaluating an expression.\n SQLSTATE: XJ001: Java exception: '100: java.lang.ArrayIndexOutOfBoundsException'.\n        at org.apache.derby.client.am.Statement.completeExecute(Unknown Source)\n        at org.apache.derby.client.net.NetStatementReply.parseEXCSQLSTTreply(Unknown Source)\n        at org.apache.derby.client.net.NetStatementReply.readExecuteCall(Unknown Source)\n        at org.apache.derby.client.net.StatementReply.readExecuteCall(Unknown Source)\n        at org.apache.derby.client.net.NetStatement.readExecuteCall_(Unknown Source)\n        at org.apache.derby.client.am.Statement.readExecuteCall(Unknown Source)\n        at org.apache.derby.client.am.Statement.flowExecute(Unknown Source)\n        at org.apache.derby.client.am.Statement.executeX(Unknown Source)\n        ... 12 more","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"37458","summary":"ArrayIndexOutOfBoundsException in SYSCS_UTIL.SYSCS_INPLACE_COMPRESS_TABLE","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"subtasks":[],"customfield_12310090":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10102","value":"Patch Available","id":"10102"}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Linux 2.6.x, JRE 1.5.0_b7","customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":35,"total":35,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12489716","id":"12489716","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"I am able to reproduce it with Sun Java build 1.6.0-b105. I changed the exception reporting code to show the real source:\r\n\r\njava.lang.ArrayIndexOutOfBoundsException: 100\r\n\tat org.apache.derby.impl.store.access.heap.HeapCompressScan.fetchRowsForCompress(HeapCompressScan.java:213)\r\n\tat org.apache.derby.impl.store.access.heap.HeapCompressScan.fetchNextGroup(HeapCompressScan.java:116)\r\n\tat org.apache.derby.iapi.db.OnlineCompress.defragmentRows(OnlineCompress.java:384)\r\n\tat org.apache.derby.iapi.db.OnlineCompress.compressTable(OnlineCompress.java:228)\r\n\tat org.apache.derby.catalog.SystemProcedures.SYSCS_INPLACE_COMPRESS_TABLE(SystemProcedures.java:927)\r\n\tat org.apache.derby.exe.ac601a400fx0112x04cex382ex00000045c1b80.g0(Unknown Source)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\r\n\tat java.lang.reflect.Method.invoke(Method.java:597)\r\n\tat org.apache.derby.impl.services.reflect.ReflectMethod.invoke(ReflectMethod.java:46)\r\n\tat org.apache.derby.impl.sql.execute.CallStatementResultSet.open(CallStatementResultSet.java:68)\r\n\tat org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:358)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1182)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:585)\r\n\tat org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:517)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-04-18T13:13:21.579+0000","updated":"2007-04-18T13:13:21.579+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12489772","id":"12489772","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"FYI, a user claimed to have a reproducible example for this on IRC. Unfortunately, he/she wasn't sure what to do with it, and left before I was able to answer.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2007-04-18T14:48:09.230+0000","updated":"2007-04-18T14:48:09.230+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12489795","id":"12489795","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"body":"A little app printing simple disk space diagnostics.\r\nNot very well tested...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kristwaa","name":"kristwaa","emailAddress":"kristwaa at apache dot org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kristwaa&avatarId=14736","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kristwaa&avatarId=14736","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kristwaa&avatarId=14736","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kristwaa&avatarId=14736"},"displayName":"Kristian Waagan","active":true},"created":"2007-04-18T15:31:21.868+0000","updated":"2007-04-18T15:31:21.868+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12489800","id":"12489800","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"Output from the app is\r\n\r\nTablename                 Type   ALLOC   FREE PSIZE   SAVE File      Size KB \r\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\r\nATTACHMENTFILTER          TABLE      1      0  4096      0 c3c0.dat        8\r\n  SQL070409002320120      INDEX      1      0  4096      0 c3d1.dat        8\r\nAUTOBLACKLIST             TABLE      1      0  4096      0 c3e0.dat        8\r\n  SQL070409002320240      INDEX      1      0  4096      0 c3f1.dat        8\r\nCACHE                     TABLE    670      0  4096      0 c400.dat     2684\r\n  SQL070409002320280      INDEX    596      0  4096      0 c411.dat     2388\r\nDISINFECTIONOPTIN         TABLE      1      0  4096      0 c420.dat        8\r\n  SQL070409002320310      INDEX      1      0  4096      0 c431.dat        8\r\nDISPOSABLEOPTIN           TABLE      1      0  4096      0 c440.dat        8\r\n  SQL070409002320350      INDEX      1      0  4096      0 c451.dat        8\r\nDISPOSABLERECIPIENTS      TABLE      1      0  4096      0 c460.dat        8\r\n  SQL070409002320380      INDEX      1      0  4096      0 c471.dat        8\r\nDOMAINADMIN               TABLE      1      0  4096      0 c480.dat        8\r\n  SQL070409002320410      INDEX      1      0  4096      0 c491.dat        8\r\nENVELOPEPOLICY            TABLE      2      0  4096      0 c4a0.dat       12\r\n  SQL070409002320450      INDEX      1      0  4096      0 c4b1.dat        8\r\nFETCHACCOUNT              TABLE      1      0  4096      0 c4c0.dat        8\r\n  SQL070409002320520      INDEX      1      0  4096      0 c4d1.dat        8\r\nFTPUSER                   TABLE      1      0  4096      0 c4e0.dat        8\r\n  SQL070409002320570      INDEX      1      0  4096      0 c4f1.dat        8\r\nJOURNAL                   TABLE   4710    377 32768 12353536 c500.dat   162816\r\n  SQL070409002320610      INDEX   4619   1125  4096 4608000 c511.dat    22980\r\n  JOURNAL_RECEIVEDDATE_DESC INDEX   5795      0  4096      0 c521.dat    23204\r\nLOCALDOMAINS              TABLE      1      0  4096      0 c530.dat        8\r\n  SQL070409002320700      INDEX      1      0  4096      0 c541.dat        8\r\nMONITORPROXIES            TABLE      1      0  4096      0 c550.dat        8\r\n  SQL070409002320730      INDEX      1      0  4096      0 c561.dat        8\r\nRCPTREWRITE               TABLE      1      0  4096      0 c570.dat        8\r\n  SQL070409002320780      INDEX      1      0  4096      0 c581.dat        8\r\nRECIPIENTBACKEND          TABLE      1      0  4096      0 c590.dat        8\r\n  SQL070409002320820      INDEX      1      0  4096      0 c5a1.dat        8\r\nRECIPIENTKEYS             TABLE      1      0  4096      0 c5b0.dat        8\r\n  SQL070409002320860      INDEX      1      0  4096      0 c5c1.dat        8\r\nRECIPIENTSTATISTIC        TABLE     14      0  4096      0 c5d0.dat       60\r\n  SQL070409002320890      INDEX     12      0  4096      0 c5e1.dat       52\r\nREPLAYADMIN               TABLE      1      0  4096      0 c5f0.dat        8\r\n  SQL070409002320930      INDEX      1      0  4096      0 c601.dat        8\r\nREPLAYLOG                 TABLE      1      0 32768      0 c610.dat       64\r\n  SQL070409002320970      INDEX      1      0  4096      0 c621.dat        8\r\n  REPLAYLOG_RECEIVEDDATE_DESC INDEX      1      0  4096      0 c631.dat        8\r\nSTATISTICOPTIN            TABLE      1      0  4096      0 c640.dat        8\r\n  SQL070409002321100      INDEX      1      0  4096      0 c651.dat        8\r\n  SYSALIASES_INDEX1       INDEX      1      0  4096      0 c191.dat        8\r\n  SYSALIASES_INDEX2       INDEX      1      0  4096      0 c1a1.dat        8\r\n  SYSALIASES_INDEX3       INDEX      1      0  4096      0 c1b1.dat        8\r\nSYSALIASES                TABLE      5      0  4096      0 c180.dat       24\r\n  SYSCHECKS_INDEX1        INDEX      1      0  4096      0 c1f1.dat        8\r\nSYSCHECKS                 TABLE      1      0  4096      0 c1e0.dat        8\r\n  SYSCOLPERMS_INDEX1      INDEX      1      0  4096      0 c351.dat        8\r\n  SYSCOLPERMS_INDEX2      INDEX      1      0  4096      0 c361.dat        8\r\n  SYSCOLPERMS_INDEX3      INDEX      1      0  4096      0 c371.dat        8\r\nSYSCOLPERMS               TABLE      1      0  4096      0 c340.dat        8\r\n  SYSCOLUMNS_INDEX1       INDEX      7      0  4096      0 ca1.dat        32\r\n  SYSCOLUMNS_INDEX2       INDEX      5      0  4096      0 cb1.dat        24\r\nSYSCOLUMNS                TABLE      8      0  4096      0 c90.dat        36\r\n  SYSCONGLOMERATES_INDEX1 INDEX      3      0  4096      0 c31.dat        16\r\n  SYSCONGLOMERATES_INDEX2 INDEX      4      0  4096      0 c41.dat        20\r\n  SYSCONGLOMERATES_INDEX3 INDEX      3      0  4096      0 c51.dat        16\r\nSYSCONGLOMERATES          TABLE      7      0  4096      0 c20.dat        32\r\n  SYSCONSTRAINTS_INDEX1   INDEX      1      0  4096      0 c101.dat        8\r\n  SYSCONSTRAINTS_INDEX2   INDEX      1      0  4096      0 c111.dat        8\r\n  SYSCONSTRAINTS_INDEX3   INDEX      1      0  4096      0 c121.dat        8\r\nSYSCONSTRAINTS            TABLE      1      0  4096      0 cf0.dat         8\r\n  SYSDEPENDS_INDEX1       INDEX      1      0  4096      0 c161.dat        8\r\n  SYSDEPENDS_INDEX2       INDEX      1      0  4096      0 c171.dat        8\r\nSYSDEPENDS                TABLE      1      0  4096      0 c150.dat        8\r\nSYSDUMMY1                 TABLE      1      0  4096      0 c2f0.dat        8\r\n  SYSFILES_INDEX1         INDEX      1      0  4096      0 c271.dat        8\r\n  SYSFILES_INDEX2         INDEX      1      0  4096      0 c281.dat        8\r\nSYSFILES                  TABLE      1      0  4096      0 c260.dat        8\r\n  SYSFOREIGNKEYS_INDEX1   INDEX      1      0  4096      0 c211.dat        8\r\n  SYSFOREIGNKEYS_INDEX2   INDEX      1      0  4096      0 c221.dat        8\r\nSYSFOREIGNKEYS            TABLE      1      0  4096      0 c200.dat        8\r\n  SYSKEYS_INDEX1          INDEX      1      0  4096      0 c141.dat        8\r\nSYSKEYS                   TABLE      1      0  4096      0 c130.dat        8\r\n  SYSROUTINEPERMS_INDEX1  INDEX      1      0  4096      0 c391.dat        8\r\n  SYSROUTINEPERMS_INDEX2  INDEX      1      0  4096      0 c3a1.dat        8\r\n  SYSROUTINEPERMS_INDEX3  INDEX      1      0  4096      0 c3b1.dat        8\r\nSYSROUTINEPERMS           TABLE      1      0  4096      0 c380.dat        8\r\n  SYSSCHEMAS_INDEX1       INDEX      1      0  4096      0 cd1.dat         8\r\n  SYSSCHEMAS_INDEX2       INDEX      1      0  4096      0 ce1.dat         8\r\nSYSSCHEMAS                TABLE      1      0  4096      0 cc0.dat         8\r\n  SYSSTATEMENTS_INDEX1    INDEX      1      0  4096      0 c241.dat        8\r\n  SYSSTATEMENTS_INDEX2    INDEX      3      0  4096      0 c251.dat       16\r\nSYSSTATEMENTS             TABLE     25     23  4096  94208 c230.dat      196\r\n  SYSSTATISTICS_INDEX1    INDEX      1      0  4096      0 c2e1.dat        8\r\nSYSSTATISTICS             TABLE      1      0  4096      0 c2d0.dat        8\r\n  SYSTABLEPERMS_INDEX1    INDEX      1      0  4096      0 c311.dat        8\r\n  SYSTABLEPERMS_INDEX2    INDEX      1      0  4096      0 c321.dat        8\r\n  SYSTABLEPERMS_INDEX3    INDEX      1      0  4096      0 c331.dat        8\r\nSYSTABLEPERMS             TABLE      1      0  4096      0 c300.dat        8\r\n  SYSTABLES_INDEX1        INDEX      1      0  4096      0 c71.dat         8\r\n  SYSTABLES_INDEX2        INDEX      1      0  4096      0 c81.dat         8\r\nSYSTABLES                 TABLE      2      0  4096      0 c60.dat        12\r\n  SYSTRIGGERS_INDEX1      INDEX      1      0  4096      0 c2a1.dat        8\r\n  SYSTRIGGERS_INDEX2      INDEX      1      0  4096      0 c2b1.dat        8\r\n  SYSTRIGGERS_INDEX3      INDEX      1      0  4096      0 c2c1.dat        8\r\nSYSTRIGGERS               TABLE      1      0  4096      0 c290.dat        8\r\n  SYSVIEWS_INDEX1         INDEX      1      0  4096      0 c1d1.dat        8\r\nSYSVIEWS                  TABLE      1      0  4096      0 c1c0.dat        8\r\nUCEOPTIN                  TABLE      1      0  4096      0 c660.dat        8\r\n  SQL070409002321140      INDEX      1      0  4096      0 c671.dat        8\r\nUSERS                     TABLE      1      0  4096      0 c680.dat        8\r\n  SQL070409002321170      INDEX      1      0  4096      0 c691.dat        8\r\nVALIDRECIPIENTS           TABLE    192      4  4096  16384 c6a0.dat      788\r\n  SQL070409002321210      INDEX    263      0  4096      0 c6b1.dat     1056\r\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\r\nTotal                            17030   1529   n/a 17072128 KB n/a     217200\r\n\r\nThe table is basically a log file. It is created by only adding new records and when 350.000 records are reached, the first (oldest) 50.000 entries are deleted. This is done by determining the 50.000th element and then deleting entries with \"WHERE xxx < yyy\" where xxx is an order column and yyy is the value of this column of the 50.000th element.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-04-18T15:43:41.173+0000","updated":"2007-04-18T15:43:41.173+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12489826","id":"12489826","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"I digged somehow deeper into this issue: I dropped all other tables and dropped the index of the table; there is only the primary key left. I replaced all values by '' and still the problem appeared. Then I tried to replace all values with 'xxxx' of the same size; after 6857 successful row updates, this happened:\r\n\r\nException in thread \"main\" org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED statementContext is not expected to equal statementContexts[0]\r\n\tat org.apache.derby.shared.common.sanity.SanityManager.ASSERT(SanityManager.java:120)\r\n\tat org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext.popStatementContext(GenericLanguageConnectionContext.java:2095)\r\n\tat org.apache.derby.impl.jdbc.EmbedResultSet.updateRow(EmbedResultSet.java:3773)\r\n\r\ntable DDL is:\r\n\r\nCREATE TABLE journal(\r\n  ID VARCHAR(20) PRIMARY KEY default '' NOT NULL,\r\n  IP VARCHAR(45) default '' NOT NULL,\r\n  SENDER VARCHAR(32000) default '' NOT NULL,\r\n  RECIPIENT VARCHAR(32000) default '' NOT NULL,\r\n  MAILSENDER VARCHAR(32000) default '' NOT NULL,\r\n  MAILFROM VARCHAR(32000) default '' NOT NULL,\r\n  MAILTO VARCHAR(32000) default '' NOT NULL,\r\n  CC VARCHAR(32000) default '' NOT NULL,\r\n  BCC VARCHAR(32000) default '' NOT NULL,\r\n  REPLYTO VARCHAR(32000) default '' NOT NULL,\r\n  MAILDATE TIMESTAMP default '0001-01-01 00:00:00',\r\n  RECEIVEDDATE TIMESTAMP default '0001-01-01 00:00:00' NOT NULL,\r\n  SUBJECT VARCHAR(32000) default '' NOT NULL,\r\n  TOTALLENGTH BIGINT default 0 NOT NULL,\r\n  ATTACHMENTS VARCHAR(32000) default '' NOT NULL,\r\n  SPAMSCORE DOUBLE NOT NULL,\r\n  STATUS VARCHAR(11) default 'aborted' NOT NULL,\r\n  REASON VARCHAR(32000) NOT NULL);\r\nCREATE INDEX journal_receiveddate_desc ON journal(receiveddate DESC);\r\n\r\nFYI, I compiled Derby from the current SVN 10.2 branch and added \"line,vars,source\" as debug options so that I can see where the issue happens. And it is a \"sane\" build.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-04-18T17:30:09.126+0000","updated":"2007-04-18T17:30:09.126+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12489899","id":"12489899","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"I just tried the replacement with batches of 2000 rows like this:\r\n\r\n        int errorRow = 0;\r\nl1:        while(true) {\r\n    final ResultSet rs = stm.executeQuery(\"SELECT * FROM journal FOR UPDATE\");\r\n        for (int row = 1; rs.next(); row++) {\r\n            if (row < errorRow) {\r\n                continue;\r\n            }\r\n            update(rs, \"ip\");\r\n            update(rs, \"sender\");\r\n            update(rs, \"recipient\");\r\n            update(rs, \"mailsender\");\r\n            update(rs, \"mailfrom\");\r\n            update(rs, \"mailto\");\r\n            update(rs, \"cc\");\r\n            update(rs, \"bcc\");\r\n            update(rs, \"replyto\");\r\n            update(rs, \"subject\");\r\n            update(rs, \"attachments\");\r\n            update(rs, \"status\");\r\n            update(rs, \"reason\");\r\n            rs.updateInt(\"totallength\", 0);\r\n            rs.updateDouble(\"spamscore\", 0);\r\n            rs.updateRow();\r\n            if (row == errorRow + 2000) {\r\n                errorRow = row;\r\n                rs.close();\r\n                continue l1;\r\n            }\r\n            \r\n            if (row % 500 == 0) {\r\n                System.out.println(row);\r\n            }\r\n        }\r\n        break;\r\n        }\r\n\r\nbut this only brought me up to 9500+. Then I tried it with closing the Statement and Connection and recreating them after 2000 updates. This worked fine.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-04-18T22:14:28.225+0000","updated":"2007-04-18T22:14:28.225+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12491558","id":"12491558","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"I've prepared a database and a sample application, that reproduces this problem: if you compress it, then the Exception occurs. If you insert one additional row, the compress will work fine. As I said before, the database contains logfiles from a mailserver, so I cannot post the file here in Jira.\r\n\r\nCan someone send me his email address and some kind of confidential statement to kurt AT huwig DOT de, please?\r\n\r\nOtherwise, is there a way to erase/overwrite the data contained in the files? I tried to overwrite them, but this cannot be done with the entries that are already deleted.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-04-25T08:33:48.096+0000","updated":"2007-04-25T08:33:48.096+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12491613","id":"12491613","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"I created a small patch that fixes the problem for me. Although I do not understand the code fully, it seems to me that the reason for the failure is that it finds more then 100 empty rows to be cleaned up but the result array only has space for 100 entries.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-04-25T11:55:10.027+0000","updated":"2007-04-25T11:55:10.027+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12491681","id":"12491681","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"If your theory about the hard-coded limit of 100 rows to be compressed on a single page is true, perhaps you could construct a completely clean test case by just starting with a fresh empty database, creating the table with the appropriate DDL, then populating it with a bunch of  test data that you make up, deleting that test data, and trying to compress the table.\r\n\r\nThat is, do you actually need your real database for a test case? Can you make a test case by making a new database which has a table which has more than 100 rows on the page eligible for compression?\r\n\r\nThat would be ideal, because then you could contribute the test case without concern for data sensitivity.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-04-25T16:01:53.487+0000","updated":"2007-04-25T16:01:53.487+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12491700","id":"12491700","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"Bryan,\r\n\r\nI tried this, but even after several hours of running time, it was working fine. I am not 100% percent sure, but I think the same problem occured on two different databases. I will give it a try and let the code run for some more hours. Also I will try it with the 10.2.2.0 release. I had to switch to the 10.2 SVN trunk, as there are two bugs fixed that I ran into frequently. Does anybody know when there will be a new release?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-04-25T16:50:53.683+0000","updated":"2007-04-25T16:50:53.683+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12491873","id":"12491873","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"You might want to look at Derby-606. The testcases that were added could be useful for this scenario.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2007-04-26T05:11:17.055+0000","updated":"2007-04-26T05:11:17.055+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12491955","id":"12491955","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"I tweaked the code a bit to use arrays of size 1000 instead of 100 and put debugging code in it that prints the used space of the array if it is larger than 100. There was only one occurence of a usage of more than 100 elements which was 111. I will attach a histogram of the frequencies of the different array usages.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-04-26T10:38:26.832+0000","updated":"2007-04-26T10:38:26.832+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12491956","id":"12491956","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"Histogram of the frequency of the \"number of elements in the array\". X is array usage, Y is frequency.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-04-26T10:39:48.160+0000","updated":"2007-04-26T10:39:48.160+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12491961","id":"12491961","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"My patch does not compress the full database. I will limit the case when there are 111 compressable elements to 100, so that they fit into the result array. But after that, the remaining 11 elements are still not compressed. If I run INPLACE_COMPRESS again, my debugging output shows me that it compressed just these 11 elements. A third or more runs will yield no further changes to the database.\r\n\r\nTherefore I guess that the limitation to 100 is somehow arbitrary and does not apply to my specifiy database.\r\n\r\nComparing to DERBY-606, the size of my database is 159MB vs several GB and it contains only 301.451 elements vs 60 million.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-04-26T10:50:32.973+0000","updated":"2007-04-26T10:50:32.973+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12492282","id":"12492282","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"I was able to reproduce this error. Attaching a sample program here.\r\n\r\nI think, the issue here is that, During Heap Scan (in Compress operation) the size of the array that can hold  the records is hard coded to 100. So when the recordCount for a page is more than 100, during compress operation, it will throw AIOBE. This is possible in 2 cases, either the record size is small so that in a page (with default size, 8192) more than 100 records are stored, or default page size is changed to a higher value that will accomodate more than 100 records.\r\n\r\nTo reproduce this bug, please run the attached program as below,\r\n\r\njava -cp $CLASSPATH:. -Dderby.debug.true=SpaceTrace -Dderby.storage.pageSize=32768 A2549Test > log.txt\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2007-04-27T12:48:41.993+0000","updated":"2007-04-27T12:48:41.993+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12492301","id":"12492301","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"Great work Mayuresh! Your test program reproduces the problem for me, too.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-04-27T14:11:37.250+0000","updated":"2007-04-27T14:11:37.250+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12492307","id":"12492307","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"This explanations sounds reasonable. I tried to find some documentation on how to determine the row and page sizes. According to the Derby tuning docs\r\n\r\ndocs/html/tuning/ctunperf10065.html\r\n\r\nthe default page size is 4k, not 8k.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-04-27T14:23:08.809+0000","updated":"2007-04-27T14:23:08.809+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12492312","id":"12492312","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"body":"It seems to me like there might be two alternate solutions:\r\n1) Kurt's technique of compressing only the first 100 rows on\r\nthe page in a single run, requiring, potentialy, multiple runs to\r\ncompress all the rows\r\n2) Adjusting the array size dynamically, so that it doesn't have\r\na hard limit of 100, but rather can be sized appropriately for\r\nhowever many rows are on the page.\r\n\r\nIs there any reason to prefer one solution over the other?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanpendleton","name":"bryanpendleton","emailAddress":"bpendleton dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Pendleton","active":true},"created":"2007-04-27T14:33:41.622+0000","updated":"2007-04-27T14:33:41.622+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12492316","id":"12492316","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"Bryan, I am also inclined towards Option 2. I think that will be the right fix, just that I was caught up with something, hence could not produce a patch today.\r\nI will create a patch for this early next week and will try to submit it for review.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2007-04-27T15:07:32.815+0000","updated":"2007-04-27T15:07:32.815+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12492319","id":"12492319","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"Byan, the array check I introduced keeps Derby from crashing. IMHO, a check like this should be kept in order to prevent further crashes. Most preferable I would like to have a check that issues a warning when more rows are found than fit into the array. This way, we would keep the crash from happening ever again while still it is reportable when it occurs. An array bounds check is cheap so it will not decrease the defragmentation significantly.\r\n\r\nStill having properly sized arrays is the best solution and the necessary array size should not be significantly larger than the now used 100 and I guess its even smaller than that for most tables. Calculation the maximum number of rows could be done at the beginning, so it won't affect running time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-04-27T15:20:02.046+0000","updated":"2007-04-27T15:20:02.046+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12492405","id":"12492405","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I think there is yet a third option.  The intent of this loop is to operate like the standard group fetch for normal scans.  So  it should just work to fetch N rows and have the loop check for N, and just return from the middle of the loop and leave the scan to get the rest of the rows on the next scan.  It shouldn't be necessary to size the group exactly and should not be necessary to just give up on a page if it has more rows.\r\n\r\nI have attached a quick patch i did, but have not run full tests.  It did seem to pass the attached bug case and passed the existing online compress test.  Would appreciate if you could run this patch with your debugging to verify that we get all 111 rows rather than skipping the remaining 11.\r\n\r\nA real checkin should include a new test case, probably based on the recent case that  reproduces the problem.  Though I noted that license has not been granted on that attachment.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2007-04-27T22:00:32.071+0000","updated":"2007-04-27T22:00:32.071+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12492447","id":"12492447","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"Mike,\r\n\r\nI had to run the compress 3 times until it stopped finding empty rows, which is one pass worse than my patch :-)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-04-28T07:16:11.611+0000","updated":"2007-04-28T07:16:11.611+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12494970","id":"12494970","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"Thanks Mike for clarifying the behavior.\r\n\r\nOn a second thought, Option 2 mentioned above would not be suitable because the size will also have to changed for few other arrays and huge size might lead to OOME. The existing approach as described in mike's comment sounds reasonable.\r\n\r\nI debugged mike's quick patch and it seems that after reaching the limit (page is unlatched), scan_position is not repositioned correctly. In fact, in this special case, on attempt to fetch next group, no valid page is found. So, only 100 rows can be cleaned per Compress operation.\r\n\r\nI will work on a follow up patch from tje patch mike attached. Thanks again mike.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2007-05-11T06:54:40.374+0000","updated":"2007-05-11T06:54:40.374+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12495008","id":"12495008","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"I have created a new patch, derby2549_v2.diff.\r\n\r\nThis change ensures that for the case when no of rows are more than row_array can hold, the same page will be fetched again in the next cycle to make sure the remaining rows are looked at.\r\n\r\nKurt, could you please try out this patch.\r\nI will start the testruns now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2007-05-11T09:27:24.125+0000","updated":"2007-05-11T09:27:24.125+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12495045","id":"12495045","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"Mayuresh,\r\n\r\nthe patch is working fine and it compresses the database within one pass.\r\n\r\nThanks for the good work!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-05-11T12:52:15.069+0000","updated":"2007-05-11T12:52:15.069+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12495105","id":"12495105","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"notes on the recent patch:\r\no it looks like your new lines expect 8 space tabs, derby code should either use not indent tabs or should use\r\n    4 space tabs.  \r\no this level of code should not be doing -- on the page number, it should use the raw store interfaces to move \r\n    to next and previous pages.  There are a couple of reasons:\r\n    1) even though the current raw store implementation dones have pages for each container laid out from 0 to N,\r\n         future implementations may not.\r\n     2) The get next and get previous interfaces take care of  postioning on the next USER head page -- by doing \r\n           -- or ++ you may get put on an overflow row page, a raw store internal bit map page, ...\r\n\r\no As you found in your debugging the problem with my previous patch was that the position of the scan was not\r\n    properly maintained in the scan_position (that will teach me to copy/paste code from other parts of system).  \r\n    I think a better fix would be to properly position the scan on the right  row, rather than letting the code get to \r\n     the postion at next page code path and then reposition backward to the previous page.   \r\n\r\n    Scan positions are meant to be maintained by a couple of different means.  While you have a latch on the page\r\n    it is fine to just maintain the slot number as nothing can change out from under you unless you do it.  If you \r\n    are going to give up the latch on heap scan then the usual way to maintain a scan is by getting the record \r\n     handl associated with the current slot number, then this can be used to repostion the scan the next trip back.\r\n     I'll post another patch with a suggestion, let me know what you think.  Again I haven't had time to debug it.\r\n\r\n     Also it would be good to get a test added to the test suite for this bug, do you plan on doing that?  I think  the\r\n     easiest case would be:\r\n     o create a table with 1 column, smallest datatype possible - say smallint, and largest page size.  It would be good if the\r\n         test case had more than 200 rows that could be moved so it would test visiting the same page more than\r\n         2 times.\r\n     o add enough rows to get a reasonable number of pages - say 10.\r\n     o delete rows leaving at least one row per page, probably easiest if you just delete every row execept each 100th row in the order you inserted them , or something like that. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2007-05-11T17:40:55.448+0000","updated":"2007-05-11T17:40:55.448+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12495107","id":"12495107","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"patch illustrating most recent comments on saving row position.  Not ready for commit - no tests/debugging done.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2007-05-11T17:44:41.022+0000","updated":"2007-05-11T17:44:41.022+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12495167","id":"12495167","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"body":"I created a testcase as Michael described, but it DOES NOT reproduce the problem, i.e. there is nothing compressed. But maybe it is a good start for somebody else.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kurti","name":"kurti","emailAddress":"apache at huwig dot de","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kurt Huwig","active":true},"created":"2007-05-11T21:07:32.631+0000","updated":"2007-05-11T21:07:32.631+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12495492","id":"12495492","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"Thanks Mike for your expert comments. I realized that '--' is inappropriate after posting the patch. I am sure it would have taken a bit more time for me to come up with that solution due to my limited understanding. I appreciate your time for the explanation and the patch.\r\n\r\nI found two small nits in the latest patch. When, getRecordHandleAtSlot is called scan_position has already moved back to the previous slot. This will imply incorrect behavior when current_slot becomes -1. I have fixed this by storing the current_slot number in a new variable temp_current_slot and passing this to getRecordHandleAtSlot.\r\n\r\nI am starting testruns for this latest patch now.\r\n\r\nI plan to add a test for this based on the repro attached. I will try to cut down the time taken by the test by using small size data. I need some time for this as I am not very familiar with junit fixtures. I am hoping that the testcase addition will go as a separate patch. let me know your thoughts ??\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2007-05-14T07:12:45.313+0000","updated":"2007-05-14T07:12:45.313+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12495573","id":"12495573","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"derbyall and Suites_All did NOT show any new failures for the patch v3.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2007-05-14T12:04:31.324+0000","updated":"2007-05-14T12:04:31.324+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12495895","id":"12495895","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"I have added another test to store/OnlineCompressTest.java.\r\nThe test is based on the repro I had attached. I have downsized the time required by the test to something much lower than the repro.\r\n\r\nThe patch only has test changes (test code + master files)\r\n\r\nThe 2 patches, derby2549_v3.diff and derby2549_testv1.diff are ready for review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2007-05-15T08:39:52.420+0000","updated":"2007-05-15T08:39:52.420+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12497638","id":"12497638","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I am ready to commit your test and  patch, but the attachments you have submitted are not checked to grant \r\nlicense to the ASF.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2007-05-21T23:49:07.827+0000","updated":"2007-05-21T23:49:07.827+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12497639","id":"12497639","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"If you click on the manage attachments link to the left of the attachments you will see a report  on each of the attachements.  Actually don't know if you can change the grant, so in the worst case you may have to submit your latest 2 again, this time checking the box to grant license when you submit them.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2007-05-21T23:51:32.765+0000","updated":"2007-05-21T23:51:32.765+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12497727","id":"12497727","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"body":"attaching patches with Grant license flag set.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mayureshnirhali","name":"mayureshnirhali","emailAddress":"Mayuresh dot Nirhali at Sun dot COM","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mayuresh Nirhali","active":true},"created":"2007-05-22T06:21:26.298+0000","updated":"2007-05-22T06:21:26.298+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367248/comment/12498002","id":"12498002","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"body":"I have committed  the fix to the trunk with change 540657, and backported the change into the 10.2 line with \r\nchange 540743","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikem","name":"mikem","emailAddress":"mikem_app at sbcglobal dot net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Matrigali","active":true},"created":"2007-05-22T20:47:08.086+0000","updated":"2007-05-22T20:47:08.086+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-2549/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i06rxb:"}}
{"expand":"renderedFields,names,schema,transitions,operations,editmeta,changelog","id":"12329523","self":"https://issues.apache.org/jira/rest/api/latest/issue/12329523","key":"DERBY-1064","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/10594","id":"10594","key":"DERBY","name":"Derby","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=10594&avatarId=10122","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=10594&avatarId=10122","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=10594&avatarId=10122","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=10594&avatarId=10122"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10090","id":"10090","description":"DB related projects","name":"DB"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12310220":"2006-06-27 16:01:31.0","customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"22288","customfield_12310222":"1_*:*_1_*:*_11171599000_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_45250145427","customfield_12312320":null,"customfield_12312321":null,"customfield_12312120":null,"customfield_12312121":null,"resolutiondate":"2006-07-07T15:35:44.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1064/watchers","watchCount":0,"isWatching":false},"created":"2006-02-28T08:22:25.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.png","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/10993","id":"10993","description":"","name":"10.1.1.0","archived":false,"released":true,"releaseDate":"2005-08-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/11187","id":"11187","description":"","name":"10.2.1.6","archived":false,"released":true,"releaseDate":"2006-10-02"}],"customfield_12311120":null,"customfield_12312330":null,"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fernanda","name":"fernanda","emailAddress":"fernanda dot pizzorno dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fernanda Pizzorno","active":true},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-12-13T09:04:49.425+0000","customfield_12312335":null,"customfield_12311720":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Complete"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/11408","id":"11408","name":"SQL"}],"timeoriginalestimate":null,"description":"When an after delete trigger which inserts into a table is created on a table that has a foreign key that references a primary key and uses the on delete cascade constraint, nulls are inserted into the table by the trigger.\n\nThe SQL below shows that the cascade delete works correctly:\n\nij> CREATE TABLE TABLE1 ( X INT PRIMARY KEY );\n0 rows inserted/updated/deleted\nij> CREATE TABLE TABLE1_DELETIONS ( X INT );\n0 rows inserted/updated/deleted\nij> CREATE TABLE TABLE2 (\n    Y INT,\n    CONSTRAINT Y_AND_X FOREIGN KEY(Y) REFERENCES TABLE1(X) ON DELETE CASCADE\n);\n0 rows inserted/updated/deleted\nij> CREATE TABLE TABLE2_DELETIONS ( Y INT );\n0 rows inserted/updated/deleted\nij> INSERT INTO TABLE1 VALUES (0);\n1 row inserted/updated/deleted\nij> INSERT INTO TABLE2 VALUES (0);\n1 row inserted/updated/deleted\nij> INSERT INTO TABLE1 VALUES (1);\n1 row inserted/updated/deleted\nij> INSERT INTO TABLE2 VALUES (1);\n1 row inserted/updated/deleted\nij> select * from table1;\nX\n-----------\n0\n1\n\n2 rows selected\nij> select * from table2;\nY\n-----------\n0\n1\n\n2 rows selected\nij> DELETE FROM TABLE1;\n2 rows inserted/updated/deleted\nij> select * from table1;\nX\n-----------\n\n0 rows selected\nij> select * from table2;\nY\n-----------\n\n0 rows selected\n\nNow insert the rows again, create the triggers, delete the rows from the primary key table, verify the cascade delete worked and observe the values in the tables used by the triggers:\n\nij> INSERT INTO TABLE1 VALUES(0);\n1 row inserted/updated/deleted\nij> INSERT INTO TABLE2 VALUES(0);\n1 row inserted/updated/deleted\nij> INSERT INTO TABLE1 VALUES(1);\n1 row inserted/updated/deleted\nij> INSERT INTO TABLE2 VALUES(1);\n1 row inserted/updated/deleted\nij> CREATE TRIGGER TRIGGER1\n    AFTER DELETE ON TABLE1\n    REFERENCING OLD AS OLD_ROW\n    FOR EACH ROW MODE DB2SQL\n    INSERT INTO TABLE1_DELETIONS VALUES (OLD_ROW.X);\n0 rows inserted/updated/deleted\nij> CREATE TRIGGER TRIGGER2\n    AFTER DELETE ON TABLE2\n    REFERENCING OLD AS OLD_ROW\n    FOR EACH ROW MODE DB2SQL\n    INSERT INTO TABLE2_DELETIONS VALUES (OLD_ROW.Y);\n0 rows inserted/updated/deleted\nij> DELETE FROM TABLE1;\n2 rows inserted/updated/deleted\nij> select * from TABLE1;\nX\n-----------\n\n0 rows selected\nij> select * from TABLE2;\nY\n-----------\n\n0 rows selected\nij> SELECT * FROM TABLE1_DELETIONS;\nX\n-----------\n0\n1\n\n2 rows selected\nij> SELECT * FROM TABLE2_DELETIONS;\nY\n-----------\nNULL\nNULL\n\nThe TABLE2_DELETIONS table contains NULLs instead of the correct values which should be 0 and 1.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12310200":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12310921":null,"customfield_12310920":"39707","summary":"Delete cascade causes NULL values inserted into table when after delete Trigger fires","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slc","name":"slc","emailAddress":"home4slc at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Susan Cline","active":true},"subtasks":[],"customfield_12310090":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slc","name":"slc","emailAddress":"home4slc at yahoo dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Susan Cline","active":true},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12311020":null,"customfield_12310050":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"startAt":0,"maxResults":3,"total":3,"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329523/comment/12417982","id":"12417982","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fernanda","name":"fernanda","emailAddress":"fernanda dot pizzorno dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fernanda Pizzorno","active":true},"body":"The problem is happening because the trigger TRIGGER2 is running with the trigger execution context (TEC) of TRIGGER1. Nulls will be inserted because this this is happening before the before and after result sets for the trigger execution context for TRIGGER1 are set.\r\n\r\nWhen deleting a row causes a cascade delete Derby will execute the following steps on both the target table and it's dependent tables:\r\n (1) get the affected rows; \r\n (2) fire before triggers;\r\n (3) delete the rows;\r\n (4) fire after triggers.\r\n\r\nThe problem described in this JIRA issue is caused by the way the execution of before and after triggers happens. The TEC for triggers that are being executed are kept in a Vector. During the execution of a trigger, the TEC used by the trigger will be the last element in this Vector.\r\nDuring the execution of before triggers, the following steps will happen: \r\n (1) for each dependent table, the TEC is added at the end of this Vector and the before trigger event is fired causing the execution of the before trigger on that table;\r\n (2) the TEC for the main table is added at the end of the Vector and the before trigger event is fired causing the execution of the before trigger on that table.\r\n\r\nIn the example in this JIRA issue, the Vector would now contain {TEC for TABLE2, TEC for TABLE1}.\r\n\r\nDuring the execution of after triggers, the following steps will happen:\r\n (1) for each dependent table, the after trigger even is fired causing the execution of the after trigger on that table;\r\n (2) the after trigger event is fired for the main table, causing the execution of the after trigger on that table;\r\n\r\nThe content of the Vector has not changed for the execution of the after trigger, so both after triggers execute with the TEC that is the last element of the Vector (TEC for TABLE1). The before and after result sets are still added to the correct TEC, as this happens when the trigger event is fired if there is a trigger for that event. When TRIGGER2 is executed, the before and after result sets are set on the correct TEC (TEC for TABLE2) but the trigger is executed with the wrong TEC (TEC for TABLE1). TEC for TABLE1 at that moment still does not have before and after result sets, causing NULLs to be inserted.\r\n\r\nThis patch (derby-1064.diff) fixes this problem by adding some steps to the execution of before and after triggers.\r\n\r\nFor the before trigger this patch will cause the TEC for those triggers that have been executed to be removed from the Vector, and for the after trigger the TEC for each trigger will be added again to the Vector (in the same order as done for before triggers), and will be removed after the trigger is executed.\r\n\r\nI have successfully run derbyall with this patch. Can someone please review it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fernanda","name":"fernanda","emailAddress":"fernanda dot pizzorno dot derby at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fernanda Pizzorno","active":true},"created":"2006-06-27T16:01:31.000+0000","updated":"2006-06-27T16:01:31.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329523/comment/12419224","id":"12419224","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"body":"Committed revision 419186 at trunk.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreask","name":"andreask","emailAddress":"andreas dot korneliussen at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Korneliussen","active":true},"created":"2006-07-05T15:07:22.000+0000","updated":"2006-07-05T15:07:22.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12329523/comment/12551316","id":"12551316","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"body":"This issue has been resolved for over a year with no further movement. Closing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fuzzylogic","name":"fuzzylogic","emailAddress":"mcintyre dot a at gmail dot com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew McIntyre","active":true},"created":"2007-12-13T09:04:49.417+0000","updated":"2007-12-13T09:04:49.417+0000"}]},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/DERBY-1064/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i075t3:"}}